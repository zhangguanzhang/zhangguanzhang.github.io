<!DOCTYPE html>
<html lang="zh-CN">
    <!-- title -->
<!-- keywords -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Zhangguanzhang">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Zhangguanzhang">
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    <meta name="description" content="记录生活点滴">
    <meta name="description" content="本文是全部离线安装，也就是 UPI (User Provisioned Infrastructure) 模式安装，假设机器只能配置静态ip不能有网络配置权限和配置 dhcp 和 pxe。机器可以是物理机和虚拟机。 前言介绍ocp介绍openshift 分为社区版本 okd 和企业版本 ocp(openshift container platform)，okd 的更新很慢，ocp 个人也是可以安装的">
<meta property="og:type" content="article">
<meta property="og:title" content="openshift 4.5.9 离线安装">
<meta property="og:url" content="http://zhangguanzhang.github.io/2020/09/18/ocp-4.5-install/">
<meta property="og:site_name" content="Zhangguanzhang">
<meta property="og:description" content="本文是全部离线安装，也就是 UPI (User Provisioned Infrastructure) 模式安装，假设机器只能配置静态ip不能有网络配置权限和配置 dhcp 和 pxe。机器可以是物理机和虚拟机。 前言介绍ocp介绍openshift 分为社区版本 okd 和企业版本 ocp(openshift container platform)，okd 的更新很慢，ocp 个人也是可以安装的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image-static.segmentfault.com/241/514/241514728-5ee6e815a4963_articlex">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531150958.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531151305.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531152811.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531152931.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531153820.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531154244.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangguanzhang/Image-Hosting/picgo/rhcos_install_boot_cmdline.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605150947.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605151307.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605151646.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605152528.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605152729.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605152911.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605153048.png">
<meta property="article:published_time" content="2020-09-18T11:14:06.000Z">
<meta property="article:modified_time" content="2020-09-18T11:14:06.000Z">
<meta property="article:author" content="Zhangguanzhang">
<meta property="article:tag" content="ocp">
<meta property="article:tag" content="openshift">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-static.segmentfault.com/241/514/241514728-5ee6e815a4963_articlex">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/favicon.ico">
    <title>openshift 4.5.9 离线安装 · zhangguanzhang&#39;s Blog</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .footer-fixed-btn,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(
            -45deg,
            #444 0,
            #444 80px,
            #333 80px,
            #333 160px
        );
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link id="stylesheet-fancybox" rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-base" rel="preload" href="/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-mobile" rel="preload" href="/css/mobile.css" as="style" onload="this.onload=null;this.rel='stylesheet';this.media='screen and (max-width: 960px)'">
    <link id="stylesheet-theme-dark" rel="preload" href="/css/dark.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
        <script>
            var hits = JSON.parse('{"per_page":10}')
            var labels = JSON.parse('{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}')

            var algolia = {
                applicationID: '3RNEGEC262',
                apiKey: '6403a5f93c8554eb5b5ed2ad42b9693e',
                indexName: 'blog',
                hits: hits,
                labels: labels
            }
        </script>
    <!-- 百度统计  -->
    <!-- 谷歌统计  -->
    <!-- Google tag (gtag.js) -->
<meta name="generator" content="Hexo 8.1.0"><link rel="alternate" href="/atom.xml" title="Zhangguanzhang" type="application/atom+xml">
</head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
        <body class="post-body">
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        <div class="header-sidebar-menu">
            <div style="padding-left: 1px;">&#xe775;</div>
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href="/">zhangguanzhang's Blog</a>
        </span>
    </div>
    <!-- toggle banner -->
    <div class="banner">
        <div class="blog-title header-element">
            <a href="/">zhangguanzhang&#39;s Blog</a>
        </div>
        <div class="post-title header-element">
            <a href="#" class="post-name">openshift 4.5.9 离线安装</a>
        </div>
    </div>
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- donate button -->

    <!-- back to top button -->
    <div class="footer-fixed-btn footer-fixed-btn--hidden back-top">
        <div>&#xe639;</div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="    height:50vh;
">
    <!-- 主页  -->
    <!-- 404页  -->
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
                openshift 4.5.9 离线安装
            <!-- 404 -->
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            <!-- 404 -->
        </p>
        <!-- 文章页 meta -->
            <div class="post-intros">
                <!-- 文章页标签  -->
                    <div class="post-intro-tags" >
        <a class="post-tag" href="javascript:void(0);" data-tags="openshift">openshift</a>
        <a class="post-tag" href="javascript:void(0);" data-tags="ocp">ocp</a>
</div>

                <!-- 文章字数统计 -->
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">20.1k</span>阅读时长: <span class="post-count reading-time">104 min</span></span>
                    </div>
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2020/09/18</span>
                    <!-- busuanzi -->
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" alt="loading">
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <p>本文是全部离线安装，也就是 UPI (User Provisioned Infrastructure) 模式安装，假设机器只能配置静态ip不能有网络配置权限和配置 dhcp 和 pxe。机器可以是物理机和虚拟机。</p>
<h2 id="前言介绍"><a href="#前言介绍" class="headerlink" title="前言介绍"></a>前言介绍</h2><h3 id="ocp介绍"><a href="#ocp介绍" class="headerlink" title="ocp介绍"></a>ocp介绍</h3><p>openshift 分为社区版本 okd 和企业版本 ocp(openshift container platform)，okd 的更新很慢，ocp 个人也是可以安装的，不购买 license 则不会享受 redhat 的官方支持。</p>
<p>openshift 不像其他的 dashboard 诸如 rancher，k3s 之类的，它自己实现了 cs 的三个组件，也给 k8s 贡献了 rbac 和 ingress 的代码。它的节点系统是使用 Red Hat Enterprise Linux CoreOS (RHCOS)，这是一款面向容器的操作系统，结合了 CoreOS 和 Red Hat Atomic Host 操作系统的一些最佳特性和功能。</p>
<p>RHCOS 是专门为从 OpenShift Container Platform 运行容器化应用程序而设计的，能够与新工具配合，提供快速安装、基于 Operator 的管理和简化的升级，ocp 里 master节点必须是 rhcos 系统，而 worker 节点除了 rhcos 以外还可以选择 rhel。并且集群里有大量的 operator，通过使用 k8s 的声明式 yaml 减少了对系统和集群底层的关注度，甚至集群升级也是通过 cluster-version-operator 完成。</p>
<h3 id="ocp安装流程"><a href="#ocp安装流程" class="headerlink" title="ocp安装流程"></a>ocp安装流程</h3><p>先看这个官方的图，从图来讲流程</p>
<p><img src="https://image-static.segmentfault.com/241/514/241514728-5ee6e815a4963_articlex" alt="ocp_install_pic"></p>
<p>它的安装是先在一台机器（bastion）上准备 pxe 和相关的安装集群描述信息需要的文件（Ignition）以及 dns，负载均衡，然后引导主机（<code>Bootstrap</code>）通过 dhcp 或者 人为挂载 rhcos 的 iso 在安装界面手写 boot cmdline 从 bastion 指定获取 <code>bootstrap.ign</code>和 os.raw.gz 文件完成安装， 随后 master 节点启动会获取<code>master.ign</code>文件并且从 bootstrap 节点获取 machine-config 信息，随后 node 同理。</p>
<p>在安装过程中 bootstrap 的 ign文件里证书是24小时过期的，因为官方这种涉及理念是 bootstrap 作用于引导集群的，安装完后会将控制平面移交到 master上，所以我们要配置负载均衡（以及代理后续集群里的 ingress controller）</p>
<ul>
<li>先在一台机器（bastion）上准备pxe和相关的安装集群描述信息需要的文件（Ignition）以及 dns，负载均衡，也就是图里的 <code>Cluster Installer</code></li>
<li><code>bastion</code>上手写一个集群安装的 yaml ，然后使用 oc 命令把 yaml 转换成集群部署清单和 Ignition 文件</li>
<li>在引导主机启动前准备好 DNS，负载均衡，镜像仓库</li>
<li>引导主机（<code>Bootstrap</code>）通过 dhcp 或者挂载 rhcos 的 iso 启动后在安装界面手写<code>boot cmdline</code>（包含网络配置，nameserver，install_dev,image_url,ignition_url），安装完系统后重启后，bootstrap 机器会执行 bootkube.sh 脚本，内部是 crio 和 podman 启动容器和 pod 来启动控制平面，并等待 master 加入</li>
<li><code>Master</code> 节点如果像我没有dhcp就手动配置boot cmdline 安装后会从引导主机远程获取资源并完成引导，会作为 node 注册。</li>
<li>bootstrap 节点 watch 到 node的注册后，会在集群里部署 operator 执行 一些 install-n-master的 pod，例如引导主机会让 master 节点构建 <code>Etcd</code> 集群。</li>
<li>引导主机使用新的 <code>Etcd</code> 集群启动临时 <code>Kubernetes</code> 控制平面。</li>
<li>临时控制平面在 Master 节点启动生成控制平面。</li>
<li>临时控制平面关闭并将控制权传递给生产控制平面。</li>
<li>引导主机将 OCP 组件注入生成控制平面。</li>
<li>整个过程主要是 bootstrap 上的 <code>bootkube.sh</code> 执行，最后执行完后会在集群里添加一个 <code>-n kube-system configmap/bootstrap</code> 作为保存状态。</li>
</ul>
<p>引导安装过程完成以后，OCP 集群部署完毕。然后集群开始下载并配置日常操作所需的其余组件，包括创建计算节点、通过 <code>Operator</code> 安装其他服务等。</p>
<h2 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h2><h3 id="资源规划"><a href="#资源规划" class="headerlink" title="资源规划"></a>资源规划</h3><p>官方文档<a target="_blank" rel="noopener" href="https://docs.openshift.com/container-platform/4.5/installing/installing_bare_metal/installing-bare-metal-network-customizations.html#minimum-resource-requirements_installing-bare-metal-network-customizations">最小配置</a>信息为:</p>
<table>
<thead>
<tr>
<th>Machine</th>
<th>Operating System</th>
<th>vCPU</th>
<th>RAM</th>
<th>Storage</th>
</tr>
</thead>
<tbody><tr>
<td>Bootstrap</td>
<td>RHCOS</td>
<td>4</td>
<td>16GB</td>
<td>120 GB</td>
</tr>
<tr>
<td>Control plane</td>
<td>RHCOS</td>
<td>4</td>
<td>16 GB</td>
<td>120 GB</td>
</tr>
<tr>
<td>Compute</td>
<td>RHCOS or RHEL 7.6</td>
<td>2</td>
<td>8 GB</td>
<td>120 GB</td>
</tr>
</tbody></table>
<p>这里机器信息是如下，官方很多镜像都是存在<code>quay.io</code>这个仓库下，因为墙的问题会无法拉取，所以实际部署都会部署一个镜像仓库，这里我镜像仓库是使用 quay ，它会使用 443 端口(暂时没找到更改端口的方法)，负载均衡会负载 ingress controller 的 http 和 https（443端口）节点，所以镜像仓库单独一个机器，如果你用其他的仓库例如 registry 可以放在负载均衡的节点上。节点的配置和 role 如下关系，因为 bootstrap 用完后可以删除，可以后面用作 worker 节点。<strong>单 master 节点参照网上的我部署有问题，后文会说明原因</strong></p>
<p>服务器规划如下：</p>
<ul>
<li>三个控制平面节点，安装 <code>Etcd</code>、控制平面组件。</li>
<li>一个计算节点，运行实际负载。</li>
<li>一个引导主机，执行安装任务，集群部署完成后当作 worker 使用。</li>
<li>一个基础节点，用于准备上离线资源，同时用来部署 DNS 和负载均衡（负载<code>machine-config</code>、ocp 的 <code>kube-apiserver</code> 和 集群里的 <code>ingress controller</code>）。</li>
<li>一个镜像节点，用来部署私有镜像仓库 <code>Quay</code>，因为官方镜像在 <code>quay.io</code> 上很难拉取。</li>
<li>翻墙节点不在下面列表里，或者有软路由之类的可以在基础节点直接拉镜像更好</li>
</ul>
<table>
<thead>
<tr>
<th>Machine and hostName</th>
<th>OS</th>
<th>vCPU</th>
<th>RAM</th>
<th>Storage</th>
<th>IP</th>
<th>FQND</th>
<th>describe</th>
</tr>
</thead>
<tbody><tr>
<td>registry</td>
<td>Centos7.8</td>
<td>4</td>
<td>8GB</td>
<td>100 GB</td>
<td>10.225.45.226</td>
<td>registry.openshift4.example.com</td>
<td>镜像仓库</td>
</tr>
<tr>
<td>bastion</td>
<td>Centos7.8</td>
<td>8</td>
<td>8GB</td>
<td>100 GB</td>
<td>10.225.45.250</td>
<td>bastion.openshift4.example.com</td>
<td>dns，负载均衡(LB)，http文件下载</td>
</tr>
<tr>
<td>bootstrap</td>
<td>RHCOS</td>
<td>4</td>
<td>16GB</td>
<td>120 GB</td>
<td>10.225.45.223</td>
<td>bootstrap.openshift4.example.com</td>
<td>也叫引导节点(Bootstrap)</td>
</tr>
<tr>
<td>master1</td>
<td>RHCOS</td>
<td>8</td>
<td>16 GB</td>
<td>120 GB</td>
<td>10.225.45.251</td>
<td>master1.openshift4.example.com</td>
<td>也叫控制节点(Control plane)</td>
</tr>
<tr>
<td>master2</td>
<td>RHCOS</td>
<td>8</td>
<td>16 GB</td>
<td>120 GB</td>
<td>10.225.45.252</td>
<td>master2.openshift4.example.com</td>
<td>也叫控制节点(Control plane)</td>
</tr>
<tr>
<td>master3</td>
<td>RHCOS</td>
<td>8</td>
<td>16 GB</td>
<td>120 GB</td>
<td>10.225.45.222</td>
<td>master3.openshift4.example.com</td>
<td>也叫控制节点(Control plane)</td>
</tr>
<tr>
<td>worker1</td>
<td>RHCOS</td>
<td>4</td>
<td>16 GB</td>
<td>120 GB</td>
<td>10.225.45.223</td>
<td>worker1.openshift4.example.com</td>
<td>也叫计算节点(Compute)</td>
</tr>
</tbody></table>
<ul>
<li>这里 253 ip被抢占了，所以 master3 的ip选 222</li>
<li><code>openshift4</code> 是集群名，<code>example.com</code>是 basedomain</li>
<li>ocp内部的 kubernetes api、router、etcd通信都是使用域名，所以这里我们也给主机规定下<code>FQDN</code>，所有节点主机名都要采用三级域名格式，如 <code>master1.aa.bb.com</code>。后面会在 dns server里写入记录</li>
</ul>
<h3 id="防火墙端口"><a href="#防火墙端口" class="headerlink" title="防火墙端口"></a>防火墙端口</h3><p>接下来看一下每个节点的端口号分配。</p>
<p>所有节点（计算节点和控制平面）之间需要开放的端口：</p>
<table>
<thead>
<tr>
<th align="center">协议</th>
<th align="center">端口</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ICMP</td>
<td align="center">N&#x2F;A</td>
<td align="center">测试网络连通性</td>
</tr>
<tr>
<td align="center">TCP</td>
<td align="center"><code>9000-9999</code></td>
<td align="center">节点的服务端口，包括 node exporter 使用的 <code>9100-9101</code> 端口和 Cluster Version Operator 使用的 <code>9099</code> 端口</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>10250</code>-<code>10259</code></td>
<td align="center">Kubernetes 预留的默认端口</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>10256</code></td>
<td align="center">openshift-sdn</td>
</tr>
<tr>
<td align="center">UDP</td>
<td align="center"><code>4789</code></td>
<td align="center">VXLAN 协议或 GENEVE 协议的通信端口</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>6081</code></td>
<td align="center">VXLAN 协议或 GENEVE 协议的通信端口</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>9000</code>-<code>9999</code></td>
<td align="center">节点的服务端口，包括 node exporter 使用的 <code>9100-9101</code> 端口</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>30000</code>-<code>32767</code></td>
<td align="center">Kubernetes NodePort range</td>
</tr>
</tbody></table>
<p>控制平面需要向其他节点开放的端口：</p>
<table>
<thead>
<tr>
<th align="center">协议</th>
<th align="center">端口</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">TCP</td>
<td align="center"><code>2379</code>-<code>2380</code></td>
<td align="center">Etcd 服务端口</td>
</tr>
<tr>
<td align="center">TCP</td>
<td align="center"><code>6443</code></td>
<td align="center">Kubernetes API</td>
</tr>
</tbody></table>
<p>除此之外，还要配置两个四层负载均衡器，一个用来暴露集群 API，一个用来暴露 Ingress：</p>
<table>
<thead>
<tr>
<th align="center">端口</th>
<th align="center">作用</th>
<th align="center">内部</th>
<th align="center">外部</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>6443</code></td>
<td align="center">引导主机和控制平面使用。在引导主机初始化集群控制平面后，需从负载均衡器中手动删除引导主机</td>
<td align="center">x</td>
<td align="center">x</td>
<td align="center">Kubernetes API server</td>
</tr>
<tr>
<td align="center"><code>22623</code></td>
<td align="center">引导主机和控制平面使用。在引导主机初始化集群控制平面后，需从负载均衡器中手动删除引导主机</td>
<td align="center"></td>
<td align="center">x</td>
<td align="center">Machine Config server</td>
</tr>
<tr>
<td align="center"><code>443</code></td>
<td align="center">Ingress Controller 或 Router 使用</td>
<td align="center">x</td>
<td align="center">x</td>
<td align="center">HTTPS 流量</td>
</tr>
<tr>
<td align="center"><code>80</code></td>
<td align="center">Ingress Controller 或 Router 使用</td>
<td align="center">x</td>
<td align="center">x</td>
<td align="center">HTTP 流量</td>
</tr>
</tbody></table>
<h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>按照官方文档，使用 UPI 基础架构的 OCP 集群需要以下的 DNS 记录。在每条记录中，<code>&lt;cluster_name&gt;</code> 是集群名称，<code>&lt;base_domain&gt;</code> 是在 <code>install-config.yaml</code> 文件中指定的集群基本域，如下表所示：</p>
<table>
<thead>
<tr>
<th align="center">组件</th>
<th align="center">DNS记录</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Kubernetes API</td>
<td align="center"><code>api.&lt;cluster_name&gt;.&lt;base_domain&gt;.</code></td>
<td align="center">此 DNS 记录必须指向控制平面节点的负载均衡器。此记录必须可由集群外部的客户端和集群中的所有节点解析。</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>api-int.&lt;cluster_name&gt;.&lt;base_domain&gt;.</code></td>
<td align="center">此 DNS 记录必须指向控制平面节点的负载均衡器。此记录必须可由集群外部的客户端和集群中的所有节点解析。</td>
</tr>
<tr>
<td align="center">Routes</td>
<td align="center"><code>*.apps.&lt;cluster_name&gt;.&lt;base_domain&gt;.</code></td>
<td align="center">DNS 通配符记录，指向负载均衡器。这个负载均衡器的后端是 Ingress router 所在的节点，默认是计算节点。此记录必须可由集群外部的客户端和集群中的所有节点解析。</td>
</tr>
<tr>
<td align="center">etcd</td>
<td align="center"><code>etcd-&lt;index&gt;.&lt;cluster_name&gt;.&lt;base_domain&gt;.</code></td>
<td align="center">OCP 要求每个 etcd 实例的 DNS 记录指向运行实例的控制平面节点。etcd 实例由 <index> 值区分，它们以 <code>0</code> 开头，以 <code>n-1</code> 结束，其中 <code>n</code> 是集群中控制平面节点的数量。集群中的所有节点必须都可以解析此记录。</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>_etcd-server-ssl._tcp.&lt;cluster_name&gt;.&lt;base_domain&gt;.</code></td>
<td align="center">因为 etcd 使用端口 <code>2380</code> 对外服务，因此需要建立对应每台 etcd 节点的 SRV DNS 记录，优先级 0，权重 10 和端口 2380</td>
</tr>
</tbody></table>
<h2 id="镜像准备"><a href="#镜像准备" class="headerlink" title="镜像准备"></a>镜像准备</h2><p>因为镜像都是在<code>quay.io</code>上，国内很难拉取下来，所以参考官方文档 <a target="_blank" rel="noopener" href="https://docs.openshift.com/container-platform/4.5/installing/install_config/installing-restricted-networks-preparations.html">Creating a mirror registry for installation in a restricted network</a> 创建个镜像仓库。<strong>要求支持 version 2 schema 2 (manifest list)</strong> ，我这里选择的是 <code>Quay 3.3</code>。quay 镜像仓库需要部署在另外一台节点，因为它需要用到 <code>443</code> 端口，与后面的负载均衡 https 端口冲突。同时因为镜像是需要翻墙拉取，所以需要自备一台能翻墙的节点处于网络边界上。</p>
<h3 id="本地镜像仓库-registry"><a href="#本地镜像仓库-registry" class="headerlink" title="本地镜像仓库 - registry"></a>本地镜像仓库 - registry</h3><p>仓库没必要开始搭建，在下文的 oc 同步镜像之前搭建好即可</p>
<p>这里使用 <code>docker-compose</code> 搭建 quay 仓库，自行安装 <code>docker</code> 和 <code>docker-compose</code> 设置好系统和内核参数，如果你也使用容器搭建，可以不用和我一样的操作系统。容器已经能通过 <code>alias</code> 互联，所以没必要的端口不用映射到宿主机上，你也可以使用 <code>podman</code> 或者其他容器工具起一个环境，甚至 <code>docker run</code> 起来这些容器。</p>
<p>设置机器的 hostname</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname registry.openshift4.example.com</span><br></pre></td></tr></table></figure>

<h4 id="docker-compose-for-registry"><a href="#docker-compose-for-registry" class="headerlink" title="docker-compose for registry"></a>docker-compose for registry</h4><p>这里数据都存放在<code>/data/quay/xxx</code>，创建目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/quay/lib/mysql \</span><br><span class="line">  /data/quay/lib/redis \</span><br><span class="line">  /data/quay/config \</span><br><span class="line">  /data/quay/storage</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器权限问题，容器的user都在root组下，但是默认<span class="built_in">umask</span>下组没有w权限，所以这里加下</span></span><br><span class="line">chmod g+w /data/quay/lib/mysql/ \</span><br><span class="line">  /data/quay/lib/redis/ \</span><br><span class="line">  /data/quay/config \</span><br><span class="line">  /data/quay/storage</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建quay仓库的<code>docker-compose.yml</code>文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash">/data/quay/docker-compose.yml &lt;&lt; <span class="string">EOF</span></span></span><br><span class="line">version: &#x27;3.2&#x27;</span><br><span class="line">services:</span><br><span class="line">  quay:</span><br><span class="line">    #image: quay.io/redhat/quay:v3.3.1</span><br><span class="line">    image: registry.aliyuncs.com/quayx/redhat-quay:v3.3.1</span><br><span class="line">    container_name: quay</span><br><span class="line">    restart: always</span><br><span class="line">    privileged: true</span><br><span class="line">    sysctls:</span><br><span class="line">      - net.core.somaxconn=1024</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/quay/config:/conf/stack:Z</span><br><span class="line">      - /data/quay/storage:/datastorage:Z</span><br><span class="line">    ports:</span><br><span class="line">      - 443:8443</span><br><span class="line">    command: [&quot;config&quot;, &quot;redhat&quot;]</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">      - redis</span><br><span class="line">    networks:</span><br><span class="line">      quay:</span><br><span class="line">        aliases:</span><br><span class="line">          - config</span><br><span class="line">    logging:</span><br><span class="line">      driver: json-file</span><br><span class="line">      options:</span><br><span class="line">        max-file: &#x27;3&#x27;</span><br><span class="line">        max-size: 100m</span><br><span class="line">  mysql:</span><br><span class="line">    image: registry.access.redhat.com/rhscl/mysql-57-rhel7</span><br><span class="line">    container_name: quay-mysql</span><br><span class="line">    restart: always</span><br><span class="line">    privileged: true</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/quay/lib/mysql:/var/lib/mysql/data:Z</span><br><span class="line">    # ports:</span><br><span class="line">    #   - 3306:3306</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=redhat</span><br><span class="line">      - MYSQL_DATABASE=enterpriseregistrydb</span><br><span class="line">      - MYSQL_USER=quayuser</span><br><span class="line">      - MYSQL_PASSWORD=redhat</span><br><span class="line">    networks:</span><br><span class="line">      quay:</span><br><span class="line">        aliases:</span><br><span class="line">          - mysql</span><br><span class="line">    logging:</span><br><span class="line">      driver: json-file</span><br><span class="line">      options:</span><br><span class="line">        max-file: &#x27;3&#x27;</span><br><span class="line">        max-size: 100m</span><br><span class="line">  redis:</span><br><span class="line">    image: registry.access.redhat.com/rhscl/redis-32-rhel7</span><br><span class="line">    container_name: quay-redis</span><br><span class="line">    restart: always</span><br><span class="line">    privileged: true</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/quay/lib/redis:/var/lib/redis/data:Z</span><br><span class="line">    networks:</span><br><span class="line">      quay:</span><br><span class="line">        aliases:</span><br><span class="line">          - redis</span><br><span class="line">    # ports:</span><br><span class="line">    #   - 6379:6379</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">    logging:</span><br><span class="line">      driver: json-file</span><br><span class="line">      options:</span><br><span class="line">        max-file: &#x27;3&#x27;</span><br><span class="line">        max-size: 100m</span><br><span class="line">networks:</span><br><span class="line">  quay:</span><br><span class="line">    name: quay</span><br><span class="line">    external: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>数据库</strong> : 主要存放镜像仓库的元数据（非镜像存储)</li>
<li><strong>Redis</strong> : 存放构建日志和Quay的向导</li>
<li><strong>Quay</strong> : 作为镜像仓库</li>
<li><strong>Clair</strong> : 提供镜像扫描功能</li>
</ul>
<p>注意，其中的镜像 <code>quay.io/redhat/quay:v3.3.1</code> 是无法拉取的，参考 <a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/3533201">官方链接</a> 获取Red Hat Quay v3 镜像的访问权才可以拉取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u=&quot;redhat+quay&quot; -p=&quot;O81WSHRSJR14UAZBK54GQHJS0P1V4CLWAJV1X2C4SD7KO59CQ9N3RE12612XU1HR&quot; quay.io</span><br></pre></td></tr></table></figure>

<p>这个镜像我已经同步到阿里云上的镜像仓库上，也方便拉取，另外这个镜像的运行命令 <code>config redhat</code>的 <code>redhat</code> 是 quay 仓库起来后的 web 里用到的密码，这里我们先拉取上面所需要的镜像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /data/quay</span><br><span class="line">docker-compose pull</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>后续还会部署的话推荐这里使用 docker 把这三个镜像 <code>docker save -o</code> 成一个tar包方便以后 <code>docker load -i</code> 导入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /data/quay</span><br><span class="line">docker save \</span><br><span class="line">  registry.access.redhat.com/rhscl/redis-32-rhel7 \</span><br><span class="line">  registry.access.redhat.com/rhscl/mysql-57-rhel7 \</span><br><span class="line">  registry.aliyuncs.com/quayx/redhat-quay:v3.3.1 | gzip - &gt; quay-img.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="setup-for-registry"><a href="#setup-for-registry" class="headerlink" title="setup for registry"></a>setup for registry</h4><p>起来后访问<code>https://ip</code> basic auth 信息为<code>quayconfig/redhat</code>，选择<code>Start New Registry Setup</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531150958.png" alt="choose an option"></p>
<p>选择新建配置，然后设置数据库：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531151305.png" alt="setup for rds"></p>
<p>连接信息按照上面的<code>docker-compose</code>里的环境变量写，<code>ssl certificate</code>先别管。</p>
<p>设置超级管理员，记住密码，然后下一步</p>
<p>下一步然后页面往下滑动，在<code>Server Configuration</code>段里设置<code>Server Hostname</code>，例如为<code>registry.openshift4.example.com</code>，往下滑动，配置redis信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531152811.png" alt="Server Configuration"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531152931.png" alt="redis"></p>
<p>点击左下角的Save，弹出的<code>Checking</code>全绿后点击<code>Next</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531153820.png" alt="checking your settings"></p>
<p>配置检查通过后，就可以保存下载下来：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200531154244.png" alt="Download Configuration"></p>
<p>最后会导出一个 <code>quay-config.tar.gz</code>，将其上传到 Quay 所在的服务器，解压到配置文件目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp quay-config.tar.gz /data/quay/config/</span><br><span class="line">cd /data/quay/config/</span><br><span class="line">tar zxvf quay-config.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="ssl-for-registry"><a href="#ssl-for-registry" class="headerlink" title="ssl for registry"></a>ssl for registry</h4><p>接下来为仓库生成域名自签名证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /data/quay/config/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成私钥</span></span><br><span class="line">openssl genrsa -out ssl.key 1024</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成证书，最好使用通配符</span></span><br><span class="line">openssl req \</span><br><span class="line">  -newkey rsa:2048 -nodes -keyout ssl.key \</span><br><span class="line">  -x509 -days 36500 -out ssl.cert -subj \</span><br><span class="line">  &quot;/C=CN/ST=Wuhan/L=Wuhan/O=WPS/OU=WPS/CN=*.openshift4.example.com&quot;</span><br></pre></td></tr></table></figure>

<p>证书搞定后<code>PREFERRED_URL_SCHEME: http</code>修改成 https</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;/^PREFERRED_URL_SCHEME:/s#\S+$#https#&#x27; config.yaml</span><br></pre></td></tr></table></figure>

<p>然后停掉服务，注释掉 command 后再启动，web 打开看看是不是镜像仓库，是的话本机添加下 hosts</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /data/quay/</span><br><span class="line">docker-compose down</span><br><span class="line">sed -ri &#x27;/^\s*command: \[&quot;config&quot;/s@^@#@&#x27; docker-compose.yml</span><br><span class="line">docker-compose up -d</span><br><span class="line">grep -qw &#x27;registry.openshift4.example.com&#x27; /etc/hosts || </span><br><span class="line">    echo &#x27;127.0.0.1 registry.openshift4.example.com&#x27; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>去浏览器上web登录下镜像仓库，添加一个<code>Organization</code>，名字为<code>ocp4</code>用于存放镜像，然后添加一个<code>Repository</code>名字为<code>openshift4</code></p>
<h2 id="纵云梯节点配置"><a href="#纵云梯节点配置" class="headerlink" title="纵云梯节点配置"></a>纵云梯节点配置</h2><h3 id="配置registry-的-hosts"><a href="#配置registry-的-hosts" class="headerlink" title="配置registry 的 hosts"></a>配置registry 的 hosts</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -qw &#x27;registry.openshift4.example.com&#x27; /etc/hosts || </span><br><span class="line">    echo &#x27;10.225.45.226 registry.openshift4.example.com&#x27; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<h3 id="二进制文件和-secret-json-准备"><a href="#二进制文件和-secret-json-准备" class="headerlink" title="二进制文件和 secret.json 准备"></a>二进制文件和 secret.json 准备</h3><p>拉取镜像是在翻墙的节点上使用的<code>openshift client</code>的 oc 二进制 cli ，该命令大部分的子命令在操作集群的时候和 kubectl 是一致的。此节需要我们在纵云梯节点上执行oc 命令执行去把镜像拉取推送到本地的 registry 上。我们先准备拉取镜像用到的一些前置文件</p>
<p>首先是 oc 下载，很多机器都需要，官方说 这个<a target="_blank" rel="noopener" href="https://cloud.redhat.com/openshift/install">页面</a>下载，我们也可以去<a target="_blank" rel="noopener" href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-4.5/">mirror页面</a>  下载。解压后放到系统的 <code>$PATH</code> 里</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-4.5/openshift-client-linux-4.5.9.tar.gz</span><br><span class="line">tar zxvf openshift-client-linux-4.5.9.tar.gz</span><br><span class="line">mv oc kubectl /usr/local/bin</span><br></pre></td></tr></table></figure>

<p>安装一些基础小工具，jq 用来格式化 json 文件，chrony 用于时间同步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release &amp;&amp; \</span><br><span class="line">  yum install \</span><br><span class="line">  jq \</span><br><span class="line">  bind-utils \</span><br><span class="line">  tcpdump \</span><br><span class="line">  chrony \</span><br><span class="line">  httpd-tools \</span><br><span class="line">  dos2unix \</span><br><span class="line">  strace</span><br></pre></td></tr></table></figure>

<p>准备拉取镜像权限认证文件，很多镜像在好几个镜像仓库上，有授权信息才能拉取。 从 Red Hat OpenShift Cluster Manager 站点的 Pull Secret 页面下载 <a target="_blank" rel="noopener" href="https://cloud.redhat.com/openshift/install/pull-secret">registry.redhat.io</a> 的 pull secret</p>
<p>把文件或者内容整上去后，格式化下json</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq . pull-secret.txt &gt; pull-secret.json</span><br></pre></td></tr></table></figure>

<p>大致下面的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;auths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cloud.openshift.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b3BlbnNo...&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;quay.io&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b3BlbnNo...&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;registry.connect.redhat.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NTE3Njg5Nj...&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;registry.redhat.io&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NTE3Njg5Nj...&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;you@example.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>把前面 quay 的用户名和密码按照<code>user:pass</code> base64 加密了，例如<code>echo -n admin:openshift | base64</code>， 然后符合 json 的格式要求下把镜像仓库和 auth 信息追加到<code>pull-secret.json</code>里</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="attr">&quot;registry.openshift4.example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;......==&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>增加后用 <code>jq . pull-secret.json</code> 检验下 json 格式是否正确</p>
<p>下面利用变量拼接一些镜像tag来同步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.5.9</span></span><br><span class="line">OCP_VERSION=$(oc version -o json | jq -r .releaseClientVersion)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.5.9-x86_64</span></span><br><span class="line">OCP_RELEASE=$OCP_VERSION-$(arch)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4</span></span><br><span class="line">OCP_MAJOR=$&#123;OCP_VERSION%%.*&#125;</span><br><span class="line"></span><br><span class="line">LOCAL_REGISTRY=&#x27;registry.openshift4.example.com&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对应前面的 ocp4/openshift4</span></span><br><span class="line">LOCAL_REPOSITORY=&quot;ocp$&#123;OCP_MAJOR&#125;/openshift$&#123;OCP_MAJOR&#125;&quot;</span><br><span class="line"></span><br><span class="line">PRODUCT_REPO=&#x27;openshift-release-dev&#x27;</span><br><span class="line">RELEASE_NAME=&quot;ocp-release&quot;</span><br><span class="line"></span><br><span class="line">LOCAL_SECRET_JSON=&#x27;pull-secret.json&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>OCP_RELEASE</strong> : OCP 版本，可以在<a target="_blank" rel="noopener" href="https://quay.io/repository/openshift-release-dev/ocp-release?tab=tags">这个页面</a>查看。如果版本不对，下面执行 <code>oc adm</code> 时会提示 <code>image does not exist</code>。</li>
<li><strong>LOCAL_REGISTRY</strong> : 本地仓库的域名和端口。</li>
<li><strong>LOCAL_REPOSITORY</strong> : 镜像存储库名称，使用 <code>ocp4/openshift4</code>。</li>
<li><code>PRODUCT_REPO</code> 和 <code>RELEASE_NAME</code> 都不需要改，这些都是一些版本特征，保持不变即可。</li>
<li><strong>LOCAL_SECRET_JSON</strong> : 密钥路径，就是上面 <code>pull-secret.json</code> 的存放路径。</li>
</ul>
<h3 id="同步镜像"><a href="#同步镜像" class="headerlink" title="同步镜像"></a>同步镜像</h3><p>同步镜像分为两种方式，一种是实时使用 oc 命令把镜像转发到 <code>LOCAL_REGISTRY</code>，一种是离线存储为文件，然后把文件拿到内网去用 oc 命令推送到内网的仓库。</p>
<p>一些后续可研究的东西:<br>如果后续有需求研究同步镜像到国内，每个版本的镜像列表可以查看<a target="_blank" rel="noopener" href="https://github.com/openshift/cluster-version-operator/blob/master/docs/user/reconciliation.md">官方这个文档</a>里的命令解开镜像去查看镜像列表：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看镜像info</span></span><br><span class="line">oc adm release info -a $&#123;LOCAL_SECRET_JSON&#125;\</span><br><span class="line"> quay.io/openshift-release-dev/ocp-release:4.5.9-x86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解开到本地查看</span></span><br><span class="line">oc image extract -a $&#123;LOCAL_SECRET_JSON&#125; \</span><br><span class="line">  quay.io/openshift-release-dev/ocp-release:4.5.9-x86_64 \</span><br><span class="line">  --path /:/tmp/release</span><br></pre></td></tr></table></figure>

<p>如果想解开这个镜像研究的话，我已经把这个镜像同步到阿里上了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">skopeo copy  docker://quay.io/openshift-release-dev/ocp-release:4.5.9-x86_64 \</span><br><span class="line">  docker://registry.aliyuncs.com/openshift-release-dev/ocp-release:4.5.9-x86_64   \</span><br><span class="line">  --insecure-policy</span><br></pre></td></tr></table></figure>

<h4 id="实时转发到-LOCAL-REGISTRY"><a href="#实时转发到-LOCAL-REGISTRY" class="headerlink" title="实时转发到 LOCAL_REGISTRY"></a>实时转发到 LOCAL_REGISTRY</h4><p>添加registry的hosts到同步的机器上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -qw &#x27;registry.openshift4.example.com&#x27; /etc/hosts || </span><br><span class="line">    echo &#x27;10.225.45.226 registry.openshift4.example.com&#x27; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>执行同步命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里之前打算同步到阿里云仓库上，但是一直报错，以后有空的时候再研究下看怎么同步到阿里的镜像仓库上</span></span><br><span class="line">oc adm -a $&#123;LOCAL_SECRET_JSON&#125; release mirror \</span><br><span class="line">  --from=quay.io/$&#123;PRODUCT_REPO&#125;/$&#123;RELEASE_NAME&#125;:$&#123;OCP_RELEASE&#125; \</span><br><span class="line">  --to=$&#123;LOCAL_REGISTRY&#125;/$&#123;LOCAL_REPOSITORY&#125; \</span><br><span class="line">  --to-release-image=$&#123;LOCAL_REGISTRY&#125;/$&#123;LOCAL_REPOSITORY&#125;:$&#123;OCP_RELEASE&#125; \</span><br><span class="line">  --insecure # 镜像仓库是自签名证书，所以加这个选项</span><br></pre></td></tr></table></figure>

<p>下面是输出，可以临时保存下:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line">info: Mirroring 110 images to registry.openshift4.example.com/ocp4/openshift4 ...</span><br><span class="line">registry.openshift4.example.com/</span><br><span class="line">  ocp4/openshift4</span><br><span class="line">    manifests:</span><br><span class="line">      sha256:00edb6c1dae03e1870e1819b4a8d29b655fb6fc40a396a0db2d7c8a20bd8ab8d -&gt; 4.5.9-local-storage-static-provisioner</span><br><span class="line">      sha256:0259aa5845ce43114c63d59cedeb71c9aa5781c0a6154fe5af8e3cb7bfcfa304 -&gt; 4.5.9-machine-api-operator</span><br><span class="line">      sha256:07f11763953a2293bac5d662b6bd49c883111ba324599c6b6b28e9f9f74112be -&gt; 4.5.9-cluster-kube-storage-version-migrator-operator</span><br><span class="line">      sha256:08068503746a2dfd4dcaf61dca44680a9a066960cac7b1e81ea83e1f157e7e8c -&gt; 4.5.9-service-ca-operator</span><br><span class="line">      sha256:09a7dea10cd584c6048f8df3dcec67dd9a8432eb44051353e180dfeb350c6310 -&gt; 4.5.9-cluster-node-tuning-operator</span><br><span class="line">      sha256:09c763b2ad50711c2b1b5f26c9c70875f821f460e7214f1b11c4be8374424f42 -&gt; 4.5.9-kube-client-agent</span><br><span class="line">      sha256:1140eff8442d5ac679a3a85655723cd51f12a63c0c8d61251214ff952cc40b06 -&gt; 4.5.9-container-networking-plugins</span><br><span class="line">      sha256:13179789b2e15ecf749f5ab51cf11756e2831bc019c02ed0659182e805e725dd -&gt; 4.5.9-cluster-etcd-operator</span><br><span class="line">      sha256:14f97b5e9195c8f9b682523dc1febbb1f75fd60d408ac2731cdfa047aee0f43d -&gt; 4.5.9-must-gather</span><br><span class="line">      sha256:15be0e6de6e0d7bec726611f1dcecd162325ee57b993e0d886e70c25a1faacc3 -&gt; 4.5.9-openshift-controller-manager</span><br><span class="line">      sha256:167c14d56714982360fbaa72b3eb3f8d4fb6c5ad10bbbb7ea396606d8412b7eb -&gt; 4.5.9-sdn</span><br><span class="line">      sha256:1960c492ce80345e03d50c6cada3d37341ca604d891c48b03109de525e99997a -&gt; 4.5.9-tests</span><br><span class="line">      sha256:1c24c01e807700d30430ce4ff2f77b54d55910cfbf9ee0cbe5c1c64979547463 -&gt; 4.5.9-prometheus-operator</span><br><span class="line">      sha256:1cf4b3ce90933a7dbef9d01ebcb00a7f490dce7c44de6ddb16ddebad07de8eda -&gt; 4.5.9-k8s-prometheus-adapter</span><br><span class="line">      sha256:1d73207be4fbba735dbb53facd23c2359886a9194df3267fd91a843a7ba10316 -&gt; 4.5.9-console-operator</span><br><span class="line">      sha256:203ab5955dbcbc5f3334e1d7f2ba9fac5f7a1e187370e88c08ad2996a8507711 -&gt; 4.5.9-aws-pod-identity-webhook</span><br><span class="line">      sha256:21fdd7329f0d9d85acb935223915fbb3af07d4ea051678fc8ec85e47ab95edb1 -&gt; 4.5.9-mdns-publisher</span><br><span class="line">      sha256:22e47de98549ac9e792f06d4083b5d99db3ecc8dc4c94c8950dba9756a75dc28 -&gt; 4.5.9-grafana</span><br><span class="line">      sha256:2527b9f6712b8551cbcec637fc87bb9640973e9f9f4972d489c5308ef25eeed0 -&gt; 4.5.9-jenkins</span><br><span class="line">      sha256:273585703f8f56c980ff77f9a71e6e380d8caa645c4101525572906e0820e8fc -&gt; 4.5.9-docker-builder</span><br><span class="line">      sha256:27774942e605c4d4b13da7721c75135aac27db8409862625b76f5b31eb2e0d63 -&gt; 4.5.9-keepalived-ipfailover</span><br><span class="line">      sha256:2899afae1d0d9baa0309944dd55975a195a2cbd211f9ecf574e39287827fa684 -&gt; 4.5.9-ovirt-machine-controllers</span><br><span class="line">      sha256:289d792eada5d1460d69a927dff31328b5fcb1f1d2e31eb7a3fd69afd9a118fc -&gt; 4.5.9-kuryr-cni</span><br><span class="line">      sha256:2b40c4a5cb2a9586ec6c8e43e3013e6ee97781399b2fa836cf8d6c181ff8430c -&gt; 4.5.9-jenkins-agent-maven</span><br><span class="line">      sha256:2be07ebc1d005decbb8e624e9beb4d282900f42eb4f8ec0b76e31daedd8874cc -&gt; 4.5.9-installer-artifacts</span><br><span class="line">      sha256:3161e52e7bbbf445170c4992d5a47ed87c1d026a7f94b8d0cd30c4508fb48643 -&gt; 4.5.9-oauth-server</span><br><span class="line">      sha256:36e7c99acba49c22c7b84a339bfdab820fae17dec07cb4a17db18617b1d46a37 -&gt; 4.5.9-kube-etcd-signer-server</span><br><span class="line">      sha256:39f8b615e82b3a3a087d6f7d301303d8a0862e4ca13e8f99e6ad968a04985f80 -&gt; 4.5.9-cli</span><br><span class="line">      sha256:3b893950a9db5aa3653d80b05b236e72c168ff368d1c2e0192dd6036486eb715 -&gt; 4.5.9-cluster-version-operator</span><br><span class="line">      sha256:3bbdc631a9271d45960e9db061bde9bc87c6b1df3ec58a17f81dd7326065b4dd -&gt; 4.5.9-prom-label-proxy</span><br><span class="line">      sha256:3c45fb79851e8498666470739c452535d16fde408f54461cc3e239608ae55943 -&gt; 4.5.9-ironic-ipa-downloader</span><br><span class="line">      sha256:3ec062eef4a908c7ce7ee01222a641505f9ccb45e4864f4d3c40a2c3160928f2 -&gt; 4.5.9-azure-machine-controllers</span><br><span class="line">      sha256:416ad8f3ddd49adae4f7db66f8a130319084604296c076c2a6d22264a5688d65 -&gt; 4.5.9-cluster-bootstrap</span><br><span class="line">      sha256:43fdf850ddbbad7b727eff2850d1886a69b6efca837ff8a35d097c1f15f0922c -&gt; 4.5.9-aws-machine-controllers</span><br><span class="line">      sha256:45ec998707309535437f03a2f361ea4c660744c41926258f6a42b566228fe59a -&gt; 4.5.9-jenkins-agent-nodejs</span><br><span class="line">      sha256:486ed094bac19bd3be37eff728596319f73e5648cfb49742ef8c1a859db15e55 -&gt; 4.5.9-operator-lifecycle-manager</span><br><span class="line">      sha256:4a547f79252b06c0fd9fa112d4bca0cd2e5958f471e9a872e33f4e917c1ebccd -&gt; 4.5.9-cluster-update-keys</span><br><span class="line">      sha256:4b15cf622173dedc8ab30dd1d81c7a4ffe2317fce9fd179bb26b04167604bfab -&gt; 4.5.9-kube-state-metrics</span><br><span class="line">      sha256:4d10b546ad2eb8bf67b50217e441d3b01d219ceb96bdf31855a5199fc23c29c7 -&gt; 4.5.9-cluster-autoscaler-operator</span><br><span class="line">      sha256:4d4f72c1556d2085c55691bddf5fadea7bb14ba980fdc28f02146b090134f3a6 -&gt; 4.5.9-cluster-svcat-apiserver-operator</span><br><span class="line">      sha256:4f99f1a5d8a5b7789016316ab33319e5d8b1b27b42ccfb974eb98b27968683b5 -&gt; 4.5.9-prometheus-alertmanager</span><br><span class="line">      sha256:521721a7d0d298eb361d550c08f682942323a68d07e580450e2a64cbfab54880 -&gt; 4.5.9-baremetal-machine-controllers</span><br><span class="line">      sha256:52a566dabf19f82f3fba485807784bd34b2b6a03539d0a2c471ea283ee601e62 -&gt; 4.5.9-openstack-machine-controllers</span><br><span class="line">      sha256:5f77b35d6095068e685cd389f5aeea4b3fad82e771957663839baaa331859eee -&gt; 4.5.9-libvirt-machine-controllers</span><br><span class="line">      sha256:62b44f524d9b820855629cb01bc8c7fff79a039a72f3b421761e1a65ea621b13 -&gt; 4.5.9-baremetal-runtimecfg</span><br><span class="line">      sha256:65dc7fc90223061deec270ecdfa365d509950a1efa4b9025c9355d02b8c22f9b -&gt; 4.5.9-cluster-machine-approver</span><br><span class="line">      sha256:66e8675a73707d519467b3598259587de325315e186a839c233f3659f58be534 -&gt; 4.5.9-ironic</span><br><span class="line">      sha256:6b4bc1c8fa3e762d70a837f63f660e4ff3e129015d35c82a7b6da0c6fb7919da -&gt; 4.5.9-kube-rbac-proxy</span><br><span class="line">      sha256:708de132d6a5a6c15c0b7f04f572cd85ff67b1733c5235d74b74f3a690a98ce7 -&gt; 4.5.9-ironic-machine-os-downloader</span><br><span class="line">      sha256:70c3c46df383aa123ffd0a09f18afcc92e894b01cb9edc4e42cdac9b4a092fa1 -&gt; 4.5.9-cluster-svcat-controller-manager-operator</span><br><span class="line">      sha256:74c4a3c93c7fba691195dec0190a47cf194759b381d41045a52b6c86aa4169c4 -&gt; 4.5.9-cluster-ingress-operator</span><br><span class="line">      sha256:755c6cd68730ad7f72950be4110c79b971403864cb9bf8f211edf4d35858b2e6 -&gt; 4.5.9-multus-cni</span><br><span class="line">      sha256:792a91df9bb7c4fb49f01c0a70479cc356aa324082ad869bf141a7ff98f51f5a -&gt; 4.5.9-deployer</span><br><span class="line">      sha256:7a56d91d1e0aeddc46dce7fcfda56d4430321e14563e10207893a360a87d3111 -&gt; 4.5.9-ironic-inspector</span><br><span class="line">      sha256:7ad540594e2a667300dd2584fe2ede2c1a0b814ee6a62f60809d87ab564f4425 -&gt; 4.5.9-x86_64</span><br><span class="line">      sha256:80cb8dd15ae02c81ba09387560eb3edb8a12645b3a3179620038df340f51bd54 -&gt; 4.5.9-thanos</span><br><span class="line">      sha256:84cb2378e2115c1fba70f6cb7ccf053ad848a2038a38c2f5ab45a2e5f21d871c -&gt; 4.5.9-console</span><br><span class="line">      sha256:87037e2988ca6fee330729017c4ecb164f1a6f68e9eb4edacc976c3efb9515fd -&gt; 4.5.9-insights-operator</span><br><span class="line">      sha256:8bd68e0f18cd6ba0a6f12848f3edb630fcca9090a272aa58e3818a6382067e52 -&gt; 4.5.9-kuryr-controller</span><br><span class="line">      sha256:8c25f463d04079a8a93791c307ff893264855d60bbb8ba7a54179d9d44fc2f9f -&gt; 4.5.9-openshift-state-metrics</span><br><span class="line">      sha256:8ee14d942d7a971f52147b15fbd706844e250bd6c72c42150d92fc53cc826111 -&gt; 4.5.9-prometheus-config-reloader</span><br><span class="line">      sha256:95e63453871b0aca40375be741597363cb8b4393a2d59b2924bb4a4123b4835e -&gt; 4.5.9-csi-snapshot-controller</span><br><span class="line">      sha256:9bf5e6781444c43939ccf52f4d69fa163dd0faf874bff3c0adb2f259780f2b47 -&gt; 4.5.9-ovn-kubernetes</span><br><span class="line">      sha256:9d7cf54cc50ab837ec797954ff49c0d6c9989e1b3079431199026203f512daf9 -&gt; 4.5.9-cluster-openshift-controller-manager-operator</span><br><span class="line">      sha256:a14dc3297e6ea3098118c920275fc54aeb29d2f490e5023f9cbb37b6af05be81 -&gt; 4.5.9-cluster-dns-operator</span><br><span class="line">      sha256:a25790af4a004de3183a44b240dd3a3138749fae3ffa4ac41cca94319f614213 -&gt; 4.5.9-openshift-apiserver</span><br><span class="line">      sha256:a48d986d1731609226d8f6876c7cef21e8cefccd4e04c000f255b1f6f908a5ea -&gt; 4.5.9-cluster-csi-snapshot-controller-operator</span><br><span class="line">      sha256:a51adfc033493814df1a193b0de547749e052cb0811edacc05b878e1fef167b8 -&gt; 4.5.9-etcd</span><br><span class="line">      sha256:a7433426912aa9ff24b63105c5799d47614978ee80a4a241f5e9f31e8e588710 -&gt; 4.5.9-cluster-network-operator</span><br><span class="line">      sha256:aa73c07c74838b11b6150c6907ab2c40c86a40eb63bf2c59db881815ab3553c5 -&gt; 4.5.9-coredns</span><br><span class="line">      sha256:adc3e7c9ab16095165261f0feef990bb829ccf57ae506dadf3734cee0801057a -&gt; 4.5.9-cluster-image-registry-operator</span><br><span class="line">      sha256:af0f67519dbd7ffe2732d89cfa342ee55557f0dc5e8ee8c674eed5ff209bb15a -&gt; 4.5.9-machine-os-content</span><br><span class="line">      sha256:b05f9e685b3f20f96fa952c7c31b2bfcf96643e141ae961ed355684d2d209310 -&gt; 4.5.9-baremetal-installer</span><br><span class="line">      sha256:b1f97ac926075c15a45aac7249e03ff583159b6e03c429132c3111ed5302727b -&gt; 4.5.9-multus-admission-controller</span><br><span class="line">      sha256:b7261a317a4bdd681f8812c2022ff7f391a606f2b80a1c068363c5675abd4363 -&gt; 4.5.9-cluster-samples-operator</span><br><span class="line">      sha256:bb64c463c4b999fbd124a772e3db56f27c74b1e033052c737b69510fc1b9e590 -&gt; 4.5.9-pod</span><br><span class="line">      sha256:bc6c8fd4358d3a46f8df4d81cd424e8778b344c368e6855ed45492815c581438 -&gt; 4.5.9-hyperkube</span><br><span class="line">      sha256:bcd6cd1559b62e4a8031cf0e1676e25585845022d240ac3d927ea47a93469597 -&gt; 4.5.9-machine-config-operator</span><br><span class="line">      sha256:bcd799425dbdbc7361a44c8bfdc7e6cc3f6f31d59ac18cbea14f3dce8de12d62 -&gt; 4.5.9-cluster-policy-controller</span><br><span class="line">      sha256:bf0d5fd64ab53dfdd477c90a293f3ec90379a22e8b356044082e807565699863 -&gt; 4.5.9-cloud-credential-operator</span><br><span class="line">      sha256:c011c86ee352f377bbcaa46521b731677e81195240cdd4faba7a25a679f00530 -&gt; 4.5.9-cluster-autoscaler</span><br><span class="line">      sha256:c3fc77b6c7ab6e1e2593043532d2a9076831915f2da031fa10aa62bdfbbd7ba8 -&gt; 4.5.9-prometheus-node-exporter</span><br><span class="line">      sha256:c492193a82adfb303b1ac27e48a12cc248c13d120909c98ea19088debe47fd8d -&gt; 4.5.9-kube-storage-version-migrator</span><br><span class="line">      sha256:c4fee4a9d551caa8bfa8cca0a1fb919408a86451bccb3649965c09dcab068a88 -&gt; 4.5.9-operator-marketplace</span><br><span class="line">      sha256:c516f6fa1dd2bf3cca769a32eae08fd027250d56361abb790910c9a18f9fcf07 -&gt; 4.5.9-cluster-node-tuned</span><br><span class="line">      sha256:c93a0de1e4cb3f04e37d547c1b81a2a22c4d9d01c013374c466ed3fd0416215a -&gt; 4.5.9-cluster-config-operator</span><br><span class="line">      sha256:ca556d4515818e3e10d2e771d986784460509146ea9dd188fb8ba6f6ac694132 -&gt; 4.5.9-cluster-kube-controller-manager-operator</span><br><span class="line">      sha256:cca683b844f3e73bb8160e27b986762e77601831eca77e2eea6d94a499959869 -&gt; 4.5.9-multus-route-override-cni</span><br><span class="line">      sha256:cd1f7e40de6a170946faea98f94375f5aae2d9868c049f9ed00fb4f07b32d775 -&gt; 4.5.9-kube-proxy</span><br><span class="line">      sha256:d014f98f1d9a5a6f7e70294830583670d1b17892d38bc8c009ec974f12599bff -&gt; 4.5.9-tools</span><br><span class="line">      sha256:d0d21ae3e27140e1fa13b49d6b2883a0f1466d8e47a2a4839f22de80668d5c95 -&gt; 4.5.9-haproxy-router</span><br><span class="line">      sha256:d11eff4148b733de49e588cfe4c002b5fdd3dea5caea4a7a3a1087390782e56a -&gt; 4.5.9-cluster-openshift-apiserver-operator</span><br><span class="line">      sha256:d72cbba07de1dacfe3669e11fa4f4efa2c7b65664899923622b0ca0715573671 -&gt; 4.5.9-telemeter</span><br><span class="line">      sha256:d8725a2f93d0df184617a41995ee068914ca5a155cdf11c304553abcc4c3100a -&gt; 4.5.9-cli-artifacts</span><br><span class="line">      sha256:db0794d279028179c45791b0dc7ff22f2172d2267d85e0a37ef2a26ffda9c642 -&gt; 4.5.9-cluster-storage-operator</span><br><span class="line">      sha256:dbca81e9b4055763f422c22df01a77efba1dca499686a24210795f2ffddf20c9 -&gt; 4.5.9-docker-registry</span><br><span class="line">      sha256:ddb26e047d0e0d7b11bdb625bd7a941ab66f7e1ef5a5f7455d8694e7ba48989d -&gt; 4.5.9-cluster-kube-scheduler-operator</span><br><span class="line">      sha256:e1d1cea1cf52358b3e91ce8176b83ad36b6b28a226ee6f356fa11496396d93ec -&gt; 4.5.9-cluster-authentication-operator</span><br><span class="line">      sha256:e34e4f3b0097db265b40d627c2cc7b4ddd953a30b7dd283e2ec4bbe5c257a49e -&gt; 4.5.9-configmap-reloader</span><br><span class="line">      sha256:e4758039391099dc1b0265099474113dcd8bcce84a1c92d02c1ef760793079e6 -&gt; 4.5.9-cluster-kube-apiserver-operator</span><br><span class="line">      sha256:e4aae960b36e292b9807f9dc6f3feb57b62cc6a91f9349f983468a1102dc01a7 -&gt; 4.5.9-multus-whereabouts-ipam-cni</span><br><span class="line">      sha256:e8e8da1a4d743770940708c84408dc6188e4df2104c014160e051ef4a8c51b04 -&gt; 4.5.9-baremetal-operator</span><br><span class="line">      sha256:ea61c3e635bbaacd3b0833cf1983f25d3fc6eddc306230bf2703334ba61c1c26 -&gt; 4.5.9-gcp-machine-controllers</span><br><span class="line">      sha256:ec29896354cb1f651142e1c3793890fb59e5252955cb5706cca0e6917e888a61 -&gt; 4.5.9-oauth-proxy</span><br><span class="line">      sha256:ec3a914142ee8dfa01b7a407f7909ff766c210c44a33d4fa731f5547fdb65796 -&gt; 4.5.9-ironic-static-ip-manager</span><br><span class="line">      sha256:ee00cecd8084aac097d0b0ee2033d7931467d92f00643c6434ce6620d643cf35 -&gt; 4.5.9-operator-registry</span><br><span class="line">      sha256:eee108b303058e74c75b5cf16aeefaeb9d0972cd25cf09e0d33ef3213dcd50d0 -&gt; 4.5.9-cluster-monitoring-operator</span><br><span class="line">      sha256:f6b9d00a5dbde8a772b0709aa4ae7d686aa2b645a2a6fbee85eebe15925f8fbb -&gt; 4.5.9-prometheus</span><br><span class="line">      sha256:f70fdff00e09230af556265af72a87fbc22de2cf0f6447ebc8205baaca02fae2 -&gt; 4.5.9-installer</span><br><span class="line">      sha256:fbc84979fec952728014a8551f6cb0deb436f19aa288b8e03803ae370fc3c911 -&gt; 4.5.9-ironic-hardware-inventory-recorder</span><br><span class="line">  stats: shared=0 unique=0 size=0B</span><br><span class="line"></span><br><span class="line">phase 0:</span><br><span class="line">  registry.openshift4.example.com ocp4/openshift4 blobs=0 mounts=0 manifests=110 shared=0</span><br><span class="line"></span><br><span class="line">info: Planning completed in 22.31s</span><br><span class="line">sha256:ec3a914142ee8dfa01b7a407f7909ff766c210c44a33d4fa731f5547fdb65796 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ironic-static-ip-manager</span><br><span class="line">sha256:f6b9d00a5dbde8a772b0709aa4ae7d686aa2b645a2a6fbee85eebe15925f8fbb registry.openshift4.example.com/ocp4/openshift4:4.5.9-prometheus</span><br><span class="line">sha256:65dc7fc90223061deec270ecdfa365d509950a1efa4b9025c9355d02b8c22f9b registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-machine-approver</span><br><span class="line">sha256:9d7cf54cc50ab837ec797954ff49c0d6c9989e1b3079431199026203f512daf9 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-openshift-controller-manager-operator</span><br><span class="line">sha256:07f11763953a2293bac5d662b6bd49c883111ba324599c6b6b28e9f9f74112be registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-kube-storage-version-migrator-operator</span><br><span class="line">sha256:3bbdc631a9271d45960e9db061bde9bc87c6b1df3ec58a17f81dd7326065b4dd registry.openshift4.example.com/ocp4/openshift4:4.5.9-prom-label-proxy</span><br><span class="line">sha256:bc6c8fd4358d3a46f8df4d81cd424e8778b344c368e6855ed45492815c581438 registry.openshift4.example.com/ocp4/openshift4:4.5.9-hyperkube</span><br><span class="line">sha256:167c14d56714982360fbaa72b3eb3f8d4fb6c5ad10bbbb7ea396606d8412b7eb registry.openshift4.example.com/ocp4/openshift4:4.5.9-sdn</span><br><span class="line">sha256:486ed094bac19bd3be37eff728596319f73e5648cfb49742ef8c1a859db15e55 registry.openshift4.example.com/ocp4/openshift4:4.5.9-operator-lifecycle-manager</span><br><span class="line">sha256:c011c86ee352f377bbcaa46521b731677e81195240cdd4faba7a25a679f00530 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-autoscaler</span><br><span class="line">sha256:e4aae960b36e292b9807f9dc6f3feb57b62cc6a91f9349f983468a1102dc01a7 registry.openshift4.example.com/ocp4/openshift4:4.5.9-multus-whereabouts-ipam-cni</span><br><span class="line">sha256:ea61c3e635bbaacd3b0833cf1983f25d3fc6eddc306230bf2703334ba61c1c26 registry.openshift4.example.com/ocp4/openshift4:4.5.9-gcp-machine-controllers</span><br><span class="line">sha256:bf0d5fd64ab53dfdd477c90a293f3ec90379a22e8b356044082e807565699863 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cloud-credential-operator</span><br><span class="line">sha256:ddb26e047d0e0d7b11bdb625bd7a941ab66f7e1ef5a5f7455d8694e7ba48989d registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-kube-scheduler-operator</span><br><span class="line">sha256:cd1f7e40de6a170946faea98f94375f5aae2d9868c049f9ed00fb4f07b32d775 registry.openshift4.example.com/ocp4/openshift4:4.5.9-kube-proxy</span><br><span class="line">sha256:adc3e7c9ab16095165261f0feef990bb829ccf57ae506dadf3734cee0801057a registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-image-registry-operator</span><br><span class="line">sha256:eee108b303058e74c75b5cf16aeefaeb9d0972cd25cf09e0d33ef3213dcd50d0 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-monitoring-operator</span><br><span class="line">sha256:09c763b2ad50711c2b1b5f26c9c70875f821f460e7214f1b11c4be8374424f42 registry.openshift4.example.com/ocp4/openshift4:4.5.9-kube-client-agent</span><br><span class="line">sha256:4d10b546ad2eb8bf67b50217e441d3b01d219ceb96bdf31855a5199fc23c29c7 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-autoscaler-operator</span><br><span class="line">sha256:80cb8dd15ae02c81ba09387560eb3edb8a12645b3a3179620038df340f51bd54 registry.openshift4.example.com/ocp4/openshift4:4.5.9-thanos</span><br><span class="line">sha256:21fdd7329f0d9d85acb935223915fbb3af07d4ea051678fc8ec85e47ab95edb1 registry.openshift4.example.com/ocp4/openshift4:4.5.9-mdns-publisher</span><br><span class="line">sha256:87037e2988ca6fee330729017c4ecb164f1a6f68e9eb4edacc976c3efb9515fd registry.openshift4.example.com/ocp4/openshift4:4.5.9-insights-operator</span><br><span class="line">sha256:74c4a3c93c7fba691195dec0190a47cf194759b381d41045a52b6c86aa4169c4 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-ingress-operator</span><br><span class="line">sha256:d8725a2f93d0df184617a41995ee068914ca5a155cdf11c304553abcc4c3100a registry.openshift4.example.com/ocp4/openshift4:4.5.9-cli-artifacts</span><br><span class="line">sha256:a25790af4a004de3183a44b240dd3a3138749fae3ffa4ac41cca94319f614213 registry.openshift4.example.com/ocp4/openshift4:4.5.9-openshift-apiserver</span><br><span class="line">sha256:e8e8da1a4d743770940708c84408dc6188e4df2104c014160e051ef4a8c51b04 registry.openshift4.example.com/ocp4/openshift4:4.5.9-baremetal-operator</span><br><span class="line">sha256:521721a7d0d298eb361d550c08f682942323a68d07e580450e2a64cbfab54880 registry.openshift4.example.com/ocp4/openshift4:4.5.9-baremetal-machine-controllers</span><br><span class="line">sha256:d11eff4148b733de49e588cfe4c002b5fdd3dea5caea4a7a3a1087390782e56a registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-openshift-apiserver-operator</span><br><span class="line">sha256:4b15cf622173dedc8ab30dd1d81c7a4ffe2317fce9fd179bb26b04167604bfab registry.openshift4.example.com/ocp4/openshift4:4.5.9-kube-state-metrics</span><br><span class="line">sha256:cca683b844f3e73bb8160e27b986762e77601831eca77e2eea6d94a499959869 registry.openshift4.example.com/ocp4/openshift4:4.5.9-multus-route-override-cni</span><br><span class="line">sha256:70c3c46df383aa123ffd0a09f18afcc92e894b01cb9edc4e42cdac9b4a092fa1 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-svcat-controller-manager-operator</span><br><span class="line">sha256:a48d986d1731609226d8f6876c7cef21e8cefccd4e04c000f255b1f6f908a5ea registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-csi-snapshot-controller-operator</span><br><span class="line">sha256:5f77b35d6095068e685cd389f5aeea4b3fad82e771957663839baaa331859eee registry.openshift4.example.com/ocp4/openshift4:4.5.9-libvirt-machine-controllers</span><br><span class="line">sha256:203ab5955dbcbc5f3334e1d7f2ba9fac5f7a1e187370e88c08ad2996a8507711 registry.openshift4.example.com/ocp4/openshift4:4.5.9-aws-pod-identity-webhook</span><br><span class="line">sha256:aa73c07c74838b11b6150c6907ab2c40c86a40eb63bf2c59db881815ab3553c5 registry.openshift4.example.com/ocp4/openshift4:4.5.9-coredns</span><br><span class="line">sha256:ee00cecd8084aac097d0b0ee2033d7931467d92f00643c6434ce6620d643cf35 registry.openshift4.example.com/ocp4/openshift4:4.5.9-operator-registry</span><br><span class="line">sha256:e1d1cea1cf52358b3e91ce8176b83ad36b6b28a226ee6f356fa11496396d93ec registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-authentication-operator</span><br><span class="line">sha256:c4fee4a9d551caa8bfa8cca0a1fb919408a86451bccb3649965c09dcab068a88 registry.openshift4.example.com/ocp4/openshift4:4.5.9-operator-marketplace</span><br><span class="line">sha256:08068503746a2dfd4dcaf61dca44680a9a066960cac7b1e81ea83e1f157e7e8c registry.openshift4.example.com/ocp4/openshift4:4.5.9-service-ca-operator</span><br><span class="line">sha256:ec29896354cb1f651142e1c3793890fb59e5252955cb5706cca0e6917e888a61 registry.openshift4.example.com/ocp4/openshift4:4.5.9-oauth-proxy</span><br><span class="line">sha256:4f99f1a5d8a5b7789016316ab33319e5d8b1b27b42ccfb974eb98b27968683b5 registry.openshift4.example.com/ocp4/openshift4:4.5.9-prometheus-alertmanager</span><br><span class="line">sha256:e4758039391099dc1b0265099474113dcd8bcce84a1c92d02c1ef760793079e6 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-kube-apiserver-operator</span><br><span class="line">sha256:ca556d4515818e3e10d2e771d986784460509146ea9dd188fb8ba6f6ac694132 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-kube-controller-manager-operator</span><br><span class="line">sha256:b05f9e685b3f20f96fa952c7c31b2bfcf96643e141ae961ed355684d2d209310 registry.openshift4.example.com/ocp4/openshift4:4.5.9-baremetal-installer</span><br><span class="line">sha256:22e47de98549ac9e792f06d4083b5d99db3ecc8dc4c94c8950dba9756a75dc28 registry.openshift4.example.com/ocp4/openshift4:4.5.9-grafana</span><br><span class="line">sha256:84cb2378e2115c1fba70f6cb7ccf053ad848a2038a38c2f5ab45a2e5f21d871c registry.openshift4.example.com/ocp4/openshift4:4.5.9-console</span><br><span class="line">sha256:0259aa5845ce43114c63d59cedeb71c9aa5781c0a6154fe5af8e3cb7bfcfa304 registry.openshift4.example.com/ocp4/openshift4:4.5.9-machine-api-operator</span><br><span class="line">sha256:1d73207be4fbba735dbb53facd23c2359886a9194df3267fd91a843a7ba10316 registry.openshift4.example.com/ocp4/openshift4:4.5.9-console-operator</span><br><span class="line">sha256:27774942e605c4d4b13da7721c75135aac27db8409862625b76f5b31eb2e0d63 registry.openshift4.example.com/ocp4/openshift4:4.5.9-keepalived-ipfailover</span><br><span class="line">sha256:2be07ebc1d005decbb8e624e9beb4d282900f42eb4f8ec0b76e31daedd8874cc registry.openshift4.example.com/ocp4/openshift4:4.5.9-installer-artifacts</span><br><span class="line">sha256:15be0e6de6e0d7bec726611f1dcecd162325ee57b993e0d886e70c25a1faacc3 registry.openshift4.example.com/ocp4/openshift4:4.5.9-openshift-controller-manager</span><br><span class="line">sha256:c3fc77b6c7ab6e1e2593043532d2a9076831915f2da031fa10aa62bdfbbd7ba8 registry.openshift4.example.com/ocp4/openshift4:4.5.9-prometheus-node-exporter</span><br><span class="line">sha256:36e7c99acba49c22c7b84a339bfdab820fae17dec07cb4a17db18617b1d46a37 registry.openshift4.example.com/ocp4/openshift4:4.5.9-kube-etcd-signer-server</span><br><span class="line">sha256:3c45fb79851e8498666470739c452535d16fde408f54461cc3e239608ae55943 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ironic-ipa-downloader</span><br><span class="line">sha256:b7261a317a4bdd681f8812c2022ff7f391a606f2b80a1c068363c5675abd4363 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-samples-operator</span><br><span class="line">sha256:2899afae1d0d9baa0309944dd55975a195a2cbd211f9ecf574e39287827fa684 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ovirt-machine-controllers</span><br><span class="line">sha256:95e63453871b0aca40375be741597363cb8b4393a2d59b2924bb4a4123b4835e registry.openshift4.example.com/ocp4/openshift4:4.5.9-csi-snapshot-controller</span><br><span class="line">sha256:e34e4f3b0097db265b40d627c2cc7b4ddd953a30b7dd283e2ec4bbe5c257a49e registry.openshift4.example.com/ocp4/openshift4:4.5.9-configmap-reloader</span><br><span class="line">sha256:45ec998707309535437f03a2f361ea4c660744c41926258f6a42b566228fe59a registry.openshift4.example.com/ocp4/openshift4:4.5.9-jenkins-agent-nodejs</span><br><span class="line">sha256:1c24c01e807700d30430ce4ff2f77b54d55910cfbf9ee0cbe5c1c64979547463 registry.openshift4.example.com/ocp4/openshift4:4.5.9-prometheus-operator</span><br><span class="line">sha256:d0d21ae3e27140e1fa13b49d6b2883a0f1466d8e47a2a4839f22de80668d5c95 registry.openshift4.example.com/ocp4/openshift4:4.5.9-haproxy-router</span><br><span class="line">sha256:3161e52e7bbbf445170c4992d5a47ed87c1d026a7f94b8d0cd30c4508fb48643 registry.openshift4.example.com/ocp4/openshift4:4.5.9-oauth-server</span><br><span class="line">sha256:13179789b2e15ecf749f5ab51cf11756e2831bc019c02ed0659182e805e725dd registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-etcd-operator</span><br><span class="line">sha256:d014f98f1d9a5a6f7e70294830583670d1b17892d38bc8c009ec974f12599bff registry.openshift4.example.com/ocp4/openshift4:4.5.9-tools</span><br><span class="line">sha256:792a91df9bb7c4fb49f01c0a70479cc356aa324082ad869bf141a7ff98f51f5a registry.openshift4.example.com/ocp4/openshift4:4.5.9-deployer</span><br><span class="line">sha256:8bd68e0f18cd6ba0a6f12848f3edb630fcca9090a272aa58e3818a6382067e52 registry.openshift4.example.com/ocp4/openshift4:4.5.9-kuryr-controller</span><br><span class="line">sha256:62b44f524d9b820855629cb01bc8c7fff79a039a72f3b421761e1a65ea621b13 registry.openshift4.example.com/ocp4/openshift4:4.5.9-baremetal-runtimecfg</span><br><span class="line">sha256:dbca81e9b4055763f422c22df01a77efba1dca499686a24210795f2ffddf20c9 registry.openshift4.example.com/ocp4/openshift4:4.5.9-docker-registry</span><br><span class="line">sha256:52a566dabf19f82f3fba485807784bd34b2b6a03539d0a2c471ea283ee601e62 registry.openshift4.example.com/ocp4/openshift4:4.5.9-openstack-machine-controllers</span><br><span class="line">sha256:8c25f463d04079a8a93791c307ff893264855d60bbb8ba7a54179d9d44fc2f9f registry.openshift4.example.com/ocp4/openshift4:4.5.9-openshift-state-metrics</span><br><span class="line">sha256:43fdf850ddbbad7b727eff2850d1886a69b6efca837ff8a35d097c1f15f0922c registry.openshift4.example.com/ocp4/openshift4:4.5.9-aws-machine-controllers</span><br><span class="line">sha256:708de132d6a5a6c15c0b7f04f572cd85ff67b1733c5235d74b74f3a690a98ce7 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ironic-machine-os-downloader</span><br><span class="line">sha256:f70fdff00e09230af556265af72a87fbc22de2cf0f6447ebc8205baaca02fae2 registry.openshift4.example.com/ocp4/openshift4:4.5.9-installer</span><br><span class="line">sha256:c516f6fa1dd2bf3cca769a32eae08fd027250d56361abb790910c9a18f9fcf07 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-node-tuned</span><br><span class="line">sha256:bcd799425dbdbc7361a44c8bfdc7e6cc3f6f31d59ac18cbea14f3dce8de12d62 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-policy-controller</span><br><span class="line">sha256:8ee14d942d7a971f52147b15fbd706844e250bd6c72c42150d92fc53cc826111 registry.openshift4.example.com/ocp4/openshift4:4.5.9-prometheus-config-reloader</span><br><span class="line">sha256:09a7dea10cd584c6048f8df3dcec67dd9a8432eb44051353e180dfeb350c6310 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-node-tuning-operator</span><br><span class="line">sha256:3b893950a9db5aa3653d80b05b236e72c168ff368d1c2e0192dd6036486eb715 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-version-operator</span><br><span class="line">sha256:4a547f79252b06c0fd9fa112d4bca0cd2e5958f471e9a872e33f4e917c1ebccd registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-update-keys</span><br><span class="line">sha256:2527b9f6712b8551cbcec637fc87bb9640973e9f9f4972d489c5308ef25eeed0 registry.openshift4.example.com/ocp4/openshift4:4.5.9-jenkins</span><br><span class="line">sha256:1cf4b3ce90933a7dbef9d01ebcb00a7f490dce7c44de6ddb16ddebad07de8eda registry.openshift4.example.com/ocp4/openshift4:4.5.9-k8s-prometheus-adapter</span><br><span class="line">sha256:416ad8f3ddd49adae4f7db66f8a130319084604296c076c2a6d22264a5688d65 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-bootstrap</span><br><span class="line">sha256:7ad540594e2a667300dd2584fe2ede2c1a0b814ee6a62f60809d87ab564f4425 registry.openshift4.example.com/ocp4/openshift4:4.5.9-x86_64</span><br><span class="line">sha256:bcd6cd1559b62e4a8031cf0e1676e25585845022d240ac3d927ea47a93469597 registry.openshift4.example.com/ocp4/openshift4:4.5.9-machine-config-operator</span><br><span class="line">sha256:6b4bc1c8fa3e762d70a837f63f660e4ff3e129015d35c82a7b6da0c6fb7919da registry.openshift4.example.com/ocp4/openshift4:4.5.9-kube-rbac-proxy</span><br><span class="line">sha256:a51adfc033493814df1a193b0de547749e052cb0811edacc05b878e1fef167b8 registry.openshift4.example.com/ocp4/openshift4:4.5.9-etcd</span><br><span class="line">sha256:1960c492ce80345e03d50c6cada3d37341ca604d891c48b03109de525e99997a registry.openshift4.example.com/ocp4/openshift4:4.5.9-tests</span><br><span class="line">sha256:66e8675a73707d519467b3598259587de325315e186a839c233f3659f58be534 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ironic</span><br><span class="line">sha256:755c6cd68730ad7f72950be4110c79b971403864cb9bf8f211edf4d35858b2e6 registry.openshift4.example.com/ocp4/openshift4:4.5.9-multus-cni</span><br><span class="line">sha256:a7433426912aa9ff24b63105c5799d47614978ee80a4a241f5e9f31e8e588710 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-network-operator</span><br><span class="line">sha256:a14dc3297e6ea3098118c920275fc54aeb29d2f490e5023f9cbb37b6af05be81 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-dns-operator</span><br><span class="line">sha256:d72cbba07de1dacfe3669e11fa4f4efa2c7b65664899923622b0ca0715573671 registry.openshift4.example.com/ocp4/openshift4:4.5.9-telemeter</span><br><span class="line">sha256:7a56d91d1e0aeddc46dce7fcfda56d4430321e14563e10207893a360a87d3111 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ironic-inspector</span><br><span class="line">sha256:db0794d279028179c45791b0dc7ff22f2172d2267d85e0a37ef2a26ffda9c642 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-storage-operator</span><br><span class="line">sha256:3ec062eef4a908c7ce7ee01222a641505f9ccb45e4864f4d3c40a2c3160928f2 registry.openshift4.example.com/ocp4/openshift4:4.5.9-azure-machine-controllers</span><br><span class="line">sha256:273585703f8f56c980ff77f9a71e6e380d8caa645c4101525572906e0820e8fc registry.openshift4.example.com/ocp4/openshift4:4.5.9-docker-builder</span><br><span class="line">sha256:4d4f72c1556d2085c55691bddf5fadea7bb14ba980fdc28f02146b090134f3a6 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-svcat-apiserver-operator</span><br><span class="line">sha256:9bf5e6781444c43939ccf52f4d69fa163dd0faf874bff3c0adb2f259780f2b47 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ovn-kubernetes</span><br><span class="line">sha256:289d792eada5d1460d69a927dff31328b5fcb1f1d2e31eb7a3fd69afd9a118fc registry.openshift4.example.com/ocp4/openshift4:4.5.9-kuryr-cni</span><br><span class="line">sha256:af0f67519dbd7ffe2732d89cfa342ee55557f0dc5e8ee8c674eed5ff209bb15a registry.openshift4.example.com/ocp4/openshift4:4.5.9-machine-os-content</span><br><span class="line">sha256:14f97b5e9195c8f9b682523dc1febbb1f75fd60d408ac2731cdfa047aee0f43d registry.openshift4.example.com/ocp4/openshift4:4.5.9-must-gather</span><br><span class="line">sha256:c93a0de1e4cb3f04e37d547c1b81a2a22c4d9d01c013374c466ed3fd0416215a registry.openshift4.example.com/ocp4/openshift4:4.5.9-cluster-config-operator</span><br><span class="line">sha256:b1f97ac926075c15a45aac7249e03ff583159b6e03c429132c3111ed5302727b registry.openshift4.example.com/ocp4/openshift4:4.5.9-multus-admission-controller</span><br><span class="line">sha256:bb64c463c4b999fbd124a772e3db56f27c74b1e033052c737b69510fc1b9e590 registry.openshift4.example.com/ocp4/openshift4:4.5.9-pod</span><br><span class="line">sha256:39f8b615e82b3a3a087d6f7d301303d8a0862e4ca13e8f99e6ad968a04985f80 registry.openshift4.example.com/ocp4/openshift4:4.5.9-cli</span><br><span class="line">sha256:c492193a82adfb303b1ac27e48a12cc248c13d120909c98ea19088debe47fd8d registry.openshift4.example.com/ocp4/openshift4:4.5.9-kube-storage-version-migrator</span><br><span class="line">sha256:2b40c4a5cb2a9586ec6c8e43e3013e6ee97781399b2fa836cf8d6c181ff8430c registry.openshift4.example.com/ocp4/openshift4:4.5.9-jenkins-agent-maven</span><br><span class="line">sha256:00edb6c1dae03e1870e1819b4a8d29b655fb6fc40a396a0db2d7c8a20bd8ab8d registry.openshift4.example.com/ocp4/openshift4:4.5.9-local-storage-static-provisioner</span><br><span class="line">sha256:1140eff8442d5ac679a3a85655723cd51f12a63c0c8d61251214ff952cc40b06 registry.openshift4.example.com/ocp4/openshift4:4.5.9-container-networking-plugins</span><br><span class="line">sha256:fbc84979fec952728014a8551f6cb0deb436f19aa288b8e03803ae370fc3c911 registry.openshift4.example.com/ocp4/openshift4:4.5.9-ironic-hardware-inventory-recorder</span><br><span class="line">info: Mirroring completed in 2.27s (0B/s)</span><br><span class="line"></span><br><span class="line">Success</span><br><span class="line">Update image:  registry.openshift4.example.com/ocp4/openshift4:4.5.9-x86_64</span><br><span class="line">Mirror prefix: registry.openshift4.example.com/ocp4/openshift4</span><br><span class="line"></span><br><span class="line">To use the new mirrored repository to install, add the following section to the install-config.yaml:</span><br><span class="line"></span><br><span class="line">imageContentSources:</span><br><span class="line">- mirrors:</span><br><span class="line">  - registry.openshift4.example.com/ocp4/openshift4</span><br><span class="line">  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev</span><br><span class="line">- mirrors:</span><br><span class="line">  - registry.openshift4.example.com/ocp4/openshift4</span><br><span class="line">  source: quay.io/openshift-release-dev/ocp-release</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">To use the new mirrored repository for upgrades, use the following to create an ImageContentSourcePolicy:</span><br><span class="line"></span><br><span class="line">apiVersion: operator.openshift.io/v1alpha1</span><br><span class="line">kind: ImageContentSourcePolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: example</span><br><span class="line">spec:</span><br><span class="line">  repositoryDigestMirrors:</span><br><span class="line">  - mirrors:</span><br><span class="line">    - registry.openshift4.example.com/ocp4/openshift4</span><br><span class="line">    source: quay.io/openshift-release-dev/ocp-v4.0-art-dev</span><br><span class="line">  - mirrors:</span><br><span class="line">    - registry.openshift4.example.com/ocp4/openshift4</span><br><span class="line">    source: quay.io/openshift-release-dev/ocp-release</span><br></pre></td></tr></table></figure>

<p>梯子不稳定的话多执行几次，<code>oc adm release mirror</code> 命令执行完成后会输出下面类似的信息，保存下来，将来会用在 <code>install-config.yaml</code> 文件中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imageContentSources:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mirrors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">registry.openshift4.example.com/ocp4/openshift4</span></span><br><span class="line">  <span class="attr">source:</span> <span class="string">quay.io/openshift-release-dev/ocp-release</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mirrors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">registry.openshift4.example.com/ocp4/openshift4</span></span><br><span class="line">  <span class="attr">source:</span> <span class="string">quay.io/openshift-release-dev/ocp-v4.0-art-dev</span></span><br></pre></td></tr></table></figure>

<h4 id="同步到本地目录"><a href="#同步到本地目录" class="headerlink" title="同步到本地目录"></a>同步到本地目录</h4><p>这里说下同步到本地，假如云梯的节点和内网是不通的，所以我们需要先在纵云梯节点上把镜像存为文件，后面文件拷贝内网里去推送到内网仓库上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir mirror</span><br><span class="line">oc adm -a $&#123;LOCAL_SECRET_JSON&#125; release mirror \</span><br><span class="line">  --from=quay.io/$&#123;PRODUCT_REPO&#125;/$&#123;RELEASE_NAME&#125;:$&#123;OCP_RELEASE&#125; \</span><br><span class="line">  --to-dir=mirror/</span><br></pre></td></tr></table></figure>

<p>梯子不稳定的话多执行几次，这个命令支持继续上次的位置下载，下载完成后会有下面类似内容</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">phase 0:</span><br><span class="line">   openshift/release blobs=238 mounts=0 manifests=110 shared=5</span><br><span class="line"></span><br><span class="line">info: Planning completed in 22.61s</span><br><span class="line">uploading: file://openshift/release sha256:740e93718e387c4611372639d025bcde65fa084f10cd64b2fea59ac3edc3b5c2 823.3MiB</span><br><span class="line">uploading: file://openshift/release sha256:4908e3220585a526b87e77f88ee7ddd06c502447269792ea4013e1b2f414f41e 383.1MiB</span><br><span class="line">uploading: file://openshift/release sha256:b9cb5a1468a5d3b235df159d5f795d2f44bc14fbe6c3d36b28ce8a69eb545771 515.5MiB</span><br><span class="line">sha256:15be0e6de6e0d7bec726611f1dcecd162325ee57b993e0d886e70c25a1faacc3 file://openshift/release:4.5.9-openshift-controller-manager</span><br><span class="line">sha256:bc6c8fd4358d3a46f8df4d81cd424e8778b344c368e6855ed45492815c581438 file://openshift/release:4.5.9-hyperkube</span><br><span class="line">sha256:74c4a3c93c7fba691195dec0190a47cf194759b381d41045a52b6c86aa4169c4 file://openshift/release:4.5.9-cluster-ingress-operator</span><br><span class="line">sha256:bcd6cd1559b62e4a8031cf0e1676e25585845022d240ac3d927ea47a93469597 file://openshift/release:4.5.9-machine-config-operator</span><br><span class="line">sha256:9d7cf54cc50ab837ec797954ff49c0d6c9989e1b3079431199026203f512daf9 file://openshift/release:4.5.9-cluster-openshift-controller-manager-operator</span><br><span class="line">sha256:c492193a82adfb303b1ac27e48a12cc248c13d120909c98ea19088debe47fd8d file://openshift/release:4.5.9-kube-storage-version-migrator</span><br><span class="line">sha256:2527b9f6712b8551cbcec637fc87bb9640973e9f9f4972d489c5308ef25eeed0 file://openshift/release:4.5.9-jenkins</span><br><span class="line">....</span><br><span class="line">info: Mirroring completed in 1h27m3.41s (345.7kB/s)</span><br><span class="line"></span><br><span class="line">Success</span><br><span class="line">Update image:  openshift/release:4.5.9</span><br><span class="line"></span><br><span class="line">To upload local images to a registry, run:</span><br><span class="line"></span><br><span class="line">    oc image mirror --from-dir=mirror/ &#x27;file://openshift/release:4.5.9*&#x27; REGISTRY/REPOSITORY</span><br><span class="line"></span><br><span class="line">Configmap signature file mirror/config/signature-sha256-7ad540594e2a6673.yaml created</span><br></pre></td></tr></table></figure>

<p>结尾输出了把 mirror 目录下文件推送到镜像仓库的命令 <code>oc image mirror --from-dir=mirror/ &#39;file://openshift/release:4.5.9*&#39; REGISTRY/REPOSITORY</code>，后面会用到这个命令，目录为下面情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree -L 4 mirror/</span></span><br><span class="line">mirror/</span><br><span class="line">├── config</span><br><span class="line">│   └── signature-sha256-7ad540594e2a6673.yaml</span><br><span class="line">└── v2</span><br><span class="line">    └── openshift</span><br><span class="line">        └── release</span><br><span class="line">            ├── blobs</span><br><span class="line">            └── manifests</span><br></pre></td></tr></table></figure>

<p>把这些镜像目录打包成压缩包，压缩后的大概5-6G大小</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zcvf mirror.tar.gz mirror/</span><br></pre></td></tr></table></figure>

<p>把前面的<code>mirror.tar.gz</code>压缩包传过来，这里传到内网的<code>LOCAL_REGISTRY</code>机器上，还有<code>pull-secret.json</code>文件和<code>oc</code>命令也记得拷贝过来。文件准备好后设置下变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.5.9</span></span><br><span class="line">OCP_VERSION=$(oc version -o json | jq -r .releaseClientVersion)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.5.9-x86_64</span></span><br><span class="line">OCP_RELEASE=$OCP_VERSION-$(arch)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4</span></span><br><span class="line">OCP_MAJOR=$&#123;OCP_VERSION%%.*&#125;</span><br><span class="line"></span><br><span class="line">LOCAL_REGISTRY=&#x27;registry.openshift4.example.com&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对应前面的 ocp4/openshift4</span></span><br><span class="line">LOCAL_REPOSITORY=&quot;ocp$&#123;OCP_MAJOR&#125;/openshift$&#123;OCP_MAJOR&#125;&quot;</span><br><span class="line"></span><br><span class="line">PRODUCT_REPO=&#x27;openshift-release-dev&#x27;</span><br><span class="line">RELEASE_NAME=&quot;ocp-release&quot;</span><br><span class="line"></span><br><span class="line">LOCAL_SECRET_JSON=&#x27;pull-secret.json&#x27;</span><br></pre></td></tr></table></figure>

<p>然后用之前下载镜像到目录的时候结尾输出的命令导入下，因为证书是非权威机构 ca 签署的，所以加<code>--insecure</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf mirror.tar.gz</span><br><span class="line"></span><br><span class="line">oc image mirror -a $&#123;LOCAL_SECRET_JSON&#125; \</span><br><span class="line">  --from-dir=mirror/ &#x27;file://openshift/release:4.5.9*&#x27; \</span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">&#123;LOCAL_REGISTRY&#125;/<span class="variable">$&#123;LOCAL_REPOSITORY&#125;</span> \</span></span><br><span class="line"><span class="language-bash">  --insecure</span></span><br></pre></td></tr></table></figure>

<p>导入后去镜像仓库的 web 上查看有没有下面名字的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="variable">$&#123;LOCAL_REGISTRY&#125;</span>/<span class="variable">$&#123;LOCAL_REPOSITORY&#125;</span>:<span class="variable">$&#123;OCP_RELEASE&#125;</span></span></span><br><span class="line">registry.openshift4.example.com/ocp4/openshift4:4.5.9-x86_64</span><br></pre></td></tr></table></figure>

<h2 id="bastion"><a href="#bastion" class="headerlink" title="bastion"></a>bastion</h2><p>bastion 提供了下列功能：</p>
<ul>
<li>dns server: 由 coredns + etcd 提供</li>
<li>负载均衡: haproxy</li>
<li>http file download: nginx</li>
<li>openshift-install 二进制文件: 用它转换部署清单成 ignition 文件</li>
<li>oc: ocp 的 client cli，和 kubectl 一样操作 ocp 集群</li>
</ul>
<p>如果你机器数量多，或者内网有 dns server 和负载均衡，上面这些服务没必要耦合部署在一台上，同时这些实现手段看自己掌握的工具，没必要和我用一模一样</p>
<h3 id="cert-for-registry"><a href="#cert-for-registry" class="headerlink" title="cert for registry"></a>cert for registry</h3><p>bastion 节点推送镜像由于非权威 ca 签署证书会报错 <code>x509: certificate signed by unknown authority</code>，把 registry 机器上 quay 的 <code>ssl.cert</code> 复制到 bastion 上，执行下面操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp ssl.cert /etc/pki/ca-trust/source/anchors/ssl.crt</span><br><span class="line">update-ca-trust extract</span><br></pre></td></tr></table></figure>

<p>如果使用 Docker 登录，需要将证书复制到 docker 的信任证书路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker/certs.d/registry.openshift4.example.com</span><br><span class="line">cp ssl.cert /etc/docker/certs.d/registry.openshift4.example.com/ssl.crt</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="oc-openshift-install"><a href="#oc-openshift-install" class="headerlink" title="oc &amp;&amp; openshift-install"></a>oc &amp;&amp; openshift-install</h3><p>把 registry 上的 oc 命令拷贝过来。为了保证安装版本一致性，需要从镜像库中提取 <code>openshift-install</code> 二进制文件，不能直接从 <a target="_blank" rel="noopener" href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/">https://mirror.openshift.com/pub/openshift-v4/clients/ocp/</a> 下载，不然后面会有 <code>sha256</code> 匹配不上的问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这一步需要用到上面的 <span class="built_in">export</span> 变量</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者提前在 纵云梯节点执行然后拷贝过来</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">x509: certificate relies on legacy Common Name field 下面的变量解决</span></span><br><span class="line">GODEBUG=x509ignoreCN=0 oc adm release extract \</span><br><span class="line">  -a $&#123;LOCAL_SECRET_JSON&#125; \</span><br><span class="line">  --command=openshift-install \</span><br><span class="line">  &quot;$&#123;LOCAL_REGISTRY&#125;/$&#123;LOCAL_REPOSITORY&#125;:$&#123;OCP_RELEASE&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>如果提示 <code>error: image dose not exist</code>，说明拉取的镜像不全，或者版本不对，可以自己去仓库的 web 上去搜下 <code>${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}</code> 这个镜像。</p>
<p>把文件移动到 <code>$PATH</code> 并确认版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chmod +x openshift-install</span><br><span class="line">mv openshift-install /usr/local/bin/</span><br><span class="line"></span><br><span class="line">openshift-install version</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面是输出</span></span><br><span class="line"></span><br><span class="line">openshift-install 4.5.9</span><br><span class="line">built from commit 0d5c871ce7d03f3d03ab4371dc39916a5415cf5c</span><br><span class="line">release image registry.openshift4.example.com/ocp4/openshift4@sha256:7ad540594e2a667300dd2584fe2ede2c1a0b814ee6a62f60809d87ab564f4425</span><br></pre></td></tr></table></figure>

<h3 id="dns-server"><a href="#dns-server" class="headerlink" title="dns server"></a>dns server</h3><p>按照官方文档要求，集群里大部分组件之间通信都是用 dns ，所以我们这里得部署一个 dns server，官方以前 3.x.x 的时候使用 ansible 部署的<code>named</code>提供，网上也有人用 dnsmasq，这里使用 <code>docker-compose</code> 起 coredns 作为 dns server，由于这里需要添加 <code>SRV</code> 记录，所以需要 CoreDNS 结合 etcd 插件使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/coredns</span><br><span class="line">cd /data/coredns</span><br><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash">docker-compose.yml&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span></span><br><span class="line">version: &#x27;3.2&#x27;</span><br><span class="line">services:</span><br><span class="line">  coredns:</span><br><span class="line">    image: coredns/coredns:1.7.0</span><br><span class="line">    container_name: coredns</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;53:53/udp&quot;</span><br><span class="line">      - &quot;53:53/tcp&quot;</span><br><span class="line">      - &quot;9153:9153/tcp&quot;</span><br><span class="line">    cap_drop:</span><br><span class="line">      - ALL</span><br><span class="line">    cap_add:</span><br><span class="line">      - NET_BIND_SERVICE</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/coredns/config/:/etc/coredns/</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">    command: [&quot;-conf&quot;, &quot;/etc/coredns/Corefile&quot;]</span><br><span class="line">    depends_on:</span><br><span class="line">      - coredns-etcd</span><br><span class="line">    networks:</span><br><span class="line">      coredns:</span><br><span class="line">        aliases:</span><br><span class="line">          - coredns</span><br><span class="line">    logging:</span><br><span class="line">      driver: json-file</span><br><span class="line">      options:</span><br><span class="line">        max-file: &#x27;3&#x27;</span><br><span class="line">        max-size: 100m</span><br><span class="line">  coredns-etcd:</span><br><span class="line">    #image: quay.io/coreos/etcd:v3.4.13</span><br><span class="line">    image: registry.aliyuncs.com/k8sxio/etcd:3.4.13-0</span><br><span class="line">    container_name: coredns-etcd</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/coredns/etcd/data:/var/lib/etcd:Z</span><br><span class="line">      - /data/coredns/etcd/conf:/etc/etcd:Z</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">    command: [&quot;/usr/local/bin/etcd&quot;, &quot;--config-file=/etc/etcd/etcd.config.yml&quot;]</span><br><span class="line">    networks:</span><br><span class="line">      coredns:</span><br><span class="line">        aliases:</span><br><span class="line">          - etcd</span><br><span class="line">    logging:</span><br><span class="line">      driver: json-file</span><br><span class="line">      options:</span><br><span class="line">        max-file: &#x27;3&#x27;</span><br><span class="line">        max-size: 100m</span><br><span class="line">networks:</span><br><span class="line">  coredns:</span><br><span class="line">    name: coredns</span><br><span class="line">    external: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>创建相关目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/coredns/config/ \</span><br><span class="line">    /data/coredns/etcd/data \</span><br><span class="line">    /data/coredns/etcd/conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">etcd 3.4.10后data目录权限必须是0700</span></span><br><span class="line">chmod 0700 /data/coredns/etcd/data</span><br></pre></td></tr></table></figure>

<h4 id="coredns"><a href="#coredns" class="headerlink" title="coredns"></a>coredns</h4><p>创建 coredns 的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /data/coredns/config/Corefile &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">.:53 &#123;  # 监听 TCP 和 UDP 的 53 端口</span><br><span class="line">    template IN A apps.openshift4.example.com &#123;</span><br><span class="line">    match .*apps\.openshift4\.example\.com # 匹配请求 DNS 名称的正则表达式</span><br><span class="line">    answer &quot;&#123;&#123; .Name &#125;&#125; 60 IN A 10.225.45.250&quot; # DNS 应答</span><br><span class="line">    fallthrough</span><br><span class="line">    &#125;</span><br><span class="line">    etcd &#123;   # 配置启用 etcd 插件,后面可以指定域名,例如 etcd test.com &#123;</span><br><span class="line">        path /skydns # etcd 里面的路径 默认为 /skydns，以后所有的 dns 记录都存储在该路径下</span><br><span class="line">        endpoint http://etcd:2379 # etcd 访问地址，这里是容器里，所以写alias域名，多个则空格分开</span><br><span class="line">        fallthrough # 如果区域匹配但不能生成记录，则将请求传递给下一个插件</span><br><span class="line">        # tls CERT KEY CACERT # 可选参数，etcd 认证证书设置</span><br><span class="line">    &#125;</span><br><span class="line">    prometheus  # 监控插件，开启metrics</span><br><span class="line">    cache 160</span><br><span class="line">    reload</span><br><span class="line">    loadbalance   # 负载均衡，开启 DNS 记录轮询策略</span><br><span class="line">    forward . 114.114.114.114 #上游 dns server，多个的话空格隔开</span><br><span class="line">    log # 打印日志</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>这里配置了一个通配符解析就是给 router 使用的（ocp的 ingress controller），有条件可以硬件F5，real server 则写所有 router 所在的 node ip，然后 vhost的通配符域名解析的 ip 写 F5 的 ip。也可以 keepalived 漂个 VIP 做，这里偷懒使用 基础节点，因为基础节点上有 haproxy 作为负载均衡，会反向代理 集群里 hostNetwork 的 router-default 的端口</li>
<li>forward 的上游可以看宿主机 <code>/etc/resolv.conf</code> 上的 nameserver 段填写</li>
</ul>
<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p>创建 etcd 的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /data/coredns/etcd/conf/etcd.config.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">name: coredns-etcd</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">auto-compaction-mode: periodic</span><br><span class="line">auto-compaction-retention: &quot;1&quot;</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;http://127.0.0.1:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;http://0.0.0.0:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;http://127.0.0.1:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;http://0.0.0.0:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;coredns-etcd=http://127.0.0.1:2380&#x27; #和上面的name一致</span><br><span class="line">initial-cluster-token: &#x27;etcd-coredns&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: false</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="config-for-dns"><a href="#config-for-dns" class="headerlink" title="config for dns"></a>config for dns</h4><p>确保宿主机上的53没有其他 dns server 进程使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>验证下解析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dig +short apps.openshift4.example.com @127.0.0.1</span></span><br><span class="line">10.225.45.250</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dig +short x.apps.openshift4.example.com @127.0.0.1</span></span><br><span class="line">10.225.45.250</span><br></pre></td></tr></table></figure>

<p>然后根据集群的 ip 添加解析记录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">alias etcdctlv3=&#x27;docker exec -e ETCDCTL_API=3 coredns-etcd etcdctl&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/api &#x27;&#123;&quot;host&quot;:&quot;10.225.45.250&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/api-int &#x27;&#123;&quot;host&quot;:&quot;10.225.45.250&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里默认etcd是部署在master节点上</span></span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/etcd-0 &#x27;&#123;&quot;host&quot;:&quot;10.225.45.251&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/etcd-1 &#x27;&#123;&quot;host&quot;:&quot;10.225.45.252&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/etcd-2 &#x27;&#123;&quot;host&quot;:&quot;10.225.45.222&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加密的etcd域名SRV记录，这里我是只有一个master，所以这里只写一个</span></span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/_tcp/_etcd-server-ssl/x1 &#x27;&#123;&quot;host&quot;:&quot;etcd-0.openshift4.example.com&quot;,&quot;ttl&quot;:60,&quot;priority&quot;:0,&quot;weight&quot;:10,&quot;port&quot;:2380&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/_tcp/_etcd-server-ssl/x2 &#x27;&#123;&quot;host&quot;:&quot;etcd-1.openshift4.example.com&quot;,&quot;ttl&quot;:60,&quot;priority&quot;:0,&quot;weight&quot;:10,&quot;port&quot;:2380&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/_tcp/_etcd-server-ssl/x3 &#x27;&#123;&quot;host&quot;:&quot;etcd-2.openshift4.example.com&quot;,&quot;ttl&quot;:60,&quot;priority&quot;:0,&quot;weight&quot;:10,&quot;port&quot;:2380&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">除此之外再添加各节点主机名记录</span></span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/bootstrap &#x27;&#123;&quot;host&quot;:&quot;10.225.45.223&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/master1 &#x27;&#123;&quot;host&quot;:&quot;10.225.45.251&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/master2 &#x27;&#123;&quot;host&quot;:&quot;10.225.45.252&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/master3 &#x27;&#123;&quot;host&quot;:&quot;10.225.45.222&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里bootstrap后面用来当作worker用，所以ip写bootstrap</span></span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/worker1 &#x27;&#123;&quot;host&quot;:&quot;10.225.45.223&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">镜像节点的域名</span></span><br><span class="line">etcdctlv3 put /skydns/com/example/openshift4/registry &#x27;&#123;&quot;host&quot;:&quot;10.225.45.226&quot;,&quot;ttl&quot;:60&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>查看所有记录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctlv3 get /skydns --prefix</span><br></pre></td></tr></table></figure>

<h4 id="validate-for-dns"><a href="#validate-for-dns" class="headerlink" title="validate for dns"></a>validate for dns</h4><p>验证dns，自己比对输出看ip是否正确</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bind-utils</span><br><span class="line"></span><br><span class="line">dig +short api.openshift4.example.com @127.0.0.1</span><br><span class="line"></span><br><span class="line">dig +short api-int.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short etcd-0.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short etcd-1.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short etcd-2.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short bootstrap.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short master1.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short master2.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short master3.openshift4.example.com @127.0.0.1</span><br><span class="line">dig +short worker1.openshift4.example.com @127.0.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dig +short -t SRV _etcd-server-ssl._tcp.openshift4.example.com @127.0.0.1</span><br><span class="line">10 33 2380 etcd-0.openshift4.example.com.</span><br><span class="line">10 33 2380 etcd-1.openshift4.example.com.</span><br><span class="line">10 33 2380 etcd-2.openshift4.example.com.</span><br></pre></td></tr></table></figure>

<p>然后我们改下系统的<code>resolv.conf</code>，使用 coredns 作为dns，这样我们不用去写 hosts</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp -a /etc/resolv.conf /etc/resolv.conf.bak</span><br><span class="line">cat &gt;/etc/resolv.conf&lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">search openshift4.example.com</span><br><span class="line">nameserver 10.225.45.250</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>这里因为安装流程是 bootstrap 机器起来后，bootstrap 运行 machine-config 进程，安装 master 和 worker 的时候会访问 bootstrap 上的 <code>mcahine-config</code> 下面的 http 接口（后面有兴趣在 bootstrap 起来后去执行试试）:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sk https://api-int.openshift4.example.com:22623/config/master</span><br></pre></td></tr></table></figure>

<p>安装完成后 bootstrap 会交出控制平面到 master 上（machine-config 和 kubernetes api），所以无论 master 有几个，都必须要配置负载均衡。使用工具不限，nginx，envoy 啥的均可。nginx 配置四层 mode 七层 check rs 的时候要安装插件来7层 healthz check，挺麻烦的，所以这里我使用 haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/haproxy</span><br><span class="line">cd /data/haproxy</span><br><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash">docker-compose.yml&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span></span><br><span class="line">version: &#x27;3.2&#x27;</span><br><span class="line">services:</span><br><span class="line">  haproxy:</span><br><span class="line">    image: haproxy:lts</span><br><span class="line">    container_name: haproxy</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: host</span><br><span class="line">    sysctls:</span><br><span class="line">      - net.core.somaxconn=2000</span><br><span class="line">    cap_drop:</span><br><span class="line">      - ALL</span><br><span class="line">    cap_add:</span><br><span class="line">      - NET_BIND_SERVICE</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/haproxy/config/:/etc/haproxy/</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">      - /etc/hosts:/etc/hosts:ro</span><br><span class="line">    command: [&quot;-f&quot;, &quot;/etc/haproxy/haproxy.cfg&quot;]</span><br><span class="line">    logging:</span><br><span class="line">      driver: json-file</span><br><span class="line">      options:</span><br><span class="line">        max-file: &#x27;3&#x27;</span><br><span class="line">        max-size: 100m</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="config-for-haproxy"><a href="#config-for-haproxy" class="headerlink" title="config for haproxy"></a>config for haproxy</h4><p>配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/haproxy/config/</span><br><span class="line">cat &gt;/data/haproxy/config/haproxy.cfg&lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  ulimit-n  16384</span><br><span class="line">  log  127.0.0.1 local0 err</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  log global</span><br><span class="line">  mode  http</span><br><span class="line">  option  httplog</span><br><span class="line">  timeout connect 5000</span><br><span class="line">  timeout client  50000</span><br><span class="line">  timeout server  50000</span><br><span class="line">  timeout http-request 15s</span><br><span class="line">  timeout http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    bind         :9000</span><br><span class="line">    mode         http</span><br><span class="line">    stats        enable</span><br><span class="line">    stats        uri /</span><br><span class="line">    stats        refresh   30s</span><br><span class="line">    stats        auth      admin:openshift #web页面登录</span><br><span class="line">    monitor-uri  /healthz</span><br><span class="line"></span><br><span class="line">frontend openshift-api-server</span><br><span class="line">    bind :6443</span><br><span class="line">    default_backend openshift-api-server</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line"></span><br><span class="line">backend openshift-api-server</span><br><span class="line">    balance roundrobin</span><br><span class="line">    mode tcp</span><br><span class="line">    option httpchk GET /healthz</span><br><span class="line">    http-check expect string ok</span><br><span class="line">    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">    server bootstrap 10.225.45.223:6443 check check-ssl verify none #安装结束后删掉此行</span><br><span class="line">    server master1 10.225.45.251:6443 check check-ssl verify none</span><br><span class="line">    server master2 10.225.45.252:6443 check check-ssl verify none</span><br><span class="line">    server master3 10.225.45.222:6443 check check-ssl verify none</span><br><span class="line"></span><br><span class="line">frontend machine-config-server</span><br><span class="line">    bind :22623</span><br><span class="line">    default_backend machine-config-server</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line"></span><br><span class="line">backend machine-config-server</span><br><span class="line">    balance roundrobin</span><br><span class="line">    mode tcp</span><br><span class="line">    server bootstrap 10.225.45.223:22623 check #安装结束后删掉此行</span><br><span class="line">    server master1 10.225.45.251:22623 check</span><br><span class="line">    server master2 10.225.45.252:22623 check</span><br><span class="line">    server master3 10.225.45.222:22623 check</span><br><span class="line"></span><br><span class="line">frontend ingress-http</span><br><span class="line">    bind :80</span><br><span class="line">    default_backend ingress-http</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line"></span><br><span class="line">backend ingress-http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    mode tcp</span><br><span class="line">    server master1 10.225.45.251:80 check</span><br><span class="line">    server master2 10.225.45.252:80 check</span><br><span class="line">    server master3 10.225.45.222:80 check</span><br><span class="line"></span><br><span class="line">frontend ingress-https</span><br><span class="line">    bind :443</span><br><span class="line">    default_backend ingress-https</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line"></span><br><span class="line">backend ingress-https</span><br><span class="line">    balance roundrobin</span><br><span class="line">    mode tcp</span><br><span class="line">    server master1 10.225.45.251:443 check</span><br><span class="line">    server master2 10.225.45.252:443 check</span><br><span class="line">    server master3 10.225.45.222:443 check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>因为前文使用的 quay 仓库无法更改 443 端口，这会和 haproxy 代理的 ingress-https 的 443 冲突，所以 quay 仓库单独部署。启动 haproxy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/haproxy</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>可以访问 <a target="_blank" rel="noopener" href="http://ip:9000/">http://ip:9000</a> 查看 haproxy 的状态，basic auth 为上面 haproxy 配置文件里的<code>admin:openshift</code></p>
<h3 id="http-file-download"><a href="#http-file-download" class="headerlink" title="http file download"></a>http file download</h3><p>由于这里不是 pxe 安装，我们还得提供 http server，让 master 和 bootstrap 从 installer iso 启动后下载 raw.gz 写入到硬盘里。这里使用 nginx 提供</p>
<p>如果有配置 dhcp 的网络环境，这里需要起 dhcp server 和 tftp 之类的服务让 pxe 自动安装，但是我这里没这个网络条件，所以是开机器后挂载 installer iso，然后开机的时候按 tab 按键输入一堆 boot 选项参数，让它从指定 http 的地方下载和安装（也就是前面我门下载的rhcos的raw.gz文件）。这里 http 用容器 nginx 提供</p>
<p>创建相关目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/install-nginx/&#123;install/ignition,conf.d&#125;</span><br></pre></td></tr></table></figure>

<p>创建 docker-compose 文件和配置文件，因为宿主机有负载均衡 80 端口在运行，所以这里 nginx 使用 8080 端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cd /data/install-nginx</span><br><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash">docker-compose.yml&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span></span><br><span class="line">version: &#x27;3.4&#x27;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    container_name: install-nginx</span><br><span class="line">    hostname: install-nginx</span><br><span class="line">    volumes:</span><br><span class="line">      - /usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span><br><span class="line">      - /data/install-nginx/install:/usr/share/nginx/html</span><br><span class="line">      - /data/install-nginx/conf.d/:/etc/nginx/conf.d/</span><br><span class="line">    network_mode: &quot;host&quot;</span><br><span class="line">    logging:</span><br><span class="line">      driver: json-file</span><br><span class="line">      options:</span><br><span class="line">        max-file: &#x27;3&#x27;</span><br><span class="line">        max-size: 100m</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">cat&gt; </span><span class="language-bash">/data/install-nginx/conf.d/default.conf &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       8080;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        autoindex    on;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>启动<code>install-nginx</code>，起来后访问 <a target="_blank" rel="noopener" href="http://ip:8080/">http://ip:8080</a> 看到目录就正常</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h4 id="rhcos-iso"><a href="#rhcos-iso" class="headerlink" title="rhcos iso"></a>rhcos iso</h4><p>下载 rhcos 的 ISO ， <a target="_blank" rel="noopener" href="https://cloud.redhat.com/openshift/install/metal/user-provisioned">下载链接地址</a> 或者 <a target="_blank" rel="noopener" href="https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/">这里下载</a> 。我们下载下面俩个即可，<strong>版本号必须小于等于ocp的版本号</strong>，<code>installer</code>是给机器挂载，会在内存里运行，根据用户输入的 boot cmdline 去从 http server 下载 <code>metal.x86_64.raw.gz</code> 和 ignition 文件安装和配置</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rhcos-4.5.6-x86_64-installer.x86_64.iso</span><br><span class="line">rhcos-4.5.6-x86_64-metal.x86_64.raw.gz</span><br></pre></td></tr></table></figure>

<p>installer是给机器挂载从光驱启动的，raw.gz存放在 nginx的http目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/install-nginx/install/</span><br><span class="line">wget https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-4.5.6-x86_64-metal.x86_64.raw.gz</span><br></pre></td></tr></table></figure>

<p>installer 的 iso 如果是物理机或者虚机的话不要在 bmc 或者类似 vshpere 上远程挂载你自己pc上的 iso，否则会遇到 bootstrap 和 master 在 logo 的安装界面输入boot cmdline 后回车无响应的情况，建议传到远端上，相对于机器近的存储上。例如是 exsi 和 vshpere 则上传到上面的数据存储上。</p>
<h3 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h3><h4 id="生成ssh密钥对"><a href="#生成ssh密钥对" class="headerlink" title="生成ssh密钥对"></a>生成ssh密钥对</h4><p>在安装过程中，我们会在基础节点上执行 OCP 安装调试和灾难恢复，因此必须在基础节点上配置 SSH key，ssh-agent 将会用它来执行安装程序。</p>
<p>基础节点上的 core 用户可以使用该私钥登录到 Master 节点。同时部署集群时，该私钥会被添加到 core 用户的 <code>~/.ssh/authorized_keys</code> 列表中。</p>
<p>创建无密码验证的 SSH key：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -N &#x27;&#x27; -f ~/.ssh/new_rsa</span><br></pre></td></tr></table></figure>

<p>后续 ssh 到 master 和 node 使用下面命令即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i ~/.ssh/new_rsa core@10.225.45.251</span><br></pre></td></tr></table></figure>

<h4 id="创建安装配置文件"><a href="#创建安装配置文件" class="headerlink" title="创建安装配置文件"></a>创建安装配置文件</h4><p>ocp的一些 yaml 和安装文件存放在<code>/data/ocpinstall</code>下，自定义 <code>install-config.yaml</code> 配置文件必须命名为 <code>install-config.yaml</code>。配置文件内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/ocpinstall</span><br><span class="line">cd /data/ocpinstall</span><br><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash">install-config.yaml&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">baseDomain: example.com</span><br><span class="line">compute:</span><br><span class="line">- hyperthreading: Enabled</span><br><span class="line">  name: worker</span><br><span class="line">  replicas: 0</span><br><span class="line">controlPlane:</span><br><span class="line">  hyperthreading: Enabled</span><br><span class="line">  name: master</span><br><span class="line">  replicas: 3</span><br><span class="line">metadata:</span><br><span class="line">  name: openshift4</span><br><span class="line">networking:</span><br><span class="line">  clusterNetwork:</span><br><span class="line">  - cidr: 10.128.0.0/14</span><br><span class="line">    hostPrefix: 23</span><br><span class="line">  networkType: OpenShiftSDN</span><br><span class="line">  serviceNetwork:</span><br><span class="line">  - 172.30.0.0/16</span><br><span class="line">platform:</span><br><span class="line">  none: &#123;&#125;</span><br><span class="line">fips: false</span><br><span class="line">pullSecret: &#x27;&#123;&quot;auths&quot;: ...&#125;&#x27;</span><br><span class="line">sshKey: &#x27;ssh-rsa ...&#x27;</span><br><span class="line">additionalTrustBundle: |</span><br><span class="line">  -----BEGIN CERTIFICATE-----</span><br><span class="line">  注意这里要前面空个两格用于yaml对齐</span><br><span class="line">  -----END CERTIFICATE-----</span><br><span class="line">imageContentSources:</span><br><span class="line">- mirrors:</span><br><span class="line">  - registry.openshift4.example.com/ocp4/openshift4</span><br><span class="line">  source: quay.io/openshift-release-dev/ocp-release</span><br><span class="line">- mirrors:</span><br><span class="line">  - registry.openshift4.example.com/ocp4/openshift4</span><br><span class="line">  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>baseDomain</strong> : 所有 Openshift 内部的 DNS 记录必须是此基础的子域，并包含集群名称。</li>
<li><strong>compute</strong> : 计算节点配置。这是一个数组，每一个元素必须以连字符 - 开头。</li>
<li><strong>hyperthreading</strong> : Enabled 表示启用同步多线程或超线程。默认启用同步多线程，可以提高机器内核的性能。如果要禁用，则控制平面和计算节点都要禁用。</li>
<li><strong>compute.replicas</strong> : 计算节点数量。因为我们要手动创建计算节点，所以这里要设置为 0。</li>
<li><strong>controlPlane.replicas</strong> : 控制平面节点数量。控制平面节点数量必须和 etcd 节点数量一致，为了实现高可用，所以设置为 3。</li>
<li><strong>metadata.name</strong> : 集群名称。即前面 DNS 记录中的 <code>&lt;cluster_name&gt;</code>。</li>
<li><strong>cidr</strong> : 定义了分配 Pod IP 的 IP 地址段，不能和物理网络重叠。</li>
<li><strong>hostPrefix</strong> : 分配给每个节点的子网前缀长度，等同于 k8s 的 node-max-mask。例如，如果将 <code>hostPrefix</code> 设置为 <code>23</code>，则为每一个节点分配一个给定 cidr 的 <code>/23</code> 子网，允许510个 Pod IP 地址，24位的话每个 node 的 pod 最多254个ip后期可能会太少了。</li>
<li><strong>serviceNetwork</strong> : Service IP 的地址池，只能设置一个。</li>
<li><strong>pullSecret</strong> : 上篇文章使用的 pull secret，可通过命令 <code>jq . /root/pull-secret.json</code> 来压缩成一行。</li>
<li><strong>sshKey</strong> : 上面创建的公钥，可通过命令 <code>cat ~/.ssh/new_rsa.pub</code> 查看。</li>
<li><strong>additionalTrustBundle</strong> : 私有镜像仓库 Quay 的信任证书，可在镜像节点上通过命令 <code>cat /data/quay/config/ssl.cert</code> 查看。</li>
<li><strong>imageContentSources</strong> : 来自前面 <code>oc adm release mirror</code> 的输出结果。</li>
</ul>
<p><strong>platform</strong> 实际上支持 gcp，aws，vshpere，bmc之类的自动创建机器，有兴趣可以去去研究下</p>
<p>修改好上面的文件后接着生成 Ignition 配置文件，创建后<code>install-config.yaml</code>会被删除，所以备份下，同时该文件实际上会被生成 configmap 的 yaml 放在<code>manifests/cluster-config.yaml</code>)里，在集群起来后会存在<code>kube-system cm/cluster-config-v1</code>里</p>
<h4 id="生成部署配置文件"><a href="#生成部署配置文件" class="headerlink" title="生成部署配置文件"></a>生成部署配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/ocpinstall</span><br><span class="line">cp install-config.yaml  install-config.yaml.$(date +%Y%m%d)</span><br></pre></td></tr></table></figure>

<p>创建部署清单manifests</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/ocpinstall</span><br><span class="line">openshift-install create manifests</span><br></pre></td></tr></table></figure>

<p>如果你的 worker 节点很多，不希望 master 节点上有pod被调度，修改 <code>manifests/cluster-scheduler-02-config.yml</code> 文件，将 <code>mastersSchedulable</code> 的值设为 flase，以防止 Pod 调度到控制节点。</p>
<p>后面的install create会转换manifest目录下所有文件，这里备份下manifest目录，有兴趣后面可以研究下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp -a manifests manifests-bak</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把部署清单转换成 Ignition 配置文件</span></span><br><span class="line">openshift-install create ignition-configs</span><br></pre></td></tr></table></figure>

<p><code>ll manifests/</code>目录是一堆yaml</p>
<p>Ignition 生成的文件如下，也有隐藏的文件，有兴趣可以去看看</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">├── auth</span><br><span class="line">│   ├── kubeadmin-password</span><br><span class="line">│   └── kubeconfig</span><br><span class="line">├── bootstrap.ign</span><br><span class="line">├── master.ign</span><br><span class="line">├── metadata.json</span><br><span class="line">└── worker.ign</span><br></pre></td></tr></table></figure>

<p>把所有 ignition 文件复制到 http server 的目录里</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\cp -a /data/ocpinstall/*.ign /data/install-nginx/install/ignition/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于nginx容器用户是nginx，上面的ign文件的o是0，增加下o的r的权限</span></span><br><span class="line">chmod o+r /data/install-nginx/install/ignition/*.ign</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">改名下raw.gz的名字，以便在 boot cmdline的时候少输入url</span></span><br><span class="line">cd /data/install-nginx/install/</span><br><span class="line">mv rhcos-4.*-x86_64-metal.x86_64.raw.gz rhcos.raw.gz</span><br></pre></td></tr></table></figure>

<h2 id="安装集群"><a href="#安装集群" class="headerlink" title="安装集群"></a>安装集群</h2><p>先安装 bootstrap 机器，是因为 master 机器起来的时候会请求<code>curl -sk https://api-int.openshift4.example.com:22623/config/master</code>，如果 bootstrap 机器起来后上面的 容器和 pod 服务没就绪。master 节点安装完系统开机后会一直 retry 这个接口</p>
<h3 id="bootstrap"><a href="#bootstrap" class="headerlink" title="bootstrap"></a>bootstrap</h3><p>机器创建好后给机器的光驱挂载上前面的 installer 的 iso 文件，开机后会停留在菜单选择界面</p>
<ol>
<li>在 RHCOS Installer 安装界面按 <code>Tab</code> 键进入引导参数配置选项</li>
<li>在默认选项 <code>coreos.inst=yes</code> 之后添加（由于无法拷贝粘贴，请输入<strong>仔细核对</strong>后再回车进行）：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=10.225.45.223::10.225.45.254:255.255.255.0:bootstrap.openshift4.example.com:ens192:none nameserver=10.225.45.250 coreos.inst.install_dev=sda coreos.inst.image_url=http://10.225.45.250:8080/rhcos.raw.gz coreos.inst.ignition_url=http://10.225.45.250:8080/ignition/bootstrap.ign</span><br></pre></td></tr></table></figure>

<p>参数说明，参数为<code>key=value key1=value1</code> 每个得空格隔开</p>
<table>
<thead>
<tr>
<th align="center">key</th>
<th align="center">value</th>
<th align="center">注意事项</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>ip</code></td>
<td align="center"><code>$IPADDRESS::$DEFAULTGW:$NETMASK:$HOSTNAMEFQDN:$IFACE:none</code></td>
<td align="center"><code>IFACE</code>在rhcos里似乎是固定的<code>ens192</code>，我试过了可以不写</td>
</tr>
<tr>
<td align="center"><code>nameserver</code></td>
<td align="center"><code>${bastion_ip}</code></td>
<td align="center">集群的dns server，这里是<code>bastion</code></td>
</tr>
<tr>
<td align="center"><code>coreos.inst.install_dev</code></td>
<td align="center"><code>sda</code></td>
<td align="center">rhcos 安装在哪块儿硬盘上，测试过只有一块硬盘也不会自动识别，所以不能省略，我的环境是 vsphere，硬盘是 sda，没有在 openstack 的虚机下试过(这样可能写vda？)</td>
</tr>
<tr>
<td align="center"><code>coreos.inst.image_url</code></td>
<td align="center"><code>http://${bastion_ip}:8080/rhcos-metal.raw.gz</code></td>
<td align="center"><code>rhcos-metal</code>的 url，根据自己http server的实际 url 填写</td>
</tr>
<tr>
<td align="center"><code>coreos.inst.ignition_url</code></td>
<td align="center"><code>http://${bastion_ip}:8080/ignition/${type}.ign</code></td>
<td align="center">ignition 的 url 链接，bootstrap 则结尾是 <code>bootstrap.ign</code>，master 则是 <code>master.gin</code></td>
</tr>
</tbody></table>
<p><img src="https://cdn.jsdelivr.net/gh/zhangguanzhang/Image-Hosting/picgo/rhcos_install_boot_cmdline.png" alt="boot_cmdline"></p>
<ol start="3">
<li>如果安装有问题会进入 <code>emergency shell</code>，检查网络、域名解析是否正常，如果不正常一般是以上参数输入有误，reboot 退出 shell 回到第一步重新开始。</li>
</ol>
<p>安装成功后从基础节点通过命令 <code>ssh -i ~/.ssh/new_rsa core@10.225.45.250</code> 登录 bootstrap 节点，然后<code>sudo su</code>切换到 root 后验证：</p>
<ul>
<li>网络配置是否符合自己的设定：<ul>
<li><code>hostname</code></li>
<li><code>ip route</code></li>
<li><code>cat /etc/resolv.conf</code></li>
</ul>
</li>
<li>验证是否成功启动 bootstrap 相应服务：<ul>
<li><code>podman ps -a</code> 查看服务是否以容器方式运行</li>
<li>使用 <code>ss -tulnp</code> 查看 6443 和 22623 端口是否启用。</li>
</ul>
</li>
</ul>
<p>这里简单介绍一下 bootstrap 节点的启动流程，它启动后运行<code>bootkube.service</code>，systemd 的 <code>ConditionPathExists</code> 可以看到用文件作为防止成功后再次运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@bootstrap core]# systemctl cat bootkube</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/systemd/system/bootkube.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Bootstrap a Kubernetes cluster</span><br><span class="line">Requires=crio-configure.service</span><br><span class="line">Wants=kubelet.service</span><br><span class="line">After=kubelet.service crio-configure.service</span><br><span class="line">ConditionPathExists=!/opt/openshift/.bootkube.done</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/opt/openshift</span><br><span class="line">ExecStart=/usr/local/bin/bootkube.sh</span><br></pre></td></tr></table></figure>

<p>查看上面的脚本内容，我们会发现它会先通过 <code>podman</code> 跑一些容器，然后在容器里面启动临时控制平面，这个临时控制平面是通过 <code>CRIO</code> 跑在容器里的，有点绕。。看下面</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@bootstrap core]# podman ps -a</span><br><span class="line">CONTAINER ID  IMAGE                                                                                                                    COMMAND               CREATED         STATUS                     PORTS  NAMES</span><br><span class="line">7a9a800c6819  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:416ad8f3ddd49adae4f7db66f8a130319084604296c076c2a6d22264a5688d65   start --tear-down...  12 minutes ago  Up 12 minutes ago                 strange_yonath</span><br><span class="line">8997b001e324  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:bf0d5fd64ab53dfdd477c90a293f3ec90379a22e8b356044082e807565699863   render --dest-dir...  12 minutes ago  Exited (0) 12 minutes ago         stoic_williamson</span><br><span class="line">7c45d60ecd39  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:bcd6cd1559b62e4a8031cf0e1676e25585845022d240ac3d927ea47a93469597   bootstrap --etcd-...  12 minutes ago  Exited (0) 12 minutes ago         lucid_heisenberg</span><br><span class="line">fe300339df9b  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:74c4a3c93c7fba691195dec0190a47cf194759b381d41045a52b6c86aa4169c4   render --prefix=c...  12 minutes ago  Exited (0) 12 minutes ago         suspicious_kepler</span><br><span class="line">102c20d247d7  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:ddb26e047d0e0d7b11bdb625bd7a941ab66f7e1ef5a5f7455d8694e7ba48989d   /usr/bin/cluster-...  12 minutes ago  Exited (0) 12 minutes ago         optimistic_euler</span><br><span class="line">1b7c759792c0  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:ca556d4515818e3e10d2e771d986784460509146ea9dd188fb8ba6f6ac694132   /usr/bin/cluster-...  13 minutes ago  Exited (0) 13 minutes ago         nice_lehmann</span><br><span class="line">8dab8ea23ebd  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:e4758039391099dc1b0265099474113dcd8bcce84a1c92d02c1ef760793079e6   /usr/bin/cluster-...  13 minutes ago  Exited (0) 13 minutes ago         clever_meitner</span><br><span class="line">8bd804fb88bf  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:c93a0de1e4cb3f04e37d547c1b81a2a22c4d9d01c013374c466ed3fd0416215a   /usr/bin/cluster-...  13 minutes ago  Exited (0) 13 minutes ago         recursing_ramanujan</span><br><span class="line">11dc7e222bf9  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:13179789b2e15ecf749f5ab51cf11756e2831bc019c02ed0659182e805e725dd   /usr/bin/cluster-...  13 minutes ago  Exited (0) 13 minutes ago         wizardly_easley</span><br><span class="line">b60208539287  registry.openshift4.example.com/ocp4/openshift4@sha256:7ad540594e2a667300dd2584fe2ede2c1a0b814ee6a62f60809d87ab564f4425  render --output-d...  13 minutes ago  Exited (0) 13 minutes ago         goofy_bassi</span><br><span class="line">428dec4624e1  quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:13179789b2e15ecf749f5ab51cf11756e2831bc019c02ed0659182e805e725dd   /usr/bin/grep -oP...  13 minutes ago  Exited (0) 13 minutes ago         pedantic_northcutt</span><br><span class="line">[root@bootstrap core]# crictl pods</span><br><span class="line">POD ID              CREATED             STATE               NAME                                                                  NAMESPACE                             ATTEMPT</span><br><span class="line">ec6155d87b866       13 minutes ago      Ready               bootstrap-kube-scheduler-bootstrap.openshift4.example.com             kube-system                           0</span><br><span class="line">6808217a146b7       13 minutes ago      Ready               bootstrap-kube-controller-manager-bootstrap.openshift4.example.com    kube-system                           0</span><br><span class="line">7f1ae27edd3fe       13 minutes ago      Ready               bootstrap-kube-apiserver-bootstrap.openshift4.example.com             kube-system                           0</span><br><span class="line">cc92475639870       13 minutes ago      Ready               cloud-credential-operator-bootstrap.openshift4.example.com            openshift-cloud-credential-operator   0</span><br><span class="line">08c45b635d5c1       13 minutes ago      Ready               bootstrap-cluster-version-operator-bootstrap.openshift4.example.com   openshift-cluster-version             0</span><br><span class="line">69fc31911a89f       14 minutes ago      Ready               bootstrap-machine-config-operator-bootstrap.openshift4.example.com    default                               0</span><br><span class="line">7d2598ac710e6       14 minutes ago      Ready               etcd-bootstrap-member-bootstrap.openshift4.example.com                openshift-etcd                        0</span><br></pre></td></tr></table></figure>

<p>如果你快速查看上面的可能一时半会儿没起来，可以通过下面命令持续观察脚本运行的日志，<code>bootkube.sh</code> 正常运行完（所有master也上来后）会出现<code>bootkube.service complete</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -b -f -u bootkube.service</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Jun 05 00:24:12 bootstrap.openshift4.example.com bootkube.sh[12571]: I0605 00:24:12.108179       1 waitforceo.go:67] waiting on condition EtcdRunningInCluster in etcd CR /cluster to be True.</span><br><span class="line">Jun 05 00:24:21 bootstrap.openshift4.example.com bootkube.sh[12571]: I0605 00:24:21.595680       1 waitforceo.go:67] waiting on condition EtcdRunningInCluster in etcd CR /cluster to be True.</span><br><span class="line">Jun 05 00:24:26 bootstrap.openshift4.example.com bootkube.sh[12571]: I0605 00:24:26.250214       1 waitforceo.go:67] waiting on condition EtcdRunningInCluster in etcd CR /cluster to be True.</span><br><span class="line">Jun 05 00:24:26 bootstrap.openshift4.example.com bootkube.sh[12571]: I0605 00:24:26.306421       1 waitforceo.go:67] waiting on condition EtcdRunningInCluster in etcd CR /cluster to be True.</span><br><span class="line">Jun 05 00:24:29 bootstrap.openshift4.example.com bootkube.sh[12571]: I0605 00:24:29.097072       1 waitforceo.go:64] Cluster etcd operator bootstrapped successfully</span><br><span class="line">Jun 05 00:24:29 bootstrap.openshift4.example.com bootkube.sh[12571]: I0605 00:24:29.097306       1 waitforceo.go:58] cluster-etcd-operator bootstrap etcd</span><br><span class="line">Jun 05 00:24:29 bootstrap.openshift4.example.com podman[16531]: 2020-06-05 00:24:29.120864426 +0000 UTC m=+17.965364064 container died 77971b6ca31755a89b279fab6f9c04828c4614161c2e678c7cba48348e684517 (image=quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f7a02df3a5d91326d95e444e2e249f8205632ae986d6dccc7f007ec65c8af77, name=recursing_cerf)</span><br><span class="line">Jun 05 00:24:29 bootstrap.openshift4.example.com bootkube.sh[12571]: bootkube.service complete</span><br></pre></td></tr></table></figure>

<h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><p>在 bootstrap 的 crictl pods 没问题后，我们来启动 master节点，参考 bootstrap，同样配置 boot cmdline 启动，注意 ip，hostname，ign结尾的<code>类型.ign</code>，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=10.225.45.251::10.225.45.254:255.255.255.0:master1.openshift4.example.com:ens192:none nameserver=10.225.45.250 coreos.inst.install_dev=sda coreos.inst.image_url=http://10.225.45.250:8080/rhcos.raw.gz coreos.inst.ignition_url=http://10.225.45.250:8080/ignition/master.ign</span><br></pre></td></tr></table></figure>

<h3 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h3><p>此时你worker也可以按照相关参数启动，下面是参考，我这里是后面 bootstrap 完成后重装它去启动作为worker的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=10.225.45.223::10.225.45.254:255.255.255.0:worker1.openshift4.example.com:ens192:none nameserver=10.225.45.250 coreos.inst.install_dev=sda coreos.inst.image_url=http://10.225.45.250:8080/rhcos.raw.gz coreos.inst.ignition_url=http://10.225.45.250:8080/ignition/worker.ign</span><br></pre></td></tr></table></figure>

<p>一样的安装，注意<code>ingition_url</code>结尾是<code>worker.ign</code>，起来后 node 的 csr 得批准</p>
<p>查看挂起的证书签名请求（CSR），并确保添加到集群的每台节点都能看到具有 <code>Pending</code> 或 <code>Approved</code> 状态的客户端和服务端请求。针对 Pending 状态的 CSR 批准请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oc get csr</span><br><span class="line">oc adm certificate approve xxx</span><br></pre></td></tr></table></figure>

<p>或者执行以下命令批准所有 CSR：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CSR_NAMES=`oc get csr -o json | jq -r <span class="string">&#x27;.items[] | select(.status == &#123;&#125; ) | .metadata.name&#x27;</span>`</span><br><span class="line">[ -n <span class="string">&quot;<span class="variable">$CSR_NAMES</span>&quot;</span> ] &amp;&amp;  oc adm certificate approve <span class="variable">$CSR_NAMES</span></span><br></pre></td></tr></table></figure>

<p>后续添加 worker 重复此步骤即可</p>
<h3 id="验证集群"><a href="#验证集群" class="headerlink" title="验证集群"></a>验证集群</h3><h4 id="配置-oc-kubeconfig"><a href="#配置-oc-kubeconfig" class="headerlink" title="配置 oc kubeconfig"></a>配置 oc kubeconfig</h4><p>在 bastion 节点上,我们生成部署清单的时候会产生一个<code>kubeconfig</code>，目录<code>/data/ocpinstall/auth</code></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">├── auth</span><br><span class="line">│   ├── kubeadmin-password</span><br><span class="line">│   └── kubeconfig</span><br></pre></td></tr></table></figure>

<p>像 k8s 那样，我们需要拷贝到默认读取目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/.kube</span><br><span class="line">\cp /data/ocpinstall/auth/kubeconfig ~/.kube/config</span><br><span class="line">oc whoami</span><br></pre></td></tr></table></figure>

<p>配置下 oc 的自动补全</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash">/etc/bash_completion.d/oc &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span></span><br><span class="line">source &lt;(oc completion bash)</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="验证集群节点"><a href="#验证集群节点" class="headerlink" title="验证集群节点"></a>验证集群节点</h4><p>查看集群节点是否上来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">oc  get node</span></span><br><span class="line">NAME                             STATUS   ROLES           AGE     VERSION</span><br><span class="line">master1.openshift4.example.com   Ready    master,worker   3d14h   v1.18.3+6c42de8</span><br><span class="line">master2.openshift4.example.com   Ready    master,worker   3d14h   v1.18.3+6c42de8</span><br><span class="line">master3.openshift4.example.com   Ready    master,worker   3d14h   v1.18.3+6c42de8</span><br></pre></td></tr></table></figure>

<p>查看集群的 pod，如果很久之后某些 pod 还是一直 crash 的话看下面<code>troubleshooting</code>的，因为<a target="_blank" rel="noopener" href="https://github.com/openshift/cluster-bootstrap/blob/master/pkg/start/status.go#L46-L106">源码里会等待所有pod不再crash</a>  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc get po -A</span><br></pre></td></tr></table></figure>

<p>使用 openshift-install 命令查看 bootstrap 完成否，会需要等很久，有问题看下文的 troubleshooting</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openshift-install --<span class="built_in">dir</span>=/data/ocpinstall wait-for bootstrap-complete --log-level=debug</span></span><br><span class="line">DEBUG OpenShift Installer 4.5.9</span><br><span class="line">DEBUG Built from commit 0d5c871ce7d03f3d03ab4371dc39916a5415cf5c</span><br><span class="line">INFO Waiting up to 20m0s for the Kubernetes API at https://api.openshift4.example.com:6443...</span><br><span class="line">INFO API v1.18.3+6c42de8 up</span><br><span class="line">INFO Waiting up to 40m0s for bootstrapping to complete...</span><br><span class="line">DEBUG Bootstrap status: complete</span><br><span class="line">INFO It is now safe to remove the bootstrap resources</span><br><span class="line">DEBUG Time slapsed per state:</span><br><span class="line">DEBUG Bootstrap Complete: 24m13s</span><br><span class="line">INFO Time elapsed: 24m13s</span><br></pre></td></tr></table></figure>

<p>这里<a target="_blank" rel="noopener" href="https://github.com/openshift/cluster-bootstrap/blob/master/pkg/start/start.go#L105-L129">查看源码</a>，实际上 bootkube.sh 最后阶段会向集群里注入一个 cm <code>kube-system/bootstrap</code>存放状态。而上面的<code>wait-for bootstrap-complete</code>实际上就是等待这个cm创建，可以<a target="_blank" rel="noopener" href="https://github.com/openshift/installer/blob/master/cmd/openshift-install/create.go#L312">查看源码里的waitForBootstrapConfigMap方法</a></p>
<h3 id="web-console"><a href="#web-console" class="headerlink" title="web console"></a>web console</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /data/ocpinstall</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openshift-install wait-for install-complete</span></span><br><span class="line">INFO Waiting up to 30m0s for the cluster at https://api.openshift4.example.com:6443 to initialize...</span><br><span class="line">INFO Waiting up to 10m0s for the openshift-console route to be created...</span><br><span class="line">INFO Install complete!</span><br><span class="line">INFO To access the cluster as the system:admin user when using &#x27;oc&#x27;, run &#x27;export KUBECONFIG=/data/ocpinstall/auth/kubeconfig&#x27;</span><br><span class="line">INFO Access the OpenShift web-console here: https://console-openshift-console.apps.openshift4.example.com</span><br><span class="line">INFO Login to the console with user: &quot;kubeadmin&quot;, and password: &quot;xxxx-xxxx-zKu8J-W7QRi&quot;</span><br><span class="line">INFO Time elapsed: 1s  </span><br></pre></td></tr></table></figure>

<p>注意最后提示访问 <code>Web Console</code> 的网址及用户密码。如果密码忘了也没关系，可以查看文件 <code>/data/ocpinstall/auth/kubeadmin-password</code> 来获得密码。</p>
<p>本地访问 Web Console，因为集群里已经有 ingress controller 了，并且我们的入口是 10.225.45.250 ，所以本地需要添加下列 hosts：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.225.45.250 console-openshift-console.apps.openshift4.example.com</span><br><span class="line">10.225.45.250 oauth-openshift.apps.openshift4.example.com</span><br></pre></td></tr></table></figure>

<p>浏览器访问 <code>https://console-openshift-console.apps.openshift4.example.com</code>，输入上面输出的用户名(kubeadm)和密码登录。首次登录后顶部会提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You are logged <span class="keyword">in</span> as a temporary administrative user. Update the Cluster OAuth configuration to allow others to <span class="built_in">log</span> <span class="keyword">in</span>.</span><br></pre></td></tr></table></figure>

<p>我们可以通过 htpasswd 自定义管理员账号，步骤如下：</p>
<p>1 <code>cd /data/ocpinstall/auth &amp;&amp; htpasswd -c -B -b users.htpasswd admin xxxxx</code></p>
<p>2 将 <code>users.htpasswd</code> 文件下载到本地。</p>
<p>3 在 Web Console 页面打开 <code>Global Configuration</code>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605150947.png" alt="Global Configuration"></p>
<p>然后找到 <code>OAuth</code>，点击进入，然后添加 <code>HTPasswd</code> 类型的 <code>Identity Providers</code>，并上传 <code>users.htpasswd</code> 文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605151307.png" alt="htpasswd"></p>
<p>4 退出当前用户，要注意退出到如下界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605151646.png" alt="login"></p>
<p>选择 <code>htpasswd</code>，然后输入之前创建的用户名密码登录。</p>
<p>如果退出后出现的就是用户密码输入窗口，实际还是 <code>kube:admin</code> 的校验，如果未出现如上提示，可以手动输入 Web Console 地址来自动跳转。</p>
<p>5 登录后貌似能看到 <code>Administrator</code> 菜单项，但访问如 <code>OAuth Details</code> 仍然提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oauths.config.openshift.io <span class="string">&quot;cluster&quot;</span> is forbidden: User <span class="string">&quot;admin&quot;</span> cannot get resource <span class="string">&quot;oauths&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;config.openshift.io&quot;</span> at the cluster scope</span><br></pre></td></tr></table></figure>

<p>因此需要授予集群管理员权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc adm policy add-cluster-role-to-user cluster-admin admin</span><br></pre></td></tr></table></figure>

<p>Web Console 部分截图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605152528.png" alt="operatorhub"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605152729.png" alt="routes"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605152911.png" alt="dashboards"></p>
<p><img src="https://cdn.jsdelivr.net/gh/yangchuansheng/imghosting/img/20200605153048.png" alt="metrics"></p>
<p>如果想删除默认账号，可以执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc -n kube-system delete secrets kubeadmin</span><br></pre></td></tr></table></figure>

<h2 id="集群善后的一些配置"><a href="#集群善后的一些配置" class="headerlink" title="集群善后的一些配置"></a>集群善后的一些配置</h2><h3 id="ingress-controller"><a href="#ingress-controller" class="headerlink" title="ingress controller"></a>ingress controller</h3><p>github 地址为<a target="_blank" rel="noopener" href="https://github.com/openshift/cluster-ingress-operator">cluster-ingress-operator</a><br>这里我集群是3个 master，发现ingress controller的一些属性没配置对，自行先<code>get deploy router-default -o yaml</code>查看，可能后续修复了。根据推测排查到是 operator 部署的，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bastion ~]# oc get ingresscontrollers -A</span><br><span class="line">NAMESPACE                    NAME      AGE</span><br><span class="line">openshift-ingress-operator   default   3d15h</span><br></pre></td></tr></table></figure>

<p>但是看了下属性<code>oc explain ingresscontrollers.spec.endpointPublishingStrategy.hostNetwork</code>发现不支持配置互斥和<code>dnsPolicy</code>，这会导致无法解析集群内的svc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master2 ~]# crictl pods --name router-default-fb744fb7f-hmmn5 -q</span><br><span class="line">0a0c7cc6d1ad6815f7613fd758c5329c4265ddb6607f568b69e30fdafdfc0a52</span><br><span class="line">[root@master2 ~]# crictl ps --pod=0a0c7cc6d1ad6815f7613fd758c5329c4265ddb6607f568b69e30fdafdfc0a52</span><br><span class="line">CONTAINER           IMAGE                                                              CREATED             STATE               NAME                ATTEMPT             POD ID</span><br><span class="line">b04c17fb1c58d       dd7aaceb9081f88c9ba418708f32a66f5de4e527a00c7f6ede50d55c93eb04ed   3 days ago          Running             router              1                   0a0c7cc6d1ad6</span><br><span class="line">[root@master2 ~]# crictl exec b04 cat /etc/resolv.conf</span><br><span class="line">search openshift4.example.com</span><br><span class="line">nameserver 10.225.45.250</span><br><span class="line">[root@master2 ~]# crictl exec b04 curl  kubernetes.default.svc.cluster.local</span><br><span class="line"><span class="meta prompt_">  % </span><span class="language-bash">Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0curl: (6) Could not resolve host: kubernetes.default.svc.cluster.local; Unknown error</span><br><span class="line">FATA[0000] execing command in container failed: command terminated with exit code 6</span><br></pre></td></tr></table></figure>

<p>这个我已经提<a target="_blank" rel="noopener" href="https://github.com/openshift/cluster-ingress-operator/issues/464">issue</a> 了</p>
<p>调整下 ingress controller 的数量，因为 deployment 由 crd 纳管，最好不要直接去操作 deploy 的属性，同时这里我们是把 ingress controller 部署在 master 上，所以得用 nodeSelector 固定，先打 label</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">oc label node master1.openshift4.example.com ingressControllerDeploy=true</span><br><span class="line">oc label node master2.openshift4.example.com ingressControllerDeploy=true</span><br><span class="line">oc label node master3.openshift4.example.com ingressControllerDeploy=true</span><br><span class="line"></span><br><span class="line">oc -n openshift-ingress-operator patch ingresscontroller default --type=&#x27;merge&#x27; -p &quot;$(cat &lt;&lt;- EOF</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  nodePlacement:</span><br><span class="line">    nodeSelector:</span><br><span class="line">      matchLabels:</span><br><span class="line">        ingressControllerDeploy: &quot;true&quot;</span><br><span class="line">EOF</span><br><span class="line">)&quot;</span><br></pre></td></tr></table></figure>

<h3 id="移除haproxy-里-bootstrap-的配置"><a href="#移除haproxy-里-bootstrap-的配置" class="headerlink" title="移除haproxy 里 bootstrap 的配置"></a>移除haproxy 里 bootstrap 的配置</h3><p>自行操作，移除负载均衡里的无用配置</p>
<h3 id="Local-Storage-Operator"><a href="#Local-Storage-Operator" class="headerlink" title="Local Storage Operator"></a>Local Storage Operator</h3><p>参考 <a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/openshift_container_platform/4.5/html/storage/persistent-storage-using-local-volume#local-storage-install_persistent-storage-local">Installing the Local Storage Operator</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oc oc new-project local-storage</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="clusteroperator"><a href="#clusteroperator" class="headerlink" title="clusteroperator"></a>clusteroperator</h3><p>查看 clusteroperator，如果有个别有问题，可以等worker部署完了慢慢排查</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@bastion ~]# oc get clusteroperator</span><br><span class="line">NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE</span><br><span class="line">authentication                             4.5.9     True        False         False      118m</span><br><span class="line">cloud-credential                           4.5.9     True        False         False      3d19h</span><br><span class="line">cluster-autoscaler                         4.5.9     True        False         False      3d18h</span><br><span class="line">config-operator                            4.5.9     True        False         False      3d18h</span><br><span class="line">console                                    4.5.9     True        False         False      8m22s</span><br><span class="line">csi-snapshot-controller                    4.5.9     True        False         False      8m27s</span><br><span class="line">dns                                        4.5.9     True        False         False      8m22s</span><br><span class="line">etcd                                       4.5.9     True        False         False      3d19h</span><br><span class="line">image-registry                             4.5.9     True        False         False      3d19h</span><br><span class="line">ingress                                    4.5.9     True        False         False      8m24s</span><br><span class="line">insights                                   4.5.9     True        False         False      3d19h</span><br><span class="line">kube-apiserver                             4.5.9     True        False         False      3d19h</span><br><span class="line">kube-controller-manager                    4.5.9     True        False         False      3d19h</span><br><span class="line">kube-scheduler                             4.5.9     True        False         False      3d19h</span><br><span class="line">kube-storage-version-migrator              4.5.9     True        False         False      8m23s</span><br><span class="line">machine-api                                4.5.9     True        False         False      3d19h</span><br><span class="line">machine-approver                           4.5.9     True        False         False      3d19h</span><br><span class="line">machine-config                             4.5.9     True        False         False      3d19h</span><br><span class="line">marketplace                                4.5.9     True        False         False      3d19h</span><br><span class="line">monitoring                                 4.5.9     True        False         False      3d18h</span><br><span class="line">network                                    4.5.9     True        False         False      3d19h</span><br><span class="line">node-tuning                                4.5.9     True        False         False      8m27s</span><br><span class="line">openshift-apiserver                        4.5.9     True        False         False      8m20s</span><br><span class="line">openshift-controller-manager               4.5.9     True        False         False      8m5s</span><br><span class="line">openshift-samples                          4.5.9     True        False         False      3d18h</span><br><span class="line">operator-lifecycle-manager                 4.5.9     True        False         False      3d19h</span><br><span class="line">operator-lifecycle-manager-catalog         4.5.9     True        False         False      3d19h</span><br><span class="line">operator-lifecycle-manager-packageserver   4.5.9     True        False         False      7m56s</span><br><span class="line">service-ca                                 4.5.9     True        False         False      3d19h</span><br><span class="line">storage                                    4.5.9     True        False         False      3d19h</span><br></pre></td></tr></table></figure>

<h2 id="troubleshooting"><a href="#troubleshooting" class="headerlink" title="troubleshooting"></a>troubleshooting</h2><p>参考<a target="_blank" rel="noopener" href="https://github.com/openshift/installer/blob/master/docs/user/troubleshooting.md">官方troubleshooting文档</a>，很多理念还是 k8s，所以多用 oc 命令排查</p>
<p>这里是我单 master 时候的错误，可以参考下排查思路</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@bastion ocpinstall]# oc get po -A</span><br><span class="line">NAMESPACE                                          NAME                                                      READY   STATUS             RESTARTS   AGE</span><br><span class="line">openshift-apiserver-operator                       openshift-apiserver-operator-6ddb679b87-478mq             1/1     Running            1          65m</span><br><span class="line">openshift-authentication-operator                  authentication-operator-f9c8c4d9-gqkhl                    1/1     Running            6          65m</span><br><span class="line">openshift-cluster-machine-approver                 machine-approver-55ccb88c4-cfxtm                          2/2     Running            0          65m</span><br><span class="line">openshift-cluster-node-tuning-operator             cluster-node-tuning-operator-576df548b-mbzcz              1/1     Running            0          65m</span><br><span class="line">openshift-cluster-node-tuning-operator             tuned-8vv2c                                               1/1     Running            0          57m</span><br><span class="line">openshift-cluster-storage-operator                 csi-snapshot-controller-operator-59cfdb9dc6-8qsm2         1/1     Running            0          65m</span><br><span class="line">openshift-cluster-version                          cluster-version-operator-6fc5bf7855-bjdbg                 1/1     Running            0          65m</span><br><span class="line">openshift-controller-manager-operator              openshift-controller-manager-operator-6d85b6f94-zxdc4     1/1     Running            1          65m</span><br><span class="line">openshift-dns-operator                             dns-operator-b47fff57d-4vlbs                              2/2     Running            0          65m</span><br><span class="line">openshift-dns                                      dns-default-qq6lt                                         3/3     Running            0          56m</span><br><span class="line">openshift-etcd-operator                            etcd-operator-5bcff88f49-mqvdh                            1/1     Running            1          65m</span><br><span class="line">openshift-kube-apiserver-operator                  kube-apiserver-operator-79b99c5564-c24z8                  1/1     Running            1          65m</span><br><span class="line">openshift-kube-apiserver                           installer-2-master1.openshift4.example.com                0/1     Completed          0          55m</span><br><span class="line">openshift-kube-apiserver                           kube-apiserver-master1.openshift4.example.com             3/4     CrashLoopBackOff   14         55m</span><br><span class="line">openshift-kube-controller-manager-operator         kube-controller-manager-operator-656db94888-gxlh8         1/1     Running            1          65m</span><br><span class="line">openshift-kube-controller-manager                  installer-3-master1.openshift4.example.com                0/1     Completed          0          55m</span><br><span class="line">openshift-kube-controller-manager                  installer-4-master1.openshift4.example.com                0/1     Completed          0          55m</span><br><span class="line">openshift-kube-controller-manager                  kube-controller-manager-master1.openshift4.example.com    4/4     Running            0          55m</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-3-master1.openshift4.example.com          0/1     Completed          0          55m</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-4-master1.openshift4.example.com          0/1     Completed          0          54m</span><br><span class="line">openshift-kube-scheduler-operator                  openshift-kube-scheduler-operator-5db8ddbd86-zgc2j        1/1     Running            1          65m</span><br><span class="line">openshift-kube-scheduler                           installer-2-master1.openshift4.example.com                0/1     Completed          0          57m</span><br><span class="line">openshift-kube-scheduler                           installer-3-master1.openshift4.example.com                0/1     Completed          0          56m</span><br><span class="line">openshift-kube-scheduler                           installer-4-master1.openshift4.example.com                0/1     Completed          0          56m</span><br><span class="line">openshift-kube-scheduler                           installer-5-master1.openshift4.example.com                0/1     Completed          0          55m</span><br><span class="line">openshift-kube-scheduler                           openshift-kube-scheduler-master1.openshift4.example.com   2/2     Running            0          55m</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-2-master1.openshift4.example.com          0/1     Completed          0          56m</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-3-master1.openshift4.example.com          0/1     Completed          0          56m</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-4-master1.openshift4.example.com          0/1     Completed          0          55m</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-5-master1.openshift4.example.com          0/1     Completed          0          54m</span><br><span class="line">openshift-kube-storage-version-migrator-operator   kube-storage-version-migrator-operator-57c5ccbffc-rsfgm   1/1     Running            1          65m</span><br><span class="line">openshift-kube-storage-version-migrator            migrator-84f6d56959-7fjrb                                 1/1     Running            0          57m</span><br><span class="line">openshift-machine-config-operator                  etcd-quorum-guard-6868b6549-5gx99                         0/1     Pending            0          56m</span><br><span class="line">openshift-machine-config-operator                  etcd-quorum-guard-6868b6549-dpjf8                         0/1     Pending            0          56m</span><br><span class="line">openshift-machine-config-operator                  etcd-quorum-guard-6868b6549-whsdq                         0/1     Running            0          56m</span><br><span class="line">openshift-machine-config-operator                  machine-config-controller-c5f979c7c-jrr7h                 1/1     Running            0          56m</span><br><span class="line">openshift-machine-config-operator                  machine-config-daemon-hqfns                               2/2     Running            0          57m</span><br><span class="line">openshift-machine-config-operator                  machine-config-operator-7f9fc9fb9-6zh9j                   1/1     Running            0          65m</span><br><span class="line">openshift-machine-config-operator                  machine-config-server-w84sq                               1/1     Running            0          56m</span><br><span class="line">openshift-multus                                   multus-admission-controller-z9hc4                         2/2     Running            0          57m</span><br><span class="line">openshift-multus                                   multus-jfwbz                                              1/1     Running            0          58m</span><br><span class="line">openshift-network-operator                         network-operator-84bb7765bc-7c2jm                         1/1     Running            0          65m</span><br><span class="line">openshift-operator-lifecycle-manager               catalog-operator-5ff486f6c8-tplsr                         1/1     Running            0          65m</span><br><span class="line">openshift-operator-lifecycle-manager               olm-operator-b4fd47678-wmpxt                              1/1     Running            0          65m</span><br><span class="line">openshift-operator-lifecycle-manager               packageserver-b68fc7b76-g8fxb                             1/1     Running            0          72s</span><br><span class="line">openshift-operator-lifecycle-manager               packageserver-b68fc7b76-z9t72                             1/1     Running            0          79s</span><br><span class="line">openshift-sdn                                      ovs-r69fg                                                 1/1     Running            0          57m</span><br><span class="line">openshift-sdn                                      sdn-6js24                                                 1/1     Running            0          57m</span><br><span class="line">openshift-sdn                                      sdn-controller-sk2f9                                      1/1     Running            0          57m</span><br><span class="line">openshift-service-ca-operator                      service-ca-operator-57cd4bc97f-t2mnq                      1/1     Running            1          65m</span><br><span class="line">openshift-service-ca                               service-ca-c75f9fb85-grcsm                                1/1     Running            0          57m</span><br></pre></td></tr></table></figure>

<p>发现<code>kube-apiserver-master1.openshift4.example.com</code>的 pod 有个容器一直 crash，从 bastion 上 ssh 到 master1 上去后查看日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 apiserver 的容器组</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps --pod=$(crictl pods --name=kube-apiserver-master1.openshift4.example.com --quiet)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">找到失败的容器，查看<span class="built_in">log</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl logs xxx</span></span><br><span class="line">...</span><br><span class="line">W0917 06:31:23.240165    1 clientconn.go:1208] grpc: addrConn.createTransport failed to connect to &#123;https://10.225.45.251:2379 &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc = &quot;transport: Error while dialing dial tcp 10.225.45.251:2379: connect: connection refused&quot;. Reconnecting...</span><br></pre></td></tr></table></figure>

<p>查看发现没有etcd的容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl ps -a | grep etcd</span><br></pre></td></tr></table></figure>

<p>回到 bastion 上，查看 etcd 来源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">oc get po -A | grep etcd</span></span><br><span class="line">openshift-etcd-operator                            etcd-operator-5bcff88f49-jf4rk                            1/1     Running            1          100m</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有operator，查看deloy</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">oc get deployment -A | grep etcd</span></span><br><span class="line">openshift-etcd-operator                            etcd-operator                            1/1     1            1           100m</span><br><span class="line">openshift-machine-config-operator                  etcd-quorum-guard                        0/1     1            0           91m</span><br></pre></td></tr></table></figure>

<p>从时间上看，operator 先部署，然后operator 部署了 etcd-quorum-guard 的 pod，但是没就绪。这个 etcd 来源于 crd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">oc -n openshift-etcd get etcd</span></span><br><span class="line">NAME     AGE</span><br><span class="line">cluster  138m</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">oc -n openshift-etcd get etcd cluster -o yaml</span></span><br><span class="line">...</span><br><span class="line">- lastTransitionTime: &quot;2020-09-17T05:33:17Z&quot;</span><br><span class="line">  message: still wating for trhee healthz etcd members</span><br><span class="line">  reason：NotEnoughEtcdMembers</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="单-master-的无法部署的处理手段"><a href="#单-master-的无法部署的处理手段" class="headerlink" title="单 master 的无法部署的处理手段"></a>单 master 的无法部署的处理手段</h4><p>看输出是期待 3 个 etcd member，我们需要更改成非 HA 的，执行下面命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">oc patch etcd cluster -p=&#x27;</span><br><span class="line">&#123;&quot;spec&quot;: &#123;&quot;unsupportedConfigOverrides&quot;: &#123;&quot;useUnsupportedUnsafeNonHANonProductionUnstableEtcd&quot;: true&#125;&#125;&#125;</span><br><span class="line">&#x27; </span><br><span class="line">--type=merge</span><br></pre></td></tr></table></figure>

<p>ocp4.6.+ 除了要应用以上 <code>etcd</code> 配置更新外，还需要配置更改 <code>oauth</code> 对于 APIServer HA 的要求，参<a target="_blank" rel="noopener" href="https://github.com/openshift/okd/issues/465">https://github.com/openshift/okd/issues/465</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc patch authentication cluster -p=&#x27;&#123;&quot;spec&quot;:&#123;&quot;unsupportedConfigOverrides&quot;:&#123;&quot;useUnsupportedUnsafeNonHANonProductionUnstableOAuthServer&quot;:true&#125;&#125;&#125;&#x27; --type=merge</span><br></pre></td></tr></table></figure>

<h4 id="一些参考信息"><a href="#一些参考信息" class="headerlink" title="一些参考信息"></a>一些参考信息</h4><p>master 上 manifests 目录正常参考如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 core]# ll /etc/kubernetes/manifests/</span><br><span class="line">total 48</span><br><span class="line">-rw-r--r--. 1 root root 22092 Sep 17 11:54 etcd-pod.yaml</span><br><span class="line">-rw-r--r--. 1 root root  5431 Sep 18 10:17 kube-apiserver-pod.yaml</span><br><span class="line">-rw-r--r--. 1 root root  5903 Sep 17 12:01 kube-controller-manager-pod.yaml</span><br><span class="line">-rw-r--r--. 1 root root  3531 Sep 17 12:00 kube-scheduler-pod.yaml</span><br><span class="line">-rw-r--r--. 1 root root   697 Sep 17 11:19 recycler-pod.yaml</span><br></pre></td></tr></table></figure>

<p>具体哪一步骤有问题可以看下面目录的 done文 件结合 <code>/usr/local/bin/bootkube.sh</code> 脚本查看，正常完成后是下面的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@bootstrap kubernetes]# ll /opt/openshift/</span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x. 2 root root   77 Sep 17 05:21 auth</span><br><span class="line">drwxr-xr-x. 2 root root  176 Sep 17 05:22 bootstrap-manifests</span><br><span class="line">drwxr-xr-x. 4 root root   50 Sep 17 05:22 cco-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:22 cco-bootstrap.done</span><br><span class="line">drwxr-xr-x. 4 root root   64 Sep 17 05:22 config-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:22 config-bootstrap.done</span><br><span class="line">drw-r--r--. 4 root root   40 Sep 17 05:21 cvo-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:21 cvo-bootstrap.done</span><br><span class="line">drwxr-xr-x. 4 root root   64 Sep 17 05:21 etcd-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:21 etcd-bootstrap.done</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:22 ingress-operator-bootstrap.done</span><br><span class="line">drwxr-x---. 2 root root  105 Sep 17 05:22 ingress-operator-manifests</span><br><span class="line">drwxr-xr-x. 4 root root   64 Sep 17 05:22 kube-apiserver-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:22 kube-apiserver-bootstrap.done</span><br><span class="line">drwxr-xr-x. 4 root root   64 Sep 17 05:22 kube-controller-manager-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:22 kube-controller-manager-bootstrap.done</span><br><span class="line">drwxr-xr-x. 4 root root   64 Sep 17 05:22 kube-scheduler-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:22 kube-scheduler-bootstrap.done</span><br><span class="line">drwxr-xr-x. 2 root root 8192 Sep 17 05:22 manifests</span><br><span class="line">drw-r-xr-x. 4 root root   40 Sep 17 05:22 mco-bootstrap</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:22 mco-bootstrap.done</span><br><span class="line">drwxr-xr-x. 2 root root 4096 Sep 17 05:21 openshift</span><br><span class="line">-rw-r--r--. 1 root root    0 Sep 17 05:21 openshift-manifests.done</span><br><span class="line">drwxr-xr-x. 2 root root 8192 Sep 17 05:21 tls</span><br></pre></td></tr></table></figure>

<p>3个 master 和 1个 node 的所有 pod 情况参考:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">[root@bastion ocpinstall]# oc get po -A</span><br><span class="line">NAMESPACE                                          NAME                                                         READY   STATUS      RESTARTS   AGE</span><br><span class="line">openshift-apiserver-operator                       openshift-apiserver-operator-6ddb679b87-48rfk                1/1     Running     2          3d21h</span><br><span class="line">openshift-apiserver                                apiserver-559b848b77-2x22v                                   1/1     Running     0          3d20h</span><br><span class="line">openshift-apiserver                                apiserver-559b848b77-bctpw                                   1/1     Running     0          3d20h</span><br><span class="line">openshift-apiserver                                apiserver-559b848b77-fwks6                                   1/1     Running     0          3d20h</span><br><span class="line">openshift-authentication-operator                  authentication-operator-f9c8c4d9-n94nf                       1/1     Running     4          3d21h</span><br><span class="line">openshift-authentication                           oauth-openshift-8555c79cc8-hksfc                             1/1     Running     0          145m</span><br><span class="line">openshift-authentication                           oauth-openshift-8555c79cc8-nlmxb                             1/1     Running     0          145m</span><br><span class="line">openshift-cloud-credential-operator                cloud-credential-operator-5b67677b7d-h5kfg                   1/1     Running     0          3d20h</span><br><span class="line">openshift-cluster-machine-approver                 machine-approver-55ccb88c4-xdnkl                             2/2     Running     0          3d21h</span><br><span class="line">openshift-cluster-node-tuning-operator             cluster-node-tuning-operator-576df548b-7xb6r                 1/1     Running     0          3d21h</span><br><span class="line">openshift-cluster-node-tuning-operator             tuned-bw8ql                                                  1/1     Running     0          47m</span><br><span class="line">openshift-cluster-node-tuning-operator             tuned-mxpz2                                                  1/1     Running     0          3d21h</span><br><span class="line">openshift-cluster-node-tuning-operator             tuned-pblld                                                  1/1     Running     0          3d21h</span><br><span class="line">openshift-cluster-node-tuning-operator             tuned-w5pct                                                  1/1     Running     0          3d21h</span><br><span class="line">openshift-cluster-samples-operator                 cluster-samples-operator-6bdbc4ffc5-jq7zn                    2/2     Running     0          3d20h</span><br><span class="line">openshift-cluster-storage-operator                 cluster-storage-operator-56f4c88949-844js                    1/1     Running     0          3d20h</span><br><span class="line">openshift-cluster-storage-operator                 csi-snapshot-controller-7d764ffdf8-wnp7h                     1/1     Running     0          3d20h</span><br><span class="line">openshift-cluster-storage-operator                 csi-snapshot-controller-operator-59cfdb9dc6-58ntn            1/1     Running     1          3d21h</span><br><span class="line">openshift-cluster-version                          cluster-version-operator-6fc5bf7855-96p2p                    1/1     Running     0          3d21h</span><br><span class="line">openshift-config-operator                          openshift-config-operator-b79c8b76-5x8c5                     1/1     Running     0          3d20h</span><br><span class="line">openshift-console-operator                         console-operator-887dd965b-28cj2                             1/1     Running     0          3d20h</span><br><span class="line">openshift-console                                  console-7cbd7657d-56bkb                                      1/1     Running     910        3d20h</span><br><span class="line">openshift-console                                  console-7cbd7657d-dqvjz                                      1/1     Running     0          3h28m</span><br><span class="line">openshift-console                                  downloads-54fc476767-59qbt                                   1/1     Running     0          3d20h</span><br><span class="line">openshift-console                                  downloads-54fc476767-hjxhq                                   1/1     Running     0          3d20h</span><br><span class="line">openshift-controller-manager-operator              openshift-controller-manager-operator-6d85b6f94-4t2f7        1/1     Running     2          3d21h</span><br><span class="line">openshift-controller-manager                       controller-manager-2wbpf                                     1/1     Running     0          2d22h</span><br><span class="line">openshift-controller-manager                       controller-manager-pnnk9                                     1/1     Running     0          2d22h</span><br><span class="line">openshift-controller-manager                       controller-manager-qrtg9                                     1/1     Running     0          2d22h</span><br><span class="line">openshift-dns-operator                             dns-operator-b47fff57d-rmnl5                                 2/2     Running     0          3d21h</span><br><span class="line">openshift-dns                                      dns-default-h7scc                                            3/3     Running     0          3d21h</span><br><span class="line">openshift-dns                                      dns-default-mdsq5                                            3/3     Running     0          3d21h</span><br><span class="line">openshift-dns                                      dns-default-r24lg                                            3/3     Running     0          3d21h</span><br><span class="line">openshift-dns                                      dns-default-sm5zl                                            3/3     Running     0          47m</span><br><span class="line">openshift-etcd-operator                            etcd-operator-5bcff88f49-jf4rk                               1/1     Running     1          3d21h</span><br><span class="line">openshift-etcd                                     etcd-master1.openshift4.example.com                          4/4     Running     0          3d20h</span><br><span class="line">openshift-etcd                                     etcd-master2.openshift4.example.com                          4/4     Running     0          3d20h</span><br><span class="line">openshift-etcd                                     etcd-master3.openshift4.example.com                          4/4     Running     0          3d20h</span><br><span class="line">openshift-etcd                                     installer-2-master1.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-etcd                                     installer-2-master2.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-etcd                                     installer-2-master3.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-etcd                                     installer-3-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     installer-3-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     installer-3-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     revision-pruner-2-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     revision-pruner-2-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     revision-pruner-2-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     revision-pruner-3-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     revision-pruner-3-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-etcd                                     revision-pruner-3-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-image-registry                           cluster-image-registry-operator-574467db97-hgcl6             2/2     Running     0          3d20h</span><br><span class="line">openshift-image-registry                           image-pruner-1600473600-ps7rq                                0/1     Completed   0          2d8h</span><br><span class="line">openshift-image-registry                           image-pruner-1600560000-pzqzt                                0/1     Completed   0          32h</span><br><span class="line">openshift-image-registry                           image-pruner-1600646400-bbghl                                0/1     Completed   0          8h</span><br><span class="line">openshift-image-registry                           node-ca-5s66m                                                1/1     Running     0          3d20h</span><br><span class="line">openshift-image-registry                           node-ca-mn8wr                                                1/1     Running     0          3d20h</span><br><span class="line">openshift-image-registry                           node-ca-w22br                                                1/1     Running     0          47m</span><br><span class="line">openshift-image-registry                           node-ca-wcj74                                                1/1     Running     0          3d20h</span><br><span class="line">openshift-ingress-operator                         ingress-operator-69cc5476dc-scjjx                            2/2     Running     0          3d20h</span><br><span class="line">openshift-ingress                                  router-default-5f5d6bf574-67bbd                              1/1     Running     0          134m</span><br><span class="line">openshift-ingress                                  router-default-5f5d6bf574-d6z84                              1/1     Running     0          133m</span><br><span class="line">openshift-ingress                                  router-default-5f5d6bf574-kcf7v                              1/1     Running     0          135m</span><br><span class="line">openshift-insights                                 insights-operator-6cd58d5859-cf9lg                           1/1     Running     0          3d20h</span><br><span class="line">openshift-kube-apiserver-operator                  kube-apiserver-operator-79b99c5564-tlr67                     1/1     Running     2          3d21h</span><br><span class="line">openshift-kube-apiserver                           installer-10-master1.openshift4.example.com                  0/1     Completed   0          3d2h</span><br><span class="line">openshift-kube-apiserver                           installer-10-master2.openshift4.example.com                  0/1     Completed   0          3d2h</span><br><span class="line">openshift-kube-apiserver                           installer-10-master3.openshift4.example.com                  0/1     Completed   0          3d2h</span><br><span class="line">openshift-kube-apiserver                           installer-11-master1.openshift4.example.com                  0/1     Completed   0          2d22h</span><br><span class="line">openshift-kube-apiserver                           installer-11-master2.openshift4.example.com                  0/1     Completed   0          2d22h</span><br><span class="line">openshift-kube-apiserver                           installer-11-master3.openshift4.example.com                  0/1     Completed   0          2d22h</span><br><span class="line">openshift-kube-apiserver                           installer-3-master1.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-apiserver                           installer-4-master3.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-apiserver                           installer-5-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-5-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-5-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-6-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-7-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-8-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-8-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-8-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           installer-9-master1.openshift4.example.com                   0/1     Completed   0          3d3h</span><br><span class="line">openshift-kube-apiserver                           installer-9-master2.openshift4.example.com                   0/1     Completed   0          3d3h</span><br><span class="line">openshift-kube-apiserver                           installer-9-master3.openshift4.example.com                   0/1     Completed   0          3d3h</span><br><span class="line">openshift-kube-apiserver                           kube-apiserver-master1.openshift4.example.com                4/4     Running     0          2d22h</span><br><span class="line">openshift-kube-apiserver                           kube-apiserver-master2.openshift4.example.com                4/4     Running     0          2d22h</span><br><span class="line">openshift-kube-apiserver                           kube-apiserver-master3.openshift4.example.com                4/4     Running     0          2d22h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-10-master1.openshift4.example.com            0/1     Completed   0          3d2h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-10-master2.openshift4.example.com            0/1     Completed   0          3d2h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-10-master3.openshift4.example.com            0/1     Completed   0          3d2h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-11-master1.openshift4.example.com            0/1     Completed   0          2d22h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-11-master2.openshift4.example.com            0/1     Completed   0          2d22h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-11-master3.openshift4.example.com            0/1     Completed   0          2d22h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-3-master1.openshift4.example.com             0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-4-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-5-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-5-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-5-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-6-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-7-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-8-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-8-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-8-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-9-master1.openshift4.example.com             0/1     Completed   0          3d3h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-9-master2.openshift4.example.com             0/1     Completed   0          3d3h</span><br><span class="line">openshift-kube-apiserver                           revision-pruner-9-master3.openshift4.example.com             0/1     Completed   0          3d2h</span><br><span class="line">openshift-kube-controller-manager-operator         kube-controller-manager-operator-656db94888-9twxm            1/1     Running     2          3d21h</span><br><span class="line">openshift-kube-controller-manager                  installer-2-master1.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-controller-manager                  installer-3-master1.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-controller-manager                  installer-3-master2.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-controller-manager                  installer-3-master3.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-controller-manager                  installer-5-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-5-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-5-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-6-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-6-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-6-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-7-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-7-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  installer-7-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  kube-controller-manager-master1.openshift4.example.com       4/4     Running     0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  kube-controller-manager-master2.openshift4.example.com       4/4     Running     1          3d20h</span><br><span class="line">openshift-kube-controller-manager                  kube-controller-manager-master3.openshift4.example.com       4/4     Running     0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-2-master1.openshift4.example.com             0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-3-master1.openshift4.example.com             0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-3-master2.openshift4.example.com             0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-3-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-5-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-5-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-5-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-6-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-6-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-6-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-7-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-7-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-controller-manager                  revision-pruner-7-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler-operator                  openshift-kube-scheduler-operator-5db8ddbd86-b4npw           1/1     Running     1          3d21h</span><br><span class="line">openshift-kube-scheduler                           installer-3-master2.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-scheduler                           installer-4-master1.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-scheduler                           installer-4-master2.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-scheduler                           installer-4-master3.openshift4.example.com                   0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-scheduler                           installer-5-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           installer-5-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           installer-5-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           installer-6-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           installer-6-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           installer-7-master1.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           installer-7-master2.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           installer-7-master3.openshift4.example.com                   0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           openshift-kube-scheduler-master1.openshift4.example.com      2/2     Running     1          3d20h</span><br><span class="line">openshift-kube-scheduler                           openshift-kube-scheduler-master2.openshift4.example.com      2/2     Running     0          3d20h</span><br><span class="line">openshift-kube-scheduler                           openshift-kube-scheduler-master3.openshift4.example.com      2/2     Running     2          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-3-master2.openshift4.example.com             0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-4-master1.openshift4.example.com             0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-4-master2.openshift4.example.com             0/1     Completed   0          3d21h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-4-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-5-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-5-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-5-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-6-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-6-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-7-master1.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-7-master2.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-scheduler                           revision-pruner-7-master3.openshift4.example.com             0/1     Completed   0          3d20h</span><br><span class="line">openshift-kube-storage-version-migrator-operator   kube-storage-version-migrator-operator-57c5ccbffc-7x2tv      1/1     Running     1          3d21h</span><br><span class="line">openshift-kube-storage-version-migrator            migrator-84f6d56959-hnhlb                                    1/1     Running     0          3d21h</span><br><span class="line">openshift-machine-api                              cluster-autoscaler-operator-568855ff87-mxpfm                 2/2     Running     0          3d20h</span><br><span class="line">openshift-machine-api                              machine-api-operator-7744b46cbc-frbmx                        2/2     Running     0          3d20h</span><br><span class="line">openshift-machine-config-operator                  etcd-quorum-guard-6868b6549-dgk9t                            1/1     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  etcd-quorum-guard-6868b6549-g495s                            1/1     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  etcd-quorum-guard-6868b6549-pbwq9                            1/1     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  machine-config-controller-c5f979c7c-vkmdd                    1/1     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  machine-config-daemon-79k88                                  2/2     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  machine-config-daemon-h6fxj                                  2/2     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  machine-config-daemon-qgdvd                                  2/2     Running     0          47m</span><br><span class="line">openshift-machine-config-operator                  machine-config-daemon-t9gsq                                  2/2     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  machine-config-operator-7f9fc9fb9-9whkf                      1/1     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  machine-config-server-66vdl                                  1/1     Running     0          3d20h</span><br><span class="line">openshift-machine-config-operator                  machine-config-server-x7zw6                                  1/1     Running     0          3d21h</span><br><span class="line">openshift-machine-config-operator                  machine-config-server-xfs4q                                  1/1     Running     0          3d21h</span><br><span class="line">openshift-marketplace                              certified-operators-77d7996cd8-59qhh                         1/1     Running     82         3d20h</span><br><span class="line">openshift-marketplace                              community-operators-7c466b6dc4-87q7n                         1/1     Running     104        3d20h</span><br><span class="line">openshift-marketplace                              marketplace-operator-66f9cd98-c5psh                          1/1     Running     0          3d20h</span><br><span class="line">openshift-marketplace                              redhat-marketplace-799fdd5f6c-pwhb6                          1/1     Running     36         3d20h</span><br><span class="line">openshift-marketplace                              redhat-operators-6c568f687f-t494g                            1/1     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               alertmanager-main-0                                          5/5     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               alertmanager-main-1                                          5/5     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               alertmanager-main-2                                          5/5     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               cluster-monitoring-operator-db8666945-pvsdq                  2/2     Running     2          3d20h</span><br><span class="line">openshift-monitoring                               grafana-6db66b6b79-glzvk                                     2/2     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               kube-state-metrics-6495bd567c-cp47h                          3/3     Running     2          3d20h</span><br><span class="line">openshift-monitoring                               node-exporter-6bc5z                                          2/2     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               node-exporter-hv2kb                                          2/2     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               node-exporter-lh4rs                                          2/2     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               node-exporter-sgrh8                                          2/2     Running     0          47m</span><br><span class="line">openshift-monitoring                               openshift-state-metrics-84c7687db5-6dkcq                     3/3     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               prometheus-adapter-674b6c66dc-hmwwt                          1/1     Running     0          2d22h</span><br><span class="line">openshift-monitoring                               prometheus-adapter-674b6c66dc-vwvcq                          1/1     Running     0          2d22h</span><br><span class="line">openshift-monitoring                               prometheus-k8s-0                                             7/7     Running     1          3d20h</span><br><span class="line">openshift-monitoring                               prometheus-k8s-1                                             7/7     Running     1          3d20h</span><br><span class="line">openshift-monitoring                               prometheus-operator-78769c95bb-2w2sc                         2/2     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               telemeter-client-654456d57f-grq8w                            3/3     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               thanos-querier-657fff7b4-p2zb7                               4/4     Running     0          3d20h</span><br><span class="line">openshift-monitoring                               thanos-querier-657fff7b4-tnkxm                               4/4     Running     0          3d20h</span><br><span class="line">openshift-multus                                   multus-9ljk9                                                 1/1     Running     0          3d21h</span><br><span class="line">openshift-multus                                   multus-admission-controller-2wxgw                            2/2     Running     0          3d21h</span><br><span class="line">openshift-multus                                   multus-admission-controller-srz97                            2/2     Running     0          3d20h</span><br><span class="line">openshift-multus                                   multus-admission-controller-wh6g8                            2/2     Running     0          3d21h</span><br><span class="line">openshift-multus                                   multus-nf2vz                                                 1/1     Running     0          47m</span><br><span class="line">openshift-multus                                   multus-pnvbh                                                 1/1     Running     0          3d21h</span><br><span class="line">openshift-multus                                   multus-qw5j4                                                 1/1     Running     0          3d20h</span><br><span class="line">openshift-network-operator                         network-operator-84bb7765bc-92p6g                            1/1     Running     0          3d21h</span><br><span class="line">openshift-operator-lifecycle-manager               catalog-operator-5ff486f6c8-2pjdd                            1/1     Running     0          3d21h</span><br><span class="line">openshift-operator-lifecycle-manager               olm-operator-b4fd47678-c5kvt                                 1/1     Running     0          3d21h</span><br><span class="line">openshift-operator-lifecycle-manager               packageserver-c8c74bbcb-64wf2                                1/1     Running     0          102m</span><br><span class="line">openshift-operator-lifecycle-manager               packageserver-c8c74bbcb-skbpd                                1/1     Running     0          100m</span><br><span class="line">openshift-sdn                                      ovs-cnmcx                                                    1/1     Running     0          3d21h</span><br><span class="line">openshift-sdn                                      ovs-kftfb                                                    1/1     Running     0          3d21h</span><br><span class="line">openshift-sdn                                      ovs-qglgb                                                    1/1     Running     0          3d21h</span><br><span class="line">openshift-sdn                                      ovs-tczlx                                                    1/1     Running     0          47m</span><br><span class="line">openshift-sdn                                      sdn-7dxts                                                    1/1     Running     0          3d20h</span><br><span class="line">openshift-sdn                                      sdn-controller-9xkqp                                         1/1     Running     0          3d21h</span><br><span class="line">openshift-sdn                                      sdn-controller-bwcc2                                         1/1     Running     0          3d21h</span><br><span class="line">openshift-sdn                                      sdn-controller-pfq7c                                         1/1     Running     2          3d21h</span><br><span class="line">openshift-sdn                                      sdn-crgmz                                                    1/1     Running     0          3d21h</span><br><span class="line">openshift-sdn                                      sdn-kwtss                                                    1/1     Running     0          47m</span><br><span class="line">openshift-sdn                                      sdn-vqzp9                                                    1/1     Running     0          3d21h</span><br><span class="line">openshift-service-ca-operator                      service-ca-operator-57cd4bc97f-9hll7                         1/1     Running     2          3d21h</span><br><span class="line">openshift-service-ca                               service-ca-c75f9fb85-xs454                                   1/1     Running     0          3d21h</span><br><span class="line">openshift-service-catalog-removed                  openshift-service-catalog-apiserver-remover-j7nft            0/1     Completed   0          3h28m</span><br><span class="line">openshift-service-catalog-removed                  openshift-service-catalog-controller-manager-remover-tp4ff   0/1     Completed   0          3h28m</span><br></pre></td></tr></table></figure>

<h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><p>2021-06-08 推荐 24 小时后再备份，<a target="_blank" rel="noopener" href="https://docs.openshift.com/container-platform/4.7/backup_and_restore/backing-up-etcd.html">官方备份文档</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/openshift_container_platform/4.5/html/installing_on_bare_metal/installing-restricted-networks-bare-metal#installation-about-restricted-networks_installing-restricted-networks-bare-metal">官方文档 [zh]在受限网络中的裸机上安装集群</a></li>
<li><a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/openshift4.4-install-offline-static-1-requirement/">4.4.9部署</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.openshift.com/container-platform/4.5/welcome/index.html">学习文档</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/openshift_container_platform/4.5/pdf/architecture/OpenShift_Container_Platform-4.5-Architecture-zh-CN.pdf">pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.openshift.com/container-platform/4.5/architecture/architecture-rhcos.html">rhcos</a></li>
</ul>
<p>其他的 单master 参考:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/williamcaban/7d4fa16c91cf597517e5778428e74658">https://gist.github.com/williamcaban/7d4fa16c91cf597517e5778428e74658</a></li>
<li><a target="_blank" rel="noopener" href="https://misa.gitbook.io/k8s-ocp-yaml/openshift-docs/2020-02-25-openshift4.4-install-online-staticip-allinone">https://misa.gitbook.io/k8s-ocp-yaml/openshift-docs/2020-02-25-openshift4.4-install-online-staticip-allinone</a></li>
<li><a target="_blank" rel="noopener" href="https://cgruver.github.io/okd4-single-node-cluster/">https://cgruver.github.io/okd4-single-node-cluster/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/cai11745/k8s-ocp-yaml/blob/master/ocp4/2020-02-25-openshift4.4-install-online-staticIP-allinone.md#%E5%AE%89%E8%A3%85%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6">https://github.com/cai11745/k8s-ocp-yaml/blob/master/ocp4/2020-02-25-openshift4.4-install-online-staticIP-allinone.md#%E5%AE%89%E8%A3%85%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6</a></li>
</ul>

    </article>
    <!-- license -->
        <div class="license-wrapper">
            <p>原文作者：<a href="http://zhangguanzhang.github.io">Zhangguanzhang</a>
            <p>原文链接：<a href="http://zhangguanzhang.github.io/2020/09/18/ocp-4.5-install/">http://zhangguanzhang.github.io/2020/09/18/ocp-4.5-install/</a>
            <p>发表日期：<a href="http://zhangguanzhang.github.io/2020/09/18/ocp-4.5-install/">九月 18日 2020, 11:14:06 上午</a>
            <p>更新日期：<a href="http://zhangguanzhang.github.io/2020/09/18/ocp-4.5-install/">September 18th 2020, 11:14:06 am</a>
            <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
                <div class="nextSlogan">Next Post</div>
                <a href="/2020/10/20/kylin-v10-k8s-overlay-error/" title="银河麒麟arm64系统上k8s集群跨节点不通的一次排查">
                    <div class="nextTitle">银河麒麟arm64系统上k8s集群跨节点不通的一次排查</div>
                </a>
        </li>
        <li class="previous">
                <div class="prevSlogan">Previous Post</div>
                <a href="/2020/08/27/skopeo-static-build/" title="skopeo 静态编译">
                    <div class="prevTitle">skopeo 静态编译</div>
                </a>
        </li>
    </ul>
    <!-- comment -->
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->
    <div id="lv-container" data-id="city" data-uid= MTAyMC8zMzk1OC8xMDQ5Mw>
        <script type="text/javascript">
            (function (d, s) {
                var j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') { return; }
                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');
        </script>
        <noscript>为正常使用来必力评论功能请激活 JavaScript</noscript>
    </div>

            
            
            
            <!-- utteranc评论 -->

            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->

            
            
            
        </div>
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    <!-- Mathjax -->
</main>

                <!-- profile -->
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
        <div class="social">
                            <a href="mailto:zhangguanzhang@qq.com" class="iconfont-archer email" title="email" ></a>
                <a href="//github.com/zhangguanzhang" class="iconfont-archer github" target="_blank" title="github"></a>
                <span class="iconfont-archer wechat" title="wechat">
                    <img class="profile-qr" src="/assets/example_wc.png" />
                </span>
                <a href="/assets/zhifubao.png" class="iconfont-archer others" target="_blank" title="others"></a>
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title="rss"></a>

        </div>
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    <!-- 不蒜子  -->
        <div class="busuanzi-container">
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
        </div>
</footer>

        </div>
        <!-- toc -->
            <div class="toc-wrapper toc-wrapper-loding" style=    top:50vh;
>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">前言介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ocp%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">ocp介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ocp%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">ocp安装流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%84%E5%88%92"><span class="toc-number">2.</span> <span class="toc-text">服务器规划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E8%A7%84%E5%88%92"><span class="toc-number">2.1.</span> <span class="toc-text">资源规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.2.</span> <span class="toc-text">防火墙端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS"><span class="toc-number">2.3.</span> <span class="toc-text">DNS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%87%86%E5%A4%87"><span class="toc-number">3.</span> <span class="toc-text">镜像准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-registry"><span class="toc-number">3.1.</span> <span class="toc-text">本地镜像仓库 - registry</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-compose-for-registry"><span class="toc-number">3.1.1.</span> <span class="toc-text">docker-compose for registry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#setup-for-registry"><span class="toc-number">3.1.2.</span> <span class="toc-text">setup for registry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ssl-for-registry"><span class="toc-number">3.1.3.</span> <span class="toc-text">ssl for registry</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%B5%E4%BA%91%E6%A2%AF%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">纵云梯节点配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEregistry-%E7%9A%84-hosts"><span class="toc-number">4.1.</span> <span class="toc-text">配置registry 的 hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8C-secret-json-%E5%87%86%E5%A4%87"><span class="toc-number">4.2.</span> <span class="toc-text">二进制文件和 secret.json 准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%95%9C%E5%83%8F"><span class="toc-number">4.3.</span> <span class="toc-text">同步镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E8%BD%AC%E5%8F%91%E5%88%B0-LOCAL-REGISTRY"><span class="toc-number">4.3.1.</span> <span class="toc-text">实时转发到 LOCAL_REGISTRY</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%88%B0%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95"><span class="toc-number">4.3.2.</span> <span class="toc-text">同步到本地目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bastion"><span class="toc-number">5.</span> <span class="toc-text">bastion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cert-for-registry"><span class="toc-number">5.1.</span> <span class="toc-text">cert for registry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oc-openshift-install"><span class="toc-number">5.2.</span> <span class="toc-text">oc &amp;&amp; openshift-install</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns-server"><span class="toc-number">5.3.</span> <span class="toc-text">dns server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#coredns"><span class="toc-number">5.3.1.</span> <span class="toc-text">coredns</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#etcd"><span class="toc-number">5.3.2.</span> <span class="toc-text">etcd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#config-for-dns"><span class="toc-number">5.3.3.</span> <span class="toc-text">config for dns</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#validate-for-dns"><span class="toc-number">5.3.4.</span> <span class="toc-text">validate for dns</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.4.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#config-for-haproxy"><span class="toc-number">5.4.1.</span> <span class="toc-text">config for haproxy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-file-download"><span class="toc-number">5.5.</span> <span class="toc-text">http file download</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rhcos-iso"><span class="toc-number">5.5.1.</span> <span class="toc-text">rhcos iso</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87"><span class="toc-number">5.6.</span> <span class="toc-text">安装准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90ssh%E5%AF%86%E9%92%A5%E5%AF%B9"><span class="toc-number">5.6.1.</span> <span class="toc-text">生成ssh密钥对</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.6.2.</span> <span class="toc-text">创建安装配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.6.3.</span> <span class="toc-text">生成部署配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%9B%86%E7%BE%A4"><span class="toc-number">6.</span> <span class="toc-text">安装集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bootstrap"><span class="toc-number">6.1.</span> <span class="toc-text">bootstrap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#master"><span class="toc-number">6.2.</span> <span class="toc-text">master</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#worker"><span class="toc-number">6.3.</span> <span class="toc-text">worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="toc-number">6.4.</span> <span class="toc-text">验证集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-oc-kubeconfig"><span class="toc-number">6.4.1.</span> <span class="toc-text">配置 oc kubeconfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="toc-number">6.4.2.</span> <span class="toc-text">验证集群节点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web-console"><span class="toc-number">6.5.</span> <span class="toc-text">web console</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%96%84%E5%90%8E%E7%9A%84%E4%B8%80%E4%BA%9B%E9%85%8D%E7%BD%AE"><span class="toc-number">7.</span> <span class="toc-text">集群善后的一些配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ingress-controller"><span class="toc-number">7.1.</span> <span class="toc-text">ingress controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4haproxy-%E9%87%8C-bootstrap-%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">7.2.</span> <span class="toc-text">移除haproxy 里 bootstrap 的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Local-Storage-Operator"><span class="toc-number">7.3.</span> <span class="toc-text">Local Storage Operator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clusteroperator"><span class="toc-number">7.4.</span> <span class="toc-text">clusteroperator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#troubleshooting"><span class="toc-number">8.</span> <span class="toc-text">troubleshooting</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95-master-%E7%9A%84%E6%97%A0%E6%B3%95%E9%83%A8%E7%BD%B2%E7%9A%84%E5%A4%84%E7%90%86%E6%89%8B%E6%AE%B5"><span class="toc-number">8.1.</span> <span class="toc-text">单 master 的无法部署的处理手段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%8F%82%E8%80%83%E4%BF%A1%E6%81%AF"><span class="toc-number">8.2.</span> <span class="toc-text">一些参考信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD"><span class="toc-number">9.</span> <span class="toc-text">备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">10.</span> <span class="toc-text">参考</span></a></li></ol>
            </div>
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    <div class="total-and-search">
        <div class="total-archive">
        Total : 207
        </div>
        <!-- search  -->
            <div class="site-search site-search-loading popup-trigger">
                <span class="iconfont-archer search-icon">&#xe627;</span>
            </div>
    </div>
    <div class="post-archive">
            <div class="archive-year"> 2025 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/12</span>
            <a class="archive-post-title" href="/2025/11/12/docker-sandbox-dns/">docker 下，重启 pod sandbox 造成 dns 异常的梳理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/06</span>
            <a class="archive-post-title" href="/2025/11/06/docker-GetImageBlob-no-such/">docker open /var/lib/docker/tmp/GetImageBlobXXX: no such file 的正确处理方式</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/31</span>
            <a class="archive-post-title" href="/2025/10/31/skopeo-copy-panic/">多线程执行skopeo copy panic的一次解决过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/23</span>
            <a class="archive-post-title" href="/2025/10/23/docker-bin-containerd/">离线安装docker和包管理安装docker下containerd的启动相关</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/17</span>
            <a class="archive-post-title" href="/2025/10/17/keepalived-locking-pid-file-invalid/">keepalived Locking pid file error 22 - Invalid argument</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/15</span>
            <a class="archive-post-title" href="/2025/10/15/k8s-NodePort-filter/">从自己造轮子NodePort白名单到参考 calico 规则</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/13</span>
            <a class="archive-post-title" href="/2025/10/13/k8s-hostNetwork-hostname/">hostNetwork下hostname的坑</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/23</span>
            <a class="archive-post-title" href="/2025/09/23/flannel.1-cannot-ping/">个别节点上 flannel.1 的 IP 无法 ping</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span>
            <a class="archive-post-title" href="/2025/09/12/salt-run-hang/">salt-run很久才返回</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/10</span>
            <a class="archive-post-title" href="/2025/09/10/kylin-4.19.90-52.49-udp-drop/">麒麟内核4.19.90-52.49导致的flannel vxlan跨节点不通</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/03</span>
            <a class="archive-post-title" href="/2025/09/03/flannel-mode-chaos/">flannel 路由错乱</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/06</span>
            <a class="archive-post-title" href="/2025/08/06/centos7-podman/">私有化下(CentOS 7)Podman调研</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/29</span>
            <a class="archive-post-title" href="/2025/07/29/python-grpc-first-long/">python grpc 使用域名第一次耗时长问题</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/17</span>
            <a class="archive-post-title" href="/2025/06/17/golang-gitlab-subgroup/">golang gitlab subgroup 构建问题</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span>
            <a class="archive-post-title" href="/2025/06/02/kubernetes-cert/">小白向的 kubernetes 证书讲解</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/27</span>
            <a class="archive-post-title" href="/2025/04/27/android-tun2sock/">开发一个让指定应用走代理的安卓 app 过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2025/04/21/kube-log-runner/">kube-log-runner 使用和适配 logrotate 改造</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/14</span>
            <a class="archive-post-title" href="/2025/02/14/aliyun-ecs-ssl/">阿里云 ecs 上 etcd SSL reset</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span>
            <a class="archive-post-title" href="/2025/02/13/clickhouse-arm64-v8.0-build/">给鲲鹏920和低版本飞腾编译arm64 clickhouse</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/08</span>
            <a class="archive-post-title" href="/2025/01/08/docker-login-hang/">docker login hang</a>
        </li>
                </ul>
            <div class="archive-year"> 2024 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/24</span>
            <a class="archive-post-title" href="/2024/11/24/inotifywait-and-confd/">inotifywait 和 confd 在一起踩的坑</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/16</span>
            <a class="archive-post-title" href="/2024/09/16/hostPort-problem/">hostPort 不通排查，以及挖掘问题根源</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/02</span>
            <a class="archive-post-title" href="/2024/08/02/k8s-ipv6/">在 IPv6 单栈下适配部署 K8S、中间件、应用适配</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/25</span>
            <a class="archive-post-title" href="/2024/07/25/headscale/">[持续更新] - headscale 搭建和应用场景</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/21</span>
            <a class="archive-post-title" href="/2024/07/21/Linux-android/">[持续更新] - 安卓折腾笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/17</span>
            <a class="archive-post-title" href="/2024/06/17/hostPort-source-addr-cni0/">hostPort 访问进来的源 IP 是 cni0 地址的排查</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/22</span>
            <a class="archive-post-title" href="/2024/05/22/redis-arm64-cow/">arm64 redis COW 检测</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span>
            <a class="archive-post-title" href="/2024/05/01/kubernetes-hotplug-resource/">k8s node 热扩容内存导致的一次业务故障</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/22</span>
            <a class="archive-post-title" href="/2024/04/22/trivy/">开源容器镜像扫描 trivy 懒人重点指南</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/16</span>
            <a class="archive-post-title" href="/2024/04/16/pprof-small/">golang pprof 转 svg 的最小二进制依赖尝试</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/2024/04/11/cri-docker-sandbox-image/">cri-dockerd 无法拉取需认证仓库上的 pause 镜像解决</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/08</span>
            <a class="archive-post-title" href="/2024/04/08/nvidia-container-toolkit/">docker 和 k8s 使用 gpu 笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span>
            <a class="archive-post-title" href="/2024/02/06/serviceAccountToken-valid/">高版本client-go在serviceAccountToken下invalid bearer token?</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/26</span>
            <a class="archive-post-title" href="/2024/01/26/docker-registry-tag-delete/">docker v2 registry 本地仓库如何只删除指定 tag 而非 manifest 下的所有 tag</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/16</span>
            <a class="archive-post-title" href="/2024/01/16/go-docker-img/">golang 代码层面构建和推送容器镜像到远端仓库</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/08</span>
            <a class="archive-post-title" href="/2024/01/08/docker-apparmor/">docker 和 apparmor</a>
        </li>
                </ul>
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/2023/12/01/resolvconf-hang/">openat /etc/resolv.conf 卡住的一次排查</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/03</span>
            <a class="archive-post-title" href="/2023/11/03/non-root-containers/">[持续更新] - 容器非 root 启动改造的经验</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/20</span>
            <a class="archive-post-title" href="/2023/10/20/pve7-to-8-hang-on-start/">proxmox 7.4 升级8 后开机卡在 Loading kernel 6.2.16-15</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/18</span>
            <a class="archive-post-title" href="/2023/08/18/kubernetes-nfs-waiting-condition/">k8s 使用 nfs 下 pod 无法创建的解决思路</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/08</span>
            <a class="archive-post-title" href="/2023/08/08/qemu-cgo-build-hang/">qemu-user-static 下 cgo go build 卡住的一次解决</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/13</span>
            <a class="archive-post-title" href="/2023/07/13/k8s-externalIPs/">为什么ipvs下externalIPs乱设置会崩</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/22</span>
            <a class="archive-post-title" href="/2023/05/22/pod-resolve/">pod 的 /etc/resolv.conf 生成机制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/12</span>
            <a class="archive-post-title" href="/2023/04/12/docker-pull-hang/">国产系统上解决docker pull卡住的问题</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/07</span>
            <a class="archive-post-title" href="/2023/03/07/qemu-binfmt_misc/">利用 qemu user 模式和 binfmt_misc 构建其他架构的 docker 镜像</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/14</span>
            <a class="archive-post-title" href="/2023/02/14/openstack-vm-rabbitmqctl/">openstack 虚机上 rabbitmqctl 超时</a>
        </li>
                </ul>
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/30</span>
            <a class="archive-post-title" href="/2022/12/30/k8s-java-request-cpu/">k8s java 容器未设置 requests.cpu 导致性能问题</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/03</span>
            <a class="archive-post-title" href="/2022/11/03/pyinstaller-supervisor/">如何打包一个不依赖 python 的 supervisor 的包去离线部署</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/09</span>
            <a class="archive-post-title" href="/2022/10/09/docker-containerd-panic/">磁盘问题宕机后 docker 的 containerd 无法启动</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/07</span>
            <a class="archive-post-title" href="/2022/09/07/docker-veth-not-clean/">低版本docker veth没清理造成容器网络问题</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/28</span>
            <a class="archive-post-title" href="/2022/07/28/redhat84-vxlan-esxi/">exsi 使用 redhat8.4 搭建k8s集群，flannel vxlan 模式的不正常排错</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/12</span>
            <a class="archive-post-title" href="/2022/07/12/pod-no-ip-addr/">k8s pod 没有 IP ，报错 failed to read pod IP from plugin/docker</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span>
            <a class="archive-post-title" href="/2022/06/03/container-not-forward/">docker info无warning，iptables规则正常，宿主机就是不转发</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/13</span>
            <a class="archive-post-title" href="/2022/05/13/overlayfs-unix-socket/">低版本内核下容器内部无法使用 unix socket 通信</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/23</span>
            <a class="archive-post-title" href="/2022/04/23/nfc/">nfc 折腾笔记，ACR122U/proxmark3</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/22</span>
            <a class="archive-post-title" href="/2022/04/22/segfault-often/">docker containerd 不定时的 segfault 的一次处理过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2022/04/21/ecs-xmrig/">ecs 中毒的一次处理过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/2022/04/11/sdn-tcp-keepalive/">无数据的 tcp 链接被 SDN/防火墙 干掉的一种处理办法</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/24</span>
            <a class="archive-post-title" href="/2022/03/24/python-list-kubernetes-permission/">python kubernetes client list permission</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/17</span>
            <a class="archive-post-title" href="/2022/03/17/woff2/">ttf转woff工具谷歌woff2的静态编译</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2022/03/16/cannot-assign-requested-address/">server 端的 cannot assign requested address</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/24</span>
            <a class="archive-post-title" href="/2022/02/24/keepalived-static-build/">keepalived static link build</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/18</span>
            <a class="archive-post-title" href="/2022/02/18/proxmox-boot-disk-lvmid-not-found/">proxmox 开机 error: disk 'lvmid/[vg uuid]/[lv uuid]' not found</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/10</span>
            <a class="archive-post-title" href="/2022/02/10/docker-daemon-layer-broken/">18.09.03 docker daemon layer broken 的一次不优雅处理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/26</span>
            <a class="archive-post-title" href="/2022/01/26/nginx-static-build/">利用 docker buildx 静态编译 nginx</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/22</span>
            <a class="archive-post-title" href="/2022/01/22/EmuELEC/">EmuELEC 笔记</a>
        </li>
                </ul>
            <div class="archive-year"> 2021 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/19</span>
            <a class="archive-post-title" href="/2021/12/19/openwrt-update/">openwrt 的在线升级固件和扩容的研究</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/12</span>
            <a class="archive-post-title" href="/2021/12/12/mod-rejected-by-service/">docker数据盘损坏后启动报错 Error starting daemon: Error initializing network controller: Error creating default "bridge" network: package not installed</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/29</span>
            <a class="archive-post-title" href="/2021/10/29/kubelet-ephemeral-storage-loop-evicted/">1.15 kubelet 在 nodefs 容量富裕下循环 reclaim ephemeral-storage</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/28</span>
            <a class="archive-post-title" href="/2021/09/28/ipvs-svc/">在非容器环境上实现散装的 IPVS SVC</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/16</span>
            <a class="archive-post-title" href="/2021/09/16/read-containerd-con-reset/">解决 docker 的 read unix @->/run/containerd/s/xxx read: connection reset by peer: unknown</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/03</span>
            <a class="archive-post-title" href="/2021/09/03/openwrt-usb-net/">[持续更新] - Openwrt USB 网络</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/02</span>
            <a class="archive-post-title" href="/2021/09/02/fio/">fio 静态编译和基础使用</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/01</span>
            <a class="archive-post-title" href="/2021/09/01/ubuntu18-and-cfq/">ubuntu18下io调度算法是cfq导致mysql非常慢</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/27</span>
            <a class="archive-post-title" href="/2021/08/27/k8s-runxtables.lock/">干掉烦人的 open /run/xtables.lock: is a directory</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/25</span>
            <a class="archive-post-title" href="/2021/08/25/flannel-a-host-net-tmout/">flannel下集群有个节点网络不通的一次排查</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/24</span>
            <a class="archive-post-title" href="/2021/08/24/cni-plugins-bridge-err/">一次 cni-plugins 导致集群 dns 无法解析的排错</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/16</span>
            <a class="archive-post-title" href="/2021/08/16/reserve-compute-resources/">kubelet 为系统配置预留资源</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/26</span>
            <a class="archive-post-title" href="/2021/07/26/kylin-v10-boot-hang/">鲲鹏920的麒麟v10物理服务器断电后无法启动处理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/20</span>
            <a class="archive-post-title" href="/2021/07/20/dlv-remote/">dlv命令行的远程调试 golang 进程步骤(包含容器进程)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/16</span>
            <a class="archive-post-title" href="/2021/07/16/consul-mips64le/">编译mips64le架构的consul</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/06</span>
            <a class="archive-post-title" href="/2021/07/06/kube-apiserver-cannot-start-after-reboot/">机器重启后 kube-apiserver 无法启动，etcd刷(error "EOF", ServerName "")</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/05</span>
            <a class="archive-post-title" href="/2021/07/05/systemctl-start-docker-canceled/">Job for docker.service canceled</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/08</span>
            <a class="archive-post-title" href="/2021/06/08/ocp4.5.9-restore-etcd/">openshift 4.5.9 etcd损坏+脑裂修复过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/26</span>
            <a class="archive-post-title" href="/2021/05/26/docker-panic-invalid-freelist-page/">docker-ce 18.09.3 启动panic: invalid freelist page: 56, page type is leaf的解决处理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/30</span>
            <a class="archive-post-title" href="/2021/04/30/kubernetes-sec-agent-node-network-error/">一次单节点单个pod网络问题排查过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/08</span>
            <a class="archive-post-title" href="/2021/04/08/kubelet-runc-disable-kmem/">kubelet 和 runc 编译关闭 kmem</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/23</span>
            <a class="archive-post-title" href="/2021/03/23/iptables-docker-no-chain/">iptables --wait -t nat -A DOCKER...: iptables NO chain/target/match by that name</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/22</span>
            <a class="archive-post-title" href="/2021/03/22/jsonpatch-doc-is-missing-path/">Internal error occurred: jsonpatch add operation does not apply: doc is missing path: xxx</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/12</span>
            <a class="archive-post-title" href="/2021/03/12/build-arm64-docker-compose-action/">使用github action 配合 docker buildx 编译 arm64 docker-compose</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/02</span>
            <a class="archive-post-title" href="/2021/02/02/node-shutdown-dns-unavailable/">集群节点关机导致dns在eviction pod之前几率不可用</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/24</span>
            <a class="archive-post-title" href="/2021/01/24/e2fsprogs/">e2fsck 太老报错 has unsupported feature(s): metadata_csum，从而尝试静态编译</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span>
            <a class="archive-post-title" href="/2021/01/23/chrony/">chrony 静态编译和笔记</a>
        </li>
                </ul>
            <div class="archive-year"> 2020 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/04</span>
            <a class="archive-post-title" href="/2020/12/04/docker1803-hang-container-restore/">docker18.03 hang at 'restoring container'</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/23</span>
            <a class="archive-post-title" href="/2020/11/23/ansible-reload-user/">ansible reload user group</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/23</span>
            <a class="archive-post-title" href="/2020/11/23/ansible-hang-in-docker/">ansible hang in docker container</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/20</span>
            <a class="archive-post-title" href="/2020/11/20/disable-swap/">永久关闭swap的正确姿势</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/06</span>
            <a class="archive-post-title" href="/2020/11/06/kylin-arm-clone-vxlan-error/">银河麒麟arm64系统克隆机器上k8s vxlan跨节点不通的一次排查</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/30</span>
            <a class="archive-post-title" href="/2020/10/30/uos20-nftables/">统信USO 20 hostPort 无法访问</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/20</span>
            <a class="archive-post-title" href="/2020/10/20/kylin-v10-k8s-overlay-error/">银河麒麟arm64系统上k8s集群跨节点不通的一次排查</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/18</span>
            <a class="archive-post-title" href="/2020/09/18/ocp-4.5-install/">openshift 4.5.9 离线安装</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/27</span>
            <a class="archive-post-title" href="/2020/08/27/skopeo-static-build/">skopeo 静态编译</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/05</span>
            <a class="archive-post-title" href="/2020/08/05/wireguard-for-personal/">个人用 wireguard 笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/30</span>
            <a class="archive-post-title" href="/2020/07/30/prometheus-rate-and-irate/">prometheus的rate与irate内部是如何计算的</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/23</span>
            <a class="archive-post-title" href="/2020/07/23/fs-error-fix-k8s-master/">k8s master机器文件系统故障的一次恢复过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/05</span>
            <a class="archive-post-title" href="/2020/07/05/linux-auditd/">Linux audit 审计</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/25</span>
            <a class="archive-post-title" href="/2020/06/25/kubernetes-pprof/">k8s pprof 分析 cpu 和内存</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span>
            <a class="archive-post-title" href="/2020/06/23/host-gw-in-aliyun/">阿里云上使用flannel host-gw跨节点pod不通的解决</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/19</span>
            <a class="archive-post-title" href="/2020/06/19/go-prom-exporter/">[未写完]使用go开发一个Prometheus的exporter</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/23</span>
            <a class="archive-post-title" href="/2020/05/23/k8s-vxlan-63-timeout/">v1.17+ k8s集群下CNI使用VXLAN模式SVC有63秒延迟的触发原因定位</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/13</span>
            <a class="archive-post-title" href="/2020/05/13/x86-router-flash/">proxmox x86软路由笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span>
            <a class="archive-post-title" href="/2020/05/12/dns-formerr/">adguardhome dns FORMERR 错误</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span>
            <a class="archive-post-title" href="/2020/05/12/N1-flash/">斐讯N1刷机和旁路由的设置</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/27</span>
            <a class="archive-post-title" href="/2020/04/27/go-version-ifno/">git工作流下golang项目的version信息该如何处理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/03</span>
            <a class="archive-post-title" href="/2020/04/03/kubernetes-admission-controllers/">编写一个动态准入控制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/26</span>
            <a class="archive-post-title" href="/2020/03/26/KubeXXXMismatch/">一次deploy,rs,sts Mismatch 的处理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/10</span>
            <a class="archive-post-title" href="/2020/03/10/go-mod-base-use/">go mod的基础使用-科普</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span>
            <a class="archive-post-title" href="/2020/03/02/centos6-hung-while-booting/">centos6中毒重启后卡在启动页面</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span>
            <a class="archive-post-title" href="/2020/03/02/binfmt-0000/">记录一次request_module: runaway loop modeprobe binfmt-0000</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/27</span>
            <a class="archive-post-title" href="/2020/02/27/microsoft-graph-for-onedrive/">使用microsoft-graph的api对接onedrive</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/15</span>
            <a class="archive-post-title" href="/2020/01/15/kill-ctr-with-grace-period/">Killing container "docker://xxx with 30 second grace period</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/08</span>
            <a class="archive-post-title" href="/2020/01/08/docker-panic-invalid-page-type/">docker-18.06.3-ce启动panic: invalid page type: 0: 0的解决处理</a>
        </li>
                </ul>
            <div class="archive-year"> 2019 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span>
            <a class="archive-post-title" href="/2019/12/05/suse-fix-data-but-device-busy/">opensuse的一次救援</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/03</span>
            <a class="archive-post-title" href="/2019/12/03/dos-to-gpt/">从PTTYPE="dos"到TYPE="LVM2_member"的救援</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/24</span>
            <a class="archive-post-title" href="/2019/11/24/kubeadm-base-use/">[长期更新]--应大多数人要求写下kubeadm的基础使用</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/24</span>
            <a class="archive-post-title" href="/2019/10/24/deployment-consul-in-k8s/">consul仅当服务发现在k8s无状态部署使用</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/21</span>
            <a class="archive-post-title" href="/2019/10/21/k8s-v1.14-v1.15-fix-issue/">手动修复v1.14-v1.15版本k8s的issue:76956</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/12</span>
            <a class="archive-post-title" href="/2019/10/12/boot-grub-rescue/">/boot目录被清空下物理机无法开机的一次救援</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/11</span>
            <a class="archive-post-title" href="/2019/10/11/ansible-count-Idempotency/">ansible数量限制上的幂等性</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/27</span>
            <a class="archive-post-title" href="/2019/09/27/consul-tls/">高可用的SSL consul cluster实践</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span>
            <a class="archive-post-title" href="/2019/09/05/prometheus-change-timezone/">修改源码更改prometheus的时区问题</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/24</span>
            <a class="archive-post-title" href="/2019/08/24/gobot-build/">gobot控制esp8266</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/06</span>
            <a class="archive-post-title" href="/2019/08/06/preseed/">ubuntu preseed无人应答安装</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/14</span>
            <a class="archive-post-title" href="/2019/07/14/chromedp/">golang headless browser包chromedp初探</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span>
            <a class="archive-post-title" href="/2019/07/08/nodeport-err/">为什么我不用nodePort之偶然中奖几率</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/07</span>
            <a class="archive-post-title" href="/2019/07/07/golang-http/">golang的net/http包的客户端简单科普</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/26</span>
            <a class="archive-post-title" href="/2019/06/26/uefi-pxe/">uefi模式下docker+交换机部署pxe批量安装</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/23</span>
            <a class="archive-post-title" href="/2019/06/23/autoInstallServer/">拟定excel表格服务器自动按照表格配置信息和安装的实现过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/12</span>
            <a class="archive-post-title" href="/2019/06/12/CLP/">SMASH CLP的一些笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span>
            <a class="archive-post-title" href="/2019/06/02/cobra/">golang cobra的一些笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/11</span>
            <a class="archive-post-title" href="/2019/05/11/container-too-many-open-file/">standard_init_linux.go:211: exec user process caused "too many open files in system"</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/28</span>
            <a class="archive-post-title" href="/2019/04/28/k8s-java-start-time-not-same/">闲谈线上俩k8s环境同等limits下pod启动时间不一样解决过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/22</span>
            <a class="archive-post-title" href="/2019/03/22/k8s-controller-error/">一次kube-controller-manager的bug导致的线上无法调度处理过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span>
            <a class="archive-post-title" href="/2019/03/15/flannel-bin/">不走etcd v2 api下二进制跑flannel的总结</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/11</span>
            <a class="archive-post-title" href="/2019/03/11/k8s-ha/">k8s高可用涉及到ip填写的相关配置和一些坑</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/03</span>
            <a class="archive-post-title" href="/2019/03/03/kubernetes-1-13-4/">二进制部署Kubernetes v1.13.12 HA可选</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span>
            <a class="archive-post-title" href="/2019/02/19/jira-confluence/">docker部署jira(8.0.0)和confluence(6.14.1)</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span>
            <a class="archive-post-title" href="/2019/02/12/dashboard/">通用的dashboard部署和tls，SSL相关部署</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span>
            <a class="archive-post-title" href="/2019/01/30/fstab/">fstab与systemd.mount自动挂载的一点研究和见解</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/22</span>
            <a class="archive-post-title" href="/2019/01/22/proxmox-cloud-init/">proxmox里使用cloud-init和一些笔记</a>
        </li>
                </ul>
            <div class="archive-year"> 2018 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/04</span>
            <a class="archive-post-title" href="/2018/12/04/black-box-exporter/">prometheus的黑盒监控</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/24</span>
            <a class="archive-post-title" href="/2018/11/24/how-to-use-kubeadm/">对于初入k8s和kubeadm的一些建议</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/06</span>
            <a class="archive-post-title" href="/2018/11/06/onlyoffice/">一次docker镜像的解耦--onlyoffice</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">11/05</span>
            <a class="archive-post-title" href="/2018/11/05/10chars/">记录一次十字符病毒清理过程</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/27</span>
            <a class="archive-post-title" href="/2018/10/27/create-kubeconfig/">生成kubeconfig常规的两种方法</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/12</span>
            <a class="archive-post-title" href="/2018/10/12/prometheus-operator/">全手动部署prometheus-operator监控K8S集群以及一些坑</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/06</span>
            <a class="archive-post-title" href="/2018/10/06/IngressController/">IngressController使用和它的高可用落地</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/24</span>
            <a class="archive-post-title" href="/2018/09/24/k8s-some-vpc-cluster/">跨VPC或者跨云供应商搭建K8S集群正确姿势</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">09/18</span>
            <a class="archive-post-title" href="/2018/09/18/kubernetes-1-11-x-bin/">二进制部署Kubernetes v1.11.x(1.12.x) HA可选</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/03</span>
            <a class="archive-post-title" href="/2018/08/03/Kubernetes_install_1.11.1/">Kubernetes v1.11.x HA全手动苦工安装教学</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/18</span>
            <a class="archive-post-title" href="/2018/07/18/ecs-vip/">基于openstack的ecs上使用VIP</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/08</span>
            <a class="archive-post-title" href="/2018/07/08/travis-sync-gcr-io/">利用travis同步gcr.io镜像到dockerhub</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/25</span>
            <a class="archive-post-title" href="/2018/06/25/etcd-error/">记录一次线上k8s节点故障</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span>
            <a class="archive-post-title" href="/2018/06/03/kubernetes-s-job/">kubernetes's Job总结和实战以及坑</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span>
            <a class="archive-post-title" href="/2018/06/02/kubernetes-nodeSelector/">kubernetes的PodAffinity的不解</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/05</span>
            <a class="archive-post-title" href="/2018/05/05/Kubernetes_install/">[转载+修正]Kubernetes v1.10.x HA全手动苦工安装教学</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/29</span>
            <a class="archive-post-title" href="/2018/04/29/kubernetes-configMap-mount/">kubernetes的configMap文件挂载不同的路径且不覆盖目录的解决方法</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/18</span>
            <a class="archive-post-title" href="/2018/03/18/keepalived-Heartbeat-use-mg-net/">使用管理网当作业务网keepalived VIP的心跳线</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span>
            <a class="archive-post-title" href="/2018/02/15/linux-tc/">Linux tc基础使用</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span>
            <a class="archive-post-title" href="/2018/02/05/docker-image-can-t-rm/">docker无法删除掉镜像的解决方法</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/20</span>
            <a class="archive-post-title" href="/2018/01/20/docker-rm%E7%9A%84%E6%B3%A8%E6%84%8F%E7%82%B9/">慎用docker的--rm选项!!!</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/10</span>
            <a class="archive-post-title" href="/2018/01/10/docker%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5/">docker的一些概念</a>
        </li>
                </ul>
            <div class="archive-year"> 2017 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">12/24</span>
            <a class="archive-post-title" href="/2017/12/24/docker%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%AE%BF%E4%B8%BB%E6%9C%BA/">docker容器访问宿主机</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">12/23</span>
            <a class="archive-post-title" href="/2017/12/23/docker%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%E4%BA%92%E8%81%94/">docker容器网络互联</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">08/03</span>
            <a class="archive-post-title" href="/2017/08/03/iptables-whitelist/">Linux 上 iptables ipset 白名单</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/25</span>
            <a class="archive-post-title" href="/2017/07/25/linux-bridge/">centos桥接测试</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/15</span>
            <a class="archive-post-title" href="/2017/07/15/dd-make-boot-device/">使用 dd 利用 iso 文件制作 USB 启动盘</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/06</span>
            <a class="archive-post-title" href="/2017/07/06/windows/">windows 笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">07/05</span>
            <a class="archive-post-title" href="/2017/07/05/centos7-some-mirror/">centos7 的一些常见软件的安装 mirror</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/26</span>
            <a class="archive-post-title" href="/2017/06/26/lua-list-all-upsteam/">lua列出所有upsteam</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">06/03</span>
            <a class="archive-post-title" href="/2017/06/03/bash-complete/">bash自定义补全</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/25</span>
            <a class="archive-post-title" href="/2017/05/25/shell-opts/">shell脚本的选项和参数处理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/15</span>
            <a class="archive-post-title" href="/2017/05/15/rpmbuild/">rpm包的制作笔记</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span>
            <a class="archive-post-title" href="/2017/05/12/ssh-trust/">ssh互信</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">05/06</span>
            <a class="archive-post-title" href="/2017/05/06/shell%E5%BF%AB%E6%8D%B7%E9%94%AE%E6%8F%90%E5%8D%87%E6%95%88%E7%8E%87/">shell利用快捷键提升命令输入和编辑</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/29</span>
            <a class="archive-post-title" href="/2017/04/29/zabbixsetup/">个人zabbix安装和坑的解决</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/26</span>
            <a class="archive-post-title" href="/2017/04/26/%E6%AD%A3%E5%88%99%E9%9B%B6%E5%AE%BD%E6%96%AD%E8%A8%80%E7%9A%84%E4%B8%80%E4%B8%AA%E6%B3%A8%E6%84%8F%E7%82%B9/">正则零宽断言的一个注意点</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/25</span>
            <a class="archive-post-title" href="/2017/04/25/%E8%BD%AC%E8%BD%BD-awk%E4%B8%ADRS-OFS-RS-ORS%E5%8C%BA%E5%88%AB%E4%BA%8E%E8%81%94%E7%B3%BB/">[转载]awk中RS,ORS,FS,OFS区别于联系</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/20</span>
            <a class="archive-post-title" href="/2017/04/20/lvm-practice/">记录LVM和raid的练习</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/20</span>
            <a class="archive-post-title" href="/2017/04/20/linux-partition-grow/">虚拟化扩容硬盘大小</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span>
            <a class="archive-post-title" href="/2017/04/17/iot/">分享下自己做的外网控制硬件</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span>
            <a class="archive-post-title" href="/2017/04/15/shell_process/">shell多进程并发执行</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span>
            <a class="archive-post-title" href="/2017/04/15/shellsubstring/">shell的字符串截取</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/2017/04/11/8266hexdownload/">8266模块的烧写和sdk的坑</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/09</span>
            <a class="archive-post-title" href="/2017/04/09/armlnmp/">安卓安装linux并且源码编译安装搭建lnmp的坑和总结</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/03</span>
            <a class="archive-post-title" href="/2017/04/03/bond/">centos配置bond</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/28</span>
            <a class="archive-post-title" href="/2017/03/28/zombie-process/">Linux 僵尸进程处理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/23</span>
            <a class="archive-post-title" href="/2017/03/23/check-dhcp-or-static/">判断是否是 dhcp 获取ip的一个手段</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/20</span>
            <a class="archive-post-title" href="/2017/03/20/ftp-install/">vsftpd虚拟用户简单部署</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span>
            <a class="archive-post-title" href="/2017/03/15/lnmp/">源码编译安装lnmp</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/26</span>
            <a class="archive-post-title" href="/2017/02/26/ad/">Altium Designer里走线开窗和挖除铺铜还有一些技巧</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/12</span>
            <a class="archive-post-title" href="/2017/02/12/wx00/">微信公众号接入自己服务器</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/02</span>
            <a class="archive-post-title" href="/2017/02/02/lamp/">lamp环境搭建总结</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/08</span>
            <a class="archive-post-title" href="/2017/01/08/tuling-wx/">微信公众号接入图灵机器人api</a>
        </li>
                </ul>
            <div class="archive-year"> 2016 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/13</span>
            <a class="archive-post-title" href="/2016/11/13/cad/">cad</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/30</span>
            <a class="archive-post-title" href="/2016/10/30/20161030/">记录下自己制作的led-vu</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">10/28</span>
            <a class="archive-post-title" href="/2016/10/28/hello/">hello world</a>
        </li>
            </ul>
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
            <span class="sidebar-tag-name" data-tags="diy">
                <span class="iconfont-archer">&#xe606;</span>
                diy
            </span>
            <span class="sidebar-tag-name" data-tags="8266">
                <span class="iconfont-archer">&#xe606;</span>
                8266
            </span>
            <span class="sidebar-tag-name" data-tags="总结">
                <span class="iconfont-archer">&#xe606;</span>
                总结
            </span>
            <span class="sidebar-tag-name" data-tags="ipmi">
                <span class="iconfont-archer">&#xe606;</span>
                ipmi
            </span>
            <span class="sidebar-tag-name" data-tags="CLP">
                <span class="iconfont-archer">&#xe606;</span>
                CLP
            </span>
            <span class="sidebar-tag-name" data-tags="EmuELEC">
                <span class="iconfont-archer">&#xe606;</span>
                EmuELEC
            </span>
            <span class="sidebar-tag-name" data-tags="linux">
                <span class="iconfont-archer">&#xe606;</span>
                linux
            </span>
            <span class="sidebar-tag-name" data-tags="k8s">
                <span class="iconfont-archer">&#xe606;</span>
                k8s
            </span>
            <span class="sidebar-tag-name" data-tags="Mismatch">
                <span class="iconfont-archer">&#xe606;</span>
                Mismatch
            </span>
            <span class="sidebar-tag-name" data-tags="ingress">
                <span class="iconfont-archer">&#xe606;</span>
                ingress
            </span>
            <span class="sidebar-tag-name" data-tags="android">
                <span class="iconfont-archer">&#xe606;</span>
                android
            </span>
            <span class="sidebar-tag-name" data-tags="Altium Designer">
                <span class="iconfont-archer">&#xe606;</span>
                Altium Designer
            </span>
            <span class="sidebar-tag-name" data-tags="N1">
                <span class="iconfont-archer">&#xe606;</span>
                N1
            </span>
            <span class="sidebar-tag-name" data-tags="openwrt">
                <span class="iconfont-archer">&#xe606;</span>
                openwrt
            </span>
            <span class="sidebar-tag-name" data-tags="etcd">
                <span class="iconfont-archer">&#xe606;</span>
                etcd
            </span>
            <span class="sidebar-tag-name" data-tags="ssl">
                <span class="iconfont-archer">&#xe606;</span>
                ssl
            </span>
            <span class="sidebar-tag-name" data-tags="aliyun">
                <span class="iconfont-archer">&#xe606;</span>
                aliyun
            </span>
            <span class="sidebar-tag-name" data-tags="tun2sock2">
                <span class="iconfont-archer">&#xe606;</span>
                tun2sock2
            </span>
            <span class="sidebar-tag-name" data-tags="ansible">
                <span class="iconfont-archer">&#xe606;</span>
                ansible
            </span>
            <span class="sidebar-tag-name" data-tags="consul">
                <span class="iconfont-archer">&#xe606;</span>
                consul
            </span>
            <span class="sidebar-tag-name" data-tags="docker">
                <span class="iconfont-archer">&#xe606;</span>
                docker
            </span>
            <span class="sidebar-tag-name" data-tags="lnmp">
                <span class="iconfont-archer">&#xe606;</span>
                lnmp
            </span>
            <span class="sidebar-tag-name" data-tags="安卓">
                <span class="iconfont-archer">&#xe606;</span>
                安卓
            </span>
            <span class="sidebar-tag-name" data-tags="initrd">
                <span class="iconfont-archer">&#xe606;</span>
                initrd
            </span>
            <span class="sidebar-tag-name" data-tags="grub">
                <span class="iconfont-archer">&#xe606;</span>
                grub
            </span>
            <span class="sidebar-tag-name" data-tags="raid">
                <span class="iconfont-archer">&#xe606;</span>
                raid
            </span>
            <span class="sidebar-tag-name" data-tags="Linux">
                <span class="iconfont-archer">&#xe606;</span>
                Linux
            </span>
            <span class="sidebar-tag-name" data-tags="kernel">
                <span class="iconfont-archer">&#xe606;</span>
                kernel
            </span>
            <span class="sidebar-tag-name" data-tags="prometheus">
                <span class="iconfont-archer">&#xe606;</span>
                prometheus
            </span>
            <span class="sidebar-tag-name" data-tags="exporter">
                <span class="iconfont-archer">&#xe606;</span>
                exporter
            </span>
            <span class="sidebar-tag-name" data-tags="boot">
                <span class="iconfont-archer">&#xe606;</span>
                boot
            </span>
            <span class="sidebar-tag-name" data-tags="tcp">
                <span class="iconfont-archer">&#xe606;</span>
                tcp
            </span>
            <span class="sidebar-tag-name" data-tags="golang">
                <span class="iconfont-archer">&#xe606;</span>
                golang
            </span>
            <span class="sidebar-tag-name" data-tags="cad">
                <span class="iconfont-archer">&#xe606;</span>
                cad
            </span>
            <span class="sidebar-tag-name" data-tags="centos6">
                <span class="iconfont-archer">&#xe606;</span>
                centos6
            </span>
            <span class="sidebar-tag-name" data-tags="podman">
                <span class="iconfont-archer">&#xe606;</span>
                podman
            </span>
            <span class="sidebar-tag-name" data-tags="centos">
                <span class="iconfont-archer">&#xe606;</span>
                centos
            </span>
            <span class="sidebar-tag-name" data-tags="chromedp">
                <span class="iconfont-archer">&#xe606;</span>
                chromedp
            </span>
            <span class="sidebar-tag-name" data-tags="chrony">
                <span class="iconfont-archer">&#xe606;</span>
                chrony
            </span>
            <span class="sidebar-tag-name" data-tags="cobra">
                <span class="iconfont-archer">&#xe606;</span>
                cobra
            </span>
            <span class="sidebar-tag-name" data-tags="kubernetes">
                <span class="iconfont-archer">&#xe606;</span>
                kubernetes
            </span>
            <span class="sidebar-tag-name" data-tags="cni-plugins">
                <span class="iconfont-archer">&#xe606;</span>
                cni-plugins
            </span>
            <span class="sidebar-tag-name" data-tags="mips64le">
                <span class="iconfont-archer">&#xe606;</span>
                mips64le
            </span>
            <span class="sidebar-tag-name" data-tags="clickhouse">
                <span class="iconfont-archer">&#xe606;</span>
                clickhouse
            </span>
            <span class="sidebar-tag-name" data-tags="arm64">
                <span class="iconfont-archer">&#xe606;</span>
                arm64
            </span>
            <span class="sidebar-tag-name" data-tags="kernal">
                <span class="iconfont-archer">&#xe606;</span>
                kernal
            </span>
            <span class="sidebar-tag-name" data-tags="kubeconfig">
                <span class="iconfont-archer">&#xe606;</span>
                kubeconfig
            </span>
            <span class="sidebar-tag-name" data-tags="cri-dockerd">
                <span class="iconfont-archer">&#xe606;</span>
                cri-dockerd
            </span>
            <span class="sidebar-tag-name" data-tags="swap">
                <span class="iconfont-archer">&#xe606;</span>
                swap
            </span>
            <span class="sidebar-tag-name" data-tags="adguardhome">
                <span class="iconfont-archer">&#xe606;</span>
                adguardhome
            </span>
            <span class="sidebar-tag-name" data-tags="dns">
                <span class="iconfont-archer">&#xe606;</span>
                dns
            </span>
            <span class="sidebar-tag-name" data-tags="dlv">
                <span class="iconfont-archer">&#xe606;</span>
                dlv
            </span>
            <span class="sidebar-tag-name" data-tags="apparmor">
                <span class="iconfont-archer">&#xe606;</span>
                apparmor
            </span>
            <span class="sidebar-tag-name" data-tags="containerd">
                <span class="iconfont-archer">&#xe606;</span>
                containerd
            </span>
            <span class="sidebar-tag-name" data-tags="panic">
                <span class="iconfont-archer">&#xe606;</span>
                panic
            </span>
            <span class="sidebar-tag-name" data-tags="net">
                <span class="iconfont-archer">&#xe606;</span>
                net
            </span>
            <span class="sidebar-tag-name" data-tags="Dockerfile">
                <span class="iconfont-archer">&#xe606;</span>
                Dockerfile
            </span>
            <span class="sidebar-tag-name" data-tags="veth">
                <span class="iconfont-archer">&#xe606;</span>
                veth
            </span>
            <span class="sidebar-tag-name" data-tags="hang">
                <span class="iconfont-archer">&#xe606;</span>
                hang
            </span>
            <span class="sidebar-tag-name" data-tags="e2fsck">
                <span class="iconfont-archer">&#xe606;</span>
                e2fsck
            </span>
            <span class="sidebar-tag-name" data-tags="fsck">
                <span class="iconfont-archer">&#xe606;</span>
                fsck
            </span>
            <span class="sidebar-tag-name" data-tags="keepavlied">
                <span class="iconfont-archer">&#xe606;</span>
                keepavlied
            </span>
            <span class="sidebar-tag-name" data-tags="ecs">
                <span class="iconfont-archer">&#xe606;</span>
                ecs
            </span>
            <span class="sidebar-tag-name" data-tags="xmrig">
                <span class="iconfont-archer">&#xe606;</span>
                xmrig
            </span>
            <span class="sidebar-tag-name" data-tags="flannel">
                <span class="iconfont-archer">&#xe606;</span>
                flannel
            </span>
            <span class="sidebar-tag-name" data-tags="fio">
                <span class="iconfont-archer">&#xe606;</span>
                fio
            </span>
            <span class="sidebar-tag-name" data-tags="vxlan">
                <span class="iconfont-archer">&#xe606;</span>
                vxlan
            </span>
            <span class="sidebar-tag-name" data-tags="ftp">
                <span class="iconfont-archer">&#xe606;</span>
                ftp
            </span>
            <span class="sidebar-tag-name" data-tags="cifs">
                <span class="iconfont-archer">&#xe606;</span>
                cifs
            </span>
            <span class="sidebar-tag-name" data-tags="go mod">
                <span class="iconfont-archer">&#xe606;</span>
                go mod
            </span>
            <span class="sidebar-tag-name" data-tags="go">
                <span class="iconfont-archer">&#xe606;</span>
                go
            </span>
            <span class="sidebar-tag-name" data-tags="gobot">
                <span class="iconfont-archer">&#xe606;</span>
                gobot
            </span>
            <span class="sidebar-tag-name" data-tags="esp8266">
                <span class="iconfont-archer">&#xe606;</span>
                esp8266
            </span>
            <span class="sidebar-tag-name" data-tags="http">
                <span class="iconfont-archer">&#xe606;</span>
                http
            </span>
            <span class="sidebar-tag-name" data-tags="gitlab">
                <span class="iconfont-archer">&#xe606;</span>
                gitlab
            </span>
            <span class="sidebar-tag-name" data-tags="subgroup">
                <span class="iconfont-archer">&#xe606;</span>
                subgroup
            </span>
            <span class="sidebar-tag-name" data-tags="hello world">
                <span class="iconfont-archer">&#xe606;</span>
                hello world
            </span>
            <span class="sidebar-tag-name" data-tags="headscale">
                <span class="iconfont-archer">&#xe606;</span>
                headscale
            </span>
            <span class="sidebar-tag-name" data-tags="derper">
                <span class="iconfont-archer">&#xe606;</span>
                derper
            </span>
            <span class="sidebar-tag-name" data-tags="host-gw">
                <span class="iconfont-archer">&#xe606;</span>
                host-gw
            </span>
            <span class="sidebar-tag-name" data-tags="hostPort">
                <span class="iconfont-archer">&#xe606;</span>
                hostPort
            </span>
            <span class="sidebar-tag-name" data-tags="iptables">
                <span class="iconfont-archer">&#xe606;</span>
                iptables
            </span>
            <span class="sidebar-tag-name" data-tags="ipset">
                <span class="iconfont-archer">&#xe606;</span>
                ipset
            </span>
            <span class="sidebar-tag-name" data-tags="inotifywait">
                <span class="iconfont-archer">&#xe606;</span>
                inotifywait
            </span>
            <span class="sidebar-tag-name" data-tags="confd">
                <span class="iconfont-archer">&#xe606;</span>
                confd
            </span>
            <span class="sidebar-tag-name" data-tags="mqtt">
                <span class="iconfont-archer">&#xe606;</span>
                mqtt
            </span>
            <span class="sidebar-tag-name" data-tags="原创">
                <span class="iconfont-archer">&#xe606;</span>
                原创
            </span>
            <span class="sidebar-tag-name" data-tags="jira">
                <span class="iconfont-archer">&#xe606;</span>
                jira
            </span>
            <span class="sidebar-tag-name" data-tags="confluence">
                <span class="iconfont-archer">&#xe606;</span>
                confluence
            </span>
            <span class="sidebar-tag-name" data-tags="lvs">
                <span class="iconfont-archer">&#xe606;</span>
                lvs
            </span>
            <span class="sidebar-tag-name" data-tags="ipvsadm">
                <span class="iconfont-archer">&#xe606;</span>
                ipvsadm
            </span>
            <span class="sidebar-tag-name" data-tags="kube-proxy">
                <span class="iconfont-archer">&#xe606;</span>
                kube-proxy
            </span>
            <span class="sidebar-tag-name" data-tags="nodeport">
                <span class="iconfont-archer">&#xe606;</span>
                nodeport
            </span>
            <span class="sidebar-tag-name" data-tags="kube-controller-manager">
                <span class="iconfont-archer">&#xe606;</span>
                kube-controller-manager
            </span>
            <span class="sidebar-tag-name" data-tags="externalIP">
                <span class="iconfont-archer">&#xe606;</span>
                externalIP
            </span>
            <span class="sidebar-tag-name" data-tags="hostname">
                <span class="iconfont-archer">&#xe606;</span>
                hostname
            </span>
            <span class="sidebar-tag-name" data-tags="ttf">
                <span class="iconfont-archer">&#xe606;</span>
                ttf
            </span>
            <span class="sidebar-tag-name" data-tags="woff">
                <span class="iconfont-archer">&#xe606;</span>
                woff
            </span>
            <span class="sidebar-tag-name" data-tags="java">
                <span class="iconfont-archer">&#xe606;</span>
                java
            </span>
            <span class="sidebar-tag-name" data-tags="springboot">
                <span class="iconfont-archer">&#xe606;</span>
                springboot
            </span>
            <span class="sidebar-tag-name" data-tags="63s">
                <span class="iconfont-archer">&#xe606;</span>
                63s
            </span>
            <span class="sidebar-tag-name" data-tags="timeout">
                <span class="iconfont-archer">&#xe606;</span>
                timeout
            </span>
            <span class="sidebar-tag-name" data-tags="vip">
                <span class="iconfont-archer">&#xe606;</span>
                vip
            </span>
            <span class="sidebar-tag-name" data-tags="keepalived">
                <span class="iconfont-archer">&#xe606;</span>
                keepalived
            </span>
            <span class="sidebar-tag-name" data-tags="fnctl">
                <span class="iconfont-archer">&#xe606;</span>
                fnctl
            </span>
            <span class="sidebar-tag-name" data-tags="kube-log-runner">
                <span class="iconfont-archer">&#xe606;</span>
                kube-log-runner
            </span>
            <span class="sidebar-tag-name" data-tags="logrotate">
                <span class="iconfont-archer">&#xe606;</span>
                logrotate
            </span>
            <span class="sidebar-tag-name" data-tags="kubelet">
                <span class="iconfont-archer">&#xe606;</span>
                kubelet
            </span>
            <span class="sidebar-tag-name" data-tags="kubeadm">
                <span class="iconfont-archer">&#xe606;</span>
                kubeadm
            </span>
            <span class="sidebar-tag-name" data-tags="operator">
                <span class="iconfont-archer">&#xe606;</span>
                operator
            </span>
            <span class="sidebar-tag-name" data-tags="ConfigMap">
                <span class="iconfont-archer">&#xe606;</span>
                ConfigMap
            </span>
            <span class="sidebar-tag-name" data-tags="PodAffinity">
                <span class="iconfont-archer">&#xe606;</span>
                PodAffinity
            </span>
            <span class="sidebar-tag-name" data-tags="nfs">
                <span class="iconfont-archer">&#xe606;</span>
                nfs
            </span>
            <span class="sidebar-tag-name" data-tags="hotplug">
                <span class="iconfont-archer">&#xe606;</span>
                hotplug
            </span>
            <span class="sidebar-tag-name" data-tags="kylin">
                <span class="iconfont-archer">&#xe606;</span>
                kylin
            </span>
            <span class="sidebar-tag-name" data-tags="systemd">
                <span class="iconfont-archer">&#xe606;</span>
                systemd
            </span>
            <span class="sidebar-tag-name" data-tags="Kylin">
                <span class="iconfont-archer">&#xe606;</span>
                Kylin
            </span>
            <span class="sidebar-tag-name" data-tags="lamp">
                <span class="iconfont-archer">&#xe606;</span>
                lamp
            </span>
            <span class="sidebar-tag-name" data-tags="audit">
                <span class="iconfont-archer">&#xe606;</span>
                audit
            </span>
            <span class="sidebar-tag-name" data-tags="fs">
                <span class="iconfont-archer">&#xe606;</span>
                fs
            </span>
            <span class="sidebar-tag-name" data-tags="nginx">
                <span class="iconfont-archer">&#xe606;</span>
                nginx
            </span>
            <span class="sidebar-tag-name" data-tags="microsoft">
                <span class="iconfont-archer">&#xe606;</span>
                microsoft
            </span>
            <span class="sidebar-tag-name" data-tags="graph">
                <span class="iconfont-archer">&#xe606;</span>
                graph
            </span>
            <span class="sidebar-tag-name" data-tags="onedrive">
                <span class="iconfont-archer">&#xe606;</span>
                onedrive
            </span>
            <span class="sidebar-tag-name" data-tags="nfc">
                <span class="iconfont-archer">&#xe606;</span>
                nfc
            </span>
            <span class="sidebar-tag-name" data-tags="pm3">
                <span class="iconfont-archer">&#xe606;</span>
                pm3
            </span>
            <span class="sidebar-tag-name" data-tags="non-root">
                <span class="iconfont-archer">&#xe606;</span>
                non-root
            </span>
            <span class="sidebar-tag-name" data-tags="containers">
                <span class="iconfont-archer">&#xe606;</span>
                containers
            </span>
            <span class="sidebar-tag-name" data-tags="coredns">
                <span class="iconfont-archer">&#xe606;</span>
                coredns
            </span>
            <span class="sidebar-tag-name" data-tags="gpu">
                <span class="iconfont-archer">&#xe606;</span>
                gpu
            </span>
            <span class="sidebar-tag-name" data-tags="nvidia">
                <span class="iconfont-archer">&#xe606;</span>
                nvidia
            </span>
            <span class="sidebar-tag-name" data-tags="openshift">
                <span class="iconfont-archer">&#xe606;</span>
                openshift
            </span>
            <span class="sidebar-tag-name" data-tags="ocp">
                <span class="iconfont-archer">&#xe606;</span>
                ocp
            </span>
            <span class="sidebar-tag-name" data-tags="openstack">
                <span class="iconfont-archer">&#xe606;</span>
                openstack
            </span>
            <span class="sidebar-tag-name" data-tags="squashfs">
                <span class="iconfont-archer">&#xe606;</span>
                squashfs
            </span>
            <span class="sidebar-tag-name" data-tags="usb-net">
                <span class="iconfont-archer">&#xe606;</span>
                usb-net
            </span>
            <span class="sidebar-tag-name" data-tags="overlay">
                <span class="iconfont-archer">&#xe606;</span>
                overlay
            </span>
            <span class="sidebar-tag-name" data-tags="/etc/resolv.conf">
                <span class="iconfont-archer">&#xe606;</span>
                /etc/resolv.conf
            </span>
            <span class="sidebar-tag-name" data-tags="pprof">
                <span class="iconfont-archer">&#xe606;</span>
                pprof
            </span>
            <span class="sidebar-tag-name" data-tags="timezone">
                <span class="iconfont-archer">&#xe606;</span>
                timezone
            </span>
            <span class="sidebar-tag-name" data-tags="Prometheus">
                <span class="iconfont-archer">&#xe606;</span>
                Prometheus
            </span>
            <span class="sidebar-tag-name" data-tags="cloud-init">
                <span class="iconfont-archer">&#xe606;</span>
                cloud-init
            </span>
            <span class="sidebar-tag-name" data-tags="supervisor">
                <span class="iconfont-archer">&#xe606;</span>
                supervisor
            </span>
            <span class="sidebar-tag-name" data-tags="pyinstaller">
                <span class="iconfont-archer">&#xe606;</span>
                pyinstaller
            </span>
            <span class="sidebar-tag-name" data-tags="python">
                <span class="iconfont-archer">&#xe606;</span>
                python
            </span>
            <span class="sidebar-tag-name" data-tags="preseed">
                <span class="iconfont-archer">&#xe606;</span>
                preseed
            </span>
            <span class="sidebar-tag-name" data-tags="proxmox">
                <span class="iconfont-archer">&#xe606;</span>
                proxmox
            </span>
            <span class="sidebar-tag-name" data-tags="grpc">
                <span class="iconfont-archer">&#xe606;</span>
                grpc
            </span>
            <span class="sidebar-tag-name" data-tags="qemu">
                <span class="iconfont-archer">&#xe606;</span>
                qemu
            </span>
            <span class="sidebar-tag-name" data-tags="binfmt_misc">
                <span class="iconfont-archer">&#xe606;</span>
                binfmt_misc
            </span>
            <span class="sidebar-tag-name" data-tags="loongarch64">
                <span class="iconfont-archer">&#xe606;</span>
                loongarch64
            </span>
            <span class="sidebar-tag-name" data-tags="cgo">
                <span class="iconfont-archer">&#xe606;</span>
                cgo
            </span>
            <span class="sidebar-tag-name" data-tags="redis">
                <span class="iconfont-archer">&#xe606;</span>
                redis
            </span>
            <span class="sidebar-tag-name" data-tags="exsi">
                <span class="iconfont-archer">&#xe606;</span>
                exsi
            </span>
            <span class="sidebar-tag-name" data-tags="redhat8.4">
                <span class="iconfont-archer">&#xe606;</span>
                redhat8.4
            </span>
            <span class="sidebar-tag-name" data-tags="rpm">
                <span class="iconfont-archer">&#xe606;</span>
                rpm
            </span>
            <span class="sidebar-tag-name" data-tags="rpmbuild">
                <span class="iconfont-archer">&#xe606;</span>
                rpmbuild
            </span>
            <span class="sidebar-tag-name" data-tags="salt">
                <span class="iconfont-archer">&#xe606;</span>
                salt
            </span>
            <span class="sidebar-tag-name" data-tags="salt-run">
                <span class="iconfont-archer">&#xe606;</span>
                salt-run
            </span>
            <span class="sidebar-tag-name" data-tags="ipv6">
                <span class="iconfont-archer">&#xe606;</span>
                ipv6
            </span>
            <span class="sidebar-tag-name" data-tags="vmware">
                <span class="iconfont-archer">&#xe606;</span>
                vmware
            </span>
            <span class="sidebar-tag-name" data-tags="hung">
                <span class="iconfont-archer">&#xe606;</span>
                hung
            </span>
            <span class="sidebar-tag-name" data-tags="keepalive">
                <span class="iconfont-archer">&#xe606;</span>
                keepalive
            </span>
            <span class="sidebar-tag-name" data-tags="serviceAccountToken">
                <span class="iconfont-archer">&#xe606;</span>
                serviceAccountToken
            </span>
            <span class="sidebar-tag-name" data-tags="bash">
                <span class="iconfont-archer">&#xe606;</span>
                bash
            </span>
            <span class="sidebar-tag-name" data-tags="shell">
                <span class="iconfont-archer">&#xe606;</span>
                shell
            </span>
            <span class="sidebar-tag-name" data-tags="segfault">
                <span class="iconfont-archer">&#xe606;</span>
                segfault
            </span>
            <span class="sidebar-tag-name" data-tags="skopeo">
                <span class="iconfont-archer">&#xe606;</span>
                skopeo
            </span>
            <span class="sidebar-tag-name" data-tags="boltdb">
                <span class="iconfont-archer">&#xe606;</span>
                boltdb
            </span>
            <span class="sidebar-tag-name" data-tags="ssh">
                <span class="iconfont-archer">&#xe606;</span>
                ssh
            </span>
            <span class="sidebar-tag-name" data-tags="suse">
                <span class="iconfont-archer">&#xe606;</span>
                suse
            </span>
            <span class="sidebar-tag-name" data-tags="dockerhub">
                <span class="iconfont-archer">&#xe606;</span>
                dockerhub
            </span>
            <span class="sidebar-tag-name" data-tags="gcr.io">
                <span class="iconfont-archer">&#xe606;</span>
                gcr.io
            </span>
            <span class="sidebar-tag-name" data-tags="微信">
                <span class="iconfont-archer">&#xe606;</span>
                微信
            </span>
            <span class="sidebar-tag-name" data-tags="api">
                <span class="iconfont-archer">&#xe606;</span>
                api
            </span>
            <span class="sidebar-tag-name" data-tags="ubuntu18">
                <span class="iconfont-archer">&#xe606;</span>
                ubuntu18
            </span>
            <span class="sidebar-tag-name" data-tags="tftp">
                <span class="iconfont-archer">&#xe606;</span>
                tftp
            </span>
            <span class="sidebar-tag-name" data-tags="trivy">
                <span class="iconfont-archer">&#xe606;</span>
                trivy
            </span>
            <span class="sidebar-tag-name" data-tags="uos">
                <span class="iconfont-archer">&#xe606;</span>
                uos
            </span>
            <span class="sidebar-tag-name" data-tags="wireguard">
                <span class="iconfont-archer">&#xe606;</span>
                wireguard
            </span>
            <span class="sidebar-tag-name" data-tags="x86">
                <span class="iconfont-archer">&#xe606;</span>
                x86
            </span>
            <span class="sidebar-tag-name" data-tags="zombie">
                <span class="iconfont-archer">&#xe606;</span>
                zombie
            </span>
            <span class="sidebar-tag-name" data-tags="zabbix">
                <span class="iconfont-archer">&#xe606;</span>
                zabbix
            </span>
            <span class="sidebar-tag-name" data-tags="正则">
                <span class="iconfont-archer">&#xe606;</span>
                正则
            </span>
            <span class="sidebar-tag-name" data-tags="awk">
                <span class="iconfont-archer">&#xe606;</span>
                awk
            </span>
            <span class="sidebar-tag-name" data-tags="GetImageBlob">
                <span class="iconfont-archer">&#xe606;</span>
                GetImageBlob
            </span>
            <span class="sidebar-tag-name" data-tags="sandbox">
                <span class="iconfont-archer">&#xe606;</span>
                sandbox
            </span>
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
        <span class="sidebar-category-name" data-categories="日志">
            <span class="iconfont-archer">&#xe60a;</span>
            日志
        </span>
        <span class="sidebar-category-name" data-categories="ipmi">
            <span class="iconfont-archer">&#xe60a;</span>
            ipmi
        </span>
        <span class="sidebar-category-name" data-categories="闲搞">
            <span class="iconfont-archer">&#xe60a;</span>
            闲搞
        </span>
        <span class="sidebar-category-name" data-categories="kubernetes">
            <span class="iconfont-archer">&#xe60a;</span>
            kubernetes
        </span>
        <span class="sidebar-category-name" data-categories="心得">
            <span class="iconfont-archer">&#xe60a;</span>
            心得
        </span>
        <span class="sidebar-category-name" data-categories="kubelet">
            <span class="iconfont-archer">&#xe60a;</span>
            kubelet
        </span>
        <span class="sidebar-category-name" data-categories="ansible">
            <span class="iconfont-archer">&#xe60a;</span>
            ansible
        </span>
        <span class="sidebar-category-name" data-categories="pxe">
            <span class="iconfont-archer">&#xe60a;</span>
            pxe
        </span>
        <span class="sidebar-category-name" data-categories="Linux">
            <span class="iconfont-archer">&#xe60a;</span>
            Linux
        </span>
        <span class="sidebar-category-name" data-categories="prometheus">
            <span class="iconfont-archer">&#xe60a;</span>
            prometheus
        </span>
        <span class="sidebar-category-name" data-categories="boot">
            <span class="iconfont-archer">&#xe60a;</span>
            boot
        </span>
        <span class="sidebar-category-name" data-categories="Auto cad">
            <span class="iconfont-archer">&#xe60a;</span>
            Auto cad
        </span>
        <span class="sidebar-category-name" data-categories="心得">
            <span class="iconfont-archer">&#xe60a;</span>
            心得
        </span>
        <span class="sidebar-category-name" data-categories="golang">
            <span class="iconfont-archer">&#xe60a;</span>
            golang
        </span>
        <span class="sidebar-category-name" data-categories="raid">
            <span class="iconfont-archer">&#xe60a;</span>
            raid
        </span>
        <span class="sidebar-category-name" data-categories="boot">
            <span class="iconfont-archer">&#xe60a;</span>
            boot
        </span>
        <span class="sidebar-category-name" data-categories="consul">
            <span class="iconfont-archer">&#xe60a;</span>
            consul
        </span>
        <span class="sidebar-category-name" data-categories="kubeconfig">
            <span class="iconfont-archer">&#xe60a;</span>
            kubeconfig
        </span>
        <span class="sidebar-category-name" data-categories="grub">
            <span class="iconfont-archer">&#xe60a;</span>
            grub
        </span>
        <span class="sidebar-category-name" data-categories="linux">
            <span class="iconfont-archer">&#xe60a;</span>
            linux
        </span>
        <span class="sidebar-category-name" data-categories="centos6">
            <span class="iconfont-archer">&#xe60a;</span>
            centos6
        </span>
        <span class="sidebar-category-name" data-categories="容器">
            <span class="iconfont-archer">&#xe60a;</span>
            容器
        </span>
        <span class="sidebar-category-name" data-categories="kickstart">
            <span class="iconfont-archer">&#xe60a;</span>
            kickstart
        </span>
        <span class="sidebar-category-name" data-categories="docker">
            <span class="iconfont-archer">&#xe60a;</span>
            docker
        </span>
        <span class="sidebar-category-name" data-categories="docker">
            <span class="iconfont-archer">&#xe60a;</span>
            docker
        </span>
        <span class="sidebar-category-name" data-categories="容器">
            <span class="iconfont-archer">&#xe60a;</span>
            容器
        </span>
        <span class="sidebar-category-name" data-categories="openstack">
            <span class="iconfont-archer">&#xe60a;</span>
            openstack
        </span>
        <span class="sidebar-category-name" data-categories="boot">
            <span class="iconfont-archer">&#xe60a;</span>
            boot
        </span>
        <span class="sidebar-category-name" data-categories="vsftp">
            <span class="iconfont-archer">&#xe60a;</span>
            vsftp
        </span>
        <span class="sidebar-category-name" data-categories="fstab">
            <span class="iconfont-archer">&#xe60a;</span>
            fstab
        </span>
        <span class="sidebar-category-name" data-categories="panic">
            <span class="iconfont-archer">&#xe60a;</span>
            panic
        </span>
        <span class="sidebar-category-name" data-categories="go">
            <span class="iconfont-archer">&#xe60a;</span>
            go
        </span>
        <span class="sidebar-category-name" data-categories="version">
            <span class="iconfont-archer">&#xe60a;</span>
            version
        </span>
        <span class="sidebar-category-name" data-categories="gobot">
            <span class="iconfont-archer">&#xe60a;</span>
            gobot
        </span>
        <span class="sidebar-category-name" data-categories="http">
            <span class="iconfont-archer">&#xe60a;</span>
            http
        </span>
        <span class="sidebar-category-name" data-categories="闲聊">
            <span class="iconfont-archer">&#xe60a;</span>
            闲聊
        </span>
        <span class="sidebar-category-name" data-categories="iptables">
            <span class="iconfont-archer">&#xe60a;</span>
            iptables
        </span>
        <span class="sidebar-category-name" data-categories="admission">
            <span class="iconfont-archer">&#xe60a;</span>
            admission
        </span>
        <span class="sidebar-category-name" data-categories="kube-controller-manager">
            <span class="iconfont-archer">&#xe60a;</span>
            kube-controller-manager
        </span>
        <span class="sidebar-category-name" data-categories="Prometheus">
            <span class="iconfont-archer">&#xe60a;</span>
            Prometheus
        </span>
        <span class="sidebar-category-name" data-categories="k8s">
            <span class="iconfont-archer">&#xe60a;</span>
            k8s
        </span>
        <span class="sidebar-category-name" data-categories="keepalived">
            <span class="iconfont-archer">&#xe60a;</span>
            keepalived
        </span>
        <span class="sidebar-category-name" data-categories="kubeadm">
            <span class="iconfont-archer">&#xe60a;</span>
            kubeadm
        </span>
        <span class="sidebar-category-name" data-categories="k8s">
            <span class="iconfont-archer">&#xe60a;</span>
            k8s
        </span>
        <span class="sidebar-category-name" data-categories="Job">
            <span class="iconfont-archer">&#xe60a;</span>
            Job
        </span>
        <span class="sidebar-category-name" data-categories="vxlan">
            <span class="iconfont-archer">&#xe60a;</span>
            vxlan
        </span>
        <span class="sidebar-category-name" data-categories="Kylin">
            <span class="iconfont-archer">&#xe60a;</span>
            Kylin
        </span>
        <span class="sidebar-category-name" data-categories="kmem">
            <span class="iconfont-archer">&#xe60a;</span>
            kmem
        </span>
        <span class="sidebar-category-name" data-categories="lua">
            <span class="iconfont-archer">&#xe60a;</span>
            lua
        </span>
        <span class="sidebar-category-name" data-categories="LVM">
            <span class="iconfont-archer">&#xe60a;</span>
            LVM
        </span>
        <span class="sidebar-category-name" data-categories="microsoft">
            <span class="iconfont-archer">&#xe60a;</span>
            microsoft
        </span>
        <span class="sidebar-category-name" data-categories="coredns">
            <span class="iconfont-archer">&#xe60a;</span>
            coredns
        </span>
        <span class="sidebar-category-name" data-categories="openwrt">
            <span class="iconfont-archer">&#xe60a;</span>
            openwrt
        </span>
        <span class="sidebar-category-name" data-categories="raid">
            <span class="iconfont-archer">&#xe60a;</span>
            raid
        </span>
        <span class="sidebar-category-name" data-categories="graph">
            <span class="iconfont-archer">&#xe60a;</span>
            graph
        </span>
        <span class="sidebar-category-name" data-categories="node-cache">
            <span class="iconfont-archer">&#xe60a;</span>
            node-cache
        </span>
        <span class="sidebar-category-name" data-categories="golang">
            <span class="iconfont-archer">&#xe60a;</span>
            golang
        </span>
        <span class="sidebar-category-name" data-categories="Prometheus">
            <span class="iconfont-archer">&#xe60a;</span>
            Prometheus
        </span>
        <span class="sidebar-category-name" data-categories="prometheus">
            <span class="iconfont-archer">&#xe60a;</span>
            prometheus
        </span>
        <span class="sidebar-category-name" data-categories="proxmox">
            <span class="iconfont-archer">&#xe60a;</span>
            proxmox
        </span>
        <span class="sidebar-category-name" data-categories="preseed">
            <span class="iconfont-archer">&#xe60a;</span>
            preseed
        </span>
        <span class="sidebar-category-name" data-categories="onedrive">
            <span class="iconfont-archer">&#xe60a;</span>
            onedrive
        </span>
        <span class="sidebar-category-name" data-categories="总结">
            <span class="iconfont-archer">&#xe60a;</span>
            总结
        </span>
        <span class="sidebar-category-name" data-categories="suse">
            <span class="iconfont-archer">&#xe60a;</span>
            suse
        </span>
        <span class="sidebar-category-name" data-categories="CI">
            <span class="iconfont-archer">&#xe60a;</span>
            CI
        </span>
        <span class="sidebar-category-name" data-categories="ubuntu18">
            <span class="iconfont-archer">&#xe60a;</span>
            ubuntu18
        </span>
        <span class="sidebar-category-name" data-categories="docker">
            <span class="iconfont-archer">&#xe60a;</span>
            docker
        </span>
        <span class="sidebar-category-name" data-categories="travis">
            <span class="iconfont-archer">&#xe60a;</span>
            travis
        </span>
        <span class="sidebar-category-name" data-categories="uos">
            <span class="iconfont-archer">&#xe60a;</span>
            uos
        </span>
        <span class="sidebar-category-name" data-categories="wireguard">
            <span class="iconfont-archer">&#xe60a;</span>
            wireguard
        </span>
        <span class="sidebar-category-name" data-categories="kickstart">
            <span class="iconfont-archer">&#xe60a;</span>
            kickstart
        </span>
        <span class="sidebar-category-name" data-categories="zombie">
            <span class="iconfont-archer">&#xe60a;</span>
            zombie
        </span>
        <span class="sidebar-category-name" data-categories="运维">
            <span class="iconfont-archer">&#xe60a;</span>
            运维
        </span>
        <span class="sidebar-category-name" data-categories="技巧">
            <span class="iconfont-archer">&#xe60a;</span>
            技巧
        </span>
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "http://zhangguanzhang.github.io",
        root: siteMetaRoot,
        author: "Zhangguanzhang"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->

        <!-- main func -->
        <script src="/scripts/main.js"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.js" onload="window.Fancybox.bind('[data-fancybox]')" defer></script>
        <!-- algolia -->
            <div class="site-search site-search-loading">
    <div class="algolia-popup popup">
        <div class="algolia-search">
            <div class="algolia-search-input-icon">
                <i class="fa fa-search"></i>
            </div>
            <div class="algolia-search-input" id="algolia-search-input"></div>
            <div class="popup-btn-close">
                <i class="iconfont-archer">&#xe609;</i>
            </div>
        </div>

        <div class="algolia-results">
            <div id="algolia-stats" class="algolia-stats"></div>
            <div id="algolia-hits"></div>
            <div id="algolia-pagination" class="algolia-pagination"></div>
        </div>
    </div>
</div>

            <script src="/scripts/search.js" async></script>
        <!-- busuanzi -->
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        <!-- async load share.js -->
            <script src="/scripts/share.js" async></script>
        <!-- mermaid -->
    </body>
</html>
