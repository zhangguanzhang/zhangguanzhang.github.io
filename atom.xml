<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Zhangguanzhang</title>
  
  <subtitle>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</subtitle>
  <link href="http://zhangguanzhang.github.io/atom.xml" rel="self"/>
  
  <link href="http://zhangguanzhang.github.io/"/>
  <updated>2025-11-12T10:30:30.000Z</updated>
  <id>http://zhangguanzhang.github.io/</id>
  
  <author>
    <name>Zhangguanzhang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>docker ä¸‹ï¼Œé‡å¯ pod sandbox é€ æˆ dns å¼‚å¸¸çš„æ¢³ç†</title>
    <link href="http://zhangguanzhang.github.io/2025/11/12/docker-sandbox-dns/"/>
    <id>http://zhangguanzhang.github.io/2025/11/12/docker-sandbox-dns/</id>
    <published>2025-11-12T10:30:30.000Z</published>
    <updated>2025-11-12T10:30:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>docker ä¸‹ï¼Œé‡å¯ pod sandbox é€ æˆ dns å¼‚å¸¸çš„æ¢³ç†</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å†…éƒ¨äº§å“æ˜¯ toB å’Œ toGï¼Œé’ˆå¯¹ toG çš„å®Œå…¨å†…ç½‘ï¼Œæµ‹è¯•ä¼šåœ¨æ­å»ºçš„ K8S é›†ç¾¤ä¸Šæ‰€æœ‰èŠ‚ç‚¹é…ç½®ä¸ªå‡çš„ DNSï¼Œè¿™æ ·é»‘ç›’ä¸‹æµ‹åŠŸèƒ½ï¼Œé¿å…ä¸šåŠ¡è®¿é—®å…¬ç½‘è€Œé€ æˆåŠŸèƒ½é—®é¢˜ã€‚ä½†æ˜¯æœ‰äº›åç»­æ–°ä¸šåŠ¡æ˜¯ä¾èµ–å…¬ç½‘çš„ï¼Œæµ‹è¯•æµ‹å®Œæ²¡å…¬ç½‘çš„éƒ¨åˆ†åå°±ä¼šé…ç½®çœŸå® dns åæµ‹è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œä¹‹å‰å°±é‡åˆ°è¿‡å¥½å‡ æ¬¡é…ç½®èŠ‚ç‚¹ DNS åï¼Œä¸ªåˆ« Pod å†… DNS å†…å®¹ä¸æ˜¯ k8s çš„ï¼Œè€Œæ˜¯ä¸‹é¢è¿™æ ·ç±»ä¼¼å˜æˆå®¿ä¸»æœºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Generated by Docker Engine.</span><br><span class="line"># This file can be edited; Docker Engine will not make further changes once it</span><br><span class="line"># has been modified.</span><br><span class="line"></span><br><span class="line">nameserver 10.xx.xx.xxx</span><br><span class="line"></span><br><span class="line"># Based on host file: &#x27;/run/systemd/resolve/resolv.conf&#x27; (legacy)</span><br><span class="line"># Overrides: []</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ˜¯ä½¿ç”¨çš„ cri-dockerd + k8s ç»„åˆã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p>ä¹‹å‰åé¦ˆäº†å‡ æ¬¡ï¼Œä½†æ˜¯ä¸€ç›´æ²¡ç¨³å®šå¤ç°æ‰‹æ®µï¼Œå°±å…ˆå»çœ‹äº†ä¸‹å¤§æ¦‚è¿™å— docker æºç ï¼Œç„¶åç»™æµ‹è¯•è¯´ï¼Œä¸‹æ¬¡å¼€å‘ç¯å¢ƒé‡åˆ°äº†åˆ«åˆ é™¤ Pod å’Œå¯¹åº”å®¹å™¨ï¼Œç›´æ¥å–Šæˆ‘ï¼Œæ˜¨å¤©ä¸‹åˆåé¦ˆæ‰¾åˆ°ç¨³å®šå¤ç°æ­¥éª¤äº†ï¼Œæˆ‘ä»¬æœ‰ä¸ª dashboardï¼Œæµ‹è¯•ç¯å¢ƒä¸Šå¼€å‘åœ¨ä¸Šé¢é‡å¯äº†ä»–çš„ Pod ä¸‹çš„å®¹å™¨ï¼Œè¯¥ Pod çš„ <code>spec.containers</code> åªæœ‰ä¸€ä¸ªï¼Œå‹¾é€‰çš„æ˜¯ç±»ä¼¼ <code>docker ps -a</code> çš„é‚£æ ·ï¼Œ<code>/pause</code> å®¹å™¨å’Œä»–çš„å®¹å™¨éƒ½å‹¾é€‰ç‚¹é‡å¯çš„ã€‚ä¸Šé¢ç‚¹äº†ä¸‹ç¡®å®å‘ç”Ÿäº†ã€‚</p><h3 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h3><p>æ‰¾åˆ°å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹ä¸Šå»çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -o wide -A | grep ai-aixxxxapi</span><br><span class="line">default       ai-aixxxxapi-6698f696d8-5w8kw                                1/1     Running            1 (27m ago)      35m     10.187.x.34    10.1x.5x.251   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">$ ip r g 1</span><br><span class="line">1.0.0.0 via 10.1x.5x.1 dev eth0 src 10.1x.5x.251 uid 0 </span><br><span class="line">    cache </span><br><span class="line">$ docker ps -a | grep  ai-aixxxxapi-6698f696d8-5w8kw </span><br><span class="line">8b4ae64cecc0   reg.xxx.lan:5000/xxx/ai-aixxxxapi                                                <span class="string">&quot;/usr/local/bin/starâ€¦&quot;</span>   27 minutes ago      Up 27 minutes                         k8s_ai-aixxxxapi_ai-aixxxxapi-6698f696d8-5w8kw_default_79fc032c-e1d3-4603-b21f-e5400ac6e3b6_1</span><br><span class="line">e8eb18aaca94   reg.xxx.lan:5000/xxx/pause:3.9                                                   <span class="string">&quot;/pause&quot;</span>                 27 minutes ago      Up 27 minutes                         k8s_POD_ai-aixxxxapi-6698f696d8-5w8kw_default_79fc032c-e1d3-4603-b21f-e5400ac6e3b6_1</span><br><span class="line">96ea991f9bb3   reg.xxx.lan:5000/xxx/ai-aixxxxapi                                                <span class="string">&quot;/usr/local/bin/starâ€¦&quot;</span>   34 minutes ago      Exited (2) 27 minutes ago             k8s_ai-aixxxxapi_ai-aixxxxapi-6698f696d8-5w8kw_default_79fc032c-e1d3-4603-b21f-e5400ac6e3b6_0</span><br><span class="line">e4c64897be98   reg.xxx.lan:5000/xxx/pause:3.9                                                   <span class="string">&quot;/pause&quot;</span>                 35 minutes ago      Exited (0) 27 minutes ago             k8s_POD_ai-aixxxxapi-6698f696d8-5w8kw_default_79fc032c-e1d3-4603-b21f-e5400ac6e3b6_0</span><br><span class="line">$ docker inspect 96ea991f9bb3 | grep Resolv</span><br><span class="line">        <span class="string">&quot;ResolvConfPath&quot;</span>: <span class="string">&quot;/data/kube/docker/containers/e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb/resolv.conf&quot;</span>,</span><br><span class="line">$ <span class="built_in">cat</span> /data/kube/docker/containers/e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb/resolv.conf</span><br><span class="line"><span class="comment"># Generated by Docker Engine.</span></span><br><span class="line"><span class="comment"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="comment"># has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 10.xx.41.103</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on host file: &#x27;/run/systemd/resolve/resolv.conf&#x27; (legacy)</span></span><br><span class="line"><span class="comment"># Overrides: []</span></span><br><span class="line">$ <span class="built_in">stat</span> /data/kube/docker/containers/e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb/resolv.conf</span><br><span class="line">  File: /data/kube/docker/containers/e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb/resolv.conf</span><br><span class="line">  Size: 238       Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 811h/2065dInode: 32449846    Links: 1</span><br><span class="line">Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">Access: 2025-11-11 15:52:45.692564762 +0800</span><br><span class="line">Modify: 2025-11-11 15:52:45.648562824 +0800</span><br><span class="line">Change: 2025-11-11 15:52:45.655896480 +0800</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure><p>å®¹å™¨ id e4c64897be98 æ‰¾ä¸‹æ—¥å¿—çœ‹çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xe --no-pager -u docker | grep -P <span class="string">&#x27;96ea991f9bb3|e4c64897be98&#x27;</span></span></span><br><span class="line">Nov 11 15:52:45 ubuntu2004chenxxxx7YX6V70 dockerd[3974]: time=&quot;2025-11-11T15:52:45.083407489+08:00&quot; level=warning msg=&quot;cleaning up after shim disconnected&quot; id=96ea991f9bb3454bec28712cb91c97f684e8f113e1b45697244190347a8c8305 namespace=moby</span><br><span class="line">Nov 11 15:52:45 ubuntu2004chenxxxx7YX6V70 dockerd[3974]: time=&quot;2025-11-11T15:52:45.587632737+08:00&quot; level=warning msg=&quot;cleaning up after shim disconnected&quot; id=e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb namespace=moby</span><br><span class="line">Nov 11 15:53:10 ubuntu2004chenxxxx7YX6V70 dockerd[3974]: time=&quot;2025-11-11T15:53:10.794469549+08:00&quot; level=warning msg=&quot;cleaning up after shim disconnected&quot; id=96ea991f9bb3454bec28712cb91c97f684e8f113e1b45697244190347a8c8305 namespace=moby</span><br><span class="line">Nov 11 15:53:11 ubuntu2004chenxxxx7YX6V70 dockerd[3974]: time=&quot;2025-11-11T15:53:11.417476169+08:00&quot; level=warning msg=&quot;cleaning up after shim disconnected&quot; id=e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb namespace=moby</span><br></pre></td></tr></table></figure><p>ä¹Ÿçœ‹ä¸‹å®¹å™¨æ—¶é—´ç›¸å…³ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker inspect e4c</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2025-11-11T07:44:57.093893019Z&quot;, ğŸ‘ˆ åˆ›å»ºæ—¶é—´</span><br><span class="line">        &quot;Path&quot;: &quot;/pause&quot;,</span><br><span class="line">        &quot;Args&quot;: [],</span><br><span class="line">        &quot;State&quot;: &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;exited&quot;,</span><br><span class="line">            &quot;Running&quot;: false,</span><br><span class="line">            &quot;Paused&quot;: false,</span><br><span class="line">            &quot;Restarting&quot;: false,</span><br><span class="line">            &quot;OOMKilled&quot;: false,</span><br><span class="line">            &quot;Dead&quot;: false,</span><br><span class="line">            &quot;Pid&quot;: 0,</span><br><span class="line">            &quot;ExitCode&quot;: 0,</span><br><span class="line">            &quot;Error&quot;: &quot;&quot;,</span><br><span class="line">            &quot;StartedAt&quot;: &quot;2025-11-11T07:52:45.856187062Z&quot;,</span><br><span class="line">            &quot;FinishedAt&quot;: &quot;2025-11-11T07:53:11.408195153Z&quot;</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure><p>ä¹Ÿçœ‹ä¸‹ cri-dockerd çš„æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xe --no-pager -u cri-dockerd | grep e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb</span></span><br><span class="line">Nov 11 15:45:03 ubuntu2004chenxxxx7YX6V70 cri-dockerd[51041]: time=&quot;2025-11-11T15:45:03+08:00&quot; level=info msg=&quot;Will attempt to re-write config file /data/kube/docker/containers/e4c64897be9891d88b999e81bfd55bb0cc1c21d626708749691d43158062f2bb/resolv.conf as [nameserver 10.186.0.2 search default.svc.cluster1.local. svc.cluster1.local. cluster1.local. options ndots:5]&quot;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢æ—¥å¿—æ€»ç»“æ—¶é—´çº¿ï¼š</p><ol><li><code>15.44.47</code> åˆ›å»º <code>/pause</code> å®¹å™¨</li><li><code>15:45:03</code> cri-dockerd æ‹‰å®Œä¸šåŠ¡é•œåƒååˆ›å»º sandbox å®¹å™¨ï¼Œre-write äº†å®¹å™¨çš„ <code>resolv.conf</code></li><li><code>15.52.45</code> é‡å¯äº†å®¹å™¨</li><li>å®¹å™¨çš„ <code>resolv.conf</code> æ ¹æ® mtime çœ‹å‘ç”Ÿæ”¹å˜</li></ol><h3 id="æœ€å°å¤ç°"><a href="#æœ€å°å¤ç°" class="headerlink" title="æœ€å°å¤ç°"></a>æœ€å°å¤ç°</h3><p>åç«¯é‡å¯å®¹å™¨é€»è¾‘æ˜¯åŒäº‹å†™çš„ï¼Œæˆ‘è®°å¾—å¤§æ¦‚é€»è¾‘æ˜¯ python docker client è°ƒç”¨ docker é‡å¯çš„ï¼Œç›´æ¥äºŒåˆ†ï¼Œçœ‹çœ‹ docker restart å¤ç°ä¸ã€‚ç¯å¢ƒä¸Šå¤ç°äº†ï¼Œé‚£å°±ä¸æ˜¯åç«¯é‡å¯é€»è¾‘é€ æˆçš„ï¼Œç„¶åè‡ªå·±æ­å»ºä¸ªå¹²å‡€ K8S ä¹Ÿå¤ç°äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> testpod.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: testpod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: testpod</span><br><span class="line">    image: m.daocloud.io/docker.io/library/nginx:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> nodeName: xxx</span></span><br></pre></td></tr></table></figure><p>å•èŠ‚ç‚¹ï¼Œå¦‚æœå›ºå®šèŠ‚ç‚¹çš„è¯è®¾ç½®ä¸‹ <code>nodeName</code> å³å¯ï¼Œå¤ç°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a | grep testpod</span></span><br><span class="line">73b346e11ef4   m.daocloud.io/docker.io/library/nginx                                            &quot;/docker-entrypoint.â€¦&quot;   3 minutes ago       Up 3 minutes                          k8s_vulnerable-container_testpod_default_f8215913-32b2-4e18-8536-69e5ecce7c84_0</span><br><span class="line">ad255b51f1b3   reg.xxx.lan:5000/xxx/pause:3.9                                                   &quot;/pause&quot;                 3 minutes ago       Up 3 minutes                          k8s_POD_testpod_default_f8215913-32b2-4e18-8536-69e5ecce7c84_0</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker inspect 73b346e11ef4 | grep ResolvConfPath</span></span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/data/kube/docker/containers/ad255b51f1b396fdea0d2579b373ac5c497fbd707031fa53936e805ac1b30cc9/resolv.conf&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/kube/docker/containers/ad255b51f1b396fdea0d2579b373ac5c497fbd707031fa53936e805ac1b30cc9/resolv.conf</span></span><br><span class="line">nameserver 10.186.0.2</span><br><span class="line">search default.svc.cluster1.local. svc.cluster1.local. cluster1.local.</span><br><span class="line">options ndots:5</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker restart 73b346e11ef4 ad255b51f1b3</span></span><br><span class="line">73b346e11ef4</span><br><span class="line">ad255b51f1b3</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/kube/docker/containers/ad255b51f1b396fdea0d2579b373ac5c497fbd707031fa53936e805ac1b30cc9/resolv.conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Generated by Docker Engine.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 10.x3.41.103</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Based on host file: <span class="string">&#x27;/run/systemd/resolve/resolv.conf&#x27;</span> (legacy)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Overrides: []</span></span><br></pre></td></tr></table></figure><p>Pod çš„åˆ›å»ºæµç¨‹å°±æ˜¯å…ˆå®¹å™¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ª &#x2F;pause å®¹å™¨ï¼Œç„¶å <code>pod.spec.containers</code> çš„å®¹å™¨ä¼š join åˆ° <code>/pause</code> ä¸Šï¼Œè€Œ docker ä¸‹å®¹å™¨çš„ hosts,resolv.conf,hopstname è¿™äº›æ˜¯å•ç‹¬ä¸€å±‚ init å±‚å¤„ç†çš„ï¼Œä¼šåˆ›å»ºæ–‡ä»¶ï¼ŒPod çš„æ‰€æœ‰å®¹å™¨éƒ½ä½¿ç”¨åŒä¸€ä»½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a | grep testpod</span></span><br><span class="line">f6ef003b4864   xxx</span><br><span class="line">340e173d875b   xxxx</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker inspect 340e173d875b | grep ResolvConfPath</span></span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/data/kube/docker/containers/340e173d875b00b6aca32f8770493b9f1d86159340bcea6bc01b93992763bab7/resolv.conf&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker inspect f6ef003b4864 | grep ResolvConfPath</span></span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/data/kube/docker/containers/340e173d875b00b6aca32f8770493b9f1d86159340bcea6bc01b93992763bab7/resolv.conf&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/kube/docker/containers/340e173d875b00b6aca32f8770493b9f1d86159340bcea6bc01b93992763bab7/resolv.conf</span></span><br><span class="line">nameserver 10.186.0.2</span><br><span class="line">search default.svc.cluster2.local. svc.cluster2.local. cluster2.local.</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure><p>ç„¶åå‘ç°åªæœ‰é‡å¯ <code>/pause</code> å®¹å™¨æ‰å‘ç”Ÿï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a | grep testpod</span></span><br><span class="line">ef9bb3c69dfa   reg.xxx.lan:5000/xxx/nginx                                                       &quot;/docker-entrypoint.â€¦&quot;   2 minutes ago    Up 2 minutes                              k8s_vulnerable-container_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_1</span><br><span class="line">e6868ab3d8ef   reg.xxx.lan:5000/xxx/pause:3.9                                                   &quot;/pause&quot;                  2 minutes ago    Up 2 minutes                              k8s_POD_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_1</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker inspect e6868ab3d8ef | grep ResolvConfPath</span></span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/data/kube/docker/containers/e6868ab3d8ef8fa1238a82a15faa88b1d13967a71a1e16c99618663610d21286/resolv.conf&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/kube/docker/containers/e6868ab3d8ef8fa1238a82a15faa88b1d13967a71a1e16c99618663610d21286/resolv.conf</span></span><br><span class="line">nameserver 10.186.0.2</span><br><span class="line">search default.svc.cluster2.local. svc.cluster2.local. cluster2.local.</span><br><span class="line">options ndots:5</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker restart e6868ab3d8ef</span></span><br><span class="line">e6868ab3d8ef</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/kube/docker/containers/e6868ab3d8ef8fa1238a82a15faa88b1d13967a71a1e16c99618663610d21286/resolv.conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Generated by Docker Engine.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Based on host file: <span class="string">&#x27;/etc/resolv.conf&#x27;</span> (legacy)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Overrides: []</span></span><br></pre></td></tr></table></figure><h3 id="ç›¸å…³æºç "><a href="#ç›¸å…³æºç " class="headerlink" title="ç›¸å…³æºç "></a>ç›¸å…³æºç </h3><p>æ—¢ç„¶ç¡®å®šæ˜¯ docker é€»è¾‘é€ æˆï¼Œé‚£å°±éœ€è¦çœ‹ä¸‹è¿™å—æºç é€»è¾‘äº†ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ç”Ÿæˆæ³¨é‡Šçš„ï¼Œä»£ç é‡Œæœå…³é”®å­— <code>Generated by Docker Engine.</code> æœåˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/libnetwork/sandbox_dns_unix.go#L248-L278</span></span><br><span class="line"><span class="comment">// loadResolvConf reads the resolv.conf file at path, and merges in overrides for</span></span><br><span class="line"><span class="comment">// nameservers, options, and search domains.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sb *Sandbox)</span></span> loadResolvConf(path <span class="type">string</span>) (*resolvconf.ResolvConf, <span class="type">error</span>) &#123;</span><br><span class="line">rc, err := resolvconf.Load(path)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !errors.Is(err, fs.ErrNotExist) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Proceed with rc, which might be zero-valued if path does not exist.</span></span><br><span class="line"></span><br><span class="line">rc.SetHeader(<span class="string">`# Generated by Docker Engine.</span></span><br><span class="line"><span class="string"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="string"># has been modified.`</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sb.config.dnsList) &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">var</span> dnsAddrs []netip.Addr</span><br><span class="line"><span class="keyword">for</span> _, ns := <span class="keyword">range</span> sb.config.dnsList &#123;</span><br><span class="line">addr, err := netip.ParseAddr(ns)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;bad nameserver address %s&quot;</span>, ns)</span><br><span class="line">&#125;</span><br><span class="line">dnsAddrs = <span class="built_in">append</span>(dnsAddrs, addr)</span><br><span class="line">&#125;</span><br><span class="line">rc.OverrideNameServers(dnsAddrs)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sb.config.dnsSearchList) &gt; <span class="number">0</span> &#123;</span><br><span class="line">rc.OverrideSearch(sb.config.dnsSearchList)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sb.config.dnsOptionsList) &gt; <span class="number">0</span> &#123;</span><br><span class="line">rc.OverrideOptions(sb.config.dnsOptionsList)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;rc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€†å‘æ€ç»´ï¼Œæœäº†ä¸‹ <code>loadResolvConf(</code> å‘ç°æœ‰åœ¨</p><ul><li><code>func (sb *Sandbox) setupDNS() error {</code></li><li><code>func (sb *Sandbox) updateDNS(ipv6Enabled bool) error {</code></li><li><code>func (sb *Sandbox) rebuildDNS() error {</code></li></ul><h4 id="æ–­ç‚¹è°ƒè¯•"><a href="#æ–­ç‚¹è°ƒè¯•" class="headerlink" title="æ–­ç‚¹è°ƒè¯•"></a>æ–­ç‚¹è°ƒè¯•</h4><p>æ ¹æ®ç¼–è¯‘ dockerd å¼€å¯è°ƒè¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">DOCKER_DEBUG=1 ./hack/make.sh binary-daemon</span></span><br><span class="line"></span><br><span class="line">Removing bundles/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">---&gt; </span><span class="language-bash">Making bundle: binary-daemon (<span class="keyword">in</span> bundles/binary-daemon)</span></span><br><span class="line">Building static bundles/binary-daemon/dockerd (linux/amd64)...</span><br><span class="line">+++ ./hack/with-go-mod.sh go build -mod=vendor -modfile=vendor.mod -o bundles/binary-daemon/dockerd -tags &#x27;netgo osusergo static_build &#x27; -ldflags &#x27; -X &quot;github.com/docker/docker/dockerversion.Version=dev&quot; -X &quot;github.com/docker/docker/dockerversion.GitCommit=de5c9cf0b96e4e172b96db54abababa4a328462f&quot; -X &quot;github.com/docker/docker/dockerversion.BuildTime=2025-11-11T10:42:16.000000000+00:00&quot; -X &quot;github.com/docker/docker/dockerversion.PlatformName=&quot; -X &quot;github.com/docker/docker/dockerversion.ProductName=&quot; -X &quot;github.com/docker/docker/dockerversion.DefaultProductLicense=&quot;  -extldflags -static &#x27; &#x27;-gcflags=all=-N -l&#x27; github.com/docker/docker/cmd/dockerd</span><br><span class="line">+ tee /root/github/moby/go.mod</span><br><span class="line">module github.com/docker/docker</span><br><span class="line"></span><br><span class="line">go 1.21</span><br><span class="line">+ trap &#x27;rm -f &quot;$&#123;ROOTDIR&#125;/go.mod&quot;&#x27; EXIT</span><br><span class="line">+ GO111MODULE=on</span><br><span class="line">+ GOTOOLCHAIN=local</span><br><span class="line">+ go build -mod=vendor -modfile=vendor.mod -o bundles/binary-daemon/dockerd -tags &#x27;netgo osusergo static_build &#x27; -ldflags &#x27; -X &quot;github.com/docker/docker/dockerversion.Version=dev&quot; -X &quot;github.com/docker/docker/dockerversion.GitCommit=de5c9cf0b96e4e172b96db54abababa4a328462f&quot; -X &quot;github.com/docker/docker/dockerversion.BuildTime=2025-11-11T10:42:16.000000000+00:00&quot; -X &quot;github.com/docker/docker/dockerversion.PlatformName=&quot; -X &quot;github.com/docker/docker/dockerversion.ProductName=&quot; -X &quot;github.com/docker/docker/dockerversion.DefaultProductLicense=&quot;  -extldflags -static &#x27; &#x27;-gcflags=all=-N -l&#x27; github.com/docker/docker/cmd/dockerd</span><br><span class="line">+ rm -f /root/github/moby/go.mod</span><br><span class="line">Created binary: bundles/binary-daemon/dockerd</span><br></pre></td></tr></table></figure><p>æ›¿æ¢å¯åŠ¨ï¼Œæ‰¾åˆ° pidï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br><span class="line">d_dir=$(dirname $(which docker))</span><br><span class="line">cp $(which dockerd) $(which dockerd).bak</span><br><span class="line">cp bundles/binary-daemon/dockerd $&#123;d_dir&#125;</span><br><span class="line">systemctl start docker</span><br><span class="line">ps -ef | grep /docker[d]</span><br></pre></td></tr></table></figure><p>ç„¶åé™„åŠ  pid ä¸Šè°ƒè¯•ï¼Œdlv æ‰“äº†å‡ ä¸ªæ–­ç‚¹åå‘ç°åœ¨ <code>setupDNS()</code> é‡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go install github.com/go-delve/delve/cmd/dlv@master</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dlv attach 19034</span></span><br><span class="line">Type &#x27;help&#x27; for list of commands.</span><br><span class="line">(dlv) b libnetwork/sandbox_dns_unix.go:285</span><br><span class="line">Breakpoint 1 set at 0x24c6c8b for github.com/docker/docker/libnetwork.(*Sandbox).setupDNS() ./libnetwork/sandbox_dns_unix.go:285</span><br><span class="line">(dlv) b libnetwork/sandbox_dns_unix.go:300</span><br><span class="line">Breakpoint 2 set at 0x24c6f52 for github.com/docker/docker/libnetwork.(*Sandbox).updateDNS() ./libnetwork/sandbox_dns_unix.go:300</span><br><span class="line">(dlv) c</span><br></pre></td></tr></table></figure><p>ç„¶åå¦ä¸€ä¸ªç»ˆç«¯ä¸Šé‡å¯ä¸‹ <code>/pause</code> å®¹å™¨ï¼Œè¿™è¾¹ dlv å°±èµ°åˆ°æ–­ç‚¹äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(dlv) c</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">[Breakpoint 1] github.com/docker/docker/libnetwork.(*Sandbox).setupDNS() ./libnetwork/sandbox_dns_unix.go:285 (hits goroutine(2045):1 total:1) (PC: 0x24c6c8b)</span></span><br><span class="line">   280:// For a new sandbox, write an initial version of the container&#x27;s resolv.conf. It&#x27;ll</span><br><span class="line">   281:// be a copy of the host&#x27;s file, with overrides for nameservers, options and search</span><br><span class="line">   282:// domains applied.</span><br><span class="line">   283:func (sb *Sandbox) setupDNS() error &#123;</span><br><span class="line">   284:// Make sure the directory exists.</span><br><span class="line">=&gt; 285:sb.restoreResolvConfPath()</span><br><span class="line">   286:dir, _ := filepath.Split(sb.config.resolvConfPath)</span><br><span class="line">   287:if err := createBasePath(dir); err != nil &#123;</span><br><span class="line">   288:return err</span><br><span class="line">   289:&#125;</span><br><span class="line">   290:</span><br><span class="line">(dlv) p sb</span><br><span class="line">Sending output to pager...</span><br><span class="line">(&quot;*github.com/docker/docker/libnetwork.Sandbox&quot;)(0xc0028d2400)</span><br><span class="line">*github.com/docker/docker/libnetwork.Sandbox &#123;</span><br><span class="line">id: &quot;1695c2a715872e25bcaa9c0268eeea65e528fa3ec6c275dfbf567344cd2cb30c&quot;,</span><br><span class="line">containerID: &quot;176c492dc77f3ed8020c1d4e59896311fea359135be39c26c04d28460546cf38&quot;,</span><br><span class="line">config: github.com/docker/docker/libnetwork.containerConfig &#123;</span><br></pre></td></tr></table></figure><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>å¤§è‡´çœ‹äº†ä¸‹ docker è¿™å—é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/libnetwork/sandbox_dns_unix.go#L280C1-L296C2</span></span><br><span class="line"><span class="comment">// For a new sandbox, write an initial version of the container&#x27;s resolv.conf. It&#x27;ll</span></span><br><span class="line"><span class="comment">// be a copy of the host&#x27;s file, with overrides for nameservers, options and search</span></span><br><span class="line"><span class="comment">// domains applied.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sb *Sandbox)</span></span> setupDNS() <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// Make sure the directory exists.</span></span><br><span class="line">sb.restoreResolvConfPath()</span><br><span class="line">dir, _ := filepath.Split(sb.config.resolvConfPath)</span><br><span class="line"><span class="keyword">if</span> err := createBasePath(dir); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rc, err := sb.loadResolvConf(sb.config.getOriginResolvConfPath())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rc.WriteFile(sb.config.resolvConfPath, sb.config.resolvConfHashFile, filePerm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sb.restoreResolvConfPath()</code> å¡«å……å˜é‡ï¼Œä¹Ÿå°±æ˜¯å®é™…çš„ <code>ResolvConfPath</code> å’Œä»–çš„ <code>.hash</code> æ–‡ä»¶:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sb *Sandbox)</span></span> restoreResolvConfPath() &#123;</span><br><span class="line"><span class="keyword">if</span> sb.config.resolvConfPath == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">sb.config.resolvConfPath = defaultPrefix + <span class="string">&quot;/&quot;</span> + sb.id + <span class="string">&quot;/resolv.conf&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">sb.config.resolvConfHashFile = sb.config.resolvConfPath + <span class="string">&quot;.hash&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sb.loadResolvConf</code> æ–¹æ³•å°±æ˜¯æŠŠ Linux çš„ DNS å†…å®¹è§£ææˆç»“æ„ä½“ï¼Œä¼ å…¥çš„ <code>sb.config.getOriginResolvConfPath()</code> æ˜¯è·å–å®¿ä¸»æœºçš„ dns æ–‡ä»¶è·¯å¾„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(dlv) n</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/docker/libnetwork.(*containerConfig).getOriginResolvConfPath() ./libnetwork/sandbox_dns_unix.go:242 (PC: 0x24c64ab)</span></span><br><span class="line">   237:&#125;</span><br><span class="line">   238:&#125;</span><br><span class="line">   239:</span><br><span class="line">   240:func (c *containerConfig) getOriginResolvConfPath() string &#123;</span><br><span class="line">   241:if c.originResolvConfPath != &quot;&quot; &#123;</span><br><span class="line">=&gt; 242:return c.originResolvConfPath</span><br><span class="line">   243:&#125;</span><br><span class="line">   244:// Fallback if not specified.</span><br><span class="line">   245:return resolvconf.Path()</span><br><span class="line">   246:&#125;</span><br><span class="line">   247:</span><br><span class="line">(dlv) p c.originResolvConfPath</span><br><span class="line">&quot;/etc/resolv.conf&quot;</span><br></pre></td></tr></table></figure><p>ç„¶åç»§ç»­è°ƒè¯•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(dlv) list</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">[Breakpoint 1] github.com/docker/docker/libnetwork.(*Sandbox).setupDNS() ./libnetwork/sandbox_dns_unix.go:291 (hits goroutine(52319):1 total:3) (PC: 0x24c6d7a)</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">github.com/docker/docker/libnetwork/internal/resolvconf.(*ResolvConf).WriteFile() ./libnetwork/internal/resolvconf/resolvconf.go:377 (PC: 0xfad513)</span></span><br><span class="line">   372:</span><br><span class="line">   373:// WriteFile generates content and writes it to path. If hashPath is non-zero, it</span><br><span class="line">   374:// also writes a file containing a hash of the content, to enable UserModified()</span><br><span class="line">   375:// to determine whether the file has been modified.</span><br><span class="line">   376:func (rc *ResolvConf) WriteFile(path, hashPath string, perm os.FileMode) error &#123;</span><br><span class="line">=&gt; 377:content, err := rc.Generate(true)</span><br><span class="line">   378:if err != nil &#123;</span><br><span class="line">   379:return err</span><br><span class="line">   380:&#125;</span><br><span class="line">   381:</span><br><span class="line">   382:// Write the resolv.conf file - it&#x27;s bind-mounted into the container, so can&#x27;t</span><br><span class="line">(dlv) p path</span><br><span class="line">&quot;/data/kube/docker/containers/c213ae91753573a17948caf3cfa6421045d11e7e269d57cbc129f784f188d99b/resolv.conf&quot;</span><br><span class="line">(dlv) p hashPath</span><br><span class="line">&quot;/data/kube/docker/containers/c213ae91753573a17948caf3cfa6421045d11e7e269d57cbc129f784f188d99b/resolv.conf.hash&quot;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸ª hash æ–‡ä»¶ï¼Œé‚£çœ‹èµ·æ¥å°±æœ€ä¸‹é¢çš„ <code>rc.WriteFile</code> æ”¹å†™çš„å†…å®¹äº†ï¼Œçœ‹ä¸‹å®ƒçš„é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/libnetwork/internal/resolvconf/resolvconf.go#L373-L402</span></span><br><span class="line"><span class="comment">// WriteFile generates content and writes it to path. If hashPath is non-zero, it</span></span><br><span class="line"><span class="comment">// also writes a file containing a hash of the content, to enable UserModified()</span></span><br><span class="line"><span class="comment">// to determine whether the file has been modified.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rc *ResolvConf)</span></span> WriteFile(path, hashPath <span class="type">string</span>, perm os.FileMode) <span class="type">error</span> &#123;</span><br><span class="line">content, err := rc.Generate(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write the resolv.conf file - it&#x27;s bind-mounted into the container, so can&#x27;t</span></span><br><span class="line"><span class="comment">// move a temp file into place, just have to truncate and write it.</span></span><br><span class="line"><span class="keyword">if</span> err := os.WriteFile(path, content, perm); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errdefs.System(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write the hash file.</span></span><br><span class="line"><span class="keyword">if</span> hashPath != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">hashFile, err := ioutils.NewAtomicFileWriter(hashPath, perm)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errdefs.System(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> hashFile.Close()</span><br><span class="line"></span><br><span class="line">digest := digest.FromBytes(content)</span><br><span class="line"><span class="keyword">if</span> _, err = hashFile.Write([]<span class="type">byte</span>(digest)); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>content å°±æ˜¯ç”Ÿæˆæœ€åå†™å…¥çš„å†…å®¹å†™å…¥ï¼Œä»¥åŠè®¡ç®—å½“å‰ content çš„ hash å†™å…¥åˆ° <code>.hash</code> æ–‡ä»¶ã€‚é‚£è¿˜æ˜¯å¾—çœ‹ <code>setupDNS()</code> çš„æ›´ä¸Šå±‚è°ƒç”¨ï¼Œæœåˆ° <code>setupResolutionFiles()</code>ï¼Œè€Œè°ƒç”¨å®ƒçš„æœ‰ä¸¤ä¸ªï¼š</p><ul><li><code>func (c *Controller) NewSandbox(</code></li><li><code>func (sb *Sandbox) Refresh(</code></li></ul><p>ä¿©éƒ½æ‰“æ–­ç‚¹çœ‹çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dlv attach 19035</span></span><br><span class="line">Type &#x27;help&#x27; for list of commands.</span><br><span class="line">(dlv) b libnetwork/sandbox.go:263</span><br><span class="line">Breakpoint 1 set at 0x24be2d8 for github.com/docker/docker/libnetwork.(*Sandbox).Refresh() ./libnetwork/sandbox.go:263</span><br><span class="line">(dlv) b libnetwork/controller.go:944</span><br><span class="line">Breakpoint 2 set at 0x2470d2f for github.com/docker/docker/libnetwork.(*Controller).NewSandbox() ./libnetwork/controller.go:944</span><br><span class="line">(dlv) c</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">[Breakpoint 2] github.com/docker/docker/libnetwork.(*Controller).NewSandbox() ./libnetwork/controller.go:944 (hits goroutine(58233):1 total:1) (PC: 0x2470d2f)</span></span><br><span class="line">   939:&#125;</span><br><span class="line">   940:c.mu.Unlock()</span><br><span class="line">   941:&#125;</span><br><span class="line">   942:&#125;()</span><br><span class="line">   943:</span><br><span class="line">=&gt; 944:if err := sb.setupResolutionFiles(); err != nil &#123;</span><br><span class="line">   945:return nil, err</span><br><span class="line">   946:&#125;</span><br><span class="line">   947:if err := c.setupOSLSandbox(sb); err != nil &#123;</span><br><span class="line">   948:return nil, err</span><br><span class="line">   949:&#125;</span><br></pre></td></tr></table></figure><p>èµ°çš„ <code>NewSandbox</code> ï¼Œæ‰“å°ä¸‹ backtraceï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(dlv) bt</span><br><span class="line"> 0  0x0000000002470d2f in github.com/docker/docker/libnetwork.(*Controller).NewSandbox</span><br><span class="line">    at ./libnetwork/controller.go:944</span><br><span class="line"> 1  0x0000000002f855e5 in github.com/docker/docker/daemon.(*Daemon).connectToNetwork</span><br><span class="line">    at ./daemon/container_operations.go:762</span><br><span class="line"> 2  0x0000000002f82825 in github.com/docker/docker/daemon.(*Daemon).allocateNetwork</span><br><span class="line">    at ./daemon/container_operations.go:525</span><br><span class="line"> 3  0x0000000002f87d05 in github.com/docker/docker/daemon.(*Daemon).initializeNetworking</span><br><span class="line">    at ./daemon/container_operations.go:950</span><br><span class="line"> 4  0x000000000302d26b in github.com/docker/docker/daemon.(*Daemon).containerStart</span><br><span class="line">    at ./daemon/start.go:117</span><br><span class="line"> 5  0x0000000003028736 in github.com/docker/docker/daemon.(*Daemon).containerRestart</span><br><span class="line">    at ./daemon/restart.go:69</span><br><span class="line"> 6  0x00000000030281e5 in github.com/docker/docker/daemon.(*Daemon).ContainerRestart</span><br><span class="line">    at ./daemon/restart.go:24</span><br><span class="line"> 7  0x00000000028a9c15 in github.com/docker/docker/api/server/router/container.(*containerRouter).postContainersRestart</span><br><span class="line">    at ./api/server/router/container/container_routes.go:267</span><br><span class="line"> 8  0x00000000028b594c in github.com/docker/docker/api/server/router/container.(*containerRouter).postContainersRestart-fm</span><br><span class="line">    at &lt;autogenerated&gt;:1</span><br></pre></td></tr></table></figure><p>å°è¯•äº†ä¿®æ”¹ä»£ç ï¼Œå‘ç°å¥½å¤šé€»è¾‘ï¼Œå¤§è‡´ç†æ¸…æ¥šäº†ï¼Œrestart &#x2F;pause ä¼šèµ° <code>NewSandbox()</code> ä»¥åŠ <code>Endpoint</code> ç›¸å…³é€»è¾‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0  0x000000000247da42 in github.com/docker/docker/libnetwork.(*Endpoint).sbJoin</span><br><span class="line">   at ./libnetwork/endpoint.go:529</span><br><span class="line">1  0x000000000247cc3a in github.com/docker/docker/libnetwork.(*Endpoint).Join</span><br><span class="line">   at ./libnetwork/endpoint.go:467</span><br><span class="line">2  0x0000000002f85ad1 in github.com/docker/docker/daemon.(*Daemon).connectToNetwork</span><br><span class="line">   at ./daemon/container_operations.go:780</span><br><span class="line">3  0x0000000002f82ac5 in github.com/docker/docker/daemon.(*Daemon).allocateNetwork</span><br><span class="line">   at ./daemon/container_operations.go:530</span><br><span class="line">4  0x0000000002f87fa5 in github.com/docker/docker/daemon.(*Daemon).initializeNetworking</span><br><span class="line">   at ./daemon/container_operations.go:955</span><br><span class="line">5  0x000000000302d50b in github.com/docker/docker/daemon.(*Daemon).containerStart</span><br><span class="line">   at ./daemon/start.go:117</span><br><span class="line">6  0x00000000030289d6 in github.com/docker/docker/daemon.(*Daemon).containerRestart</span><br><span class="line">   at ./daemon/restart.go:69</span><br><span class="line">7  0x0000000003028485 in github.com/docker/docker/daemon.(*Daemon).ContainerRestart</span><br><span class="line">   at ./daemon/restart.go:24</span><br><span class="line">8  0x00000000028a9c95 in github.com/docker/docker/api/server/router/container.(*containerRouter).postContainersRestart</span><br><span class="line">   at ./api/server/router/container/container_routes.go:267</span><br></pre></td></tr></table></figure><p>æ”¹äº†å‡ ä¸ªåœ°æ–¹é€»è¾‘å‘ç°æ‰“åœ°é¼ ä¸€æ ·:</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">From 47d22b26fbee572f01bde687d42bc5f0a7bff4a8 Mon Sep 17 00:00:00 2001</span><br><span class="line">From: zhangguanzhang &lt;zhangguanzhang@qq.com&gt;</span><br><span class="line">Date: Wed, 12 Nov 2025 16:34:42 +0800</span><br><span class="line">Subject: [PATCH] fix</span><br><span class="line"></span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> daemon/container_operations.go | 5 +++++</span><br><span class="line"> libnetwork/controller.go       | 9 +++++++--</span><br><span class="line"> libnetwork/sandbox.go          | 1 +</span><br><span class="line"> libnetwork/sandbox_options.go  | 8 ++++++++</span><br><span class="line"> 4 files changed, 21 insertions(+), 2 deletions(-)</span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/daemon/container_operations.go b/daemon/container_operations.go</span></span><br><span class="line"><span class="comment">index 86da02f172..023622caa0 100644</span></span><br><span class="line"><span class="comment">--- a/daemon/container_operations.go</span></span><br><span class="line"><span class="comment">+++ b/daemon/container_operations.go</span></span><br><span class="line"><span class="meta">@@ -154,6 +154,11 @@</span> func (daemon *Daemon) buildSandboxOptions(cfg *config.Config, container *contain</span><br><span class="line"> </span><br><span class="line"> sboxOptions = append(sboxOptions, libnetwork.OptionPortMapping(publishedPorts), libnetwork.OptionExposedPorts(exposedPorts))</span><br><span class="line"> </span><br><span class="line"><span class="addition">+if !container.Created.IsZero() &amp;&amp; time.Now().After(container.Created) &amp;&amp;</span></span><br><span class="line"><span class="addition">+!container.HostConfig.NetworkMode.IsContainer() &amp;&amp; !container.HostConfig.NetworkMode.IsHost() &#123;</span></span><br><span class="line"><span class="addition">+sboxOptions = append(sboxOptions, libnetwork.OptionRestartOperate())</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // Legacy Link feature is supported only for the default bridge network.</span><br><span class="line"> // return if this call to build join options is not for default bridge network</span><br><span class="line"> // Legacy Link is only supported by docker run --link</span><br><span class="line"><span class="comment">diff --git a/libnetwork/controller.go b/libnetwork/controller.go</span></span><br><span class="line"><span class="comment">index 9a34a87e11..2cc73169da 100644</span></span><br><span class="line"><span class="comment">--- a/libnetwork/controller.go</span></span><br><span class="line"><span class="comment">+++ b/libnetwork/controller.go</span></span><br><span class="line"><span class="meta">@@ -941,9 +941,14 @@</span> func (c *Controller) NewSandbox(containerID string, options ...SandboxOption) (_</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;()</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-if err := sb.setupResolutionFiles(); err != nil &#123;</span></span><br><span class="line"><span class="deletion">-return nil, err</span></span><br><span class="line"><span class="addition">+if !sb.inRestartOperate &#123;</span></span><br><span class="line"><span class="addition">+if err := sb.setupResolutionFiles(); err != nil &#123;</span></span><br><span class="line"><span class="addition">+return nil, err</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> if err := c.setupOSLSandbox(sb); err != nil &#123;</span><br><span class="line"> return nil, err</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">diff --git a/libnetwork/sandbox.go b/libnetwork/sandbox.go</span></span><br><span class="line"><span class="comment">index e1138da5c4..7c9c9d9ddf 100644</span></span><br><span class="line"><span class="comment">--- a/libnetwork/sandbox.go</span></span><br><span class="line"><span class="comment">+++ b/libnetwork/sandbox.go</span></span><br><span class="line"><span class="meta">@@ -50,6 +50,7 @@</span> type Sandbox struct &#123;</span><br><span class="line"> dbExists           bool</span><br><span class="line"> isStub             bool</span><br><span class="line"> inDelete           bool</span><br><span class="line"><span class="addition">+inRestartOperate   bool</span></span><br><span class="line"> ingress            bool</span><br><span class="line"> ndotsSet           bool</span><br><span class="line"> oslTypes           []osl.SandboxType // slice of properties of this sandbox</span><br><span class="line"><span class="comment">diff --git a/libnetwork/sandbox_options.go b/libnetwork/sandbox_options.go</span></span><br><span class="line"><span class="comment">index 0d914512fa..144e7526b4 100644</span></span><br><span class="line"><span class="comment">--- a/libnetwork/sandbox_options.go</span></span><br><span class="line"><span class="comment">+++ b/libnetwork/sandbox_options.go</span></span><br><span class="line"><span class="meta">@@ -171,3 +171,11 @@</span> func OptionLoadBalancer(nid string) SandboxOption &#123;</span><br><span class="line"> sb.oslTypes = append(sb.oslTypes, osl.SandboxTypeLoadBalancer)</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// OptionRestartOperate function returns an option setter for marking a</span></span><br><span class="line"><span class="addition">+// sandbox as a restarting status.</span></span><br><span class="line"><span class="addition">+func OptionRestartOperate() SandboxOption &#123;</span></span><br><span class="line"><span class="addition">+return func(sb *Sandbox) &#123;</span></span><br><span class="line"><span class="addition">+sb.inRestartOperate = true</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="deletion">-- </span></span><br><span class="line">2.25.1</span><br></pre></td></tr></table></figure><h4 id="sandbox-change"><a href="#sandbox-change" class="headerlink" title="sandbox change"></a>sandbox change</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a | grep testpod</span><br><span class="line">256cdbac0fc8   reg.xxx.lan:5000/xxx/nginx                                                       &quot;/docker-entrypoint.â€¦&quot;   12 minutes ago      Up 12 minutes                             k8s_vulnerable-container_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_20</span><br><span class="line">2f79aa18d3f6   reg.xxx.lan:5000/xxx/pause:3.9                                                   &quot;/pause&quot;                  12 minutes ago      Up 12 minutes                             k8s_POD_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_20</span><br><span class="line">$ docker inspect 2f79aa18d3f6 | grep SandboxI</span><br><span class="line">            &quot;SandboxID&quot;: &quot;08b8e08676b30c527f76ef551de3dff3fec048af4486b69f8eb0071b2af0a9cf&quot;,</span><br><span class="line">            &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/08b8e08676b3&quot;,</span><br><span class="line">$ docker restart 2f79aa18d3f6</span><br><span class="line">2f79aa18d3f6</span><br><span class="line">$ docker inspect 2f79aa18d3f6 | grep SandboxI</span><br><span class="line">            &quot;SandboxID&quot;: &quot;c87e60bef5f4d95feb723a1ec8818bf2021c900fa5974e0e2107189ab90661ba&quot;,</span><br><span class="line">            &quot;SandboxKey&quot;: &quot;/var/run/docker/netns/c87e60bef5f4&quot;,</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° sandbox å˜äº†å¯¼è‡´é‡å»ºäº† DNSã€‚</p><h4 id="containerd-æ²¡å¤ç°"><a href="#containerd-æ²¡å¤ç°" class="headerlink" title="containerd æ²¡å¤ç°"></a>containerd æ²¡å¤ç°</h4><p>é¡ºä¾¿æ‰¾äºº containerd + nerdctl è¯•äº†ä¸‹æ²¡é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nerdctl -n k8s.io ps -a | grep zgz</span></span><br><span class="line">d79ac72ea7a6    dockerhub.xxxxxxwan.cn/pub/nginx:latest                                                        &quot;/docker-entrypoint.â€¦&quot;    57 seconds ago        Up                  k8s://default/test-zgz/nginx</span><br><span class="line">a2f547c59e8f    dockerhub.xxxxxxwan.cn/pub/pause:3.9                                                           &quot;/pause&quot;                  About a minute ago    Up                  k8s://default/test-zgz</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nerdctl -n k8s.io inspect a2f547c59e8f | grep Resolv</span></span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/data/lv/lib/io.containerd.grpc.v1.cri/sandboxes/a2f547c59e8fc1d0dd1b6e5a9e35232211e9d4ce811a9101c45ed4d6bc9cf343/resolv.conf&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/lv/lib/io.containerd.grpc.v1.cri/sandboxes/a2f547c59e8fc1d0dd1b6e5a9e35232211e9d4ce811a9101c45ed4d6bc9cf343/resolv.conf</span></span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">nameserver 169.254.25.10</span><br><span class="line">options ndots:5</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nerdctl -n k8s.io restart a2f547c59e8f</span></span><br><span class="line">a2f547c59e8f</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nerdctl -n k8s.io ps -a | grep zgz</span></span><br><span class="line">13be2f142023    dockerhub.xxxxxxwan.cn/pub/nginx:latest                                                        &quot;/docker-entrypoint.â€¦&quot;    Less than a second ago    Up                  k8s://default/test-zgz/nginx</span><br><span class="line">cabe19fd2fd7    dockerhub.xxxxxxwan.cn/pub/pause:3.9                                                           &quot;/pause&quot;                  1 second ago              Up                  k8s://default/test-zgz</span><br><span class="line">d79ac72ea7a6    dockerhub.xxxxxxwan.cn/pub/nginx:latest                                                        &quot;/docker-entrypoint.â€¦&quot;    2 minutes ago             Created             k8s://default/test-zgz/nginx</span><br><span class="line">a2f547c59e8f    dockerhub.xxxxxxwan.cn/pub/pause:3.9                                                           &quot;/pause&quot;                  2 minutes ago             Up                  k8s://default/test-zgz</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nerdctl -n k8s.io ps -a | grep zgz</span></span><br><span class="line">13be2f142023    dockerhub.xxxxxxwan.cn/pub/nginx:latest                                                        &quot;/docker-entrypoint.â€¦&quot;    9 seconds ago     Up                  k8s://default/test-zgz/nginx</span><br><span class="line">cabe19fd2fd7    dockerhub.xxxxxxwan.cn/pub/pause:3.9                                                           &quot;/pause&quot;                  10 seconds ago    Up                  k8s://default/test-zgz</span><br><span class="line">d79ac72ea7a6    dockerhub.xxxxxxwan.cn/pub/nginx:latest                                                        &quot;/docker-entrypoint.â€¦&quot;    2 minutes ago     Created             k8s://default/test-zgz/nginx</span><br><span class="line">a2f547c59e8f    dockerhub.xxxxxxwan.cn/pub/pause:3.9                                                           &quot;/pause&quot;                  2 minutes ago     Up                  k8s://default/test-zgz</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nerdctl -n k8s.io inspect cabe19fd2fd7 | grep Resolv</span></span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/data/lv/lib/io.containerd.grpc.v1.cri/sandboxes/cabe19fd2fd75677f4ce77883697a76f66c425977c7cb358a3beb7da36d9d847/resolv.conf&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/lv/lib/io.containerd.grpc.v1.cri/sandboxes/cabe19fd2fd75677f4ce77883697a76f66c425977c7cb358a3beb7da36d9d847/resolv.conf</span></span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">nameserver 169.254.25.10</span><br><span class="line">options ndots:5</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">nerdctl -n k8s.io inspect 13be2f142023 | grep Resolv</span></span><br><span class="line">        &quot;ResolvConfPath&quot;: &quot;/data/lv/lib/io.containerd.grpc.v1.cri/sandboxes/cabe19fd2fd75677f4ce77883697a76f66c425977c7cb358a3beb7da36d9d847/resolv.conf&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /data/lv/lib/io.containerd.grpc.v1.cri/sandboxes/cabe19fd2fd75677f4ce77883697a76f66c425977c7cb358a3beb7da36d9d847/resolv.conf</span></span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">nameserver 169.254.25.10</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure><p>containerd æ²¡å¤ç°ï¼Œç®—äº†ï¼Œè¿˜æ˜¯æ issue å§ã€‚</p><h4 id="é‡å¯å¶å°”é‡å»ºPod"><a href="#é‡å¯å¶å°”é‡å»ºPod" class="headerlink" title="é‡å¯å¶å°”é‡å»ºPod"></a>é‡å¯å¶å°”é‡å»ºPod</h4><p>å¶å°”å‘ç°é‡å¯ <code>/pause</code> å®¹å™¨è¢« k8s é‡å»ºäº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker restart c213ae917535</span></span><br><span class="line">c213ae917535</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a | grep testpod</span></span><br><span class="line">427dbeb17e72   reg.xxx.lan:5000/xxx/nginx                                                       &quot;/docker-entrypoint.â€¦&quot;   2 seconds ago    Up 1 second                               k8s_vulnerable-container_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_8</span><br><span class="line">612bf2b23193   reg.xxx.lan:5000/xxx/pause:3.9                                                   &quot;/pause&quot;                  3 seconds ago    Up 1 second                               k8s_POD_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_8</span><br><span class="line">cbd04bc66cac   reg.xxx.lan:5000/xxx/nginx                                                       &quot;/docker-entrypoint.â€¦&quot;   10 minutes ago   Exited (0) 2 seconds ago                  k8s_vulnerable-container_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_7</span><br><span class="line">51a41d9884e4   reg.xxx.lan:5000/xxx/pause:3.9                                                   &quot;/pause&quot;                  10 minutes ago   Exited (0) 2 seconds ago                  k8s_POD_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_7</span><br><span class="line">c213ae917535   reg.xxx.lan:5000/xxx/pause:3.9                                                   &quot;/pause&quot;                  2 hours ago      Exited (0) 2 seconds ago                  k8s_POD_testpod_default_ebb8ace6-84ab-4a28-814c-109c41827908_6</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get event | grep testpod</span></span><br><span class="line">3s         Normal    Pulling             pod/testpod          Pulling image &quot;reg.xxx.lan:5000/xxx/nginx&quot;</span><br><span class="line">3s         Normal    Created             pod/testpod          Created container vulnerable-container</span><br><span class="line">3s         Normal    Started             pod/testpod          Started container vulnerable-container</span><br><span class="line">4s         Normal    SandboxChanged      pod/testpod          Pod sandbox changed, it will be killed and re-created.</span><br></pre></td></tr></table></figure><p>æœ <code>Pod sandbox changed</code> å¤§è‡´çœ‹äº†ä¸‹è¿™å— kubelet ä»£ç ï¼Œå°±æ˜¯åˆšå¥½æ£€æµ‹ Pod çš„ sandbox çŠ¶æ€å’Œé‡å¯è¡Œä¸ºé‡åˆå°±ä¼šå¯åŠ¨æ–°çš„å®¹å™¨é¿å…äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡ä¸æ˜¯ç™¾åˆ†ä¹‹ç™¾é‡åˆã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;docker ä¸‹ï¼Œé‡å¯ pod sandbox é€ æˆ dns å¼‚å¸¸çš„æ¢³ç†&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="sandbox" scheme="http://zhangguanzhang.github.io/tags/sandbox/"/>
    
  </entry>
  
  <entry>
    <title>docker open /var/lib/docker/tmp/GetImageBlobXXX: no such file çš„æ­£ç¡®å¤„ç†æ–¹å¼</title>
    <link href="http://zhangguanzhang.github.io/2025/11/06/docker-GetImageBlob-no-such/"/>
    <id>http://zhangguanzhang.github.io/2025/11/06/docker-GetImageBlob-no-such/</id>
    <published>2025-11-06T10:30:30.000Z</published>
    <updated>2025-11-06T10:30:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>docker open &#x2F;var&#x2F;lib&#x2F;docker&#x2F;tmp&#x2F;GetImageBlobXXX: no such file or directory. è§£å†³ </p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æµ‹è¯•åé¦ˆ <code>04:33</code> å‡ºåŒ…å¤±è´¥ï¼Œç›¸å…³æ­¥éª¤æŠ¥é”™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d -p 48835:5000 --name daily-master-K8S_XC-2298 -v /xxx/images:/var/lib/registry harbor.xxx.cn/xxx-base/registry:2.6.1</span></span><br><span class="line">Unable to find image &#x27;harbor.xxx.cn/xxx-base/registry&#x27; locally</span><br><span class="line">2.6.1: Pulling from xxx-base/registry</span><br><span class="line">53478ce18e19: Pulling fs layer</span><br><span class="line">907370c150a1: Pulling fs layer</span><br><span class="line">ecd89ee27260: Pulling fs layer</span><br><span class="line">e4d3e6950197: Pulling fs layer</span><br><span class="line">a0c226b30c4f: Pulling fs layer</span><br><span class="line">d4bda1830450: Pulling fs layer</span><br><span class="line">f441bc34ec75: Pulling fs layer</span><br><span class="line">877c19e43805: Pulling fs layer</span><br><span class="line">docker: open /work/docker/tmp/GetImageBlob838250894: no such file or directory.</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ docker è®¾ç½®äº† data-rootï¼Œå¦‚æœé»˜è®¤è·¯å¾„ä¼šæ˜¯ <code>open /var/lib/docker/tmp/GetImageBlob</code></p><h2 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h2><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>æ ¹æ®æ„å»ºæ—¥å¿—ï¼Œç™»å½•åˆ°æ„å»ºæœºå™¨ä¸Šï¼Œæ‰‹åŠ¨æ‹‰é•œåƒä¹Ÿå¤ç°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker pull harbor.xxx.cn/xxxx-run/gosu:v1</span></span><br><span class="line">v1: Pulling from xxxx-run/gosu</span><br><span class="line">e9abf7e9593f: Pulling fs layer </span><br><span class="line">open /work/docker/tmp/GetImageBlob159490514: no such file or directory</span><br></pre></td></tr></table></figure><p>å» jenkins ä¸Šçœ‹è¿™å°æœºå™¨æ²¡æ„å»ºä»»åŠ¡ï¼Œç»™æ ‡è®°ä¸‹çº¿çŠ¶æ€é¿å…å½±å“å…¶ä»–æ„å»ºã€‚</p><h3 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>è¿™ç§æŠ¥é”™å¾ˆç›´è§‚äº†ï¼Œä¸è¦é€ è½®å­å’Œè¦å­¦ä¼šå–„ç”¨æœç´¢å¼•æ“ï¼Œç»“æœæœåˆ°éƒ½æ˜¯è¯´é‡å¯ docker è§£å†³ï¼Œå¦‚æœä¸€ä¸ªå¼€æºé¡¹ç›®å­˜åœ¨ä¸€ä¸ªå¿…ç°é—®é¢˜ï¼Œé‚£å°±ä¸æ˜¯é—®é¢˜ï¼Œgolang é¡¹ç›®é‡Œå¦¥å–„ <code>return err</code> çš„è¯ï¼Œç›´æ¥æºç èƒ½æœåˆ°ç›¸å…³é€»è¾‘ï¼Œæºç é‡Œæœ <code>GetImageBlob</code> æœåˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/distribution/pull_v2.go#L1070C1-L1072C2</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createDownloadFile</span><span class="params">()</span></span> (*os.File, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> os.CreateTemp(<span class="string">&quot;&quot;</span>, <span class="string">&quot;GetImageBlob&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>os.CreateTemp</code> é»˜è®¤æ˜¯åœ¨ <code>/tmp/</code> ä¸‹åˆ›å»ºä¸´æ—¶æ–‡ä»¶çš„ï¼Œä½†æ˜¯å®é™…ç›®å½•æ˜¯æ‹¼æ¥äº†ï¼Œåº”è¯¥æœ‰åœ°æ–¹è®¾ç½®äº† tmp ç›¸å…³ envï¼Œå…ˆä» proc çœ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -ef | grep docker[d]</span></span><br><span class="line">root     23938     1  3 03:00 ?        00:19:00 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">xargs -0 -n1 &lt; /proc/23938/environ</span> </span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br><span class="line">NOTIFY_SOCKET=/run/systemd/notify</span><br><span class="line">LISTEN_PID=23938</span><br><span class="line">LISTEN_FDS=1</span><br></pre></td></tr></table></figure><p>ä» proc è¿›ç¨‹èƒ½ç¡®è®¤å¯åŠ¨çš„æ²¡æœ‰ <code>TMPDIR</code> ç›¸å…³ envï¼Œé‚£ä¹ˆåªæœ‰è¿›ç¨‹è‡ªå·± <code>os.Setenv</code> äº†ï¼Œæœ <code>TMPDIR</code> æœåˆ°ç›¸å…³é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/daemon/daemon.go#L841-L856</span></span><br><span class="line"><span class="comment">// set up the tmpDir to use a canonical path</span></span><br><span class="line">tmp, err := prepareTempDir(config.Root)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;Unable to get the TempDir under %s: %s&quot;</span>, config.Root, err)</span><br><span class="line">&#125;</span><br><span class="line">realTmp, err := fileutils.ReadSymlinkedDirectory(tmp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;Unable to get the full path to the TempDir (%s): %s&quot;</span>, tmp, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> isWindows &#123;</span><br><span class="line">        ...</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">os.Setenv(<span class="string">&quot;TMPDIR&quot;</span>, realTmp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·¯å¾„æ‹¼æ¥é€»è¾‘ç¡®è®¤äº†ï¼Œè¦ç¡®è®¤ err å“ªé‡ŒæŠ›å‡ºçš„ï¼Œæœä¸Šé¢çš„ <code>createDownloadFile</code> æ‰¾åˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/distribution/pull_v2.go#L169-L199</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ld *layerDescriptor)</span></span> Download(ctx context.Context, progressOutput progress.Output) (io.ReadCloser, <span class="type">int64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">log.G(ctx).Debugf(<span class="string">&quot;pulling blob %q&quot;</span>, ld.digest)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">err    <span class="type">error</span></span><br><span class="line">offset <span class="type">int64</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ld.tmpFile == <span class="literal">nil</span> &#123;</span><br><span class="line">ld.tmpFile, err = createDownloadFile()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="number">0</span>, xfer.DoNotRetry&#123;Err: err&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">offset, err = ld.tmpFile.Seek(<span class="number">0</span>, io.SeekEnd)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.G(ctx).Debugf(<span class="string">&quot;error seeking to end of download file: %v&quot;</span>, err)</span><br><span class="line">offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">ld.tmpFile.Close()</span><br><span class="line"><span class="keyword">if</span> err := os.Remove(ld.tmpFile.Name()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.G(ctx).Errorf(<span class="string">&quot;Failed to remove temp file: %s&quot;</span>, ld.tmpFile.Name())</span><br><span class="line">&#125;</span><br><span class="line">ld.tmpFile, err = createDownloadFile()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="number">0</span>, xfer.DoNotRetry&#123;Err: err&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> offset != <span class="number">0</span> &#123;</span><br><span class="line">log.G(ctx).Debugf(<span class="string">&quot;attempting to resume download of %q from %d bytes&quot;</span>, ld.digest, offset)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>err æ˜¯è¿™é™„è¿‘æŠ›å‡ºçš„ï¼Œå…·ä½“ä½ç½®ä¸çŸ¥é“ï¼Œä½†æ˜¯çœ‹æœ‰æ—¥å¿—æ‰“å°ï¼Œéœ€è¦æŸ¥çœ‹ä¸‹ docker daemon æ—¥å¿—ç¡®è®¤ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Nov 06 10:30:22 centos-xx dockerd[23938]: time=&quot;2025-11-06T10:30:22.290434484+08:00&quot; level=error msg=&quot;Download failed after 1 attempts: open /work/docker/tmp/GetImageBlob1655640392: no such file or directory&quot;</span><br><span class="line">Nov 06 10:48:51 centos-xx dockerd[23938]: time=&quot;2025-11-06T10:48:51.619866730+08:00&quot; level=error msg=&quot;Download failed after 1 attempts: open /work/docker/tmp/GetImageBlob1626967315: no such file or directory&quot;</span><br></pre></td></tr></table></figure><p>æœ <code>Download failed after</code> æœåˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/distribution/xfer/download.go#L274-L293</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">downloadReader, size, err = descriptor.Download(d.transfer.context(), progressOutput)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If an error was returned because the context</span></span><br><span class="line"><span class="comment">// was cancelled, we shouldn&#x27;t retry.</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-d.transfer.context().Done():</span><br><span class="line">d.err = err</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, isDNR := err.(DoNotRetry); isDNR || attempt &gt;= ldm.maxDownloadAttempts &#123;</span><br><span class="line">log.G(context.TODO()).Errorf(<span class="string">&quot;Download failed after %d attempts: %v&quot;</span>, attempt, err)</span><br><span class="line">d.err = err</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ç¡®è®¤ err æ˜¯ä¸Šé¢çš„ download é‡Œ return çš„ï¼Œä» daemon çš„æ—¥å¿—æ¥çœ‹ï¼Œè¯¥ err æ²¡æœ‰ç»è¿‡ <code>errors.Wrap</code> ç±»ä¼¼æ·»åŠ é¢å¤–ä¿¡æ¯ï¼Œåº”è¯¥å°±æ˜¯ <code>createDownloadFile()</code> æŠ›å‡ºçš„ syscall å±‚é¢ errorã€‚</p><p>æƒ³ç€ golang å†™ä¸€ä¸ª demo å¤ç°ï¼Œä½†æ˜¯æƒ³ç€ mktmp è¿™ä¸ªä¸ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„è¡Œä¸ºå—ï¼Œshell å°±è‡ªå¸¦ <code>mktemp</code> ç›¸å…³å‘½ä»¤ï¼Œå¤ç°ä¸‹çœ‹çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mktemp</span> /work/docker/tmp/test1111</span></span><br><span class="line">mktemp: too few X&#x27;s in template â€˜/work/docker/tmp/test1111â€™</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mktemp</span> /work/docker/tmp/testXXXX</span></span><br><span class="line">mktemp: failed to create file via template â€˜/work/docker/tmp/testXXXXâ€™: No such file or directory</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mktemp</span> /tmp/testXXX</span></span><br><span class="line">/tmp/testx1T</span><br></pre></td></tr></table></figure><p>work ç›®å½•æŒ‚è½½çš„ï¼Œæµ‹è¯•äº†ä¸‹è¯»å†™ä¹Ÿæ²¡é—®é¢˜ï¼Œç„¶åå‘ç°äº† docker data-root æ²¡æœ‰ tmp ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">touch</span> /work/docker/test1111</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -f /work/docker/test1111</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /work/docker/</span></span><br><span class="line">total 4</span><br><span class="line">drwx--x--x 4 root root 170 Nov  6 03:00 buildkit</span><br><span class="line">drwx--x--- 2 root root  10 Nov  6 03:00 containers</span><br><span class="line">-rw------- 1 root root  36 Nov  6 03:00 engine-id</span><br><span class="line">drwx------ 3 root root  30 Nov  6 03:00 image</span><br><span class="line">drwxr-x--- 3 root root  27 Nov  6 03:00 network</span><br><span class="line">drwx--x--- 3 root root  52 Nov  6 03:00 overlay2</span><br><span class="line">drwx------ 4 root root  44 Nov  6 03:00 plugins</span><br><span class="line">drwx------ 2 root root  10 Nov  6 03:00 swarm</span><br><span class="line">drwx-----x 2 root root  62 Nov  6 03:00 volumes</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºè¯¥ç›®å½•åå°±å¥½äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker pull harbor.xxx.cn/xxxx-run/gosu:v1</span></span><br><span class="line">v1: Pulling from xxxx-run/gosu</span><br><span class="line">e9abf7e9593f: Pulling fs layer </span><br><span class="line">open /work/docker/tmp/GetImageBlob1426925393: no such file or directory</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p /work/docker/tmp</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker pull harbor.xxx.cn/xxxx-run/gosu:v1</span></span><br><span class="line">v1: Pulling from xxxx-run/gosu</span><br><span class="line">e9abf7e9593f: Pull complete </span><br><span class="line">Digest: sha256:06ff9bb691ce53498f7dda976e0028639fb320f71513f6a41b4dd6761e989e78</span><br><span class="line">Status: Downloaded newer image for harbor.xxx.cn/xxxx-run/gosu:v1</span><br><span class="line">harbor.xxx.cn/xxxx-run/gosu:v1</span><br></pre></td></tr></table></figure><h3 id="æ ¹å› "><a href="#æ ¹å› " class="headerlink" title="æ ¹å› "></a>æ ¹å› </h3><p>åŸæœ¬æƒ³å¯åŠ¨ docker ååˆ›å»ºä¸‹ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">.d ç›®å½•çš„è¯ï¼Œå³ä½¿åç»­ docker æ›´æ–°ä¹Ÿä¸ä¼šåˆ æ‰ä¸‹é¢æ–‡ä»¶ï¼Œèƒ½æŒä¹…åŒ–ä½é€»è¾‘</span></span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d/</span><br><span class="line">cat &gt; /etc/systemd/system/docker.service.d/tmp.conf &lt;&lt; EOF</span><br><span class="line">[Service]</span><br><span class="line">ExecStartPost=/usr/bin/mkdir /work/docker/tmp</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æƒ³äº†ä¸‹ï¼Œåˆ«äººé‡å¯ docker èƒ½è§£å†³è¯´æ˜ docker daemon å¯åŠ¨æ˜¯ä¼šåˆ›å»ºè¿™ä¸ªç›®å½•çš„ï¼Œæœäº†ä¸‹ç¡®è®¤æœ‰å¦‚æ­¤é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v26.1.4/daemon/daemon.go#L1420-L1442</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// prepareTempDir prepares and returns the default directory to use</span></span><br><span class="line"><span class="comment">// for temporary files.</span></span><br><span class="line"><span class="comment">// If it doesn&#x27;t exist, it is created. If it exists, its content is removed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareTempDir</span><span class="params">(rootDir <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> tmpDir <span class="type">string</span></span><br><span class="line"><span class="keyword">if</span> tmpDir = os.Getenv(<span class="string">&quot;DOCKER_TMPDIR&quot;</span>); tmpDir == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">tmpDir = filepath.Join(rootDir, <span class="string">&quot;tmp&quot;</span>)</span><br><span class="line">newName := tmpDir + <span class="string">&quot;-old&quot;</span></span><br><span class="line"><span class="keyword">if</span> err := os.Rename(tmpDir, newName); err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := os.RemoveAll(newName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.G(context.TODO()).Warnf(<span class="string">&quot;failed to delete old tmp directory: %s&quot;</span>, newName)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> !os.IsNotExist(err) &#123;</span><br><span class="line">log.G(context.TODO()).Warnf(<span class="string">&quot;failed to rename %s for background deletion: %s. Deleting synchronously&quot;</span>, tmpDir, err)</span><br><span class="line"><span class="keyword">if</span> err := os.RemoveAll(tmpDir); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.G(context.TODO()).Warnf(<span class="string">&quot;failed to delete old tmp directory: %s&quot;</span>, tmpDir)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tmpDir, idtools.MkdirAllAndChown(tmpDir, <span class="number">0o700</span>, idtools.CurrentIdentity())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£å°±æ˜¯è¯´å¤–éƒ¨è¡Œä¸ºåˆ é™¤äº† tmp ç›®å½•å¯¼è‡´ï¼ŒæŸ¥çœ‹å®šæ—¶ä»»åŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crontab -l</span></span><br><span class="line">0 3 * * *  systemctl stop docker &amp;&amp; mv /work/docker /work/docker-$(date +\%Y\%m\%d) &amp;&amp; systemctl start docker</span><br><span class="line">15 3 * * * rm -rf /work/docker-*</span><br><span class="line">20 3 * * * find /work -maxdepth 1 -name &#x27;*dev*&#x27; -type d -ctime +1 | xargs rm -rf</span><br><span class="line">23 3 * * * find /work -maxdepth 1 -name &#x27;*test*&#x27; -type d -ctime +1 | xargs rm -rf</span><br><span class="line">25 3 * * * find /work -maxdepth 1 -name &#x27;*release*&#x27; -type d -ctime +1 | xargs rm -rf</span><br><span class="line">27 3 * * * find /work -maxdepth 1 -name &#x27;*openxxx*&#x27; -type d -ctime +1 | xargs rm -rf</span><br><span class="line">0 9-23/2 * * * python /data/epy/clean_dir.py  /work</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">0 9-23/2  * * *  docker system prune -f</span></span><br><span class="line">0 */2 * * * echo 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">*/30 * * * * python /data/prepullimage/pull_image.py </span><br></pre></td></tr></table></figure><p>æ ¹æ® <code>04:33</code> é™„è¿‘æ—¶é—´çœ‹æ²¡æœ‰ï¼Œè¯¢é—®äº†ä¸‹åŒäº‹å‘ç° jenkins æœ‰å®šæ—¶ <code>04:30</code> æ¸…ç†æœºå™¨ä¸Šçš„æ–‡ä»¶ï¼Œè°ƒæ•´åè§£å†³</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;docker open &amp;#x2F;var&amp;#x2F;lib&amp;#x2F;docker&amp;#x2F;tmp&amp;#x2F;GetImageBlobXXX: no such file or directory. è§£å†³ &lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="GetImageBlob" scheme="http://zhangguanzhang.github.io/tags/GetImageBlob/"/>
    
  </entry>
  
  <entry>
    <title>å¤šçº¿ç¨‹æ‰§è¡Œskopeo copy panicçš„ä¸€æ¬¡è§£å†³è¿‡ç¨‹</title>
    <link href="http://zhangguanzhang.github.io/2025/10/31/skopeo-copy-panic/"/>
    <id>http://zhangguanzhang.github.io/2025/10/31/skopeo-copy-panic/</id>
    <published>2025-10-31T17:30:30.000Z</published>
    <updated>2025-10-31T17:30:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¤šçº¿ç¨‹æ‰§è¡Œskopeo copy panicçš„ä¸€æ¬¡è§£å†³è¿‡ç¨‹</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å†…éƒ¨æ„å»ºå‡ºåŒ…å­˜åœ¨å¤§æ¦‚ä»¥ä¸‹é€»è¾‘ï¼š</p><ol><li>èµ·ä¸€ä¸ª registry å®¹å™¨ï¼Œå‡è®¾éšæœºç«¯å£ä¸º 45678</li><li>ç„¶åæŠŠç›¸å…³é•œåƒ skopeo copy ä»ç¼“å­˜çš„ harbor åŒæ­¥åˆ° registryå®¹å™¨</li><li>æ‰“åŒ…registryçš„ç›®å½•æˆä¸º <code>iamge-xxx.tgz</code></li></ol><p>ç„¶åå‘ç°è¿™å‡ å¤©æ‰“åŒ…æœ‰é—®é¢˜ï¼Œå¤šçº¿ç¨‹ skopeo copy æŠ¥é”™æ²¡å¤„ç†ï¼Œæœ€å <code>iamge-xxx.tgz</code> å¤§å°ä¸å¯¹ã€‚</p><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><h3 id="è°ƒç”¨é“¾åˆ†æ"><a href="#è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="è°ƒç”¨é“¾åˆ†æ"></a>è°ƒç”¨é“¾åˆ†æ</h3><p>æŸ¥çœ‹å‡ºåŒ…æ—¥å¿—ä¸€å †panicï¼Œç”±äºå¤šçº¿ç¨‹è°ƒç”¨çš„ï¼Œgolang çš„ panic å †æ ˆçš„é¡ºåºéƒ½é”™ä¹±äº†ï¼Œæ„å»ºæœºå™¨éƒ½æ˜¯ centos7ï¼Œéƒ½ä¸ç»´æŠ¤äº†ï¼Œä¸Šé¢çš„ skopeo é€šè¿‡åŒ…ç®¡ç†å®‰è£…çš„ï¼Œç‰ˆæœ¬æ¯”è¾ƒä½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">skopeo --version</span></span><br><span class="line">skopeo version 0.1.40</span><br></pre></td></tr></table></figure><p>æ ¹æ®ç‰ˆæœ¬å»æŸ¥çœ‹æºç æ‰¾è°ƒç”¨é“¾ï¼Œskopeo ä½¿ç”¨äº† cobra åº“ï¼Œä» <code>cmd/skopeo/copy.go</code> æ‰¾åˆ°å †æ ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/builddir/build/BUILD/skopeo-be6146b0a8471b02e776134119a2c37dfb70d414/cmd/skopeo/copy.go:159 +0x94b fp=0xc0005f3920 sp=0xc0005f3678 pc=0x559635b91b0b</span><br></pre></td></tr></table></figure><p>ä»£ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/containers/image/v5/copy&quot;</span></span><br><span class="line">    ....</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://github.com/containers/skopeo/blob/v0.1.40/cmd/skopeo/copy.go#L159-L167</span></span><br><span class="line">    _, err = <span class="built_in">copy</span>.Image(ctx, policyContext, destRef, srcRef, &amp;<span class="built_in">copy</span>.Options&#123;</span><br><span class="line">        RemoveSignatures:      opts.removeSignatures,</span><br><span class="line">        SignBy:                opts.signByFingerprint,</span><br><span class="line">        ReportWriter:          stdout,</span><br><span class="line">        SourceCtx:             sourceCtx,</span><br><span class="line">        DestinationCtx:        destinationCtx,</span><br><span class="line">        ForceManifestMIMEType: manifestType,</span><br><span class="line">        ImageListSelection:    imageListSelection,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><p>æ ¹æ®å¯¼åŒ…æ‰¾åˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/containers/skopeo/blob/v0.1.40/vendor/github.com/containers/image/v5/copy/copy.go#L173</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Image</span><span class="params">(ctx context.Context, policyContext *signature.PolicyContext, destRef, srcRef types.ImageReference, options *Options)</span></span> (copiedManifest []<span class="type">byte</span>, retErr <span class="type">error</span>) &#123;</span><br></pre></td></tr></table></figure><p>ä¾¿äºæŸ¥æ‰¾ï¼Œç»™æ‰€æœ‰å †æ ˆå­—ç¬¦ä¸²ä¿å­˜åˆ°æ–‡ä»¶é‡Œï¼Œä»è¾“å‡ºæ··ä¹±çš„å †æ ˆå­—ç¬¦ä¸²é‡Œæœç´¢ <code>copy/copy.go:</code> æ‰¾åˆ°:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Po <span class="string">&#x27;vendor.*?/copy/copy.go:\d+&#x27;</span> txt | sort -u</span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">1337</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">258</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">578</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">740</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">755</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">765</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">766</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">770</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">771</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">860</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">948</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">949</span></span><br><span class="line">vendor/src/github.com/containers/image/v5/pkg/blobinfocache/boltdb/boltdb.go0x105/builddir/build/BUILD/skopeo-be6146b0a8471b02e776134119a2c37dfb70d414/vendor/src/github.com/containers/image/v5/<span class="built_in">copy</span>/<span class="built_in">copy</span>.<span class="keyword">go</span>:<span class="number">174</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢ä¿¡æ¯å’Œæºç ï¼Œè°ƒç”¨é“¾ä¸ºï¼š</p><ul><li><code>copy/copy.go#L173</code> çš„ <code>func Image(ctx context.Context,</code></li><li><code>copy/copy.go#L258</code> çš„ <code>if copiedManifest, _, _, err = c.copyOneImage(</code></li><li><code>copy/copy.go#L473</code> çš„ <code>func (c *copier) copyOneImage</code></li><li><code>copy/copy.go#L578</code> çš„ <code>if err := ic.copyLayers(ctx);</code></li><li><code>copy/copy.go#L704</code> çš„ <code>func (ic *imageCopier) copyLayers(ctx context.Context)</code></li><li><code>copy/copy.go:766</code> çš„ <code>go copyLayerHelper(i, srcLayer, progressPool)ï¼Œè€Œè¯¥æ–¹æ³•æ˜¯ä¸‹é¢é—­åŒ…å£°æ˜çš„</code></li><li><code>copy/copy.go:755</code> çš„ <code>cld.destInfo, cld.diffID, cld.err = ic.copyLayer(ctx, srcLayer, pool) </code></li><li><code>copy/copy.go:948</code> çš„ <code>func (ic *imageCopier) copyLayer(ctxï¼Œç„¶åèµ°åˆ°å†…éƒ¨ç¬¬ä¸€è¡Œ</code></li><li><code>copy/copy.go:949</code> çš„ <code>cachedDiffID := ic.c.blobInfoCache.UncompressedDigest(srcInfo.Digest)</code></li></ul><p>è€Œæ–¹æ³• <code>UncompressedDigest</code> æ˜¯æ¥å£ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/containers/skopeo/blob/v0.1.40/vendor/github.com/containers/image/v5/types/types.go#L177-L198</span></span><br><span class="line"><span class="keyword">type</span> BlobInfoCache <span class="keyword">interface</span> &#123;</span><br><span class="line"></span><br><span class="line">    UncompressedDigest(anyDigest digest.Digest) digest.Digest</span><br><span class="line"></span><br><span class="line">    RecordDigestUncompressedPair(anyDigest digest.Digest, uncompressed digest.Digest)</span><br><span class="line">    RecordKnownLocation(transport ImageTransport, scope BICTransportScope, digest digest.Digest, location BICLocationReference)</span><br><span class="line">    CandidateLocations(transport ImageTransport, scope BICTransportScope, digest digest.Digest, canSubstitute <span class="type">bool</span>) []BICReplacementCandidate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ <code>ic.c.blobInfoCache</code> é‡Œçš„ <code>blobInfoCache</code> èµ‹å€¼ï¼Œæœåˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/containers/skopeo/blob/v0.1.40/vendor/github.com/containers/image/v5/copy/copy.go#L173-L233</span></span><br><span class="line">blobInfoCache: blobinfocache.DefaultCache(options.DestinationCtx)</span><br></pre></td></tr></table></figure><p>ç„¶åå‘ç°æ˜¯ boltdb å­˜å‚¨ cacheï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/containers/skopeo/blob/v0.1.40/vendor/github.com/containers/image/v5/pkg/blobinfocache/default.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DefaultCache</span><span class="params">(sys *types.SystemContext)</span></span> types.BlobInfoCache &#123;</span><br><span class="line">    dir, err := blobInfoCacheDir(sys, getRootlessUID())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logrus.Debugf(<span class="string">&quot;Error determining a location for %s, using a memory-only cache&quot;</span>, blobInfoCacheFilename)</span><br><span class="line">        <span class="keyword">return</span> memory.New()</span><br><span class="line">    &#125;</span><br><span class="line">    path := filepath.Join(dir, blobInfoCacheFilename)</span><br><span class="line">    <span class="keyword">if</span> err := os.MkdirAll(dir, <span class="number">0700</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logrus.Debugf(<span class="string">&quot;Error creating parent directories for %s, using a memory-only cache: %v&quot;</span>, blobInfoCacheFilename, err)</span><br><span class="line">        <span class="keyword">return</span> memory.New()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logrus.Debugf(<span class="string">&quot;Using blob info cache at %s&quot;</span>, path)</span><br><span class="line">    <span class="keyword">return</span> boltdb.New(path)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å¤±è´¥æ„å»ºçš„æ„å»ºæœºå™¨ä¸Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /var/lib/containers/cache</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l</span></span><br><span class="line">total 25740</span><br><span class="line">-rw------- 1 root root 43134976 Oct 28 12:31 blob-info-cache-v1.boltdb</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -al</span></span><br><span class="line">total 25740</span><br><span class="line">drwx------ 2 root root       39 Aug 27 14:18 .</span><br><span class="line">drwxr-xr-x 4 root root       35 Aug 27 14:18 ..</span><br><span class="line">-rw------- 1 root root 43134976 Oct 28 12:31 blob-info-cache-v1.boltdb</span><br></pre></td></tr></table></figure><p>å’Œå †æ ˆé‡Œçš„ boltdb ç›¸å…³å †æ ˆä¹Ÿå¯¹çš„ä¸Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -Po <span class="string">&#x27;blobinfocache/boltdb/boltdb.go:\d+&#x27;</span> txt  | <span class="built_in">sort</span> -u</span></span><br><span class="line">blobinfocache/boltdb/boltdb.go:108</span><br><span class="line">blobinfocache/boltdb/boltdb.go:112</span><br><span class="line">blobinfocache/boltdb/boltdb.go:114</span><br><span class="line">blobinfocache/boltdb/boltdb.go:119</span><br><span class="line">blobinfocache/boltdb/boltdb.go:124</span><br><span class="line">blobinfocache/boltdb/boltdb.go:146</span><br><span class="line">blobinfocache/boltdb/boltdb.go:172</span><br><span class="line">blobinfocache/boltdb/boltdb.go:174</span><br><span class="line">blobinfocache/boltdb/boltdb.go:175</span><br><span class="line">blobinfocache/boltdb/boltdb.go:3010</span><br><span class="line">blobinfocache/boltdb/boltdb.go:54</span><br><span class="line">blobinfocache/boltdb/boltdb.go:56</span><br><span class="line">blobinfocache/boltdb/boltdb.go:58</span><br><span class="line">blobinfocache/boltdb/boltdb.go:65</span><br><span class="line">blobinfocache/boltdb/boltdb.go:66</span><br><span class="line">blobinfocache/boltdb/boltdb.go:67</span><br><span class="line">blobinfocache/boltdb/boltdb.go:84</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨é“¾å°±ä¸ç»†è‡´åˆ†æäº†ï¼Œç¡®å®šæ˜¯ <code>uncompressedDigest</code> æ–¹æ³•é‡Œ boltdb é—®é¢˜ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/containers/skopeo/blob/v0.1.40/vendor/github.com/containers/image/v5/pkg/blobinfocache/boltdb/boltdb.go#L145C1-L146C57</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bdc *cache)</span></span> uncompressedDigest(tx *bolt.Tx, anyDigest digest.Digest) digest.Digest &#123;</span><br><span class="line">    <span class="keyword">if</span> b := tx.Bucket(uncompressedDigestBucket); b != <span class="literal">nil</span> &#123;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰é—®é¢˜çš„è¯å°±è¯´æ˜ boltdb æ–‡ä»¶æŸåï¼Œboltdb æ–‡ä»¶æŸåçš„è¯ï¼Œdocker å’Œ etcd éƒ½èƒ½é‡åˆ°ï¼Œæœå…³é”®å­—å°±çŸ¥é“äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep invalid txt</span></span><br><span class="line">panic: invalid page type: 6432: 10</span><br></pre></td></tr></table></figure><h3 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h3><p>å†™ä¸ª boltdb æŸ¥çœ‹ Bucket çš„ cli å¤ç°ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    bolt <span class="string">&quot;go.etcd.io/bbolt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &lt; <span class="number">2</span> &#123;</span><br><span class="line">        fmt.Fprintf(os.Stderr, <span class="string">&quot;Usage: %s &lt;bolt-db-file&gt;\n&quot;</span>, os.Args[<span class="number">0</span>])</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    filename := os.Args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    db, err := bolt.Open(filename, <span class="number">0600</span>, &amp;bolt.Options&#123;ReadOnly: <span class="literal">true</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;failed to open %s: %v&quot;</span>, filename, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">    err = db.View(<span class="function"><span class="keyword">func</span><span class="params">(tx *bolt.Tx)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Top-level buckets in %s:\n&quot;</span>, filename)</span><br><span class="line">        <span class="keyword">return</span> tx.ForEach(<span class="function"><span class="keyword">func</span><span class="params">(name []<span class="type">byte</span>, _ *bolt.Bucket)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;- %s\n&quot;</span>, name)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‹·è´åˆ°æ„å»ºæœºå™¨ä¸Šæ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./bbolt-tool blob-info-cache-v1.boltdb</span></span><br><span class="line">Top-level buckets in blob-info-cache-v1.boltdb:</span><br><span class="line">panic: invalid page type: 6432: 10</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">go.etcd.io/bbolt.(*Cursor).search(0xc0000a5cd8, &#123;0x7ff6b8ff8130, 0x47, 0x47&#125;, 0x0?)</span><br><span class="line">        /root/go/pkg/mod/go.etcd.io/bbolt@v1.4.3/cursor.go:286 +0x279</span><br><span class="line">go.etcd.io/bbolt.(*Cursor).seek(0xc0000a5cd8, &#123;0x7ff6b8ff8130?, 0xc000080140?, 0xc0000ac040?&#125;)</span><br><span class="line">        /root/go/pkg/mod/go.etcd.io/bbolt@v1.4.3/cursor.go:162 +0x2e</span><br><span class="line">go.etcd.io/bbolt.(*Bucket).Bucket(0xc0000aa018, &#123;0x7ff6b8ff8130, 0x47, 0x4e8c40?&#125;)</span><br><span class="line">        /root/go/pkg/mod/go.etcd.io/bbolt@v1.4.3/bucket.go:97 +0xb6</span><br><span class="line">main.main.func1.(*Tx).ForEach.2(&#123;0x7ff6b8ff8130, 0x47, 0x47&#125;, &#123;0xc0000a5dd8?, 0x1?, 0x1?&#125;)</span><br><span class="line">        /root/go/pkg/mod/go.etcd.io/bbolt@v1.4.3/tx.go:158 +0x45</span><br><span class="line">go.etcd.io/bbolt.(*Bucket).ForEach(0x51c268?, 0xc0000a5de8)</span><br><span class="line">        /root/go/pkg/mod/go.etcd.io/bbolt@v1.4.3/bucket.go:591 +0x89</span><br><span class="line">go.etcd.io/bbolt.(*Tx).ForEach(...)</span><br><span class="line">        /root/go/pkg/mod/go.etcd.io/bbolt@v1.4.3/tx.go:157</span><br><span class="line">main.main.func1(0xc0000aa000)</span><br><span class="line">        /root/code/golang/bbolt/main.go:26 +0x9d</span><br><span class="line">go.etcd.io/bbolt.(*DB).View(0x7ffca6c567a8?, 0xc0000a5f00)</span><br><span class="line">        /root/go/pkg/mod/go.etcd.io/bbolt@v1.4.3/db.go:939 +0x6c</span><br><span class="line">main.main()</span><br><span class="line">        /root/code/golang/bbolt/main.go:24 +0x1f0</span><br><span class="line">        </span><br><span class="line">        </span><br></pre></td></tr></table></figure><p>æ­£å¸¸æ„å»ºæœºå™¨ä¸Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./bbolt-tool blob-info-cache-v1.boltdb</span> </span><br><span class="line">Top-level buckets in blob-info-cache-v1.boltdb:</span><br><span class="line">- knownLocations</span><br></pre></td></tr></table></figure><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><p>æ ¹æ®ä¸Šé¢æ–¹æ³• <code>DefaultCache</code> å¯ä»¥æŠŠ path åˆ›å»ºæˆæ–‡ä»¶ï¼Œè®©èµ°å†…å­˜ç¼“å­˜ï¼Œä½†æ˜¯æŸ¥çœ‹äº†ä¸‹æ–°ç‰ˆæœ¬ skopeo å·²ç»é»˜è®¤ä½¿ç”¨ <code>sqlite</code> ç¼“å­˜äº†ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If the format changes in an incompatible way, increase the version number.</span></span><br><span class="line">blobInfoCacheFilename = <span class="string">&quot;blob-info-cache-v1.sqlite&quot;</span></span><br><span class="line"><span class="comment">// systemBlobInfoCacheDir is the directory containing the blob info cache (in blobInfocacheFilename) for root-running processes.</span></span><br><span class="line">systemBlobInfoCacheDir = <span class="string">&quot;/var/lib/containers/cache&quot;</span></span><br></pre></td></tr></table></figure><p>æ”¹ä¸ºä½¿ç”¨æ–°ç‰ˆæœ¬ skopeo ï¼Œä»¥åŠç›¸å…³å¤šçº¿ç¨‹çš„è¾“å‡ºä¹ŸåŠ äº†å‰ç¼€ï¼Œé¿å…ä¸‹æ¬¡ç±»ä¼¼é—®é¢˜å †æ ˆæ··ä¹±ã€‚ç„¶åå‘ç°è€ç‰ˆæœ¬åˆ†æ”¯è¿˜æ˜¯ä¼šèµ°è€é€»è¾‘ï¼Œæ„å»ºæœºå™¨ä¸ŠæŠŠè¿™ä¸ª boltdb æ–‡ä»¶ mv ä¸‹é¿å…å½±å“å…¶ä»–åˆ†æ”¯ï¼Œ</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¤šçº¿ç¨‹æ‰§è¡Œskopeo copy panicçš„ä¸€æ¬¡è§£å†³è¿‡ç¨‹&lt;/p&gt;</summary>
    
    
    
    
    <category term="skopeo" scheme="http://zhangguanzhang.github.io/tags/skopeo/"/>
    
    <category term="boltdb" scheme="http://zhangguanzhang.github.io/tags/boltdb/"/>
    
  </entry>
  
  <entry>
    <title>ç¦»çº¿å®‰è£…dockerå’ŒåŒ…ç®¡ç†å®‰è£…dockerä¸‹containerdçš„å¯åŠ¨ç›¸å…³</title>
    <link href="http://zhangguanzhang.github.io/2025/10/23/docker-bin-containerd/"/>
    <id>http://zhangguanzhang.github.io/2025/10/23/docker-bin-containerd/</id>
    <published>2025-10-23T17:10:30.000Z</published>
    <updated>2025-10-23T17:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç®€å•ç§‘æ™®ä¸‹ docker å¯åŠ¨æ—¶å€™å’Œ contaienrd ç›¸å…³</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æ˜¨å¤©å¤„ç†äº†ä¸€ä¸ªç°åœº docker èµ·ä¸æ¥çš„é—®é¢˜ï¼Œå€Ÿç€å¤„ç†è¿‡ç¨‹ç§‘æ™®ä¸‹ã€‚docker æ— æ³•å¯åŠ¨æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journarlctl -xe --no-pager -u docker</span></span><br><span class="line">Oct 23 17:28:33 XXX251023S00P systemd[1]: docker.service: Unit entered failed state.</span><br><span class="line">Oct 23 17:28:33 XXX251023S00P systemd[1]: docker.service: Failed with result &#x27;exit-code&#x27;.</span><br><span class="line">Oct 23 17:28:43 XXX251023S00P systemd[1]: docker.service: Service RestartSec=10s expired, scheduling restart.</span><br><span class="line">Oct 23 17:28:43 XXX251023S00P systemd[1]: Stopped Docker Application Container Engine.</span><br><span class="line">-- Subject: Unit docker.service has finished shutting down</span><br><span class="line">-- Defined-By: systemd</span><br><span class="line">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="line">-- </span><br><span class="line">-- Unit docker.service has finished shutting down.</span><br><span class="line">Oct 23 17:28:43 XXX251023S00P systemd[1]: Starting Docker Application Container Engine...</span><br><span class="line">-- Subject: Unit docker.service has begun start-up</span><br><span class="line">-- Defined-By: systemd</span><br><span class="line">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="line">-- </span><br><span class="line">-- Unit docker.service has begun starting up.</span><br><span class="line">Oct 23 17:28:43 XXX251023S00P dockerd[7355]: time=&quot;2025-10-23T17:28:43+08:00&quot; level=info msg=&quot;SUSE:secrets :: enabled&quot;</span><br><span class="line">Oct 23 17:28:44 XXX251023S00P dockerd[7355]: time=&quot;2025-10-23T17:28:44.000689797+08:00&quot; level=warning msg=&quot;The \&quot;graph\&quot; config file option is deprecated. Please use \&quot;data-root\&quot; instead.&quot;</span><br><span class="line">Oct 23 17:28:44 XXX251023S00P dockerd[7355]: time=&quot;2025-10-23T17:28:44.064839553+08:00&quot; level=warning msg=&quot;grpc: addrConn.createTransport failed to connect to &#123;unix:///run/containerd/containerd.sock 0  &lt;nil&gt;&#125;. Err :connection error: desc = \&quot;transport: Error while dialing dial unix /run/containerd/containerd.sock: connect: connection refused\&quot;. Reconnecting...&quot; module=grpc</span><br><span class="line">Oct 23 17:28:45 XXX251023S00P dockerd[7355]: time=&quot;2025-10-23T17:28:45.065163178+08:00&quot; level=warning msg=&quot;grpc: addrConn.createTransport failed to connect to &#123;unix:///run/containerd/containerd.sock 0  &lt;nil&gt;&#125;. Err :connection error: desc = \&quot;transport: Error while dialing dial unix /run/containerd/containerd.sock: connect: connection refused\&quot;. Reconnecting...&quot; module=grpc</span><br></pre></td></tr></table></figure><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><p>ä¸Šé¢æ—¥å¿—å³è¾¹æ»‘åŠ¨æŸ¥çœ‹ï¼Œæ ¸å¿ƒæŠ¥é”™æ˜¯ <code>Error while dialing dial unix /run/containerd/containerd.sock: connect: connection refused</code> ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜è¦å…ˆäº†è§£ä¸‹ docker å’Œ containerd å¯åŠ¨ç›¸å…³ã€‚</p><h3 id="åŒ…ç®¡ç†ä¸‹çš„-docker-å’Œ-containerd"><a href="#åŒ…ç®¡ç†ä¸‹çš„-docker-å’Œ-containerd" class="headerlink" title="åŒ…ç®¡ç†ä¸‹çš„ docker å’Œ containerd"></a>åŒ…ç®¡ç†ä¸‹çš„ docker å’Œ containerd</h3><p>docker damon å’Œ containerd æ˜¯å­˜åœ¨äº¤äº’è€Œå·¥ä½œçš„ï¼Œå¦‚æœæ˜¯åŒ…ç®¡ç†å®‰è£…çš„ dockerï¼Œä¼šæœ‰ä¸¤ä¸ª systemd service æ–‡ä»¶ï¼š</p><ul><li>containerd åŒ…æä¾› <code>containerd.service</code> æ–‡ä»¶</li><li>docker-ce çš„ <code>docker.service</code></li></ul><p>è¿™é‡Œä»¥ rpm åŒ…ä¸¾ä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -qa | grep -P <span class="string">&#x27;containerd&#x27;</span></span></span><br><span class="line">containerd.io-1.6.33-3.1.el7.x86_64</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -ql containerd.io | grep -Ev <span class="string">&#x27;/(doc|licen|man)&#x27;</span></span></span><br><span class="line">/etc/containerd</span><br><span class="line">/etc/containerd/config.toml</span><br><span class="line">/usr/bin/containerd</span><br><span class="line">/usr/bin/containerd-shim</span><br><span class="line">/usr/bin/containerd-shim-runc-v1</span><br><span class="line">/usr/bin/containerd-shim-runc-v2</span><br><span class="line">/usr/bin/ctr</span><br><span class="line">/usr/bin/runc</span><br><span class="line">/usr/lib/systemd/system/containerd.service</span><br></pre></td></tr></table></figure><p>è€ŒåŒ…ç®¡ç† docker.service æœ‰ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl <span class="built_in">cat</span> --no-pager  docker | grep containerd.service</span></span><br><span class="line">After=network-online.target docker.socket firewalld.service containerd.service time-set.target</span><br><span class="line">Wants=network-online.target containerd.service</span><br></pre></td></tr></table></figure><h3 id="äºŒè¿›åˆ¶å®‰è£…-docker"><a href="#äºŒè¿›åˆ¶å®‰è£…-docker" class="headerlink" title="äºŒè¿›åˆ¶å®‰è£… docker"></a>äºŒè¿›åˆ¶å®‰è£… docker</h3><p>æˆ‘ä»¬ç§æœ‰åŒ–å°±æ˜¯ docker ç¦»çº¿å®‰è£…çš„ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://docs.docker.com/engine/install/binaries/">https://docs.docker.com/engine/install/binaries/</a> ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…ï¼Œä½†æ˜¯å®˜æ–¹æ–‡æ¡£æ²¡æœ‰è¯´ systemd service æ–‡ä»¶è·å–ã€‚ä»¥åŠæˆ‘æ¥æ‰‹åå‘ç°ä¹Ÿæ²¡æœ‰åˆ›å»º containerd.service çº³ç®¡ containerdï¼Œä½†æ˜¯ docker ä¹Ÿèƒ½è¿è¡Œï¼ŒæŸ¥çœ‹ docker å­è¿›ç¨‹èƒ½çœ‹åˆ°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl status docker</span></span><br><span class="line">â— docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/docker.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since ä¸‰ 2025-10-22 16:44:38 CST; 1 day 1h ago</span><br><span class="line">     Docs: http://docs.docker.io</span><br><span class="line"> Main PID: 16487 (dockerd)</span><br><span class="line">    Tasks: 167</span><br><span class="line">   Memory: 6.1G</span><br><span class="line">   CGroup: /system.slice/docker.service</span><br><span class="line">...</span><br><span class="line">           â”œâ”€16506 containerd --config /var/run/docker/containerd/containerd.toml --log-level warn</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¯´æ˜ docker è‚¯å®šå†…éƒ¨åç¨‹èµ·äº† containerd è¿›ç¨‹ï¼Œä½ç‰ˆæœ¬ containerd åå­—å¯èƒ½æ˜¯ <code>docker-containerd</code> ã€‚<br>é€†å‘æ€ç»´æŸ¥ä¸‹æºç ï¼Œå› ä¸ºåç¨‹èµ· containerd è¿›ç¨‹ï¼Œè‚¯å®šä¼šæ‹¼æ¥ cmdlineï¼Œæºç æœç´¢ <code>--config</code> æ‰¾åˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v19.03.15/libcontainerd/supervisor/remote_daemon.go#L165C1-L212C5</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *remote)</span></span> startContainerd() <span class="type">error</span> &#123;</span><br><span class="line">    pid, err := r.getContainerdPid()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pid != <span class="number">-1</span> &#123;</span><br><span class="line">        r.daemonPid = pid</span><br><span class="line">        logrus.WithField(<span class="string">&quot;pid&quot;</span>, pid).</span><br><span class="line">            Infof(<span class="string">&quot;libcontainerd: %s is still running&quot;</span>, binaryName)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    configFile, err := r.getContainerdConfig()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    args := []<span class="type">string</span>&#123;<span class="string">&quot;--config&quot;</span>, configFile&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> r.Debug.Level != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        args = <span class="built_in">append</span>(args, <span class="string">&quot;--log-level&quot;</span>, r.Debug.Level)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmd := exec.Command(binaryName, args...)</span><br><span class="line">    <span class="comment">// redirect containerd logs to docker logs</span></span><br><span class="line">    cmd.Stdout = os.Stdout</span><br><span class="line">    cmd.Stderr = os.Stderr</span><br><span class="line">    cmd.SysProcAttr = containerdSysProcAttr()</span><br><span class="line">    <span class="comment">// clear the NOTIFY_SOCKET from the env when starting containerd</span></span><br><span class="line">    cmd.Env = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">for</span> _, e := <span class="keyword">range</span> os.Environ() &#123;</span><br><span class="line">        <span class="keyword">if</span> !strings.HasPrefix(e, <span class="string">&quot;NOTIFY_SOCKET&quot;</span>) &#123;</span><br><span class="line">            cmd.Env = <span class="built_in">append</span>(cmd.Env, e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := cmd.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.daemonWaitCh = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Reap our child when needed</span></span><br><span class="line">        <span class="keyword">if</span> err := cmd.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            r.logger.WithError(err).Errorf(<span class="string">&quot;containerd did not exit successfully&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(r.daemonWaitCh)</span><br><span class="line">    &#125;()</span><br></pre></td></tr></table></figure><p>ç„¶ååå‘æ‰¾ <code>startContainerd()</code> çš„è°ƒç”¨é“¾ï¼š</p><ul><li>åŒæ–‡ä»¶çš„ <code>func (r *remote) monitorDaemon(ctx context.Context) { </code></li><li>åŒæ–‡ä»¶çš„ <code>func Start(</code></li><li>å› ä¸º <code>Start</code> æ–¹æ³•å¤§å†™ï¼Œè‚¯å®šåœ¨å…¶ä»–åœ°æ–¹åŒ…å¯¼å…¥ï¼Œæœ <code>supervisor.Start</code> æ‰¾åˆ°</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v19.03.15/cmd/dockerd/daemon_unix.go#L152C1-L171</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli *DaemonCli)</span></span> initContainerD(ctx context.Context) (<span class="function"><span class="keyword">func</span><span class="params">(time.Duration)</span></span> <span class="type">error</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> waitForShutdown <span class="function"><span class="keyword">func</span><span class="params">(time.Duration)</span></span> <span class="type">error</span></span><br><span class="line">    <span class="keyword">if</span> cli.Config.ContainerdAddr == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        systemContainerdAddr, ok, err := systemContainerdRunning(honorXDG)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;could not determine whether the system containerd is running&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            logrus.Debug(<span class="string">&quot;Containerd not running, starting daemon managed containerd&quot;</span>)</span><br><span class="line">        opts, err := cli.getContainerdDaemonOpts()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;failed to generate containerd options&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r, err := supervisor.Start(ctx, filepath.Join(cli.Config.Root, <span class="string">&quot;containerd&quot;</span>), filepath.Join(cli.Config.ExecRoot, <span class="string">&quot;containerd&quot;</span>), opts...)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrap(err, <span class="string">&quot;failed to start containerd&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        logrus.Debug(<span class="string">&quot;Started daemon managed containerd&quot;</span>)</span><br><span class="line">        cli.Config.ContainerdAddr = r.Address()</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç é€»è¾‘å°±æ˜¯ <code>systemContainerdRunning</code> æ–¹æ³•åˆ¤æ–­ <code>containerd</code> æ˜¯å¦è¿è¡Œï¼Œæ²¡æœ‰è¿è¡Œå°±è°ƒç”¨ <code>supervisor.Start</code> å¯åŠ¨ containerdï¼ŒæŸ¥çœ‹ <code>systemContainerdRunning</code> å†…éƒ¨å®ç°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/moby/moby/blob/v19.03.15/cmd/dockerd/daemon.go#L691C1-L702C2</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">systemContainerdRunning</span><span class="params">(honorXDG <span class="type">bool</span>)</span></span> (<span class="type">string</span>, <span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    addr := containerddefaults.DefaultAddress</span><br><span class="line">    <span class="keyword">if</span> honorXDG &#123;</span><br><span class="line">        runtimeDir, err := homedir.GetRuntimeDir()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="literal">false</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        addr = filepath.Join(runtimeDir, <span class="string">&quot;containerd&quot;</span>, <span class="string">&quot;containerd.sock&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    _, err := os.Lstat(addr)</span><br><span class="line">    <span class="keyword">return</span> addr, err == <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯æŸ¥çœ‹è¿æ¥ containerd çš„ grpc sock æ–‡ä»¶ <code>/run/containerd/containerd.sock</code> å­˜åœ¨å¦åˆ¤æ–­æ˜¯å¦è¿è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ systemd å¯åŠ¨äº† containerdï¼Œdocker daemon å°±ä¸ <code>supervisor.Start</code> å¯åŠ¨ containerd å­è¿›ç¨‹ã€‚</p><p>ç°åœºçš„æ˜¯ suse docker rpm åŒ…å®‰è£…çš„ï¼Œæœ‰ containerd çš„ rpm åŒ…ï¼Œæ‰å‘ç°é‡Œé¢æ²¡ service æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯èµ°æºç å­è¿›ç¨‹é€»è¾‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -ql containerd</span></span><br><span class="line">/etc/containerd</span><br><span class="line">/etc/containerd/config.toml/usr/sbin/containerd</span><br><span class="line">/usr/sbin/containerd-shim</span><br><span class="line">/usr/sbin/docker-containerd</span><br><span class="line">/usr/sbin/docker-containerd-shim</span><br><span class="line">/usr/share/doc/packages/containerd</span><br><span class="line">/usr/share/doc/packages/containerd/README</span><br><span class="line">/usr/share/licenses/containerd</span><br><span class="line">/usr/share/licenses/containerd/LICENSE</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æœç„¶æ˜¯æœ‰ sock æ–‡ä»¶è€Œæ²¡ containerd è¿›ç¨‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /run/containerd/</span></span><br><span class="line">total 28</span><br><span class="line">srw-rw---- 1 root root     0 Oct 23 15:20 containerd.sock</span><br><span class="line">-rwxr-xr-x 1 root root 25651 Oct 23 15:26 events.log</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -ef | grep container[d]</span></span><br></pre></td></tr></table></figure><p>åˆ æ‰è¯¥æ–‡ä»¶åé‡èµ· docker è§£å†³ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç®€å•ç§‘æ™®ä¸‹ docker å¯åŠ¨æ—¶å€™å’Œ contaienrd ç›¸å…³&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="containerd" scheme="http://zhangguanzhang.github.io/tags/containerd/"/>
    
  </entry>
  
  <entry>
    <title>keepalived Locking pid file error 22 - Invalid argument</title>
    <link href="http://zhangguanzhang.github.io/2025/10/17/keepalived-locking-pid-file-invalid/"/>
    <id>http://zhangguanzhang.github.io/2025/10/17/keepalived-locking-pid-file-invalid/</id>
    <published>2025-10-17T18:10:30.000Z</published>
    <updated>2025-10-17T18:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ç°åœºéƒ¨ç½²ä¸šåŠ¡åå‘ç°è®¿é—®æœ‰é—®é¢˜ï¼Œæ’æŸ¥åå‘ç°ä¸šåŠ¡ç½‘å…³è®¿é—® etcd çš„ <a href="https://zhangguanzhang.github.io/2021/09/28/ipvs-svc/">keepalived IPVS svc</a> ä¸é€š</p><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><h3 id="åŸºç¡€æ’æŸ¥"><a href="#åŸºç¡€æ’æŸ¥" class="headerlink" title="åŸºç¡€æ’æŸ¥"></a>åŸºç¡€æ’æŸ¥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl 169.254.20.4:12379</span></span><br><span class="line">curl: (7) Failed to connect to 169.254.20.4 port 12379: Connection refused</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯æˆ‘ä»¬ etcd çš„ svc çš„ï¼Œcurl <code>real server</code> æ­£å¸¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl &lt;æœ¬æœºIP&gt;:12379</span><br></pre></td></tr></table></figure><p>ç„¶åçœ‹äº†ä¸‹ <code>iptables -t filter -S</code> æ— é¢å¤–è§„åˆ™ï¼Œæ€•å®¢æˆ·å®‰å…¨åŠ å›ºå•¥çš„å‰é¢ insert äº†è§„åˆ™å½±å“ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sysctl --all |&amp; grep vs.conn</span></span><br><span class="line">net.ipv4.vs.conn_reuse_mode = 1</span><br><span class="line">net.ipv4.vs.conntrack = 1</span><br></pre></td></tr></table></figure><p><code>vs.conntrack</code> æ­£å¸¸ï¼Œä¸æ˜¯ 0ï¼ŒæŸ¥çœ‹ä¸‹ ipvs è§„åˆ™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> keepalived-ipvs ipvsadm -<span class="built_in">ln</span> | grep -A3 169.254.20.4</span></span><br></pre></td></tr></table></figure><p>ç°åœºè¯´ä¸ºç©ºï¼Œè®©å»æ‰ grep ç›´æ¥çœ‹ä¹Ÿæ˜¯ä¸ºç©ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> keepalived-ipvs ipvsadm -<span class="built_in">ln</span></span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br></pre></td></tr></table></figure><p>è®©çœ‹ä¸‹ keepalived æ—¥å¿—ï¼Œå‘ç°æœ‰ä¸ªé”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">daemon is already running</span><br><span class="line">Locking pid file /run/keepalived.pid error 22 - Invalid argument</span><br><span class="line">Opening file &#x27;/etc/keepalived/conf.d/xxx.conf&#x27;.</span><br><span class="line">Opening file &#x27;/etc/keepalived/conf.d/xxx2.conf&#x27;.</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><p>å› ä¸º keepalived å®¹å™¨éœ€è¦æ“ä½œ lvs è§„åˆ™ï¼Œæ‰€ä»¥æ˜¯æœ‰ <code>privileged: true</code> çš„ï¼Œæ„Ÿè§‰è¿˜æ˜¯å†…æ ¸ç›¸å…³é—®é¢˜å¯¼è‡´çš„ï¼Œé‚£å°±çœ‹æºç äº†ã€‚æˆ‘ä»¬ç”¨çš„ keepalived ç‰ˆæœ¬æ˜¯æœ€æ–°çš„ <code>v2.3.4</code> ï¼Œæœç´¢æºç  <code>Locking pid file</code> æœåˆ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/acassen/keepalived/blob/v2.3.4/keepalived/core/pidfile.c#L183-L194</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> HAVE_DECL_F_OFD_SETLK == 1</span></span><br><span class="line">    fl.l_pid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((ret = fcntl(pidf-&gt;fd, F_OFD_SETLK, &amp;fl)) &amp;&amp; errno == EINTR);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">      <span class="keyword">if</span> (errno == EAGAIN)</span><br><span class="line">        log_message(LOG_INFO, <span class="string">&quot;Another process has pid file %s locked&quot;</span>, pidf-&gt;path);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        log_message(LOG_INFO, <span class="string">&quot;Locking pid file %s error %d - %m&quot;</span>, pidf-&gt;path, errno);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>çœ‹è¿™ä¸ªå®å®šä¹‰å†…çš„ä»£ç å°±æ˜¯ fcntl ä½¿ç”¨ <code>F_OFD_SETLK</code> é’ˆå¯¹ Pid æ–‡ä»¶ä¸Šé”ï¼Œè¿™ä¸ªç‰¹æ€§æ˜¯å†…æ ¸ç‰¹æ€§ï¼Œç°åœºæ˜¯ CentOS 7.4 ï¼Œå†…æ ¸ç‰ˆæœ¬ <code>3.10.0-693.el7.x86_64</code>ï¼Œæƒ³çœ‹ä¸‹è¿™å—æäº¤ï¼Œäºæ˜¯ä¸‹è½½æºç åæ‰¾åˆ°ä¸‹é¢ä¿©ä¸ª commmitï¼š</p><ul><li><a href="https://github.com/acassen/keepalived/commit/2c4cd3b927e5f12f59c62481261621b70375a304">https://github.com/acassen/keepalived/commit/2c4cd3b927e5f12f59c62481261621b70375a304</a></li><li><a href="https://github.com/acassen/keepalived/commit/7d2b85d1f03d3ae2944237c60c3eeb5edc4fa12a">https://github.com/acassen/keepalived/commit/7d2b85d1f03d3ae2944237c60c3eeb5edc4fa12a</a></li></ul><p>ç¬¬ä¸€ä¸ª commit æ˜¯å¢åŠ  Pid é”ï¼Œç¬¬äºŒä¸ªæ˜¯å…è®¸å®å®šä¹‰ä¸ç”¨è¿™ä¸ªç‰¹æ€§åœ¨è€ç³»ç»Ÿä¸Šæ„å»ºï¼Œåˆ©ç”¨ autoconf æ£€æµ‹æ”¯æŒ <code>F_OFD_SETLK</code> ä¸ã€‚</p><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å®¹å™¨åŒ–éƒ¨ç½²ï¼ŒåŸºç¡€é•œåƒæ¢æˆæ¬§æ‹‰äº†ï¼Œè€Œæ¬§æ‹‰çš„åŒ…ç®¡ç†å®‰è£…çš„ keepalived ç‰ˆæœ¬å¤ªä½ï¼Œæ‰€ä»¥æˆ‘æ˜¯ Dockerfile å†…ç¼–è¯‘å®‰è£…çš„ keepalivedï¼Œè€Œæ„å»ºè¿™ä¸ªé•œåƒçš„æœºå™¨çš„å†…æ ¸æ¯”è¾ƒé«˜ï¼Œåªèƒ½æ„å»ºçš„æ—¶å€™ä¼ é€’é€‰é¡¹å…³é—­äº†ã€‚</p><p>å½±å“é¢ä¹Ÿä¸éœ€è¦å…³æ³¨ï¼Œå› ä¸ºæ˜¯å®¹å™¨ï¼Œå¹¶ä¸”é•œåƒçš„å¯åŠ¨è„šæœ¬å†…æˆ‘åœ¨å¯åŠ¨çš„æ—¶å€™å…ˆåˆ é™¤ pid æ–‡ä»¶çš„ï¼Œæ— è„‘ç¼–è¯‘å…³é—­å³å¯ï¼Œä¸è¦ hack ä¿®æ”¹ä»£ç ï¼Œautoconf å•¥çš„éƒ½æ˜¯å¤§å®¶éµå®ˆçš„è§„èŒƒï¼Œä¸»è¦æ˜¯ <code>configure.ac</code> ä¸‹é¢çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dnl -- Linux 3.15</span><br><span class="line">AC_CHECK_DECLS([F_OFD_SETLK], [], [],</span><br><span class="line">  [[</span><br><span class="line">    #include &lt;unistd.h&gt;</span><br><span class="line">    #include &lt;fcntl.h&gt;</span><br><span class="line">  ]])</span><br><span class="line">for flag in F_OFD_SETLK; do</span><br><span class="line">  AS_VAR_COPY([decl_var], [ac_cv_have_decl_$flag])</span><br><span class="line">  if test $&#123;decl_var&#125; = yes; then</span><br><span class="line">    add_system_opt[$&#123;flag&#125;]</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹é¢é€»è¾‘ï¼Œ<code>&quot;ac_cv_have_decl_&quot;+&quot;F_OFD_SETLK&quot;=&quot;yes&quot;</code> ï¼Œåœ¨ <code>./configure</code> åé¢åŠ å°±è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    ./autogen.sh; \</span><br><span class="line">    ./configure ac_cv_have_decl_F_OFD_SETLK=no \</span><br><span class="line">        --disable-dynamic-linking \</span><br><span class="line">        --prefix=/usr \</span><br><span class="line">        --exec-prefix=/usr \</span><br><span class="line">        --bindir=/usr/bin \</span><br><span class="line">        --sbindir=/usr/sbin \</span><br><span class="line">        --sysconfdir=/etc \</span><br><span class="line">        --enable-nftables \</span><br><span class="line">        --enable-regex \</span><br><span class="line">        --disable-systemd \</span><br><span class="line">        ; \</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æ‰“åŒ…é•œåƒåæµ‹è¯•æ²¡é—®é¢˜ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;ç°åœºéƒ¨ç½²ä¸šåŠ¡åå‘ç°è®¿é—®æœ‰é—®é¢˜ï¼Œæ’æŸ¥åå‘ç°ä¸šåŠ¡ç½‘å…³è®¿é—® etcd çš„ &lt;a href=&quot;https://zhangguanzhang.gith</summary>
      
    
    
    
    
    <category term="keepalived" scheme="http://zhangguanzhang.github.io/tags/keepalived/"/>
    
    <category term="fnctl" scheme="http://zhangguanzhang.github.io/tags/fnctl/"/>
    
  </entry>
  
  <entry>
    <title>ä»è‡ªå·±é€ è½®å­NodePortç™½åå•åˆ°å‚è€ƒ calico è§„åˆ™</title>
    <link href="http://zhangguanzhang.github.io/2025/10/15/k8s-NodePort-filter/"/>
    <id>http://zhangguanzhang.github.io/2025/10/15/k8s-NodePort-filter/</id>
    <published>2025-10-15T10:10:30.000Z</published>
    <updated>2025-10-15T10:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç ”ç©¶ä¸‹ calico å¦‚ä½•å®ç° nodePort ç™½åå•ã€‚</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ç”±äºæˆ‘ä»¬åšç§æœ‰åŒ–ï¼Œå¾ˆå¤šå®¢æˆ·æ³¨é‡å®‰å…¨ï¼Œéœ€è¦æœ‰ç±»ä¼¼ <code>NetworkPolicy</code> é‚£æ ·åšç™½åå•é™åˆ¶æ¥æºï¼Œè€Œ calico æœ€å°åŒ–éƒ¨ç½²çš„è¯ä¸‹é¢é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.tigera.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Installation</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># https://docs.tigera.io/calico/latest/reference/installation/api#installationspec</span></span><br><span class="line">  <span class="attr">calicoNetwork:</span> <span class="comment"># https://docs.tigera.io/calico/latest/reference/installation/api#caliconetworkspec</span></span><br><span class="line">    <span class="attr">ipPools:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-ipv4-ippool</span></span><br><span class="line">      <span class="attr">blockSize:</span> <span class="number">24</span> <span class="comment"># node ä¸Šåˆ†é…åˆ°çš„ PodIP çš„æ©ç ï¼Œé»˜è®¤26ï¼Œæˆ‘å–œæ¬¢æ”¹æˆ24æ–¹ä¾¿é˜…è¯»</span></span><br><span class="line">      <span class="attr">cidr:</span> <span class="number">10.187</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">      <span class="attr">encapsulation:</span> <span class="string">VXLANCrossSubnet</span> <span class="comment"># https://docs.tigera.io/calico/latest/reference/installation/api#encapsulationtype</span></span><br><span class="line">      <span class="attr">natOutgoing:</span> <span class="string">Enabled</span></span><br><span class="line">      <span class="attr">nodeSelector:</span> <span class="string">all()</span></span><br><span class="line">    <span class="attr">nodeAddressAutodetectionV4:</span> <span class="comment"># https://docs.tigera.io/calico/latest/reference/installation/api#nodeaddressautodetection</span></span><br><span class="line">      <span class="attr">canReach:</span> <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span></span><br><span class="line">  <span class="attr">registry:</span> <span class="string">m.daocloud.io/quay.io</span> <span class="comment"># https://docs.tigera.io/calico/latest/operations/image-options/alternate-registry</span></span><br><span class="line">  <span class="attr">flexVolumePath:</span> <span class="string">None</span> <span class="comment"># è®¾ç½®ä¸ºNone ä¸å®‰è£… CSI ç›¸å…³</span></span><br><span class="line">  <span class="attr">kubeletVolumePluginPath:</span> <span class="string">None</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">operator.tigera.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIServer</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹éƒ½ä¼šéƒ¨ç½²å¾ˆå¤šç»„ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl -n calico-system get deploy</span></span><br><span class="line">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">calico-kube-controllers   1/1     1            1           6d3h</span><br><span class="line">calico-typha              1/1     1            1           6d3h</span><br><span class="line">goldmane                  1/1     1            1           6d1h</span><br><span class="line">whisker                   1/1     1            1           6d1h</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl -n calico-apiserver get deploy</span></span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">calico-apiserver   2/2     2            2           6d1h</span><br></pre></td></tr></table></figure><p>è€Œä¸”å¾ˆå¤šå®¢æˆ·æœºå™¨é…ç½®ä¸é«˜ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ flannelï¼Œè€Œç½‘ç»œç­–ç•¥è¿™å—æœ‰å®ç°ä¸€ä¸ª agent å®¹å™¨åš iptables è§„åˆ™ç™½åå•ï¼Œé K8S ä¸‹ docker ä¹Ÿå¯ä»¥ç”¨ã€‚æŸä¸ªç‰ˆæœ¬å¼€å§‹æœ‰éƒ¨åˆ†ä¸šåŠ¡éœ€è¦ NodePort æš´æ¼ç”¨äºå¤–éƒ¨ä¸Šä¼ å¤‡ä»½æ–‡ä»¶ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å®¢æˆ·å®‰å…¨è¦æ±‚ï¼Œæ‰€ä»¥éœ€è¦ <code>NodePort</code> åšç™½åå•é™åˆ¶ã€‚<br>å¦‚æœå¯¹ iptables ä¸ç†Ÿæ‚‰ï¼Œå¯èƒ½ä¼šä¸‹æ„è¯†çš„å» <code>INPUT</code> é“¾å»åšï¼Œå®é™…æ˜¯ä¸è¡Œçš„ï¼ŒNodePort åœ¨ nat è¡¨é‡Œ <code>PREROUTING</code> å…ˆåŒ¹é…åš nat çš„ï¼Œæ‹¿å¦‚ä¸‹ svc åšè¯´æ˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Name:                     my-service</span><br><span class="line">Namespace:                default</span><br><span class="line">Labels:                   &lt;none&gt;</span><br><span class="line">Annotations:              &lt;none&gt;</span><br><span class="line">Selector:                 nodePort=test</span><br><span class="line">Type:                     NodePort</span><br><span class="line">IP Family Policy:         SingleStack</span><br><span class="line">IP Families:              IPv4</span><br><span class="line">IP:                       10.186.158.205</span><br><span class="line">IPs:                      10.186.158.205</span><br><span class="line">Port:                     &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:               80/TCP</span><br><span class="line">NodePort:                 &lt;unset&gt;  30008/TCP</span><br><span class="line">Endpoints:                10.187.220.19:80</span><br><span class="line">Session Affinity:         None</span><br><span class="line">External Traffic Policy:  Cluster</span><br><span class="line">Events:                   &lt;none&gt;</span><br></pre></td></tr></table></figure><p>ç›¸å…³ nat è¡¨ä¸‹çš„ <code>PRETOUTING</code> é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…¥å£</span></span><br><span class="line">-A PREROUTING -m comment --comment &quot;kubernetes service portals&quot; -j KUBE-SERVICES</span><br><span class="line">-A KUBE-SERVICES -m comment --comment &quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&quot; -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS</span><br><span class="line">-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/my-service&quot; -m tcp --dport 30008 -j KUBE-EXT-FXIYY6OHUSNBITIX</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nodePort åŒ¹é…ä¹‹å‰å…ˆæ‰“ snat markï¼Œå†æ˜¯ä¸‹é¢çš„ KUBE-SVC-FXIYY6OHUSNBITIX svc çš„ dnat é“¾</span></span><br><span class="line">-A KUBE-EXT-FXIYY6OHUSNBITIX -m comment --comment &quot;masquerade traffic for default/my-service external destinations&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-EXT-FXIYY6OHUSNBITIX -j KUBE-SVC-FXIYY6OHUSNBITIX</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">svc çš„ dnat é“¾</span></span><br><span class="line">-A KUBE-SVC-FXIYY6OHUSNBITIX -d 10.186.158.205/32 -p tcp -m comment --comment &quot;default/my-service cluster IP&quot; -m tcp --dport 80 -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SVC-FXIYY6OHUSNBITIX -m comment --comment &quot;default/my-service -&gt; 10.187.220.19:80&quot; -j KUBE-SEP-DPGHCWFA3YQKRCGQ</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">svc çš„ endpoint é“¾</span></span><br><span class="line">-A KUBE-SEP-DPGHCWFA3YQKRCGQ -s 10.187.220.19/32 -m comment --comment &quot;default/my-service&quot; -j KUBE-MARK-MASQ</span><br><span class="line">-A KUBE-SEP-DPGHCWFA3YQKRCGQ -p tcp -m comment --comment &quot;default/my-service&quot; -m tcp -j DNAT --to-destination 10.187.220.19:80</span><br></pre></td></tr></table></figure><p>ç­‰èµ°åˆ° INPUT åï¼Œç›®æ ‡ IP å’Œ port éƒ½ç»è¿‡äº† dnatäº†ï¼Œæ‰€ä»¥ä¸èƒ½åœ¨ INPUT æ‹¦æˆªåŒ¹é…ï¼ŒåŒç† docker -p æš´æ¼çš„ç«¯å£ä¹Ÿæ˜¯ä¸€æ ·ã€‚æ‰€ä»¥ä¹‹å‰æˆ‘æ˜¯åœ¨ raw è¡¨çš„ <code>PREROUTING</code> é‡Œåšçš„ã€‚</p><h2 id="è§„åˆ™é—®é¢˜"><a href="#è§„åˆ™é—®é¢˜" class="headerlink" title="è§„åˆ™é—®é¢˜"></a>è§„åˆ™é—®é¢˜</h2><p>è®¾è®¡çš„è§„åˆ™æ˜¯ä¸€ä¸ª ipset å­˜ç™½åå•ç«¯å£åˆ—è¡¨ï¼Œä¸€ä¸ªæ˜¯ ip ç™½åå•ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t raw -S PREROUTING</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å›ç¨‹ conntrack çŠ¶æ€æ”¾è¡Œ</span></span><br><span class="line">-A PREROUTING -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¥æº IP ä¸æ˜¯ç™½åå• IPï¼Œä½†æ˜¯ç›®æ ‡ç«¯å£æ˜¯ç™½åå•ç«¯å£å°±æ‹’ç»</span></span><br><span class="line">-A PREROUTING -m set ! --match-set whiteiplist src -m set --match-set whiteportlist dst -j DROP</span><br></pre></td></tr></table></figure><p>ç„¶åæµ‹äº†ä¸‹å‘ç°æ²¡é—®é¢˜ï¼Œåé¢æ—¶ä¸æ—¶æ”¶åˆ°å®æ–½åé¦ˆå®¢æˆ·ç°åœºç¯å¢ƒä¸Šï¼ŒæœåŠ¡ä½œä¸ºå®¢æˆ·ç«¯è®¿é—®å¤–éƒ¨ä½æ¦‚ç‡è¶…æ—¶ï¼ŒæŠ“åŒ…å‘ç°æœ¬æœºä¸Šè®¿é—®å¤–éƒ¨ serverï¼Œserver å›åŒ…è¢«é˜»æ–­ï¼š</p><ul><li>æœ¬æœºä¸Šä½œä¸º client è®¿é—®å¤–éƒ¨ï¼Œå‘é€ SYN åŒ…</li><li>å¤–éƒ¨ server ç»™æœ¬æœºå‘é€ SYN-ACK è¢«é˜»æ–­</li></ul><p>æ ¹æ® iptables ç»Ÿè®¡æ•°æ®çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t raw -nvL PREROUTING</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"> 162M   64G ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line"> 20   1604 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ! match-set whiteiplist src match-set whiteportlist dst</span><br></pre></td></tr></table></figure><p>å‘ç°å°±æ˜¯ raw çš„è¿™ä¸ªè§„åˆ™åŒ¹é… DROP çš„ï¼Œæ’æŸ¥å‘ç°ï¼ŒæŸä¸ªç‰ˆæœ¬å¼€å§‹åï¼ŒæŠŠç™½åå•ç«¯å£å¢åŠ å¾ˆå¤šï¼Œä¾‹å¦‚ <code>49100-49500</code> ä¹‹ç±»çš„ï¼ˆINPUT é“¾æˆ‘ä»¬ä¹Ÿåœ¨ç”¨ whiteportlistï¼‰ï¼Œåœ¨ <code>ip_local_port_range</code> èŒƒå›´å†…ï¼Œåˆšå¥½å®¢æˆ·ç«¯ä½¿ç”¨å°±ä¼šå‘ç”Ÿï¼š</p><ul><li>æœ¬æœºè¯·æ±‚å¤–éƒ¨ serverï¼Œåˆ†é…çš„ <code>local_port</code> æ˜¯ <code>whiteportlist</code> ä¾‹å¦‚ï¼š<code>49123</code></li><li>å¤–éƒ¨å›åŒ…ï¼Œæ­¤åˆ»æ²¡æœ‰è¢« <code>conntrack</code> æ ‡è®°ä¸º <code>ESTABLISHED</code> çŠ¶æ€ï¼Œèµ°åˆ°ä¸‹ä¸€æ¡è§„åˆ™</li><li>ç„¶åå‘½ä¸­ä¸‹ä¸€æ¡å°±è¢« DROP</li></ul><p>ä½¿ç”¨ tcp ç¼–ç¨‹å¤ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">49123</span>))</span><br><span class="line">s.connect((<span class="string">&#x27;39.156.70.37&#x27;</span>, <span class="number">80</span>))</span><br><span class="line">s.send(<span class="string">b&#x27;GET / HTTP/1.1\r\nHost: www.baidu.com\r\n\r\n&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>))</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure><p><code>39.156.70.37</code> ä¸ºç™¾åº¦åŸŸå IPï¼Œæ‰§è¡Œåå¡ä½ï¼ŒæŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯å¢åŠ äº†ä¹Ÿç¬¦åˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç©º PREROUTING ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t raw -Z PREROUTING</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python test.py</span></span><br><span class="line">^C</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t raw -nvL PREROUTING</span></span><br></pre></td></tr></table></figure><p>çœ‹æ¥ raw å¦‚å­—é¢æ„æ€ï¼Œå¤ªåŸå§‹äº†ã€‚</p><h2 id="calico"><a href="#calico" class="headerlink" title="calico"></a>calico</h2><p>ç ”ç©¶ä¸‹ calico å¦‚ä½•å®ç°çš„ï¼Œå•æœºå¹²å‡€ K8S é›†ç¾¤ä¸Šéƒ¨ç½²äº† calico ï¼Œçœ‹äº†ä¸‹ operator å®‰è£…çš„ calico ç‰ˆæœ¬ä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker images | grep calico/node</span></span><br><span class="line">m.daocloud.io/quay.io/calico/node                           v3.30.3                                  ce9c4ac0f175   7 weeks ago    401MB</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡çš„è§„åˆ™ç ”ç©¶ä»¥ <code>v3.30.3</code> ç‰ˆæœ¬ä¸ºå‡†ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>å…ˆéƒ¨ç½²ä¸€ä¸ª NodePortï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-hostname</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">m.daocloud.io/docker.io/library/nginx:alpine</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30008</span></span><br></pre></td></tr></table></figure><p>ç›¸å…³ä¿¡æ¯å­˜æ¡£ï¼Œåç»­ç”Ÿæ•ˆçš„ç­–ç•¥å¯¹æ¯”ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -w -t raw -S &gt; raw</span><br><span class="line">iptables -w -t nat -S &gt; nat</span><br><span class="line">iptables -w -t mangle -S &gt; mangle</span><br><span class="line">iptables -w -S &gt; filter</span><br><span class="line">ipset list &gt; ipset</span><br></pre></td></tr></table></figure><h3 id="GlobalNetworkPolicy"><a href="#GlobalNetworkPolicy" class="headerlink" title="GlobalNetworkPolicy"></a>GlobalNetworkPolicy</h3><p>è°·æ­Œæœåˆ°å®˜æ–¹æ–‡æ¡£<a href="https://docs.tigera.io/calico/latest/network-policy/services/kubernetes-node-ports">network-policy kubernetes-node-ports</a>ï¼Œä½¿ç”¨çš„æ˜¯ <code>GlobalNetworkPolicy</code>ï¼Œçœ‹äº†ä¸‹æ–‡æ¡£ï¼Œcalico çš„è¿™ä¸ª CRD ç›¸å¯¹äº <code>NetworkPolicy</code> èŒƒå›´æ›´å¹¿ï¼Œå®ƒå¯ä»¥æ§åˆ¶ä¸»æœºå±‚é¢ï¼Œè€Œé <code>NetworkPolicy</code> åªæ§åˆ¶ ns å’Œ Pod ç­–ç•¥ï¼Œæ ¹æ®æ–‡æ¡£ä¾‹å­å†™äº†ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">projectcalico.org/v3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">GlobalNetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-cluster-nodeport-only</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment"># å¸¸è§„ä½¿ç”¨æ˜¯é…åˆå…œåº•ç­–ç•¥ï¼Œä¼˜å…ˆçº§é«˜çš„å‰é¢æ”¾è¡Œï¼Œä¼˜å…ˆçº§æœ€ä½çš„æ˜¯æ‹’ç»ï¼Œä¹Ÿå°±æ˜¯ç™½åå•ç­–ç•¥ã€‚æˆ–è€…ä¼˜å…ˆçº§æœ€ä½çš„æ˜¯æ”¾è¡Œï¼Œä¼˜å…ˆçº§é«˜çš„æ˜¯DROPï¼Œä¹Ÿå°±æ˜¯é»‘åå•ç­–ç•¥</span></span><br><span class="line"><span class="comment"># è¿™é‡Œæˆ‘æ˜¯åªæµ‹è¯•ï¼Œå†™å‡ºä¸‹é¢è§„åˆ™</span></span><br><span class="line">  <span class="attr">order:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">preDNAT:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">applyOnForward:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">Allow</span></span><br><span class="line">      <span class="attr">source:</span></span><br><span class="line">        <span class="attr">nets:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="number">10.</span><span class="string">xxx.41.110/32</span> <span class="comment"># è‡ªèº« IP</span></span><br><span class="line">         <span class="bullet">-</span> <span class="number">10.</span><span class="string">xxx.195.118/32</span> <span class="comment"># å¤–éƒ¨æµ‹è¯• IP</span></span><br><span class="line">         <span class="bullet">-</span> <span class="number">10.187</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span> <span class="comment"># Pod CIDR</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">Deny</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">ports:</span> [<span class="number">30008</span>]</span><br><span class="line">  <span class="attr">selector:</span> <span class="string">has(kubernetes.io/os)</span></span><br></pre></td></tr></table></figure><p>apply åå‘ç° iptables çš„æ‰€æœ‰è¡¨é‡Œéƒ½æ²¡æœ‰è§„åˆ™å¢åŠ ï¼Œå®˜æ–¹æ–‡æ¡£è¯´é€‰æ‹©å™¨å¯ä»¥é€‰ node çš„ï¼Œä½†æ˜¯å®é™…æµ‹è¯•ä¸è¡Œï¼Œçœ‹å®˜æ–¹æ–‡æ¡£å…¶ä»–åœ°æ–¹æœ‰ä½¿ç”¨ <code>kind: HostEndpoint</code> é…åˆ <code>selector</code> ï¼Œè®¾ç½®ä¸‹è‡ªåŠ¨åˆ›å»º hep è¿˜æ˜¯ä¸è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl patch kubecontrollersconfigurations default \</span></span><br><span class="line"><span class="language-bash">  --<span class="built_in">type</span>=merge -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;controllers&quot;: &#123;&quot;node&quot;:&#123;&quot;hostEndpoint&quot;:&#123;&quot;autoCreate&quot;: &quot;Enabled&quot;&#125;&#125;&#125;&#125;&#125;&#x27;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get hep -l kubernetes.io/os</span></span><br><span class="line">NAME                     CREATED AT</span><br><span class="line">10.xxx.xx.170-auto-hep   2025-10-15T09:18:37</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹é€‰æ‹©å™¨æ–‡æ¡£ï¼Œç›´æ¥æ”¹æˆ <code>selector: all()</code> åå¯ä»¥äº†ï¼Œå¤–éƒ¨ IP ä¸åœ¨ä¸Šé¢çš„ç™½åå•é‡Œ curl nodeport ä¸é€š</p><h2 id="è§„åˆ™ç ”ç©¶"><a href="#è§„åˆ™ç ”ç©¶" class="headerlink" title="è§„åˆ™ç ”ç©¶"></a>è§„åˆ™ç ”ç©¶</h2><p>å¯¼å‡ºç°åœ¨è§„åˆ™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -w -t raw -S &gt; raw2</span><br><span class="line">iptables -w -t nat -S &gt; nat2</span><br><span class="line">iptables -w -t mangle -S &gt; mangle2</span><br><span class="line">iptables -w -S &gt; filter2</span><br></pre></td></tr></table></figure><h3 id="æ–°å¢è§„åˆ™"><a href="#æ–°å¢è§„åˆ™" class="headerlink" title="æ–°å¢è§„åˆ™"></a>æ–°å¢è§„åˆ™</h3><p>å¯¹æ¯”ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">diff mangle*</span></span><br><span class="line">10a11</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-N cali-failsafe-in</span></span><br><span class="line">11a13</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-N cali-fh-any-interface-at-all</span></span><br><span class="line">12a15</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-N cali-pi-_Ddz2TLFtYPs0Zt3iUZs</span></span><br><span class="line">25a29,37</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:wWFQM43tJU7wwnFZ&quot;</span> -m multiport --dports 22 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p udp -m comment --comment <span class="string">&quot;cali:LwNV--R8MjeUYacw&quot;</span> -m multiport --dports 68 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:QOO5NUOqOSS1_Iw0&quot;</span> -m multiport --dports 179 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:cwZWoBSwVeIAZmVN&quot;</span> -m multiport --dports 2379 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:7FbNXT91kugE_upR&quot;</span> -m multiport --dports 2380 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:8Ftbkk2dRH2eEeq1&quot;</span> -m multiport --dports 5473 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:-JoRSaAQZPJAegMo&quot;</span> -m multiport --dports 6443 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:PUKij4Rn9njHfVTi&quot;</span> -m multiport --dports 6666 -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-failsafe-in -p tcp -m comment --comment <span class="string">&quot;cali:vSprVE-4rient0wc&quot;</span> -m multiport --dports 6667 -j ACCEPT</span></span><br><span class="line">34a47,64</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-fh-any-interface-at-all -m comment --comment <span class="string">&quot;cali:CCbcqJXqEISzSqnH&quot;</span> -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-fh-any-interface-at-all -m comment --comment <span class="string">&quot;cali:mmvu-cTJXJ7YH9Lp&quot;</span> -m conntrack --ctstate INVALID -j DROP</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-fh-any-interface-at-all -m comment --comment <span class="string">&quot;cali:NnqjZhu9yccY4C7-&quot;</span> -j cali-failsafe-in</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-fh-any-interface-at-all -m comment --comment <span class="string">&quot;cali:AtciE88iDfq0ah2L&quot;</span> -j MARK --set-xmark 0x0/0x30000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-fh-any-interface-at-all -m comment --comment <span class="string">&quot;cali:BZMMxJKaVi8hIM9r&quot;</span> -m comment --comment <span class="string">&quot;Start of tier default&quot;</span> -j MARK --set-xmark 0x0/0x20000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-fh-any-interface-at-all -m comment --comment <span class="string">&quot;cali:_hnIU4TYdSt--CFh&quot;</span> -m mark --mark 0x0/0x20000 -j cali-pi-_Ddz2TLFtYPs0Zt3iUZs</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-fh-any-interface-at-all -m comment --comment <span class="string">&quot;cali:-n3Ama1WlBcv-Yv9&quot;</span> -m comment --comment <span class="string">&quot;Return if policy accepted&quot;</span> -m mark --mark 0x10000/0x10000 -j RETURN</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-from-host-endpoint -m comment --comment <span class="string">&quot;cali:0MLuqUx2SPsTwgBS&quot;</span> -g cali-fh-any-interface-at-all</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment <span class="string">&quot;cali:5eFTXO3b0B-Tbiq8&quot;</span> -m comment --comment <span class="string">&quot;Policy default.allow-cluster-nodeport-only ingress&quot;</span> -j MARK --set-xmark 0x0/0x180000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -s 10.xxx.41.110/32 -m comment --comment <span class="string">&quot;cali:L5TwSbHWsELZIAEd&quot;</span> -j MARK --set-xmark 0x80000/0x80000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -s 10.xxx.195.118/32 -m comment --comment <span class="string">&quot;cali:noUEAlswvbgG5j7d&quot;</span> -j MARK --set-xmark 0x80000/0x80000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -s 10.187.0.0/16 -m comment --comment <span class="string">&quot;cali:TxEjJz-IsLiJzVDK&quot;</span> -j MARK --set-xmark 0x80000/0x80000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment <span class="string">&quot;cali:SBosizM5mtjxTsOe&quot;</span> -m mark --mark 0x80000/0x80000 -j MARK --set-xmark 0x10000/0x10000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment <span class="string">&quot;cali:5w4NEetZaXhF7wjm&quot;</span> -m mark --mark 0x10000/0x10000 -j NFLOG --nflog-prefix  <span class="string">&quot;API0|default.allow-cluster-nodeport-only&quot;</span> --nflog-group 1 --nflog-range 80</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment <span class="string">&quot;cali:NMym66CfdBVWGhc6&quot;</span> -m mark --mark 0x10000/0x10000 -j RETURN</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -p tcp -m comment --comment <span class="string">&quot;cali:HONlGpSGnitWLUh-&quot;</span> -m multiport --dports 30008 -j MARK --set-xmark 0x40000/0x40000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment <span class="string">&quot;cali:9vcFh92OaOMP06xg&quot;</span> -m mark --mark 0x40000/0x40000 -j NFLOG --nflog-prefix  <span class="string">&quot;DPI1|default.allow-cluster-nodeport-only&quot;</span> --nflog-group 1 --nflog-range 80</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">-A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment <span class="string">&quot;cali:URAeOCUsDbThanFp&quot;</span> -m mark --mark 0x40000/0x40000 -j DROP</span></span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯å¤šäº†ä¸‰ä¸ªé“¾ï¼š</p><ul><li><code>cali-failsafe-in</code></li><li><code>cali-fh-any-interface-at-all</code></li><li><code>cali-pi-_Ddz2TLFtYPs0Zt3iUZs</code></li></ul><p><code>cali-failsafe-in</code> é“¾å¦‚åå­—æ‰€ç¤ºï¼Œå…œåº•ç­–ç•¥ï¼Œå…ˆæ”¾è¡Œ ssh&#x2F;etcd&#x2F;kube-apiserver ä¹‹ç±»ç«¯å£ ï¼Œé¿å…é…ç½®é”™è¯¯ç½‘ç»œç­–ç•¥åå¯¼è‡´æœºå™¨é›†ç¾¤æ— æ³•è¿ä¸Šï¼Œæ¶‰åŠåˆ°çš„ç«¯å£è§å®˜æ–¹æ–‡æ¡£ <a href="https://docs.tigera.io/calico/latest/reference/host-endpoints/failsafe">failsafe</a>ï¼Œå¯¹äºæ–°å¢è¿‡æ»¤è§„åˆ™çš„éƒ½ä¼šå…ˆè·³åˆ°è¿™ä¸ªé“¾ã€‚</p><p>åé¢ä¿©é“¾æ˜¯å…·ä½“ <code>cali-pi-_Ddz2TLFtYPs0Zt3iUZs</code> é‡Œåšå¤„ç†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; -A cali-fh-any-interface-at-all -m comment --comment &quot;cali:_hnIU4TYdSt--CFh&quot; -m mark --mark 0x0/0x20000 -j cali-pi-_Ddz2TLFtYPs0Zt3iUZs</span><br></pre></td></tr></table></figure><p>æ¥æ‡’äººåŠæ³•ï¼Œæ¸…ç†æ‰é“¾çš„ç»Ÿè®¡ä¿¡æ¯çœ‹ç”Ÿæ•ˆåœ¨å“ªå—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t mangle -Z cali-pi-_Ddz2TLFtYPs0Zt3iUZs</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t mangle -nvL cali-pi-_Ddz2TLFtYPs0Zt3iUZs</span></span><br><span class="line">Chain cali-pi-_Ddz2TLFtYPs0Zt3iUZs (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">   10   600 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:5eFTXO3b0B-Tbiq8 */ /* Policy default.allow-cluster-nodeport-only ingress */ MARK and 0xffe7ffff</span><br><span class="line">    0     0 MARK       all  --  *      *       10.xxx.41.110        0.0.0.0/0            /* cali:L5TwSbHWsELZIAEd */ MARK or 0x80000</span><br><span class="line">    0     0 MARK       all  --  *      *       10.xxx.195.118       0.0.0.0/0            /* cali:noUEAlswvbgG5j7d */ MARK or 0x80000</span><br><span class="line">    0     0 MARK       all  --  *      *       10.187.0.0/16        0.0.0.0/0            /* cali:TxEjJz-IsLiJzVDK */ MARK or 0x80000</span><br><span class="line">    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:SBosizM5mtjxTsOe */ mark match 0x80000/0x80000 MARK or 0x10000</span><br><span class="line">    0     0 NFLOG      all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:5w4NEetZaXhF7wjm */ mark match 0x10000/0x10000 nflog-prefix  &quot;API0|default.allow-cluster-nodeport-only&quot; nflog-group 1 nflog-range 80</span><br><span class="line">    0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:NMym66CfdBVWGhc6 */ mark match 0x10000/0x10000</span><br><span class="line">    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:HONlGpSGnitWLUh- */ multiport dports 30008 MARK or 0x40000</span><br><span class="line">    0     0 NFLOG      all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:9vcFh92OaOMP06xg */ mark match 0x40000/0x40000 nflog-prefix  &quot;DPI1|default.allow-cluster-nodeport-only&quot; nflog-group 1 nflog-range 80</span><br><span class="line">    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:URAeOCUsDbThanFp */ mark match 0x40000/0x40000</span><br></pre></td></tr></table></figure><p>ç„¶åå¤–éƒ¨çš„ä¸åœ¨ç™½åå•é‡Œçš„ curl ä¸‹ NodePortï¼Œå†çœ‹ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t mangle -nvL cali-pi-_Ddz2TLFtYPs0Zt3iUZs</span></span><br><span class="line">Chain cali-pi-_Ddz2TLFtYPs0Zt3iUZs (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">   44  2640 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:5eFTXO3b0B-Tbiq8 */ /* Policy default.allow-cluster-nodeport-only ingress */ MARK and 0xffe7ffff</span><br><span class="line">    0     0 MARK       all  --  *      *       10.xxx.41.110        0.0.0.0/0            /* cali:L5TwSbHWsELZIAEd */ MARK or 0x80000</span><br><span class="line">    0     0 MARK       all  --  *      *       10.xxx.195.118       0.0.0.0/0            /* cali:noUEAlswvbgG5j7d */ MARK or 0x80000</span><br><span class="line">    0     0 MARK       all  --  *      *       10.187.0.0/16        0.0.0.0/0            /* cali:TxEjJz-IsLiJzVDK */ MARK or 0x80000</span><br><span class="line">    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:SBosizM5mtjxTsOe */ mark match 0x80000/0x80000 MARK or 0x10000</span><br><span class="line">    0     0 NFLOG      all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:5w4NEetZaXhF7wjm */ mark match 0x10000/0x10000 nflog-prefix  &quot;API0|default.allow-cluster-nodeport-only&quot; nflog-group 1 nflog-range 80</span><br><span class="line">    0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:NMym66CfdBVWGhc6 */ mark match 0x10000/0x10000</span><br><span class="line">    2   120 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:HONlGpSGnitWLUh- */ multiport dports 30008 MARK or 0x40000</span><br><span class="line">    2   120 NFLOG      all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:9vcFh92OaOMP06xg */ mark match 0x40000/0x40000 nflog-prefix  &quot;DPI1|default.allow-cluster-nodeport-only&quot; nflog-group 1 nflog-range 80</span><br><span class="line">    2   120 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:URAeOCUsDbThanFp */ mark match 0x40000/0x40000</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ç”¨ mark åšæ¡ä»¶ flag åŒ¹é…å¤„ç†ï¼Œä¸»è¦çœ‹è¿™å‡ ä¸ªè§„åˆ™å°±è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment &quot;cali:5eFTXO3b0B-Tbiq8&quot; -m comment --comment &quot;Policy default.allow-cluster-nodeport-only ingress&quot; -j MARK --set-xmark 0x0/0x180000</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -s 10.xxx.41.110/32 -m comment --comment &quot;cali:L5TwSbHWsELZIAEd&quot; -j MARK --set-xmark 0x80000/0x80000</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -s 10.xxx.195.118/32 -m comment --comment &quot;cali:noUEAlswvbgG5j7d&quot; -j MARK --set-xmark 0x80000/0x80000</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -s 10.187.0.0/16 -m comment --comment &quot;cali:TxEjJz-IsLiJzVDK&quot; -j MARK --set-xmark 0x80000/0x80000</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment &quot;cali:SBosizM5mtjxTsOe&quot; -m mark --mark 0x80000/0x80000 -j MARK --set-xmark 0x10000/0x10000</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment &quot;cali:5w4NEetZaXhF7wjm&quot; -m mark --mark 0x10000/0x10000 -j NFLOG --nflog-prefix  &quot;API0|default.allow-cluster-nodeport-only&quot; --nflog-group 1 --nflog-range 80</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment &quot;cali:NMym66CfdBVWGhc6&quot; -m mark --mark 0x10000/0x10000 -j RETURN</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -p tcp -m comment --comment &quot;cali:HONlGpSGnitWLUh-&quot; -m multiport --dports 30008 -j MARK --set-xmark 0x40000/0x40000</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment &quot;cali:9vcFh92OaOMP06xg&quot; -m mark --mark 0x40000/0x40000 -j NFLOG --nflog-prefix  &quot;DPI1|default.allow-cluster-nodeport-only&quot; --nflog-group 1 --nflog-range 80</span><br><span class="line">&gt; -A cali-pi-_Ddz2TLFtYPs0Zt3iUZs -m comment --comment &quot;cali:URAeOCUsDbThanFp&quot; -m mark --mark 0x40000/0x40000 -j DROP</span><br></pre></td></tr></table></figure><ul><li>ç™½åå•ä¼šæ‰“ä¸Š <code>0x80000/0x80000</code> æ ‡è®°</li><li><code>-m mark --mark 0x80000/0x80000 -j MARK --set-xmark 0x10000/0x10000</code> åŒ¹é…ä¸Š <code>0x80000/0x80000</code> çš„æ‰“æ–° mark <code>0x10000/0x10000</code> ï¼Œè¿™é‡ŒæŒ‰ç…§äºŒè¿›åˆ¶ç†è§£ï¼Œä¸¤è€…éƒ½å­˜åœ¨</li><li><code>--mark 0x10000/0x10000 -j NFLOG</code> åŒ¹é… <code>0x10000/0x10000</code> çš„åœ¨ NFLOG ä¸Šè®°å½•ï¼Œå¯ä»¥ç”¨ <code>tcpdump -i nflog:1</code> æŠ“åŒ…ï¼Œé…åˆå‰é¢ä¸€æ¡ä¹Ÿå°±æ˜¯å‘½ä¸­è§„åˆ™çš„æ‰ä¼š NFLOG</li><li><code>--mark 0x10000/0x10000 -j RETURN</code> ç™½åå•å‘½ä¸­æ”¾è¡Œçš„æ­¤åˆ»ä¸å¾€ä¸‹èµ°</li><li><code>-m multiport --dports 30008 -j MARK --set-xmark 0x40000/0x40000</code> è®¿é—®çš„æ˜¯ NodePort æ‰“ä¸Šæ ‡è®°</li><li><code>--mark 0x40000/0x40000 -j NFLOG</code> è®°å½•ï¼Œå†å¾€ä¸‹èµ°</li><li><code>--mark 0x40000/0x40000 -j DROP</code> æ‰”æ‰æŠ¥æ–‡</li></ul><h3 id="mangle-çš„-PREROUTING"><a href="#mangle-çš„-PREROUTING" class="headerlink" title="mangle çš„ PREROUTING"></a>mangle çš„ PREROUTING</h3><p>ç›¸å…³æµç¨‹éƒ½åœ¨ mangle é‡Œ:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t mangle -S PREROUTING</span></span><br><span class="line">-P PREROUTING ACCEPT</span><br><span class="line">-A PREROUTING -m comment --comment &quot;cali:6gwbT8clXdHdC1b1&quot; -j cali-PREROUTING</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t mangle -S cali-PREROUTING</span></span><br><span class="line">-N cali-PREROUTING</span><br><span class="line">-A cali-PREROUTING -m comment --comment &quot;cali:6BJqBjBC7crtA-7-&quot; -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A cali-PREROUTING -m comment --comment &quot;cali:KX7AGNd6rMcDUai6&quot; -m mark --mark 0x10000/0x10000 -j ACCEPT</span><br><span class="line">-A cali-PREROUTING -m comment --comment &quot;cali:wNH7KsA3ILKJBsY9&quot; -j cali-from-host-endpoint</span><br><span class="line">-A cali-PREROUTING -m comment --comment &quot;cali:Cg96MgVuoPm7UMRo&quot; -m comment --comment &quot;Host endpoint policy accepted packet.&quot; -m mark --mark 0x10000/0x10000 -j ACCEPT</span><br></pre></td></tr></table></figure><p>ç„¶åæ˜¯ <code>cali-from-host-endpoint</code> é‡Œï¼Œå¦‚æœæ²¡æœ‰ return å°±æ— æ³•èµ°åˆ°ä¸‹é¢çš„ <code>&quot;Host endpoint policy accepted packet.&quot; -m mark --mark 0x10000/0x10000 -j ACCEPT</code>ï¼Œè€Œå®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t mangle -S cali-from-host-endpoint</span></span><br><span class="line">-N cali-from-host-endpoint</span><br><span class="line">-A cali-from-host-endpoint -m comment --comment &quot;cali:0MLuqUx2SPsTwgBS&quot; -g cali-fh-any-interface-at-all</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å®ƒä¼šèµ°åˆ°ä¸Šé¢æ–°å¢çš„ diff è§„åˆ™é‡Œï¼Œè¿™æ˜¯æ•´ä¸ªæµç¨‹ã€‚</p><h2 id="ç›¸å…³æºç "><a href="#ç›¸å…³æºç " class="headerlink" title="ç›¸å…³æºç "></a>ç›¸å…³æºç </h2><p>calico è´Ÿè´£ iptables è§„åˆ™çš„æ˜¯ felix</p><h3 id="é“¾åå­—"><a href="#é“¾åå­—" class="headerlink" title="é“¾åå­—"></a>é“¾åå­—</h3><p><a href="https://github.com/projectcalico/calico/blob/v3.30.3/felix/rules/rule_defs.go">https://github.com/projectcalico/calico/blob/v3.30.3/felix/rules/rule_defs.go</a></p><h3 id="mark"><a href="#mark" class="headerlink" title="mark"></a>mark</h3><p>ç›¸å…³ mark å€¼æºç é‡Œæ‰¾åˆ°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/projectcalico/calico/blob/v3.30.3/felix/dataplane/driver.go#L156-L164</span></span><br><span class="line">log.WithFields(log.Fields&#123;</span><br><span class="line"><span class="string">&quot;acceptMark&quot;</span>:          markAccept,</span><br><span class="line"><span class="string">&quot;passMark&quot;</span>:            markPass,</span><br><span class="line"><span class="string">&quot;dropMark&quot;</span>:            markDrop,</span><br><span class="line"><span class="string">&quot;scratch0Mark&quot;</span>:        markScratch0,</span><br><span class="line"><span class="string">&quot;scratch1Mark&quot;</span>:        markScratch1,</span><br><span class="line"><span class="string">&quot;endpointMark&quot;</span>:        markEndpointMark,</span><br><span class="line"><span class="string">&quot;endpointMarkNonCali&quot;</span>: markEndpointNonCaliEndpoint,</span><br><span class="line">&#125;).Info(<span class="string">&quot;Calculated iptables mark bits&quot;</span>)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ—¥å¿—ï¼Œä¸‹é¢ä¾¿äºé˜…è¯»åŠ å‡ ä¸ªæ¢è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker logs d96d | grep <span class="string">&#x27;Calculated iptables mark bits&#x27;</span></span></span><br><span class="line">2025-10-15 08:54:06.100 [INFO][85] felix/driver.go 164: Calculated iptables mark bits </span><br><span class="line">acceptMark=0x10000 </span><br><span class="line">dropMark=0x40000 </span><br><span class="line">endpointMark=0xffe00000 </span><br><span class="line">endpointMarkNonCali=0x0 </span><br><span class="line">passMark=0x20000 </span><br><span class="line">scratch0Mark=0x80000 </span><br><span class="line">scratch1Mark=0x100000</span><br></pre></td></tr></table></figure><h3 id="host-ipset"><a href="#host-ipset" class="headerlink" title="host ipset"></a>host ipset</h3><p>å‘ç° calico æœ‰ä¸€ä¸ª ipset å­˜å‚¨äº†æœ¬æœºä¸Šçš„ç½‘å¡ IPï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Name: cali40this-host</span><br><span class="line">Type: hash:ip</span><br><span class="line">Revision: 4</span><br><span class="line">Header: family inet hashsize 1024 maxelem 1048576</span><br><span class="line">Size in memory: 456</span><br><span class="line">References: 0</span><br><span class="line">Number of entries: 7</span><br><span class="line">Members:</span><br><span class="line">127.0.0.1</span><br><span class="line">169.254.20.10</span><br><span class="line">10.187.220.0</span><br><span class="line">10.185.0.1</span><br><span class="line">10.xxx.xx.xxx #æœ¬æœºIP</span><br><span class="line">10.186.0.2</span><br></pre></td></tr></table></figure><p>ç›¸å…³ä»£ç åœ¨ï¼š</p><p><a href="https://github.com/projectcalico/calico/blob/v3.30.3/felix/daemon/daemon.go#L179">https://github.com/projectcalico/calico/blob/v3.30.3/felix/daemon/daemon.go#L179</a><br><a href="https://github.com/projectcalico/calico/blob/v3.30.3/felix/config/config_params.go#L1067">https://github.com/projectcalico/calico/blob/v3.30.3/felix/config/config_params.go#L1067</a></p><p>æŸ¥çœ‹ç›¸å…³æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker logs calico-node | grep int_dataplane.go</span></span><br><span class="line">2025-10-15 08:54:06.562 [INFO][85] felix/int_dataplane.go 2063: Started internal iptables dataplane driver loop</span><br><span class="line">2025-10-15 08:54:06.562 [INFO][85] felix/int_dataplane.go 2180: Will refresh IP sets on timer interval=1m30s</span><br><span class="line">2025-10-15 08:54:06.562 [INFO][85] felix/int_dataplane.go 2180: Will refresh routes on timer interval=1m30s</span><br><span class="line">2025-10-15 08:54:06.562 [INFO][85] felix/int_dataplane.go 2618: Started internal status report thread</span><br><span class="line">2025-10-15 08:54:06.562 [INFO][85] felix/int_dataplane.go 2620: Process status reports disabled</span><br><span class="line">2025-10-15 08:54:06.565 [INFO][85] felix/int_dataplane.go 1590: Linux interface state changed. ifIndex=1 ifaceName=&quot;lo&quot; state=&quot;up&quot;</span><br><span class="line">2025-10-15 08:54:06.565 [INFO][85] felix/int_dataplane.go 2259: Received interface update msg=&amp;intdataplane.ifaceStateUpdate&#123;Name:&quot;lo&quot;, State:&quot;up&quot;, Index:1&#125;</span><br><span class="line">2025-10-15 08:54:06.565 [INFO][85] felix/int_dataplane.go 1634: Linux interface addrs changed. addrs=set.Set&#123;127.0.0.0,127.0.0.1,::1,fe80::ecee:eeff:feee:eeee&#125; ifaceName=&quot;lo&quot;</span><br><span class="line">2025-10-15 08:54:06.565 [INFO][85] felix/int_dataplane.go 1590: Linux interface state changed. ifIndex=2 ifaceName=&quot;ens192&quot; state=&quot;up&quot;</span><br><span class="line">2025-10-15 08:54:06.565 [INFO][85] felix/int_dataplane.go 2286: Received interface addresses update msg=&amp;intdataplane.ifaceAddrsUpdate&#123;Name:&quot;lo&quot;, Addrs:set.Typed[string]&#123;&quot;127.0.0.0&quot;:set.v&#123;&#125;, &quot;127.0.0.1&quot;:set.v&#123;&#125;, &quot;::1&quot;:set.v&#123;&#125;, &quot;fe80::ecee:eeff:feee:eeee&quot;:set.v&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹æºç è·å–ç½‘å¡ IP é€»è¾‘åœ¨ <a href="https://github.com/projectcalico/calico/blob/v3.30.3/felix/ifacemonitor/iface_monitor.go">felix&#x2F;ifacemonitor&#x2F;iface_monitor.go</a> ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ Linux netlink æ¥å£è·å–ç½‘å¡å’Œå˜æ›´æ·»åŠ åˆ é™¤æ¶ˆæ¯ç›‘å¬ï¼Œç„¶åæ‰§è¡Œ OnUpdate ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/projectcalico/calico/blob/v3.30.3/felix/dataplane/linux/hostip_mgr.go#L81-L103</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *hostIPManager)</span></span> OnUpdate(msg <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line"><span class="keyword">switch</span> msg := msg.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> *ifaceAddrsUpdate:</span><br><span class="line">log.WithField(<span class="string">&quot;update&quot;</span>, msg).Info(<span class="string">&quot;Interface addrs changed.&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> m.nonHostIfacesRegexp.MatchString(msg.Name) &#123;</span><br><span class="line">log.WithField(<span class="string">&quot;update&quot;</span>, msg).Debug(<span class="string">&quot;Not a real host interface, ignoring.&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> msg.Addrs != <span class="literal">nil</span> &#123;</span><br><span class="line">m.hostIfaceToAddrs[msg.Name] = msg.Addrs</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">delete</span>(m.hostIfaceToAddrs, msg.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Host ip update is a relative rare event. Flush entire ipsets to make it simple.</span></span><br><span class="line">metadata := ipsets.IPSetMetadata&#123;</span><br><span class="line">Type:    ipsets.IPSetTypeHashIP,</span><br><span class="line">SetID:   m.hostIPSetID,</span><br><span class="line">MaxSize: m.maxSize,</span><br><span class="line">&#125;</span><br><span class="line">m.ipsetsDataplane.AddOrReplaceIPSet(metadata, m.getCurrentMembers())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¾è®¡"><a href="#è®¾è®¡" class="headerlink" title="è®¾è®¡"></a>è®¾è®¡</h2><ul><li>ä¸€ä¸ª ipset å­˜å‚¨ç™½åå• <code>whiteiplist</code>ï¼ŒåŒ¹é…ä¸Šå°± ACCEPT</li><li>ä¸€ä¸ª ipset å­˜å‚¨ Port <code>whiteportlist</code>ï¼Œæ­¤åˆ»è¿˜åŒ¹é…å°±è¯´æ˜ä¸æ˜¯ç™½åå•èµ°è¿‡æ¥ï¼Œæ‰“ mark 2</li><li>åŒ¹é…åˆ° mark 2 åˆ™ DROP</li></ul><p>å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥æŸä¸ªåœ°æ–¹å†åŠ ä¸€ä¸ªè§„åˆ™æ‰“ä¸Š mark 1 æ¥çƒ­ä¿®ã€‚</p><h3 id="mangle-è¡¨"><a href="#mangle-è¡¨" class="headerlink" title="mangle è¡¨"></a>mangle è¡¨</h3><p>ç”±äºæˆ‘ä»¬åªä½¿ç”¨ flannelï¼Œå¹¶ä¸”ä¹Ÿä¸éœ€è¦å„ç§æƒ…å†µï¼Œæ‰€ä»¥å°±ä¸ç”¨ mark å¤„ç†äº†ï¼Œæ‰€ä»¥ä¹Ÿåªæ˜¯åƒ calico é‚£æ ·åœ¨ mangle çš„ PRETOUTING åšé“¾ ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å…ˆåˆ›å»ºé“¾</span></span><br><span class="line">iptables --wait --table mangle --new test-PREROUTING</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ’å…¥ mangle è¡¨çš„ PREROUTING é“¾å‰é¢</span></span><br><span class="line">iptables --wait --table mangle --insert PREROUTING --jump test-PREROUTING</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¾è¡Œå·²å»ºç«‹çš„è¿æ¥</span></span><br><span class="line">iptables --wait --table mangle --insert test-PREROUTING -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå•ç‹¬çš„é“¾</span></span><br><span class="line">iptables --wait --table mangle --new test-from-host-endpoint</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŒ¹é…è¡Œä¸ºåœ¨ test-from-host-endpoint é‡Œåšï¼Œæœ‰é—®é¢˜åœ¨å®ƒå‰é¢ INSERT è§„åˆ™å³å¯</span></span><br><span class="line">iptables --wait --table mangle --append test-PREROUTING -j test-from-host-endpoint</span><br></pre></td></tr></table></figure><h3 id="test-from-host-endpoint-é“¾"><a href="#test-from-host-endpoint-é“¾" class="headerlink" title="test-from-host-endpoint é“¾"></a>test-from-host-endpoint é“¾</h3><p>æ‹†æˆä¸¤ä¸ªæ˜¯å¯ä»¥åç»­å† <code>test-from-host-endpoint</code> å‰ insert æœ¬æœºç½‘å¡ IP æˆ–è€…å¯ä»¥æ·»åŠ ç±»ä¼¼ <code>failsafe-in</code> ä¹‹ç±»çš„ ipset ä¹‹ç±»çš„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç™½åå• IP ç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">iptables --wait --table mangle --append test-from-host-endpoint -m set --match-set whiteiplist src -j ACCEPT</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éç™½åå• ip è®¿é—®ç™½åå•ç«¯å£æ‹’ç»</span></span><br><span class="line">iptables --wait --table mangle --append test-from-host-endpoint -m set --match-set whiteportlist dst -j DROP</span><br></pre></td></tr></table></figure><p>filter è¡¨çš„ INPUT é“¾é‡Œæˆ‘ä»¬ä¹ŸåŠ äº†ä¸‹ç±»ä¼¼ this-host çš„é€»è¾‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -j BASE-RULE</span><br><span class="line"></span><br><span class="line">-A BASE-RULE -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A BASE-RULE -m set --match-set whiteiplist src -j ACCEPT</span><br><span class="line">-A BASE-RULE -m set --match-set this-host src -j ACCEPT</span><br><span class="line">-A BASE-RULE -m set --match-set whiteportlist dst -j DROP</span><br></pre></td></tr></table></figure><h2 id="æˆå“"><a href="#æˆå“" class="headerlink" title="æˆå“"></a>æˆå“</h2><p>æ”¯æŒåŒæ ˆï¼Œæ”¯æŒè·å–ç½‘å¡IPï¼Œipv6 æ ¹æ® ipv6list å’Œ <code>cat /proc/sys/net/ipv6/conf/all/disable_ipv6</code> å€¼åšå¼€å…³</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Name: this-host</span><br><span class="line">Type: hash:net</span><br><span class="line">Revision: 6</span><br><span class="line">Header: family inet hashsize 1024 maxelem 1000000</span><br><span class="line">Size in memory: 568</span><br><span class="line">References: 1</span><br><span class="line">Number of entries: 3</span><br><span class="line">Members:</span><br><span class="line">127.0.0.0/24</span><br><span class="line">10.xx.94.189</span><br><span class="line">169.254.0.0/16</span><br><span class="line"></span><br><span class="line">Name: whiteipv6list</span><br><span class="line">Type: hash:net</span><br><span class="line">Revision: 6</span><br><span class="line">Header: family inet6 hashsize 1024 maxelem 1000000</span><br><span class="line">Size in memory: 1608</span><br><span class="line">References: 2</span><br><span class="line">Number of entries: 4</span><br><span class="line">Members:</span><br><span class="line">2408:8656:22df:ff01::14:1620</span><br><span class="line">2408:8656:22df:ff01::14:1621</span><br><span class="line">::1</span><br><span class="line">2408:8656:22df:ff01::14:1622</span><br><span class="line"></span><br><span class="line">Name: this-host6</span><br><span class="line">Type: hash:net</span><br><span class="line">Revision: 6</span><br><span class="line">Header: family inet6 hashsize 1024 maxelem 1000000</span><br><span class="line">Size in memory: 1496</span><br><span class="line">References: 1</span><br><span class="line">Number of entries: 3</span><br><span class="line">Members:</span><br><span class="line">ee80:169:254:20::/64</span><br><span class="line">2408:8656:22df:ff01::14:1620</span><br><span class="line">::1</span><br><span class="line"></span><br><span class="line">Name: whiteportlist</span><br><span class="line">Type: bitmap:port</span><br><span class="line">Revision: 3</span><br><span class="line">Header: range 0-65535</span><br><span class="line">Size in memory: 8296</span><br><span class="line">References: 4</span><br><span class="line">Number of entries: 230</span><br><span class="line">Members:</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä¸€äº›ä»…ä¾›ä»–äººå‚è€ƒçš„ shellï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">function get_if_inet()&#123;</span><br><span class="line">  local if=$1</span><br><span class="line">  ip -4 -o a s $if | awk &#x27;&#123;print $4&#125;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function this_host()&#123;</span><br><span class="line">  ipset create this-host hash:net maxelem 1000000 -exist</span><br><span class="line">  ipset add this-host 127.0.0.1/24 -exist</span><br><span class="line">  ipset add this-host 169.254.0.0/16 -exist</span><br><span class="line"></span><br><span class="line">  if [ -d /sys/devices/virtual/net/cni0/ ];then</span><br><span class="line">    ipset add this-host $(get_if_inet cni0| sed &#x27;s#/\d+#/16#&#x27;) -exist</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  ip -o -4 a s scope global | grep -Ev &#x27;:\s+(cali|tunl|vxlan|flannel|docker0|veth|wireguard|wg|cni0|kube|dummy|veth)&#x27; | awk -F&#x27;[ /]+&#x27; &#x27;&#123;print $4&#125;&#x27;| \</span><br><span class="line">  while read ip;do</span><br><span class="line">    ipset add this-host $ip -exist</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_if_inet6()&#123;</span><br><span class="line">  local if=$1 ignore=$2 inet6</span><br><span class="line">  inet6=ip -6 -o a s $if | awk &#x27;&#123;print $4&#125;&#x27;</span><br><span class="line">  if [ -n &quot;$ignore&quot; ];then</span><br><span class="line">    inet6=$(echo $inet6 | grep -Ev &quot;$2&quot;)</span><br><span class="line">  fi</span><br><span class="line">  echo $inet6</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function this_host6()&#123;</span><br><span class="line">  ipset create this-host6 hash:net maxelem 1000000 family inet6 -exist</span><br><span class="line">  ipset add this-host6 ::1 -exist</span><br><span class="line"></span><br><span class="line">  if [ -d /sys/devices/virtual/net/cni0/ ];then</span><br><span class="line">    cni0_inet6=$(get_if_inet6 cni0| sed &#x27;s#/\d+#/56#&#x27;)</span><br><span class="line">    if [ -n &quot;$cni0_inet6&quot; ];then</span><br><span class="line">      ipset add this-host6 $cni0_inet6 -exist</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  ip -o -6 a s scope global | grep -Ev &#x27;:\s+(cali|tunl|vxlan|flannel|docker0|veth|wireguard|wg|cni0|kube|dummy|veth)&#x27; |\</span><br><span class="line">   grep -Ev &#x27;^fe80::.+/64&#x27; | awk -F&#x27;[ /]+&#x27; &#x27;&#123;print $4&#125;&#x27;| \</span><br><span class="line">  while read ip;do</span><br><span class="line">    ipset add this-host6 $ip -exist</span><br><span class="line">  done</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç ”ç©¶ä¸‹ calico å¦‚ä½•å®ç° nodePort ç™½åå•ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="nodeport" scheme="http://zhangguanzhang.github.io/tags/nodeport/"/>
    
  </entry>
  
  <entry>
    <title>hostNetworkä¸‹hostnameçš„å‘</title>
    <link href="http://zhangguanzhang.github.io/2025/10/13/k8s-hostNetwork-hostname/"/>
    <id>http://zhangguanzhang.github.io/2025/10/13/k8s-hostNetwork-hostname/</id>
    <published>2025-10-13T10:10:30.000Z</published>
    <updated>2025-10-13T10:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‡çº§å’Œå‹æµ‹é‡åˆ°çš„ hostNetwork ä¸‹ hostname çš„å‘é—®é¢˜</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æ€§èƒ½å‹æµ‹å›¢é˜Ÿå‹æµ‹åå‘ç° kafka çš„æ•°æ®ç›®å½•ä¸‹æœ‰ä¿©ä¸ªå¾ˆå¤§çš„ç›®å½•ç»™æœºå™¨ç›®å½•å æ»¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">total 88</span><br><span class="line">drwxr-xr-x 568 nfsnobody nfsnobody 28672 Oct  1 17:42 kafka-logs-kafka-1</span><br><span class="line">drwxr-xr-x 535 nfsnobody nfsnobody 28672 Sep 26 19:51 kafka-logs-vm10-7-131-94</span><br></pre></td></tr></table></figure><h2 id="å¤§å°é—®é¢˜"><a href="#å¤§å°é—®é¢˜" class="headerlink" title="å¤§å°é—®é¢˜"></a>å¤§å°é—®é¢˜</h2><p>å¤§å°é—®é¢˜æ˜¯å› ä¸º kafka é»˜è®¤é…ç½® <code>log.retention.bytes = -1</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> docker logs 2d21e7 |&amp; grep -P <span class="string">&#x27;^\s+log\.retention&#x27;</span></span></span><br><span class="line">log.retention.bytes = -1</span><br><span class="line">log.retention.check.interval.ms = 150000</span><br><span class="line">log.retention.hours = 168</span><br><span class="line">log.retention.minutes = null</span><br><span class="line">log.retention.ms = null</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹äº†ä¸‹ kafka çš„å¯åŠ¨è„šæœ¬ï¼Œæ”¯æŒ env é…ç½®ï¼Œé…ç½®ä¸‹ <code>KAFKA_LOG_RETENTION_BYTES: &quot;1073741824&quot;</code> åæµ‹è¯•æ²¡é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç»ˆç«¯1å†™å…¥topic</span></span><br><span class="line">for i in &#123;1..1000&#125;; do head -c 102400000 /dev/urandom | base64 |kafka-console-producer.sh --bootstrap-server 127.0.0.1:9092  --topic test; done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç»ˆç«¯2 è§‚å¯Ÿ</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">du</span> -shx *; <span class="built_in">ls</span> -lh test-0</span></span><br><span class="line">0cleaner-offset-checkpoint</span><br><span class="line">4.0Klog-start-offset-checkpoint</span><br><span class="line">4.0Kmeta.properties</span><br><span class="line">4.0Krecovery-point-offset-checkpoint</span><br><span class="line">4.0Kreplication-offset-checkpoint</span><br><span class="line">3.5Gtest-0</span><br><span class="line">3.5Gtest-1</span><br><span class="line">æ€»ç”¨é‡ 3.5G</span><br><span class="line">-rwxr-xr-x 1 65534 65534 514K 10æœˆ 13 17:58 00000000000012487638.index.deleted</span><br><span class="line">-rwxr-xr-x 1 65534 65534 1.0G 10æœˆ 13 17:58 00000000000012487638.log.deleted</span><br><span class="line">-rwxr-xr-x 1 65534 65534 355K 10æœˆ 13 17:58 00000000000012487638.timeindex.deleted</span><br><span class="line">-rwxr-xr-x 1 65534 65534 517K 10æœˆ 13 19:02 00000000000024975185.index</span><br><span class="line">-rwxr-xr-x 1 65534 65534 1.0G 10æœˆ 13 19:02 00000000000024975185.log</span><br><span class="line">-rwxr-xr-x 1 65534 65534 4.0K 10æœˆ 13 17:58 00000000000024975185.snapshot</span><br><span class="line">-rwxr-xr-x 1 65534 65534 372K 10æœˆ 13 19:02 00000000000024975185.timeindex</span><br><span class="line">-rwxr-xr-x 1 65534 65534 4.1K 10æœˆ 13 18:02 00000000000027453871.snapshot</span><br><span class="line">-rw-r--r-- 1 65534 65534  10M 10æœˆ 13 19:02 00000000000037462545.index</span><br><span class="line">-rw-r--r-- 1 65534 65534 430M 10æœˆ 13 19:02 00000000000037462545.log</span><br><span class="line">-rw-r--r-- 1 65534 65534 4.6K 10æœˆ 13 19:02 00000000000037462545.snapshot</span><br><span class="line">-rw-r--r-- 1 65534 65534  10M 10æœˆ 13 19:02 00000000000037462545.timeindex</span><br><span class="line">-rw-r--r-- 1 65534 65534   15 10æœˆ 13 19:03 leader-epoch-checkpoint</span><br><span class="line">-rwxr-xr-x 1 65534 65534   43 10æœˆ 13 17:33 partition.metadata</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">du</span> -shx *; <span class="built_in">ls</span> -lh test-0</span></span><br><span class="line">0cleaner-offset-checkpoint</span><br><span class="line">4.0Klog-start-offset-checkpoint</span><br><span class="line">4.0Kmeta.properties</span><br><span class="line">4.0Krecovery-point-offset-checkpoint</span><br><span class="line">4.0Kreplication-offset-checkpoint</span><br><span class="line">1.5Gtest-0</span><br><span class="line">1.5Gtest-1</span><br><span class="line">æ€»ç”¨é‡ 1.5G</span><br><span class="line">-rwxr-xr-x 1 65534 65534 517K 10æœˆ 13 19:02 00000000000024975185.index</span><br><span class="line">-rwxr-xr-x 1 65534 65534 1.0G 10æœˆ 13 19:02 00000000000024975185.log</span><br><span class="line">-rwxr-xr-x 1 65534 65534 4.0K 10æœˆ 13 17:58 00000000000024975185.snapshot</span><br><span class="line">-rwxr-xr-x 1 65534 65534 372K 10æœˆ 13 19:02 00000000000024975185.timeindex</span><br><span class="line">-rwxr-xr-x 1 65534 65534 4.1K 10æœˆ 13 18:02 00000000000027453871.snapshot</span><br><span class="line">-rw-r--r-- 1 65534 65534  10M 10æœˆ 13 19:02 00000000000037462545.index</span><br><span class="line">-rw-r--r-- 1 65534 65534 430M 10æœˆ 13 19:02 00000000000037462545.log</span><br><span class="line">-rw-r--r-- 1 65534 65534 4.6K 10æœˆ 13 19:02 00000000000037462545.snapshot</span><br><span class="line">-rw-r--r-- 1 65534 65534  10M 10æœˆ 13 19:02 00000000000037462545.timeindex</span><br><span class="line">-rw-r--r-- 1 65534 65534   15 10æœˆ 13 19:03 leader-epoch-checkpoint</span><br><span class="line">-rwxr-xr-x 1 65534 65534   43 10æœˆ 13 17:33 partition.metadata</span><br></pre></td></tr></table></figure><h2 id="hostname-é—®é¢˜"><a href="#hostname-é—®é¢˜" class="headerlink" title="hostname é—®é¢˜"></a>hostname é—®é¢˜</h2><h3 id="ä¸¤ä¸ªå¸¦-hostname-ç›®å½•çš„é—®é¢˜"><a href="#ä¸¤ä¸ªå¸¦-hostname-ç›®å½•çš„é—®é¢˜" class="headerlink" title="ä¸¤ä¸ªå¸¦ hostname ç›®å½•çš„é—®é¢˜"></a>ä¸¤ä¸ªå¸¦ hostname ç›®å½•çš„é—®é¢˜</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/wurstmeister/kafka-docker/blob/master/start-kafka.sh#L43C1-L45C3</span></span><br><span class="line">if [[ -z &quot;$KAFKA_LOG_DIRS&quot; ]]; then</span><br><span class="line">    export KAFKA_LOG_DIRS=&quot;/kafka/kafka-logs-$HOSTNAME&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>ä»å¯åŠ¨è„šæœ¬çœ‹åˆ°ä¸Šé¢é€»è¾‘ï¼Œæ²¡æœ‰è®¾ç½®å°±æ‹¼æ¥ hostnameï¼ŒæŒ‡å®š <code>KAFKA_LOG_DIRS</code> æˆå›ºå®šï¼Œå†ä¿®æ”¹å¯åŠ¨è„šæœ¬æ”¯æŒå‡çº§åæŠŠè€ç›®å½• mv æˆä¸å¸¦ hostname çš„å”¯ä¸€ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if [ -n &quot;$KAFKA_LOG_DIRS&quot; ] &amp;&amp; ! [ -d &quot;$KAFKA_LOG_DIRS&quot; ];then</span><br><span class="line">latest_log_dir=$(ls -1 -t -d /kafka/kafka-logs-* | head -n1)</span><br><span class="line">if [ -n &quot;$latest_log_dir&quot; ];then</span><br><span class="line">echo &quot;found old kafka-logs-: $&#123;latest_log_dir&#125;&quot;</span><br><span class="line">mv -v $latest_log_dir $KAFKA_LOG_DIRS</span><br><span class="line">fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="hostname-é—®é¢˜-1"><a href="#hostname-é—®é¢˜-1" class="headerlink" title="hostname é—®é¢˜"></a>hostname é—®é¢˜</h3><p>ä¸¤ä¸ªç›®å½•é—®é¢˜è¿˜æ˜¯è¦æŸ¥æ‰¾åŸå› çš„ï¼Œå‡ºç°çš„åœºæ™¯æ˜¯åœ¨æˆ‘ä»¬ kafka ä¹‹å‰æ˜¯ staticPod + hostPath éƒ¨ç½²çš„ï¼Œåé¢åˆ‡æˆ docker-compose éƒ¨ç½²åå‘ç”Ÿçš„ï¼Œç›¸å…³é…ç½®ä¸ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># staticPod</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">kafka-&#123;&#123;</span> <span class="string">MY_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-compose</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">kafka-&#123;&#123;</span> <span class="string">kafka.MY_ID</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>è€Œä»”ç»†çœ‹ mtimeï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">total 88</span><br><span class="line">drwxr-xr-x 568 nfsnobody nfsnobody 28672 Oct  1 17:42 kafka-logs-kafka-1</span><br><span class="line">drwxr-xr-x 535 nfsnobody nfsnobody 28672 Sep 26 19:51 kafka-logs-vm10-7-131-94</span><br></pre></td></tr></table></figure><p><code>-kafka-1</code> æ˜¯æœ€æ–°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ docker-compose æ²¡é—®é¢˜ï¼Œè€Œ k8s çš„å®¹å™¨è·å–åˆ°çš„æ˜¯å®¿ä¸»æœºçš„ hostnameï¼ŒéªŒè¯äº†ä¸‹ç¡®å®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -ti --entrypoint hostname --net host --hostname test111 m.daocloud.io/docker.io/library/nginx:alpine</span> </span><br><span class="line">test111</span><br></pre></td></tr></table></figure><p>æµ‹è¯• <code>hostNetwork</code> å’Œ <code>hostname</code> ä¸€èµ·ä¸‹ï¼Œå®¹å™¨çš„ hostname æ˜¯å®¿ä¸»æœºçš„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-hostname</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">m.daocloud.io/docker.io/library/nginx:alpine</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">test111</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>ä¸€å¼€å§‹æƒ³ç€æ˜¯ cri-dockerd çš„ bugï¼Œæƒ³ç€å»å†æäº¤ä¸€ä¸ª pr ï¼Œäºæ˜¯å…ˆè®©ç¾¤å‹ containerd ç¯å¢ƒ K8S æµ‹ä¸‹ï¼Œå¥½æ‹¿ä¿¡æ¯å»æäº¤ prã€‚ç»“æœå‘ç° containerd K8S ä¸‹ä¹Ÿä¸€æ ·æ˜¯å®¿ä¸»æœºçš„ hostnameï¼Œæœç´¢äº†ä¸‹åå‘ç°ï¼š</p><p><a href="https://github.com/kubernetes/kubernetes/issues/67019">https://github.com/kubernetes/kubernetes/issues/67019</a></p><p>æ˜¯ K8S ä»£ç é€»è¾‘å¯¼è‡´çš„ï¼Œçœ‹äº†ä¸‹ issueï¼Œçœ‹åˆ°æœ‰ pr å…³è” <a href="https://github.com/kubernetes/kubernetes/pull/132558/files">KEP-4762: Allows setting any FQDN as the podâ€™s hostname</a> æ˜¯æ–°ç‰ˆæœ¬é‡ŒåŠ äº†ä¸ªç‰¹æ€§ <code>features.HostnameOverride</code> é—¨æ§å’Œå­—æ®µ <code>HostnameOverride</code>ï¼Œä½†æ˜¯çœ‹äº†ä¸‹æè¿°ï¼Œå‘ç°å‹æ ¹ä¸æ˜¯ä¸€å›äº‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">HostnameOverride</span> <span class="string">specifies</span> <span class="string">an</span> <span class="string">explicit</span> <span class="string">override</span> <span class="string">for</span> <span class="string">the</span> <span class="string">pod&#x27;s</span> <span class="string">hostname</span> <span class="string">as</span> <span class="string">perceived</span> <span class="string">by</span> <span class="string">the</span> <span class="string">pod.</span></span><br><span class="line"><span class="string">//</span> <span class="string">This</span> <span class="string">field</span> <span class="string">only</span> <span class="string">specifies</span> <span class="string">the</span> <span class="string">pod&#x27;s</span> <span class="string">hostname</span> <span class="string">and</span> <span class="string">does</span> <span class="string">not</span> <span class="string">affect</span> <span class="string">its</span> <span class="string">DNS</span> <span class="string">records.</span></span><br><span class="line"><span class="string">//</span> <span class="attr">When this field is set to a non-empty string:</span></span><br><span class="line"><span class="string">//</span> <span class="bullet">-</span> <span class="string">It</span> <span class="string">takes</span> <span class="string">precedence</span> <span class="string">over</span> <span class="string">the</span> <span class="string">values</span> <span class="string">set</span> <span class="string">in</span> <span class="string">`hostname`</span> <span class="string">and</span> <span class="string">`subdomain`.</span></span><br><span class="line"><span class="string">//</span> <span class="bullet">-</span> <span class="string">The</span> <span class="string">Pod&#x27;s</span> <span class="string">hostname</span> <span class="string">will</span> <span class="string">be</span> <span class="string">set</span> <span class="string">to</span> <span class="string">this</span> <span class="string">value.</span></span><br><span class="line"><span class="string">//</span> <span class="bullet">-</span> <span class="string">`setHostnameAsFQDN`</span> <span class="string">must</span> <span class="string">be</span> <span class="string">nil</span> <span class="string">or</span> <span class="string">set</span> <span class="string">to</span> <span class="string">false.</span></span><br><span class="line"><span class="string">//</span> <span class="bullet">-</span> <span class="string">`hostNetwork`</span> <span class="string">must</span> <span class="string">be</span> <span class="string">set</span> <span class="string">to</span> <span class="string">false.</span></span><br><span class="line"><span class="string">//</span></span><br><span class="line"><span class="string">//</span> <span class="string">This</span> <span class="string">field</span> <span class="string">must</span> <span class="string">be</span> <span class="string">a</span> <span class="string">valid</span> <span class="string">DNS</span> <span class="string">subdomain</span> <span class="string">as</span> <span class="string">defined</span> <span class="string">in</span> <span class="string">RFC</span> <span class="number">1123 </span><span class="string">and</span> <span class="string">contain</span> <span class="string">at</span> <span class="string">most</span> <span class="number">64</span> <span class="string">characters.</span></span><br><span class="line"><span class="string">//</span> <span class="string">Requires</span> <span class="string">the</span> <span class="string">HostnameOverride</span> <span class="string">feature</span> <span class="string">gate</span> <span class="string">to</span> <span class="string">be</span> <span class="string">enabled.</span></span><br><span class="line"><span class="string">//</span></span><br><span class="line"><span class="string">//</span> <span class="string">+featureGate=HostnameOverride</span></span><br><span class="line"><span class="string">//</span> <span class="string">+optional</span></span><br><span class="line"><span class="string">HostnameOverride</span> <span class="meta">*string</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„çœ‹ä¸Šé¢çš„ <code>hostNetwork must be set to false.</code> ï¼Œæ–°ç‰ˆæœ¬çš„è¿™ä¸ªç‰¹æ€§å‹æ ¹è§£å†³ä¸äº†è¿™ä¸ªé—®é¢˜ï¼Œåªèƒ½æ˜¯è‡ªå·±è¸©å‘äº†ã€‚</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>æˆªæ­¢ç›®å‰ä¸ºæ­¢ï¼Œk8s çš„ Pod åŒæ—¶é…ç½® <code>hostNetwork</code> å’Œ <code>hostname</code> ä¸‹ï¼Œå®¹å™¨å†…çš„ hostname æ˜¯å®¿ä¸»æœºçš„ï¼Œdocker ç›´æ¥èµ·è¿™æ ·é…ç½®çš„å®¹å™¨åˆ™æ²¡é—®é¢˜ï¼Œå¦‚æœä½ çš„è¿›ç¨‹ä¾èµ– hostnameï¼Œåˆ™è¦æ³¨æ„è¿™å—ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘å‡çº§å’Œå‹æµ‹é‡åˆ°çš„ hostNetwork ä¸‹ hostname çš„å‘é—®é¢˜&lt;/p&gt;</summary>
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="hostname" scheme="http://zhangguanzhang.github.io/tags/hostname/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ªåˆ«èŠ‚ç‚¹ä¸Š flannel.1 çš„ IP æ— æ³• ping</title>
    <link href="http://zhangguanzhang.github.io/2025/09/23/flannel.1-cannot-ping/"/>
    <id>http://zhangguanzhang.github.io/2025/09/23/flannel.1-cannot-ping/</id>
    <published>2025-09-23T10:10:30.000Z</published>
    <updated>2025-09-23T10:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€æ¬¡å®¢æˆ·ç¯å¢ƒä¸Šä¸ªåˆ«èŠ‚ç‚¹ flannel.1 çš„ IP æ— æ³• ping çš„æ’æŸ¥</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å®¢æˆ·åé¦ˆä»–ä»¬ç¯å¢ƒ agent å‘Šè­¦ç›‘æ§ï¼š æœ¬æœºä¸Šçš„ IP <code>10.187.12.0</code> æ— æ³• ping é€šã€‚</p><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><h3 id="å®šä½èŒƒå›´"><a href="#å®šä½èŒƒå›´" class="headerlink" title="å®šä½èŒƒå›´"></a>å®šä½èŒƒå›´</h3><p>å®¢æˆ·ç¯å¢ƒä¸èƒ½è¿œç¨‹ï¼Œéƒ½æ˜¯å‘å‘½ä»¤è®©æŸ¥çš„ï¼ŒæŸ¥çœ‹ flannel å®¹å™¨å‡æ²¡æœ‰é‡å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docekr ps -a | grep flanneld</span></span><br><span class="line">cb0e35b00899   1e0b2bff6efb               &quot;/opt/bin/flanneld -â€¦&quot;   7 weeks ago   Up 7 weeks                                k8s_kube-flannel_kube-flannel-ds-qbps5_kube-system_bffc6d17-0835-468d-bb90-2367c190c94f_0</span><br></pre></td></tr></table></figure><p>è®©å®¢æˆ·å»å‘Šè­¦æœºå™¨ä¸Š pingï¼Œå®¢æˆ·è¯´ cni0 åœ°å€æ˜¯é€šçš„ï¼Œå°± <code>10.187.12.0</code> å’Œ <code>10.187.11.0</code> æ— æ³• ping é€šï¼Œæ²Ÿé€šä¸€ç•ªæ‰æ„è¯†åˆ°æ˜¯è¿™ä¿© ip åœ¨å„è‡ªæœ¬æœºä¸Šæ— æ³• ping é€šï¼Œç›´æ¥ ping æŠ¥é”™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 10.187.12.0</span></span><br><span class="line">Do you want to ping broadcast? Then -b. If not, check your local firewall rules.</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ <code>flannel.1</code> å’Œ <code>cni0</code> çš„ IP ä¿¡æ¯ä¹Ÿæ²¡é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip a s flannel.1</span></span><br><span class="line">9: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default </span><br><span class="line">    link/ether 4e:81:e2:84:ff:49 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.187.12.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4c81:e2ff:fe84:ff49/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip a s cni0</span></span><br><span class="line">7: cni0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 02:e6:56:fb:18:3d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.187.12.1/24 brd 10.187.12.255 scope global cni0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::e6:56ff:fefb:183d/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹å†…æ ¸å‚æ•°ä¹Ÿæ­£å¸¸ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>å»æœä¸‹æºç çœ‹çœ‹ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -qf `<span class="built_in">which</span> ping`</span></span><br><span class="line">iputils-20190709-5.ky10.aarch64</span><br></pre></td></tr></table></figure><p>æœåˆ°æºç  iputils æ²¡ç‰¹æ®Šå¤„ç†é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/iputils/iputils/blob/master/ping/ping.c#L885-L895</span></span><br><span class="line"></span><br><span class="line">sock_setmark(rts, probe_fd);</span><br><span class="line"></span><br><span class="line">dst.sin_port = htons(<span class="number">1025</span>);</span><br><span class="line"><span class="keyword">if</span> (rts-&gt;nroute)</span><br><span class="line">dst.sin_addr.s_addr = rts-&gt;route[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (connect(probe_fd, (<span class="keyword">struct</span> sockaddr *)&amp;dst, <span class="keyword">sizeof</span>(dst)) == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (errno == EACCES) &#123;</span><br><span class="line"><span class="keyword">if</span> (rts-&gt;broadcast_pings == <span class="number">0</span>)</span><br><span class="line">error(<span class="number">2</span>, <span class="number">0</span>,</span><br><span class="line">_(<span class="string">&quot;Do you want to ping broadcast? Then -b. If not, check your local firewall rules&quot;</span>));</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, _(<span class="string">&quot;WARNING: pinging broadcast address\n&quot;</span>));</span><br></pre></td></tr></table></figure><p>å®Œå…¨èµ°çš„ç³»ç»Ÿå±‚é¢åˆ†é…ï¼Œè·å–åˆ°çš„åœ°å€æ˜¯å¹¿æ’­åœ°å€æ‰æŠ¥é”™ï¼Œçœ‹ä¸‹è·¯ç”±ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show</span></span><br><span class="line">default via xxx dev enp4s0</span><br><span class="line">....</span><br><span class="line">10.187.12.0/24 dev cni0 proto kernel scope link src 10.187.12.1</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è·¯ç”±åŒ¹é…å°±æœ‰é—®é¢˜äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route get 10.187.12.0</span></span><br><span class="line">broadcast 10.187.12.0 dev cni0 src 10.187.12.1 uid 58248</span><br><span class="line">    cache &lt;local,brd&gt;</span><br></pre></td></tr></table></figure><p>çœ‹æ¥é—®é¢˜å°±åœ¨è·¯ç”±è¿™å—ï¼Œ<code>ip route show</code> å®é™…æ˜¯ <code>ip route show talbe main</code> çœ‹ä¸‹ç”±ç½‘å¡ç”Ÿæˆçš„ local è·¯ç”±è¡¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show table <span class="built_in">local</span> | grep 10.187.12.0</span></span><br><span class="line">broadcast 10.187.12.0 dev cni0 proto kernel scope link src 10.187.12.1 </span><br><span class="line">local 10.187.12.0 dev flannel.1 proto kernel scope host src 10.187.12.0</span><br></pre></td></tr></table></figure><p>æœç„¶æ˜¯é¡ºåºå¯¼è‡´ï¼Œlocal è·¯ç”±è¡¨æ˜¯æ ¹æ®ç½‘å¡é¡ºåºç”Ÿæˆçš„ï¼Œå‰é¢ç»†å¿ƒçš„è¯ä¼šå‘ç° <code>flannel.1</code> å‰é¢æ•°å­—æ˜¯ 9ï¼Œ<code>cni0</code> æ˜¯ 7ï¼Œæ„å‘³ç€ <code>cni0</code> æ¯” <code>flannel.1</code> å…ˆåˆ›å»ºï¼Œæˆ–è€…æ˜¯ <code>flannel.1</code> ç½‘å¡åˆ é™¤åé‡å¯ flanneld å®¹å™¨åˆ›å»ºçš„ã€‚</p><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>å†…éƒ¨æ‰¾ä¸ª k8s ç¯å¢ƒæµ‹è¯•ä¸‹å¤ç°äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip a s flannel.1</span></span><br><span class="line">6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default </span><br><span class="line">    link/ether 4a:53:ae:34:23:99 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.187.2.0/32 scope global flannel.1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4853:aeff:fe34:2399/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 10.187.2.0</span></span><br><span class="line">PING 10.187.2.0 (10.187.2.0) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.187.2.0: icmp_seq=1 ttl=64 time=0.042 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.187.2.0 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.042/0.042/0.042/0.000 ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip <span class="built_in">link</span> delete flannel.1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a | grep flanneld</span></span><br><span class="line">46079b620076   reg.xxx.lan:5000/xxx/flannel                                                     &quot;/opt/bin/flanneld -â€¦&quot;   8 days ago       Up 8 days </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker restart 460</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 10.187.2.0</span></span><br><span class="line">Do you want to ping broadcast? Then -b. If not, check your local firewall rules.</span><br></pre></td></tr></table></figure><h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><p>æ·»åŠ  32 ä½æ©ç è·¯ç”±ä¸è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route add 10.187.2.0/32 dev flannel.1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 10.187.2.0</span></span><br><span class="line">Do you want to ping broadcast? Then -b. If not, check your local firewall rules.</span><br></pre></td></tr></table></figure><p>å› ä¸º local å…ˆåŒ¹é…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show table <span class="built_in">local</span> | grep 10.187.2.0</span></span><br><span class="line">broadcast 10.187.2.0 dev cni0 proto kernel scope link src 10.187.2.1 </span><br><span class="line">local 10.187.2.0 dev flannel.1 proto kernel scope host src 10.187.2.0 </span><br></pre></td></tr></table></figure><p>åˆ é™¤åå¯ä»¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route delete broadcast 10.187.2.0 dev cni0 proto kernel scope <span class="built_in">link</span> src 10.187.2.1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show</span></span><br><span class="line">...</span><br><span class="line">10.185.0.0/16 dev docker0 proto kernel scope link src 10.185.0.1 </span><br><span class="line">10.187.0.0/24 via 10.187.0.0 dev flannel.1 onlink </span><br><span class="line">10.187.1.0/24 via 10.187.1.0 dev flannel.1 onlink </span><br><span class="line">10.187.2.0/24 dev cni0 proto kernel scope link src 10.187.2.1 </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip route show table <span class="built_in">local</span>  | grep 10.187.2.0</span></span><br><span class="line">local 10.187.2.0 dev flannel.1 proto kernel scope host src 10.187.2.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 10.187.2.0</span></span><br><span class="line">PING 10.187.2.0 (10.187.2.0) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.187.2.0: icmp_seq=1 ttl=64 time=0.074 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.187.2.0 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.074/0.074/0.074/0.000 ms</span><br></pre></td></tr></table></figure><p>æµ‹ä¸‹è·¨èŠ‚ç‚¹ä¹Ÿæ²¡é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ping 10.187.0.1</span></span><br><span class="line">PING 10.187.0.1 (10.187.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.187.0.1: icmp_seq=1 ttl=64 time=0.365 ms</span><br><span class="line">64 bytes from 10.187.0.1: icmp_seq=2 ttl=64 time=0.325 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.187.0.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.325/0.345/0.365/0.020 ms</span><br></pre></td></tr></table></figure><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>è™½ç„¶è¿™ä¸ªç»†èŠ‚é—®é¢˜ä¸å½±å“ k8s overlay ç½‘ç»œï¼Œä½†æ˜¯å®¢æˆ·ç›‘æ§å‘Šè­¦è¦æŸ¥æ¸…æ¥šåŸå› ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€æ¬¡å®¢æˆ·ç¯å¢ƒä¸Šä¸ªåˆ«èŠ‚ç‚¹ flannel.1 çš„ IP æ— æ³• ping çš„æ’æŸ¥&lt;/p&gt;</summary>
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="flannel" scheme="http://zhangguanzhang.github.io/tags/flannel/"/>
    
  </entry>
  
  <entry>
    <title>salt-runå¾ˆä¹…æ‰è¿”å›</title>
    <link href="http://zhangguanzhang.github.io/2025/09/12/salt-run-hang/"/>
    <id>http://zhangguanzhang.github.io/2025/09/12/salt-run-hang/</id>
    <published>2025-09-12T20:10:30.000Z</published>
    <updated>2025-09-12T20:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€æ¬¡ salt-run å¾ˆä¹…æ‰è¿”å›çš„æ’æŸ¥</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æ‰€æœ‰ salt-run å‘½ä»¤è€—æ—¶éƒ½å¾ˆä¹…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ time salt-run jobs.active</span><br><span class="line">[INFO    ] Runner completed: 20250912111420062465_14113</span><br><span class="line"></span><br><span class="line">real0m23.432s</span><br><span class="line">user0m2.716s</span><br><span class="line">sys0m0.320s</span><br></pre></td></tr></table></figure><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><p>salt-master æ˜¯å®¹å™¨é‡Œè¿è¡Œçš„ï¼Œè¯¥å®¹å™¨æ²¡ ptrace æƒé™ï¼Œæ€•é‡å¯å®¹å™¨åæ•…éšœæ— äº†ã€‚å°±å®¹å™¨å†…æ‰§è¡Œå¡ä½åçœ‹ä¸‹å®¿ä¸»æœºè¿›ç¨‹ salt-run æ˜¯å”¯ä¸€çš„ï¼Œå®¿ä¸»æœºä¸Šæœ‰ strace å‘½ä»¤ï¼Œstrace çœ‹çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">strace -p `ps -ef | grep -E <span class="string">&#x27;salt-ru[n]&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> `</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">openat(AT_FDCWD, &quot;/etc/hosts&quot;, O_RDONLY|O_CLOEXEC) = 11</span><br><span class="line">fstat(11, &#123;st_mode=S_IFREG|0644, st_size=898, ...&#125;) = 0</span><br><span class="line">lseek(11, 0, SEEK_SET)                  = 0</span><br><span class="line">read(11, &quot;#\n# hosts         This file desc&quot;..., 4096) = 898</span><br><span class="line">read(11, &quot;&quot;, 4096)                      = 0</span><br><span class="line">close(11)                               = 0</span><br><span class="line">newfstatat(AT_FDCWD, &quot;/etc/nsswitch.conf&quot;, &#123;st_mode=S_IFREG|0644, st_size=1516, ...&#125;, 0) = 0</span><br><span class="line">newfstatat(AT_FDCWD, &quot;/etc/resolv.conf&quot;, &#123;st_mode=S_IFREG|0644, st_size=211, ...&#125;, 0) = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/etc/hosts&quot;, O_RDONLY|O_CLOEXEC) = 11</span><br><span class="line">fstat(11, &#123;st_mode=S_IFREG|0644, st_size=898, ...&#125;) = 0</span><br><span class="line">lseek(11, 0, SEEK_SET)                  = 0</span><br><span class="line">read(11, &quot;#\n# hosts         This file desc&quot;..., 4096) = 898</span><br><span class="line">read(11, &quot;&quot;, 4096)                      = 0</span><br><span class="line">close(11)                               = 0</span><br><span class="line">socket(PF_INET, SOCK_DGRAM|SOCK_CLOEXEC|SOCK_NONBLOCK, IPPROTO_IP) = 11</span><br><span class="line">setsockopt(11, SOL_IP, IP_RECVERR, [1], 4) = 0</span><br><span class="line">connect(11, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;10.xx.xx.1&quot;)&#125;, 16) = 0</span><br><span class="line">poll([&#123;fd=11, events=POLLOUT&#125;], 1, 0)   = 1 ([&#123;fd=11, revents=POLLOUT&#125;])</span><br><span class="line">sendto(11, &quot;e\366\1\0\0\1\0\0\0\0\0\0\7kubexxx\0\0\34\0\1&quot;, 25, MSG_NOSIGNAL, NULL, 0) = 25</span><br><span class="line">poll([&#123;fd=11, events=POLLIN&#125;], 1, 5000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å·¦è¾¹çª—å£æ‰§è¡Œï¼Œå³è¾¹èµ¶ç´§ straceï¼Œå‘ç°æœ‰è¾“å‡ºåå¡ä¸»ï¼Œèµ¶ç´§æŒ‰å›è½¦åˆ†å¼€ï¼Œæœ€åå¾€ä¸Šç¿»æ‰¾ç©ºè¡Œé™„è¿‘å°±æ˜¯å¡ä½çš„ä¿¡æ¯ã€‚ä»ä¸Šé¢çœ‹å°±æ˜¯ glibc çš„ DNS è§£æè¡Œä¸ºï¼š</p><ol><li>å…ˆçœ‹ <code>/etc/nsswitch.conf</code> å†…çš„ <code>hosts</code> è¡Œï¼Œçœ‹ hosts å’Œ dns çš„ä¼˜å…ˆçº§</li><li><code>connect(11, {sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;10.xx.xx.1&quot;)}, 16) = 0</code> å‘èµ·äº† DNS è§£æè¯·æ±‚çš„è¿æ¥ä¿¡æ¯</li><li><code>sendto(11, &quot;e\366\1\0\0\1\0\0\0\0\0\0\7kubexxx\0\0\34\0\1&quot;, 25, MSG_NOSIGNAL, NULL, 0) = 25</code> DNS è¯·æ±‚</li></ol><p>ç„¶åå†æ‰§è¡Œä¸‹ï¼Œå¦ä¸€ä¸ªçª—å£çœ‹äº†ä¸‹é“¾æ¥ç¡®å®å­˜åœ¨ DNS è§£æè¡Œä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ss -anuop | grep :53</span></span><br><span class="line">ESTAB      0      0      10.xx.xx.215:36250              10.xx.xx.1:53                  users:((&quot;salt-run&quot;,pid=13752,fd=4))</span><br></pre></td></tr></table></figure><p>ç„¶åæŠ“åŒ…çœ‹äº†ä¸‹è¯·æ±‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ‰‹æœºé˜…è¯»çš„è¯ï¼Œè¯·å¾€å³ä¾§ç¿»</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tcpdump -nn -i any port 53 -vvv</span></span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">19:34:24.952563 IP (tos 0x0, ttl 64, id 50084, offset 0, flags [DF], proto UDP (17), length 53)</span><br><span class="line">    10.xx.xx.215.63760 &gt; 10.xx.xx.1.53: [bad udp cksum 0xc324 -&gt; 0xd5d2!] 64743+ AAAA? kubexxx. (25)</span><br><span class="line">19:34:26.613645 IP (tos 0x0, ttl 64, id 50437, offset 0, flags [DF], proto UDP (17), length 53)</span><br><span class="line">    10.xx.xx.215.35564 &gt; 10.xx.xx.1.53: [bad udp cksum 0xc324 -&gt; 0x3614!] 2763+ AAAA? kubexxx. (25)</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢çš„ <code>AAAA? kubexxx</code>ï¼Œå¯ä»¥ç¡®è®¤æ˜¯è¯·æ±‚ hostname kubexxx çš„ IPv6 DNS è§£æè®°å½•ï¼Œç„¶ååŠ äº†ä¸‹ hosts å°±å¥½äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;::1 <span class="variable">$HOSTNAME</span>&quot;</span> &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="keyword">time</span> salt-run jobs.active</span></span><br><span class="line">[INFO    ] Runner completed: 20250912113512377461_16938</span><br><span class="line"></span><br><span class="line">real0m3.265s</span><br><span class="line">user0m2.714s</span><br><span class="line">sys0m0.254s</span><br></pre></td></tr></table></figure><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><p>æœäº†ä¸‹å…³é”®å­— <code>salt-run dns ipv6</code> çœ‹çœ‹æœ‰æ²¡æœ‰å…¶ä»–äººé‡åˆ°ï¼Œç»“æœæ‰¾åˆ°ç±»ä¼¼é—®é¢˜ï¼š</p><ul><li><a href="https://github.com/saltstack/salt/issues/40912">https://github.com/saltstack/salt/issues/40912</a></li><li><a href="https://github.com/saltstack/salt/issues/32719#issuecomment-238114720">https://github.com/saltstack/salt/issues/32719#issuecomment-238114720</a></li></ul><p>ä½†æ˜¯å›å¤éƒ½æ˜¯è€ç‰ˆæœ¬é‡è§å¤šï¼Œæˆ‘è¿™è¾¹ç‰ˆæœ¬éƒ½å¾ˆæ–°äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">salt --versions-report</span></span><br><span class="line">Salt Version:</span><br><span class="line">          Salt: 3006.15</span><br><span class="line"> </span><br><span class="line">Python Version:</span><br><span class="line">        Python: 3.10.13 (main, Sep  8 2025, 06:32:11) [GCC 10.3.1]</span><br><span class="line"> </span><br><span class="line">Dependency Versions:</span><br><span class="line">          cffi: 1.14.5</span><br><span class="line">      cherrypy: Not Installed</span><br><span class="line">  cryptography: 44.0.1</span><br><span class="line">      dateutil: 2.8.2</span><br><span class="line">     docker-py: 6.1.3</span><br><span class="line">         gitdb: Not Installed</span><br><span class="line">     gitpython: Not Installed</span><br><span class="line">        Jinja2: 3.0.1</span><br><span class="line">       libgit2: Not Installed</span><br><span class="line">  looseversion: 1.3.0</span><br><span class="line">      M2Crypto: Not Installed</span><br><span class="line">          Mako: 1.2.2</span><br><span class="line">       msgpack: 1.0.5</span><br><span class="line">  msgpack-pure: Not Installed</span><br><span class="line">  mysql-python: Not Installed</span><br><span class="line">     packaging: 24.1</span><br><span class="line">     pycparser: 2.20</span><br><span class="line">      pycrypto: 3.19.1</span><br><span class="line">  pycryptodome: Not Installed</span><br><span class="line">        pygit2: Not Installed</span><br><span class="line">  python-gnupg: Not Installed</span><br><span class="line">        PyYAML: 6.0.1</span><br><span class="line">         PyZMQ: 27.0.2</span><br><span class="line">        relenv: Not Installed</span><br><span class="line">         smmap: Not Installed</span><br><span class="line">       timelib: Not Installed</span><br><span class="line">       Tornado: 4.5.3</span><br><span class="line">           ZMQ: 4.3.5</span><br><span class="line"> </span><br><span class="line">System Versions:</span><br><span class="line">          dist: openeuler 22.03 LTS-SP4</span><br><span class="line">        locale: utf-8</span><br><span class="line">       machine: x86_64</span><br><span class="line">       release: 4.12.14-120-default</span><br><span class="line">        system: Linux</span><br><span class="line">       version: openEuler 22.03 LTS-SP4</span><br></pre></td></tr></table></figure><p>è¿™ç§æ˜¯ glibc çš„è¡Œä¸ºï¼Œsalt ä¼šè§£æ hostnameï¼Œä¸šåŠ¡ä¸´è¿‘å°åº“ï¼Œæ”¹è¿™ä¸ª docker é•œåƒå†…å¯åŠ¨è„šæœ¬ä¹Ÿæ¥ä¸åŠäº†ï¼Œå°±å…ˆåœ¨ä»£ç å±‚é¢è§£å†³äº†ï¼Œæœäº†ä¸‹ python socket åº“å¹¶æ²¡æœ‰é‚£ç§çº¯çœ‹ hosts æ¡ç›®çš„åº“ï¼Œå°±æ‰‹åŠ¨å†™äº†å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fcntl</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ensure_hosts_entry</span>(<span class="params">ip_address, hostname</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;r+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># åŠ æ’ä»–é”ï¼ˆé˜»å¡æ¨¡å¼ï¼Œç¡®ä¿å¹¶å‘å®‰å…¨ï¼‰</span></span><br><span class="line">            fcntl.flock(f, fcntl.LOCK_EX)</span><br><span class="line">            original_content = f.readlines()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> index, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(original_content):</span><br><span class="line">                line_part = line.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(line_part) &lt; <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> hostname <span class="keyword">in</span> line_part:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            original_content.append(<span class="string">f&quot;<span class="subst">&#123;ip_address&#125;</span> <span class="subst">&#123;hostname&#125;</span>\n&quot;</span>)</span><br><span class="line">            f.seek(<span class="number">0</span>)</span><br><span class="line">            f.truncate()</span><br><span class="line">            f.write(<span class="string">&#x27;&#x27;</span>.join(original_content))</span><br><span class="line">            f.flush()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            fcntl.flock(f, fcntl.LOCK_UN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ensure_hosts_entry(<span class="string">&quot;::1&quot;</span>, socket.gethostname())</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€æ¬¡ salt-run å¾ˆä¹…æ‰è¿”å›çš„æ’æŸ¥&lt;/p&gt;</summary>
    
    
    
    
    <category term="salt" scheme="http://zhangguanzhang.github.io/tags/salt/"/>
    
    <category term="salt-run" scheme="http://zhangguanzhang.github.io/tags/salt-run/"/>
    
    <category term="ipv6" scheme="http://zhangguanzhang.github.io/tags/ipv6/"/>
    
  </entry>
  
  <entry>
    <title>éº’éºŸå†…æ ¸4.19.90-52.49å¯¼è‡´çš„flannel vxlanè·¨èŠ‚ç‚¹ä¸é€š</title>
    <link href="http://zhangguanzhang.github.io/2025/09/10/kylin-4.19.90-52.49-udp-drop/"/>
    <id>http://zhangguanzhang.github.io/2025/09/10/kylin-4.19.90-52.49-udp-drop/</id>
    <published>2025-09-10T18:10:30.000Z</published>
    <updated>2025-09-10T18:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€æ¬¡éº’éºŸå†…æ ¸å¯¼è‡´ flannel è·¨èŠ‚ç‚¹ä¸é€šçš„æ’æŸ¥</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å®¢æˆ·æœ‰ä¸€å¥— K8S ç¯å¢ƒ A è¦æ‰©å®¹ï¼Œç»™äº†ä¸¤å°æœºå™¨åŠ è¿›åï¼ŒåŒäº‹å‘ç°æ–°èŠ‚ç‚¹ flannel è·¨èŠ‚ç‚¹ä¸é€šã€‚æŠ“åŒ…æ’æŸ¥å‘ç°æ–°èŠ‚ç‚¹çš„ <code>ip -s a s flannel.1</code> æ˜¾ç¤ºçš„ Rx æ”¶åŒ…ä¸º0ã€‚<br>å®¢æˆ·è®¤ä¸ºæ˜¯ k8s é—®é¢˜ï¼Œæˆ‘ä»¬è®¤ä¸ºæ˜¯å®¢æˆ·ç½‘ç»œç¯å¢ƒæ²¡æ”¾è¡Œ UDPã€‚ç„¶ååŒæ–¹è¾¾æˆå…±è¯†æä¸€å¥—å¹²å‡€ç¯å¢ƒ B éƒ¨ç½² K8S çœ‹çœ‹ï¼Œç„¶åå‘ç°ä¾æ—§è·¨èŠ‚ç‚¹ä¸é€šã€‚</p><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><h3 id="ç¯å¢ƒä¿¡æ¯"><a href="#ç¯å¢ƒä¿¡æ¯" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/os-release</span></span><br><span class="line">NAME=&quot;Kylin Linux Advanced Server&quot;</span><br><span class="line">VERSION=&quot;V10 (Lance)&quot;</span><br><span class="line">ID=&quot;kylin&quot;</span><br><span class="line">VERSION_ID=&quot;V10&quot;</span><br><span class="line">PRETTY_NAME=&quot;Kylin Linux Advanced Server V10 (Lance)&quot;</span><br><span class="line">ANSI_COLOR=&quot;0;31&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">lscpu</span></span><br><span class="line">Architecture:                    x86_64</span><br><span class="line">CPU op-mode(s):                  32-bit, 64-bit</span><br><span class="line">Byte Order:                      Little Endian</span><br><span class="line">Address sizes:                   48 bits physical, 48 bits virtual</span><br><span class="line">CPU(s):                          14</span><br><span class="line">On-line CPU(s) list:             0-13</span><br><span class="line">Thread(s) per core:              1</span><br><span class="line">Core(s) per socket:              2</span><br><span class="line">Socket(s):                       7</span><br><span class="line">NUMA node(s):                    1</span><br><span class="line">Vendor ID:                       AuthenticAMD</span><br><span class="line">CPU family:                      15</span><br><span class="line">Model:                           6</span><br><span class="line">Model name:                      Hygon C86-3G 7390 32-core Processor</span><br><span class="line">Stepping:                        3</span><br><span class="line">CPU MHz:                         2699.998</span><br><span class="line">BogoMIPS:                        5399.99</span><br><span class="line">Hypervisor vendor:               KVM</span><br><span class="line">Virtualization type:             full</span><br><span class="line">L1d cache:                       896 KiB</span><br><span class="line">L1i cache:                       896 KiB</span><br><span class="line">L2 cache:                        7 MiB</span><br><span class="line">L3 cache:                        112 MiB</span><br><span class="line">NUMA node0 CPU(s):               0-13</span><br><span class="line">Vulnerability Itlb multihit:     Not affected</span><br><span class="line">Vulnerability Spec store bypass: Not affected</span><br><span class="line">Vulnerability Spectre v1:        Mitigation; usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Vulnerability Spectre v2:        Mitigation; Retpolines, STIBP disabled, RSB filling, PBRSB-eIBRS Not affected</span><br><span class="line">Vulnerability Srbds:             Not affected</span><br><span class="line">Vulnerability Tsx async abort:   Not affected</span><br><span class="line">Flags:                           fpu de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx lm rep_good </span><br><span class="line">                                 nopl cpuid extd_apicid tsc_known_freq pni cx16 x2apic aes hypervisor cmp_legacy 3dnowprefetch vmmcall</span><br></pre></td></tr></table></figure><h3 id="æ¥æ‰‹ç¼˜ç”±"><a href="#æ¥æ‰‹ç¼˜ç”±" class="headerlink" title="æ¥æ‰‹ç¼˜ç”±"></a>æ¥æ‰‹ç¼˜ç”±</h3><p>ç°åœºçš„åŒäº‹å¸è½½äº† K8S åæµ‹è¯•UDP è¿˜æ˜¯ä¸€æ ·ï¼Œç„¶åè®¤ä¸º udp å­˜åœ¨é™åˆ¶ï¼Œå®¢æˆ·ç”¨ nmap æ‰«æè®¤ä¸º UDP æ²¡é™åˆ¶ï¼Œæˆ‘ä»¬ç”¨ nc èµ· server ç”¨ client æµ‹ä¸é€šï¼Œå®¢æˆ·è®¤ä¸ºæˆ‘ä»¬è¿™ç§æµ‹è¯•æ–¹å¼ä¸å‡†ï¼Œæˆ‘å°±å†™äº†ä¸ªæµ‹è¯•è„šæœ¬ç»™åŒäº‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] == <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">input</span> = raw_input</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">usage</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Usage:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Server: python udp-test.py &lt;local-port&gt;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Client: python udp-test.py &lt;host:port&gt;&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_addr</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;:&quot;</span> <span class="keyword">in</span> s:</span><br><span class="line">        host, port = s.rsplit(<span class="string">&quot;:&quot;</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> host, <span class="built_in">int</span>(port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="built_in">int</span>(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server</span>(<span class="params">port</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    sock.bind((<span class="string">&quot;0.0.0.0&quot;</span>, port))</span><br><span class="line">    logging.info(<span class="string">&quot;Server listening on UDP *:%d&quot;</span>, port)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data, addr = sock.recvfrom(<span class="number">4096</span>)</span><br><span class="line">        msg = data.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        logging.info(<span class="string">&quot;Received from %s: %r&quot;</span>, addr, msg)</span><br><span class="line">        sock.sendto(data, addr)          <span class="comment"># å›æ˜¾</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">client</span>(<span class="params">host, port</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    target = (host, port)</span><br><span class="line">    logging.info(<span class="string">&quot;Client target UDP %s:%d (type message and press Enter)&quot;</span>, host, port)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            text = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> (EOFError, KeyboardInterrupt):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\nBye&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        sock.sendto(text.encode(<span class="string">&#x27;utf-8&#x27;</span>), target)</span><br><span class="line">        sock.settimeout(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data, _ = sock.recvfrom(<span class="number">4096</span>)</span><br><span class="line">            logging.info(<span class="string">&quot;Server echoed: %r&quot;</span>, data.decode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;ignore&#x27;</span>))</span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            logging.debug(<span class="string">&quot;No echo within 2s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        usage()</span><br><span class="line">    addr_str = sys.argv[<span class="number">1</span>]</span><br><span class="line">    host, port = parse_addr(addr_str)</span><br><span class="line"></span><br><span class="line">    LOG_FMT = <span class="string">&quot;%(asctime)s [%(levelname)s] %(message)s&quot;</span></span><br><span class="line">    logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=LOG_FMT)</span><br><span class="line">    <span class="keyword">if</span> host <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># çº¯æ•°å­—ç«¯å£ -&gt; æœåŠ¡ç«¯</span></span><br><span class="line">        server(port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># host:port -&gt; å®¢æˆ·ç«¯</span></span><br><span class="line">        client(host, port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>è„šæœ¬å°±æ˜¯è¿ä¸Šåå‘æ¶ˆæ¯å›è½¦ï¼Œserver æŠŠæ”¶åˆ°çš„æ¶ˆæ¯å‘å›å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ‰“å°æ”¶åˆ°çš„æ¶ˆæ¯ï¼ŒåŒäº‹å®¢æˆ·ç¯å¢ƒä¸Šæµ‹äº†ä¸‹å‘ç°ä¸æ­£å¸¸ï¼Œç„¶åå®¢æˆ·ç”¨ tcpdump æŠ“åŒ…è¯´æ¥æ”¶åˆ°äº†ã€‚çœ‹äº†ä¸‹å®¢æˆ·æŠ“åŒ…æ–¹å¼ç¡®å®æ²¡é—®é¢˜ï¼š</p><ul><li>æœºå™¨B ä¸Šå…ˆå¼€æŠ“åŒ… <code>tcpdump -nn -i eth0 port 8472 -w xxx.pcap</code></li><li>æœºå™¨A ä¸Š <code>echo &quot;123&quot; | nc -u &lt;æœºå™¨B_ip&gt; 8472</code></li></ul><p>ä¹‹å‰ä»¥ä¸ºæ˜¯å®¢æˆ·åœ¨å‘é€æœºå™¨ä¸ŠæŠ“çš„ï¼Œç†æ¸…æ¥šå®¢æˆ·æ€è·¯æ˜¯æ­£ç¡®åï¼Œå°±è¿œç¨‹ä¸Šå»çœ‹äº†ã€‚</p><h3 id="æŠ“åŒ…é‡ç°"><a href="#æŠ“åŒ…é‡ç°" class="headerlink" title="æŠ“åŒ…é‡ç°"></a>æŠ“åŒ…é‡ç°</h3><p>ç¡®å®ç›®æ ‡æœºå™¨èƒ½æŠ“åˆ°æŠ¥æ–‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tcpdump  -nn -i any port 8472 -vvv</span></span><br><span class="line">dropped privs to tcpdump</span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked v1), capture size 262144 bytes</span><br><span class="line">14:43:39.267522 IP (tos 0x0, ttl 64, id 56033, offset 0, flags [DF], proto UDP (17), length 35)</span><br><span class="line">    10.xx.50.166.50492 &gt; 10.xx.50.169.8472: [udp sum ok] OTV,  [|OTV]</span><br><span class="line">^C</span><br><span class="line">1 packet captured</span><br><span class="line">3 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æŠ“åŒ…åç”¨ nc å‘ UDP æŠ“çš„ï¼Œç„¶åä¸‹é¢æ˜¯è„šæœ¬å½¢å¼å‘çš„æŠ“çš„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tcpdump -nn -i any port 8472 -vvv</span></span><br><span class="line">dropped privs to tcpdump</span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked v1), capture size 262144 bytes</span><br><span class="line">14:48:58.540224 IP (tos 0x0, ttl 64, id 48511, offset 0, flags [DF], proto UDP (17), length 31)</span><br><span class="line">    10.xx.50.166.46543 &gt; 10.xx.50.169.8472: [bad udp cksum 0x7a0d -&gt; 0x4acd!] OTV,  [|OTV]</span><br><span class="line">^C</span><br><span class="line">1 packet captured</span><br><span class="line">2 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><p>ä¸Šé¢æŠ“åŒ…å¯¹æ¯”é‡Œæœ‰ <code>bad udp cksum</code>ï¼Œå°è¯•å–æ¶ˆç½‘å¡è®¡ç®— checksum è¯•è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ethtool --show-offload eth0 | grep checksum</span></span><br><span class="line">rx-checksumming: on [fixed]</span><br><span class="line">tx-checksummtng: on</span><br><span class="line">tx-checksum-ipv4:off[fixed]</span><br><span class="line">tx-checksum-ip-generic: on</span><br><span class="line">tx-checksum-ipv6: off [fixed]</span><br><span class="line">tx-checksum-fcoe-crc: off [ftxed]</span><br><span class="line">tx-checksum-sctp: off [fixed]</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ethtool --offload eth0 tx-checksum-ip-generic off</span></span><br><span class="line">Actual changes:</span><br><span class="line">tx-checksumming: off</span><br><span class="line">tx-checksum-ip-generic: off</span><br><span class="line">tcp-segmentatton-offLoad: off</span><br><span class="line">tx-tcp-segmentation; off [requested on]</span><br><span class="line">tx-tcp-ecn-segmentation: off [requested on]</span><br><span class="line">tx-tcp6-segmentation: off [requested on]</span><br></pre></td></tr></table></figure><p>æµ‹äº†ä¸‹å‘ä¸‹è¿˜ä¸è¡Œï¼Œç„¶åå‡ ä¸ªéƒ½è®¾ç½®äº†è¿˜æ˜¯ä¸è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ethtool --offload eth0 tx off rx off</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”äº†ç¯å¢ƒ A çš„ offload éƒ½ä¸€æ ·ï¼Œå¹¶ä¸”æŸ¥çœ‹é©±åŠ¨ä¹Ÿä¸€è‡´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">readlink</span> -f /sys/class/net/eth0/device/driver/module</span></span><br><span class="line">/sys/module/virtio_net</span><br></pre></td></tr></table></figure><p>iptables å•¥è§„åˆ™éƒ½æ²¡æœ‰ï¼Œè¿˜æœ‰ä¸ä¸€æ ·çš„å°±åªæœ‰å†…æ ¸ç‰ˆæœ¬äº†ï¼š</p><ul><li>æ­£å¸¸ç¯å¢ƒï¼š<code>Linux 4.19.90-52.22.v2207.ky10.x86_64 #1 SMP Tue Mar 14 12:19:10 CST 2023 x86_64 x86_64 x86_64 GNU/Linux</code></li><li>å¼‚å¸¸ç¯å¢ƒï¼š<code>Linux 4.19.90-52.49.v2207.ky10.x86_64 #3 SMP Thu Jul 24 02:43:35 CST 2025 x86_64 x86_64 x86_64 GNU/Linux</code></li></ul><p>è¯¢é—®å®¢æˆ·èƒ½ä¸èƒ½è¿™å¥—ç¯å¢ƒ B æœºå™¨æ¢æˆå’Œæ­£å¸¸ç¯å¢ƒä¸€æ ·å†…æ ¸çš„è™šæœºï¼Œå®¢æˆ·ç­”å¤è¯´æ˜¯å¹³å°è‡ªåŠ¨åŒ–å¼€çš„æœºå™¨ï¼Œæ— æ³•ä¿æŒå†…æ ¸ä¸€è‡´ã€‚æ²¡åŠæ³•ï¼Œç„¶åçœ‹è¿™å¥—ç¯å¢ƒæ˜¯ä¸æ˜¯å‡çº§è¿‡å†…æ ¸ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep kernel /var/log/dnf*</span></span><br><span class="line">...</span><br><span class="line">/var/log/dnf.rpm.log:2025-08-07T01:34:25Z SUBDEBUG InstaLLed:kernel-4.19.90-52.49.v2207.ky10.x86_64</span><br><span class="line">/var/log/dnf.rpm.log:2025-08-67T01:34:26Z SUBDEBUG Upgrade:kernel-tools-4.19.90-52.49.v2207.ky10.x86_64</span><br><span class="line">/var/log/dnf.rpm.log:2025-08-07T01:34:29Z SUBDEBUG Upgraded:kernel-tools-4.19.90-52.45.v2207.ky10.x86_64</span><br><span class="line">/var/log/dnf.rpm.log:2025-08-67T01:34:30Z SUBDEBUG Upgraded:kernel-headers-4.19.90-52.45.v2207.ky10.x86_64</span><br><span class="line">/var/log/dnf.rpm.log:2025-08-07T01:34:34Z SUBDEBUG Upgraded:kernel-tools-libs-4.19.90-52.45.v2207.ky10.x86_64</span><br></pre></td></tr></table></figure><p>æœç„¶å‡çº§äº†ï¼Œçœ‹ä¸‹è€ç‰ˆæœ¬åœ¨ä¸åœ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rpm -qa | grep kernel</span></span><br><span class="line">kernel-modules-extra-4.19.90-52.45.v2207.ky10.x86_64</span><br><span class="line">kernel-moduLes-extra-4.19.90-52.22.v2207.ky10.x86_64</span><br><span class="line">kernel-modules-4.19.90-52.49.v2207.ky10.x86_64</span><br><span class="line">kernel-core-4.19.90-52.22.v2207.ky10.x86_64</span><br><span class="line">kerne1-t001s-11bs-4.19.90-52.49.V2207.ky10.x86_64</span><br><span class="line">kernel-modules-extra-4.19.96-52.49.v2207.ky10.x86_64</span><br><span class="line">kernel-4.19.90-52.22.v2207.ky10.x86_64</span><br><span class="line">kernel-t00L5-4.19.90-52.49.v2207.ky10.x86_64</span><br><span class="line">kernel-core-4.19.90-52.45.v2207.ky10.x86_64</span><br><span class="line">kernel-modules-4.19.90-52.45.v2207.ky10.x86_64</span><br><span class="line">kernel-4.19.90-52.45.v2207.ky10.x86_64</span><br><span class="line">kernel-modules-4.19.90-52.22.v2207.ky10.x86_64</span><br><span class="line">kernel-headers-4.19.96-52.49.v2207.ky10.x86_64</span><br><span class="line">kernel-4.19.90-52.49.v2207.ky10.x86_64</span><br><span class="line">kernel-4.19.90-52.49.v2207.ky10.x86_64</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹ grub é‡Œé¡ºåºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">awk -F\&#x27; <span class="string">&#x27;$1==&quot;menuentry &quot; &#123;print i++ &quot; : &quot; $2&#125;&#x27;</span> /etc/grub2.cfg</span></span><br><span class="line">0 : Kylin Linux Advanced Server (4.19.90-52.49.v2207.ky10.x86_64) V10 (Lance)</span><br><span class="line">1 : Kylin Linux Advanced Server (4.19.90-52.45.v2207.ky10.x86_64) V10 (Lance)</span><br><span class="line">2 : Kylin Linux Advanced Server (4.19.90-52.22.v2207.ky10.x86_64) V10 (Lance)</span><br><span class="line">3 : Kylin Linux Advanced Server (0-rescue-de06076a688a45bf9d1acd0bf45bb93e) V10 (Lance)</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢åˆ° 52.22:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grub2-set-default 2</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grub2-mkconfig -o /etc/grub2.cfg</span></span><br></pre></td></tr></table></figure><p>è¯¢é—®å®¢æˆ·èƒ½å¦é‡å¯ï¼Œå¯ä»¥é‡å¯ï¼Œé‡å¯åæµ‹è¯•å°±æ­£å¸¸äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux TKVMJT0240 4.19.90-52.22.v2207.ky10.x86_64 #1 SMP Tue Mar 14 12:19:10 CST </span><br><span class="line"></span><br><span class="line"># ä»»æ„æœºå™¨1</span><br><span class="line">$ python udp-test.py 8472</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># æœºå™¨2</span><br><span class="line">$ python udp-test.py æœºå™¨1çš„ip:8472</span><br><span class="line">25-09-10 17:29:59,623 [INFO] Client raget UDP xxx:8472( type message and press Enter)</span><br><span class="line">&gt;&gt;&gt; 123</span><br><span class="line">25-09-10 17:30:00,753 [INFO] Server echoed: &#x27;123&#x27;</span><br><span class="line">&gt;&gt;&gt; ^C</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure><p>å…¶ä»–å‡ ä¸ªæœºå™¨ä¸€æ ·å¤„ç†åéƒ½æ­£å¸¸ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€æ¬¡éº’éºŸå†…æ ¸å¯¼è‡´ flannel è·¨èŠ‚ç‚¹ä¸é€šçš„æ’æŸ¥&lt;/p&gt;</summary>
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="flannel" scheme="http://zhangguanzhang.github.io/tags/flannel/"/>
    
    <category term="vxlan" scheme="http://zhangguanzhang.github.io/tags/vxlan/"/>
    
    <category term="kylin" scheme="http://zhangguanzhang.github.io/tags/kylin/"/>
    
  </entry>
  
  <entry>
    <title>flannel è·¯ç”±é”™ä¹±</title>
    <link href="http://zhangguanzhang.github.io/2025/09/03/flannel-mode-chaos/"/>
    <id>http://zhangguanzhang.github.io/2025/09/03/flannel-mode-chaos/</id>
    <published>2025-09-03T10:10:30.000Z</published>
    <updated>2025-09-03T10:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€æ¬¡ flannel è·¯ç”±é”™ä¹±å¯¼è‡´çš„è·¨èŠ‚ç‚¹ä¸é€š</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æœ‰ä¸€å¥—å®¢æˆ·æµ‹è¯•ç¯å¢ƒï¼Œå®æ–½éƒ¨ç½²ä¸šåŠ¡åå‘ç°æœ‰é—®é¢˜ï¼Œçœ‹äº†ä¸‹ä¸šåŠ¡æ—¥å¿—æ— æ³•è§£æåŸŸåã€‚å› ä¸º host-gw éœ€è¦äºŒå±‚ï¼Œè€Œä¸”æœ‰äº›è™šæ‹ŸåŒ–æœ‰ IP&#x2F;MAC ç»‘å®šï¼Œæ‰€ä»¥é»˜è®¤ç”¨ vxlan æ¨¡å¼ã€‚</p><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><h3 id="è·¯ç”±ä¸å¯¹"><a href="#è·¯ç”±ä¸å¯¹" class="headerlink" title="è·¯ç”±ä¸å¯¹"></a>è·¯ç”±ä¸å¯¹</h3><p>ä¸Šå»æŸ¥äº†ä¸‹å‘ç° Pod ç½‘æ®µè·¯ç”±ä¸å¯¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> ip r s</span> </span><br><span class="line">default via 172.16.0.1 dev eth0 proto dhcp metric 100 </span><br><span class="line">10.185.0.0/16 dev docker0 proto kernel scope link src 10.185.0.1 linkdown </span><br><span class="line">10.187.0.0/24 via 172.16.0.250 dev eth0</span><br><span class="line">10.187.1.0/24 via 172.16.0.202 dev eth0 </span><br><span class="line">10.187.2.0/24 via 172.16.0.104 dev eth0 #&lt;--- è¿™å‡ ä¸ª</span><br><span class="line">10.187.3.0/24 via 172.16.0.104 dev eth0 #&lt;--- è¿™å‡ ä¸ª</span><br><span class="line">10.187.3.0/24 dev cni0 proto kernel scope link src 10.187.3.1 #&lt;--- è¿™å‡ ä¸ª</span><br><span class="line">172.16.0.0/24 dev eth0 proto kernel scope link src 172.16.0.231 metric 100 </span><br></pre></td></tr></table></figure><p>æ˜¯ vxlan æ¨¡å¼ï¼Œä½†æ˜¯ 2.0ã€3.0 ä¸‹ä¸€è·³éƒ½æ˜¯ 172.16.0.104ï¼Œè€Œä¸”æœ¬æœºæ˜¯ <code>10.187.3.0/24</code> ç½‘æ®µï¼Œcni0 çš„è·¯ç”±æ— æ³•åŒ¹é…åˆ°ã€‚æ€€ç–‘æ˜¯å®¢æˆ·æ·»åŠ çš„è·¯ç”±ï¼Œè®©å’Œå®¢æˆ·æ²Ÿé€šåæ¢ä¸ªå’Œå®¢æˆ·å†…ç½‘ä¸é‡åˆçš„ Pod CIDRã€‚ç„¶åå®æ–½é‡è£…åè¿˜æ˜¯è¿™æ ·ï¼Œä¸Šå»çœ‹äº†ä¸‹æ—¥å¿—ï¼š</p><h3 id="æ¨¡å¼é”™ä¹±"><a href="#æ¨¡å¼é”™ä¹±" class="headerlink" title="æ¨¡å¼é”™ä¹±"></a>æ¨¡å¼é”™ä¹±</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a | grep flanneld</span><br><span class="line">$ docker logs xxxx # flannelå®¹å™¨ID</span><br><span class="line">W0903 01:37:31.229597       1 main.go:540] no subnet found for key: FLANNEL_IPV6_NETWORK in file: /run/flannel/subnet.env</span><br><span class="line">W0903 01:37:31.229636       1 main.go:540] no subnet found for key: FLANNEL_IPV6_SUBNET in file: /run/flannel/subnet.env</span><br><span class="line">I0903 01:37:31.229643       1 iptables.go:125] Setting up masking rules</span><br><span class="line">I0903 01:37:31.422425       1 iptables.go:226] Changing default FORWARD chain policy to ACCEPT</span><br><span class="line">I0903 01:37:31.523863       1 main.go:396] Wrote subnet file to /run/flannel/subnet.env</span><br><span class="line">I0903 01:37:31.523889       1 main.go:400] Running backend.</span><br><span class="line">I0903 01:37:31.524023       1 route_network.go:56] Watching for new subnet leases</span><br><span class="line">I0903 01:37:31.524247       1 subnet.go:152] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xa610100, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xac100068, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;host-gw&quot;, BackendData:json.RawMessage&#123;0x6e, 0x75, 0x6c, 0x6c&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0903 01:37:31.524425       1 subnet.go:152] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xa610300, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xac1000e7, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;host-gw&quot;, BackendData:json.RawMessage&#123;0x6e, 0x75, 0x6c, 0x6c&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0903 01:37:31.524449       1 route_network.go:93] Subnet added: 10.97.1.0/24 via 172.16.0.104</span><br><span class="line">I0903 01:37:31.524705       1 route_network.go:166] Route to &#123;Ifindex: 2 Dst: 10.97.1.0/24 Src: &lt;nil&gt; Gw: 172.16.0.104 Flags: [] Table: 0 Realm: 0&#125; already exists, skipping.</span><br><span class="line">I0903 01:37:31.524797       1 route_network.go:93] Subnet added: 10.97.3.0/24 via 172.16.0.231</span><br><span class="line">I0903 01:37:31.524876       1 route_network.go:166] Route to &#123;Ifindex: 2 Dst: 10.97.3.0/24 Src: &lt;nil&gt; Gw: 172.16.0.231 Flags: [] Table: 0 Realm: 0&#125; already exists, skipping.</span><br><span class="line">I0903 01:37:31.524903       1 subnet.go:152] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xa610000, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xac1000fa, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;host-gw&quot;, BackendData:json.RawMessage&#123;0x6e, 0x75, 0x6c, 0x6c&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0903 01:37:31.524939       1 route_network.go:93] Subnet added: 10.97.0.0/24 via 172.16.0.250</span><br><span class="line">I0903 01:37:31.525190       1 route_network.go:166] Route to &#123;Ifindex: 2 Dst: 10.97.0.0/24 Src: &lt;nil&gt; Gw: 172.16.0.250 Flags: [] Table: 0 Realm: 0&#125; already exists, skipping.</span><br><span class="line">I0903 01:37:31.621427       1 main.go:421] Waiting for all goroutines to exit</span><br><span class="line">I0903 01:37:31.922267       1 iptables.go:372] bootstrap done</span><br><span class="line">I0903 01:37:32.129063       1 iptables.go:372] bootstrap done</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ—¥å¿—å¾ˆå¥‡æ€ªï¼Œæ³¨æ„å‡ ä¸ªå…³é”®åœ°æ–¹ï¼š</p><ul><li><code>BackendType:&quot;host-gw&quot;</code></li><li><code>Subnet added: 10.97.0.0/24 via 172.16.0.250</code></li></ul><p>æ€ä¹ˆä¼šæ˜¯ <code>host-gw</code> æ¨¡å¼ï¼ŒæŸ¥çœ‹ä¸‹è·¯ç”±ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@vm172-16-0-202 ~]# ip r s </span><br><span class="line">default via 172.16.0.1 dev eth0 proto dhcp metric 100 </span><br><span class="line">10.97.0.0/24 via 172.16.0.250 dev eth0 </span><br><span class="line">10.97.1.0/24 via 172.16.0.104 dev eth0 </span><br><span class="line">10.97.2.0/24 via 172.16.0.250 dev eth0 </span><br><span class="line">10.97.2.0/24 dev cni0 proto kernel scope link src 10.97.2.1 </span><br><span class="line">10.97.3.0/24 via 172.16.0.231 dev eth0 </span><br><span class="line">10.185.0.0/16 dev docker0 proto kernel scope link src 10.185.0.1 linkdown </span><br><span class="line">10.187.0.0/24 via 172.16.0.250 dev eth0 </span><br><span class="line">10.187.2.0/24 via 172.16.0.104 dev eth0 </span><br><span class="line">10.187.3.0/24 via 172.16.0.231 dev eth0 </span><br><span class="line">172.16.0.0/24 dev eth0 proto kernel scope link src 172.16.0.202 metric 100</span><br></pre></td></tr></table></figure><p>è€è·¯ç”±å¿½ç•¥ï¼Œæ–°è·¯ç”±çœ‹ç¡®å®æ˜¯ host-gw æ¨¡å¼çš„è·¯ç”±ï¼Œçœ‹ä¸‹ configmap é…ç½®æ¨¡å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@vm172-16-0-202 ~]# kubectl -n kube-system get cm kube-flannel-cfg -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  cni-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;cbr0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;cniVersion&quot;</span>: <span class="string">&quot;0.3.1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;flannel&quot;</span>,</span><br><span class="line">          <span class="string">&quot;delegate&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;hairpinMode&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;isDefaultGateway&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;portmap&quot;</span>,</span><br><span class="line">          <span class="string">&quot;capabilities&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;portMappings&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">      <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.97.0.0/16&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Backend&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;vxlan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Port&quot;</span>: 8475</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">kind: ConfigMap</span><br></pre></td></tr></table></figure><p>configmap æ˜¯ vxlan æ²¡é—®é¢˜ï¼Œçœ‹ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@vm172-16-0-202 ~]# cat /run/flannel/subnet.env </span><br><span class="line">FLANNEL_NETWORK=10.97.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.97.2.1/24</span><br><span class="line">FLANNEL_MTU=1500</span><br><span class="line">FLANNEL_IPMASQ=true</span><br></pre></td></tr></table></figure><p>å¥‡æ€ªäº†ï¼Œæ€ä¹ˆæ˜¯ host-gw çš„ 1500 MTUï¼Œåˆ é™¤ä¸‹ flannel å®¹å™¨åå†çœ‹çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@vm172-16-0-202 ~]# docker rm -f xxx # flanneld å®¹å™¨id</span><br><span class="line">[root@vm172-16-0-202 ~]# cat /run/flannel/subnet.env </span><br><span class="line">FLANNEL_NETWORK=10.97.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.97.2.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=true</span><br><span class="line">[root@vm172-16-0-202 ~]# docker ps -a | grep flanneld</span><br><span class="line">e288c4442ee2   reg.xxx.lan:5000/xxx/flannel                   &quot;/opt/bin/flanneld -â€¦&quot;   41 seconds ago   Up 40 seconds                         k8s_kube-flannel_kube-flannel-ds-w7rk2_kube-system_581101b1-cfa5-4ccc-80be-e78a9c248b96_1</span><br><span class="line">[root@vm172-16-0-202 ~]# docker logs e288</span><br><span class="line">I0903 01:47:13.123249       1 main.go:211] CLI flags config: &#123;etcdEndpoints:http://127.0.0.1:4001,http://127.0.0.1:2379 etcdPrefix:/coreos.com/network etcdKeyfile: etcdCertfile: etcdCAFile: etcdUsername: etcdPassword: version:false kubeSubnetMgr:true kubeApiUrl: kubeAnnotationPrefix:flannel.alpha.coreos.com kubeConfigFile: iface:[] ifaceRegex:[] ipMasq:true ifaceCanReach: subnetFile:/run/flannel/subnet.env publicIP: publicIPv6: subnetLeaseRenewMargin:60 healthzIP:0.0.0.0 healthzPort:0 iptablesResyncSeconds:5 iptablesForwardRules:true netConfPath:/etc/kube-flannel/net-conf.json setNodeNetworkUnavailable:true&#125;</span><br><span class="line">W0903 01:47:13.123387       1 client_config.go:618] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span><br><span class="line">I0903 01:47:13.223377       1 kube.go:139] Waiting 10m0s for node controller to sync</span><br><span class="line">I0903 01:47:13.223476       1 kube.go:469] Starting kube subnet manager</span><br><span class="line">I0903 01:47:13.230593       1 kube.go:490] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.97.1.0/24]</span><br><span class="line">I0903 01:47:13.230628       1 kube.go:490] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.97.2.0/24]</span><br><span class="line">I0903 01:47:13.230637       1 kube.go:490] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.97.3.0/24]</span><br><span class="line">I0903 01:47:13.230644       1 kube.go:490] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.97.0.0/24]</span><br><span class="line">I0903 01:47:14.223684       1 kube.go:146] Node controller sync successful</span><br><span class="line">I0903 01:47:14.223761       1 main.go:231] Created subnet manager: Kubernetes Subnet Manager - 172.16.0.202</span><br><span class="line">I0903 01:47:14.223767       1 main.go:234] Installing signal handlers</span><br><span class="line">I0903 01:47:14.224176       1 main.go:452] Found network config - Backend type: vxlan</span><br><span class="line">I0903 01:47:14.229346       1 kube.go:669] List of node(172.16.0.202) annotations: map[string]string&#123;&quot;flannel.alpha.coreos.com/backend-data&quot;:&quot;null&quot;, &quot;flannel.alpha.coreos.com/backend-type&quot;:&quot;host-gw&quot;, &quot;flannel.alpha.coreos.com/kube-subnet-manager&quot;:&quot;true&quot;, &quot;flannel.alpha.coreos.com/public-ip&quot;:&quot;172.16.0.202&quot;, &quot;node.alpha.kubernetes.io/ttl&quot;:&quot;0&quot;, &quot;volumes.kubernetes.io/controller-managed-attach-detach&quot;:&quot;true&quot;&#125;</span><br><span class="line">I0903 01:47:14.229398       1 match.go:210] Determining IP address of default interface</span><br><span class="line">I0903 01:47:14.229758       1 match.go:263] Using interface with name eth0 and address 172.16.0.202</span><br><span class="line">I0903 01:47:14.229788       1 match.go:285] Defaulting external address to interface address (172.16.0.202)</span><br><span class="line">I0903 01:47:14.229841       1 vxlan.go:141] VXLAN config: VNI=1 Port=8475 GBP=false Learning=false DirectRouting=false</span><br><span class="line">I0903 01:47:14.233427       1 kube.go:636] List of node(172.16.0.202) annotations: map[string]string&#123;&quot;flannel.alpha.coreos.com/backend-data&quot;:&quot;null&quot;, &quot;flannel.alpha.coreos.com/backend-type&quot;:&quot;host-gw&quot;, &quot;flannel.alpha.coreos.com/kube-subnet-manager&quot;:&quot;true&quot;, &quot;flannel.alpha.coreos.com/public-ip&quot;:&quot;172.16.0.202&quot;, &quot;node.alpha.kubernetes.io/ttl&quot;:&quot;0&quot;, &quot;volumes.kubernetes.io/controller-managed-attach-detach&quot;:&quot;true&quot;&#125;</span><br><span class="line">I0903 01:47:14.249292       1 iptables.go:51] Starting flannel in iptables mode...</span><br><span class="line">W0903 01:47:14.249452       1 main.go:540] no subnet found for key: FLANNEL_IPV6_NETWORK in file: /run/flannel/subnet.env</span><br><span class="line">W0903 01:47:14.249491       1 main.go:540] no subnet found for key: FLANNEL_IPV6_SUBNET in file: /run/flannel/subnet.env</span><br><span class="line">I0903 01:47:14.249498       1 iptables.go:125] Setting up masking rules</span><br><span class="line">I0903 01:47:14.250112       1 kube.go:490] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.97.2.0/24]</span><br><span class="line">I0903 01:47:14.529553       1 iptables.go:226] Changing default FORWARD chain policy to ACCEPT</span><br><span class="line">I0903 01:47:14.622211       1 main.go:396] Wrote subnet file to /run/flannel/subnet.env</span><br><span class="line">I0903 01:47:14.622240       1 main.go:400] Running backend.</span><br><span class="line">I0903 01:47:14.622545       1 vxlan_network.go:65] watching for new subnet leases</span><br><span class="line">I0903 01:47:14.622590       1 subnet.go:152] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xa610100, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xac100068, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;host-gw&quot;, BackendData:json.RawMessage&#123;0x6e, 0x75, 0x6c, 0x6c&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0903 01:47:14.622651       1 subnet.go:152] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xa610300, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xac1000e7, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;host-gw&quot;, BackendData:json.RawMessage&#123;0x6e, 0x75, 0x6c, 0x6c&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0903 01:47:14.622694       1 vxlan_network.go:100] Received Subnet Event with VxLan: BackendType: host-gw, PublicIP: 172.16.0.104, PublicIPv6: (nil), BackendData: null, BackendV6Data: (nil)</span><br><span class="line">W0903 01:47:14.622710       1 vxlan_network.go:102] ignoring non-vxlan v4Subnet(10.97.1.0/24) v6Subnet(::/0): type=host-gw</span><br><span class="line">I0903 01:47:14.622724       1 vxlan_network.go:100] Received Subnet Event with VxLan: BackendType: host-gw, PublicIP: 172.16.0.231, PublicIPv6: (nil), BackendData: null, BackendV6Data: (nil)</span><br><span class="line">W0903 01:47:14.622727       1 vxlan_network.go:102] ignoring non-vxlan v4Subnet(10.97.3.0/24) v6Subnet(::/0): type=host-gw</span><br><span class="line">I0903 01:47:14.622737       1 subnet.go:152] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xa610000, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xac1000fa, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;host-gw&quot;, BackendData:json.RawMessage&#123;0x6e, 0x75, 0x6c, 0x6c&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0903 01:47:14.622759       1 vxlan_network.go:100] Received Subnet Event with VxLan: BackendType: host-gw, PublicIP: 172.16.0.250, PublicIPv6: (nil), BackendData: null, BackendV6Data: (nil)</span><br><span class="line">W0903 01:47:14.622764       1 vxlan_network.go:102] ignoring non-vxlan v4Subnet(10.97.0.0/24) v6Subnet(::/0): type=host-gw</span><br><span class="line">I0903 01:47:14.722083       1 main.go:421] Waiting for all goroutines to exit</span><br><span class="line">I0903 01:47:15.123247       1 iptables.go:372] bootstrap done</span><br><span class="line">I0903 01:47:15.525861       1 iptables.go:372] bootstrap done</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹æ˜¯å¯¹äº†ï¼Œä½†æ˜¯çœ‹æ—¥å¿—å†…éƒ¨æ˜¾ç¤ºèŠ‚ç‚¹ annotation æ³¨è§£ä¸å¯¹åŠ²ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kube.go:636] List of node(172.16.0.202) annotations: \</span><br><span class="line">  map[string]string&#123;&quot;flannel.alpha.coreos.com/backend-data&quot;:&quot;null&quot;, \</span><br><span class="line">  &quot;flannel.alpha.coreos.com/backend-type&quot;:&quot;host-gw&quot;, \</span><br><span class="line">  &quot;flannel.alpha.coreos.com/kube-subnet-manager&quot;:&quot;true&quot;, \</span><br><span class="line">  &quot;flannel.alpha.coreos.com/public-ip&quot;:&quot;172.16.0.202&quot;, \</span><br><span class="line">  &quot;node.alpha.kubernetes.io/ttl&quot;:&quot;0&quot;, &quot;volumes.kubernetes.io/controller-managed-attach-detach&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºçš„æ˜¯ host-gw ï¼Œçœ‹ä¸‹èŠ‚ç‚¹æ³¨è§£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node -o yaml | grep flannel</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &quot;null&quot;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: host-gw</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.104</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel@sha256:13cddb14533a10394aa9436bd96a4c866a139b7ef01e71526aae013e724acca7</span><br><span class="line">      - flannel/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin@sha256:85aa4c338969e97b1ab751fdc2c167af228a241a224e2d0e5b81ca0f3e93e1fa</span><br><span class="line">      - flannel/flannel-cni-plugin:v1.4.1-flannel1</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin:v1.4.1</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &#x27;&#123;&quot;VNI&quot;:1,&quot;VtepMAC&quot;:&quot;f6:12:96:a0:5a:14&quot;&#125;&#x27;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: vxlan</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.202</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel@sha256:13cddb14533a10394aa9436bd96a4c866a139b7ef01e71526aae013e724acca7</span><br><span class="line">      - flannel/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin@sha256:85aa4c338969e97b1ab751fdc2c167af228a241a224e2d0e5b81ca0f3e93e1fa</span><br><span class="line">      - flannel/flannel-cni-plugin:v1.4.1-flannel1</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin:v1.4.1</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &quot;null&quot;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: host-gw</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.231</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel@sha256:13cddb14533a10394aa9436bd96a4c866a139b7ef01e71526aae013e724acca7</span><br><span class="line">      - flannel/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin@sha256:85aa4c338969e97b1ab751fdc2c167af228a241a224e2d0e5b81ca0f3e93e1fa</span><br><span class="line">      - flannel/flannel-cni-plugin:v1.4.1-flannel1</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin:v1.4.1</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &quot;null&quot;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: host-gw</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.250</span><br></pre></td></tr></table></figure><p>æ€ä¹ˆä¸¤ä¸ª host-gw æ¨¡å¼ï¼Œæ—¢ç„¶åˆ é™¤ pod æ— ç”¨ï¼Œå°± edit å»æ‰ <code>flannel.alpha.coreos.com/backend-type</code> æ³¨è§£äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@vm172-16-0-202 ~]# kubectl edit node 172.16.0.202</span><br><span class="line">[root@vm172-16-0-202 ~]# kubectl -n kube-system delete pod kube-flannel-ds-2cxkf kube-flannel-ds-hml7r</span><br><span class="line">pod &quot;kube-flannel-ds-2cxkf&quot; deleted</span><br><span class="line">pod &quot;kube-flannel-ds-hml7r&quot; deleted</span><br><span class="line">[root@vm172-16-0-202 ~]# kubectl get no -o yaml | grep flannel</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &#x27;&#123;&quot;VNI&quot;:1,&quot;VtepMAC&quot;:&quot;de:87:3d:b7:74:fc&quot;&#125;&#x27;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: vxlan</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.104</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel@sha256:13cddb14533a10394aa9436bd96a4c866a139b7ef01e71526aae013e724acca7</span><br><span class="line">      - flannel/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin@sha256:85aa4c338969e97b1ab751fdc2c167af228a241a224e2d0e5b81ca0f3e93e1fa</span><br><span class="line">      - flannel/flannel-cni-plugin:v1.4.1-flannel1</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin:v1.4.1</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &#x27;&#123;&quot;VNI&quot;:1,&quot;VtepMAC&quot;:&quot;f6:12:96:a0:5a:14&quot;&#125;&#x27;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: vxlan</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.202</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel@sha256:13cddb14533a10394aa9436bd96a4c866a139b7ef01e71526aae013e724acca7</span><br><span class="line">      - flannel/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin@sha256:85aa4c338969e97b1ab751fdc2c167af228a241a224e2d0e5b81ca0f3e93e1fa</span><br><span class="line">      - flannel/flannel-cni-plugin:v1.4.1-flannel1</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin:v1.4.1</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &#x27;&#123;&quot;VNI&quot;:1,&quot;VtepMAC&quot;:&quot;1e:24:24:5e:b8:84&quot;&#125;&#x27;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: vxlan</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.231</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel@sha256:13cddb14533a10394aa9436bd96a4c866a139b7ef01e71526aae013e724acca7</span><br><span class="line">      - flannel/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel:v0.25.4</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin@sha256:85aa4c338969e97b1ab751fdc2c167af228a241a224e2d0e5b81ca0f3e93e1fa</span><br><span class="line">      - flannel/flannel-cni-plugin:v1.4.1-flannel1</span><br><span class="line">      - reg.xxx.lan:5000/xxx/flannel-cni-plugin:v1.4.1</span><br><span class="line">      flannel.alpha.coreos.com/backend-data: &#x27;&#123;&quot;VNI&quot;:1,&quot;VtepMAC&quot;:&quot;36:a5:28:4d:ec:e3&quot;&#125;&#x27;</span><br><span class="line">      flannel.alpha.coreos.com/backend-type: vxlan</span><br><span class="line">      flannel.alpha.coreos.com/kube-subnet-manager: &quot;true&quot;</span><br><span class="line">      flannel.alpha.coreos.com/public-ip: 172.16.0.250</span><br></pre></td></tr></table></figure><p>å‰©ä¸‹å‡ ä¸ª node å¤„ç†åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@vm172-16-0-202 ~]# ip r s</span><br><span class="line">default via 172.16.0.1 dev eth0 proto dhcp metric 100 </span><br><span class="line">10.97.0.0/24 via 10.97.0.0 dev flannel.1 onlink </span><br><span class="line">10.97.1.0/24 via 10.97.1.0 dev flannel.1 onlink </span><br><span class="line">10.97.2.0/24 via 172.16.0.250 dev eth0 </span><br><span class="line">10.97.2.0/24 dev cni0 proto kernel scope link src 10.97.2.1 </span><br><span class="line">10.97.3.0/24 via 10.97.3.0 dev flannel.1 onlink </span><br><span class="line">10.185.0.0/16 dev docker0 proto kernel scope link src 10.185.0.1 linkdown </span><br><span class="line">10.187.0.0/24 via 172.16.0.250 dev eth0 </span><br><span class="line">10.187.2.0/24 via 172.16.0.104 dev eth0 </span><br><span class="line">10.187.3.0/24 via 172.16.0.231 dev eth0 </span><br><span class="line">172.16.0.0/24 dev eth0 proto kernel scope link src 172.16.0.202 metric 100</span><br></pre></td></tr></table></figure><p>é‡å¯åä¹Ÿæ²¡é—®é¢˜</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@vm172-16-0-202 ~]# ip r</span><br><span class="line">default via 172.16.0.1 dev eth0 proto dhcp metric 100 </span><br><span class="line">10.97.0.0/24 via 10.97.0.0 dev flannel.1 onlink </span><br><span class="line">10.97.1.0/24 via 10.97.1.0 dev flannel.1 onlink </span><br><span class="line">10.97.2.0/24 dev cni0 proto kernel scope link src 10.97.2.1 </span><br><span class="line">10.97.3.0/24 via 10.97.3.0 dev flannel.1 onlink </span><br><span class="line">10.185.0.0/16 dev docker0 proto kernel scope link src 10.185.0.1 linkdown </span><br><span class="line">172.16.0.0/24 dev eth0 proto kernel scope link src 172.16.0.202 metric 100</span><br></pre></td></tr></table></figure><p>è¯¢é—®äº†æ˜¯ä¸æ˜¯æœ‰äººæœ€å¼€å§‹éƒ¨ç½²æ”¹è¿‡æ¨¡å¼äº†ï¼Œè¯´æ²¡æœ‰ï¼Œå¥‡æ€ªäº†ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€æ¬¡ flannel è·¯ç”±é”™ä¹±å¯¼è‡´çš„è·¨èŠ‚ç‚¹ä¸é€š&lt;/p&gt;</summary>
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="flannel" scheme="http://zhangguanzhang.github.io/tags/flannel/"/>
    
    <category term="vxlan" scheme="http://zhangguanzhang.github.io/tags/vxlan/"/>
    
  </entry>
  
  <entry>
    <title>ç§æœ‰åŒ–ä¸‹(CentOS 7)Podmanè°ƒç ”</title>
    <link href="http://zhangguanzhang.github.io/2025/08/06/centos7-podman/"/>
    <id>http://zhangguanzhang.github.io/2025/08/06/centos7-podman/</id>
    <published>2025-08-06T10:10:30.000Z</published>
    <updated>2025-08-06T10:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>CentOS 7 ä¸Š Podmanè°ƒç ”â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å†…éƒ¨éœ€è¦è°ƒç ” podman æ›¿æ¢æ‰ dockerï¼Œå› ä¸ºæˆ‘ä»¬ç§æœ‰åŒ–è¦é€‚é…å¾ˆå¤šæ“ä½œç³»ç»Ÿï¼ˆå¾ˆå¤šå®¢æˆ·å†…éƒ¨è§„å®šäº†å¿…é¡»ä½¿ç”¨å•¥ç³»ç»Ÿï¼Œæ‰€ä»¥è¦æ”¯æŒï¼‰ï¼Œä½¿ç”¨æœ€å¸¸è§çš„ CentOS 7ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/redhat-release</span> </span><br><span class="line">CentOS Linux release 7.8.2003 (Core)</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">uname</span> -a</span></span><br><span class="line">Linux xxx 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="ç¦»çº¿å®‰è£…"><a href="#ç¦»çº¿å®‰è£…" class="headerlink" title="ç¦»çº¿å®‰è£…"></a>ç¦»çº¿å®‰è£…</h3><p><a href="https://podman.io/docs/installation">å®˜æ–¹å®‰è£…æ–‡æ¡£</a>ä¸Šå¹¶æ²¡æœ‰ centos7 çš„å®‰è£…ï¼Œå› ä¸ºå·²ç» EOL å¥½å‡ å¹´ã€‚è€ƒè™‘åˆ°å®¢æˆ·ä¼šæ— ç½‘ï¼Œéœ€è¦ç±»ä¼¼ docker-static é‚£æ ·ï¼Œæœç´¢è°·æ­Œå’Œ github æ‰¾åˆ° <a href="https://github.com/mgoltzsche/podman-static">podman-static</a>ã€‚podman æœ€æ–°ç‰ˆæœ¬æ˜¯v5ï¼Œä¸‹è½½ v5.5.2 çš„å‹ç¼©åŒ…åè§£å‹ã€‚</p><h3 id="daemon-è¿›ç¨‹ç›¸å…³"><a href="#daemon-è¿›ç¨‹ç›¸å…³" class="headerlink" title="daemon è¿›ç¨‹ç›¸å…³"></a>daemon è¿›ç¨‹ç›¸å…³</h3><p>å› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦è°ƒç”¨ APIï¼Œæ‰€ä»¥éœ€è¦èµ· daemon è¿›ç¨‹ç›‘å¬ socket å’Œ tcpï¼Œéœ€è¦ä»¥ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">podman system service -h</span></span><br><span class="line">Run API service</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  Run an API service</span><br><span class="line"></span><br><span class="line">Enable a listening service for API access to Podman commands.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  podman system service [options] [URI]</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  podman system service --time=0 unix:///tmp/podman.sock</span><br><span class="line">  podman system service --time=0 tcp://localhost:8888</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --cors string   Set CORS Headers</span><br><span class="line">  -t, --time uint     Time until the service session expires in seconds.  Use 0 to disable the timeout (default 5)</span><br></pre></td></tr></table></figure><p>å‘ç°æ— æ³•åŒæ—¶ç›‘å¬ tcp å’Œ socketï¼Œå¹¶ä¸” tcp ä¸æ”¯æŒtlsé€‰é¡¹ï¼Œæœç´¢issue <a href="https://github.com/containers/podman/issues/24583">Support (m)TLS API socket</a>å‘ç°æš‚æœªæ”¯æŒï¼Œåªèƒ½ä½¿ç”¨ socket ç›‘å¬ã€‚</p><p>ç„¶åå‘ç°æ— æ³•ç›‘å¬æŒ‡å®šè·¯å¾„ socketæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">API service listening on \&quot;/run/podman/podman.sock\&quot;. URI: \&quot;unix:///var/run/docker.sock\&quot;&quot;</span><br></pre></td></tr></table></figure><p>æŸ¥é˜… podman æºç ï¼Œå‘ç°èµ°åˆ°ä»¥ä¸‹é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/containers/podman/blob/v5.5.2/cmd/podman/system/service_abi.go#L58-L77</span></span><br><span class="line">        <span class="keyword">switch</span> uri.Scheme &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;unix&quot;</span>:</span><br><span class="line">            path, err := filepath.Abs(uri.Path)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> os.Getenv(<span class="string">&quot;LISTEN_FDS&quot;</span>) != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">                <span class="comment">// If it is activated by systemd, use the first LISTEN_FD (3)</span></span><br><span class="line">                <span class="comment">// instead of opening the socket file.</span></span><br><span class="line">                f := os.NewFile(<span class="type">uintptr</span>(<span class="number">3</span>), <span class="string">&quot;podman.sock&quot;</span>)</span><br><span class="line">                listener, err = net.FileListener(f)</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> err</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                listener, err = net.Listen(uri.Scheme, path)</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to create socket: %w&quot;</span>, err)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æŸ¥çœ‹ env å‘ç°ç¡®å®æœ‰ <code>LISTEN_FDS</code> çš„ envï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">xargs -n1 -0 &lt; /proc/$(pgrep podman)/environ</span></span><br><span class="line">LANG=zh_CN.UTF-8</span><br><span class="line">PATH=&quot;/data/kube/bin:/bin:/sbin:/usr/bin:/usr/sbin&quot;</span><br><span class="line">LISTEN_PID=9047</span><br><span class="line">LISTEN_FDS=1</span><br><span class="line">LOGGING=&quot;--log-level=info&quot;</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ä»£ç è¯´æ˜ï¼Œæ˜¯æ”¯æŒ systemd çš„ socket ä¸»åŠ¨æ¿€æ´»ï¼Œæˆ‘ä»¬ä¸éœ€è¦ï¼Œå»æ‰å‹ç¼©åŒ…é‡Œçš„:</p><ol><li><code>system/podman.socket</code></li><li><code>system/podman.service</code> å†… requireå’Œ after podman.socket</li></ol><p>ç„¶åå¯åŠ¨å¯è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">API service listening on &quot;/var/run/docker.sock&quot;. URI: &quot;unix:///var/run/docker.sock&quot;</span><br></pre></td></tr></table></figure><h3 id="info-çš„-format-å·®å¼‚"><a href="#info-çš„-format-å·®å¼‚" class="headerlink" title="info çš„ format å·®å¼‚"></a>info çš„ format å·®å¼‚</h3><p>æˆ‘ä»¬ä½¿ç”¨åˆ°äº†éƒ¨åˆ† info é‡Œçš„ format å­˜åœ¨å·®å¼‚ï¼š</p><ol><li><code>&#39;&#123;&#123;.OSType&#125;&#125;&#39;</code> -&gt; <code>&#39;&#123;&#123;.Host.OS&#125;&#125;&#39;</code></li><li><code>&#39;&#123;&#123;.DockerRootDir&#125;&#125;&#39;</code> -&gt; <code>&#39;&#123;&#123;.Store.GraphRoot&#125;&#125;&#39;</code></li></ol><h3 id="é-host-ç½‘ç»œå®¹å™¨"><a href="#é-host-ç½‘ç»œå®¹å™¨" class="headerlink" title="é host ç½‘ç»œå®¹å™¨"></a>é host ç½‘ç»œå®¹å™¨</h3><p>éƒ¨ç½²åå‘ç°æ— æ³•å¯åŠ¨é host ç½‘ç»œå®¹å™¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --name registry_pass --entrypoint htpasswd registry:2.7.1</span></span><br><span class="line">Error: creating network namespace for container 3de0fd230fd7693a107de4b56e5ab1444a558ae1e835e78e292ed364915a6362: failed to create namespace: failed to bind mount ns at /run/netns/netns-b0f807fe-e630-3182-e16b-5b5837e2b1a3: no such file or directory</span><br></pre></td></tr></table></figure><p>golang ä»£ç çš„ Error æ˜¯ä¿¡æ¯å åŠ çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æœç´¢æŠ¥é”™ <code>creating network namespace for container</code> ï¼Œæ‰¾åˆ°æŠ¥é”™ä»£ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/containers/podman/blob/v5.5.2/libpod/networking_linux.go#L77-L81</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runtime)</span></span> createNetNS(ctr *Container) (n <span class="type">string</span>, q <span class="keyword">map</span>[<span class="type">string</span>]types.StatusBlock, retErr <span class="type">error</span>) &#123;</span><br><span class="line">    ctrNS, err := netns.NewNS()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;creating network namespace for container %s: %w&quot;</span>, ctr.ID(), err)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è·³è½¬åˆ° <code>netns.NewNS()</code> å†…ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNS</span><span class="params">()</span></span> (ns.NetNS, <span class="type">error</span>) &#123;</span><br><span class="line">    nsRunDir, err := GetNSRunDir()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the directory for mounting network namespaces</span></span><br><span class="line">    <span class="comment">// This needs to be a shared mountpoint in case it is mounted in to</span></span><br><span class="line">    <span class="comment">// other namespaces (containers)</span></span><br><span class="line">    err = makeNetnsDir(nsRunDir)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">range</span> <span class="number">10000</span> &#123;</span><br><span class="line">        nsName, err := getRandomNetnsName()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        nsPath := path.Join(nsRunDir, nsName)</span><br><span class="line">        ns, err := newNSPath(nsPath)</span><br><span class="line">        <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ns, <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// retry when the name already exists</span></span><br><span class="line">        <span class="keyword">if</span> errors.Is(err, os.ErrExist) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, errNoFreeName</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯é‚£è¡Œ <code>makeNetnsDir()</code> æŠ¥é”™ï¼Œå†…éƒ¨éƒ½æ˜¯åŸºç¡€çš„æ–‡ä»¶å’Œ ns mount æ“ä½œï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeNetnsDir</span><span class="params">(nsRunDir <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    err := os.MkdirAll(nsRunDir, <span class="number">0o755</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Important, the bind mount setup is racy if two process try to set it up in parallel.</span></span><br><span class="line">    <span class="comment">// This can have very bad consequences because we end up with two duplicated mounts</span></span><br><span class="line">    <span class="comment">// for the netns file that then might have a different parent mounts.</span></span><br><span class="line">    <span class="comment">// Also because as root netns dir is also created by ip netns we should not race against them.</span></span><br><span class="line">    <span class="comment">// Use a lock on the netns dir like they do, compare the iproute2 ip netns add code.</span></span><br><span class="line">    <span class="comment">// https://github.com/iproute2/iproute2/blob/8b9d9ea42759c91d950356ca43930a975d0c352b/ip/ipnetns.c#L806-L815</span></span><br><span class="line"></span><br><span class="line">    dirFD, err := unix.Open(nsRunDir, unix.O_RDONLY|unix.O_DIRECTORY|unix.O_CLOEXEC, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;os.PathError&#123;Op: <span class="string">&quot;open&quot;</span>, Path: nsRunDir, Err: err&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// closing the fd will also unlock so we do not have to call flock(fd,LOCK_UN)</span></span><br><span class="line">    <span class="keyword">defer</span> unix.Close(dirFD)</span><br><span class="line"></span><br><span class="line">    err = unix.Flock(dirFD, unix.LOCK_EX)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to lock %s dir: %w&quot;</span>, nsRunDir, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remount the namespace directory shared. This will fail with EINVAL</span></span><br><span class="line">    <span class="comment">// if it is not already a mountpoint, so bind-mount it on to itself</span></span><br><span class="line">    <span class="comment">// to &quot;upgrade&quot; it to a mountpoint.</span></span><br><span class="line">    err = unix.Mount(<span class="string">&quot;&quot;</span>, nsRunDir, <span class="string">&quot;none&quot;</span>, unix.MS_SHARED|unix.MS_REC, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err != unix.EINVAL &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;mount --make-rshared %s failed: %q&quot;</span>, nsRunDir, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Recursively remount /run/netns on itself. The recursive flag is</span></span><br><span class="line">    <span class="comment">// so that any existing netns bindmounts are carried over.</span></span><br><span class="line">    err = unix.Mount(nsRunDir, nsRunDir, <span class="string">&quot;none&quot;</span>, unix.MS_BIND|unix.MS_REC, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;mount --rbind %s %s failed: %q&quot;</span>, nsRunDir, nsRunDir, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we can make it shared</span></span><br><span class="line">    err = unix.Mount(<span class="string">&quot;&quot;</span>, nsRunDir, <span class="string">&quot;none&quot;</span>, unix.MS_SHARED|unix.MS_REC, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;mount --make-rshared %s failed: %q&quot;</span>, nsRunDir, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹è½½ä»£ç åç¼–è¯‘ podman è°ƒè¯•çœ‹çœ‹ <code>makeNetnsDir()</code> å…·ä½“å“ªä¸ªæ­¥éª¤å‡ºé—®é¢˜ï¼Œå‘ç°æ— æ³•è·³åˆ°æ–­ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ dlv exec bin/podman --  run  -ti --entrypoint ls docker.io/library/registry:2.7.1</span><br><span class="line">Type &#x27;help&#x27; for list of commands.</span><br><span class="line">(dlv) b libpod/networking_linux.go:78</span><br><span class="line">Breakpoint 1 set at 0x1555494 for github.com/containers/podman/v5/libpod.(*Runtime).createNetNS() ./libpod/networking_linux.go:78</span><br><span class="line">(dlv) c</span><br><span class="line">WARN[0000] Using cgroups-v1 which is deprecated in favor of cgroups-v2 with Podman v5 and will be removed in a future version. Set environment variable `PODMAN_IGNORE_CGROUPSV1_WARNING` to hide this warning. </span><br><span class="line">WARN[0000] The input device is not a TTY. The --tty and --interactive flags might not work properly </span><br><span class="line">received SIGINT, stopping process (will not forward signal)</span><br><span class="line">&gt; runtime.futex() /usr/local/go/src/runtime/sys_linux_amd64.s:558 (PC: 0x492243)</span><br><span class="line">Warning: debugging optimized function</span><br><span class="line">   553:        MOVQ    ts+16(FP), R10</span><br><span class="line">   554:        MOVQ    addr2+24(FP), R8</span><br><span class="line">   555:        MOVL    val3+32(FP), R9</span><br><span class="line">   556:        MOVL    $SYS_futex, AX</span><br><span class="line">   557:        SYSCALL</span><br><span class="line">=&gt; 558:        MOVL    AX, ret+40(FP)</span><br></pre></td></tr></table></figure><p>ç„¶åå‘ç° <code>podman info</code> ä¹Ÿå¡ä½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/podman  info</span></span><br><span class="line">WARN[0000] Using cgroups-v1 which is deprecated in favor of cgroups-v2 with Podman v5 and will be removed in a future version. Set environment variable `PODMAN_IGNORE_CGROUPSV1_WARNING` to hide this warning. </span><br><span class="line">^C</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ <code>podman info</code> è°ƒç”¨é“¾ï¼Œè°ƒè¯•äº†ä¸‹å‘ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(dlv) n</span><br><span class="line">&gt; github.com/containers/podman/v5/libpod.(*Runtime).hostInfo() ./libpod/info.go:106 (PC: 0x21d942e)</span><br><span class="line">   101:        cpuUtil, err := getCPUUtilization()</span><br><span class="line">   102:        if err != nil &#123;</span><br><span class="line">   103:            return nil, err</span><br><span class="line">   104:        &#125;</span><br><span class="line">   105:    </span><br><span class="line">=&gt; 106:        locksFree, err := r.lockManager.AvailableLocks()</span><br><span class="line">   107:        if err != nil &#123;</span><br><span class="line">   108:            return nil, fmt.Errorf(&quot;getting free locks: %w&quot;, err)</span><br><span class="line">   109:        &#125;</span><br><span class="line">   110:    </span><br><span class="line">   111:        info := define.HostInfo&#123;</span><br><span class="line">(dlv) n</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ä»£ç æ˜¯å¡åœ¨ cgo çš„ shm lock é‚£é‡Œï¼Œæ— æ³•è°ƒè¯•æ‰¾åˆ°ç½‘ç»œnsåˆ›å»ºé—®é¢˜ã€‚</p><h3 id="v4ç‰ˆæœ¬å°è¯•"><a href="#v4ç‰ˆæœ¬å°è¯•" class="headerlink" title="v4ç‰ˆæœ¬å°è¯•"></a>v4ç‰ˆæœ¬å°è¯•</h3><p>v4 å·²ç»ä¸ç»´æŠ¤ï¼Œå®˜æ–¹ä¸»å¹²ç‰ˆæœ¬æ˜¯ v5ï¼Œå°è¯•ä¸‹è½½äº†æœ€æ–°çš„v4 v4.9.5 å¯åŠ¨æŠ¥é”™ä¸æ”¯æŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">podman run --entrypoint <span class="built_in">ls</span> alpine:latest</span></span><br><span class="line">Error: netavark: create veth pair: Netlink error: Not supported (os error 95)</span><br></pre></td></tr></table></figure><p>å¯¹äºv5å’Œv4çš„æŠ¥é”™å‡æœç´¢åˆ°ç±»ä¼¼çš„é—®é¢˜:</p><ul><li><a href="https://github.com/mgoltzsche/podman-static/issues/138">https://github.com/mgoltzsche/podman-static/issues/138</a></li><li><a href="https://github.com/containers/podman/discussions/12840">https://github.com/containers/podman/discussions/12840</a></li></ul><p>centos7çš„3.10å†…æ ¸ä¸æ»¡è¶³æœ€ä½çš„4.18</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><ol><li>podman ç°é˜¶æ®µä¸æ”¯æŒ tlsï¼Œå¹¶ä¸” socket å’Œ tcp æ— æ³•åŒæ—¶ç›‘å¬ï¼Œå®‰å…¨é—®é¢˜åªèƒ½ä½¿ç”¨ socket æ–‡ä»¶ï¼Œæ— æ³•è¿œç¨‹ç®¡ç†</li><li>ç§æœ‰åŒ–éœ€è¦æ”¯æŒä¼—å¤šæ“ä½œç³»ç»Ÿä¸‹ï¼Œå†…æ ¸ç‰ˆæœ¬è·¨åº¦ä»è€åˆ°æ–°éƒ½æœ‰ï¼Œæ— æ³•ä½¿ç”¨ podmanï¼Œå¦‚æœä¸æ˜¯ç§æœ‰åŒ–è‡ªå·±å•ä¸€ç¯å¢ƒä¸”æœ‰ç½‘çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;CentOS 7 ä¸Š Podmanè°ƒç ”â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="podman" scheme="http://zhangguanzhang.github.io/tags/podman/"/>
    
    <category term="centos" scheme="http://zhangguanzhang.github.io/tags/centos/"/>
    
  </entry>
  
  <entry>
    <title>python grpc ä½¿ç”¨åŸŸåç¬¬ä¸€æ¬¡è€—æ—¶é•¿é—®é¢˜</title>
    <link href="http://zhangguanzhang.github.io/2025/07/29/python-grpc-first-long/"/>
    <id>http://zhangguanzhang.github.io/2025/07/29/python-grpc-first-long/</id>
    <published>2025-07-29T17:40:30.000Z</published>
    <updated>2025-07-29T17:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ python grpc è€—æ—¶é•¿é—®é¢˜â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æ˜¨å¤©ä¸Šç€ç­çªç„¶è¢«ç¾¤é‡Œæ‹‰åˆ°ä¸€ä¸ªå¼€å‘ä»»åŠ¡ç¾¤é‡Œï¼Œçœ‹äº†ä¸‹èŠå¤©è®°å½•è¯´å•¥æ…¢ï¼Œè¯¢é—®äº†ä¸‹ç†æ¸…äº†æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> client    server1   model server</span><br><span class="line">â”Œâ”€â”€â”        â”Œâ”€â”€â”        â”Œâ”€â”€â” </span><br><span class="line">â””â”¬â”€â”˜        â””â”¬â”€â”˜        â””â”€â”¬â”˜ </span><br><span class="line"> â”œâ”€â”€â”€httpâ”€â”€â”€â–ºâ”‚            â”‚  </span><br><span class="line"> â”‚           â”œâ”€â”€â”€grpcâ”€â”€â”€â”€â–ºâ”‚  </span><br><span class="line"> â”‚           â”‚â—„â”€â”€grpcâ”€â”€â”€â”€â”€â”¤  </span><br><span class="line"> â”‚â—„â”€â”€â”€httpâ”€â”€â”€â”¤            â”‚  </span><br><span class="line">                          </span><br></pre></td></tr></table></figure><p>http å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡1ï¼Œå¸¦äº†æ¨¡å‹æœåŠ¡çš„ <code>model_url</code>ï¼Œserver1 ä¼š grpc è¯·æ±‚ <code>model_url</code>ï¼Œç„¶åå‘ç°å›å¤éå¸¸æ…¢ï¼ŒæŠŠ <code>ai-xxx</code> æ¢æˆå®é™…çš„å¤–éƒ¨ IP å°±ä¼šå¾ˆå¿«ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl --location &#x27;http://xxxx:8870/chat&#x27; \</span><br><span class="line">    --header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">    --data &#x27;&#123;</span><br><span class="line">        &quot;stream&quot;: true,</span><br><span class="line">        &quot;messages_type&quot;: 1,</span><br><span class="line">        &quot;title&quot;: &quot;äººå·¥æ™ºèƒ½&quot;,</span><br><span class="line">        &quot;inspiration&quot;: &quot;æ–‡é£ä¸¥è°¨ï¼Œè¯­è¨€ç®€æ´å‡ç»ƒ&quot;,</span><br><span class="line">        &quot;model_config&quot;: &#123;</span><br><span class="line">            &quot;default&quot;: true,</span><br><span class="line">            &quot;type&quot;: &quot;xxxx&quot;,</span><br><span class="line">            &quot;model_url&quot;: &quot;ai-xxx&quot;,</span><br><span class="line">            &quot;model_name&quot;: &quot;xxxxx-xxxx&quot;,</span><br><span class="line">            &quot;model&quot;: &quot;xxxxx&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#x27;</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒä¸Šæµ‹äº†ä¸‹æœç„¶æ˜¯ï¼Œserver1 çš„è®¿é—®æ—¥å¿—çœ‹æœ‰ 9s å·¦å³è€—æ—¶ï¼Œçœ‹äº†ä¸‹ç¯å¢ƒæ˜¯ k8sï¼Œ <code>ai-xxx</code> æ˜¯ç›´æ¥åˆ›å»ºçš„ svc å’Œ epï¼Œendpoint ä¸ºå¤–éƒ¨ä¸€ä¸ªæ¨¡å‹æœåŠ¡çš„ ip ç«¯å£ã€‚çœ‹äº†ä¸‹ server1 å†…çš„ <code>/etc/nsswitch</code> æ­£å¸¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grep hosts /etc/nsswitch.conf </span><br><span class="line">hosts:          files dns</span><br></pre></td></tr></table></figure><p>åŠ äº†ä¸‹ hosts æµ‹ä¸‹è¿˜æ˜¯æ¯æ¬¡éƒ½å¿…ç°ï¼Œå¯ä»¥è‚¯å®šå’Œ k8s dns æ— å…³äº†ï¼Œå¦‚æœæ˜¯ k8s dns 5s timeout é—®é¢˜ï¼Œé‚£æ˜¯ IPv6 çš„ AAAA è®°å½•äº”å…ƒç»„å†²çªå¯¼è‡´çš„è¶…æ—¶çš„è¯éƒ½æ˜¯å¶ç°è€Œéå¿…ç°ï¼Œå’Œè¿™ä¸ªä¸ä¸€æ ·ã€‚</p><h2 id="è§£å†³è¿‡ç¨‹"><a href="#è§£å†³è¿‡ç¨‹" class="headerlink" title="è§£å†³è¿‡ç¨‹"></a>è§£å†³è¿‡ç¨‹</h2><p>åˆæ­¥æ€€ç–‘æ˜¯ç ”å‘çš„ server1 åç«¯æ¥å£é€»è¾‘æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä»–ä»¬è¯´æœ‰äº›ç¯å¢ƒæ­£å¸¸æœ‰äº›ä¸æ­£å¸¸ï¼Œäºæ˜¯æˆ‘è®©ä»–ä»¬ç»™ä¸ªæœ€å°çš„ python grpc client è®¿é—®æ¨¡å‹çš„ demoã€‚è¿™æ ·äºŒåˆ†æ’é™¤èŒƒå›´ï¼Œä¸ç„¶ä¸¤ä¸ªé“¾è·¯ä¸å¥½æŸ¥ã€‚æ²¡æƒ³åˆ°ä»Šå¤©æµ‹è¯•åˆå‚¬è¿™ä¸ªé—®é¢˜çœ‹å¾—å’‹æ ·äº†ã€‚ç„¶åè®©ç ”å‘æŠŠ demo å‘è¿‡æ¥çœ‹ã€‚</p><h3 id="demo-å¤ç°"><a href="#demo-å¤ç°" class="headerlink" title="demo å¤ç°"></a>demo å¤ç°</h3><p>æ‹¿åˆ° demo æœ‰ç‚¹æ— è¯­ï¼Œè¿™ç§è€—æ—¶çš„æ‰“å°å±…ç„¶æ˜¯ç”¨çš„ printï¼Œæ‰‹åŠ¨ä¿®æ”¹æˆ logging åæµ‹è¯•å¤ç°äº†ï¼Œå¤§æ¦‚é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_urls = [</span><br><span class="line">    <span class="string">&quot;ai-xxx:80&quot;</span>,</span><br><span class="line">    <span class="string">&quot;10.xx.xx.xxx:10037&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> server_url <span class="keyword">in</span> server_urls:</span><br><span class="line">    grpc_test()</span><br></pre></td></tr></table></figure><p>æ‹·è´åˆ° server1 çš„å®¹å™¨é‡Œæ‰§è¡Œï¼Œå‘ç°å¿…ç°ï¼Œè€—æ—¶ä¹…çš„é™„è¿‘æ˜¯å¦‚ä¸‹ <code>35s - 43s</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2025-07-29 16:52:35 [INFO] ğŸ”¥ å¼€å§‹æµ‹è¯•GRPCè¿æ¥: ai-xxx:80</span><br><span class="line">2025-07-29 16:52:35 [INFO] ğŸ“¡ åˆ›å»ºTritonå®¢æˆ·ç«¯...</span><br><span class="line">2025-07-29 16:52:35 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 16:52:35 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</span><br><span class="line">2025-07-29 16:52:43 [INFO]    æœåŠ¡å™¨å­˜æ´»: âœ…</span><br><span class="line">2025-07-29 16:52:43 [INFO]    æœåŠ¡å™¨å°±ç»ª: âœ…</span><br><span class="line">2025-07-29 16:52:43 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br><span class="line">...</span><br><span class="line">2025-07-29 16:52:44 [INFO] ğŸ”¥ å¼€å§‹æµ‹è¯•GRPCè¿æ¥: 10.xx.xx.xxx:10037</span><br><span class="line">2025-07-29 16:52:44 [INFO] ğŸ“¡ åˆ›å»ºTritonå®¢æˆ·ç«¯...</span><br><span class="line">2025-07-29 16:52:44 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 16:52:44 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</span><br><span class="line">2025-07-29 16:52:44 [INFO]    æœåŠ¡å™¨å­˜æ´»: âœ…</span><br><span class="line">2025-07-29 16:52:44 [INFO]    æœåŠ¡å™¨å°±ç»ª: âœ…</span><br><span class="line">2025-07-29 16:52:44 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ demo ä»£ç å¯¹åº”ä½ç½®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">triton_client = grpcclient.InferenceServerClient(</span><br><span class="line">    url=server_url,</span><br><span class="line">    verbose=<span class="literal">False</span></span><br><span class="line">)</span><br><span class="line">logging.info(<span class="string">&quot;âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live&quot;</span>)</span><br><span class="line">is_live = triton_client.is_server_live()</span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready&quot;</span>)</span><br><span class="line">is_ready = triton_client.is_server_ready()</span><br></pre></td></tr></table></figure><p><code>python -m pdb grpc-test.py</code> è°ƒè¯•äº†ä¸‹ï¼Œå‘ç°è¿™ä¸ªæ–¹æ³•åªæ˜¯ä¸€ä¸ªçº¯ç²¹çš„ grpc è¯·æ±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) n</span><br><span class="line">&gt; /usr/local/lib/python3<span class="number">.10</span>/site-packages/tritonclient/grpc/_client.py(<span class="number">294</span>)is_server_live()</span><br><span class="line">-&gt; <span class="keyword">try</span>:</span><br><span class="line">(Pdb) <span class="built_in">list</span></span><br><span class="line"><span class="number">289</span>          InferenceServerException</span><br><span class="line"><span class="number">290</span>              If unable to get liveness <span class="keyword">or</span> has timed out.</span><br><span class="line"><span class="number">291</span>  </span><br><span class="line"><span class="number">292</span>          <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">293          metadata = self._get_metadata(headers)</span></span><br><span class="line"><span class="string">294  -&gt;        try:</span></span><br><span class="line"><span class="string">295              request = service_pb2.ServerLiveRequest()</span></span><br><span class="line"><span class="string">296              if self._verbose:</span></span><br><span class="line"><span class="string">297                  print(&quot;is_server_live, metadata &#123;&#125;\n&#123;&#125;&quot;.format(metadata, request))</span></span><br><span class="line"><span class="string">298              response = self._client_stub.ServerLive(</span></span><br><span class="line"><span class="string">299                  request=request, metadata=metadata, timeout=client_timeout</span></span><br></pre></td></tr></table></figure><p>grpc å®¢æˆ·ç«¯ç”¨çš„ <code>tritonclient</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pip list | grep client</span></span><br><span class="line">tritonclient           2.57.0</span><br></pre></td></tr></table></figure><p><a href="https://pypi.org/project/tritonclient/#history">pypi</a> æŸ¥äº†ä¸‹è¿™ä¸ª grpc åº“å‘ç°æ‰¾åˆ°çš„ä»“åº“ <a href="https://github.com/triton-inference-server/client">triton-inference-server&#x2F;client</a> åˆ†æ”¯å’Œä¸Šé¢ç‰ˆæœ¬å·å¯¹ä¸ä¸Šï¼Œå¾ˆå¥‡æ€ªã€‚</p><p>è°·æ­Œæœäº†ä¸‹ <code>is_server_live long time</code> å‘ç°èƒ½æœåˆ°åŒæ ·é—®é¢˜ <a href="https://github.com/triton-inference-server/server/issues/3800">is_server_live() python GRPC client got no response</a>ï¼Œä½†æ˜¯åˆ«äººç”¨çš„æ˜¯ IP ï¼Œåé¢è¿˜æŠŠ issue å…³é—­äº†è¯´æ˜¯ä»–ä»¬è‡ªå·±çš„ç½‘ç»œé—®é¢˜ã€‚</p><p>ç„¶åè®©ç ”å‘æ‰¾ <code>is_server_live()</code> çš„ grpc server ç«¯ç ”å‘æŸ¥ä¸‹ <code>ServerLive</code> æ¥å£è°ƒç”¨é€»è¾‘ï¼Œå¦ä¸€æ–¹é¢è®© server1 ç ”å‘æŠŠ <code>is_server_live()</code> æ³¨é‡Šäº†è¯•è¯•ï¼Œä»–è¯´èµ° CI æµç¨‹ä¼šç¨å¾®æ…¢äº›ï¼Œè®©æˆ‘çœ‹çœ‹ç¯å¢ƒä¸Šèƒ½ç›´æ¥æ”¹ä¸ï¼Œäºæ˜¯å¤§å®¶ä¸€èµ·å¹¶è¡Œæ“ä½œã€‚</p><h3 id="ç¨æœ‰çœ‰ç›®"><a href="#ç¨æœ‰çœ‰ç›®" class="headerlink" title="ç¨æœ‰çœ‰ç›®"></a>ç¨æœ‰çœ‰ç›®</h3><p>å‘ç°ç¯å¢ƒæ”¹äº†åè¿˜æ˜¯å¤ç°ï¼Œäºæ˜¯æˆ‘åœ¨ demo é‡Œæ”¹äº†ä¸‹å‘ç°æ…¢åœ¨ç¬¬äºŒä¸ªäº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live&quot;</span>)</span><br><span class="line"><span class="comment"># is_live = triton_client.is_server_live()</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready&quot;</span>)</span><br><span class="line"><span class="comment"># is_ready = triton_client.is_server_ready()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logging.info(f&quot;   æœåŠ¡å™¨å­˜æ´»: &#123;&#x27;âœ…&#x27; if is_live else &#x27;âŒ&#x27;&#125;&quot;)</span></span><br><span class="line"><span class="comment"># logging.info(f&quot;   æœåŠ¡å™¨å°±ç»ª: &#123;&#x27;âœ…&#x27; if is_ready else &#x27;âŒ&#x27;&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if not is_live:</span></span><br><span class="line"><span class="comment">#     raise Exception(&quot;æœåŠ¡å™¨æœªå­˜æ´»&quot;)</span></span><br><span class="line"><span class="comment"># if not is_ready:</span></span><br><span class="line"><span class="comment">#     raise Exception(&quot;æœåŠ¡å™¨æœªå°±ç»ª&quot;)</span></span><br><span class="line"></span><br><span class="line">logging.info(<span class="string">&quot;âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è·å–æ¨¡å‹ä¿¡æ¯</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ“‹ è·å–æ¨¡å‹ä¿¡æ¯...&quot;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    model_metadata = triton_client.get_model_metadata(<span class="string">&quot;xxxxx&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2025-07-29 17:32:32 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 17:32:32 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live</span><br><span class="line">2025-07-29 17:32:32 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready</span><br><span class="line">2025-07-29 17:32:32 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br><span class="line">2025-07-29 17:32:32 [INFO] ğŸ“‹ è·å–æ¨¡å‹ä¿¡æ¯...</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æˆåŠŸè·å–æ¨¡å‹å…ƒæ•°æ®</span><br><span class="line">2025-07-29 17:32:40 [INFO]    æ¨¡å‹åç§°: xxxx</span><br><span class="line">2025-07-29 17:32:40 [INFO]    æ¨¡å‹ç‰ˆæœ¬: [&#x27;1&#x27;]</span><br><span class="line">2025-07-29 17:32:40 [INFO] ğŸ§  æ‰§è¡Œç®€å•æ¨ç†æµ‹è¯•...</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æµå¯åŠ¨æˆåŠŸ</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æ¨ç†è¯·æ±‚å‘é€æˆåŠŸ</span><br><span class="line">2025-07-29 17:32:40 [INFO] â³ ç­‰å¾…å“åº”...</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æ”¶åˆ°æˆåŠŸå“åº”</span><br><span class="line">2025-07-29 17:32:40 [INFO]    è¾“å‡ºtokens: [9]</span><br><span class="line">2025-07-29 17:32:40 [INFO] ğŸ‰ GRPCè¿æ¥æµ‹è¯•å®Œå…¨æˆåŠŸ!</span><br><span class="line">2025-07-29 17:32:40 [INFO] ğŸ‰ åŠ¡å™¨ ai-xxx:80 æµ‹è¯•æˆåŠŸ!</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡ä¸æ˜¯å‰é¢çš„ <code>is_server_live()</code> é—®é¢˜ï¼Œä»”ç»†çœ‹äº†ä¸‹ä»£ç æƒ³äº†ä¸‹æ˜¯ <code>grpcclient</code> çš„ç¬¬ä¸€ä¸ª grpc è¯·æ±‚æœ‰é—®é¢˜å¯¼è‡´è€—æ—¶é•¿ï¼Œæœç´¢äº†ä¸‹å‘ç°ä¸€æ ·ç›¸ä¼¼ä½†æ˜¯æ›´è€—æ—¶çš„é—®é¢˜ï¼š</p><ul><li><a href="https://github.com/triton-inference-server/server/issues/1821">https://github.com/triton-inference-server/server/issues/1821</a></li></ul><p>ä¸è¿‡ä¸Šé¢ issue é‡Œ triton å®˜æ–¹è¯´æ˜¯ <code>grpc/grpc</code> çš„é—®é¢˜ï¼Œ æœåˆ° <a href="https://github.com/grpc/grpc/issues/22260">Communication from c++ server to python client is too slow</a> è¯´ python å¾ˆæ…¢ä½†æ˜¯ c++ çš„ä¸æ…¢ï¼Œpython çš„é¦–æ¬¡ grpc å»ºç«‹è¿æ¥è€—æ—¶å¾ˆé•¿ï¼Œåç»­çš„è¯·æ±‚éƒ½åœ¨ ms å†…å®Œæˆã€‚issue å†…ä¸‹é¢å¤§ä½¬æ’æŸ¥å‡ºè€—æ—¶å¤§éƒ¨åˆ†å¼€é”€éƒ½æ˜¯åœ¨ libc ç›¸å…³è°ƒç”¨ä¸Šã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œgrpc æ˜¯é•¿è¿æ¥åæ¨æµï¼Œè®©ç ”å‘è¦ä¸è¦æ”¹ä»£ç å†™æˆè¿æ¥æ± è¯•è¯•ï¼Œä»–ä»¬è¯´æ¥ä¸åŠã€‚</p><p>æ„Ÿè§‰æ—¢ç„¶å’Œ triton æ— å…³ï¼Œå°±æœ <code>python grpc dns first time long</code> æœåˆ°äº† <a href="https://github.com/grpc/grpc/issues/24018">Python client hangs on first connection</a> ç±»ä¼¼é—®é¢˜ï¼Œæ’æŸ¥å’Œ DNS ç›¸å…³ï¼Œå‘ç°å¤§ä½¬è¯´è¯•è¯• <code>GRPC_DNS_RESOLVER=native</code> ï¼Œæœäº†ä¸‹ <code>grpc/grpc</code> å®˜æ–¹æ–‡æ¡£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* GRPC_DNS_RESOLVER</span><br><span class="line">  Declares which DNS resolver to use. The default is ares if gRPC is built with</span><br><span class="line">  c-ares support. Otherwise, the value of this environment variable is ignored.</span><br><span class="line">  Available DNS resolver include:</span><br><span class="line">  - ares (default on most platforms except iOS, Android or Node)- a DNS</span><br><span class="line">    resolver based around the c-ares library</span><br><span class="line">  - native - a DNS resolver based around getaddrinfo(), creates a new thread to</span><br><span class="line">    perform name resolution</span><br></pre></td></tr></table></figure><p>é»˜è®¤æ˜¯ c çš„åº“ <code>c-ares</code> å»è§£æçš„ï¼Œè®¾ç½®ä¸º <code>native</code> åˆ™ä½¿ç”¨ç³»ç»Ÿ libc çš„ <code>getaddrinfo()</code> ï¼Œäºæ˜¯æµ‹è¯•äº†ä¸‹å¯ä»¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GRPC_DNS_RESOLVER=native python3  /root/test2.py</span> </span><br><span class="line">2025-07-29 17:59:43 [INFO] âœ… tritonclientå¯¼å…¥æˆåŠŸ</span><br><span class="line">2025-07-29 17:59:43 [INFO] ============================================================</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸš€ GRPCè¿æ¥æµ‹è¯•å·¥å…·</span><br><span class="line">2025-07-29 17:59:43 [INFO] ============================================================</span><br><span class="line">2025-07-29 17:59:43 [INFO] </span><br><span class="line">ğŸ“ æµ‹è¯•æœåŠ¡å™¨: ai-xxx:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] ----------------------------------------</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ” æµ‹è¯•DNSè§£æ: ai-xxx:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] âœ… DNSè§£ææˆåŠŸ: ai-xxx -&gt; 10.186.44.250:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ”¥ å¼€å§‹æµ‹è¯•GRPCè¿æ¥: ai-xxx:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ“¡ åˆ›å»ºTritonå®¢æˆ·ç«¯...</span><br><span class="line">2025-07-29 17:59:43 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live</span><br><span class="line">2025-07-29 17:59:44 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æœåŠ¡å™¨å­˜æ´»: âœ…</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æœåŠ¡å™¨å°±ç»ª: âœ…</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br><span class="line">2025-07-29 17:59:44 [INFO] ğŸ“‹ è·å–æ¨¡å‹ä¿¡æ¯...</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æˆåŠŸè·å–æ¨¡å‹å…ƒæ•°æ®</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æ¨¡å‹åç§°: xxxx</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æ¨¡å‹ç‰ˆæœ¬: [&#x27;1&#x27;]</span><br><span class="line">2025-07-29 17:59:44 [INFO] ğŸ§  æ‰§è¡Œç®€å•æ¨ç†æµ‹è¯•...</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æµå¯åŠ¨æˆåŠŸ</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æ¨ç†è¯·æ±‚å‘é€æˆåŠŸ</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ python grpc è€—æ—¶é•¿é—®é¢˜â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="python" scheme="http://zhangguanzhang.github.io/tags/python/"/>
    
    <category term="grpc" scheme="http://zhangguanzhang.github.io/tags/grpc/"/>
    
  </entry>
  
  <entry>
    <title>golang gitlab subgroup æ„å»ºé—®é¢˜</title>
    <link href="http://zhangguanzhang.github.io/2025/06/17/golang-gitlab-subgroup/"/>
    <id>http://zhangguanzhang.github.io/2025/06/17/golang-gitlab-subgroup/</id>
    <published>2025-06-17T14:40:30.000Z</published>
    <updated>2025-06-17T14:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ subgroup é—®é¢˜â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å¼€å‘æ„å»º Docker é•œåƒæŠ¥é”™æ²¡æƒé™æ‹‰å–ä¾èµ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xxxapi/middlewares imports</span><br><span class="line">xxx.xxxgitlab.net/x/xx/xxx/econtext: xxx.xxxgitlab.net/x/xx/xxx@v1.6.5-rc.7.0.20250609085545-4855369c0f1e: invalid version: git ls-remote -q origin in /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c: exit status 128:</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">remote: The project you were looking for could not be found or you don&#x27;t have permission to view it.</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><h2 id="è§£å†³è¿‡ç¨‹"><a href="#è§£å†³è¿‡ç¨‹" class="headerlink" title="è§£å†³è¿‡ç¨‹"></a>è§£å†³è¿‡ç¨‹</h2><p>é•œåƒå†…æœ‰ gitlab çš„ deploy keysï¼Œåˆæ­¥æ€€ç–‘æ˜¯æ²¡ä¾èµ–ä»“åº“æƒé™ï¼Œè®©å¼€å‘è”ç³»è¯¥ä¾èµ–ä»“åº“è´Ÿè´£äººï¼Œå»å¼€å¯ <code>Enabled deploy keys</code> åè¿˜æ˜¯ä¸€æ ·ã€‚</p><h3 id="æ‰‹åŠ¨æ„å»ºæµ‹è¯•"><a href="#æ‰‹åŠ¨æ„å»ºæµ‹è¯•" class="headerlink" title="æ‰‹åŠ¨æ„å»ºæµ‹è¯•"></a>æ‰‹åŠ¨æ„å»ºæµ‹è¯•</h3><p>ç™»å½•åˆ°æ„å»ºæœºå™¨ä¸Šï¼Œdocker build å®é™…å°±æ˜¯æŒ‰ç…§ Dockerfile æ¥ docker run å’Œ docker commit çš„ç»“åˆï¼Œæ‰¾åˆ°å¤±è´¥çš„ run çš„é•œåƒ idï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a</span></span><br><span class="line">b7c4be99d86d   ba54b82c5b1c                                                        &quot;/bin/sh -c &#x27;IN_DOCKâ€¦&quot;   4 hours ago    Exited (1) 1 hours ago              nervous_chandrasekhar</span><br></pre></td></tr></table></figure><p>ç”¨ä¸Šé¢çš„é•œåƒ ID å’Œ command æ‰‹åŠ¨æµ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --<span class="built_in">rm</span> -ti --entrypoint bash ba54b82c5b1c</span></span><br><span class="line">root@a9114c46d496:/go/src/xxx.xxxgitlab.net/xxxxx/# IN_DOCKER=1 bash ./build.sh</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ä¾æ—§ï¼Œ<code>GOPRIVATE</code> <code>GONOPROXY</code> å•¥çš„éƒ½é…ç½®äº†çš„ï¼Œä»¥åŠ ssh ç›¸å…³ <code>git config --global url.&quot;git@xxx.xxxgitlab.net:&quot;.insteadof &quot;https://xxx.xxxgitlab.net/&quot;</code>éƒ½æ˜¯ä»¥åŠé…ç½®äº†æ²¡é—®é¢˜çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.gitconfig</span></span><br><span class="line">[url &quot;git@xxx.xxxgitlab.net:&quot;]</span><br><span class="line">insteadof = https://xxx.xxxgitlab.net/</span><br></pre></td></tr></table></figure><p>ç”¨ git æµ‹è¯•ä¹Ÿæ²¡é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -T git@xxx.xxxgitlab.net</span></span><br><span class="line">Welcome to GitLab, @xxxx_reporter!</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> xxx.xxxgitlab.net/x/xx/xxx</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ go çš„ help ï¼Œå‘ç° <code>go mod</code> æ²¡æœ‰ debug level ç›¸å…³ cmdlineï¼Œä½†æ˜¯ <code>go get</code> æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go get -x  xxx.xxxgitlab.net/x/xx/xxx</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx/xxx?go-get=1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx/xxx?go-get=1: 200 OK (0.063s)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/docmxini/xx?go-get=1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx?go-get=1: 200 OK (0.016s)</span></span><br><span class="line">mkdir -p /go/pkg/mod/cache/vcs # git3 https://xxx.xxxgitlab.net/x/xx.git</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lock /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c.lock</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c <span class="keyword">for</span> git3 https://xxx.xxxgitlab.net/x/fx.git</span></span><br><span class="line">cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git -c log.showsignature=false log --no-decorate -n1 &#x27;--format=format:%H %ct %D&#x27; 4855369c0f1e --</span><br><span class="line">0.002s # cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git -c log.showsignature=false log --no-decorate -n1 &#x27;--format=format:%H %ct %D&#x27; 4855369c0f1e --</span><br><span class="line">cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git ls-remote -q origin</span><br><span class="line">0.232s # cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git ls-remote -q origin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx.git</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx.git: 200 OK (0.076s)</span></span><br><span class="line">cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git tag -l</span><br><span class="line">0.002s # cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git tag -l</span><br><span class="line">go: xxx.xxxgitlab.net/x/xx/xxx@v1.6.5-rc.7.0.20250609085545-4855369c0f1e: invalid version: git ls-remote -q origin in /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c: exit status 128:</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">remote: The project you were looking for could not be found or you don&#x27;t have permission to view it.</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æœ€åçš„å‘½ä»¤æŠ¥é”™ï¼Œcd è¿›å»æ‰§è¡Œä¸‹çœ‹çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git ls-remote</span></span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">remote: The project you were looking for could not be found or you don&#x27;t have permission to view it.</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><p>å…¶å®å‰é¢çš„ <code>go get -x</code> é‡Œå°±æœ‰é—®é¢˜è¯¦ç»†ä¿¡æ¯äº†ï¼Œè¿™é‡Œæˆ‘æ˜¯çœ‹ç›®å½•ä¸‹æ–‡ä»¶å‘ç°çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -al</span></span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x  7 root root  119 Jun 17 03:53 .</span><br><span class="line">drwxr-xr-x 20 root root 8192 Jun 17 03:53 ..</span><br><span class="line">-rw-r--r--  1 root root   23 Jun 17 03:53 HEAD</span><br><span class="line">drwxr-xr-x  2 root root    6 Jun 17 03:53 branches</span><br><span class="line">-rw-r--r--  1 root root  179 Jun 17 03:53 config</span><br><span class="line">-rw-r--r--  1 root root   73 Jun 17 03:53 description</span><br><span class="line">drwxr-xr-x  2 root root 4096 Jun 17 03:53 hooks</span><br><span class="line">drwxr-xr-x  2 root root   21 Jun 17 03:53 info</span><br><span class="line">drwxr-xr-x  4 root root   30 Jun 17 03:53 objects</span><br><span class="line">drwxr-xr-x  4 root root   31 Jun 17 03:53 refs</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> config</span></span><br><span class="line">[core]</span><br><span class="line">repositoryformatversion = 0</span><br><span class="line">filemode = true</span><br><span class="line">bare = true</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">url = https://xxx.xxxgitlab.net/x/xx.git</span><br><span class="line">fetch = +refs/heads/*:refs/remotes/origin/*</span><br></pre></td></tr></table></figure><p>ä»“åº“åœ°å€ä¸å¯¹ï¼Œæ”¹æˆ <code>url = https://xxx.xxxgitlab.net/x/xx/xxx.git</code> åå°±å¯ä»¥äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git ls-remote | <span class="built_in">head</span></span></span><br><span class="line">From git@xxx.xxxgitlab.net:x/xx/xxx.git</span><br><span class="line">74f35a28ecc0f9721a49c41fb5d7bffa071d1502HEAD</span><br><span class="line">295c3a79dfc0d27022459d0cec21411031edd5e8refs/heads/0xxx</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="gitlab-subgroup"><a href="#gitlab-subgroup" class="headerlink" title="gitlab subgroup"></a>gitlab subgroup</h3><p>æœäº†ä¸‹ï¼Œå‘ç°æ˜¯ gitlab çš„é‰´æƒå’Œ golang çš„ get é€»è¾‘å†²çªï¼ŒåŒæ–¹éƒ½è®¤ä¸ºå¯¹æ–¹ä¸è§„èŒƒï¼Œè°éƒ½ä¸è®©è°ï¼Œå…·ä½“è§æ–‡ç« :</p><ul><li><a href="https://mp.weixin.qq.com/s/D_AsV9QpOZ_5v8f1eKoxjQ">Go æ¨¡å—ä½¿ç”¨ GitLab subgroups çš„é—®é¢˜</a></li><li><a href="https://docs.gitlab.com/ee/user/project/use_project_as_go_package.html#authenticate-go-requests-to-private-projects">use_project_as_go_package</a></li><li><a href="https://go.dev/ref/mod#private-module-proxy-auth">private-module-proxy-auth</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/437005">Allow to set a go-modules folder for private Go projects</a></li></ul><p>è§£å†³æ–¹æ¡ˆåªæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ <code>~/.netrc</code> ä½†æ˜¯æ˜¯æ˜æ–‡å¯†ç ï¼Œä¸é€‚ç”¨äº CI&#x2F;CD æ„å»ºã€‚<br>ä½¿ç”¨ replace çš„è¯éœ€è¦æŒ‡å®šä¸€æ ·çš„ç‰ˆæœ¬ï¼Œè€Œ <code>go get</code> å‡çº§ä¾èµ–çš„æ—¶å€™ replace ä¸ä¼šåŠ¨ã€‚<br>å†™ shell åœ¨ <code>go build</code> å‰æ‰§è¡Œçš„è¯ï¼Œæ€•æ­£åˆ™è¾¹ç•Œå’Œæ¨¡ç³ŠåŒ¹é…åˆ°äº†å‰ç¼€ä¸€æ ·çš„ï¼Œå¹¶ä¸” <code>go mod edit -json</code> å¯ä»¥è¾“å‡º json ä¿¡æ¯ï¼Œå¥½åœ¨ golang ç¼–è¯‘é•œåƒæ˜¯ ubuntuï¼Œå†…éƒ¨æœ‰ pythonã€‚</p><h3 id="è„šæœ¬è§£å†³"><a href="#è„šæœ¬è§£å†³" class="headerlink" title="è„šæœ¬è§£å†³"></a>è„šæœ¬è§£å†³</h3><p>èŠ±äº†ç‚¹æ—¶é—´å†™äº†å¦‚ä¸‹ python è„šæœ¬ï¼Œæ‰§è¡Œæ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">go mod edit -json | python3 scripts/golang-subgroup.py \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æˆ–è€…</span></span><br><span class="line">go mod edit -json &gt; go.mod.json</span><br><span class="line">python3 scripts/golang-subgroup.py \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx2</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;è§£å†³ go.mod é‡Œçš„ gitlab subgroups é—®é¢˜&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--repo&#x27;</span>, action=<span class="string">&#x27;append&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;è¦å¤„ç†çš„ä»“åº“åå­—ï¼Œä¾‹å¦‚: xx.gitlab.cn/a/b/c&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--mod&#x27;</span>, default=<span class="string">&quot;./go.mod&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;go.mod path&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">replace_repo</span>(<span class="params">repo_list, mod_json, mod_path</span>):</span><br><span class="line">    <span class="keyword">if</span> mod_json[<span class="string">&#x27;Replace&#x27;</span>]:</span><br><span class="line">        mod_replace_list = [ i[<span class="string">&#x27;Old&#x27;</span>][<span class="string">&#x27;Path&#x27;</span>] <span class="keyword">for</span> i <span class="keyword">in</span> mod_json[<span class="string">&#x27;Replace&#x27;</span>]]</span><br><span class="line">        repo_list = [repo <span class="keyword">for</span> repo <span class="keyword">in</span> repo_list <span class="keyword">if</span> repo <span class="keyword">not</span> <span class="keyword">in</span> mod_replace_list]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(repo_list) == <span class="number">0</span>:</span><br><span class="line">            logging.info(<span class="string">&quot;å·²ç»å…¨éƒ¨æ›¿æ¢&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    replace_list = [ i <span class="keyword">for</span> i <span class="keyword">in</span> mod_json[<span class="string">&#x27;Require&#x27;</span>] <span class="keyword">if</span> i[<span class="string">&#x27;Path&#x27;</span>] <span class="keyword">in</span> repo_list <span class="keyword">and</span> (<span class="keyword">not</span> i.get(<span class="string">&#x27;Indirect&#x27;</span>, <span class="literal">False</span>))]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(replace_list) == <span class="number">0</span>:</span><br><span class="line">        logging.error(<span class="string">&quot;æœªæ‰¾åˆ°éœ€è¦æ›¿æ¢çš„ä»“åº“: %s&quot;</span>, <span class="string">&#x27;,&#x27;</span>.join(repo_list))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(mod_path, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> replace_list:</span><br><span class="line">            replace_str = <span class="string">&quot;replace &#123;0&#125; =&gt; &#123;0&#125;.git &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(item[<span class="string">&#x27;Path&#x27;</span>], item[<span class="string">&#x27;Version&#x27;</span>])</span><br><span class="line">            logging.info(<span class="string">&quot;æ·»åŠ  %s&quot;</span>, replace_str)</span><br><span class="line">            f.writelines(replace_str+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">    args = parse_args()</span><br><span class="line">    <span class="keyword">if</span> args.repo <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(args.repo) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    mod_json = &#123;&#125;</span><br><span class="line">    mod_json_path = <span class="string">&quot;go.mod.json&quot;</span></span><br><span class="line">    <span class="keyword">if</span> os.isatty(<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(mod_json_path):</span><br><span class="line">            logging.error(<span class="string">&quot;è¯·ä»¥ go mod edit -json | python3 %s è¿è¡Œ&quot;</span>, __file__)</span><br><span class="line">            os._exit(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(mod_json_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            mod_json = json.load(file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        mod_json = json.loads(sys.stdin.read())</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> <span class="built_in">isinstance</span>(mod_json, <span class="built_in">dict</span>)) <span class="keyword">or</span> mod_json.get(<span class="string">&quot;Module&quot;</span>, <span class="string">&quot;&quot;</span>) == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        logging.error(<span class="string">&quot;è¯·ä»¥ go mod edit -json | python3 %s è¿è¡Œ&quot;</span>, __file__)</span><br><span class="line">        os._exit(<span class="number">2</span>)</span><br><span class="line">    replace_repo(args.repo, mod_json, args.mod)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ subgroup é—®é¢˜â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="http://zhangguanzhang.github.io/tags/golang/"/>
    
    <category term="gitlab" scheme="http://zhangguanzhang.github.io/tags/gitlab/"/>
    
    <category term="subgroup" scheme="http://zhangguanzhang.github.io/tags/subgroup/"/>
    
  </entry>
  
  <entry>
    <title>å°ç™½å‘çš„ kubernetes è¯ä¹¦è®²è§£</title>
    <link href="http://zhangguanzhang.github.io/2025/06/02/kubernetes-cert/"/>
    <id>http://zhangguanzhang.github.io/2025/06/02/kubernetes-cert/</id>
    <published>2025-06-02T20:40:30.000Z</published>
    <updated>2025-06-02T20:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åŒäº‹é‡åˆ°å‡ èµ·è¯ä¹¦ç›¸å…³é—®é¢˜ï¼Œä»å°ç™½è§’åº¦æ¥å†™ä¸‹ k8s è¯ä¹¦â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å¾ˆå¤šäººå¯¹  k8s è¯ä¹¦å’Œ kubeconfig æœ›è€Œå´æ­¥ï¼Œè¯ä¹¦è¿‡æœŸå’Œç›¸å…³æŠ¥é”™å°±æ— ä»ä¸‹æ‰‹ï¼Œå¸‚é¢ä¸Šæœ‰å†™è¯ä¹¦çš„æ–‡ç« åšå®¢ï¼Œä½†æ˜¯æ„Ÿè§‰å¾ˆé•¿çš„ç†è®ºä¼šè®©å¾ˆå¤šäººçœ‹ä¸ä¸‹å»ï¼Œå®é™…æ›´éœ€è¦çš„æ˜¯è§£å†³é—®é¢˜æ—¶å€™çš„å…·ä½“æ­¥éª¤å’Œæ–¹å‘ã€‚</p><h2 id="ç†è®ºéƒ¨åˆ†"><a href="#ç†è®ºéƒ¨åˆ†" class="headerlink" title="ç†è®ºéƒ¨åˆ†"></a>ç†è®ºéƒ¨åˆ†</h2><p>ç®€å•è®²è§£è¯ä¹¦ç†è®ºéƒ¨åˆ†ã€‚</p><h3 id="åŒå‘-SSL"><a href="#åŒå‘-SSL" class="headerlink" title="åŒå‘ SSL"></a>åŒå‘ SSL</h3><p>è®¿é—®ä¸€ä¸ª https ç½‘ç«™ï¼Œéœ€è¦ç›®æ ‡ web server é…ç½®æœ‰ ssl è¯ä¹¦ï¼Œè€Œè¯ä¹¦æ¥æºä¸¤ç§ï¼š</p><ol><li>CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰ä½¿ç”¨ç§é’¥ç­¾ç½²å‡º æ ¹ CA è¯ä¹¦ï¼ˆå…¬é’¥ï¼‰ï¼Œæµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿå†…ç½®è¿™äº› æ ¹ CA è¯ä¹¦ï¼Œ åªæœ‰ CA æœºæ„ç­¾ç½²çš„è¯ä¹¦æ‰ä¼šæ˜¯ç»¿é”ã€‚</li><li>ä½¿ç”¨è¯ä¹¦å·¥å…·æˆ–è€…éµå®ˆè¯ä¹¦è§„èŒƒçš„åº“ç”Ÿæˆçš„ CA ç§é’¥è‡ªå·±ç­¾ç½²å‡ºçš„è¯ä¹¦ï¼Œæµè§ˆå™¨æ˜¾ç¤ºçº¢è‰²è­¦å‘Šï¼ˆè¿æ¥ä¸å®‰å…¨&#x2F;æ— æ•ˆè¯ä¹¦ï¼‰</li></ol><p>k8s é‡‡ç”¨çš„æ˜¯åŸºäº X.509 V3 æ ‡å‡†çš„åŒå‘ SSLï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡ï¼Œéƒ½ä¼šéªŒè¯åŒæ–¹è¯ä¹¦ï¼Œæ ¹æ®åŒæ–¹æ˜¯å¦æ˜¯ä¸€æ ·çš„ CA ç­¾ç½²çš„è¯ä¹¦ï¼Œè€Œ CA ç§é’¥æ˜¯è‡ªå·±ç”Ÿæˆçš„ï¼Œä½ å¯ä»¥çœ‹åˆ° k8s ç»„ä»¶çš„ cmdline éƒ½æœ‰æŒ‡å®šå‚æ•° <code>ca-file|cert-file</code> ç›¸å…³ã€‚</p><h3 id="è¯ä¹¦å»ºè®®ç›¸å…³"><a href="#è¯ä¹¦å»ºè®®ç›¸å…³" class="headerlink" title="è¯ä¹¦å»ºè®®ç›¸å…³"></a>è¯ä¹¦å»ºè®®ç›¸å…³</h3><h4 id="æ—¶é—´"><a href="#æ—¶é—´" class="headerlink" title="æ—¶é—´"></a>æ—¶é—´</h4><p>æ— è®ºæ˜¯ openssl è¿˜æ˜¯ cfsslï¼Œæ¨èéƒ½æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®é«˜ä¸€äº›ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -x509 ... -days 10000</span><br><span class="line">$ cat ca-config.json</span><br><span class="line">...</span><br><span class="line">  &quot;expiry&quot;: &quot;876000h&quot;</span><br></pre></td></tr></table></figure><p>è€Œå¯¹äº kubeadmï¼Œç½‘ä¸Šæœ‰ä¿®æ”¹ç¼–è¯‘çš„ï¼Œæˆ–è€… go build çš„æ—¶å€™æ³¨å…¥è¦†ç›–é»˜è®¤çš„æ—¶é—´çš„ï¼Œè‡ªè¡Œæœç´¢ã€‚</p><h4 id="certSAN"><a href="#certSAN" class="headerlink" title="certSAN"></a>certSAN</h4><p>k8s é‡Œ <code>kube-apiserver</code> å’Œ <code>etcd</code> éƒ½æ˜¯éƒ¨ç½²åœ¨å¤šä¸ªæœºå™¨ä¸Šå®ç°é«˜å¯ç”¨çš„ï¼Œåœ¨ <code>openssl/cfssl/kubeadm</code> é‡Œæ¨èåŠ  IP ä»¥å¤–è¿˜è¦åŠ åŸŸåä»¥é˜²åç»­æ¢ IP ç›¸å…³ï¼š</p><ul><li>openssl é…ç½®æ–‡ä»¶å‚è€ƒ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/roles/etcd/templates/openssl.conf.j2">kubernetes-sigs&#x2F;kubespray çš„ openssl.conf</a></li><li>cfssl ä½¿ç”¨çš„ json æ–‡ä»¶é‡Œçš„ <code>hosts</code> å­—æ®µ</li><li>kubeadm çš„ <code>certSANs</code> å­—æ®µ</li></ul><p>è¿™é‡Œä»¥ ipv4 ä¸‹ kubeadm çš„æŒ‡å®š yml åˆ›å»ºé›†ç¾¤æ¥ä¸¾ä¾‹ä¸€èˆ¬å†™é‚£äº›ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ cat initconfig.yaml</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - 10.96.0.1 # service cidrçš„ç¬¬ä¸€ä¸ªip</span><br><span class="line">  - 127.0.0.1 # å¤šä¸ªmasterçš„æ—¶å€™è´Ÿè½½å‡è¡¡å‡ºé—®é¢˜äº†èƒ½å¤Ÿå¿«é€Ÿä½¿ç”¨localhostè°ƒè¯•</span><br><span class="line">  - localhost</span><br><span class="line">  - apiserver.k8s.local # è´Ÿè½½å‡è¡¡çš„åŸŸåæˆ–è€…vip</span><br><span class="line">  - 172.19.0.2 # ä¸‰å° kube-apiserver çš„ IP</span><br><span class="line">  - 172.19.0.3</span><br><span class="line">  - 172.19.0.4</span><br><span class="line">  - apiserver01.k8s.local </span><br><span class="line">  - apiserver02.k8s.local</span><br><span class="line">  - apiserver03.k8s.local</span><br><span class="line">  - apiserver04.k8s.local # é¢„ç•™åŸŸå</span><br><span class="line">  - apiserver05.k8s.local</span><br><span class="line">  - master</span><br><span class="line">  - kubernetes</span><br><span class="line">  - kubernetes.default</span><br><span class="line">  - kubernetes.default.svc</span><br><span class="line">  - kubernetes.default.svc.cluster.local # é›†ç¾¤å†… dns search å’Œ clusterDomain</span><br><span class="line">...</span><br><span class="line">etcd: # https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#Etcd</span><br><span class="line">  local:</span><br><span class="line">    serverCertSANs:</span><br><span class="line">    - localhost</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">    - 172.19.0.2</span><br><span class="line">    - 172.19.0.3</span><br><span class="line">    - 172.19.0.4</span><br><span class="line">    - etcd01.k8s.local</span><br><span class="line">    - etcd02.k8s.local</span><br><span class="line">    - etcd03.k8s.local</span><br><span class="line">    - etcd04.k8s.local # é¢„ç•™åŸŸå</span><br><span class="line">    - etcd05.k8s.local</span><br><span class="line">    peerCertSANs:</span><br><span class="line">    - localhost</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">    - 172.19.0.2</span><br><span class="line">    - 172.19.0.3</span><br><span class="line">    - 172.19.0.4</span><br><span class="line">    - etcd01.k8s.local</span><br><span class="line">    - etcd02.k8s.local</span><br><span class="line">    - etcd03.k8s.local</span><br><span class="line">    - etcd04.k8s.local # é¢„ç•™åŸŸå</span><br><span class="line">    - etcd05.k8s.local</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åªåˆ—ä¸¾ IPv4 çš„ï¼Œå¦‚æœåç»­æœ‰åŒæ ˆå•¥çš„å¯ä»¥é¢„å…ˆå†™ä¸Šï¼Œå¦‚æœå†™æ¼äº†åŸŸåå’Œ IPï¼Œç®¡ç†ç»„ä»¶æˆ–è€… pod å†…é€šè¿‡ SDK è®¿é—® kube-apiserver çš„æ—¶å€™ä¼šæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unable to connect to the server: tls: failed to verify certificate: x509: certificate is valid for 10.96.0.1, yyyy, not xxxx</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯ä¹¦çš„ certSANs åªæœ‰ <code>10.96.0.1, yyyy</code> è€Œæ²¡æœ‰ <code>xxxx</code>ï¼Œå¯ä»¥ä½¿ç”¨åŸæœ‰ CA è¯ä¹¦ç­¾ç½²ä¸‹ã€‚å‘½ä»¤è¡ŒæŸ¥çœ‹è¯ä¹¦çš„ certSAN å¯ä»¥ä½¿ç”¨ openssl ï¼Œç¼–ç¨‹è¯­è¨€çš„è¯æ¨èå»ä½¿ç”¨åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸€èˆ¬ä¼šæŠŠè¯ä¹¦æ”¾åœ¨ /etc/kubernetes/pki æ‰¾ä¸åˆ°çš„æ‰¾ apiserver cmdline å‚æ•°è·¯å¾„</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -noout -text -<span class="keyword">in</span> apiserver.crt</span></span><br><span class="line">X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:localhost, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address: 172.19.0.2</span><br></pre></td></tr></table></figure><p>openssl ä¸Šé¢çš„è¾“å‡ºé‡Œå¾ˆå¤šä¿¡æ¯ï¼Œè¿˜åŒ…å«è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œè€Œä¸” openssl x509 ä¸‹å¾ˆå¤šé€‰é¡¹çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ©ç”¨ -certopt å’Œ -text é…åˆåªæ‰“å° certSANs</span></span><br><span class="line">openssl x509 -noout  -in apiserver.crt  -certopt no_subject,no_header,no_version,no_serial,no_signame,no_validity,no_issuer,no_pubkey,no_sigdump,no_aux -text</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åªæŸ¥çœ‹è¯ä¹¦æ—¶é—´</span></span><br><span class="line">openssl x509 -noout  -in apiserver.crt -dates</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åªå±•ç¤º subject</span></span><br><span class="line">openssl x509 -noout  -in apiserver.crt  -subject</span><br></pre></td></tr></table></figure><p>åªæœ‰åŒä¸€å¥— ca ç­¾ç½²è¯ä¹¦æ‰ç¬¦åˆè¦æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ openssl å‘½ä»¤æ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ apiserver.crt æ˜¯å¦æ˜¯ç”± ca.key ç­¾ç½²</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl verify -CAfile ca.crt apiserver.crt</span></span><br><span class="line">apiserver.crt: OK</span><br></pre></td></tr></table></figure><h3 id="k8s-role-å’Œ-RBAC"><a href="#k8s-role-å’Œ-RBAC" class="headerlink" title="k8s role å’Œ RBAC"></a>k8s role å’Œ RBAC</h3><p>åŒå‘ TLS è¿‡å»äº†ï¼Œä½†æ˜¯å…·ä½“æƒé™æ§åˆ¶ k8s æ€ä¹ˆåšçš„å‘¢ï¼Œå°±æ˜¯ X.509 è¯ä¹¦ç­¾ç½²ï¼ˆSubject å­—æ®µå†…ï¼‰çš„ <code>CN(Common Name)</code> ä¸ <code>O(Organization)</code> å­—æ®µï¼Œå¯¹åº” <code>User Name</code> å’Œ <code>Group</code>ï¼Œä¹Ÿå°±æ˜¯ k8s çš„ RBACï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get clusterrolebinding</span><br><span class="line">NAME                                                   ROLE                                                                               AGE</span><br><span class="line">cluster-admin                                          ClusterRole/cluster-admin                                                          81m</span><br><span class="line">kubeadm:get-nodes                                      ClusterRole/kubeadm:get-nodes                                                      81m</span><br><span class="line">kubeadm:kubelet-bootstrap                              ClusterRole/system:node-bootstrapper                                               81m</span><br><span class="line">kubeadm:node-autoapprove-bootstrap                     ClusterRole/system:certificates.k8s.io:certificatesigningrequests:nodeclient       81m</span><br><span class="line">kubeadm:node-autoapprove-certificate-rotation          ClusterRole/system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   81m</span><br><span class="line">kubeadm:node-proxier                                   ClusterRole/system:node-proxier                                                    81m</span><br><span class="line">...</span><br><span class="line">system:coredns                                         ClusterRole/system:coredns                                                         81m</span><br><span class="line">system:discovery                                       ClusterRole/system:discovery                                                       81m</span><br><span class="line">system:kube-controller-manager                         ClusterRole/system:kube-controller-manager                                         81m</span><br><span class="line">system:kube-dns                                        ClusterRole/system:kube-dns                                                        81m</span><br><span class="line">system:kube-scheduler                                  ClusterRole/system:kube-scheduler                                                  81m</span><br><span class="line">system:monitoring                                      ClusterRole/system:monitoring                                                      81m</span><br><span class="line">system:node                                            ClusterRole/system:node                                                            81m</span><br><span class="line">system:node-proxier                                    ClusterRole/system:node-proxier                                                    81m</span><br><span class="line">system:public-info-viewer                              ClusterRole/system:public-info-viewer                                              81m</span><br><span class="line">system:service-account-issuer-discovery                ClusterRole/system:service-account-issuer-discovery                                81m</span><br><span class="line">system:volume-scheduler                                ClusterRole/system:volume-scheduler                                                81m</span><br></pre></td></tr></table></figure><p>kube-apiserver å¯åŠ¨åä¼šåˆ›å»ºä¸Šé¢çš„ <code>clusterrolebinding</code>ï¼Œkubectl æœ¬è´¨å°±æ˜¯ä¸ª client + kubeconfig è®¿é—® <code>kube-apiserver</code> çš„ï¼ŒæŸ¥çœ‹ kubectl å½“å‰ä½¿ç”¨çš„ <code>kubeconfig</code> å¯ä»¥é€šè¿‡ k8s æ‰€æœ‰äºŒè¿›åˆ¶çš„ cmdline çš„ <code>-v</code> é€‰é¡¹ï¼Œä»è¯¦ç»†ä¿¡æ¯é‡Œè·å–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl config view -v=6</span></span><br><span class="line">I0604 10:40:46.836786   14513 loader.go:395] Config loaded from file:  /root/.kube/config</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä»ä¸Šé¢çœ‹åˆ°æ˜¯ <code>/root/.kube/config</code> ï¼Œä»¥ kubeadm çš„ä¸¾ä¾‹ï¼Œè¯¥æ–‡ä»¶å†…å®¹å†…æœ‰è¯ä¹¦å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /root/.kube/config</span><br><span class="line">certificate-authority-data  /etc/kubernetes/pki/ca.crt å†…å®¹ base64 åŠ å¯†åçš„å€¼</span><br><span class="line">client-certificate-data     /etc/kubernetes/pki/admin.crt å†…å®¹ base64 åŠ å¯†åçš„å€¼</span><br><span class="line">client-key-data             /etc/kubernetes/pki/admin.key å†…å®¹ base64 åŠ å¯†åçš„å€¼</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åé¢ä¿©å·²ç»å†…åµŒäº†ï¼Œæ‰€ä»¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰äº›äººè‡ªå»ºé›†ç¾¤ä¸Šé¢çš„åé¢å€¼æ˜¯è·¯å¾„ï¼Œæ˜¯å› ä¸º kubectl config ç”Ÿæˆ kubeconfig çš„æ—¶å€™æ²¡æŒ‡å®šé€‰é¡¹ <code>--embed-certs</code>ï¼Œå†…åµŒçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig /etc/kubernetes/admin.conf config set-credentials admin \</span><br><span class="line">        --client-certificate=/etc/kubernetes/pki/admin.crt \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --client-key=/etc/kubernetes/pki/admin.key&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">rm</span> -f /etc/kubernetes/pki/admin.???</span></span><br></pre></td></tr></table></figure><p>kubeadm golang ç›´æ¥æ²¡æœ‰è½åœ°æ–‡ä»¶ï¼Œç›´æ¥ç”Ÿæˆ yml å†…å®¹çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ‰£å‡ºè¯ä¹¦ä¿¡æ¯çœ‹çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> &lt;(kubectl config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d ) -noout -text</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> &lt;(kubectl config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d ) -noout  -subject</span></span><br><span class="line">subject= /O=system:masters/CN=kubernetes-admin</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>O=system:masters</code> ï¼Œå®é™…å¯¹åº” <code>clusterrolebinding cluster-admin</code> çš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get clusterrolebinding cluster-admin -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2025-06-03T07:36:44Z&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  resourceVersion: &quot;160&quot;</span><br><span class="line">  uid: d5638680-38de-4010-a2c9-084645a8ad21</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:masters</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ç»„ <code>system:masters</code> å…·å¤‡ clusterrole <code>cluster-admin</code> çš„æƒé™ã€‚</p><p>æœ¬å°ç»“å‚è€ƒï¼š</p><ul><li><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/">ä½¿ç”¨ RBAC é‰´æƒ</a></li><li><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/implementation-details/">kubeadm å®ç°ç»†èŠ‚</a></li></ul><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><p>è¯´å®Œç†è®ºéƒ¨åˆ†ï¼Œæ¥å®æˆ˜ä¸‹ï¼Œåˆ©ç”¨è¯ä¹¦çš„ <code>CN(Common Name)</code> ä¸ <code>O(Organization)</code> å­—æ®µæ¥åˆ›å»ºä¸¤ä¸ªæƒé™è¯ä¹¦æµ‹è¯•ä¸‹ï¼š</p><ul><li>ç”¨æˆ· test1 å…·å¤‡ default ns ä¸‹çš„ pod list æƒé™</li><li>ç»„ test2 å…·å¤‡æ‰€æœ‰ ns çš„ pod list æƒé™</li></ul><p>é¿å…è·¯å¾„ã€è¯ä¹¦åå­—å’Œåç¼€å’Œä¹ æƒ¯é—®é¢˜ï¼Œå®æˆ˜éƒ¨åˆ†ä»¥ cfssl åœ¨ kubeadm åˆå§‹åŒ–åçš„æ–‡ä»¶ç›®å½•å†…æ“ä½œã€‚</p><p>å¯¹è¯ä¹¦åšæ“ä½œä¹‹å‰è¦æœ‰å¤‡ä»½ä¹ æƒ¯ï¼Œæ— è®ºè¯ä¹¦æŸåè¿˜æ˜¯è¿‡æœŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes</span><br><span class="line">cp -a pki pki.bak</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºè¯ä¹¦"><a href="#åˆ›å»ºè¯ä¹¦" class="headerlink" title="åˆ›å»ºè¯ä¹¦"></a>åˆ›å»ºè¯ä¹¦</h3><p>åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># åˆ›å»º ca ç­¾ç½²è¯ä¹¦ç­¾åé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºè¯¥è¯ä¹¦æ˜¯åª client ä½¿ç”¨ï¼Œä¸éœ€è¦åœ¨ usages é‡Œå¸¦ &quot;server auth&quot;</span><br><span class="line"># å¦‚æœæ‰€æœ‰è¯ä¹¦æ‰‹åŠ¨ç”Ÿæˆæ—¶å€™ç”¨åŒä¸€ä¸ª ca-config.json å¯ä»¥å·æ‡’å¸¦ä¸Š &quot;server auth&quot;</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># cn å¯¹åº” user o å¯¹åº” group</span><br><span class="line">cat &gt; test1-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;O&quot;: &quot;test1&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç­¾ç½²è¯ä¹¦ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">        -ca=ca.crt \</span><br><span class="line">        -ca-key=ca.key \</span><br><span class="line">        -config=ca-config.json \</span><br><span class="line">        -profile=kubernetes test1-csr.json | cfssljson -bare test1</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è¯ä¹¦æƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é¿å… kubeconfig å¹²æ‰°ï¼Œæ”¹åä¸‹å®¶ç›®å½•æ–‡ä»¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config ~/.kube/config.bak</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">KUBECONFIG= kubectl --server=https://xxx:6443 \</span></span><br><span class="line"><span class="language-bash">  --certificate-authority=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="language-bash">  --client-certificate=/etc/kubernetes/pki/test1.pem \</span></span><br><span class="line"><span class="language-bash">  --client-key=/etc/kubernetes/pki/test1-key.pem get pod</span></span><br><span class="line">Error from server (Forbidden): pods is forbidden: User &quot;test1&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure><p>kube-apiserver æœ¬è´¨æ˜¯ http&#x2F;grpc serverï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ curl æµ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X GET \</span></span><br><span class="line"><span class="language-bash">  --cacert /etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="language-bash">  --cert /etc/kubernetes/pki/test1.pem \</span></span><br><span class="line"><span class="language-bash">  --key /etc/kubernetes/pki/test1-key.pem \</span></span><br><span class="line"><span class="language-bash">  -H <span class="string">&quot;Accept: application/json&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  <span class="string">&quot;https://xxx:6443/api/v1/namespaces/default/pods?limit=500&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;&#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;pods is forbidden: User \&quot;test1\&quot; cannot list resource \&quot;pods\&quot; in API group \&quot;\&quot; in the namespace \&quot;default\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;kind&quot;: &quot;pods&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åˆ›å»º <code>test1</code> çš„ <code>RBAC</code> ï¼Œä¹Ÿå°±æ˜¯ <code>rolebinding</code>ï¼Œåˆ›å»ºä¸‹åå†è¯•è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config.bak ~/.kube/config</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; test1-rbac.yml &lt;&lt; <span class="string">EOF</span></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: test1-role</span><br><span class="line">  namespace: default</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: test1-rolebinding</span><br><span class="line">  namespace: default</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: test1-role</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: test1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">kubectl apply -f test1-rbac.yml</span></span></span><br></pre></td></tr></table></figure><p>ç„¶åå†æµ‹è¯•ï¼Œå¯ä»¥åˆ—å‡º default ä¸‹çš„ pod è€Œä¸èƒ½åˆ—å‡º svcï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config ~/.kube/config.bak</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">KUBECONFIG= kubectl --server=https://xxx:6443 \</span></span><br><span class="line"><span class="language-bash">  --certificate-authority=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="language-bash">  --client-certificate=/etc/kubernetes/pki/test1.pem \</span></span><br><span class="line"><span class="language-bash">  --client-key=/etc/kubernetes/pki/test1-key.pem get pod</span></span><br><span class="line">No resources found in default namespace.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">KUBECONFIG= kubectl --server=https://xxx:6443   --certificate-authority=/etc/kubernetes/pki/ca.crt   --client-certificate=/etc/kubernetes/pki/test1.pem   --client-key=/etc/kubernetes/pki/test1-key.pem get svc</span></span><br><span class="line">Error from server (Forbidden): services is forbidden: User &quot;test1&quot; cannot list resource &quot;services&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure><p>åŒæ ·ä½¿ç”¨ curl æµ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X GET  \</span></span><br><span class="line"><span class="language-bash">  --cacert /etc/kubernetes/pki/ca.crt  \</span></span><br><span class="line"><span class="language-bash">  --cert /etc/kubernetes/pki/test1.pem  \</span></span><br><span class="line"><span class="language-bash">  --key /etc/kubernetes/pki/test1-key.pem  \</span></span><br><span class="line"><span class="language-bash">   -H <span class="string">&quot;Accept: application/json&quot;</span>   <span class="string">&quot;https://10.xxx.xx.xxx:6443/api/v1/namespaces/default/pods?limit=500&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;PodList&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line">    &quot;resourceVersion&quot;: &quot;107116&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;items&quot;: []</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X GET  \</span></span><br><span class="line"><span class="language-bash">  --cacert /etc/kubernetes/pki/ca.crt  \</span></span><br><span class="line"><span class="language-bash">  --cert /etc/kubernetes/pki/test1.pem  \</span></span><br><span class="line"><span class="language-bash">  --key /etc/kubernetes/pki/test1-key.pem  \</span></span><br><span class="line"><span class="language-bash">   -H <span class="string">&quot;Accept: application/json&quot;</span>   <span class="string">&quot;https://10.xxx.xx.xxx:6443/api/v1/namespaces/default/services?limit=500&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;&#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;services is forbidden: User \&quot;test1\&quot; cannot list resource \&quot;services\&quot; in API group \&quot;\&quot; in the namespace \&quot;default\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;kind&quot;: &quot;services&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯ä¹¦æƒé™ç¬¦åˆé¢„æœŸï¼Œkubeconfig é‡Œå¯ä»¥åŒ…å«å¤šä¸ªé…ç½®æ®µçš„ï¼Œå‰é¢çš„è¯ä¹¦ç”Ÿæˆ kubeconfig å¯ä»¥ä½¿ç”¨ kubectl ï¼ŒæŒ‰ç…§ä¸‹é¢æ­¥éª¤ç”Ÿæˆå¯¹åº”é…ç½®æ®µï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®é›†ç¾¤å‚æ•°ï¼ŒæŒ‡å®šCAè¯ä¹¦å’Œapiserveråœ°å€</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config set-cluster kubernetes \</span><br><span class="line">    --certificate-authority=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --server=https://xxx:6443</span><br><span class="line">        </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼ŒæŒ‡å®šä½¿ç”¨è¯ä¹¦å’Œç§é’¥</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config set-credentials test1 \</span><br><span class="line">    --client-certificate=test1.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --client-key=test1-key.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿½åŠ ä¸€ä¸ªåä¸º kubernetes çš„ä¸Šä¸‹æ–‡å‚æ•°ï¼ŒæŒ‡å®šå®ƒä½¿ç”¨å‰é¢æ·»åŠ çš„ é›†ç¾¤ kubernetes å’Œåä¸º test1 çš„å‡­æ®</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config set-context kubernetes \</span><br><span class="line">    --cluster=kubernetes --user=test1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€‰æ‹©é»˜è®¤çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config use-context kubernetes</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨è¯¥ kubeconfig æµ‹è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zgz pki]# kubectl --kubeconfig=test1.kubeconfig get pod</span><br><span class="line">No resources found in default namespace.</span><br><span class="line">[root@zgz pki]# kubectl --kubeconfig=test1.kubeconfig get svc</span><br><span class="line">Error from server (Forbidden): services is forbidden: User &quot;test1&quot; cannot list resource &quot;services&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure><p>group test2 ä¸€æ ·æ“ä½œï¼Œå°±æ˜¯æ³¨æ„ <code>O</code> å­—æ®µå³å¯ï¼Œç„¶åæ˜¯ <code>clusterrole</code> å’Œ <code>clusterrolebinding</code> ï¼Œè‡ªè¡ŒæŒ‘æˆ˜ä¸‹ã€‚</p><h3 id="kube-apiserver-çš„-certSAN"><a href="#kube-apiserver-çš„-certSAN" class="headerlink" title="kube-apiserver çš„ certSAN"></a>kube-apiserver çš„ certSAN</h3><p>æ­¤éƒ¨åˆ†è§£å†³ kube-apiserver çš„è¯ä¹¦ï¼ˆè¿‡æœŸä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥ï¼‰ï¼Œä¾‹å¦‚å¾ˆå¤šäºº kubeadm åˆå§‹åŒ–åï¼ŒcertSAN ç¼ºå°‘ hosts æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ echo &#x27;127.0.0.1 santest&#x27; &gt;&gt; /etc/hosts</span><br><span class="line">$ kubectl --server https://santest:6443 get pod</span><br><span class="line">...</span><br><span class="line">Unable to connect to the server: tls: </span><br><span class="line">    failed to verify certificate: x509: </span><br><span class="line">    certificate is valid for kubernetes, kubernetes.default, kubernetes.default.svc, kubernetes.default.svc.cluster.local, node, not santest</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¯ä»¥ç”¨ ca ç­¾ç½²æ–°è¯ä¹¦æ¥åŒ…å« santest ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># åˆ›å»º ca ç­¾ç½²è¯ä¹¦ç­¾åé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºè¯¥è¯ä¹¦æ˜¯åª server ä½¿ç”¨ï¼Œä¸éœ€è¦åœ¨ usages é‡Œå¸¦ &quot;client auth&quot;</span><br><span class="line"># å¦‚æœæ‰€æœ‰è¯ä¹¦æ‰‹åŠ¨ç”Ÿæˆæ—¶å€™ç”¨åŒä¸€ä¸ª ca-config.json å¯ä»¥å·æ‡’å¸¦ä¸Š &quot;client auth&quot;</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹ç°æœ‰ certSAN</span><br><span class="line">openssl x509 -noout  -in apiserver.crt  -certopt no_subject,no_header,no_version,no_serial,no_signame,no_validity,no_issuer,no_pubkey,no_sigdump,no_aux -text</span><br><span class="line"></span><br><span class="line"># æŠŠä¸Šé¢è€çš„å’Œè¦æ·»åŠ çš„ å†™åˆ°æ–‡ä»¶é‡Œ</span><br><span class="line">cat &gt; kubernetes-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;::1&quot;,</span><br><span class="line">    &quot;localhost&quot;,</span><br><span class="line">    &quot;santest&quot;</span><br><span class="line">    &quot;10.xx&quot;,</span><br><span class="line">    &quot;10.96.0.1&quot;,</span><br><span class="line">    &quot;kubernetes&quot;,</span><br><span class="line">    &quot;kubernetes.default&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># ç­¾ç½²è¯ä¹¦</span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">        -ca=ca.crt \</span><br><span class="line">        -ca-key=ca.key \</span><br><span class="line">        -config=ca-config.json \</span><br><span class="line">        -profile=kubernetes kubernetes-csr.json | cfssljson -bare apiserver2</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ kube-apiserver çš„ cmdline ä½¿ç”¨ <code>apiserver2.pem</code> å’Œ <code>apiserver2-key.pem</code> :</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /etc/kubernetes/manifests/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -E <span class="string">&#x27;apiserver.(crt|key)&#x27;</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line">    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sed -ri -e <span class="string">&#x27;s#/apiserver.crt#/apiserver2.pem#&#x27;</span> -e <span class="string">&#x27;s#/apiserver.key#/apiserver2-key.pem#&#x27;</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -E -- <span class="string">&#x27;--tls-(cert|private)&#x27;</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line">    - --tls-cert-file=/etc/kubernetes/pki/apiserver2.pem</span><br><span class="line">    - --tls-private-key-file=/etc/kubernetes/pki/apiserver2-key.pem</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ä¸Šé¢çš„ santest åŸŸåæµ‹è¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl --server https://santest:6443 get pod</span><br><span class="line">No resources found in default namespace.</span><br><span class="line">$ kubectl --server https://santest:6443 get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   1h</span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ¡ˆä¾‹"><a href="#æ•…éšœæ¡ˆä¾‹" class="headerlink" title="æ•…éšœæ¡ˆä¾‹"></a>æ•…éšœæ¡ˆä¾‹</h2><h3 id="kubectl-è¯ä¹¦è¿‡æœŸ"><a href="#kubectl-è¯ä¹¦è¿‡æœŸ" class="headerlink" title="kubectl è¯ä¹¦è¿‡æœŸ"></a>kubectl è¯ä¹¦è¿‡æœŸ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f /tmp/test-svc.yml</span></span><br><span class="line">... x509: certificate has exprired or is not yet valid: current time 2025-05-20T23:25:51+08:00 is after 2025-01-16T02:16:34Z</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ kubeconfig å†…åµŒçš„è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> &lt;(kubectl config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d ) -noout -enddate</span></span><br><span class="line">notAfter=Jan 16 02:16:34 2025 GMT</span><br></pre></td></tr></table></figure><p>è€Œ <code>admin.pem</code> çœ‹ç°åœºé‡æ–°ç­¾ç½²äº†ä¸‹ï¼Œæ—¶é—´æ²¡è¿‡æœŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> admin.pem -noout -dates</span></span><br><span class="line">notBefore=Jan 17 03:05:00 2024 GMT</span><br><span class="line">notAfter=Dec 24 03:05:00 2123 GMT</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å†…åµŒä¸‹è¯ä¹¦ç”Ÿæˆæ–°çš„ kubeconfig å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æˆ‘ä»¬è¯ä¹¦åç¼€å’Œæ–‡ä»¶è·¯å¾„ä¸ä¸€æ ·ï¼Œä¸è¦ç…§æŠ„ï¼Œ<span class="built_in">env</span> å’Œå‘½ä»¤è¡ŒæŒ‡å®šç”Ÿæˆçš„ kubeconfig å‡ä¸€æ ·</span></span><br><span class="line">cd /etc/kubernetes/cluster1/ssl</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">        kubectl config set-cluster kubernetes \</span><br><span class="line">        --certificate-authority=ca.pem \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --server=https://127.0.0.1:8443</span><br><span class="line">        </span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">        kubectl config set-credentials admin \</span><br><span class="line">        --client-certificate=admin.pem \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --client-key=admin-key.pem</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">        kubectl config set-context kubernetes \</span><br><span class="line">        --cluster=kubernetes --user=admin</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">         kubectl config use-context kubernetes</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 kubectl get node</span><br></pre></td></tr></table></figure><h3 id="deploy-çš„-rs-åˆ›å»ºæŠ¥é”™è¿‡æœŸ"><a href="#deploy-çš„-rs-åˆ›å»ºæŠ¥é”™è¿‡æœŸ" class="headerlink" title="deploy çš„ rs åˆ›å»ºæŠ¥é”™è¿‡æœŸ"></a>deploy çš„ rs åˆ›å»ºæŠ¥é”™è¿‡æœŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n default describe deploy deployment-example</span><br><span class="line">Name:                   deployment-example</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Fri, 30 May 2025 15:45:03 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            &lt;none&gt;</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               2 desired | 0 updated | 0 total | 0 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:1.19-alpine</span><br><span class="line">    Port:         12343/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Progressing    False   ReplicaSetCreateError</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                 Age                From                   Message</span><br><span class="line">  ----     ------                 ----               ----                   -------</span><br><span class="line">  Warning  ReplicaSetCreateError  21s (x7 over 21s)  deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:13+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  20s (x2 over 20s)  deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:14+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  18s                deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:16+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  16s                deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:18+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  11s                deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:23+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  0s                 deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:34+08:00 is after 2024-08-28T14:45:36Z</span><br></pre></td></tr></table></figure><p>è¿™å¥—ç¯å¢ƒæ˜¯äºŒè¿›åˆ¶éƒ¨ç½²ï¼ŒReplicaSet æ˜¯ <code>kube-controller-manager</code> åˆ›å»ºçš„ï¼Œè¯¥æŠ¥é”™éœ€è¦çœ‹ kube-controller-manager æ—¥å¿—ï¼Œç„¶å k8s çš„ç®¡ç†ç»„ä»¶æ˜¯é€šè¿‡ lease å¯¹è±¡ä¿è¯åªæœ‰ä¸€ä¸ªçœŸæ­£å¤„ç†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl -n kube-system get lease</span></span><br><span class="line">NAME                      HOLDER                                                                     AGE</span><br><span class="line">kube-controller-manager   ubuntu-Standard-PC-i440FX-PIIX-1996_296a57fb-a219-4301-a0a6-62c3cd09e0f2   639d</span><br><span class="line">kube-scheduler            ubuntu-Standard-PC-i440FX-PIIX-1996_edd2caff-d647-4633-8bd5-2d9788986e1f   639d</span><br></pre></td></tr></table></figure><p>holder çš„åå­—ç”Ÿæˆè§„åˆ™å¦‚ä¸‹</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/kubernetes/kubernetes/blob/v1.29.5/cmd/kube-controller-manager/app/controllermanager.go#L256-L286</span></span><br><span class="line">id, err := os.Hostname()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add a uniquifier so that two processes on the same host don&#x27;t accidentally both become active</span></span><br><span class="line">id = id + <span class="string">&quot;_&quot;</span> + <span class="type">string</span>(uuid.NewUUID())</span><br></pre></td></tr></table></figure><p>å‘ç°æ¯å°æœºå™¨çš„ hostname ä¸€æ ·çš„ï¼Œå®Œå…¨ä¸çŸ¥é“å½“å‰æŒæœ‰ lease çš„ <code>kube-controller-manager</code> æ˜¯å“ªå°ï¼Œç®—äº†ï¼Œæ¯ä¸ªå»çœ‹æ—¥å¿—å§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xe --no-pager -u kube-controller-manager.service</span> </span><br><span class="line">-- Logs begin at Fri 2025-05-09 14:24:19 CST, end at Fri 2025-05-30 22:21:03 CST. --</span><br><span class="line">May 22 00:01:48 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[53418]: E0522 00:01:48.204891   53418 leaderelection.go:325] error retrieving resource lock kube-system/kube-controller-manager: etcdserver: leader changed</span><br><span class="line"></span><br><span class="line">May 30 22:08:57 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[22314]: E0530 22:08:57.593721   22314 deployment_controller.go:495] Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:08:57+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">May 30 22:08:57 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[22314]: I0530 22:08:57.593752   22314 deployment_controller.go:496] Dropping deployment &quot;default/deployment-example&quot; out of the queue: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:08:57+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">May 30 22:08:57 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[22314]: I0530 22:08:57.593824   22314 event.go:291] &quot;Event occurred&quot; object=&quot;default/deployment-example&quot; kind=&quot;Deployment&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Warning&quot; reason=&quot;ReplicaSetCreateError&quot; message=&quot;Failed to create new replica set \&quot;deployment-example-b4f6c7989\&quot;: Get \&quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas\&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:08:57+08:00 is after 2024-08-28T14:45:36Z&quot;</span><br></pre></td></tr></table></figure><p>ä» cmdline è·å– kubeconfig è·¯å¾„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl <span class="built_in">cat</span> kube-controller-manager.service</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/data/kube/bin/kube-controller-manager \</span><br><span class="line">  --address=127.0.0.1 \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/cluster1/ssl/kube-controller-manager.kubeconfig \</span><br><span class="line">...</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹æ—¶é—´</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig  /etc/kubernetes/cluster1/ssl/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="language-bash">config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d &gt; test.pem</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> test.pem -noout -enddate</span></span><br><span class="line">notAfter=Aug  5 15:37:00 2123 GMT</span><br></pre></td></tr></table></figure><p>æ—¶é—´æ²¡é—®é¢˜ï¼Œç„¶åçœ‹äº†ä¸‹æ¯ä¸ª kube-controller-manager éƒ½æ²¡é—®é¢˜ï¼Œè½®æµé—´éš”é‡å¯äº†ä¸‹ <code>kube-controller-manager</code> è¿˜æ˜¯ä¸€æ ·ï¼Œç„¶åé‡å¯äº†ä¸‹ kube-apiserver æ‰å¥½ï¼Œæ„Ÿè§‰ kube-apiserver ç¼“å­˜ bugã€‚</p><h3 id="kubelet-è½®è½¬è¯ä¹¦"><a href="#kubelet-è½®è½¬è¯ä¹¦" class="headerlink" title="kubelet è½®è½¬è¯ä¹¦"></a>kubelet è½®è½¬è¯ä¹¦</h3><p>è¯ä¹¦ä½äº <code>/var/lib/kubelet</code> ï¼Œæœ‰æ—¶å€™ kubelet ä¸ä¼šè‡ªåŠ¨è½®è½¬ï¼Œè¯¥ç›®å½•å†…è¯ä¹¦å¤‡ä»½ä¸‹åé‡å¯ kubelet å³å¯ï¼Œä»¥åŠæ¨èè®¾ç½® kube-controller-manager çš„è½®è½¬è¯ä¹¦æ—¶é—´ä¹…äº›ã€‚</p><h2 id="ä¸€äº›å…¶ä»–çš„"><a href="#ä¸€äº›å…¶ä»–çš„" class="headerlink" title="ä¸€äº›å…¶ä»–çš„"></a>ä¸€äº›å…¶ä»–çš„</h2><p>ä¸å•å• k8s è¯ä¹¦ï¼Œ etcd è¯ä¹¦ä¸€æ ·ï¼Œk8s è®¿é—® etcd ç›¸å…³å¤§åŒå°å¼‚ï¼Œä¸Šé¢å®æˆ˜éƒ¨åˆ†å¦‚æœç†è§£èƒ½åŠ›ä¸è¡Œï¼Œåœ¨å…³äº <code>ca-config.json</code> çš„ usages å¯ä»¥å·æ‡’ä¸‹é¢ client å’Œ server éƒ½å†™ä¸Šäº†ï¼Œä¸€ä¸ª ca é…ç½®æ–‡ä»¶ç”¨äºæ‰€æœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;usages&quot;: [</span><br><span class="line">    &quot;signing&quot;,</span><br><span class="line">    &quot;key encipherment&quot;,</span><br><span class="line">    &quot;server auth&quot;,</span><br><span class="line">    &quot;client auth&quot;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>ä»»ä½•å…³äºè¯ä¹¦æŠ¥é”™çš„ä¿¡æ¯å’Œæ—¥å¿—ä»”ç»†çœ‹ï¼Œè¯ä¹¦è¿‡æœŸã€ certSAN ä¸åŒ¹é…å’Œä¸æ˜¯ä¸€å¥— ca å¯¼è‡´æ ¡éªŒä¸é€šè¿‡ç­‰æ˜¯ä¸ä¸€æ ·çš„äº‹æƒ…ï¼Œä¸è¦æ— è„‘æ‰¾åˆ°å•¥è¯ä¹¦æ–‡ç« åšå®¢å°±è·Ÿç€çæ“ä½œï¼Œè¯ä¹¦æ“ä½œå‰è¦å¤‡ä»½å·²æœ‰è¯ä¹¦ï¼Œäº§ç”Ÿ kubeconfig æ–‡ä»¶çš„æ—¶å€™ï¼Œè¦ä½¿ç”¨ kubectl æŒ‡å®šæ–°è·¯å¾„ç”Ÿæˆï¼Œä¸è¦åŠ¨è€çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åŒäº‹é‡åˆ°å‡ èµ·è¯ä¹¦ç›¸å…³é—®é¢˜ï¼Œä»å°ç™½è§’åº¦æ¥å†™ä¸‹ k8s è¯ä¹¦â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="ssl" scheme="http://zhangguanzhang.github.io/tags/ssl/"/>
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å¼€å‘ä¸€ä¸ªè®©æŒ‡å®šåº”ç”¨èµ°ä»£ç†çš„å®‰å“ app è¿‡ç¨‹</title>
    <link href="http://zhangguanzhang.github.io/2025/04/27/android-tun2sock/"/>
    <id>http://zhangguanzhang.github.io/2025/04/27/android-tun2sock/</id>
    <published>2025-04-27T20:40:30.000Z</published>
    <updated>2025-04-27T20:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å¼€å‘ä¸€ä¸ªè®©æŒ‡å®š app èµ° http ä»£ç†çš„ç»è¿‡â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æƒ³å¯¹ç½‘ç»œåšä¸€äº›éªŒè¯ï¼Œåˆæ­¥æƒ³æ³•æ˜¯æ‰¾ä¸‹ golang socks5 ä»£ç† server ä¸Šå¯¹æ¯ä¸ª conn çš„å­—èŠ‚æµååºåˆ—åŒ–ååšåŠ¨ä½œï¼Œç„¶åå‘ç°å¦‚æœè®¾å¤‡å¤šäº†çš„è¯ï¼Œæ²¡æœ‰ä»£ç†æ± åŸºæœ¬æº IP å°±æ˜¯ä¸€ä¸ªäº†ï¼Œæ‰€ä»¥æƒ³ç€æ‰‹æœºç«¯ä¸Šæœ‰æ²¡æœ‰é root ä¸‹è®©æŒ‡å®š app èµ°ä»£ç†çš„ä»£ç†è½¯ä»¶ã€‚</p><p>ç„¶åæƒ³èµ·äº† <code>v2rxxNG</code> é‡Œå¯ä»¥æŒ‡å®š app èµ°ä»£ç†ï¼Œäºæ˜¯ç ”ç©¶æŠ˜è…¾äº†ä¸€ç•ªåˆ°å­¦ä¹  kotlin å’Œå®‰å“ compose è‡ªå·±å¼€å‘å®‰å“ appã€‚</p><h2 id="åº•å±‚æ¢è®¨ç»è¿‡"><a href="#åº•å±‚æ¢è®¨ç»è¿‡" class="headerlink" title="åº•å±‚æ¢è®¨ç»è¿‡"></a>åº•å±‚æ¢è®¨ç»è¿‡</h2><p>å…ˆå¤§è‡´çœ‹äº†ä¸‹ <code>v2rxxNG</code> çš„ä»£ç ï¼Œå‘ç°ç”¨çš„ <code>tun2socks</code> æŠ€æœ¯ï¼Œä¸»è¦æ˜¯ tun æ¥å£ï¼Œä¹Ÿå°±æ˜¯ Linux çš„ tun æŠ€æœ¯ã€‚</p><h3 id="Tun"><a href="#Tun" class="headerlink" title="Tun"></a>Tun</h3><p>åœ¨ Linux é‡Œä¸€åˆ‡çš†æ–‡ä»¶ï¼ŒTap&#x2F;Tun æ˜¯ Linux æä¾›çš„ç”¨æˆ·æ€å°è£…æŠ¥æ–‡çš„æ¥å£ï¼ŒTap æ˜¯æ•°æ®é“¾è·¯å±‚äºŒå±‚ï¼ŒTun æ˜¯ç½‘ç»œ IP å±‚ä¸‰å±‚ï¼ŒTun ä¸€ç«¯è¿ç€å†…æ ¸çš„åè®®æ ˆï¼Œå¦ä¸€ç«¯è¿ç€ç”¨æˆ·æ€çš„è¿›ç¨‹ã€‚ä½¿ç”¨æµç¨‹æ˜¯ï¼š</p><ol><li>ç¨‹åºä½¿ç”¨ç°æœ‰æˆ–è€…åˆ›å»ºçš„è™šæ‹Ÿç½‘å¡ï¼ˆTap&#x2F;Tunï¼‰</li><li>ç¨‹åºéœ€è¦å¯¹æ”¶å’Œå‘çš„æŠ¥æ–‡è¿›è¡Œå¤„ç†ï¼ˆä¹Ÿå°±æ˜¯è¯»å†™ &#x2F;dev&#x2F;net&#x2F;tun å­—ç¬¦è®¾å¤‡ï¼‰ï¼Œç¨‹åºçš„é€»è¾‘å°±åƒç‰©ç†ç½‘å¡çš„ç¡¬ä»¶åŠŸèƒ½ä¸€æ ·</li></ol><p>è¯¦ç»†æµç¨‹è§<a href="https://www.junmajinlong.com/virtual/network/all_about_tun_tap/">ç†è§£Linuxè™šæ‹Ÿç½‘å¡è®¾å¤‡tun&#x2F;tapçš„ä¸€åˆ‡</a>ï¼Œä¸æå•¥è™šæ‹Ÿäº¤æ¢æœºï¼Œè€Œæ˜¯å¸¸è§„åšè½¯ä»¶ä»£ç†éš§é“å•¥çš„ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ Tunã€‚</p><p>ä¾‹å¦‚ linux æœºå™¨ä½¿ç”¨ socks5 tun æ¨¡å¼ä»£ç†ï¼š</p><ul><li>èµ°è·¯ç”±æˆ–è€… iptables fmark åŒ¹é…åˆ°å‘å¾€ tun ç½‘å¡</li><li>Linux åè®®æ ˆä¼šæŠŠ TCP&#x2F;IP æŠ¥æ–‡å‘åˆ°ç”¨æˆ·æ€ç¨‹åºçš„ socks5 client</li><li>client ç¨‹åºè§£æ IP å±‚çš„æ•°æ®ï¼Œå°è£…æˆ socks5 åè®®çš„åŒ…å‘å‡ºå»</li><li>åè®®æ ˆæ”¶åˆ°åå‘å¾€ç‰©ç†ç½‘å¡ï¼Œç‰©ç†ç½‘å¡å‘å‡ºå»</li><li>socks5 server ç«¯æ”¶åˆ°æŠ¥æ–‡ï¼Œè§£æåï¼Œæœ¬æœºå‘å¾€ç›®æ ‡åœ°å€</li></ul><p>è¿™æ ·ç›®æ ‡åœ°å€çœ‹åˆ°å°±æ˜¯ socks5 server çš„ IP è¯·æ±‚çš„è‡ªå·±äº†ï¼Œå’Œ socks5 æ— å…³ï¼Œä»£ç†éš§é“å•¥çš„åŸºæœ¬éƒ½æ˜¯è¿™æ ·çš„å·¥ä½œåŸç†ã€‚</p><p>æ›´è¯¦ç»†çš„å›¾æ–‡è§ï¼š</p><ul><li><a href="https://www.junmajinlong.com/virtual/network/data_flow_about_openvpn/">https://www.junmajinlong.com/virtual/network/data_flow_about_openvpn/</a></li><li><a href="https://www.zhaohuabing.com/post/2020-02-24-linux-taptun/">https://www.zhaohuabing.com/post/2020-02-24-linux-taptun/</a></li></ul><h3 id="å®‰å“å’Œ-Tun"><a href="#å®‰å“å’Œ-Tun" class="headerlink" title="å®‰å“å’Œ Tun"></a>å®‰å“å’Œ Tun</h3><p><a href="https://github.com/2dust/v2rayNG/blob/master/V2rayNG/app/src/main/java/com/v2ray/ang/service/V2RayVpnService.kt">v2rxxNG</a> æ˜¯æŠŠ <code>badvxn</code> ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¾åœ¨ libs ä¸‹å‘½åä¸º <code>libtun2socks.so</code>ï¼Œè¿™æ · Android åœ¨å®‰è£… app çš„æ—¶å€™ä¼šè‡ªåŠ¨ç»™ <code>.so</code> åç¼€çš„æ–‡ä»¶ <code>+rx</code> æ‰§è¡Œæƒé™ï¼Œåœ¨æ²¡æœ‰ root çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºæ˜¯æ— æ³•ç»™ä¸€ä¸ªæ–‡ä»¶å¢åŠ  x æƒé™çš„ï¼Œè¿™ä¹Ÿç®—æ˜¯ä¸€ä¸ªéªšæ“ä½œã€‚</p><p>ç„¶ååœ¨å®‰å“å¼€å‘çš„æ—¶å€™ï¼Œå®‰å“æä¾›äº†æ¥å£ï¼Œéœ€è¦ç»§æ‰¿ <a href="https://developer.android.com/reference/kotlin/android/net/VpnService">VxnService</a> ï¼Œåœ¨å…¶ç±»çš„å†…éƒ¨ä½¿ç”¨ <code>Builder()</code> åˆ›å»º tunï¼Œåªä¸è¿‡å®‰å“ä¸Šä¸å†æ˜¯ <code>/dev/net/tun</code> è€Œæ˜¯æ–‡ä»¶æè¿°ç¬¦äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ParcelFileDescriptor tunDevice = new Builder()</span><br><span class="line">    .addAddress(VXN_ADDRESS, 32)</span><br><span class="line">    .addRoute(VXN_ROUTE, 0)</span><br><span class="line">    .addDnsServer(VXN_DNS)</span><br><span class="line">    .addAllowedApplication(&quot;com.google.android.tethering&quot;)</span><br><span class="line">    .addAllowedApplication(&quot;com.google.android.tethering2&quot;)</span><br><span class="line">    .establish();</span><br><span class="line"></span><br><span class="line">fd = tunDevice.getFd()</span><br></pre></td></tr></table></figure><p>ç„¶å <code>libtun2socks</code> ä½¿ç”¨è¿™ä¸ª fd è¿è¡Œï¼Œ<code>badvxn</code> æ˜¯åŸºäº <code>LwIP</code> ä¿®æ”¹çš„å®ç°ï¼Œc è¯­è¨€åŸºæœ¬éƒ½å¿˜å…‰äº†ï¼Œæ‰¾äº†ä¸‹ golang çš„å®ç°çœ‹çœ‹ï¼Œæ‰¾åˆ°äº† <code>https://github.com/xjasonlyu/tun2socks</code> ï¼Œä¸ºå•¥é€‰å®ƒæ˜¯åº”ä¸ºå®ƒå†…ç½®äº†å¥½å‡ ä¸ªæ¨¡å¼ï¼Œä¾‹å¦‚ direct ï¼Œä¿®æ”¹èµ·æ¥åº”è¯¥æ¯”è¾ƒç®€å•ï¼ˆè¿™é‡Œæˆ‘ä¸å»è¿½æ±‚æ€§èƒ½æé™ï¼Œä»¥éœ€æ±‚ä¼˜å…ˆè€Œé€‰å‹ï¼‰ã€‚</p><h2 id="å®‰å“å¼€å‘"><a href="#å®‰å“å¼€å‘" class="headerlink" title="å®‰å“å¼€å‘"></a>å®‰å“å¼€å‘</h2><p>æœäº†ä¸‹ç›¸å…³æ²¡æœ‰æœåˆ°ç°æœ‰çš„è½®å­ï¼Œå”¯ä¸€ä¸€ä¸ªæ¯”è¾ƒæ¥è¿‘æˆ‘éœ€æ±‚çš„ <a href="https://github.com/ys1231/appproxy/tree/iyue">appproxy</a> æ˜¯ flutter å†™çš„ï¼Œå¹¶ä¸”ä»£ç†ç±»å‹åªæœ‰ http å’Œ socks5ï¼Œæ²¡åŠæ³•ï¼Œå°±å»å­¦ä¹ äº†ä¸‹ kotlin å’Œå®‰å“å¼€å‘ã€‚</p><h3 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h3><p>2025å¹´ï¼Œæè¿™ç§ç¨å¾®åå‘åº•å±‚çš„å¯¹æ¥çš„ï¼Œå½“ç„¶æ˜¯å­¦ä¹  kotlin æå®‰å“å¼€å‘äº†ï¼Œä¹‹å‰çœ‹åˆ°çš„ <a href="https://kotlin.liying-cn.net/home.html">kotlin ä¸­æ–‡ç¿»è¯‘æ–‡æ¡£</a> çœ‹äº†ä¸‹æ„Ÿè§‰ä»å­¦ä¹ è·¯çº¿æ¥çœ‹å¥½çç¢ï¼Œå®‰å“å®˜æ–¹å¼€å‘æ–‡æ¡£é¡µé¢åˆå¯¹ kotlin ä»‹ç»å¾ˆå°‘ï¼Œéƒ½æ˜¯è¯¾ç¨‹é‡Œç©¿æ’ç€åŸºç¡€çŸ¥è¯†ã€‚å®Œæ•´ä½“ç³»çš„è¿˜æ˜¯è¦ä»äº’è”ç½‘ä¸Šæ‰¾ä¸‹çœ‹çœ‹ï¼Œä¸‹é¢çš„ gist æ˜¯æ”¶è—çš„ä¸€äº›ï¼ŒåŸºæœ¬éƒ½çœ‹è¿‡çš„ï¼š</p><p><a href="https://gist.github.com/zhangguanzhang/cd2f3eb20de5a1314e5d3802401aa192">https://gist.github.com/zhangguanzhang/cd2f3eb20de5a1314e5d3802401aa192</a></p><p>å…ˆå­¦ kotlinï¼Œå†å»çœ‹å®‰å“å®˜æ–¹çš„æ•™ç¨‹ï¼Œå®‰å“å®˜æ–¹æ–‡æ¡£æ˜¯å®æˆ˜å¸¦ä½ å…¥é—¨å®‰å“å¼€å‘ï¼Œç›¸å¯¹äºå®Œæ•´å®‰å“å¼€å‘ä½“ç³»æ¥è¯´è¿˜æ˜¯ç¼ºå°‘å¾ˆå¤šå†…å®¹ï¼Œä¾‹å¦‚ Serviceã€Intent å’Œ Flow å•¥çš„è®²è§£å¾ˆå°‘æˆ–è€…åŸºæœ¬æ²¡è®²ã€‚</p><h3 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>ä¸»è¦éœ€æ±‚ä¸ºå¦‚ä¸‹ï¼š</p><ul><li>æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ä»£ç†é…ç½®</li><li>é€šçŸ¥æ çš„å‰å°è¿è¡Œé€šçŸ¥</li><li>å³ä¸‹è§’çš„æµ®åŠ¨å¼€å…³</li><li>tun2socks å¯¹æ¥å¯åŠ¨</li><li>app é€‰æ‹©ç•Œé¢é€‰æ‹©å“ªäº› app èµ°ä»£ç†</li></ul><p>å¿«é€Ÿçœ‹å®Œå®˜æ–¹æ–‡æ¡£çš„ compose å¼€å‘åï¼ŒåŸºäº <a href="https://github.com/google-developer-training/basic-android-kotlin-compose-training-inventory-app">inventory-app</a> å¤åˆ¶ä¿®æ”¹å¼€å§‹ï¼Œå„ä¸ªç•Œé¢è·³è½¬ç”¨ navigate ï¼Œå¦å¤–è¿˜å‘ç° <a href="https://github.com/tailscale/tailscale-android/tree/main/android">tailscale-android</a> ä¹Ÿæ˜¯å…¨éƒ¨ç”¨ kotlin + jetpack compose å¼€å‘çš„ï¼Œå¯ä»¥ä»é‡Œé¢å­¦ä¸‹ä»£ç ã€‚</p><h3 id="tun2socks-aar"><a href="#tun2socks-aar" class="headerlink" title="tun2socks aar"></a>tun2socks aar</h3><p>æ ¹æ®æ–‡æ¡£ tun2socks çš„ <a href="https://github.com/xjasonlyu/tun2socks/issues/123">How to use file descriptor in Android</a> å¾—çŸ¥ï¼Œé›†æˆåˆ°å®‰å“æ˜¯è¦åˆ©ç”¨ gomobile ç¼–è¯‘å‡ºå®‰å“çš„ aar åä»£ç é‡ŒåŠ è½½ï¼ˆè€Œä¸æ˜¯ <code>v2rxxNG</code> é‚£æ ·è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€‚å…ˆç¼–è¯‘å‡ºæ¥åå†™ä¸ªæœ€å° demo è¯•è¯•çœ‹ï¼Œéœ€è¦ NDK å’Œ SDK_TOOLS å’Œ golangï¼Œæœç´¢äº†ä¸‹ååˆ¶ä½œäº†ä¸€ä¸ªå¸¦ç¯å¢ƒçš„ docker é•œåƒï¼Œç›´æ¥ä¸‹é¢æ­¥éª¤å¿«é€Ÿç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/xjasonlyu/tun2socks</span><br><span class="line"><span class="built_in">cd</span> tun2socks</span><br><span class="line"><span class="comment"># ä¸è¦åœ¨ä½é…ç½®æœºå™¨ä¸Šç¼–è¯‘ï¼Œä¼šå¡æ­»æœºå™¨</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -ti \</span><br><span class="line"> -e GOPROXY=<span class="string">&#x27;https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,https://proxy.golang.com.cn,direct&#x27;</span> \</span><br><span class="line">  --entrypoint bash -v <span class="variable">$PWD</span>:/w -w /w registry.aliyuncs.com/zhangguanzhang/gomobile</span><br><span class="line">go get golang.org/x/mobile/bind</span><br><span class="line"><span class="built_in">mkdir</span> -p build</span><br><span class="line"><span class="comment">#  ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›go build å‚æ•° è¿™é‡Œæˆ‘æŒ‡å®š-androidapi 24æœ€ä½å…¼å®¹å®‰å“7ï¼Œé»˜è®¤å€¼æ˜¯16ï¼Œä½†æ˜¯è¾ƒæ–°çš„ NDK ä¸Šæ— æ³•ç¼–è¯‘ï¼Œ 23.1.7779620 å¯ä»¥ç¼–è¯‘</span></span><br><span class="line">gomobile <span class="built_in">bind</span> -ldflags=<span class="string">&quot;-s -w&quot;</span> -trimpath -o build/tun2socks.aar \</span><br><span class="line">-target android \</span><br><span class="line">-androidapi 24 \</span><br><span class="line">github.com/xjasonlyu/tun2socks/v2/engine</span><br><span class="line">$ <span class="built_in">ls</span> -l build/</span><br><span class="line">total 30580</span><br><span class="line">-rw-r--r-- 1 root root 31304576 Apr 27 11:50 tun2socks.aar</span><br><span class="line">-rw-r--r-- 1 root root     6927 Apr 27 11:50 tun2socks-sources.jar</span><br></pre></td></tr></table></figure><p>issue é‡ŒåŸºæœ¬éƒ½æ˜¯ java å¼€å‘çš„ï¼Œæˆ‘è¿™é‡Œæ˜¯ kotlin å’Œæœ€æ–°ç‰ˆæœ¬çš„ <code>Android Studio</code>ï¼Œæœ€æ–°çš„ç‰ˆæœ¬é‡Œï¼Œéƒ½æ˜¯ç”¨ kotlin çš„ DSL gradle äº†ï¼ŒæŒ‰ç…§ issue é‡Œçš„æ·»åŠ ååœ¨ <code>Android Studio</code> é‡Œä¸€ç›´æŠ¥çº¢ï¼Œç„¶åæœç´¢åä¸‹é¢çš„æ‰è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># app ä¸‹çš„ buid.grade.kts çš„ ä¾èµ–ä¸‹æ·»åŠ </span><br><span class="line">implementation(files(&quot;libs/tun2socks.aar&quot;))</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢çš„ aar æ–‡ä»¶æ”¾ <code>app/libs/</code> ä¸‹å³å¯ï¼Œä½¿ç”¨å’Œ issue é‡Œä¸€æ ·ã€‚</p><p>gomobile ä¸€äº›å®è·µå‚è€ƒ:</p><ul><li><a href="https://mbox.dev/dev/go/go-mobile/03/">GoMobile 3: åœ¨ iOS &amp; Android ä¸Šçš„é›†æˆ</a></li><li><a href="https://apkdv.com/creating-android-ios-cross-platform-libraries-with-gomobile.html">ä½¿ç”¨ GoMobile åˆ›å»º Androidã€iOS è·¨å¹³å° WebSocket Library</a></li></ul><h3 id="å‰å°"><a href="#å‰å°" class="headerlink" title="å‰å°"></a>å‰å°</h3><p>å®˜æ–¹çš„ demo <a href="https://android.googlesource.com/platform/development/+/master/samples/ToyVpn">Toy</a> éå¸¸è€ï¼Œè€Œä¸”æ˜¯ java çš„ï¼Œè¿™é‡Œæ˜¯æˆ‘æ‰¾çš„å®˜æ–¹æ–‡æ¡£å’Œä¸€äº›å‚è€ƒä»£ç ï¼š</p><ul><li><a href="https://developer.android.com/develop/background-work/services/fgs?hl=zh-cn">å‰å°æœåŠ¡</a></li><li><a href="https://github.com/satishnada/android-vpn-implementation-guide/blob/master/app/src/main/java/com/satish/vpnguide/service/LocalVpnService.kt">android-vxn-implementation-guide</a></li><li><a href="https://github.com/microsoft/HydraLab/blob/main/android_client/app/src/main/java/com/microsoft/hydralab/android/client/vpn/HydraLabVpnService.kt">https://github.com/microsoft/HydraLab/blob/main/android_client/app/src/main/java/com/microsoft/hydralab/android/client/vpn/HydraLabVpnService.kt</a></li></ul><p>å‰å°æœåŠ¡è¿è¡Œéœ€è¦ <code>Notification</code> ï¼Œå‚è€ƒä¸‹åˆ«äººä»£ç å <code>Android Studio</code> æ¨¡æ‹Ÿå™¨é‡ŒçŠ¶æ€æ å‰å°éœ€è¦çš„é€šçŸ¥å‡ºä¸æ¥ï¼Œåœ¨çœŸæœºå®‰å“ 11 è¯•äº†ä¸‹æ²¡é—®é¢˜ï¼Œå‘ç°æ¨¡æ‹Ÿå™¨çš„å®‰å“ç‰ˆæœ¬å¤ªé«˜äº†ï¼Œè°·æ­Œäº†ä¸‹éœ€è¦åŠ ä¸‹é¢ä»£ç ç”³è¯·ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresApi(Build.VERSION_CODES.TIRAMISU)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">checkNotificationPermission</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> permission = android.Manifest.permission.POST_NOTIFICATIONS</span><br><span class="line">    <span class="keyword">when</span> &#123;</span><br><span class="line">        ContextCompat.checkSelfPermission(</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            permission</span><br><span class="line">        ) == PackageManager.PERMISSION_GRANTED -&gt; &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        shouldShowRequestPermissionRationale(permission) -&gt; &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">            requestNotificationPermission.launch(permission)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> requestNotificationPermission =</span><br><span class="line">    registerForActivityResult(ActivityResultContracts.RequestPermission()) &#123; isGranted -&gt;</span><br><span class="line">        <span class="keyword">if</span> (isGranted) Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;é€šçŸ¥æƒé™å·²æˆäºˆ&quot;</span>, Toast.LENGTH_SHORT)</span><br><span class="line">            .show()</span><br><span class="line">        <span class="keyword">else</span> Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;é€šçŸ¥æƒé™è¢«æ‹’ç»&quot;</span>, Toast.LENGTH_SHORT)</span><br><span class="line">            .show()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨ä»£ç†é—ªé€€ï¼Œå‘ç°æ²¡æœ‰åƒä»¥å‰ç”¨çš„ app é‚£æ ·å¼¹çª—å£å’Œé’¥åŒ™ï¼Œå°±æ˜¯è¯´è¯¥ app ç”³è¯· <code>vpn</code> æ¥å£ï¼Œä¼šå¯¹å•¥å•¥çš„ï¼Œéœ€è¦è°ƒç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VpnService.prepare(this)</span><br></pre></td></tr></table></figure><h3 id="ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜"><a href="#ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜" class="headerlink" title="ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜"></a>ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜</h3><p>å¯åŠ¨åï¼Œåˆ‡å‡ºå»ï¼Œå†ä»é€šçŸ¥æ è¿›æ¥ï¼Œå‘ç°æµ®åŠ¨æŒ‰é’®çŠ¶æ€å’Œå®é™…ä¸ä¸€è‡´ï¼Œæœ€åè¿˜æ˜¯æŒ‰ç…§ Binder å’Œ Service é€šä¿¡æ‰è¡Œï¼Œä»¥åŠ <code>Broadcast</code> è®©æŒ‰é’®çŠ¶æ€å’Œå®é™…ä¸€è‡´ã€‚<br>å®Œæ•´ä»£ç åœ¨ <a href="https://github.com/zhangguanzhang/appproxy">appproxy</a></p><p>æ‰“åŒ…å‘ç»™å…¶ä»–äººï¼Œå‘ç°å®‰è£…ä¸ä¸Šï¼Œæœ€åå‘ç°æ˜¯ç­¾åé—®é¢˜ï¼Œæ²¡ç­¾åå®‰è£…ä¸äº†ï¼Œå·æ‡’å¯ä»¥æš‚æ—¶ <code>Build -&gt; Generate App Bundles or APKs -&gt; Generate APKs</code> å¼¹å‡ºçš„ç‚¹ locate é‡Œã€‚è¿˜å¯ä»¥åˆ†æ¶æ„æ‰“éä¸€ä½“åŒ…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">splits &#123;</span><br><span class="line">    abi &#123;</span><br><span class="line">        isEnable = true</span><br><span class="line">        reset()</span><br><span class="line">        include(&quot;armeabi-v7a&quot;, &quot;arm64-v8a&quot;, &quot;x86_64&quot;)</span><br><span class="line">        isUniversalApk = false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>app å¼€å‘å®Œæˆåï¼Œåç»­å°±æ˜¯ fork tun2socks å¤åˆ¶ direct ååœ¨ conn å¯¹æµè§£æå’Œä¿®æ”¹å‘é€ ï¼Œå½“ç„¶å¯ä»¥å¤©é©¬è¡Œç©ºä¸‹ä¸è¦å±€é™åœ¨ä»£ç†å±‚é¢ï¼Œä¾‹å¦‚ç”¨æˆ·æ€ kotlin ç›´æ¥å¯¹ fd çš„æµè½¬å‘ä¸‹åªç»Ÿè®¡è®¿é—® ipï¼Œå°±å¯ä»¥åšä¸€ä¸ªç®€å•çš„ç½‘ç»œè®¿é—®ç»Ÿè®¡äº†ã€‚</p><p>tun2socks å¥½å¤šå…¨å±€å˜é‡å’Œ init é‡Œåšæ“ä½œï¼Œè¿™é‡Œè®°å½•ä¸‹æ¢³ç†çš„ä¸€äº›å¯åŠ¨æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. main.go é‡Œçš„ engine.Start()</span><br><span class="line">2. engine/engine.go é‡Œçš„ start()</span><br><span class="line">3. engine/engine.go é‡Œçš„ netstack() å†…çš„ `tunnel.T().SetDialer(_defaultProxy)`</span><br><span class="line">4. ä¸Šé¢ import äº† tunnel æ‰§è¡Œäº† tunnel/global.go å†…çš„ init() çš„ T().ProcessAsync()</span><br><span class="line">5. go t.process(ctx)</span><br><span class="line">func (t *Tunnel) process(ctx context.Context) &#123;</span><br><span class="line">for &#123;</span><br><span class="line">select &#123;</span><br><span class="line">case conn := &lt;-t.tcpQueue:</span><br><span class="line">go t.handleTCPConn(conn)</span><br><span class="line">case conn := &lt;-t.udpQueue:</span><br><span class="line">go t.handleUDPConn(conn)</span><br><span class="line">case &lt;-ctx.Done():</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæ˜¯ aar å¼•ç”¨ï¼Œå…¥å£æ˜¯ <code>engine/engine.go</code> å†…çš„ <code>engine.Start()</code> æ–¹æ³•ï¼Œå¯¹äºæ—¥å¿—ï¼Œå¦‚æœæœ‰æ‰“å°åˆ°æ–‡ä»¶çš„éœ€æ±‚çš„è¦åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œä¿®æ”¹ï¼Œç”±äºé»˜è®¤ <code>cwd</code> æ˜¯ <code>/</code> ä¼šæŠ¥é”™åªè¯»ï¼Œæ¨èç»™ Key æ·»åŠ  <code>Dir</code> å‚æ•°åœ¨ <code>engine/engine.go</code> é‡Œï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">general</span><span class="params">(k *Key)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">level, err := log.ParseLevel(k.LogLevel)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filename := path.Join(_defaultKey.Dir, <span class="string">&quot;tun2socks.log&quot;</span>)</span><br><span class="line">cfg := zap.NewProductionConfig()</span><br><span class="line">cfg.OutputPaths = []<span class="type">string</span>&#123;filename&#125;</span><br><span class="line">cfg.Level.SetLevel(level)</span><br><span class="line">log.SetLogger(zap.Must(cfg.Build()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// log.SetLogger(log.Must(log.NewLeveled(level)))</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ service é‡Œç»™ <code>key.dir</code> ä¼ é€’ <code>getExternalFilesDir(null)?.absolutePath</code>ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/storage/emulated/0/Android/data/&lt;package_name&gt;/files/</span><br></pre></td></tr></table></figure><p>è¿™æ · engine æ—¥å¿—å°±å¯ä»¥æ‰“å°åœ¨ä¸Šé¢ç›®å½•å†…ï¼Œå¦å¤–å¯¹äº tcp é“¾æ¥ï¼Œæ ¸å¿ƒå°±æ˜¯è¿™å—ä»£ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Tunnel)</span></span> handleTCPConn(originConn adapter.TCPConn) &#123;</span><br><span class="line"><span class="keyword">defer</span> originConn.Close()</span><br><span class="line"></span><br><span class="line">id := originConn.ID()</span><br><span class="line">metadata := &amp;M.Metadata&#123;</span><br><span class="line">Network: M.TCP,</span><br><span class="line">SrcIP:   parseTCPIPAddress(id.RemoteAddress),</span><br><span class="line">SrcPort: id.RemotePort,</span><br><span class="line">DstIP:   parseTCPIPAddress(id.LocalAddress),</span><br><span class="line">DstPort: id.LocalPort,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), tcpConnectTimeout)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">remoteConn, err := t.Dialer().DialContext(ctx, metadata)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Warnf(<span class="string">&quot;[TCP] dial %s: %v&quot;</span>, metadata.DestinationAddress(), err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">metadata.MidIP, metadata.MidPort = parseNetAddr(remoteConn.LocalAddr())</span><br><span class="line"></span><br><span class="line">remoteConn = statistic.NewTCPTracker(remoteConn, metadata, t.manager)</span><br><span class="line"><span class="keyword">defer</span> remoteConn.Close()</span><br><span class="line"></span><br><span class="line">log.Infof(<span class="string">&quot;[TCP] %s &lt;-&gt; %s&quot;</span>, metadata.SourceAddress(), metadata.DestinationAddress())</span><br><span class="line">pipe(originConn, remoteConn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼Œå®¢æˆ·ç«¯å‘èµ·è¿æ¥åˆ° tun2socksï¼Œç„¶å tun2socks <code>t.Dialer().DialContext(ctx, metadata)</code> è¿æ¥ç›®æ ‡åœ°å€ï¼Œç„¶å pipe ä¸¤ä¸ª conn</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä¹Ÿå¯ä»¥å»çœ‹çœ‹ core/tcp.go</span><br><span class="line">client ----originConn----&gt; tun2socks -----remoteConn----&gt; server</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦ tun2socks ä¸»åŠ¨ç»™ client å›åŒ…ï¼Œéœ€è¦æŠŠ remoteConn ä¼ é€’è¿‡å»ï¼ŒåŒæ—¶åœ¨ <code>t.Dialer().DialContext</code> å†…äº§ç”Ÿçš„ <code>net.Conn</code> çš„ <code>Read</code> çš„ <code>[]byte</code> len å‘ç°æœ‰ç‚¹å°ï¼Œæˆ‘è‡ªå·±ç»´æŠ¤äº†ä¸ª buf åšå¤„ç†ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *mirrorStream)</span></span> Read(p []<span class="type">byte</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">tmp := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(p))</span><br><span class="line">n, err := m.rawConn.Read(tmp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">copy</span>(p, tmp[:n])</span><br><span class="line">m.buf = <span class="built_in">append</span>(m.buf, tmp[:n]...)</span><br><span class="line">m.mirrorMessages()</span><br><span class="line"><span class="keyword">return</span> n, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://blog.csdn.net/qq_45649553/article/details/136543933">å®‰å“åŸºç¡€-applicationè¯¦è§£</a></li><li><a href="https://github.com/xjasonlyu/tun2socks/discussions/139">tun2socks è‡ªå®šä¹‰ä»£ç†</a></li><li><a href="https://ivanfan.site/2022/01/05/Android/VPN%E4%BB%A3%E7%90%86%E5%8A%A0%E9%80%9F/">ä»£ç†åŠ é€Ÿ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘å¼€å‘ä¸€ä¸ªè®©æŒ‡å®š app èµ° http ä»£ç†çš„ç»è¿‡â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="android" scheme="http://zhangguanzhang.github.io/tags/android/"/>
    
    <category term="tun2sock2" scheme="http://zhangguanzhang.github.io/tags/tun2sock2/"/>
    
  </entry>
  
  <entry>
    <title>kube-log-runner ä½¿ç”¨å’Œé€‚é… logrotate æ”¹é€ </title>
    <link href="http://zhangguanzhang.github.io/2025/04/21/kube-log-runner/"/>
    <id>http://zhangguanzhang.github.io/2025/04/21/kube-log-runner/</id>
    <published>2025-04-21T10:40:30.000Z</published>
    <updated>2025-04-21T10:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ä½¿ç”¨ kube-log-runner çš„ç»å†â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>kubelet å’Œä¸€äº› kube ç»„ä»¶åœ¨äºŒè¿›åˆ¶ systemd service ç®¡ç†ä¸‹ï¼Œæ—¥å¿—æœ€ç»ˆä¼šåœ¨ <code>/var/log/messages</code> é‡Œï¼Œæˆ‘ä»¬çš„å®¢æˆ·å¯¹è¯¥æ–‡ä»¶ä¼šæœ‰å…³é”®å­—ï¼ˆErrorã€Failed â€¦ï¼‰ç›‘æ§ï¼Œè®©æˆ‘ä»¬æŠŠç›¸å…³ç»„ä»¶æ—¥å¿—å†™åˆ°å…¶ä»–æ–‡ä»¶é‡Œå»ã€‚</p><h2 id="ç»è¿‡"><a href="#ç»è¿‡" class="headerlink" title="ç»è¿‡"></a>ç»è¿‡</h2><h3 id="é€‰å‹"><a href="#é€‰å‹" class="headerlink" title="é€‰å‹"></a>é€‰å‹</h3><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/system-logs/">ç³»ç»Ÿæ—¥å¿—</a> å¾—çŸ¥ <code>v1.26</code> å¼€å§‹ç§»é™¤äº†ä»¥å‰çš„æ—¥å¿—æ–‡ä»¶ã€ç›®å½•å’Œè½®è½¬ä¹‹ç±»çš„å‚æ•°ï¼Œè€Œæ˜¯è®©ä½¿ç”¨ <code>kube-log-runner</code> ä»£æ›¿ï¼Œè¯¥äºŒè¿›åˆ¶å·²ç»å†…ç½®åœ¨äºŒè¿›åˆ¶ä¸‹è½½å‹ç¼©åŒ…é‡Œäº†ã€‚å¦‚æœæ˜¯ä½¿ç”¨é•œåƒï¼Œå®˜æ–¹çš„å®¹å™¨é•œåƒå†…ç½®äº†ï¼Œåªæ˜¯åå­—å«åš <code>/go-runner</code>ã€‚</p><p>æ ¹æ® <a href="https://github.com/kubernetes/component-base/tree/master/logs/kube-log-runner">github kube-log-runner</a> å¾—çŸ¥ä½¿ç”¨æ–¹å¼å’Œæºç ï¼Œå®ƒå°±æ˜¯ golang å†™çš„ä¸€ä¸ªç®€å•å·¥å…·ï¼Œå¯åŠ¨å‘½ä»¤ï¼ŒæŠŠå‘½ä»¤çš„æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºæ•è·å†™åˆ°æ–‡ä»¶ï¼Œç„¶åè½¬å‘ä¿¡å·ç»™è¿›ç¨‹ã€‚</p><h3 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl cat --no-pager kube-apiserver</span><br><span class="line">...</span><br><span class="line">ExecStart=/usr/local/bin/kube-log-runner \</span><br><span class="line">  --log-file=/var/logs/kube-apiserver.log \</span><br><span class="line">  /usr/local/bin/kube-apiserver </span><br></pre></td></tr></table></figure><p>ç›´æ¥æµ‹è¯•äº†ä¸‹å‘ç°å¯åŠ¨æŠ¥é”™ä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4æœˆ 18 10:30:25 xxx systemd[1]: Got notification message from PID 9885, but reception only permitted for main PID 9880</span><br></pre></td></tr></table></figure><p>å¦‚æœå¯¹ systemd æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥ç›´æ¥çœ‹å‡ºé—®é¢˜ã€‚å› ä¸ºæˆ‘ä»¬è¿™è¾¹ç”¨çš„ <code>Type=notify</code>ï¼Œè¯¥è®¾ç½®ä¸‹ï¼ŒæœåŠ¡å¯åŠ¨åä¼šå‘é€ <code>sd_notify</code> ç»™ systemdï¼Œè¿™æ · systemd ç¡®è®¤è¯¥æœåŠ¡æ­£å¸¸å¯åŠ¨ã€‚è¿™ä¸ªæŠ¥é”™å°±æ˜¯ï¼š</p><ol><li>systemd æ‹‰èµ·çš„ä¸»è¿›ç¨‹ Pid æ˜¯ 9880</li><li>ä»éä¸»è¿›ç¨‹çš„ 9885 æ”¶åˆ°äº† notification æ¶ˆæ¯</li></ol><p>è§£å†³è¯¥é—®é¢˜å¾ˆç®€å•ï¼Œsystemd ç»™äº†é…ç½®é€‰é¡¹æ¥æ”¶æ‰€æœ‰çš„ notify ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NotifyAccess=all</span><br></pre></td></tr></table></figure><h3 id="logrotate"><a href="#logrotate" class="headerlink" title="logrotate"></a>logrotate</h3><p>æ—¥å¿—è¦å†™å…¥åˆ°æ–‡ä»¶ï¼Œé‚£å°±ä¸€å®šè¦éµå®ˆ Linux è§„èŒƒé…ç½® logrotate é¿å…æ—¥å¿—å†™æ»¡åˆ†åŒºã€‚ç„¶åç›¸å…³é…ç½®å®Œï¼Œå†™å®Œé…ç½®ç”¨ä¸€ä¸ªå°çš„ size å‚æ•°æµ‹è¯•äº† logrotate å‘ç°ä¸è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -v /etc/logrotate.d/kube-apiserver</span><br></pre></td></tr></table></figure><p>logrotate è½®è½¬æ—¥å¿—åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œcreate å’Œ copytruncateï¼Œé»˜è®¤æ˜¯ createï¼Œä¸¤ç§å¤§è‡´åŸç†å¦‚ä¸‹ï¼š</p><ul><li>createï¼šé‡å‘½åæ—¥å¿—æ–‡ä»¶ï¼Œå†åˆ›å»ºåŸæœ‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œç­‰åŒäº mv + touch</li><li>copytruncateï¼š<code>cp xx.log xx.log.1 &amp;&amp; truncate -s 0 xx.log</code></li></ul><p>Linux ä¸Šæ‰“å¼€æ–‡ä»¶åå®é™…æ˜¯æ“ä½œ inodeï¼Œæ–‡ä»¶ååœ¨æ‰“å¼€ inode åæ”¹åæˆ–è€…åˆ æ‰æ–‡ä»¶ path å¯¹è¿›ç¨‹å¹¶ä¸ä¼šæœ‰å½±å“ï¼Œcreate æ–¹å¼éœ€è¦è¿›ç¨‹æ”¯æŒ reopen æ—¥å¿—æ–‡ä»¶è·¯å¾„ä½¿ç”¨æ–°çš„ inodeï¼Œç±»ä¼¼ nginx çš„ logrotate é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/var/log/nginx/*.log /var/log/nginx/*/*.log&#123;</span><br><span class="line">daily</span><br><span class="line">missingok</span><br><span class="line">rotate 14</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">create 640 root adm</span><br><span class="line">sharedscripts</span><br><span class="line">postrotate</span><br><span class="line">[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>kube-apiserver å¹¶æ²¡æœ‰æ”¯æŒè¿™ç§è¡Œä¸ºï¼Œå°±å°è¯•äº†ä¸‹ <code>copytruncate</code> å‘ç°ä¹Ÿä¸è¡Œï¼Œç„¶åå» <a href="https://github.com/kubernetes/enhancements/issues/2845">kep çš„ kube-log-runner</a> ä¸‹å›å¤äº†ä¸‹è¯·æ±‚æ·»åŠ  logrotate æ”¯æŒã€‚</p><h3 id="ä¿®æ”¹"><a href="#ä¿®æ”¹" class="headerlink" title="ä¿®æ”¹"></a>ä¿®æ”¹</h3><p>ç­‰å®˜æ–¹ä¼°è®¡å¾ˆä¹…äº†ï¼Œå…ˆè‡ªå·±ä¿®æ”¹ä¸‹æºç æ”¯æŒä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;os/exec&quot;</span></span><br><span class="line"><span class="string">&quot;os/signal&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">logFilePath    = flag.String(<span class="string">&quot;log-file&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;If non-empty, save stdout to this file&quot;</span>)</span><br><span class="line">alsoToStdOut   = flag.Bool(<span class="string">&quot;also-stdout&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;useful with log-file, log to standard output as well as the log file&quot;</span>)</span><br><span class="line">redirectStderr = flag.Bool(<span class="string">&quot;redirect-stderr&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;treat stderr same as stdout&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å¢å…¨å±€å˜é‡</span></span><br><span class="line">logFile         *os.File</span><br><span class="line">logFileMu       sync.Mutex</span><br><span class="line">globalLogFile   <span class="type">string</span></span><br><span class="line">globalAlsoStdOut <span class="type">bool</span></span><br><span class="line">globalRedirectStderr <span class="type">bool</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SyncWriter æ”¯æŒåŠ¨æ€åˆ‡æ¢ Writer</span></span><br><span class="line"><span class="keyword">type</span> SyncWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">mu sync.Mutex</span><br><span class="line">w  io.Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sw *SyncWriter)</span></span> Write(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">sw.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> sw.mu.Unlock()</span><br><span class="line"><span class="keyword">return</span> sw.w.Write(p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sw *SyncWriter)</span></span> SetWriter(w io.Writer) &#123;</span><br><span class="line">sw.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> sw.mu.Unlock()</span><br><span class="line">sw.w = w</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">outputSync = &amp;SyncWriter&#123;w: os.Stdout&#125;</span><br><span class="line">errSync    = &amp;SyncWriter&#123;w: os.Stderr&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := configureAndRun(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configureAndRun</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// ä¿å­˜å‚æ•°åˆ°å…¨å±€å˜é‡</span></span><br><span class="line">globalLogFile = *logFilePath</span><br><span class="line">globalAlsoStdOut = *alsoToStdOut</span><br><span class="line">globalRedirectStderr = *redirectStderr</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> globalLogFile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">logFile, err = os.OpenFile(globalLogFile, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to open log file: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalAlsoStdOut &#123;</span><br><span class="line">outputSync.SetWriter(io.MultiWriter(os.Stdout, logFile))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">outputSync.SetWriter(logFile)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalRedirectStderr &#123;</span><br><span class="line">errSync.SetWriter(outputSync)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">args := flag.Args()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;not enough arguments to run&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exe := args[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">var</span> exeArgs []<span class="type">string</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">exeArgs = args[<span class="number">1</span>:]</span><br><span class="line">&#125;</span><br><span class="line">cmd := exec.Command(exe, exeArgs...)</span><br><span class="line">cmd.Stdout = outputSync</span><br><span class="line">cmd.Stderr = errStream()</span><br><span class="line"></span><br><span class="line">log.Printf(<span class="string">&quot;Running command:\n%v&quot;</span>, cmdInfo(cmd))</span><br><span class="line">err := cmd.Start()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;starting command: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡å·å¤„ç†</span></span><br><span class="line"><span class="keyword">go</span> setupSigHandler(cmd.Process)</span><br><span class="line"><span class="keyword">if</span> err := cmd.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;running command: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errStream</span><span class="params">()</span></span> io.Writer &#123;</span><br><span class="line"><span class="keyword">if</span> *redirectStderr &#123;</span><br><span class="line"><span class="keyword">return</span> outputSync</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> os.Stderr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cmdInfo</span><span class="params">(cmd *exec.Cmd)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(</span><br><span class="line"><span class="string">`Command env: (log-file=%v, also-stdout=%v, redirect-stderr=%v)</span></span><br><span class="line"><span class="string">Run from directory: %v</span></span><br><span class="line"><span class="string">Executable path: %v</span></span><br><span class="line"><span class="string">Args (comma-delimited): %v`</span>, *logFilePath, *alsoToStdOut, *redirectStderr,</span><br><span class="line">cmd.Dir, cmd.Path, strings.Join(cmd.Args, <span class="string">&quot;,&quot;</span>),</span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹åçš„ä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupSigHandler</span><span class="params">(process *os.Process)</span></span> &#123;</span><br><span class="line">signals := []os.Signal&#123;</span><br><span class="line">syscall.SIGHUP, syscall.SIGINT,</span><br><span class="line">syscall.SIGTERM, syscall.SIGQUIT, syscall.SIGUSR1,</span><br><span class="line">&#125;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(c, signals...)</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">&quot;Now listening for signals&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> s := <span class="keyword">range</span> c &#123;</span><br><span class="line"><span class="keyword">if</span> s == syscall.SIGUSR1 &#123;</span><br><span class="line">handleLogRotate()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">forwardSignal(process, s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†æ—¥å¿—è½®è½¬</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLogRotate</span><span class="params">()</span></span> &#123;</span><br><span class="line">logFileMu.Lock()</span><br><span class="line"><span class="keyword">defer</span> logFileMu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalLogFile == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">log.Println(<span class="string">&quot;No log file configured, ignoring SIGUSR1&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­æ—§æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> logFile != <span class="literal">nil</span> &#123;</span><br><span class="line">logFile.Sync()</span><br><span class="line"><span class="keyword">if</span> err := logFile.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Error closing log file: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€æ–°æ–‡ä»¶</span></span><br><span class="line">newFile, err := os.OpenFile(globalLogFile, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;ERROR: Failed to reopen log file: %v (logging to stdout)&quot;</span>, err)</span><br><span class="line">outputSync.SetWriter(os.Stdout)</span><br><span class="line"><span class="keyword">if</span> globalRedirectStderr &#123;</span><br><span class="line">errSync.SetWriter(os.Stdout)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logFile = newFile</span><br><span class="line">log.SetOutput(logFile)</span><br><span class="line">log.Println(<span class="string">&quot;Successfully reopened log file&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°è¾“å‡ºæµ</span></span><br><span class="line"><span class="keyword">if</span> globalAlsoStdOut &#123;</span><br><span class="line">outputSync.SetWriter(io.MultiWriter(os.Stdout, logFile))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">outputSync.SetWriter(logFile)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalRedirectStderr &#123;</span><br><span class="line">errSync.SetWriter(outputSync)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">forwardSignal</span><span class="params">(process *os.Process, s os.Signal)</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Forwarding signal %v to PID %v&quot;</span>, s, process.Pid)</span><br><span class="line"><span class="keyword">if</span> err := process.Signal(s); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Error forwarding signal %v: %v&quot;</span>, s, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸è½¬å‘ USR1 ä¿¡å·ç»™å¥—å¨ƒçš„è¿›ç¨‹ï¼Œè‡ªèº«å¤„ç† USR1 ä¿¡å·å°±æ˜¯ reopen æ—¥å¿—æ–‡ä»¶ã€‚ç„¶å logrotate è§¦å‘éœ€è¦ pid æ–‡ä»¶ï¼Œsystemd é‡Œå¢åŠ :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStartPost=/bin/sh -c &quot;echo $MAINPID &gt; /var/run/kube-apiserver.pid&quot;</span><br></pre></td></tr></table></figure><p>logrotate é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/var/logs/kube-apiserver.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 5</span><br><span class="line">    size 400M</span><br><span class="line">    missingok</span><br><span class="line">    compress</span><br><span class="line">    nomail</span><br><span class="line">    delaycompress</span><br><span class="line">    create</span><br><span class="line">    postrotate</span><br><span class="line">        [ ! -f /var/run/kube-apiserver.pid ] || kill -USR1 `cat /var/run/kube-apiserver.pid`</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://wsgzao.github.io/post/logrotate/">https://wsgzao.github.io/post/logrotate/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ä½¿ç”¨ kube-log-runner çš„ç»å†â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="kube-log-runner" scheme="http://zhangguanzhang.github.io/tags/kube-log-runner/"/>
    
    <category term="logrotate" scheme="http://zhangguanzhang.github.io/tags/logrotate/"/>
    
  </entry>
  
  <entry>
    <title>é˜¿é‡Œäº‘ ecs ä¸Š etcd SSL reset</title>
    <link href="http://zhangguanzhang.github.io/2025/02/14/aliyun-ecs-ssl/"/>
    <id>http://zhangguanzhang.github.io/2025/02/14/aliyun-ecs-ssl/</id>
    <published>2025-02-14T13:40:30.000Z</published>
    <updated>2025-02-14T13:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æŠ˜è…¾ä¸€äº›æ—¶é—´çš„ etcd ssl reset é—®é¢˜â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å‡ å¹´å‰çš„ 120 å—çš„è…¾è®¯äº‘è½»é‡åº”ç”¨æœåŠ¡å™¨ä¹°äº†åå† 240 å—ç»­è´¹ä¸¤å¹´ï¼Œå¿«åˆ°æœŸäº†åé˜¿é‡Œäº‘ 90 å¿«å»ä¹°äº†ä¸€å¹´ã€‚ç„¶åä¸Šé¢æŠŠæˆ‘ä¹‹å‰çš„ etcd è¿ç§»è¿‡å»äº†ï¼Œè¯ä¹¦å½“åˆç”Ÿæˆçš„æ—¶å€™å¯ä»¥é¢„ç•™äº† cert SAN åŸŸåç›¸å…³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># openssl  x509 -in s1.pem -noout -text | grep -A1 &#x27;X509v3 Subject Alternative Name&#x27;</span><br><span class="line">            X509v3 Subject Alternative Name: </span><br><span class="line">                DNS:localhost, DNS:xxx.com, IP Address:127.0.0.1, IP Address:10.0.x.x, IP Address:10.2.0.1</span><br></pre></td></tr></table></figure><p>é¿å…å…¶ä»– etcd å®¢æˆ·ç«¯æ¢è¯ä¹¦çš„ï¼Œä¸€äº›éäº‘ä¸Šä¼šç”¨åˆ°è¯¥ etcd çš„ç›´æ¥æœ¬åœ°é…ç½® hosts xxx.com ï¼Œè¿™æ ·åç»­ ecs æ¢ ip äº†ç›´æ¥æ”¹ hosts æ–‡ä»¶å³å¯ã€‚</p><h2 id="ç»è¿‡"><a href="#ç»è¿‡" class="headerlink" title="ç»è¿‡"></a>ç»è¿‡</h2><p>è¿‡å¹´æ”¾å‡ä¹‹å‰ etcd æ•´åˆ°é˜¿é‡Œäº‘ ecs ä¸Šäº†ï¼Œç„¶åçœ‹ç€ä¹Ÿæ­£å¸¸ï¼Œåé¢çªç„¶å‡ ä¸ª agent è¿ä¸ä¸Š etcdï¼ŒåŒ…æ‹¬ curl ä¹Ÿæœ‰é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v https://xxx.com:22379 --resolve xxx.com:22379:x.x.x.x</span><br><span class="line">* Added xxx.com:22379:x.x.x.x to DNS cache</span><br><span class="line">* Hostname xxx.com was found <span class="keyword">in</span> DNS cache</span><br><span class="line">*   Trying x.x.x.x:22379...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to xxx.com (x.x.x.x) port 22379 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully <span class="built_in">set</span> certificate verify locations:</span><br><span class="line">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">  CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* OpenSSL SSL_connect: SSL_ERROR_SYSCALL <span class="keyword">in</span> connection to xxx.com:22379 </span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (35) OpenSSL SSL_connect: SSL_ERROR_SYSCALL <span class="keyword">in</span> connection to xxx.com:22379</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç›´æ¥ ip å°±æ²¡é—®é¢˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v https://x.x.x.x:22379 --resolve xxx.com:22379:x.x.x.x</span><br><span class="line">* Added xxx.com:22379:x.x.x.x to DNS cache</span><br><span class="line">*   Trying x.x.x.x:22379...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to x.x.x.x (x.x.x.x) port 22379 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">  CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Request CERT (13):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.3 (OUT), TLS alert, unknown CA (560):</span><br><span class="line">* SSL certificate problem: unable to get local issuer certificate</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (60) SSL certificate problem: unable to get local issuer certificate</span><br><span class="line">More details here: https://curl.haxx.se/docs/sslcerts.html</span><br><span class="line"></span><br><span class="line">curl failed to verify the legitimacy of the server and therefore could not</span><br><span class="line">establish a secure connection to it. To learn more about this situation and</span><br><span class="line">how to fix it, please visit the web page mentioned above.</span><br></pre></td></tr></table></figure><p>è¿™äº›æ—¥å­æ²¡é‚£ä¹ˆå¿™äº†å°±çœ‹äº†ä¸‹ï¼Œå‘ç°å¥½å‡ ä¸ªåœ°æ–¹ç½‘ç»œè®¿é—®éƒ½è¿™æ ·ï¼Œæ ¹æ®æ’é™¤æ³•ä¸€å®šæ˜¯é˜¿é‡Œäº‘æœ‰é—®é¢˜äº†ã€‚æœäº†ä¸‹ aliyun ssl reset æœåˆ°æœç„¶æ˜¯é˜¿é‡Œäº‘æœ‰é—®é¢˜ã€‚è®¿é—®é˜¿é‡Œäº‘ ecs çš„æµé‡ä¼šå…ˆè¿›äº‘ç›¾ï¼Œä¼šæ ¹æ® SSL çš„ SNI åŸŸååšåˆ¤æ–­ï¼Œå¦‚æœæ²¡å¤‡æ¡ˆåˆ™ tcp resetã€‚æ— è¯­äº†ï¼Œæˆ‘è¿™åˆä¸æ˜¯ 80ã€8080ã€443 ç«¯å£ï¼Œæ²¡åŠæ³•æš‚æ—¶ç”¨ IP å§ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://developer.aliyun.com/article/708243">https://developer.aliyun.com/article/708243</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æŠ˜è…¾ä¸€äº›æ—¶é—´çš„ etcd ssl reset é—®é¢˜â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="etcd" scheme="http://zhangguanzhang.github.io/tags/etcd/"/>
    
    <category term="ssl" scheme="http://zhangguanzhang.github.io/tags/ssl/"/>
    
    <category term="aliyun" scheme="http://zhangguanzhang.github.io/tags/aliyun/"/>
    
  </entry>
  
  <entry>
    <title>ç»™é²²é¹920å’Œä½ç‰ˆæœ¬é£è…¾ç¼–è¯‘arm64 clickhouse</title>
    <link href="http://zhangguanzhang.github.io/2025/02/13/clickhouse-arm64-v8.0-build/"/>
    <id>http://zhangguanzhang.github.io/2025/02/13/clickhouse-arm64-v8.0-build/</id>
    <published>2025-02-13T12:10:30.000Z</published>
    <updated>2025-02-13T12:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>clickhouse å®˜æ–¹ docker é•œåƒæ— æ³•åœ¨è€çš„ arm64 cpu ä¸Šè¿è¡Œï¼Œéœ€è¦ç¼–è¯‘</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ä¸šåŠ¡æ–¹æœ‰åœ¨ä½¿ç”¨ clickhouseï¼Œå½“æ—¶ç‰ˆæœ¬æ˜¯ <code>22.8.5.29</code>ï¼Œéšç€åé¢ä¹Ÿæœ‰ arm64 éœ€æ±‚ï¼Œåœ¨ arm64 æœºå™¨ä¸Šéƒ¨ç½²äº† ck åå³ä½¿æ²¡æœ‰ä¸šåŠ¡æ•°æ®å†…å­˜å ç”¨ä¹Ÿéå¸¸é«˜ï¼Œåœ¨æŒç»­åˆ·ä¸‹é¢æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__1::__function::__policy_storage const*) @ 0x8e8379c in /usr/bin/clickhouse</span><br><span class="line">26. ThreadPoolImpl&lt;std::__1::thread&gt;::worker(std::__1::__list_iterator&lt;std::__1::thread, void*&gt;) @ 0x8e7f950 in /usr/bin/clickhouse</span><br><span class="line">27. ? @ 0x8e82844 in /usr/bin/clickhouse</span><br><span class="line">28. start_thread @ 0x7624 in /usr/lib/aarch64-linux-gnu/libpthread-2.31.so</span><br><span class="line">29. ? @ 0xd149c in /usr/lib/aarch64-linux-gnu/libc-2.31.so</span><br><span class="line"> (version 22.8.5.29 (official build))</span><br><span class="line">2025.02.08 16:10:33.504961 [ 54 ] &#123;&#125; &lt;Error&gt; void DB::MergeTreeBackgroundExecutor&lt;DB::MergeMutateRuntimeQueue&gt;::routine(DB::TaskRuntimeDataPtr) [Queue = DB::MergeMutateRuntimeQueue]: Code: 241. DB::Exception: Memory limit (total) exceeded: would use 18.44 GiB (attempt to allocate chunk of 8709611 bytes), maximum: 18.00 GiB. OvercommitTracker decision: Memory overcommit isn&#x27;t used. Waiting time or overcommit denominator are set to zero. (MEMORY_LIMIT_EXCEEDED), Stack trace (when copying this message, always include the lines below):</span><br><span class="line"></span><br><span class="line">0. DB::Exception::Exception(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, int, bool) @ 0x8dcd368 in /usr/bin/clickhouse</span><br><span class="line">1. DB::Exception::Exception&lt;char const*, char const*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, long&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; &gt;(int, fmt::v8::basic_format_string&lt;char, fmt::v8::type_identity&lt;char const*&gt;::type, fmt::v8::type_identity&lt;char const*&gt;::type, fmt::v8::type_identity&lt;std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; &gt;::type, fmt::v8::type_identity&lt;long&amp;&gt;::type, fmt::v8::type_identity&lt;std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; &gt;::type, fmt::v8::type_identity&lt;std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; &gt;::type&gt;, char const*&amp;&amp;, char const*&amp;&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;&amp;&amp;, long&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;&amp;&amp;, std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp;&amp;) @ 0x8dbfe08 in /usr/bin/clickhouse</span><br><span class="line">2. MemoryTracker::allocImpl(long, bool, MemoryTracker*) @ 0x8dbf6d4 in /usr/bin/clickhouse</span><br><span class="line">3. MemoryTracker::allocImpl(long, bool, MemoryTracker*) @ 0x8dbf0f0 in /usr/bin/clickhouse</span><br><span class="line">4. MemoryTracker::allocImpl(long, bool, MemoryTracker*) @ 0x8dbf0f0 in /usr/bin/clickhouse</span><br><span class="line">5. DB::Memory&lt;Allocator&lt;false, false&gt; &gt;::alloc(unsigned long) @ 0x8e26118 in /usr/bin/clickhouse</span><br><span class="line">6. DB::WriteBufferFromFile::WriteBufferFromFile(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned long, int, unsigned int, char*, unsigned long) @ 0x8e46138 in /usr/bin/clickhouse</span><br><span class="line">7. DB::DiskLocal::writeFile(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned long, DB::WriteMode, DB::WriteSettings const&amp;) @ 0x1141bc88 in /usr/bin/clickhouse</span><br><span class="line">8. DB::DataPartStorageBuilderOnDisk::writeFile(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned long, DB::WriteSettings const&amp;) @ 0x1230e6e8 in /usr/bin/clickhouse</span><br><span class="line">9. DB::MergeTreeDataPartWriterOnDisk::Stream::Stream(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::shared_ptr&lt;DB::IDataPartStorageBuilder&gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::shared_ptr&lt;DB::ICompressionCodec&gt; const&amp;, unsigned long, DB::WriteSettings const&amp;) @ 0x12441ef0 in /usr/bin/clickhouse</span><br></pre></td></tr></table></figure><p>æœç´¢äº†çœ‹åˆ°å‡ ä¸ª issue éƒ½å»ºè®®å‡çº§ç‰ˆæœ¬ï¼š</p><ul><li><a href="https://github.com/ClickHouse/ClickHouse/issues/47642">https://github.com/ClickHouse/ClickHouse/issues/47642</a></li><li><a href="https://github.com/ClickHouse/ClickHouse/issues/40215">https://github.com/ClickHouse/ClickHouse/issues/40215</a></li></ul><p>åç»­ä¹Ÿå‘ç°äº†éƒ¨åˆ†å›½äº§ cpu ä¸Šæ— æ³•å¯åŠ¨ï¼Œä½¿ç”¨æœ¬æ–‡ç¼–è¯‘çš„åæ‰å¯ä»¥å¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker logs xxxxx</span></span><br><span class="line">Merging configuration file &#x27;/etc/clickhouse-server/config.d/docker_related_config.xml&#x27;.</span><br><span class="line">Including configuration file &#x27;/etc/metrika.xml&#x27;.</span><br><span class="line">2025.06.25 14:40:21.352040 [ 1 ] &#123;&#125; &lt;Information&gt; : Starting ClickHouse 22.8.5.29 with revision 54465, build id: 30D2CCC2A2FE0DE0, PID 1</span><br><span class="line">2025.06.25 14:40:21.352181 [ 1 ] &#123;&#125; &lt;Information&gt; Application: starting up</span><br><span class="line">2025.06.25 14:40:21.352201 [ 1 ] &#123;&#125; &lt;Information&gt; Application: OS name: Linux, version: 4.19.90-24.4.v2101.ky10.aarch64, architecture: aarch64</span><br><span class="line">2025.06.25 14:40:21.385220 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: ########################################</span><br><span class="line">2025.06.25 14:40:21.385298 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: (version 22.8.5.29 (official build), build id: 30D2CCC2A2FE0DE0) (from thread 1) (no query) Received signal Illegal instruction (4)</span><br><span class="line">2025.06.25 14:40:21.385327 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: Illegal opcode.</span><br><span class="line">2025.06.25 14:40:21.385358 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: Stack trace: 0xaaabccb2b12c 0xfffc5cb307c0</span><br><span class="line">2025.06.25 14:40:21.385459 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: 0. ? @ 0x8fdb12c in /usr/bin/clickhouse</span><br><span class="line">2025.06.25 14:40:21.385562 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: 1. ? @ 0xfffc5cb307c0 in ?</span><br><span class="line">2025.06.25 14:40:21.554513 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: Integrity check of the executable skipped because the reference checksum could not be read. (calculated checksum: 05AC43DEA3E119694BFE830A4D95</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">lscpu</span></span><br><span class="line">æ¶æ„ï¼š                           aarch64</span><br><span class="line">CPU è¿è¡Œæ¨¡å¼ï¼š                   64-bit</span><br><span class="line">å­—èŠ‚åºï¼š                         Little Endian</span><br><span class="line">CPU:                             16</span><br><span class="line">åœ¨çº¿ CPU åˆ—è¡¨ï¼š                  0-15</span><br><span class="line">æ¯ä¸ªæ ¸çš„çº¿ç¨‹æ•°ï¼š                 1</span><br><span class="line">æ¯ä¸ªåº§çš„æ ¸æ•°ï¼š                   1</span><br><span class="line">åº§ï¼š                             16</span><br><span class="line">NUMA èŠ‚ç‚¹ï¼š                      1</span><br><span class="line">å‚å•† IDï¼š                        Phytium</span><br><span class="line">å‹å·ï¼š                           2</span><br><span class="line">å‹å·åç§°ï¼š                       FT-2000+/64</span><br><span class="line">æ­¥è¿›ï¼š                           0x1</span><br><span class="line">BogoMIPSï¼š                       100.00</span><br><span class="line">L1d ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L1i ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L2 ç¼“å­˜ï¼š                        8 MiB</span><br><span class="line">L3 ç¼“å­˜ï¼š                        512 MiB</span><br><span class="line">NUMA èŠ‚ç‚¹0 CPUï¼š                 0-15</span><br><span class="line">Vulnerability Itlb multihit:     Not affected</span><br><span class="line">Vulnerability L1tf:              Not affected</span><br><span class="line">Vulnerability Mds:               Not affected</span><br><span class="line">Vulnerability Meltdown:          Not affected</span><br><span class="line">Vulnerability Spec store bypass: Not affected</span><br><span class="line">Vulnerability Spectre v1:        Mitigation; __user pointer sanitization</span><br><span class="line">Vulnerability Spectre v2:        Not affected</span><br><span class="line">Vulnerability Srbds:             Not affected</span><br><span class="line">Vulnerability Tsx async abort:   Not affected</span><br><span class="line">æ ‡è®°ï¼š                           fp asimd evtstrm crc32 cpuid</span><br></pre></td></tr></table></figure><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="arm64-è¿è¡Œç¯å¢ƒ"><a href="#arm64-è¿è¡Œç¯å¢ƒ" class="headerlink" title="arm64 è¿è¡Œç¯å¢ƒ"></a>arm64 è¿è¡Œç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">æ¶æ„ï¼š                           aarch64</span><br><span class="line">CPU è¿è¡Œæ¨¡å¼ï¼š                   64-bit</span><br><span class="line">å­—èŠ‚åºï¼š                         Little Endian</span><br><span class="line">CPU:                             16</span><br><span class="line">åœ¨çº¿ CPU åˆ—è¡¨ï¼š                  0-15</span><br><span class="line">æ¯ä¸ªæ ¸çš„çº¿ç¨‹æ•°ï¼š                 1</span><br><span class="line">æ¯ä¸ªåº§çš„æ ¸æ•°ï¼š                   1</span><br><span class="line">åº§ï¼š                             16</span><br><span class="line">NUMA èŠ‚ç‚¹ï¼š                      1</span><br><span class="line">å‚å•† IDï¼š                        Phytium</span><br><span class="line">å‹å·ï¼š                           3</span><br><span class="line">å‹å·åç§°ï¼š                       ARMv8 CPU</span><br><span class="line">æ­¥è¿›ï¼š                           0x1</span><br><span class="line">CPU æœ€å¤§ MHzï¼š                   2100.0000</span><br><span class="line">CPU æœ€å° MHzï¼š                   2100.0000</span><br><span class="line">BogoMIPSï¼š                       100.00</span><br><span class="line">L1d ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L1i ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L2 ç¼“å­˜ï¼š                        8 MiB</span><br><span class="line">L3 ç¼“å­˜ï¼š                        512 MiB</span><br><span class="line">NUMA èŠ‚ç‚¹0 CPUï¼š                 0-15</span><br><span class="line">Vulnerability Itlb multihit:     Not affected</span><br><span class="line">Vulnerability L1tf:              Not affected</span><br><span class="line">Vulnerability Mds:               Not affected</span><br><span class="line">Vulnerability Meltdown:          Not affected</span><br><span class="line">Vulnerability Mmio stale data:   Not affected</span><br><span class="line">Vulnerability Spec store bypass: Not affected</span><br><span class="line">Vulnerability Spectre v1:        Mitigation; __user pointer sanitization</span><br><span class="line">Vulnerability Spectre v2:        Not affected</span><br><span class="line">Vulnerability Srbds:             Not affected</span><br><span class="line">Vulnerability Tsx async abort:   Not affected</span><br><span class="line">æ ‡è®°ï¼š                           fp asimd evtstrm aes pmull sha1 sha2 crc32 cpuid</span><br></pre></td></tr></table></figure><h3 id="å‡çº§åèµ·ä¸æ¥"><a href="#å‡çº§åèµ·ä¸æ¥" class="headerlink" title="å‡çº§åèµ·ä¸æ¥"></a>å‡çº§åèµ·ä¸æ¥</h3><p>æ ¹æ® ck <a href="https://clickhouse.com/docs/en/operations/update">å®˜æ–¹ update æ–‡æ¡£</a> é‡Œå¯çŸ¥å®˜æ–¹åŠªåŠ›ä¿æŒä¸€å¹´å…¼å®¹æœŸï¼Œä¸¤ä¸ªç‰ˆæœ¬ä¹‹å‰å·®å¼‚å°äºä¸€å¹´æˆ–è€… LTS ç‰ˆæœ¬å°‘äºä¸¤ä¸ªå¯ä»¥å‡çº§ã€‚è€Œ 23 çš„ LTS ç‰ˆæœ¬æ˜¯ <code>v23.8.16.40-lts</code> ã€‚ç„¶åæ¢äº†é•œåƒåè¿è¡Œä¸èµ·æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/entrypoint.sh: line 40:    23 Illegal instruction     (core dumped) clickhouse extract-from-config --config-file &quot;$CLICKHOUSE_CONFIG&quot; --key=&#x27;storage_configuration.disks.*.path&#x27;</span><br><span class="line">/entrypoint.sh: line 41:    25 Illegal instruction     (core dumped) clickhouse extract-from-config --config-file &quot;$CLICKHOUSE_CONFIG&quot; --key=&#x27;storage_configuration.disks.*.metadata_path&#x27;</span><br></pre></td></tr></table></figure><p>ç„¶åå°è¯•äº†ä¸‹åˆ—ç‰ˆæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">23.5.5.92</span><br><span class="line">23.3.22.3</span><br><span class="line">23.3.9.55</span><br><span class="line">23.3.1</span><br><span class="line">22.12.6.22</span><br><span class="line">22.8.21.38</span><br><span class="line">22.10.7.13</span><br><span class="line">22.10.1</span><br><span class="line">22.9.1.2603</span><br><span class="line">22.9.7.34</span><br></pre></td></tr></table></figure><p>å‘ç° 22.9 æ‰èƒ½å¯åŠ¨ï¼ŒæŸ¥çœ‹ changelog <a href="https://clickhouse.com/docs/en/whats-new/changelog/2022#-clickhouse-release-2210-2022-10-25">https://clickhouse.com/docs/en/whats-new/changelog/2022#-clickhouse-release-2210-2022-10-25</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Aarch64 binaries now require at least ARMv8.2, released in 2016. Most notably, this enables use of ARM LSE, i.e. native atomic operations. \</span><br><span class="line">Also, CMake build option &quot;NO_ARMV81_OR_HIGHER&quot; has been added to allow compilation of binaries for older ARMv8.0 hardware, e.g. Raspberry Pi 4. #41610 (Robert Schulze).</span><br></pre></td></tr></table></figure><p>22.10 å¼€å§‹ä½¿ç”¨ arm LSE æŒ‡ä»¤é›†åšåŸå­æ“ä½œï¼Œä½†æ˜¯è¯¥æŒ‡ä»¤é›† armv8.2 æ‰æœ‰ï¼Œä½†æ˜¯ä¹Ÿåœ¨ Cmake æ·»åŠ äº†é€‰é¡¹ <code>NO_ARMV81_OR_HIGHER</code> å¯¹äº armv8.0 ç¼–è¯‘æ”¯æŒã€‚</p><h3 id="æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£"><a href="#æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£" class="headerlink" title="æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£"></a>æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£</h3><p>å®˜æ–¹è™½ç„¶æ–‡æ¡£å†™å¾—æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æ„Ÿè§‰æ¯”è¾ƒçç¢ã€‚è·Ÿç€å‰é¢ changelog çš„ pr <a href="https://github.com/ClickHouse/ClickHouse/pull/41987">#41987</a> çœ‹äº†ä¸‹å®˜æ–¹æ˜¯ github action ç¼–è¯‘çš„ã€‚github action æ„å»ºå†å²æœ‰ä¸Šé™ï¼Œæ‰¾ pr é‡Œçš„ <code>BuilderBinAarch64V80Compat</code> æ‰¾ä¸åˆ°ï¼Œç„¶ååœ¨æ–°ç‰ˆæœ¬ <code>.github/workflows/master.yml</code> é‡Œæ‰¾åˆ°äº† <code>build_arm_v80compat</code>ã€‚ä½†æ˜¯ç”¨çš„æ˜¯ä¸‹é¢ç¼–è¯‘å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m praktika run &#x27;Build (arm_v80compat)&#x27; --workflow &quot;MasterCI&quot; --ci</span><br></pre></td></tr></table></figure><p><code>praktika</code> è¿™ä¸ª pip ä»“åº“ä¸Šæ‰¾ä¸åˆ°ï¼Œäºæ˜¯æ‰¾åˆ°ç›¸å…³æœ€æ–°çš„ action é‡Œçœ‹ä¸‹å…·ä½“æ€ä¹ˆç¼–è¯‘çš„ï¼Œæ‰¾åˆ°äº†ç›¸å…³æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INFO:root:Pulling image clickhouse/binary-builder:54b46bb22708 - done</span><br><span class="line">INFO:root:Going to run packager with cd /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/docker/packager &amp;&amp; \</span><br><span class="line">  CMAKE_FLAGS=&#x27;-DENABLE_CLICKHOUSE_SELF_EXTRACTING=1&#x27; ./packager \</span><br><span class="line">  --output-dir=/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build \</span><br><span class="line">  --package-type=binary --compiler=clang-19-aarch64-v80compat \</span><br><span class="line">  --cache=sccache --s3-rw-access --s3-bucket=clickhouse-builds \</span><br><span class="line">  --docker-image-version=54b46bb22708 --with-profiler --with-buzzhouse --version=25.2.1.1773 --official</span><br><span class="line"></span><br><span class="line">2025-02-10 22:37:56,547 Will build ClickHouse pkg with cmd: &#x27;docker run --network=host --user=1000:1000 --rm  \</span><br><span class="line">  --volume=/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build:/output \</span><br><span class="line">  --volume=/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse:/build \</span><br><span class="line">   -e OUTPUT_DIR=/output -e DEB_ARCH=arm64 -e CC=clang-19 -e CXX=clang++-19 \</span><br><span class="line">   -e BUILD_TYPE=None -e SCCACHE_BUCKET=clickhouse-builds -e SCCACHE_S3_KEY_PREFIX=ccache/sccache \</span><br><span class="line">   -e VERSION_STRING=&#x27;25.2.1.1773&#x27; \</span><br><span class="line">   -e CMAKE_FLAGS=&quot;$CMAKE_FLAGS -DCMAKE_TOOLCHAIN_FILE=/build/cmake/linux/toolchain-aarch64.cmake \</span><br><span class="line">   -DNO_ARMV81_OR_HIGHER=1 -DCMAKE_C_COMPILER=clang-19 -DCMAKE_CXX_COMPILER=clang++-19 \</span><br><span class="line">   -DCOMPILER_CACHE=sccache -DENABLE_BUILD_PROFILING=1 \</span><br><span class="line">   -DENABLE_BUZZHOUSE=1 -DCLICKHOUSE_OFFICIAL_BUILD=1&quot; \</span><br><span class="line">   -e BUILD_TARGET=&#x27;clickhouse-bundle&#x27; --volume=/home/ubuntu/.cargo/registry:/rust/cargo/registry  \</span><br><span class="line">   clickhouse/binary-builder:54b46bb22708&#x27;</span><br></pre></td></tr></table></figure><p>æœäº†ä¸‹ç›¸å…³æºç ç›¸å…³å…³é”®å­— <code>binary-builder</code>ï¼Œå¤§ä½“äº†è§£äº†ä¸‹å®˜æ–¹ç¼–è¯‘æ­¥éª¤ï¼š</p><ul><li><code>docker/packager</code> ä¸‹æä¾›äº† <code>packager</code> äºŒè¿›åˆ¶(å®é™…æ˜¯pythonè„šæœ¬)æ¥ç¼–è¯‘</li><li><code>docker/packager/binary-builder</code> æ˜¯åˆ©ç”¨ docker æ‰“åŒ…ä¸€ä¸ªé•œåƒï¼Œé‡Œé¢åŒ…å« llvmã€rustã€clang ä¹‹ç±»çš„ç¼–è¯‘ç¯å¢ƒ</li></ul><p>è¯¥å®¹å™¨é•œåƒç”± CI æ„å»ºå®šæœŸæ¨é€åˆ° dockerhub ä¸Šï¼Œç„¶åä¸æƒ³å®¿ä¸»æœºä¸Šå®‰è£…ç¯å¢ƒå¯ä»¥ä½¿ç”¨å®ƒæ¥è¿›è¡Œç¼–è¯‘ï¼Œå…·ä½“å‚æ•°æŸ¥çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd docker/packager</span><br><span class="line">$ packager --help</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p>å¹¶ä¸”å®˜æ–¹æ–‡æ¡£æœ‰ <a href="https://clickhouse.com/docs/en/development/build#building-in-docker">building-in-docker</a> ï¼Œæ‰€ä»¥æ‰“ç®—ä½¿ç”¨å®˜æ–¹çš„ docker é•œåƒæ„å»ºï¼Œæœºå™¨è¦æå‰å®‰è£…å¥½ dockerï¼Œç¡¬ç›˜æœ€å¥½æœ‰ 50G å®¹é‡ï¼Œæºç éå¸¸å¤§ï¼Œè‡ªå¤‡ç¨³å®šçŒ«å’ªä¹‹ç±»çš„ã€‚æ‹‰å–æºç å’Œç¼–è¯‘å…¨ç¨‹å»ºè®®å¼€ä¸ª screen é‡Œæ“ä½œï¼š</p><h4 id="æ‹‰å–æºç "><a href="#æ‹‰å–æºç " class="headerlink" title="æ‹‰å–æºç "></a>æ‹‰å–æºç </h4><p>å› ä¸ºå­æ¨¡å—éå¸¸å¤šï¼Œå»ºè®®ä½¿ç”¨ git2 é¿å…ä¸€äº›å¥‡æ€ªé—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ClickHouse/ClickHouse.git</span><br></pre></td></tr></table></figure><p>åˆ‡åˆ°æŒ‡å®šåˆ†æ”¯å’Œæ‹‰å–å­æ¨¡å—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout v23.8.16.40-lts</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å­æ¨¡å—å®Œæ•´æ€§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line">git submodule status</span><br></pre></td></tr></table></figure><p>ç¡®è®¤æ‹‰å–å®Œæˆåå†å¼€å§‹åé¢æ“ä½œ</p><h4 id="å¤±è´¥çš„ç¼–è¯‘"><a href="#å¤±è´¥çš„ç¼–è¯‘" class="headerlink" title="å¤±è´¥çš„ç¼–è¯‘"></a>å¤±è´¥çš„ç¼–è¯‘</h4><p>æŸ¥çœ‹ <code>docker/packager/packager</code> å†…å®¹ç¼–è¯‘ arm64v8.0 æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./docker/packager</span><br><span class="line">packager --package-type=binary --output-dir=build_results \</span><br><span class="line"> --compiler=clang-16-aarch64-v80compat</span><br></pre></td></tr></table></figure><p>ç„¶åæŠ¥é”™ clang ç‰ˆæœ¬ç›¸å…³ï¼Œé»˜è®¤æ‹‰å–çš„ <code>clickhouse/binary-builder:latest</code>ï¼ŒæŸ¥çœ‹äº†ä¸‹ <code>packager</code> æºç å’Œ <code>--help</code> æœ‰é€‰é¡¹ <code>--docker-image-version</code> æŒ‡å®šé•œåƒ tagï¼Œå» dockerhub ä¸Šæ‰¾äº†ä¸‹ <code>clickhouse/binary-builder</code> çš„ clang 16 ç‰ˆæœ¬ï¼Œå‘ç° tag å¥½åƒæ˜¯ commitid ç›¸å…³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git log -n1</span><br><span class="line">commit e143a9039ba36ad0c25f2ed85503f36e88f61063 (HEAD, tag: v23.8.16.40-lts)</span><br><span class="line">Merge: 8afc5bd5d1c a60c914df11</span><br><span class="line">Author: Antonio Andelic &lt;antonio2368@users.noreply.github.com&gt;</span><br><span class="line">Date:   Thu Jul 25 20:50:17 2024 +0100</span><br><span class="line"></span><br><span class="line">    Merge pull request #66717 from ClickHouse/backport/23.8/66548</span><br><span class="line">    </span><br><span class="line">    Backport #66548 to 23.8: Correctly track memory for `Allocator::realloc`</span><br></pre></td></tr></table></figure><p>æœç´¢äº†ä¸‹ <a href="https://hub.docker.com/r/clickhouse/binary-builder/tags?name=e143a903">e143a903</a> æ‰¾åˆ°äº† tag <code>54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</code>ï¼Œä½†æ˜¯é•œåƒæ¯”è¾ƒå¤§ï¼Œç„¶åç”¨ daoCloud çš„åŒæ­¥äº†ä¸‹ï¼Œæ‹‰å–ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull m.daocloud.io/docker.io/clickhouse/binary-builder:54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br><span class="line">docker tag m.daocloud.io/docker.io/clickhouse/binary-builder:54187-e143a9039ba36ad0c25f2ed85503f36e88f61063 \</span><br><span class="line">        clickhouse/binary-builder:54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br></pre></td></tr></table></figure><p>ç„¶åç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./docker/packager/packager --package-type=binary --compiler=clang-16-aarch64-v80compat  \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br></pre></td></tr></table></figure><p>ç›¸å…³æŠ¥é”™ä¸€ç›´æ— æ³•è§£å†³ï¼Œæäº† <a href="https://github.com/ClickHouse/ClickHouse/issues/75923">issue 75923</a>ï¼Œå®˜æ–¹è¯´è¯¥ç‰ˆæœ¬å·²ç»ä¸ç»´æŠ¤ä¸æä¾›å¸®åŠ©ï¼Œè®©æˆ‘ä¸è¦è‡ªå·±ç¼–è¯‘ï¼Œè€Œæ˜¯å»ä¸‹è½½å®˜æ–¹ç¼–è¯‘çš„ã€‚ä¸‹è½½äº†å½“ç„¶æ˜¯ core dumpã€‚ç„¶åè‡ªå·±æ‰¾äº†ä¸‹å®˜æ–¹ç¼–è¯‘çš„ <code>build_arm_v80compat</code> ï¼Œåªæœ‰ä¸€ä¸ªä¸‹è½½ç›´é“¾ï¼Œä¸å­˜åœ¨è€ç‰ˆæœ¬ï¼Œaction é‡Œå¯ä»¥çœ‹åˆ°ä¸‹è½½é“¾æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2025-02-10 22:46:45,343 Output placed into /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build</span><br><span class="line">INFO:root:Built successfully</span><br><span class="line">INFO:root:Build finished as success, log path /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build_log/build_log.log</span><br><span class="line">INFO:botocore.credentials:Found credentials from IAM Role: ec2_admin</span><br><span class="line">INFO:root:Processing file without compression</span><br><span class="line">INFO:root:File is too large, do not provide content type</span><br><span class="line">INFO:root:Upload /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse to https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse-full Meta: &#123;&#125;</span><br><span class="line">Notice: Binary static URL (with debug info): https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse-full</span><br><span class="line">INFO:root:Processing file without compression</span><br><span class="line">INFO:root:File is too large, do not provide content type</span><br><span class="line">INFO:root:Upload /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse-stripped to https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse Meta: &#123;&#125;</span><br><span class="line">Notice: Binary static URL (compact): https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse</span><br><span class="line">Run action done for: [binary_aarch64_v80compat]</span><br><span class="line">INFO:botocore.credentials:Found credentials from IAM Role: ec2_admin</span><br><span class="line">INFO:root:Get token with 4322 remaining requests</span><br><span class="line">INFO:root:User robot-clickhouse-ci-1 with 4322 remaining requests is used</span><br><span class="line">&#123;&#125;</span><br><span class="line">=== Run script finished ===</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª action é‡Œéƒ½æœ‰é“¾æ¥ï¼Œä½†æ˜¯å¤ªæ—©çš„å°±æ²¡æœ‰äº†ï¼Œå› ä¸º github action åªä¿ç•™ä¸Šé™çš„æ„å»ºå†å²ã€‚çœ‹äº†ä¸‹åº”è¯¥æ˜¯æ„å»ºéƒ½å­˜åœ¨ s3 ä¸Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">=== Post run script [Build (arm_v80compat)], workflow [MasterCI] ===</span><br><span class="line">Job provides s3 artifacts [[Artifact.Config(name=&#x27;CH_ARMV80C_DARWIN_BIN&#x27;, type=&#x27;s3&#x27;, path=&#x27;/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse&#x27;, _provided_by=&#x27;Build (arm_v80compat)&#x27;, _s3_path=&#x27;&#x27;)]]</span><br><span class="line">Run command: [ls -l /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse]</span><br><span class="line">-rwxr-xr-x 1 ubuntu ubuntu 770032980 Feb 10 23:27 /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse</span><br><span class="line">Run command [aws s3 cp /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse s3://clickhouse-builds/REFs/master/57b1cafdcb704280f05ee61345e8fbad9a6af5ed/build_arm_v80compat/clickhouse]</span><br><span class="line">Artifact report enabled and will be uploaded: [&#123;&#x27;build_urls&#x27;: [&#x27;https://clickhouse-builds.s3.amazonaws.com/REFs/master/57b1cafdcb704280f05ee61345e8fbad9a6af5ed/build_arm_v80compat/clickhouse&#x27;]&#125;]</span><br><span class="line">Run command [aws s3 cp ./ci/tmp/artifact_report_build_arm_v80compat.json s3://clickhouse-builds/REFs/master/57b1cafdcb704280f05ee61345e8fbad9a6af5ed/build_arm_v80compat/artifact_report_build_arm_v80compat.json]</span><br><span class="line">Insert results to CIDB</span><br></pre></td></tr></table></figure><p>æ ¹æ®é“¾æ¥è§„åˆ™æ¨æ–­äº†ä¸‹ä¸‹è½½ urlï¼Œå‘ç° 403ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://clickhouse-builds.s3.amazonaws.com/REFs/master/e143a9039ba36ad0c25f2ed85503f36e88f61063/build_arm_v80compat/clickhouse</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶è¯´ v23 ä¸ç»´æŠ¤ï¼Œç„¶åå°è¯•äº† v24 çš„ lts ç‰ˆæœ¬ä¹Ÿä¸€æ ·ï¼Œç›¸å…³æŠ¥é”™ä¹Ÿæäº† <a href="https://github.com/ClickHouse/ClickHouse/issues/75960">issue 75960</a></p><h4 id="æˆåŠŸçš„ç¼–è¯‘"><a href="#æˆåŠŸçš„ç¼–è¯‘" class="headerlink" title="æˆåŠŸçš„ç¼–è¯‘"></a>æˆåŠŸçš„ç¼–è¯‘</h4><p>æŠ¥é”™éƒ½æ˜¯ <code>contrib/sysroot</code> å’Œ <code>contrib/thrift</code> è¿™ä¿©å­æ¨¡å—ï¼Œgithub ä¸Šçœ‹äº†ä¸‹å†å²è®°å½•ï¼Œè¿™ä¿©æ¨¡å—åŸºæœ¬æ²¡æ€ä¹ˆæ›´æ–°åˆ°æ–°ç‰ˆæœ¬ï¼Œæ„Ÿè§‰ä¸æ˜¯æ¨¡å—é—®é¢˜ã€‚æœäº†ä¸€äº›ç›¸å…³ç¼–è¯‘ï¼Œå‘ç°éƒ½æ˜¯ç¼–è¯‘ 22.10 ä¹‹å‰çš„ç‰ˆæœ¬å±…å¤šã€‚éº’éºŸçš„ yum æºé‡Œç‰ˆæœ¬ä¹Ÿæ¯”è¾ƒè€ï¼Œè”ç³»äº†éº’éºŸæœ‰æ²¡æœ‰æ–°ç‰ˆæœ¬ rpm åŒ…ï¼Œç„¶åéº’éºŸå‘äº†ä¸ªæ–°ç‰ˆæœ¬æºç ç¼–è¯‘å®‰è£…çš„æ–‡æ¡£è¿‡æ¥ï¼Œçœ‹äº†ä¸‹æ˜¯åœ¨ arm64 ä¸Šç¼–è¯‘çš„ 25 ç‰ˆæœ¬ï¼Œå¤§ä½“æ­¥éª¤ä¸ºï¼š</p><ul><li>rpm åŒ…å®‰è£… cmake 3.26</li><li>ç¼–è¯‘å®‰è£… gcc-11.3.0 å¹¶æ¢ std åº“</li><li>ç¼–è¯‘å®‰è£… clang-18.1.0</li><li>ç¼–è¯‘å®‰è£… llvm-18.1.0</li><li>å®‰è£… rust 1.80.0</li><li>å®‰è£… ccache src.rpm</li><li>å£°æ˜ CC&#x3D;clang CXX&#x3D;clang++ å<ul><li><code>mkdir build &amp;&amp; cd build</code></li><li><code>cmake .. -DCMAKE_INSTALL_PREFIX=/opt/clickhouse-bin -DNO_ARMV81_OR_HIGHER=1</code></li><li><code>ninja -j32</code></li><li><code>ninja install</code></li></ul></li></ul><p>æ ¹æ®ç¼–è¯‘ç›¸å…³ï¼Œ<code>packager</code> çš„ <code>--compiler=clang-16-aarch64-v80compat</code> ç›¸å…³é€»è¾‘ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ARM_V80COMPAT_SUFFIX = <span class="string">&quot;-aarch64-v80compat&quot;</span></span><br><span class="line">...</span><br><span class="line">is_cross_arm_v80compat = compiler.endswith(ARM_V80COMPAT_SUFFIX)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">elif</span> is_cross_arm_v80compat:</span><br><span class="line">        cc = compiler[: -<span class="built_in">len</span>(ARM_V80COMPAT_SUFFIX)]</span><br><span class="line">        cmake_flags.append(</span><br><span class="line">            <span class="string">&quot;-DCMAKE_TOOLCHAIN_FILE=/build/cmake/linux/toolchain-aarch64.cmake&quot;</span></span><br><span class="line">        )</span><br><span class="line">        cmake_flags.append(<span class="string">&quot;-DNO_ARMV81_OR_HIGHER=1&quot;</span>)</span><br><span class="line">        result.append(<span class="string">&quot;DEB_ARCH=arm64&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>-DNO_ARMV81_OR_HIGHER=1</code> æ˜¯å¿…å¡«çš„ï¼Œè€Œæ’å…¥çš„ <code>-DCMAKE_TOOLCHAIN_FILE</code> åˆ™æ˜¯é…ç½®ä½¿ç”¨äº¤å‰ç¼–è¯‘å·¥å…·é“¾ã€‚äº¤å‰ç¼–è¯‘ä¸€ç›´å¤±è´¥ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ arm64 æœºå™¨ä¸Šå’Œéº’éºŸé‚£æ ·æºç ç¼–è¯‘ clang ç­‰ç›¸å…³å†å°è¯•ç¼–è¯‘ ckï¼Œä½†æ˜¯æ–°å¼€çš„éº’éºŸ arm64 æœºå™¨ä¸Šæ²¡çŒ«å’ª gcc å’Œ llvm ä¸‹è½½éå¸¸æ…¢ã€‚å°±åŒæ­¥çœ‹äº†ä¸‹ <code>clickhouse/binary-builder</code> å‘ç°è¿˜æä¾›äº† arm64 çš„é•œåƒï¼Œæƒ³ç€ç›´æ¥ arm64 ä¸Šä¸æŒ‡å®š <code>ARM_V80COMPAT_SUFFIX</code> é‚£å°±ä¼šç”¨å†…ç½®çš„ arm64 gcc äº†ï¼Œç„¶åå†æŒ‡å®š <code>-DNO_ARMV81_OR_HIGHER=1</code> ç¼–è¯‘é€‰é¡¹é‚£å°±å’Œéº’éºŸä¸€æ ·äº†ã€‚å’Œä¹‹å‰ä¸€æ ·æ‰¾äº†ä¸ªé«˜é…ç½® arm64 æœºå™¨ä¸Šï¼š</p><ul><li>æ‹‰æºç ï¼Œè¿›å» checkout åˆ° <code>v23.8.16.40-lts</code>ï¼Œæ‹‰å–å­æ¨¡å—æºç </li><li>æ‹‰å–å¯¹åº”çš„ <code>clickhouse/binary-builder</code> å¹¶ tag</li></ul><p>æŸ¥çœ‹è„šæœ¬å¾—åˆ°ç¼–è¯‘å‘½ä»¤å’Œé€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_FLAGS=<span class="string">&#x27;-DNO_ARMV81_OR_HIGHER=1&#x27;</span> ./docker/packager/packager --package-type=binary \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåç»ˆäºæ²¡å¡åœ¨ <code>contrib/sysroot</code> å’Œ <code>contrib/thrift</code> äº†ï¼Œä½†æ˜¯æœ€åæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Feb 12 08:22:09 [3590/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/SubtargetFeatureInfo.cpp.o</span><br><span class="line">Feb 12 08:22:10 [3591/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/CompressInstEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:10 [3592/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/X86DisassemblerTables.cpp.o</span><br><span class="line">Feb 12 08:22:10 [3593/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/CodeExpander.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3594/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagEdge.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3595/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/WebAssemblyDisassemblerEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3596/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/X86RecognizableInstr.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3596/10884] cd /build/build_docker/rust/skim &amp;&amp; /usr/bin/cmake -E make_directory /build/build_docker/rust/skim/RelWithDebInfo &amp;&amp; /usr/bin/cmake -E env CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=/usr/bin/clang++-16 CC_aarch64-unknown-linux-gnu=/usr/bin/clang-16 HOST_CC=/usr/bin/clang-16 CXX_aarch64-unknown-linux-gnu=/usr/bin/clang++-16 HOST_CXX=/usr/bin/clang++-16 CORROSION_BUILD_DIR=/build/build_docker/rust/skim CARGO_BUILD_RUSTC=/rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/rustc /rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/cargo rustc --target=aarch64-unknown-linux-gnu --package _ch_rust_skim_rust --manifest-path /build/build_docker/rust/skim/Cargo.toml --target-dir /build/build_docker/RelWithDebInfo/cargo/build --profile=release -- -Cdefault-linker-libraries=no -Clink-args=--target=aarch64-linux-gnu &amp;&amp; /usr/bin/cmake -E copy_if_different /build/build_docker/RelWithDebInfo/cargo/build/aarch64-unknown-linux-gnu/release/lib_ch_rust_skim_rust.a /build/build_docker/rust/skim/RelWithDebInfo</span><br><span class="line">Feb 12 08:22:11 error: package `cxx v1.0.140` cannot be built because it requires rustc 1.73 or newer, while the currently active rustc version is 1.72.0-nightly</span><br><span class="line">Feb 12 08:22:11 Either upgrade to rustc 1.73 or newer, or use</span><br><span class="line">Feb 12 08:22:11 cargo update -p cxx@1.0.140 --precise ver</span><br><span class="line">Feb 12 08:22:11 where `ver` is the latest version of `cxx` supporting rustc 1.72.0-nightly</span><br><span class="line">Feb 12 08:22:12 [3600/10884] Linking CXX static library contrib/ulid-c-cmake/lib_ulid.a</span><br><span class="line">Feb 12 08:22:12 FAILED: rust/skim/CMakeFiles/cargo-build__ch_rust_skim_rust rust/skim/RelWithDebInfo/lib_ch_rust_skim_rust.a /build/build_docker/rust/skim/CMakeFiles/cargo-build__ch_rust_skim_rust /build/build_docker/rust/skim/RelWithDebInfo/lib_ch_rust_skim_rust.a </span><br><span class="line">Feb 12 08:22:12 cd /build/build_docker/rust/skim &amp;&amp; /usr/bin/cmake -E make_directory /build/build_docker/rust/skim/RelWithDebInfo &amp;&amp; /usr/bin/cmake -E env CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=/usr/bin/clang++-16 CC_aarch64-unknown-linux-gnu=/usr/bin/clang-16 HOST_CC=/usr/bin/clang-16 CXX_aarch64-unknown-linux-gnu=/usr/bin/clang++-16 HOST_CXX=/usr/bin/clang++-16 CORROSION_BUILD_DIR=/build/build_docker/rust/skim CARGO_BUILD_RUSTC=/rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/rustc /rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/cargo rustc --target=aarch64-unknown-linux-gnu --package _ch_rust_skim_rust --manifest-path /build/build_docker/rust/skim/Cargo.toml --target-dir /build/build_docker/RelWithDebInfo/cargo/build --profile=release -- -Cdefault-linker-libraries=no -Clink-args=--target=aarch64-linux-gnu &amp;&amp; /usr/bin/cmake -E copy_if_different /build/build_docker/RelWithDebInfo/cargo/build/aarch64-unknown-linux-gnu/release/lib_ch_rust_skim_rust.a /build/build_docker/rust/skim/RelWithDebInfo</span><br><span class="line">Feb 12 08:22:12 [3602/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/SearchableTableEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3603/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/CTagsEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3604/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/VarLenCodeEmitterGen.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3605/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/InstrInfoEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3606/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagOperands.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3607/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagInstr.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3608/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDag.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3609/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/X86FoldTablesEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3610/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagPredicateDependencyEdge.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3611/10884] Building CXX object contrib/llvm-project/llvm/lib/BinaryFormat/CMakeFiles/LLVMBinaryFormat.dir/COFF.cpp.o</span><br><span class="line">Feb 12 08:22:13 [3612/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagPredicate.cpp.o</span><br><span class="line">Feb 12 08:22:13 [3613/10884] Building CXX object contrib/llvm-project/llvm/lib/BinaryFormat/CMakeFiles/LLVMBinaryFormat.dir/AMDGPUMetadataVerifier.cpp.o</span><br><span class="line">Feb 12 08:22:14 [3614/10884] Building CXX object contrib/llvm-project/llvm/lib/BinaryFormat/CMakeFiles/LLVMBinaryFormat.dir/Dwarf.cpp.o</span><br><span class="line">Feb 12 08:22:15 [3615/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/SubtargetEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:18 [3616/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/RegisterInfoEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:19 [3617/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchTree.cpp.o</span><br><span class="line">Feb 12 08:22:24 [3618/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/GlobalISelEmitter.cpp.o</span><br></pre></td></tr></table></figure><p>æŠ¥é”™è¯´ rust ç‰ˆæœ¬ 1.72 ä½äº†ï¼Œè¦æ±‚ 1.73ï¼Œæœäº†ä¸‹ <code>nightly-2023-07-04</code> æœä¸åˆ°æœ‰ç”¨çš„ï¼Œ<code>nightly</code> æ˜¯æ¯æ—¥å‘è¡Œç‰ˆæœ¬ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„ <code>1.73</code> æ˜¯å•¥æ—¥æœŸã€‚å¦‚æœç›´æ¥ä½¿ç”¨æ–°ç‰ˆæœ¬ <code>binary-builder</code> ï¼Œé‡Œé¢çš„ clang å’Œè¦ç¼–è¯‘çš„ ck ç‰ˆæœ¬å¯¹ä¸ä¸Šï¼Œäºæ˜¯æ ¹æ® <code>clickhouse/binary-builder</code> çš„ Dockerfile æ‰¾äº†ä¸‹ rust çš„ä¸´è¿‘æ›´æ–°æ˜¯ <code>nightly-2024-12-01</code>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl https://sh.rustup.rs -sSf | bash -s -- -y &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 777 -R /rust &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup toolchain install nightly-2024-12-01 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup default nightly-2024-12-01 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup toolchain remove stable &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup component add rust-src &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup target add x86_64-unknown-linux-gnu &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup target add aarch64-unknown-linux-gnu &amp;&amp; \</span></span><br></pre></td></tr></table></figure><p>å‰é¢ç¼–è¯‘æŠ¥é”™ç»“å°¾ä¼šæœ‰ä¸€ä¸ª <code>docker run ...</code> å®Œæ•´å‘½ä»¤ï¼Œç»“å°¾åŠ ä¸€ä¸ª <code>bash</code> run èµ·æ¥åå†…éƒ¨å‡çº§ä¸‹ rust å°è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®°å¾—ä¾æ—§ä½¿ç”¨ screen</span></span><br><span class="line">docker run .... bash</span><br><span class="line"><span class="comment"># export RUSTUP_DIST_SERVER=https://mirrors.tuna.tsinghua.edu.cn/rustup # æ²¡æœ‰ä¸‹é¢çš„nightly</span></span><br><span class="line">rustup toolchain install nightly-2024-12-01</span><br><span class="line">rustup default nightly-2024-12-01</span><br><span class="line">rustup component add rust-src <span class="comment">#&lt;--- ä¼¼ä¹æ²¡å¿…è¦æ‰§è¡Œ</span></span><br><span class="line">rustup target add aarch64-unknown-linux-gnu <span class="comment">#&lt;--- ä¼¼ä¹æ²¡å¿…è¦æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>å®é™… <code>clickhouse/binary-builder</code> å’Œ å®ƒçš„ Dockerfile CMD éƒ½æ˜¯æ‰§è¡Œï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;bash&quot;</span> <span class="string">&quot;-c&quot;</span> <span class="string">&quot;/build.sh 2&gt;&amp;1&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¸Šé¢çš„å®¹å™¨é‡Œç»§ç»­æ‰§è¡Œ <code>bash /build.sh</code> å°±å¯ä»¥ç¼–è¯‘äº†ï¼Œæœ€åç¼–è¯‘å‡ºæ¥ 2.9G å¤§å°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Feb 12 10:39:51 Average compiler                  0.000 s</span><br><span class="line">Feb 12 10:39:51 Average cache read hit            0.000 s</span><br><span class="line">Feb 12 10:39:51 Failed distributed compilations       0</span><br><span class="line">Feb 12 10:39:51 Cache location                  Local disk: &quot;/root/.cache/sccache&quot;</span><br><span class="line">Feb 12 10:39:51 Version (client)                0.5.4</span><br><span class="line">Feb 12 10:39:51 + ccache --evict-older-than 1d</span><br><span class="line">Feb 12 10:39:51 + &#x27;[&#x27; &#x27;&#x27; == 1 &#x27;]&#x27;</span><br><span class="line">Feb 12 10:39:51 + &#x27;[&#x27; -n &#x27;&#x27; &#x27;]&#x27;</span><br><span class="line">Feb 12 10:39:51 + ls -l /output</span><br><span class="line">Feb 12 10:39:51 total 6200956</span><br><span class="line">Feb 12 10:39:51 -rwxr-xr-x 1 root root 3336977696 Feb 12 10:39 clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-benchmark -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-client -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-compressor -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-copier -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-disks -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-extract-from-config -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-format -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-git-import -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-keeper -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-keeper-client -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-keeper-converter -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-local -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-obfuscator -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-server -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-static-files-disk-uploader -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-su -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 -rwxr-xr-x 1 root root 3012799232 Feb 12 10:39 unit_tests_dbms</span><br></pre></td></tr></table></figure><p>ç„¶ååŠ ä¸€äº›é€‰é¡¹ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_FLAGS=<span class="string">&#x27;-DNO_ARMV81_OR_HIGHER=1 -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTS=OFF -DENABLE_DEBUG=OFF -DSPLIT_DEBUG_SYMBOLS=ON&#x27;</span> \</span><br><span class="line">  ./docker/packager/packager --package-type=binary \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Feb 13 01:24:21 Failed distributed compilations       0</span><br><span class="line">Feb 13 01:24:21 Cache location                  Local disk: &quot;/root/.cache/sccache&quot;</span><br><span class="line">Feb 13 01:24:21 Version (client)                0.5.4</span><br><span class="line">Feb 13 01:24:21 + ccache --evict-older-than 1d</span><br><span class="line">Feb 13 01:24:21 + &#x27;[&#x27; &#x27;&#x27; == 1 &#x27;]&#x27;</span><br><span class="line">Feb 13 01:24:21 + &#x27;[&#x27; -n &#x27;&#x27; &#x27;]&#x27;</span><br><span class="line">Feb 13 01:24:21 + ls -l /output</span><br><span class="line">Feb 13 01:24:21 total 680996</span><br><span class="line">Feb 13 01:24:21 -rwxr-xr-x 1 root root 697336944 Feb 13 01:24 clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-benchmark -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-client -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-compressor -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-copier -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-disks -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-extract-from-config -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-format -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-git-import -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-keeper -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-keeper-client -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-keeper-converter -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-local -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-obfuscator -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-server -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-static-files-disk-uploader -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-su -&gt; clickhouse</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ–‡ä»¶æ‰“åŒ…ï¼Œç„¶å core dump æœºå™¨ä¸Šæµ‹è¯•ä¸‹æ²¡é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./clickhouse <span class="built_in">local</span> -q <span class="string">&#x27;select 1&#x27;</span></span><br><span class="line">1</span><br><span class="line">./clickhouse-server --version</span><br><span class="line">ClickHouse server version 23.8.16.1.</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç‰ˆæœ¬æœ‰é—®é¢˜ä¸æ˜¯ <code>23.8.16.40</code>ï¼Œæ‰¾ä¸‹å‘ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ find . -type f -exec grep -wl 23.8.16.1 &#123;&#125; \; </span><br><span class="line">./cmake/autogenerated_versions.txt</span><br><span class="line">^C</span><br><span class="line">$ cat cmake/autogenerated_versions.txt </span><br><span class="line"># This variables autochanged by tests/ci/version_helper.py:</span><br><span class="line"></span><br><span class="line"># NOTE: VERSION_REVISION has nothing common with DBMS_TCP_PROTOCOL_VERSION,</span><br><span class="line"># only DBMS_TCP_PROTOCOL_VERSION should be incremented on protocol changes.</span><br><span class="line">SET(VERSION_REVISION 54477)</span><br><span class="line">SET(VERSION_MAJOR 23)</span><br><span class="line">SET(VERSION_MINOR 8)</span><br><span class="line">SET(VERSION_PATCH 16)</span><br><span class="line">SET(VERSION_GITHASH 060ff8e813a4a16a540063127f8c91e2108d9adf)</span><br><span class="line">SET(VERSION_DESCRIBE v23.8.16.1-lts)</span><br><span class="line">SET(VERSION_STRING 23.8.16.1)</span><br><span class="line"># end of autochange</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ€åæ„å»ºè„šæœ¬é‡Œ <code>docker/packager/packager</code> çœ‹åˆ°æœ‰:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> with_coverage:</span><br><span class="line">        cmake_flags.append(<span class="string">&quot;-DWITH_COVERAGE=1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> version:</span><br><span class="line">        result.append(<span class="string">f&quot;VERSION_STRING=&#x27;<span class="subst">&#123;version&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    env_prepared = parse_env_variables(</span><br><span class="line">...</span><br><span class="line">        args.version,</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å‰é¢çš„ç¼–è¯‘é€‰é¡¹åŠ ä¸Š <code>args.version</code> ï¼Œæµ‹è¯•äº†ä¸‹å‘ç°è¿˜æ˜¯ä¸è¡Œï¼Œå°±ä¿®æ”¹ <code>cmake/autogenerated_versions.txt</code> æ‰å¯ä»¥ï¼Œå®Œæ•´ç¼–è¯‘æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vi cmake/autogenerated_versions.txt </span><br><span class="line"><span class="built_in">export</span> CMAKE_FLAGS=<span class="string">&#x27;-DNO_ARMV81_OR_HIGHER=1 -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTS=OFF -DENABLE_DEBUG=OFF -DSPLIT_DEBUG_SYMBOLS=ON -DRust_TOOLCHAIN=nightly-2024-12-01 -DCLICKHOUSE_OFFICIAL_BUILD=ON&#x27;</span></span><br><span class="line"></span><br><span class="line">./docker/packager/packager --package-type=binary \</span><br><span class="line">  --version 23.8.16.40 \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br><span class="line"><span class="comment"># ç­‰æŠ¥é”™ï¼Œèµ‹å€¼docker run</span></span><br><span class="line">docker run .... bash</span><br><span class="line"><span class="comment"># export RUSTUP_DIST_SERVER=https://mirrors.tuna.tsinghua.edu.cn/rustup # æ²¡æœ‰ä¸‹é¢çš„nightly</span></span><br><span class="line">rustup toolchain install nightly-2024-12-01</span><br><span class="line">rustup default nightly-2024-12-01</span><br><span class="line">bash /build.sh</span><br></pre></td></tr></table></figure><p>ä¸Šé¢é€‰é¡¹ <code>Rust_TOOLCHAIN=nightly-2024-12-01</code> æ˜¯å› ä¸ºæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">info: This is the version for the rustup toolchain manager, not the rustc compiler.</span><br><span class="line">info: The currently active `rustc` version is `rustc 1.85.0-nightly (7442931d4 2024-11-30)`</span><br><span class="line">-- Rust Toolchain: </span><br><span class="line">Could not find toolchain &#x27;&#x27;</span><br><span class="line">Available toolchains:</span><br><span class="line">  nightly-2023-07-04-aarch64-unknown-linux-gnu</span><br><span class="line">  nightly-2024-12-01-aarch64-unknown-linux-gnu</span><br></pre></td></tr></table></figure><p>find grep äº†ä¸‹æ‰¾åˆ°æ˜¯ <a href="https://github.com/corrosion-rs/corrosion/blob/d9dfdefaa3d9ec4ba1245c7070727359c65c7869/cmake/FindRust.cmake#L140">corrosion-rs&#x2F;corrosion&#x2F;cmake&#x2F;FindRust.cmake</a></p><h3 id="æ‰“åŒ…-Docker-é•œåƒ"><a href="#æ‰“åŒ…-Docker-é•œåƒ" class="headerlink" title="æ‰“åŒ… Docker é•œåƒ"></a>æ‰“åŒ… Docker é•œåƒ</h3><p>æ ¹æ® <code>docker histort --no-trunc</code> ç¡®è®¤äº† Dockerfile æ˜¯ç”¨çš„ <a href="https://github.com/ClickHouse/ClickHouse/blob/v23.8.16.40-lts/docker/server/Dockerfile.ubuntu">docker&#x2F;server&#x2F;Dockerfile.ubuntu</a>ï¼Œä½†æ˜¯ç¼–è¯‘çš„é•œåƒæ˜¯åŸºäº ubuntu:22.04 çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/os-release </span></span><br><span class="line">PRETTY_NAME=<span class="string">&quot;Ubuntu 22.04.4 LTS&quot;</span></span><br><span class="line">NAME=<span class="string">&quot;Ubuntu&quot;</span></span><br><span class="line">VERSION_ID=<span class="string">&quot;22.04&quot;</span></span><br><span class="line">VERSION=<span class="string">&quot;22.04.4 LTS (Jammy Jellyfish)&quot;</span></span><br><span class="line">VERSION_CODENAME=jammy</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">HOME_URL=<span class="string">&quot;https://www.ubuntu.com/&quot;</span></span><br><span class="line">SUPPORT_URL=<span class="string">&quot;https://help.ubuntu.com/&quot;</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span></span><br><span class="line">PRIVACY_POLICY_URL=<span class="string">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span></span><br><span class="line">UBUNTU_CODENAME=jammy</span><br></pre></td></tr></table></figure><p>é¿å…æ„å¤–å’Œ CVEï¼Œè¿˜æ˜¯ç”¨ <code>ubuntu:22.04</code> ç¨³å¦¥äº›ï¼Œå‚è€ƒäº†ä¸‹æœ€æ–°çš„ master åˆ†æ”¯ä¸Šçš„ 22.04 æ•´äº†ä¸‹ <code>docker/server/Dockerfile.fix</code>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">22.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># see https://github.com/moby/moby/issues/4032#issuecomment-192327844</span></span><br><span class="line"><span class="comment"># It could be removed after we move on a version 23:04+</span></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="comment"># ARG for quick switch to a given ubuntu mirror</span></span><br><span class="line"><span class="keyword">ARG</span> apt_archive=<span class="string">&quot;http://archive.ubuntu.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We shouldn&#x27;t use `apt upgrade` to not change the upstream image. It&#x27;s updated biweekly</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># user/group precreated explicitly with fixed uid/gid on purpose.</span></span><br><span class="line"><span class="comment"># It is especially important for rootless containers: in that case entrypoint</span></span><br><span class="line"><span class="comment"># can&#x27;t do chown and owners of mounted volumes should be configured externally.</span></span><br><span class="line"><span class="comment"># We do that in advance at the begining of Dockerfile before any packages will be</span></span><br><span class="line"><span class="comment"># installed to prevent picking those uid / gid by some unrelated software.</span></span><br><span class="line"><span class="comment"># The same uid / gid (101) is used both for alpine and ubuntu.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&quot;s|http://archive.ubuntu.com|<span class="variable">$&#123;apt_archive&#125;</span>|g&quot;</span> /etc/apt/sources.list \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; groupadd -r clickhouse --gid=101 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; useradd -r -g clickhouse --uid=101 --home-dir=/var/lib/clickhouse --shell=/bin/bash clickhouse \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install --<span class="built_in">yes</span> --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">        ca-certificates \</span></span><br><span class="line"><span class="language-bash">        locales \</span></span><br><span class="line"><span class="language-bash">        tzdata \</span></span><br><span class="line"><span class="language-bash">        wget \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/* /var/cache/debconf /tmp/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> VERSION=<span class="string">&quot;23.8.16.40&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> single_binary_location_url=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install from a single binary</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;single_binary_location_url&#125;</span>&quot;</span> ]; <span class="keyword">then</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="built_in">echo</span> <span class="string">&quot;installing from single binary url: <span class="variable">$&#123;single_binary_location_url&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">rm</span> -rf /tmp/clickhouse_binary \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">mkdir</span> -p /tmp/clickhouse_binary \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; wget --progress=bar:force:noscroll <span class="string">&quot;<span class="variable">$&#123;single_binary_location_url&#125;</span>&quot;</span> -O /tmp/clickhouse_binary/clickhouse \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">chmod</span> +x /tmp/clickhouse_binary/clickhouse \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; /tmp/clickhouse_binary/clickhouse install --user <span class="string">&quot;clickhouse&quot;</span> --group <span class="string">&quot;clickhouse&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">rm</span> -rf /tmp/* ; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">fi</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The rest is the same in the official docker and in our build system</span></span><br><span class="line"><span class="comment">#docker-official-library:on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># post install</span></span><br><span class="line"><span class="comment"># we need to allow &quot;others&quot; access to clickhouse folder, because docker container</span></span><br><span class="line"><span class="comment"># can be started with arbitrary uid (openshift usecase)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> clickhouse-local -q <span class="string">&#x27;SELECT * FROM system.build_options&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mkdir</span> -p /var/lib/clickhouse /var/log/clickhouse-server /etc/clickhouse-server /etc/clickhouse-client \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> ugo+Xrw -R /var/lib/clickhouse /var/log/clickhouse-server /etc/clickhouse-server /etc/clickhouse-client</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> locale-gen en_US.UTF-8</span></span><br><span class="line"><span class="keyword">ENV</span> LANG=en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=UTC</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /docker-entrypoint-initdb.d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker_related_config.xml /etc/clickhouse-server/config.d/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> entrypoint.sh /entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">9000</span> <span class="number">8123</span> <span class="number">9009</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /var/lib/clickhouse</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> CLICKHOUSE_CONFIG=/etc/clickhouse-server/config.xml</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥æ‹·è´äºŒè¿›åˆ¶è¿›å»æ‰§è¡Œ clickhouse install ä¼šé€ æˆ overlay diff æµªè´¹ï¼Œæ‰€ä»¥éœ€è¦èµ·ä¸€ä¸ª web ä¸‹è½½ï¼Œç¼–è¯‘å®¹å™¨é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RANDOM_PORT=50358</span><br><span class="line">docker run -d --name ck -v <span class="variable">$PWD</span>/build_results:/usr/share/nginx/html/ \</span><br><span class="line">    -p 50358:80 \</span><br><span class="line">    m.daocloud.io/docker.io/library/nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> docker/server/</span><br><span class="line">docker build . --build-arg VERSION=<span class="string">&quot;23.8.16.40&quot;</span> --network host \</span><br><span class="line">  --build-arg single_binary_location_url=http://127.0.0.1:50358/clickhouse \</span><br><span class="line">   -t clickhouse/clickhouse-server:23.8.16.40 -f Dockerfile.fix</span><br></pre></td></tr></table></figure><h3 id="ä¸€äº›å…¶ä»–ä¿¡æ¯"><a href="#ä¸€äº›å…¶ä»–ä¿¡æ¯" class="headerlink" title="ä¸€äº›å…¶ä»–ä¿¡æ¯"></a>ä¸€äº›å…¶ä»–ä¿¡æ¯</h3><p><code>clickhouse/binary-builder</code> æ–°ç‰ˆæœ¬çš„ tag ä¼¼ä¹ä¸æ˜¯ commidID äº†ï¼Œæ‰¾äº†ä¸‹ä¸€äº›ç‰ˆæœ¬ tag å’Œ clang å¯¹åº”ï¼š</p><ul><li>dd5e777b6745 18</li><li>54187-e143a9039ba36ad0c25f2ed85503f36e88f61063 16</li></ul><p>å®˜æ–¹å’Œç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ file ä¿¡æ¯å¯¹æ¯”ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, <span class="keyword">for</span> GNU/Linux 3.7.0, BuildID[sha1]=3e70066de2db0f08f97ca310827184d61111dc22, not stripped</span><br><span class="line">clickhouse: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked (uses shared libs), <span class="keyword">for</span> GNU/Linux 3.7.0, BuildID[sha1]=586fe5a059c988b60f99dcd794e68f0e4cf69619, not stripped</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢å…¶ä»–ç‰ˆæœ¬çš„æ—¶å€™è¦å¤„ç†ä¸‹å­æ¨¡å—ï¼Œç›¸å…³å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --recursive --checkout</span><br><span class="line"></span><br><span class="line">git submodule foreach --recursive git reset --hard</span><br><span class="line">git submodule update  --recursive</span><br></pre></td></tr></table></figure><p>åˆ‡ç‰ˆæœ¬è¿˜è¦è®°å¾—æ¸…ç† <code>build_docker</code> ç›®å½•</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>å…¶å®ä¹Ÿæ²¡å‚è€ƒå¤šå°‘ï¼Œå°±æ˜¯è¿™äº›æ˜¯èƒ½æœåˆ°çš„ arm64 ç¼–è¯‘ç›¸å…³</p><ul><li><a href="https://clickhouse.com/docs/en/development/build#building-in-docker">https://clickhouse.com/docs/en/development/build#building-in-docker</a></li><li><a href="http://www.shadow-li.com.cn/kunpeng/">http://www.shadow-li.com.cn/kunpeng/</a></li><li><a href="https://blog.csdn.net/pzz490/article/details/103574403">https://blog.csdn.net/pzz490/article/details/103574403</a></li><li><a href="https://www.bookstack.cn/read/clickhouse-20.3-en/a6fe877844d4f2ad.md">https://www.bookstack.cn/read/clickhouse-20.3-en/a6fe877844d4f2ad.md</a></li><li><a href="https://programmersought.com/article/22059609594/">https://programmersought.com/article/22059609594/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;clickhouse å®˜æ–¹ docker é•œåƒæ— æ³•åœ¨è€çš„ arm64 cpu ä¸Šè¿è¡Œï¼Œéœ€è¦ç¼–è¯‘&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="clickhouse" scheme="http://zhangguanzhang.github.io/tags/clickhouse/"/>
    
    <category term="arm64" scheme="http://zhangguanzhang.github.io/tags/arm64/"/>
    
  </entry>
  
  <entry>
    <title>docker login hang</title>
    <link href="http://zhangguanzhang.github.io/2025/01/08/docker-login-hang/"/>
    <id>http://zhangguanzhang.github.io/2025/01/08/docker-login-hang/</id>
    <published>2025-01-08T17:10:30.000Z</published>
    <updated>2025-01-08T17:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>docker login å’Œ pod æ‹‰å–é•œåƒéå¸¸æ…¢çš„æ’æŸ¥</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ç°åœºå®¢æˆ·å•æœºæµ‹è¯•ç¯å¢ƒï¼Œåé¦ˆ docker login å’Œ docker pull å’Œ pod æ‹‰å–é•œåƒéå¸¸æ…¢ï¼Œç°åœºå¤§è‡´æŸ¥äº†ä¸‹æŸ¥ä¸å‡ºæ¥åæˆ‘ä¸Šå»è¿œç¨‹æŸ¥äº†ä¸‹ã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p>æˆ‘ä»¬ç§æœ‰åŒ–éƒ½ä¼šéƒ¨ç½²ä¸€ä¸ªé•œåƒä»“åº“çš„ï¼Œé•œåƒéƒ½æ¨é€åˆ°ä»“åº“ä¸Šï¼Œç°åœºè¯´æ‹‰å–é•œåƒå¾ˆæ…¢å’Œ docker login å¾ˆæ…¢</p><h3 id="ç¯å¢ƒä¿¡æ¯"><a href="#ç¯å¢ƒä¿¡æ¯" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/redhat-release </span><br><span class="line">Red Hat Enterprise Linux Server release 7.8 (Maipo)</span><br><span class="line">$ uname -a</span><br><span class="line">Linux poc-xxxx 3.10.0-1127.el7.x86_64 #1 SMP Tue Feb 18 16:39:12 EST 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><h3 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>ä¸Šå»çœ‹äº†ä¸‹ï¼Œlogin éå¸¸æ…¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u xxx -p xxxx reg.xxx.lan:5000</span><br></pre></td></tr></table></figure><p>strace çœ‹çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ strace docker login -u xxx -p xxxx reg.xxx.lan:5000</span><br><span class="line">...</span><br><span class="line">write(3, &quot;HEAD /_ping HTTP/1.1\r\nHost: api.&quot;..., 92) = 92</span><br><span class="line">futex(0xc000700148, FUTEX_WAKE_PRIVATE, 1) = 1</span><br><span class="line">futex(0x1ac5448, FUTEX_WAIT_PRIVATE, 0, NULLWARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">) = 0</span><br><span class="line">futex(0x1ac5448, FUTEX_WAIT_PRIVATE, 0, NULL) = 0</span><br><span class="line">futex(0x1ac5448, FUTEX_WAIT_PRIVATE, 0, NULL) = 0</span><br></pre></td></tr></table></figure><p>å‘ç°å¡åœ¨ä¸Šé¢ï¼Œä½†æ˜¯ curl å‘ä¸‹ HEAD è¯·æ±‚æ­£å¸¸ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -v reg.xxx.lan:5000/_ping -I</span></span><br><span class="line">* About to connect() to reg.xxx.lan port 5000 (#0)</span><br><span class="line">*   Trying 7.xx.x.125...</span><br><span class="line">* Connected to reg.xxx.lan (7.xx.x.125) port 5000 (#0)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET /_ping HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: reg.xxx.lan:5000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 404 Not Found</span></span><br><span class="line">&lt; Content-Type: text/plain; charset=utf-8</span><br><span class="line">&lt; Docker-Distribution-Api-Version: registry/2.0</span><br><span class="line">&lt; X-Content-Type-Options: nosniff</span><br><span class="line">&lt; Date: Wed, 08 Jan 2025 07:05:33 GMT</span><br><span class="line">&lt; Content-Length: 19</span><br><span class="line">&lt;</span><br><span class="line">404 page not found</span><br><span class="line">* Connection #0 to host reg.xxx.lan left intact</span><br></pre></td></tr></table></figure><p>ç„¶åè®©å®¢æˆ·å‡†å¤‡ç¬¬äºŒå°æœºå™¨åªå®‰è£…åŒæ ·çš„ docker ç‰ˆæœ¬ ï¼Œä¸Šå» docker login å°±å¾ˆå¿«ï¼Œæ’é™¤æ‰é•œåƒä»“åº“é—®é¢˜ã€‚çœ‹äº†ä¸‹è¿™å—ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/moby/moby/blob/6c523afaedcbb2e3e219dbf4d417efad5b9397b3/client/ping.go#L21</span><br></pre></td></tr></table></figure><p>å‘ç°ä»£ç é€»è¾‘ä¹Ÿæ²¡å•¥é€»è¾‘é—®é¢˜ï¼Œå…ˆå‘ HEAD è¯·æ±‚æœ‰é—®é¢˜å†å°è¯• GET è¯·æ±‚ã€‚æœºå™¨ä¸Šçœ‹äº†ä¸‹ä¹Ÿæ²¡å®‰å…¨è½¯ä»¶å•¥çš„ã€‚æœ€åå°è¯•ä¸‹ 127 è®¿é—®è¯•è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u xxx -p xxxx 127.0.0.1:5000</span><br></pre></td></tr></table></figure><p>å‘ç°å¾ˆå¿«ï¼Œæ„Ÿè§‰ä¸ä¼šæ˜¯ hosts è§£æç›¸å…³å§ï¼Œ<code>tcpdump -nn -i ens224 port 53 -v | grep -A2 reg.xxx.lan</code> çœ‹äº†ä¸‹æœç„¶å‘å¾€å¤–é¢äº†ã€‚æŸ¥çœ‹ä¸‹ <code>/etc/nsswitch.conf</code> å‘ç°æœç„¶è¢«ä¿®æ”¹äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep hosts /etc/nsswitch.conf</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">hosts:     db files nisplus nis dns</span></span><br><span class="line">hosts:      dns files myhostname</span><br></pre></td></tr></table></figure><p>æ”¹å›å°±æ­£å¸¸äº†ï¼Œè¯¢é—®å®¢æˆ·æ²¡æœ‰äººæ”¹ï¼Œåº”è¯¥æ˜¯ä»–ä»¬åˆ¶ä½œè™šæœºæ¨¡æ¿æ—¶å€™ä¿®æ”¹çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;docker login å’Œ pod æ‹‰å–é•œåƒéå¸¸æ…¢çš„æ’æŸ¥&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="net" scheme="http://zhangguanzhang.github.io/tags/net/"/>
    
  </entry>
  
</feed>
