<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Zhangguanzhang</title>
  
  <subtitle>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</subtitle>
  <link href="http://zhangguanzhang.github.io/atom.xml" rel="self"/>
  
  <link href="http://zhangguanzhang.github.io/"/>
  <updated>2022-06-03T15:18:30.000Z</updated>
  <id>http://zhangguanzhang.github.io/</id>
  
  <author>
    <name>Zhangguanzhang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>docker infoæ— warningï¼Œiptablesè§„åˆ™æ­£å¸¸ï¼Œå®¿ä¸»æœºå°±æ˜¯ä¸è½¬å‘</title>
    <link href="http://zhangguanzhang.github.io/2022/06/03/container-not-forward/"/>
    <id>http://zhangguanzhang.github.io/2022/06/03/container-not-forward/</id>
    <published>2022-06-03T15:18:30.000Z</published>
    <updated>2022-06-03T15:18:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>06ã€02 å‡Œæ™¨è¢«å–Šé†’å¸®å¿™çœ‹é—®é¢˜ï¼Œå®¢æˆ·ä¾§é‡å¯éƒ¨åˆ† k8s èŠ‚ç‚¹æœºå™¨åï¼Œä¸šåŠ¡çš„éƒ¨åˆ†æ¥å£å‡ºç°é—®é¢˜ï¼Œç¯å¢ƒæ— æ³•å‘æ—¥è‘µä¹‹ç±»çš„è¿œç¨‹ï¼Œåªèƒ½å‘å‘½ä»¤åï¼Œç°åœºäººå‘˜æ‰§è¡Œã€‚</p><h3 id="å…·ä½“ç°è±¡"><a href="#å…·ä½“ç°è±¡" class="headerlink" title="å…·ä½“ç°è±¡"></a>å…·ä½“ç°è±¡</h3><p>ä¸šåŠ¡ pod æ—¥å¿—çœ‹æ˜¯æ— æ³•è¿åˆ°é k8s æœºå™¨ä¸Šçš„ mysql çš„ 3306ï¼Œ <code>docker info</code> å‘½ä»¤æ—  warning ä¹Ÿå°±æ˜¯ä»£è¡¨ä¸‹é¢çš„å‡ ä¸ªå†…æ ¸å‚æ•°æ­£å¸¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ <code>iptables -S</code> è§„åˆ™æ²¡æœ‰ä¼˜å…ˆçº§é«˜çš„ drop ä¹‹ç±»çš„è§„åˆ™ï¼Œé»˜è®¤ FORWARD Chain çš„æœ€åè¡Œä¸ºè§„åˆ™ä¹Ÿä¸æ˜¯ DROPã€‚å› ä¸ºç”¨äº† cni plugins ï¼Œpod çš„å®¹å™¨éƒ½æ˜¯æŒ‚åœ¨ cni0 ä¸‹çš„ï¼Œå¯ä»¥ -i æ’å…¥ä¼˜å…ˆæ”¾è¡Œçš„è§„åˆ™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables --<span class="built_in">wait</span> -I INPUT -i cni0 -j ACCEPT</span><br></pre></td></tr></table></figure><p>è®©ç°åœºæ’å…¥äº†è¿˜æ˜¯ä¸è¡Œï¼Œç„¶åè®©çœ‹çœ‹å®‰å…¨è½¯ä»¶ï¼Œ<code>ps aux | grep xxx</code> å…³é”®å­—åæ‰¾åˆ°äº†ä¸ª <code>titanagent</code>ï¼Œæœäº†ä¸‹æ˜¯é’è—¤äº‘ï¼Œå‡Œæ™¨æ— æ³•æ‰¾åˆ°ç›¸å…³äººå‘˜ï¼Œæš‚æ—¶æŠŠå‡ ä¸ªèŠ‚ç‚¹ <code>drain</code> äº† </p><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><p>06&#x2F;03 å·å®¢æˆ·æ‰¾äººå¸è½½äº†é’è—¤äº‘ï¼Œå‘ç°è¿˜æ˜¯ä¸è¡Œï¼Œæä¾›äº†è¿œç¨‹ï¼Œæˆ‘ä¸Šå»çœ‹ã€‚</p><h3 id="æ•…éšœç°è±¡"><a href="#æ•…éšœç°è±¡" class="headerlink" title="æ•…éšœç°è±¡"></a>æ•…éšœç°è±¡</h3><p>æŸ¥äº†ä¸‹ï¼Œå‘ç°é‡å¯çš„èŠ‚ç‚¹ä¸Šçš„å®¹å™¨ï¼Œæ— æ³•è®¿é—®éå®¿ä¸»æœºçš„ipå’Œç«¯å£ï¼Œping å¦ä¸€ä¸ª k8s ä¸»æœºéƒ½ä¸è¡Œï¼Œç”¨ tcpdump æŠ“åŒ…å‘ç°å®¿ä¸»æœºæ²¡è½¬å‘ï¼Œç„¶åç”¨ docker èµ·ä¸ªé»˜è®¤æ¡¥æ¥ç½‘ç»œçš„è¯•ä¸‹ä¹Ÿæ˜¯ä¸è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -ti --entrypoint bash xxx telnet xxx 3306</span><br></pre></td></tr></table></figure><p>ç„¶åçœ‹äº†ä¸‹ iptables çŠ¶æ€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -vnL -w | grep -A10 FORWARD</span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    0     0 KUBE-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding rules */</span><br><span class="line">    0     0 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes service portals */</span><br><span class="line">    0     0 DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line">    0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  *      *       172.27.0.0/16        0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            172.27.0.0/16</span><br></pre></td></tr></table></figure><p>æœç„¶æ²¡è½¬å‘ï¼Œä»”ç»†çœ‹æ˜¯æ‰€æœ‰çš„éƒ½æ²¡è½¬å‘ï¼Œæ€è€ƒäº†ä¸‹æ˜¯ä¸æ˜¯å®¢æˆ· <code>/etc/sysctl.conf</code> é‡Œæ”¹äº†å•¥ docker info æ²¡æ£€æµ‹åˆ°çš„è½¬å‘ç›¸å…³çš„å†…æ ¸å‚æ•°ï¼Œç„¶åé‡å¯åå°±æ²¡è½¬å‘çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/sysctl.conf /etc/sysctl.conf.bak</span><br><span class="line">vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹å‚æ•°å¾ˆå¤šï¼Œå°±ç›´æ¥ç²—æš´çš„å¤„ç†äº†ï¼Œå¤‡ä»½æ–‡ä»¶ï¼Œç„¶åäºŒåˆ†æ’é™¤ã€‚ç¬¬ä¸€è¡Œåˆ°ä¸­é—´æ³¨é‡Šï¼Œé‡å¯åä¸Šé¢çš„ docker å‘½ä»¤æµ‹è¯•ï¼Œæœ€åæ‰¾åˆ°æ˜¯ä¸‹é¢è¿™ä¸ªå‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.conf.default.forwarding=0</span><br></pre></td></tr></table></figure><h3 id="net-ipv4-conf-default-forwarding-çš„æµ‹è¯•"><a href="#net-ipv4-conf-default-forwarding-çš„æµ‹è¯•" class="headerlink" title="net.ipv4.conf.default.forwarding çš„æµ‹è¯•"></a>net.ipv4.conf.default.forwarding çš„æµ‹è¯•</h3><p>å…¶å®é—®é¢˜è¿˜æ²¡å®Œï¼Œæˆ‘è¯•äº†ä¸‹å¦‚æœè®¾ç½®ä¸º0é‡å¯ï¼Œç„¶åèµ·å®¹å™¨äº†ï¼Œç„¶åè®¾ç½®ä¸º1è¿˜æ˜¯ä¸è¡Œï¼Œç„¶åæ‰¾ä¸ªå¹²å‡€çš„ç¯å¢ƒæ¥ä¸‹é¢æ­¥éª¤å¤ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;/net.ipv4.conf.default.forwarding/s#1#0#&#x27; /etc/sysctl.conf</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run --rm -tid --name test --entrypoint bash nicolaka/netshoot</span><br><span class="line">timeout 3 docker exec test ping -c 1 114.114.114.114</span><br><span class="line"></span><br><span class="line">sysctl -w net.ipv4.conf.default.forwarding=1</span><br><span class="line">timeout 3 docker exec test ping -c 1 114.114.114.114</span><br></pre></td></tr></table></figure><p>ç„¶åçœ‹ä¸‹å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -a |&amp; grep forwarding </span><br><span class="line">net.ipv4.conf.all.forwarding = 1</span><br><span class="line">net.ipv4.conf.all.mc_forwarding = 0</span><br><span class="line">net.ipv4.conf.default.forwarding = 1</span><br><span class="line">net.ipv4.conf.default.mc_forwarding = 0</span><br><span class="line">net.ipv4.conf.docker0.forwarding = 0</span><br><span class="line">net.ipv4.conf.docker0.mc_forwarding = 0</span><br><span class="line">net.ipv4.conf.eth0.forwarding = 1</span><br><span class="line">net.ipv4.conf.eth0.mc_forwarding = 0</span><br><span class="line">net.ipv4.conf.lo.forwarding = 1</span><br><span class="line">net.ipv4.conf.lo.mc_forwarding = 0</span><br><span class="line">net.ipv4.conf.veth10d8150.forwarding = 0</span><br><span class="line">net.ipv4.conf.veth10d8150.mc_forwarding = 0</span><br><span class="line">net.ipv6.conf.all.forwarding = 0</span><br><span class="line">net.ipv6.conf.all.mc_forwarding = 0</span><br><span class="line">net.ipv6.conf.default.forwarding = 0</span><br><span class="line">net.ipv6.conf.default.mc_forwarding = 0</span><br><span class="line">net.ipv6.conf.docker0.forwarding = 0</span><br><span class="line">net.ipv6.conf.docker0.mc_forwarding = 0</span><br><span class="line">net.ipv6.conf.eth0.forwarding = 0</span><br><span class="line">net.ipv6.conf.eth0.mc_forwarding = 0</span><br><span class="line">net.ipv6.conf.lo.forwarding = 0</span><br><span class="line">net.ipv6.conf.lo.mc_forwarding = 0</span><br><span class="line">net.ipv6.conf.veth10d8150.forwarding = 0</span><br><span class="line">net.ipv6.conf.veth10d8150.mc_forwarding = 0</span><br></pre></td></tr></table></figure><p>æ¡¥æ¥å·¥å…·çœ‹ä¸‹ï¼Œå› ä¸ºåªæœ‰ docker å¹¶ä¸”ä¸Šé¢ä¸€ä¸ªå®¹å™¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">docker08000.0242b6e42b7fnoveth10d8150</span><br></pre></td></tr></table></figure><p>æŠŠå®¹å™¨çš„ç½‘å¡æ‰€åœ¨çš„ç½‘æ¡¥ docker0 è½¬å‘å¼€å¯ä¸‹å†è¯•è¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -w net.ipv4.conf.docker0.forwarding=1</span><br><span class="line">$ timeout 3 docker exec test ping -c 1 114.114.114.114</span><br><span class="line">PING 114.114.114.114 (114.114.114.114) 56(84) bytes of data.</span><br><span class="line">64 bytes from 114.114.114.114: icmp_seq=1 ttl=67 time=17.5 ms</span><br><span class="line"></span><br><span class="line">--- 114.114.114.114 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 17.500/17.500/17.500/0.000 ms</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœæ˜¯å…³é—­åå¼€æœºï¼Œéœ€è¦è®¾ç½®æ€»å¼€å…³å’Œç›¸å…³çš„ç½‘æ¡¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.conf.default.forwarding=1</span><br><span class="line">net.ipv4.conf.docker0.forwarding=1</span><br><span class="line">net.ipv4.conf.cni0.forwarding=1</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸ªå‚æ•°ä¸çŸ¥é“ä¸ºå•¥ docker info ä¸æ£€æŸ¥å®ƒ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;06ã€02 å‡Œæ™¨è¢«å–Šé†’å¸®å¿™çœ‹é—®é¢˜ï¼Œå®¢æˆ·ä¾§é‡å¯éƒ¨åˆ† k8s èŠ‚ç‚¹æœºå™¨åï¼Œä¸šåŠ¡çš„éƒ¨åˆ†æ¥å£å‡ºç°é—®é¢˜ï¼Œç¯å¢ƒæ— æ³•å‘æ—¥è‘µä¹‹ç±»çš„è¿œç¨‹ï¼Œåªèƒ½å‘å‘½ä»¤åï¼Œç°åœºäºº</summary>
      
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="kernal" scheme="http://zhangguanzhang.github.io/tags/kernal/"/>
    
  </entry>
  
  <entry>
    <title>ä½ç‰ˆæœ¬å†…æ ¸ä¸‹å®¹å™¨å†…éƒ¨æ— æ³•ä½¿ç”¨ unix socket é€šä¿¡</title>
    <link href="http://zhangguanzhang.github.io/2022/05/13/overlayfs-unix-socket/"/>
    <id>http://zhangguanzhang.github.io/2022/05/13/overlayfs-unix-socket/</id>
    <published>2022-05-13T14:18:30.000Z</published>
    <updated>2022-05-13T14:18:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æœ€è¿‘å‡ æ¬¡é‡åˆ°çš„æœºå™¨ä¸Šæ‰€æœ‰å®¹å™¨å†…ï¼Œéƒ½æ— æ³•ä½¿ç”¨ unix:&#x2F;&#x2F; å»é€šä¿¡çš„çš„ä¸€ä¸ªé—®é¢˜ã€‚</p><h2 id="é‡åˆ°çš„å‡ ä¸ªé”™è¯¯ç°è±¡"><a href="#é‡åˆ°çš„å‡ ä¸ªé”™è¯¯ç°è±¡" class="headerlink" title="é‡åˆ°çš„å‡ ä¸ªé”™è¯¯ç°è±¡"></a>é‡åˆ°çš„å‡ ä¸ªé”™è¯¯ç°è±¡</h2><p>æœ€å¼€å§‹æ˜¯æˆ‘ä»¬éƒ¨ç½²å®¹å™¨å†…æ— æ³•ä½¿ç”¨ ansible å»æ“ä½œå…¶ä»–æœºå™¨ï¼Œåé¢æ˜¯è¯¥æœºå™¨ä¸Šæ‰€æœ‰å®¹å™¨å†…çš„ supervisorctl æ— æ³•é€šè¿‡ unix sock è¿æ¥ supervisord </p><h3 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h3><p>æŠ¥é”™å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">failt: [10.x.x.x]: UNREACHABLE! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;msg&quot;: &quot;Data could not be sent to remote host \&quot;10.x.x.x\&quot;. Make sure this host can be reached over ssh: Control socket connect (/tmp/ansible-ssh-10.x.x.x-22-root): Connection refused</span><br><span class="line">    Failed to connect to new control master&quot;, &quot;unreachable&quot;: true&#125;</span><br></pre></td></tr></table></figure><p>ansible çš„å‘½ä»¤åŠ ä¸Š <code>-vvvv</code> åå¤åˆ¶ ssh çš„æ‰€æœ‰å‚æ•°æ‰§è¡Œï¼Œç„¶åå‘ç°å»æ‰ socket çš„å‚æ•°å°±èƒ½è¿ä¸Šï¼Œä»¥å‰é‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œå½“æ—¶æœåˆ° issue åæ˜¯æ”¹ ansible.cfg æŠŠ ssh çš„æŒä¹…åŒ– socket è·¯å¾„æ¢äº†ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ssh_connection]</span><br><span class="line">#control_path = /tmp/ansible-ssh-%%h-%%p-%%r</span><br><span class="line">control_path = /dev/shm/cp%%h-%%p-%%r</span><br></pre></td></tr></table></figure><h3 id="supervisor-çš„-unix-x2F-x2F-refused"><a href="#supervisor-çš„-unix-x2F-x2F-refused" class="headerlink" title="supervisor çš„ unix:&#x2F;&#x2F; refused"></a>supervisor çš„ unix:&#x2F;&#x2F; refused</h3><p>ç„¶åæ˜¨å¤©æˆ‘ä»¬å¼€å‘æœºå™¨ä¸Šï¼Œå‘ç°æœ‰ä¸ªä¸šåŠ¡å®¹å™¨å†…ä¸èƒ½ç”¨ <code>supervisorctl</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ supervisorctl status </span><br><span class="line">unix:///var/run/supervisor.sock refused connection</span><br></pre></td></tr></table></figure><p>ç„¶åä»Šå¤©æˆ‘ä»¬çš„ä¸€ä¸ªéƒ¨ç½²å®¹å™¨å‘ç°ä¹Ÿæ˜¯è¿™æ ·ï¼Œå¤§è‡´åˆ†æäº†ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å¯åŠ¨å‚æ•°</span><br><span class="line">#/usr/local/bin/python3.7 /usr/local/bin/supervisord -c /root/xxx/supervisord.conf.containd --nodaemon</span><br><span class="line"># æŒ‡å®šé…ç½®æ–‡ä»¶è¿˜æ˜¯ä¸€æ ·</span><br><span class="line">$ supervisorctl -c   /root/xxx/supervisord.conf.containd status</span><br><span class="line">unix:///var/run/supervisor.sock refused connection</span><br><span class="line"></span><br><span class="line"># socket æ–‡ä»¶å­˜åœ¨ï¼Œæƒé™ä¹Ÿå¯¹</span><br><span class="line">ls -l /var/run/supervisor.sock </span><br><span class="line">srw-rw---- 1 root root 0 5æœˆ  13 11:32 /var/run/supervisor.sock</span><br></pre></td></tr></table></figure><p>é…ç½®é‡Œç›¸å…³çš„éƒ½æ˜¯å¯¹çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[unix_http_server]</span><br><span class="line">file=/var/run/supervisor.sock   ; (the path to the socket file)</span><br><span class="line">chmod=0700                       ; sockef file mode (default 0700)</span><br><span class="line"></span><br><span class="line">[rpcinterface:supervisor]</span><br><span class="line">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</span><br><span class="line"></span><br><span class="line">[supervisorctl]</span><br><span class="line">serverurl=unix:///var/run/supervisor.sock ; use a unix:// URL  for a unix socket</span><br></pre></td></tr></table></figure><p>ç„¶åå¯¹æ¯”å¦ä¸€ä¸ªæˆ‘è‡ªå·±çš„æ­£å¸¸çš„ CentOS æœºå™¨ä¸Šéƒ¨ç½²å®¹å™¨å†…éƒ¨çš„ supervisor é…ç½®æ–‡ä»¶å‘ç°æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ–­å®šå’Œé…ç½®æ— å…³ï¼Œç„¶åæœäº†ä¸‹å‘ç°æ˜¯å†…æ ¸é—®é¢˜ã€‚ä½ç‰ˆæœ¬çš„ overlayfs å†…éƒ¨ä½¿ç”¨ unix sock æ–‡ä»¶é€šä¿¡ä¼šå‡ºé—®é¢˜ï¼Œæœºå™¨ç›¸å…³ä¿¡æ¯ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/os-release</span><br><span class="line">NAME=&quot;Ubuntu&quot;</span><br><span class="line">VERSION=&quot;16.04 LTS (Xenial Xerus)&quot;</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">PRETTY_NAME=&quot;Ubuntu 16.04 LTS&quot;</span><br><span class="line">VERSION_ID=&quot;16.04&quot;</span><br><span class="line">HOME_URL=&quot;http://www.ubuntu.com/&quot;</span><br><span class="line">SUPPORT_URL=&quot;http://help.ubuntu.com/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;http://bugs.launchpad.net/ubuntu/&quot;</span><br><span class="line">UBUNTU_CODENAME=xenial</span><br><span class="line">$ uname -a</span><br><span class="line">Linux xxx 4.4.0-21-generic #37-Ubuntu ....</span><br></pre></td></tr></table></figure><h2 id="è§£å†³å®¹å™¨å†…ä½¿ç”¨-sock-æ–‡ä»¶é€šä¿¡çš„é—®é¢˜"><a href="#è§£å†³å®¹å™¨å†…ä½¿ç”¨-sock-æ–‡ä»¶é€šä¿¡çš„é—®é¢˜" class="headerlink" title="è§£å†³å®¹å™¨å†…ä½¿ç”¨ sock æ–‡ä»¶é€šä¿¡çš„é—®é¢˜"></a>è§£å†³å®¹å™¨å†…ä½¿ç”¨ sock æ–‡ä»¶é€šä¿¡çš„é—®é¢˜</h2><p>ubuntu å®˜æ–¹è¯´è¿™ä¸ªåœ¨å†…æ ¸ <code>4.4.0-36.55</code> ä¿®å¤äº†ï¼Œéœ€è¦å‡çº§å†…æ ¸ï¼Œå…ˆè¯´ä¸‹å‡çº§å†…æ ¸çš„æ­¥éª¤</p><h3 id="å‡çº§å†…æ ¸"><a href="#å‡çº§å†…æ ¸" class="headerlink" title="å‡çº§å†…æ ¸"></a>å‡çº§å†…æ ¸</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg --get-selections |grep -E &#x27;^linux&#x27;</span><br><span class="line">linux-baseinstall</span><br><span class="line">linux-firmwareinstall</span><br><span class="line">linux-genericinstall</span><br><span class="line">linux-headers-4.4.0-21install</span><br><span class="line">linux-headers-4.4.0-21-genericinstall</span><br><span class="line">linux-headers-genericinstall</span><br><span class="line">linux-image-4.4.0-21-genericinstall</span><br><span class="line">linux-image-extra-4.4.0-21-genericinstall</span><br><span class="line">linux-image-genericinstall</span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾æŒ‡å®šå†…æ ¸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ apt-cache search linux| grep 4.4.0-36</span><br><span class="line">linux-cloud-tools-4.4.0-36 - Linux kernel version specific cloud tools for version 4.4.0-36</span><br><span class="line">linux-cloud-tools-4.4.0-36-generic - Linux kernel version specific cloud tools for version 4.4.0-36</span><br><span class="line">linux-cloud-tools-4.4.0-36-lowlatency - Linux kernel version specific cloud tools for version 4.4.0-36</span><br><span class="line">linux-headers-4.4.0-36 - Header files related to Linux kernel version 4.4.0</span><br><span class="line">linux-headers-4.4.0-36-generic - Linux kernel headers for version 4.4.0 on 64 bit x86 SMP</span><br><span class="line">linux-headers-4.4.0-36-lowlatency - Linux kernel headers for version 4.4.0 on 64 bit x86 SMP</span><br><span class="line">linux-image-4.4.0-36-generic - Linux kernel image for version 4.4.0 on 64 bit x86 SMP</span><br><span class="line">linux-image-4.4.0-36-lowlatency - Linux kernel image for version 4.4.0 on 64 bit x86 SMP</span><br><span class="line">linux-image-extra-4.4.0-36-generic - Linux kernel extra modules for version 4.4.0 on 64 bit x86 SMP</span><br><span class="line">linux-signed-image-4.4.0-36-generic - Signed kernel image generic</span><br><span class="line">linux-signed-image-4.4.0-36-lowlatency - Signed kernel image lowlatency</span><br><span class="line">linux-tools-4.4.0-36 - Linux kernel version specific tools for version 4.4.0-36</span><br><span class="line">linux-tools-4.4.0-36-generic - Linux kernel version specific tools for version 4.4.0-36</span><br><span class="line">linux-tools-4.4.0-36-lowlatency - Linux kernel version specific tools for version 4.4.0-36</span><br></pre></td></tr></table></figure><p>å®‰è£…æŒ‡å®šå†…æ ¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y linux-&#123;headers,image&#125;-4.4.0-36-generic</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹ä¸‹ <code>/boot/grub/grub.cfg</code> é‡Œç¬¬ä¸€ä¸ª menuentry æ®µçš„ <code>initrd</code> æ˜¯å¦æŒ‡å®šåˆ°æ–°çš„å†…æ ¸äº†ï¼Œæ•´ä½“å¼€æœº grub èœå•å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ grep -Ei &#x27;submenu|menuentry &#x27; /boot/grub/grub.cfg | sed -re &quot;s/(.? )&#x27;([^&#x27;]+)&#x27;.*/\1 \2/&quot;</span><br><span class="line">menuentry  Ubuntu</span><br><span class="line">submenu  Advanced options for Ubuntu</span><br><span class="line">menuentry  Ubuntu, with Linux 4.4.0-36-generic</span><br><span class="line">menuentry  Ubuntu, with Linux 4.4.0-36-generic (recovery mode)</span><br><span class="line">menuentry  Ubuntu, with Linux 4.4.0-21-generic</span><br><span class="line">menuentry  Ubuntu, with Linux 4.4.0-21-generic (recovery mode)</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³å¼€æœºå¯åŠ¨åˆ° submenu çš„ ç¬¬ä¸‰ä¸ªï¼Œå¯ä»¥æ”¹æ–‡ä»¶ <code>/etc/default/grub</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_DEFAULT=&quot;1&gt;2&quot;</span><br></pre></td></tr></table></figure><p>å‰é¢æ˜¯å¤–å±‚èœå•ï¼Œåé¢æ˜¯å­èœå•ï¼Œ0 å¼€å§‹ï¼Œæ›´æ–°ä¸‹ grub:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-grub</span><br></pre></td></tr></table></figure><p>é‡å¯åè¿›å…¥å‘ç°å¥½äº†ã€‚</p><h3 id="ä¸å‡çº§å†…æ ¸çš„åŠæ³•"><a href="#ä¸å‡çº§å†…æ ¸çš„åŠæ³•" class="headerlink" title="ä¸å‡çº§å†…æ ¸çš„åŠæ³•"></a>ä¸å‡çº§å†…æ ¸çš„åŠæ³•</h3><p>å°±æ˜¯å®¹å™¨å†…çš„ sock æ–‡ä»¶å­˜æ”¾åˆ°å®¹å™¨å†…éƒ¨çš„ <code>/dev/shm/</code> é‡Œå³å¯ã€‚</p><h2 id="ä¸€äº›è¯´æ˜"><a href="#ä¸€äº›è¯´æ˜" class="headerlink" title="ä¸€äº›è¯´æ˜"></a>ä¸€äº›è¯´æ˜</h2><p>Centos 7 æ²¡é—®é¢˜æ˜¯å› ä¸º centos çš„å†…æ ¸æ˜¯ backport çš„ï¼Œå¯ä»¥ç†è§£ä¸º centos çš„ overlay å†…æ ¸æ¨¡å—å®é™…ä¸Šæ˜¯ 4.10 å†…æ ¸ä»£ç ç§»æ¤çš„ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/Supervisor/supervisor/issues/654">https://github.com/Supervisor/supervisor/issues/654</a></li><li><a href="https://github.com/moby/moby/issues/12080">https://github.com/moby/moby/issues/12080</a></li><li><a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1214500">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1214500</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;æœ€è¿‘å‡ æ¬¡é‡åˆ°çš„æœºå™¨ä¸Šæ‰€æœ‰å®¹å™¨å†…ï¼Œéƒ½æ— æ³•ä½¿ç”¨ unix:&amp;#x2F;&amp;#x2F; å»é€šä¿¡çš„çš„ä¸€ä¸ªé—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&quot;é‡åˆ°çš„å‡ ä¸ªé”™è¯¯</summary>
      
    
    
    
    
    <category term="overlay" scheme="http://zhangguanzhang.github.io/tags/overlay/"/>
    
    <category term="kernal" scheme="http://zhangguanzhang.github.io/tags/kernal/"/>
    
  </entry>
  
  <entry>
    <title>nfc æŠ˜è…¾ç¬”è®°ï¼ŒACR122U/proxmark3</title>
    <link href="http://zhangguanzhang.github.io/2022/04/23/nfc/"/>
    <id>http://zhangguanzhang.github.io/2022/04/23/nfc/</id>
    <published>2022-04-23T14:28:30.000Z</published>
    <updated>2022-04-23T14:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿‘æœŸæŠ˜è…¾ nfc ç›¸å…³ï¼Œä»¥å nfc çš„æŠ˜è…¾ä¹Ÿä¼šæ›´æ–°åœ¨è¿™ä¸ªæ–‡ç« å†…</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ä»¥å‰ä¹°è¿‡ ACR122U ï¼Œæƒ³ç€å¸®äººé—¨ç¦è§£å¯†å¯¼å…¥æ‰‹ç¯æŒ£ç‚¹å¤–å¿«ï¼Œæ²¡æƒ³åˆ°å¼„ä¸å¼€ï¼Œç„¶åç¾¤å‹é€äº†ä¸ª proxmark3ï¼ˆpm3ï¼‰æˆ‘ï¼ŒæŠ˜è…¾äº†ä¸‹ï¼Œåšä¸ªç¬”è®°</p><h2 id="æŠ˜è…¾"><a href="#æŠ˜è…¾" class="headerlink" title="æŠ˜è…¾"></a>æŠ˜è…¾</h2><h3 id="å¡ç‰‡"><a href="#å¡ç‰‡" class="headerlink" title="å¡ç‰‡"></a>å¡ç‰‡</h3><p>å¡ç‰‡ä»‹ç»ï¼Œé€šå¸¸åˆ†ä¸º IC å¡å’Œ ID å¡ï¼š</p><ol><li>ID å¡ä¸€èˆ¬ä½é¢‘ï¼Œä¸å¯å†™å…¥æ•°æ®ï¼Œåªè¯»å¡å·ï¼Œè¿˜æœ‰ HID å¡ï¼ˆä¸€äº›å¤§å‚å·¥ç‰Œï¼‰ï¼Œå¡è¡¨æ˜æœ‰ç¼–å·ï¼Œé‡Œé¢ä¸€èˆ¬æ˜¯åœ†å½¢çº¿åœˆã€‚</li><li>IC å¡é«˜é¢‘ï¼Œå¤§éƒ¨åˆ†å¯ä»¥æ“¦å†™ï¼Œé“¶è¡Œï¼Œäº¤é€šï¼Œé—¨ç¦ï¼Œé¥­å¡ï¼Œå·¥ç‰Œä¹‹ç±»éƒ½ç”¨ä½¿ç”¨ã€‚RFIDã€NFC å±äº IC å¡ï¼Œçº¿åœˆä¸€èˆ¬æ˜¯çŸ©å½¢ã€‚IC å¡æˆ‘ä»¬ç ´è§£å•¥çš„ä¸€èˆ¬æ˜¯ä¸‹é¢å‡ ç§ç±»å‹ç›¸å…³:</li></ol><table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th><th>é¢‘ç‡</th><th>æ“¦å†™æƒ…å†µ</th></tr></thead><tbody><tr><td>M1</td><td>NXP Mifareç³»åˆ—å¡, å·¥ä½œåœ¨é«˜é¢‘ï¼ˆ13.56Mhzï¼‰ï¼Œå…¨ç§°Mifare S50ï¼Œæ˜¯æœ€å¸¸è§çš„å¡ï¼Œå‡ºå‚å›ºåŒ–UID</td><td>13.56Mhz</td><td>UID éƒ¨åˆ†ä¸å¯æ“¦å†™</td></tr><tr><td>M0</td><td>ç›¸å½“äºM1å¡çš„ç²¾ç®€ç‰ˆï¼Œå®¹é‡æ›´å°ã€åŠŸèƒ½æ›´å°‘ï¼Œä½†ä»·æ ¼æ›´ä½</td><td>13.56Mhz</td><td>UID éƒ¨åˆ†ä¸å¯æ“¦å†™</td></tr><tr><td>UID</td><td>å…¨ç§°Mifare UID Chinese magic cardï¼Œå›½å¤–å«åšä¸­å›½é­”æœ¯å¡ï¼ŒM1å¡çš„å˜å¼‚ç‰ˆæœ¬ï¼Œä½¿ç”¨åé—¨æŒ‡ä»¤(magicæŒ‡ä»¤)ï¼Œå¯ä¿®æ”¹UIDï¼ˆUIDåœ¨block0åˆ†åŒºï¼‰ï¼Œå¯ä»¥ç”¨æ¥å®Œæ•´å…‹éš†M1å¡çš„æ•°æ®ï¼›ä½†æ˜¯ç°åœ¨æ–°çš„è¯»å¡ç³»ç»Ÿé€šè¿‡æ£€æµ‹å¡ç‰‡å¯¹åé—¨æŒ‡ä»¤çš„å›åº”ï¼Œå¯ä»¥æ£€æµ‹å‡ºUIDå¡ï¼Œå› æ­¤å¯ä»¥æ¥æ‹’ç»UIDå¡çš„è®¿é—®ï¼Œæ¥è¾¾åˆ°å±è”½å¤åˆ¶å¡çš„åŠŸèƒ½ï¼ˆå³UIDé˜²ç«å¢™ç³»ç»Ÿï¼‰ï¼›</td><td>13.56Mhz</td><td>UID éƒ¨åˆ†å¯æ“¦å†™</td></tr><tr><td>CUID</td><td>ä¸ºäº†é¿å¼€UIDé˜²ç«å¢™ç³»ç»Ÿï¼ŒCUIDå¡åº”è¿è€Œç”Ÿï¼Œå–æ¶ˆå“åº”åé—¨æŒ‡ä»¤(magicæŒ‡ä»¤)ï¼Œå¯ä¿®æ”¹UIDï¼Œæ˜¯ç›®å‰å¸‚åœºä¸Šæœ€å¸¸ç”¨çš„å¤åˆ¶å¡ï¼›ä½†æ˜¯ç°åœ¨è²Œä¼¼ä¹Ÿæœ‰ CUID å¡çš„é˜²ç«å¢™</td><td>13.56Mhz</td><td>UID éƒ¨åˆ†å¯æ“¦å†™</td></tr><tr><td>FUID</td><td>FUIDå¡åªèƒ½å†™ä¸€æ¬¡UIDï¼Œå†™å®Œä¹‹åè‡ªåŠ¨å›ºåŒ–UIDæ‰€åœ¨åˆ†åŒºï¼Œå°±ç­‰åŒM1å¡ï¼Œç›®å‰ä»»ä½•é˜²ç«å¢™ç³»ç»Ÿéƒ½æ— æ³•å±è”½ï¼Œå¤åˆ¶çš„å¡å‡ ä¹å’ŒåŸå¡ä¸€æ¨¡ä¸€æ ·ï¼›</td><td>13.56Mhz</td><td>å¯æ“¦å†™ä¸€æ¬¡</td></tr><tr><td>UFUID</td><td>é›†UIDå¡å’ŒFUIDå¡çš„ä¼˜ç‚¹äºä¸€èº«ï¼Œä½¿ç”¨åé—¨æŒ‡ä»¤ï¼Œå¯ä¿®æ”¹UIDï¼Œå†æ‰‹åŠ¨é”å¡ï¼Œå˜æˆM1å¡ã€‚å¯å…ˆåå¤è¯»å†™UIDï¼Œç¡®è®¤æ•°æ®æ— è¯¯ï¼Œæ‰‹åŠ¨é”å¡å˜æˆM1ï¼Œè§£å†³äº†UIDå¡çš„UIDé˜²ç«å¢™å±è”½ï¼Œä¹Ÿè§£å†³FUIDçš„ä¸€æ¬¡æ€§å†™å…¥å®¹æ˜“å†™é”™çš„é—®é¢˜ï¼Œä¸”ä»·æ ¼æ¯”FUIDå¡è¿˜ä¾¿å®œï¼›</td><td>13.56Mhz</td><td>å¯æ“¦å†™ä¸€æ¬¡</td></tr></tbody></table><p>åˆ¤æ–­æ˜¯ M0å¡(Mifare UltraLight)ï¼Œè¿˜æ˜¯ M1å¡(Mifare Classic 1k)ï¼Œå¯ä»¥é€šè¿‡ SAK å€¼åˆ¤æ–­ã€‚</p><table><thead><tr><th>äº§å“</th><th>ATQA</th><th>SAK</th><th>UIDé•¿åº¦</th></tr></thead><tbody><tr><td>Mifare Mini</td><td>00 04</td><td>09</td><td>4 bytes</td></tr><tr><td>Mifare Classic 1k</td><td>00 04</td><td>08</td><td>4 bytes</td></tr><tr><td>Mifare Classic 4k</td><td>00 02</td><td>18</td><td>4 bytes</td></tr><tr><td>Mifare Ultraligh</td><td>00 44</td><td>00</td><td>4 byteså†™</td></tr><tr><td>Mifare Plus</td><td>00 44</td><td>20</td><td>4 bytes</td></tr></tbody></table><p>SAK ä¸º 20 çš„æ˜¯ CPU æ¨¡æ‹Ÿå¡ï¼ŒåŸºæœ¬æ— è§£ï¼Œè¿˜æœ‰ç§ SAK æ˜¯ 28çš„ï¼Œæ˜¯å¸¦ M1 æ•°æ®çš„ cpu æ¨¡æ‹Ÿå¡ï¼Œåªèƒ½è¯»å– M1 çš„æ•°æ®éƒ¨åˆ†ï¼Œä¸ä¸€å®šèƒ½æ¨¡æ‹ŸæˆåŠŸã€‚</p><h3 id="å¡ç‰‡æ•°æ®å­˜å‚¨ä»‹ç»"><a href="#å¡ç‰‡æ•°æ®å­˜å‚¨ä»‹ç»" class="headerlink" title="å¡ç‰‡æ•°æ®å­˜å‚¨ä»‹ç»"></a>å¡ç‰‡æ•°æ®å­˜å‚¨ä»‹ç»</h3><p>M1(Mifare classic 1K) å¡ç‰‡ï¼Œå³å­˜å‚¨å®¹é‡ 1K &#x3D; 1024Byteï¼Œæœ‰ 16 ä¸ªæ‰‡åŒºï¼Œæ¯ä¸ªæ‰‡åŒºæœ‰ 4 ä¸ªå—ï¼Œæ¯ä¸ªå— 16 ä¸ªå­—èŠ‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0 æ‰‡åŒº</span><br><span class="line">0åŒºå—:00000000000000000000000000000000</span><br><span class="line">1åŒºå—:00000000000000000000000000000000</span><br><span class="line">2åŒºå—:00000000000000000000000000000000</span><br><span class="line">3åŒºå—:FFFFFFFFFFFFFF078069FFFFFFFFFFFF</span><br><span class="line"></span><br><span class="line">1 æ‰‡åŒº</span><br><span class="line">0åŒºå—:00000000000000000000000000000000</span><br><span class="line">1åŒºå—:00000000000000000000000000000000</span><br><span class="line">2åŒºå—:00000000000000000000000000000000</span><br><span class="line">3åŒºå—:FFFFFFFFFFFFFF078069FFFFFFFFFFFF</span><br></pre></td></tr></table></figure><ol><li>0 æ‰‡åŒºçš„ 0 åŒºå—å‡ºå‚èµ‹äºˆçš„ï¼Œå‰ 4 ä¸ªå­—èŠ‚æ˜¯ UIDï¼Œç¬¬ 5 ä¸ªå­—èŠ‚æ˜¯ UIDï¼Œç¬¬ 6 ä¸ªå­—èŠ‚æ˜¯ SAKï¼ŒåŒ…æ‹¬åé¢çš„ä¸€èµ·æ˜¯å‚å•†ç ï¼Œæ‰€æœ‰å¡ç‰‡çš„å‚å•†ç éƒ½æ— æ³•ä¿®æ”¹ã€‚</li><li>é™¤äº† 0 æ‰‡åŒºä»¥å¤–ï¼Œæ¯ä¸ªæ‰‡åŒºçš„å—0ã€å—1ã€å—2 ä¸ºæ•°æ®å—ï¼Œå¯ç”¨äºå­˜å‚¨æ•°æ®ã€‚</li><li>æ¯ä¸ªæ‰‡åŒºçš„å—3ä¸ºæ§åˆ¶å—ï¼ŒåŒ…æ‹¬å¯†ç keyAï¼Œå­˜å–æ§åˆ¶ï¼Œå¯†ç keyBã€‚å­˜å–æ§åˆ¶çš„ä½œç”¨æ˜¯æ§åˆ¶å¯¹åº”æ‰‡åŒºè®°å½•çš„è¯»å†™æƒé™ä¸keyAå’ŒkeyBçš„å…³ç³»ã€‚ç”±äºæ¯ä¸ªæ‰‡åŒºéƒ½æœ‰ç‹¬ç«‹çš„keyå’Œå­˜å–æ§åˆ¶ï¼Œå› æ­¤M1å¡å¯ä»¥åšåˆ°ä¸€å¡å¤šç”¨äº’ä¸å¹²æ‰°ã€‚</li></ol><p>æ›´å¤šè¯¦æƒ…è§ <a href="https://hceng.cn/2019/07/12/NFC%E6%89%8B%E6%9C%BA%E6%A8%A1%E6%8B%9F%E5%8A%A0%E5%AF%86%E9%97%A8%E7%A6%81%E5%8D%A1/">NFCæ‰‹æœºæ¨¡æ‹ŸåŠ å¯†é—¨ç¦å¡</a> é‡Œçš„åŸºç¡€çŸ¥è¯†ã€‚</p><h3 id="ACR122U"><a href="#ACR122U" class="headerlink" title="ACR122U"></a>ACR122U</h3><p>Linux ä¸‹é¢æœ‰ä¸ªå¤åˆ¶è„šæœ¬ï¼Œ<a href="https://www.lostserver.com/static/nfc-cloner.sh">nfc-clone</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y mfoc  libnfc-bin libnfc-bin libnfc-examples</span><br></pre></td></tr></table></figure><p>ACR122U ä¸Šé¢çš„å‘½ä»¤å°±å¯ä»¥é©±åŠ¨äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ nfc-list</span><br><span class="line">nfc-list uses libnfc 1.7.1</span><br><span class="line">errorlibnfc.driver.acr122_usbUnable to claim USB interface (Device or resource busy)</span><br><span class="line">nfc-list: ERROR: Unable to open NFC device: acr122_usb:001:015</span><br><span class="line">$ lsmod | grep pn533</span><br><span class="line">pn533_usb              20480  0</span><br><span class="line">pn533                  36864  1 pn533_usb</span><br><span class="line">nfc                   110592  1 pn533</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æŠ¥é”™å‚è€ƒ <a href="https://github.com/nfc-tools/libnfc/issues/402">nfc-tools&#x2F;libnfc</a> è§£å†³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/modprobe.d/blacklist-libnfc.conf</span><br><span class="line">blacklist nfc</span><br><span class="line">blacklist pn533</span><br><span class="line">blacklist pn533_usb</span><br><span class="line">$ sudo modprobe -rf pn533_usb</span><br><span class="line">$ nfc-list</span><br><span class="line">nfc-list uses libnfc 1.7.1</span><br><span class="line">NFC device: ACS / ACR122U PICC Interface opened</span><br></pre></td></tr></table></figure><p>è¯»å¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nfc-list</span><br><span class="line">nfc-list uses libnfc 1.7.1</span><br><span class="line">NFC device: ACS / ACR122U PICC Interface opened</span><br><span class="line">1 ISO14443A passive target(s) found:</span><br><span class="line">ISO/IEC 14443A (106 kbps) target:</span><br><span class="line">    ATQA (SENS_RES): 00  04  </span><br><span class="line">       UID (NFCID1): xx  xx  0f  7d  </span><br><span class="line">      SAK (SEL_RES): 28  </span><br><span class="line">                ATS: 78  80  90  02  20  90  00  00  00  00  00  xx  xx  0f  7d  </span><br></pre></td></tr></table></figure><p>æ›´å¤šå‚è€ƒä¸Šé¢çš„è„šæœ¬ã€‚</p><h3 id="pm3"><a href="#pm3" class="headerlink" title="pm3"></a>pm3</h3><h4 id="å›ºä»¶ç¼–è¯‘"><a href="#å›ºä»¶ç¼–è¯‘" class="headerlink" title="å›ºä»¶ç¼–è¯‘"></a>å›ºä»¶ç¼–è¯‘</h4><p>å®˜æ–¹å›ºä»¶ä»“åº“æ²¡çœ‹åˆ°æ›´æ–°ï¼Œæœ‰åçš„å°±æ˜¯ icemanï¼ˆå†°äººï¼‰çš„ <a href="https://github.com/RfidResearchGroup/proxmark3">RfidResearchGroup&#x2F;proxmark3</a>ã€‚</p><p>æˆ‘æ˜¯åœ¨æˆ‘çš„ r2s ä¸Šç”¨ docker èµ·ç‰¹æƒå®¹å™¨ç©çš„ï¼Œ<code>apt</code> ç³»åˆ—ç³»ç»Ÿ <code>ldd --version</code> çœ‹çœ‹ glibc ç‰ˆæœ¬ï¼Œå¤§äºç­‰äº 2.27ï¼Œæ¨èèµ· <code>ubuntu:18.04</code> å®¹å™¨ç¼–è¯‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Linuxç³»ç»Ÿä¸­å¯èƒ½å­˜åœ¨ModemManagerï¼Œä»è€Œå¹²æ‰°ç³»ç»Ÿå’Œproxmark3çš„é€šä¿¡ã€‚</span><br><span class="line"> apt remove modemmanager</span><br><span class="line"># è·å–å…³é—­</span><br><span class="line">sudo systemctl stop ModemManager</span><br><span class="line">sudo systemctl disable ModemManager</span><br><span class="line"></span><br><span class="line">git clone https://github.com/RfidResearchGroup/proxmark3</span><br><span class="line">docker run --name t1 --restart always -tid --privileged -v $PWD/proxmark3:/opt/proxmark3 -w /opt/proxmark3 ubuntu:18.04</span><br></pre></td></tr></table></figure><p>å¼€å§‹ç¼–è¯‘çš„ä¾èµ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ -f /etc/apt/sources.list ];then sed -ri &#x27;s/(deb|security|archive|ports).(debian.org|ubuntu.com)/mirrors.aliyun.com/g&#x27; /etc/apt/sources.list; fi &amp;&amp; \</span><br><span class="line">    apt-get update &amp;&amp; \</span><br><span class="line">    DEBIAN_FRONTEND=noninteractive apt install gcc g++ make autoconf pkg-config cmake git libbz2-dev libreadline-dev gcc-arm-none-eabi libssl-dev usbutils -y</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¹‹å‰çœ‹ä¸‹ <code>Makefile.platform.sample</code> ï¼Œä»£ç é‡Œé»˜è®¤æ˜¯ <code>pm3 rdv4</code> ç‰ˆæœ¬ï¼Œå°±æ˜¯ 1k å¤šå…ƒå¸¦è“ç‰™çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ˜¯ pm3 GENERICï¼ˆå³ä¾§ä¸€ä¸ªæŒ‰é’®ï¼Œä¸­é—´ä¸€ä¸ª usb å£ï¼Œçº¿åœˆå†…å°± LF Antenna&#x2F;Rreq: 125kHZçš„ç‰ˆæœ¬ï¼‰ï¼Œæ‰€ä»¥ç¼–è¯‘å‘½ä»¤ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make all PLATFORM=PM3GENERIC</span><br><span class="line"># å•ç‹¬ç¼–è¯‘å®¢æˆ·ç«¯çš„è¯</span><br><span class="line"># make client</span><br></pre></td></tr></table></figure><p>æˆ‘çš„ openwrt èƒ½ç”¨æ˜¯å› ä¸ºæœ‰å¾ˆå¤šæ¨¡å—ï¼Œä¾‹å¦‚ä¸‹é¢çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ opkg list-installed | grep -P &#x27;cdc-|usb-&#x27;</span><br><span class="line">kmod-usb-acm - 5.10.102-1</span><br><span class="line">kmod-usb-core - 5.10.102-1</span><br><span class="line">kmod-usb-net - 5.10.102-1</span><br><span class="line">kmod-usb-net-cdc-eem - 5.10.102-1</span><br><span class="line">kmod-usb-net-cdc-ether - 5.10.102-1</span><br><span class="line">kmod-usb-net-cdc-ncm - 5.10.102-1</span><br><span class="line">kmod-usb-net-rtl8152 - 5.10.102-1</span><br><span class="line">kmod-usb-storage - 5.10.102-1</span><br><span class="line">kmod-usb-storage-extras - 5.10.102-1</span><br><span class="line">kmod-usb-storage-uas - 5.10.102-1</span><br><span class="line">libusb-1.0-0 - 1.0.24-5</span><br></pre></td></tr></table></figure><p>åç»­æ‰‹æœºæƒ³æ“ä½œ pm3 æœ€å¥½çœ‹ä¸‹æ‰‹æœºç¼–è¯‘äº† <code>usb-acm</code> æ²¡ï¼Œä¸€èˆ¬çš„å®˜æ–¹ rom éƒ½ä¸ä¼šå¼€è¿™ä¸ªçš„ã€‚</p><h4 id="pm3-æ“ä½œ"><a href="#pm3-æ“ä½œ" class="headerlink" title="pm3 æ“ä½œ"></a>pm3 æ“ä½œ</h4><p>pm3 æ— è®ºå•¥æ—¶å€™æ’å…¥ linuxï¼Œdmesg é‡Œéƒ½æœ‰ä¸‹é¢ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[862180.046239] usb 2-1: USB disconnect, device number 3</span><br><span class="line">[863606.280680] cdc_acm 2-1:1.0: ttyACM0: USB ACM device</span><br></pre></td></tr></table></figure><p>æœ‰ <code>ttyACM0</code> æ‰æ˜¯å¯¹çš„ï¼Œå¦åˆ™å°±æ˜¯ä½  Linux æ²¡ USB-ACM ç›¸å…³æ¨¡å—ï¼Œæœ‰äº†åä¼šå¤šå‡ºä¸€ä¸ªå­—ç¬¦è®¾å¤‡ <code>/dev/ttyACM0</code> ã€‚</p><h5 id="åˆ·å†™å›ºä»¶"><a href="#åˆ·å†™å›ºä»¶" class="headerlink" title="åˆ·å†™å›ºä»¶"></a>åˆ·å†™å›ºä»¶</h5><p>ä¸Šé¢çš„ make all ä¼šç¼–è¯‘å›ºä»¶å’Œ clientã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">./pm3-flash-fullimage </span><br><span class="line">[=] Session log /root/.proxmark3/logs/log_20220420.txt</span><br><span class="line">[+] About to use the following file:</span><br><span class="line">[+]    /opt/proxmark3/client/../armsrc/obj/fullimage.elf</span><br><span class="line">[+] Loading ELF file /opt/proxmark3/client/../armsrc/obj/fullimage.elf</span><br><span class="line">[+] ELF file version Iceman/master/v4.14831-551-gda81c6806 2022-04-20 20:23:34 617717b0d</span><br><span class="line"></span><br><span class="line">[+] Waiting for Proxmark3 to appear on /dev/ttyACM0</span><br><span class="line"> ğŸ•‘  59 found</span><br><span class="line">[+] Entering bootloader...</span><br><span class="line">[+] (Press and release the button only to abort)</span><br><span class="line">[+] Waiting for Proxmark3 to appear on /dev/ttyACM0</span><br><span class="line"> ğŸ•”  58 found</span><br><span class="line">[=] Available memory on this board: 512K bytes</span><br><span class="line"></span><br><span class="line">[=] Permitted flash range: 0x00102000-0x00180000</span><br><span class="line">[+] Loading usable ELF segments:</span><br><span class="line">[+]    1: V 0x00102000 P 0x00102000 (0x0004e974-&gt;0x0004e974) [R X] @0xb8</span><br><span class="line">[+]    2: V 0x00200000 P 0x00150974 (0x00001ba1-&gt;0x00001ba1) [R X] @0x4ea30</span><br><span class="line">[=] Note: Extending previous segment from 0x4e974 to 0x50515 bytes</span><br><span class="line"></span><br><span class="line">[+] Flashing...</span><br><span class="line">[+] Writing segments for file: /opt/proxmark3/client/../armsrc/obj/fullimage.elf</span><br><span class="line">[+]  0x00102000..0x00152514 [0x50515 / 643 blocks]</span><br><span class="line">...................................................................</span><br><span class="line">        @@@  @@@@@@@ @@@@@@@@ @@@@@@@@@@   @@@@@@  @@@  @@@</span><br><span class="line">        @@! !@@      @@!      @@! @@! @@! @@!  @@@ @@!@!@@@</span><br><span class="line">        !!@ !@!      @!!!:!   @!! !!@ @!@ @!@!@!@! @!@@!!@!</span><br><span class="line">        !!: :!!      !!:      !!:     !!: !!:  !!! !!:  !!!</span><br><span class="line">        :    :: :: : : :: :::  :      :    :   : : ::    : </span><br><span class="line">        .    .. .. . . .. ...  .      .    .   . . ..    . </span><br><span class="line">...................................................................</span><br><span class="line">...................................................................</span><br><span class="line">...................................................................... ok</span><br><span class="line"></span><br><span class="line">[+] All done</span><br><span class="line"></span><br><span class="line">[=] Have a nice day!</span><br></pre></td></tr></table></figure><p>è¿æ¥ pm3</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">$ ./pm3 --list</span><br><span class="line">1: /dev/ttyACM0</span><br><span class="line"></span><br><span class="line">$ ./client/proxmark3 /dev/ttyACM0 </span><br><span class="line">[=] Session log /root/.proxmark3/logs/log_20220420.txt</span><br><span class="line">[+] loaded from JSON file /root/.proxmark3/preferences.json</span><br><span class="line">[=] Using UART port /dev/ttyACM0</span><br><span class="line">[=] Communicating with PM3 over USB-CDC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  8888888b.  888b     d888  .d8888b.   </span><br><span class="line">  888   Y88b 8888b   d8888 d88P  Y88b  </span><br><span class="line">  888    888 88888b.d88888      .d88P  </span><br><span class="line">  888   d88P 888Y88888P888     8888&quot;  </span><br><span class="line">  8888888P&quot;  888 Y888P 888      &quot;Y8b.  </span><br><span class="line">  888        888  Y8P  888 888    888  </span><br><span class="line">  888        888   &quot;   888 Y88b  d88P </span><br><span class="line">  888        888       888  &quot;Y8888P&quot;    [ â„ï¸ ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  [ Proxmark3 RFID instrument ]</span><br><span class="line"></span><br><span class="line">    MCU....... AT91SAM7S512 Rev B</span><br><span class="line">    Memory.... 512 Kb ( 58% used )</span><br><span class="line"></span><br><span class="line">    Client.... Iceman/master/v4.14831-551-gda81c6806 2022-04-20 22:00:05</span><br><span class="line">    Bootrom... Iceman/master/v4.14831-551-gda81c6806 2022-04-20 22:02:34 </span><br><span class="line">    OS........ Iceman/master/v4.14831-551-gda81c6806 2022-04-20 22:04:23 </span><br><span class="line">    Target.... PM3 GENERIC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[usb] pm3 --&gt; hw version</span><br><span class="line"></span><br><span class="line"> [ Proxmark3 RFID instrument ]</span><br><span class="line"></span><br><span class="line"> [ CLIENT ]</span><br><span class="line">  Iceman/master/v4.14831-551-gda81c6806 2022-04-20 22:00:05 617717b0d</span><br><span class="line">  compiled with............. GCC 9.4.0</span><br><span class="line">  platform.................. Linux / aarch64</span><br><span class="line">  Readline support.......... present</span><br><span class="line">  QT GUI support............ absent</span><br><span class="line">  native BT support......... absent</span><br><span class="line">  Python script support..... absent</span><br><span class="line">  Lua SWIG support.......... present</span><br><span class="line">  Python SWIG support....... absent</span><br><span class="line"></span><br><span class="line"> [ PROXMARK3 ]</span><br><span class="line">  firmware.................. PM3 GENERIC</span><br><span class="line"></span><br><span class="line"> [ ARM ]</span><br><span class="line">  bootrom: Iceman/master/v4.14831-551-gda81c6806 2022-04-20 22:02:34 617717b0d</span><br><span class="line">       os: Iceman/master/v4.14831-551-gda81c6806 2022-04-20 22:04:23 617717b0d</span><br><span class="line">  compiled with GCC 9.2.1 20191025 (release) [ARM/arm-9-branch revision 277599]</span><br><span class="line"></span><br><span class="line"> [ FPGA ] </span><br><span class="line">  LF image 2s30vq100 2022-03-23 17:21:05</span><br><span class="line">  HF image 2s30vq100 2022-03-23 17:21:16</span><br><span class="line">  HF FeliCa image 2s30vq100 2022-03-23 17:21:27</span><br><span class="line">  HF 15 image 2s30vq100 2022-03-23 17:21:38</span><br><span class="line"></span><br><span class="line"> [ Hardware ]</span><br><span class="line">  --= uC: AT91SAM7S512 Rev B</span><br><span class="line">  --= Embedded Processor: ARM7TDMI</span><br><span class="line">  --= Internal SRAM size: 64K bytes</span><br><span class="line">  --= Architecture identifier: AT91SAM7Sxx Series</span><br><span class="line">  --= Embedded flash memory 512K bytes ( 58% used )</span><br><span class="line"></span><br><span class="line">[usb] pm3 --&gt; hw status</span><br><span class="line">[#] Memory</span><br><span class="line">[#]   BigBuf_size............. 42760</span><br><span class="line">[#]   Available memory........ 42760</span><br><span class="line">[#] Tracing</span><br><span class="line">[#]   tracing ................ 1</span><br><span class="line">[#]   traceLen ............... 0</span><br><span class="line">[#] Current FPGA image</span><br><span class="line">[#]   mode.................... HF image 2s30vq100 2022-03-23 17:21:16</span><br><span class="line">[#] LF Sampling config</span><br><span class="line">[#]   [q] divisor............. 95 ( 125.00 kHz )</span><br><span class="line">[#]   [b] bits per sample..... 8</span><br><span class="line">[#]   [d] decimation.......... 1</span><br><span class="line">[#]   [a] averaging........... yes</span><br><span class="line">[#]   [t] trigger threshold... 0</span><br><span class="line">[#]   [s] samples to skip..... 0 </span><br><span class="line">[#] </span><br><span class="line">[#] LF T55XX config</span><br><span class="line">[#]            [r]               [a]   [b]   [c]   [d]   [e]   [f]   [g]</span><br><span class="line">[#]            mode            |start|write|write|write| read|write|write</span><br><span class="line">[#]                            | gap | gap |  0  |  1  | gap |  2  |  3</span><br><span class="line">[#] ---------------------------+-----+-----+-----+-----+-----+-----+------</span><br><span class="line">[#] fixed bit length (default) |  31 |  20 |  18 |  50 |  15 | N/A | N/A | </span><br><span class="line">[#]     long leading reference |  31 |  20 |  18 |  50 |  15 | N/A | N/A | </span><br><span class="line">[#]               leading zero |  31 |  20 |  18 |  40 |  15 | N/A | N/A | </span><br><span class="line">[#]    1 of 4 coding reference |  31 |  20 |  18 |  34 |  15 |  50 |  66 | </span><br><span class="line">[#] </span><br><span class="line">[#] HF 14a config</span><br><span class="line">[#]   [a] Anticol override.... std    ( follow standard )</span><br><span class="line">[#]   [b] BCC override........ std    ( follow standard )</span><br><span class="line">[#]   [2] CL2 override........ std    ( follow standard )</span><br><span class="line">[#]   [3] CL3 override........ std    ( follow standard )</span><br><span class="line">[#]   [r] RATS override....... std    ( follow standard )</span><br><span class="line">[#] Transfer Speed</span><br><span class="line">[#]   Sending packets to client...</span><br><span class="line">[#]   Time elapsed................... 500ms</span><br><span class="line">[#]   Bytes transferred.............. 295424</span><br><span class="line">[#]   Transfer Speed PM3 -&gt; Client... 590848 bytes/s</span><br><span class="line">[#] Various</span><br><span class="line">[#]   Max stack usage......... 4088 / 8480 bytes</span><br><span class="line">[#]   Debug log level......... 1 ( error )</span><br><span class="line">[#]   ToSendMax............... -1</span><br><span class="line">[#]   ToSend BUFFERSIZE....... 2308</span><br><span class="line">[#]   Slow clock.............. 30644 Hz</span><br><span class="line">[#] Installed StandAlone Mode</span><br><span class="line">[#]   LF HID26 standalone - aka SamyRun (Samy Kamkar)</span><br><span class="line">[#] </span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="pm3-çš„æ“ä½œ"><a href="#pm3-çš„æ“ä½œ" class="headerlink" title="pm3 çš„æ“ä½œ"></a>pm3 çš„æ“ä½œ</h5><h6 id="åŸºç¡€æ“ä½œ"><a href="#åŸºç¡€æ“ä½œ" class="headerlink" title="åŸºç¡€æ“ä½œ"></a>åŸºç¡€æ“ä½œ</h6><p>ä¸Šé¢è¿æ¥åï¼Œè¿›å…¥åˆ°ä¸€ä¸ªäº¤äº’ï¼Œäº¤äº’é‡Œè¾“å…¥å‘½ä»¤å°±è¡Œäº†ï¼Œæœ‰ç‚¹ç±»ä¼¼äº¤æ¢æœºå’Œå•ç‰‡æœºé‡Œçš„ AT æŒ‡ä»¤ï¼Œå¯ä»¥ <code>help</code> æŸ¥çœ‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å‘½ä»¤çš„å¸®åŠ©å°± <code>å‘½ä»¤ --help</code>ã€<code>å‘½ä»¤ å­å‘½ä»¤ --help</code> ä¾æ¬¡ç±»æ¨ï¼Œä½ æœåˆ°çš„å¾ˆå¤šæ–‡ç« éƒ½æ˜¯è€å‘½ä»¤ï¼Œæ ¹æ®å›ºä»¶é‡Œå®é™…æ¥ã€‚</p><p><code>lf</code> å’Œ <code>hf</code> å¯¹åº”ä½é¢‘å’Œé«˜é¢‘å‘½ä»¤ï¼Œä¾‹å¦‚æˆ‘ä»¬æ‰«æ M1 å¡ç‰‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[usb] pm3 --&gt; hf search</span><br><span class="line"> ??  Searching for ISO14443-A tag...          </span><br><span class="line">[+]  UID: XX XX 0F 7D </span><br><span class="line">[+] ATQA: 00 04</span><br><span class="line">[+]  SAK: 28 [1]</span><br><span class="line">[+] Possible types:</span><br><span class="line">[+]    SmartMX with MIFARE Classic 1K</span><br><span class="line">[=] -------------------------- ATS --------------------------</span><br><span class="line">[+] ATS: 10 78 80 90 02 20 90 00 00 00 00 00 XX XX 0F 7D [ ED 00 ]</span><br><span class="line">[=]      10...............  TL    length is 16 bytes</span><br><span class="line">[=]         78............  T0    TA1 is present, TB1 is present, TC1 is present, FSCI is 8 (FSC = 256)</span><br><span class="line">[=]            80.........  TA1   different divisors are NOT supported, DR: [], DS: []</span><br><span class="line">[=]               90......  TB1   SFGI = 0 (SFGT = (not needed) 0/fc), FWI = 9 (FWT = 2097152/fc)</span><br><span class="line">[=]                  02...  TC1   NAD is NOT supported, CID is supported</span><br><span class="line"></span><br><span class="line">[=] -------------------- Historical bytes --------------------</span><br><span class="line">[+]   20900000000000XXXX0F7D</span><br><span class="line"></span><br><span class="line">[+] Prng detection: weak</span><br><span class="line">[#] Auth error</span><br><span class="line">[?] Hint: try `hf mf` commands</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Valid ISO 14443-A tag found</span><br><span class="line"></span><br><span class="line">[=] Short AID search:</span><br><span class="line">[?] Hint: try emv commands</span><br></pre></td></tr></table></figure><h6 id="å—…æ¢"><a href="#å—…æ¢" class="headerlink" title="å—…æ¢"></a>å—…æ¢</h6><p>ä¸»è¦åˆ©ç”¨ sniff å‘½ä»¤å—…æ¢ï¼Œæ¯”å¦‚å¸¸è§çš„ 14a å¡ç‰‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[usb] pm3 --&gt; hf 14a sniff</span><br><span class="line"></span><br><span class="line">[#] Starting to sniffã€‚ Press PM3 Button to stop.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åä¿æŒä¸Šç”µï¼Œæ‹¿å»åˆ·å¡ï¼Œ<code>å¡</code> â€“ <code>pm3</code> â€“ <code>åˆ·å¡è®¾å¤‡</code> ï¼Œå¤šåˆ·å‡ ä¸‹ï¼Œç­‰ pm3 ä¸¤ä¸ªç¯äº¤å‰é—ªçƒåå¸¸äº®ï¼ŒæŒ‰ä¸‹ Button æŒ‰é’®ï¼Œpm3 å®¢æˆ·ç«¯ä¼šæ˜¾ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[#] trace len = xxxx</span><br></pre></td></tr></table></figure><p>æ­¤åˆ»èµ¶ç´§ä¿å­˜ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[usb] pm3 --&gt; data save -f xxx</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ†æï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[usb] pm3 --&gt; trace list -t 14a</span><br></pre></td></tr></table></figure><p>è¿æ°”å¥½èƒ½åˆ†æåˆ° <code>PWD-AUTH KEY</code> ï¼Œç„¶åç ´è§£ï¼Œå‚è€ƒ <a href="https://raycn.pub/2021/08/21/reset-xiaomi-air-purifier-filters/">ã€PM3ã€‘é‡ç½®å°ç±³ç©ºæ°”å‡€åŒ–å™¨æ»¤èŠ¯</a>ã€‚è¿æ°”ä¸å¥½å°±æ— æ³•å—…æ¢ã€‚</p><h3 id="ç ´è§£çš„ä¸€äº›è¯´æ˜"><a href="#ç ´è§£çš„ä¸€äº›è¯´æ˜" class="headerlink" title="ç ´è§£çš„ä¸€äº›è¯´æ˜"></a>ç ´è§£çš„ä¸€äº›è¯´æ˜</h3><ol><li>æŠŠå¡ç‰‡è§£å¯†å dump å‡ºæ¥ï¼Œdump çš„æ•°æ®æ˜¯æ²¡åŠ å¯†çš„ï¼Œå†å†™å…¥ç™½å¡ï¼Œæ‰‹æœºæˆ–è€…æ‰‹ç¯å†è¯»å–ç™½å¡æ¨¡æ‹Ÿ</li><li>è®¾å¤‡å¯ä»¥è¯»å– dump æ•°æ®å†™å…¥æ‰‹æœºçš„ nfc å¡ç‰‡é‡Œï¼Œä½†æ˜¯æœ€å¥½ä¸è¦è¿™æ ·åšï¼Œå¾ˆå¤šæ‰‹æœºçš„ nfc æ˜¯å•ç‹¬ä¸€å—ç”µè·¯ï¼Œä¸è·Ÿéšåˆ·æœºæ¢å¤å‡ºå‚è®¾ç½®çš„ï¼Œè¯»å†™å¯èƒ½ä¼šæŸå nfc ç›¸å…³ç¡¬ä»¶åªæœ‰æ¢ä¸»æ¿äº†ã€‚</li><li>æœ‰äº›é—¨ç¦è®¾å¤‡æ˜¯è¿˜æ ¡éªŒå‚å•†ç çš„ï¼Œè¿™ç§å°±æ”¾å¼ƒå§ï¼Œæ‰‹æœºæ¨¡æ‹Ÿç™½å¡ä¸ä¼šè®©å†™å‚å•†ç çš„ï¼Œæ¶‰åŠåˆ°æ³•å¾‹é—®é¢˜ã€‚</li><li>æœ‰äº›å…¬å¸çš„ oa è½¯ä»¶æ”¯æŒæ·»åŠ ç”µå­å·¥ç‰Œï¼Œå®é™…æ·»åŠ è¡Œä¸ºæ˜¯ oa è½¯ä»¶é‡Œç‚¹äº†æ·»åŠ åä¼šç»™æ‰‹æœºçš„é’±åŒ…-nfc æ·»åŠ ä¸€å¼ æ¨¡æ‹Ÿå¡ç‰‡ï¼Œè¿™ä¸ªå¡ç‰‡æ˜¯ cpu æ¨¡æ‹Ÿå¡ï¼ŒSAK æ˜¾ç¤º 20ï¼Œè¯´æ˜é—¨ç¦è”ç½‘çš„ã€‚</li></ol><h3 id="å…¶ä»–è¡¥å……"><a href="#å…¶ä»–è¡¥å……" class="headerlink" title="å…¶ä»–è¡¥å……"></a>å…¶ä»–è¡¥å……</h3><ol><li>windows æˆ‘æœ‰å®‰è£…ä¸²å£é©±åŠ¨ï¼Œä½†æ˜¯ä¸‹çš„ client å’Œ GUI éƒ½æ— æ³•é€šè¿‡ COM å£è¿ä¸Š pm3 ï¼Œè¿›å®‰å…¨æ¨¡å¼å®‰è£… <a href="https://github.com/RfidResearchGroup/proxmark3/tree/master/driver">å®˜æ–¹çš„é©±åŠ¨</a> ä¹Ÿä¸è¡Œã€‚å°è¯•è¿‡ä¸²å£è½¯ä»¶æ‰“å¼€ com å£ï¼Œçœ‹æºç æ˜¯ <code>baud=115200 parity=N data=8 stop=1</code>ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸è¡Œ</li><li>å®‰å“å®¢æˆ·ç«¯ <a href="https://github.com/AndProx/AndProx">AndProx&#x2F;AndProx</a> å› ä¸ºæˆ‘æ‰‹æœºå†…æ ¸ç¼–è¯‘æ²¡å¼€ <code>USB_ACM</code> å¯¼è‡´æ— æ³•ä½¿ç”¨ï¼Œ<a href="https://github.com/RfidResearchGroup/proxmark3/blob/master/doc/termux_notes.md">termux</a> åŒæ ·ã€‚</li><li>å¤šçœ‹çœ‹ <a href="https://github.com/RfidResearchGroup/proxmark3/blob/master/README.md">å®˜æ–¹çš„ README.md</a></li></ol><p>ä¹Ÿæœ‰ç¦»çº¿å—…æ¢å›ºä»¶ï¼Œæˆ‘å°±ä¸æŠ˜è…¾äº†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://raycn.pub/2021/08/21/reset-xiaomi-air-purifier-filters/">ã€PM3ã€‘é‡ç½®å°ç±³ç©ºæ°”å‡€åŒ–å™¨æ»¤èŠ¯</a></li><li><a href="https://pm3.echo.cool/index.php/2018/08/21/pm3%E7%A6%BB%E7%BA%BF%E5%97%85%E6%8E%A2%E8%AF%B4%E6%98%8E/">PM3ç¦»çº¿å—…æ¢è¯´æ˜</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿‘æœŸæŠ˜è…¾ nfc ç›¸å…³ï¼Œä»¥å nfc çš„æŠ˜è…¾ä¹Ÿä¼šæ›´æ–°åœ¨è¿™ä¸ªæ–‡ç« å†…&lt;/p&gt;</summary>
    
    
    
    
    <category term="nfc" scheme="http://zhangguanzhang.github.io/tags/nfc/"/>
    
    <category term="pm3" scheme="http://zhangguanzhang.github.io/tags/pm3/"/>
    
  </entry>
  
  <entry>
    <title>docker containerd ä¸å®šæ—¶çš„ segfault çš„ä¸€æ¬¡å¤„ç†è¿‡ç¨‹</title>
    <link href="http://zhangguanzhang.github.io/2022/04/22/segfault-often/"/>
    <id>http://zhangguanzhang.github.io/2022/04/22/segfault-often/</id>
    <published>2022-04-22T10:15:30.000Z</published>
    <updated>2022-04-22T10:15:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>å®¢æˆ·ç¯å¢ƒ docker å’Œ containerd å¯åŠ¨æ—¶ä¸æ—¶ segment fault çš„ä¸€æ¬¡å¤„ç†è¿‡ç¨‹ã€‚</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>é—®é¢˜æ‹‰æˆ‘å¤„ç†æ˜¯ <code>04/15</code> å·ï¼Œç°è±¡æ˜¯å®¢æˆ·çš„æ ¹åˆ†åŒºè¢«æ’‘çˆ†äº†ï¼Œåå° tty è¿›å»çœ‹äº†ä¸‹æ˜¯æ ¹ç›®å½•å……æ»¡äº† <code>core.$pid</code> çš„ coredump æ–‡ä»¶ã€‚ç„¶åæ¸…ç†åé‡å¯å‘ç°å¾ˆå¤šå®¹å™¨èµ·ä¸æ¥ã€‚ç„¶åå–Šæˆ‘æ¥çœ‹ä¸‹ã€‚</p><h2 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h2><p>å®¢æˆ·ç³»ç»Ÿæ˜¯ centos7.9 ï¼Œå…ˆä½¿ç”¨ <code>systemctl status docker</code> çœ‹äº†ä¸‹ docker è¿è¡Œä¸€æ®µæ—¶é—´åå°±å´©äº†ï¼Œå‰å°å¯åŠ¨è°ƒè¯•ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ dockerd --version</span><br><span class="line">Docker version 19.03.14, build 5eb3275</span><br><span class="line">$ systemctl stop kubelet docker</span><br><span class="line">$ dockerd --debug</span><br></pre></td></tr></table></figure><p>ç„¶åå‘ç°æ¯æ¬¡ dockerd é€€å‡ºæ—¥å¿—ä¸ä¸€æ ·ï¼Œæœ‰æ—¶å€™æ˜¯ <code>segment fault</code>ï¼Œæœ‰æ—¶å€™æŠ¥é”™æ— æ³•é€šè¿‡ <code>/var/run/docker/containerd/containerd.sock</code> è¿æ¥ containerdï¼Œè¯¥ sock æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ ¹æ®è¿™ä¸ªæŠ¥é”™å¯ä»¥çœ‹å‡ºæ¥ containerd æ— æ³•å¯åŠ¨ã€‚å¯ä»¥é€šè¿‡ <a href="https://github.com/docker/docker-ce/blob/d7080c17a580919f5340a15a8e5e013133089680/components/engine/libcontainerd/remote_daemon.go#L205-244">æºç </a> å¾—çŸ¥ï¼Œå¦‚æœæ²¡å¯åŠ¨ containerd ï¼Œdocker åˆ™ä¼š os.Exec èµ·ä¸€ä¸ª <code>containerd</code> ã€‚</p><p>æˆ‘ä»¬çš„ docker æ˜¯å®˜æ–¹çš„ static bin å®‰è£…çš„ï¼Œå¦‚æœæ˜¯å®˜æ–¹åŒ…ç®¡ç†å®‰è£…çš„è¯ï¼Œcontainerd ä¼šç”± systemd å¯åŠ¨ï¼Œdocker bin çš„æ–¹å¼çš„è¯ï¼Œä¼šç”± dockerd ä½¿ç”¨ exec æ–¹å¼å¯åŠ¨ä¸€ä¸ª containerdï¼Œæ‰¾ä¸ªåŒç‰ˆæœ¬çš„æŸ¥è¯¢ä¸‹ cmdline åæ‰‹åŠ¨å‰å° debug log-level å¯åŠ¨ä¸‹ containerdï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">$ containerd --config /var/run/docker/containerd/containerd.toml --log-level debug   </span><br><span class="line">INFO[2022-04-15T14:14:01.755841221+08:00] starting containerd                           revision=ea765aba0d05254012b0b9e595e995c09186427f version=v1.3.9</span><br><span class="line">DEBU[2022-04-15T14:14:01.755989919+08:00] changing OOM score to -500                   </span><br><span class="line">INFO[2022-04-15T14:14:01.787587081+08:00] loading plugin &quot;io.containerd.content.v1.content&quot;...  type=io.containerd.content.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.787837808+08:00] loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.790684367+08:00] skip loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  error=&quot;path /data/kube/docker/containerd/daemon/io.containerd.snapshotter.v1.btrfs (xfs) must be a btrfs filesystem to be used with the btrfs snapshotter: skip plugin&quot; type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.790779651+08:00] loading plugin &quot;io.containerd.snapshotter.v1.devmapper&quot;...  type=io.containerd.snapshotter.v1</span><br><span class="line">WARN[2022-04-15T14:14:01.790827944+08:00] failed to load plugin io.containerd.snapshotter.v1.devmapper  error=&quot;devmapper not configured&quot;</span><br><span class="line">INFO[2022-04-15T14:14:01.790850382+08:00] loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.793069978+08:00] skip loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  error=&quot;modprobe aufs failed: \&quot;modprobe: FATAL: Module aufs not found.\\n\&quot;: exit status 1: skip plugin&quot; type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.793133838+08:00] loading plugin &quot;io.containerd.snapshotter.v1.native&quot;...  type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.793229323+08:00] loading plugin &quot;io.containerd.snapshotter.v1.overlayfs&quot;...  type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.793392157+08:00] loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.794994033+08:00] skip loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  error=&quot;path /data/kube/docker/containerd/daemon/io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter: skip plugin&quot; type=io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.795033213+08:00] loading plugin &quot;io.containerd.metadata.v1.bolt&quot;...  type=io.containerd.metadata.v1</span><br><span class="line">WARN[2022-04-15T14:14:01.795068521+08:00] could not use snapshotter devmapper in metadata plugin  error=&quot;devmapper not configured&quot;</span><br><span class="line">INFO[2022-04-15T14:14:01.795097127+08:00] metadata content store policy set             policy=shared</span><br><span class="line">INFO[2022-04-15T14:14:01.795925864+08:00] loading plugin &quot;io.containerd.differ.v1.walking&quot;...  type=io.containerd.differ.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.795966063+08:00] loading plugin &quot;io.containerd.gc.v1.scheduler&quot;...  type=io.containerd.gc.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796083519+08:00] loading plugin &quot;io.containerd.service.v1.containers-service&quot;...  type=io.containerd.service.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796116546+08:00] loading plugin &quot;io.containerd.service.v1.content-service&quot;...  type=io.containerd.service.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796143806+08:00] loading plugin &quot;io.containerd.service.v1.diff-service&quot;...  type=io.containerd.service.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796174035+08:00] loading plugin &quot;io.containerd.service.v1.images-service&quot;...  type=io.containerd.service.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796201988+08:00] loading plugin &quot;io.containerd.service.v1.leases-service&quot;...  type=io.containerd.service.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796236554+08:00] loading plugin &quot;io.containerd.service.v1.namespaces-service&quot;...  type=io.containerd.service.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796274839+08:00] loading plugin &quot;io.containerd.service.v1.snapshots-service&quot;...  type=io.containerd.service.v1</span><br><span class="line">INFO[2022-04-15T14:14:01.796309507+08:00] loading plugin &quot;io.containerd.runtime.v1.linux&quot;...  type=io.containerd.runtime.v1</span><br><span class="line">DEBU[2022-04-15T14:14:01.796470242+08:00] loading tasks in namespace                    namespace=moby</span><br><span class="line">ERRO[2022-04-15T14:14:01.796797091+08:00] connecting to shim                            error=&quot;dial unix \x00/containerd-shim/moby/427b5abebd744817fe9cf8c0aa2febadff17d5905e830d3236bb46fa58d6858b/shim.sock: connect: connection refused&quot; id=427b5abebd744817fe9cf8c0aa2febadff17d5905e830d3236bb46fa58d6858b namespace=moby</span><br><span class="line">WARN[2022-04-15T14:14:01.796844852+08:00] cleaning up after shim dead                   id=427b5abebd744817fe9cf8c0aa2febadff17d5905e830d3236bb46fa58d6858b namespace=moby</span><br><span class="line">DEBU[2022-04-15T14:14:01.809292656+08:00] event published                               ns=moby topic=/tasks/exit type=containerd.events.TaskExit</span><br><span class="line">DEBU[2022-04-15T14:14:01.810296940+08:00] event published                               ns=moby topic=/tasks/delete type=containerd.events.TaskDelete</span><br><span class="line">ERRO[2022-04-15T14:14:01.810491037+08:00] connecting to shim                            error=&quot;dial unix /run/containerd/s/058682ed3ebcc6c9b8d37022b1d379d2d11dbf583467c8d834cc09b3d0c76fea: connect: connection refused&quot; id=44d4a81a122079c684c2a45fcd412c8dc2eef3e4e3569ecae2332ac450b80076 namespace=moby</span><br><span class="line">WARN[2022-04-15T14:14:01.810533770+08:00] cleaning up after shim dead                   id=44d4a81a122079c684c2a45fcd412c8dc2eef3e4e3569ecae2332ac450b80076 namespace=moby</span><br><span class="line">DEBU[2022-04-15T14:14:01.823164929+08:00] event published                               ns=moby topic=/tasks/exit type=containerd.events.TaskExit</span><br><span class="line">DEBU[2022-04-15T14:14:01.823795277+08:00] event published                               ns=moby topic=/tasks/delete type=containerd.events.TaskDelete</span><br><span class="line">ERRO[2022-04-15T14:14:01.823953161+08:00] connecting to shim                            error=&quot;dial unix /run/containerd/s/96bd5e94f86fc8e5752989ee5f22f46924d7deea59c7b8ef11087186f81ca50b: connect: connection refused&quot; id=52aa8ad1be01f3f947bcd2f03197771f1b965b0733f3d4026a58d77979618966 namespace=moby</span><br><span class="line">WARN[2022-04-15T14:14:01.823995417+08:00] cleaning up after shim dead                   id=52aa8ad1be01f3f947bcd2f03197771f1b965b0733f3d4026a58d77979618966 namespace=moby</span><br><span class="line">DEBU[2022-04-15T14:14:01.835741082+08:00] event published                               ns=moby topic=/tasks/exit type=containerd.events.TaskExit</span><br><span class="line">DEBU[2022-04-15T14:14:01.836774408+08:00] event published                               ns=moby topic=/tasks/delete type=containerd.events.TaskDelete</span><br><span class="line">ERRO[2022-04-15T14:14:01.836931317+08:00] connecting to shim                            error=&quot;dial unix \x00/containerd-shim/moby/6b1fb39b4c5ad46612b6755f652d608ef75b3374f719b08a67cac1b7f4ddf646/shim.sock: connect: connection refused&quot; id=6b1fb39b4c5ad46612b6755f652d608ef75b3374f719b08a67cac1b7f4ddf646 namespace=moby</span><br><span class="line">WARN[2022-04-15T14:14:01.836979896+08:00] cleaning up after shim dead                   id=6b1fb39b4c5ad46612b6755f652d608ef75b3374f719b08a67cac1b7f4ddf646 namespace=moby</span><br><span class="line">DEBU[2022-04-15T14:14:01.849530967+08:00] event published                               ns=moby topic=/tasks/exit type=containerd.events.TaskExit</span><br><span class="line">ERRO[2022-04-15T14:14:01.862000189+08:00] delete bundle                                 error=&quot;rename /data/kube/docker/containerd/daemon/io.containerd.runtime.v1.linux/moby/6b1fb39b4c5ad46612b6755f652d608ef75b3374f719b08a67cac1b7f4ddf646 /data/kube/docker/containerd/daemon/io.containerd.runtime.v1.linux/moby/.6b1fb39b4c5ad46612b6755f652d608ef75b3374f719b08a67cac1b7f4ddf646: file exists&quot;</span><br><span class="line">DEBU[2022-04-15T14:14:01.862166378+08:00] event published                               ns=moby topic=/tasks/delete type=containerd.events.TaskDelete</span><br><span class="line">ERRO[2022-04-15T14:14:01.862300707+08:00] connecting to shim                            error=&quot;dial unix \x00/containerd-shim/moby/b49a6d51e1a8997440bbcb6e9267a76d8ce2f24a684454890ae98600de364f64/shim.sock: connect: connection refused&quot; id=b49a6d51e1a8997440bbcb6e9267a76d8ce2f24a684454890ae98600de364f64 namespace=moby</span><br><span class="line">WARN[2022-04-15T14:14:01.862334378+08:00] cleaning up after shim dead                   id=b49a6d51e1a8997440bbcb6e9267a76d8ce2f24a684454890ae98600de364f64 namespace=moby</span><br><span class="line">DEBU[2022-04-15T14:14:01.877502812+08:00] event published                               ns=moby topic=/tasks/exit type=containerd.events.TaskExit</span><br><span class="line">DEBU[2022-04-15T14:14:01.877994394+08:00] event published                               ns=moby topic=/tasks/delete type=containerd.events.TaskDelete</span><br><span class="line">ERRO[2022-04-15T14:14:01.878143864+08:00] connecting to shim                            error=&quot;dial unix /run/containerd/s/b538e3e9b252cc635009139b544114a233b3cc34ca48925588da77aa15cdf90a: connect: connection refused&quot; id=b902f9e634100578e9ab38eeaf9a27224d843035ae33a368d65efc071393bd2f namespace=moby</span><br><span class="line">WARN[2022-04-15T14:14:01.878183396+08:00] cleaning up after shim dead                   id=b902f9e634100578e9ab38eeaf9a27224d843035ae33a368d65efc071393bd2f namespace=moby</span><br><span class="line">DEBU[2022-04-15T14:14:01.895566880+08:00] event published                               ns=moby topic=/tasks/exit type=containerd.events.TaskExit</span><br><span class="line">DEBU[2022-04-15T14:14:01.896242084+08:00] event published                               ns=moby topic=/tasks/delete type=containerd.events.TaskDelete</span><br><span class="line">ERRO[2022-04-15T14:14:01.896450640+08:00] connecting to shim                            error=&quot;dial unix /run/containerd/s/4d17ae4e022c51c38d6eff249e4a50d6eaceba757f043204ae68b9382271b0da: connect: connection refused&quot; id=dc31940495385987c90e96c333014f1ac7dc7eddb5e3f45acb19877c79e22893 namespace=moby</span><br><span class="line">WARN[2022-04-15T14:14:01.896496784+08:00] cleaning up after shim dead                   id=dc31940495385987c90e96c333014f1ac7dc7eddb5e3f45acb19877c79e22893 namespace=moby</span><br><span class="line">DEBU[2022-04-15T14:14:01.904116791+08:00] garbage collected                             d=7.541562ms</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">0x40c05f</span><br><span class="line">fatal error: bad lfnode address</span><br><span class="line">[signal SIGSEGV: segmentation violation code=0x80 addr=0x0 pc=0x45cf1f]</span><br><span class="line"></span><br><span class="line">runtime stack:</span><br><span class="line">runtime: unexpected return pc for runtime.lfnodeValidate called from 0x0</span><br><span class="line">stack: frame=&#123;sp:0x7f5918d8f5d8, fp:0x7f5918d8f600&#125; stack=[0x7f5918594148,0x7f5918d93d48)</span><br><span class="line">00007f5918d8f4d8:  000000c000000900  01000000000003e8 </span><br><span class="line">00007f5918d8f4e8:  0000000000000004  000000000000001f </span><br><span class="line">00007f5918d8f4f8:  000000000045cf1f &lt;runtime.GoroutineProfile.func2+47&gt;  0000000000000000 </span><br><span class="line">00007f5918d8f508:  0000000000000080  00000000013f1515 </span><br><span class="line">00007f5918d8f518:  00007f5918d8f560  000000000045d961 &lt;runtime.fatalthrow.func1+97&gt; </span><br><span class="line">00007f5918d8f528:  000000c000000900  0000000000430dd4 &lt;runtime.throw+116&gt; </span><br><span class="line">00007f5918d8f538:  00007f5918d8f5a8  0000000000000001 </span><br><span class="line">00007f5918d8f548:  00007f5918d8f5a8  0000000000430dd4 &lt;runtime.throw+116&gt; </span><br><span class="line">00007f5918d8f558:  000000c000000900  00007f5918d8f598 </span><br><span class="line">00007f5918d8f568:  0000000000430fa9 &lt;runtime.fatalthrow+89&gt;  00007f5918d8f578 </span><br><span class="line">00007f5918d8f578:  000000000045d900 &lt;runtime.fatalthrow.func1+0&gt;  000000c000000900 </span><br><span class="line">00007f5918d8f588:  0000000000430dd4 &lt;runtime.throw+116&gt;  00007f5918d8f5a8 </span><br><span class="line">00007f5918d8f598:  00007f5918d8f5c8  0000000000430dd4 &lt;runtime.throw+116&gt; </span><br><span class="line">00007f5918d8f5a8:  00007f5918d8f5b0  000000000045d870 &lt;runtime.throw.func1+0&gt; </span><br><span class="line">00007f5918d8f5b8:  00000000013dce54  0000000000000012 </span><br><span class="line">00007f5918d8f5c8:  00007f5918d8f608  000000000040beba &lt;runtime.lfnodeValidate+170&gt; </span><br><span class="line">00007f5918d8f5d8: &lt;00000000013dce54  0000000000000012 </span><br><span class="line">00007f5918d8f5e8:  00000000004317a0 &lt;runtime.recordForPanic+304&gt;  000000000274594b </span><br><span class="line">00007f5918d8f5f8: !0000000000000000 &gt;0000000000000000 </span><br><span class="line">00007f5918d8f608:  00007f5918d8f648  0000000000000000 </span><br><span class="line">00007f5918d8f618:  00007f5918d8f650  00000000004317a0 &lt;runtime.recordForPanic+304&gt; </span><br><span class="line">00007f5918d8f628:  000000000274594b  0000000000000004 </span><br><span class="line">00007f5918d8f638:  00007f5918d8f670  00000000004317a0 &lt;runtime.recordForPanic+304&gt; </span><br><span class="line">00007f5918d8f648:  00007f5918d8f668  000000000043183d &lt;runtime.printlock+109&gt; </span><br><span class="line">00007f5918d8f658:  00000000027445b0  000000c000074380 </span><br><span class="line">00007f5918d8f668:  00007f5918d8f698  000000000045d8a6 &lt;runtime.throw.func1+54&gt; </span><br><span class="line">00007f5918d8f678:  0000000000431967 &lt;runtime.gwrite+167&gt;  0000000000000002 </span><br><span class="line">00007f5918d8f688:  000000000000002a  00000000014054d6 </span><br><span class="line">00007f5918d8f698:  00007f5918d8f6c8  0000000000430dad &lt;runtime.throw+77&gt; </span><br><span class="line">00007f5918d8f6a8:  00007f5918d8f6b0  000000000045d870 &lt;runtime.throw.func1+0&gt; </span><br><span class="line">00007f5918d8f6b8:  00000000014054d6  000000000000002a </span><br><span class="line">00007f5918d8f6c8:  00007f5918d8f6f8  0000000000446a60 &lt;runtime.sigpanic+1152&gt; </span><br><span class="line">00007f5918d8f6d8:  00000000014054d6  000000000000002a </span><br><span class="line">00007f5918d8f6e8:  00000000013c9053  0000000000000001 </span><br><span class="line">00007f5918d8f6f8:  00007f5918d8f720 </span><br><span class="line">runtime.throw(0x13dce54, 0x12)</span><br><span class="line">        /usr/local/go/src/runtime/panic.go:774 +0x74</span><br><span class="line">runtime: unexpected return pc for runtime.lfnodeValidate called from 0x0</span><br><span class="line">stack: frame=&#123;sp:0x7f5918d8f5d8, fp:0x7f5918d8f600&#125; stack=[0x7f5918594148,0x7f5918d93d48)</span><br><span class="line">00007f5918d8f4d8:  000000c000000900  01000000000003e8 </span><br><span class="line">00007f5918d8f4e8:  0000000000000004  000000000000001f </span><br><span class="line">00007f5918d8f4f8:  000000000045cf1f &lt;runtime.GoroutineProfile.func2+47&gt;  0000000000000000 </span><br><span class="line">00007f5918d8f508:  0000000000000080  00000000013f1515 </span><br><span class="line">00007f5918d8f518:  00007f5918d8f560  000000000045d961 &lt;runtime.fatalthrow.func1+97&gt; </span><br><span class="line">00007f5918d8f528:  000000c000000900  0000000000430dd4 &lt;runtime.throw+116&gt; </span><br><span class="line">00007f5918d8f538:  00007f5918d8f5a8  0000000000000001 </span><br><span class="line">00007f5918d8f548:  00007f5918d8f5a8  0000000000430dd4 &lt;runtime.throw+116&gt; </span><br><span class="line">00007f5918d8f558:  000000c000000900  00007f5918d8f598 </span><br><span class="line">00007f5918d8f568:  0000000000430fa9 &lt;runtime.fatalthrow+89&gt;  00007f5918d8f578 </span><br><span class="line">00007f5918d8f578:  000000000045d900 &lt;runtime.fatalthrow.func1+0&gt;  000000c000000900 </span><br><span class="line">00007f5918d8f588:  0000000000430dd4 &lt;runtime.throw+116&gt;  00007f5918d8f5a8 </span><br><span class="line">00007f5918d8f598:  00007f5918d8f5c8  0000000000430dd4 &lt;runtime.throw+116&gt; </span><br><span class="line">00007f5918d8f5a8:  00007f5918d8f5b0  000000000045d870 &lt;runtime.throw.func1+0&gt; </span><br><span class="line">00007f5918d8f5b8:  00000000013dce54  0000000000000012 </span><br><span class="line">00007f5918d8f5c8:  00007f5918d8f608  000000000040beba &lt;runtime.lfnodeValidate+170&gt; </span><br><span class="line">00007f5918d8f5d8: &lt;00000000013dce54  0000000000000012 </span><br><span class="line">00007f5918d8f5e8:  00000000004317a0 &lt;runtime.recordForPanic+304&gt;  000000000274594b </span><br><span class="line">00007f5918d8f5f8: !0000000000000000 &gt;0000000000000000 </span><br><span class="line">00007f5918d8f608:  00007f5918d8f648  0000000000000000 </span><br><span class="line">00007f5918d8f618:  00007f5918d8f650  00000000004317a0 &lt;runtime.recordForPanic+304&gt; </span><br><span class="line">00007f5918d8f628:  000000000274594b  0000000000000004 </span><br><span class="line">00007f5918d8f638:  00007f5918d8f670  00000000004317a0 &lt;runtime.recordForPanic+304&gt; </span><br><span class="line">00007f5918d8f648:  00007f5918d8f668  000000000043183d &lt;runtime.printlock+109&gt; </span><br><span class="line">00007f5918d8f658:  00000000027445b0  000000c000074380 </span><br><span class="line">00007f5918d8f668:  00007f5918d8f698  000000000045d8a6 &lt;runtime.throw.func1+54&gt; </span><br><span class="line">00007f5918d8f678:  0000000000431967 &lt;runtime.gwrite+167&gt;  0000000000000002 </span><br><span class="line">00007f5918d8f688:  000000000000002a  00000000014054d6 </span><br><span class="line">00007f5918d8f698:  00007f5918d8f6c8  0000000000430dad &lt;runtime.throw+77&gt; </span><br><span class="line">00007f5918d8f6a8:  00007f5918d8f6b0  000000000045d870 &lt;runtime.throw.func1+0&gt; </span><br><span class="line">00007f5918d8f6b8:  00000000014054d6  000000000000002a </span><br><span class="line">00007f5918d8f6c8:  00007f5918d8f6f8  0000000000446a60 &lt;runtime.sigpanic+1152&gt; </span><br><span class="line">00007f5918d8f6d8:  00000000014054d6  000000000000002a </span><br><span class="line">00007f5918d8f6e8:  00000000013c9053  0000000000000001 </span><br><span class="line">00007f5918d8f6f8:  00007f5918d8f720 </span><br><span class="line">runtime.lfnodeValidate(0x0)</span><br><span class="line">        /usr/local/go/src/runtime/lfstack.go:65 +0xaa</span><br><span class="line"></span><br><span class="line">goroutine 1 [chan receive]:</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.(*defaultMonitor).Wait(0x2744360, 0xc0002738c0, 0xc00035e4e0, 0x0, 0x0, 0x3d54454b434f)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/monitor.go:74 +0x50</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.cmdOutput(0xc0002738c0, 0xc0002ee301, 0x0, 0x0, 0x0, 0x0, 0x0)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/runc.go:709 +0x14e</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.(*Runc).runOrError(0xc00055ec80, 0xc0002738c0, 0xc0002cee40, 0xc00004ee40)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/runc.go:689 +0x186</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.(*Runc).Delete(0xc00055ec80, 0x1bcd9e0, 0xc0002cee40, 0xc000016796, 0x40, 0xc00062cd77, 0x40, 0xc00055ec80)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/runc.go:302 +0x16a</span><br><span class="line">github.com/containerd/containerd/runtime/v1/linux.(*Runtime).terminate(0xc000240960, 0x1bcd9e0, 0xc0002cee40, 0xc0002cea80, 0xc00010d5d1, 0x4, 0xc000016796, 0x40, 0x1, 0x1)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/runtime/v1/linux/runtime.go:473 +0xfc</span><br><span class="line">github.com/containerd/containerd/runtime/v1/linux.(*Runtime).cleanupAfterDeadShim(0xc000240960, 0x1bcd9e0, 0xc0002cee40, 0xc0002cea80, 0xc00010d5d1, 0x4, 0xc000016796, 0x40, 0x1b938c0, 0xc00003caf0)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/runtime/v1/linux/runtime.go:432 +0x386</span><br><span class="line">github.com/containerd/containerd/runtime/v1/linux.(*Runtime).loadTasks(0xc000240960, 0x1bcd960, 0xc000040098, 0xc00010d5d1, 0x4, 0x0, 0x0, 0xc00062e610, 0x439d71, 0xc000052500)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/runtime/v1/linux/runtime.go:362 +0xa28</span><br><span class="line">github.com/containerd/containerd/runtime/v1/linux.(*Runtime).restoreTasks(0xc000240960, 0x1bcd960, 0xc000040098, 0x1a9f5c0, 0xc000532540, 0x0, 0x0, 0xc00062e898)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/runtime/v1/linux/runtime.go:298 +0x368</span><br><span class="line">github.com/containerd/containerd/runtime/v1/linux.New(0xc00034ea80, 0xc000332c60, 0x2, 0x2, 0x1968f20)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/runtime/v1/linux/runtime.go:125 +0x3db</span><br><span class="line">github.com/containerd/containerd/plugin.(*Registration).Init(0xc00009a1e0, 0xc00034ea80, 0x18c2f40)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/plugin/plugin.go:110 +0x3a</span><br><span class="line">github.com/containerd/containerd/services/server.New(0x1bcd960, 0xc000040098, 0xc00055c480, 0x1, 0x1, 0xc0002079b0)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/services/server/server.go:167 +0xcaa</span><br><span class="line">github.com/containerd/containerd/cmd/containerd/command.App.func1(0xc000558580, 0x0, 0xc000162880)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/cmd/containerd/command/main.go:177 +0x7fa</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/urfave/cli.HandleAction(0x1937d80, 0x1b71550, 0xc000558580, 0xc000558580, 0x0)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/urfave/cli/app.go:523 +0xc0</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/urfave/cli.(*App).Run(0xc000536700, 0xc00003c050, 0x5, 0x5, 0x0, 0x0)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/urfave/cli/app.go:285 +0x5e1</span><br><span class="line">main.main()</span><br><span class="line">        github.com/containerd/containerd/cmd/containerd/main.go:33 +0x51</span><br><span class="line"></span><br><span class="line">goroutine 6 [syscall]:</span><br><span class="line">os/signal.signal_recv(0x0)</span><br><span class="line">        /usr/local/go/src/runtime/sigqueue.go:147 +0x9e</span><br><span class="line">os/signal.loop()</span><br><span class="line">        /usr/local/go/src/os/signal/signal_unix.go:23 +0x24</span><br><span class="line">created by os/signal.init.0</span><br><span class="line">        /usr/local/go/src/os/signal/signal_unix.go:29 +0x43</span><br><span class="line"></span><br><span class="line">goroutine 7 [chan receive]:</span><br><span class="line">github.com/containerd/containerd/vendor/k8s.io/klog.(*loggingT).flushDaemon(0x2721260)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/k8s.io/klog/klog.go:1010 +0x8d</span><br><span class="line">created by github.com/containerd/containerd/vendor/k8s.io/klog.init.0</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/k8s.io/klog/klog.go:411 +0xd8</span><br><span class="line"></span><br><span class="line">goroutine 43 [select]:</span><br><span class="line">github.com/containerd/containerd/cmd/containerd/command.handleSignals.func1(0xc000551380, 0xc000551320, 0x1bcd960, 0xc000040098, 0xc00054c300)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/cmd/containerd/command/main_unix.go:44 +0xf2</span><br><span class="line">created by github.com/containerd/containerd/cmd/containerd/command.handleSignals</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/cmd/containerd/command/main_unix.go:41 +0x8b</span><br><span class="line"></span><br><span class="line">goroutine 11 [select]:</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/docker/go-events.(*Broadcaster).run(0xc00003c0f0)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/docker/go-events/broadcast.go:117 +0x1b3</span><br><span class="line">created by github.com/containerd/containerd/vendor/github.com/docker/go-events.NewBroadcaster</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/docker/go-events/broadcast.go:39 +0x1b0</span><br><span class="line"></span><br><span class="line">goroutine 114 [runnable]:</span><br><span class="line">os/exec.(*Cmd).Start.func2(0xc0002738c0)</span><br><span class="line">        /usr/local/go/src/os/exec/exec.go:448 +0xc6</span><br><span class="line">created by os/exec.(*Cmd).Start</span><br><span class="line">        /usr/local/go/src/os/exec/exec.go:447 +0x6d2</span><br><span class="line"></span><br><span class="line">goroutine 47 [select]:</span><br><span class="line">github.com/containerd/containerd/gc/scheduler.(*gcScheduler).run(0xc0002408a0, 0x1bcd960, 0xc000040098)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/gc/scheduler/scheduler.go:268 +0x1ce</span><br><span class="line">created by github.com/containerd/containerd/gc/scheduler.init.0.func1</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/gc/scheduler/scheduler.go:132 +0x429</span><br><span class="line"></span><br><span class="line">goroutine 115 [runnable]:</span><br><span class="line">os/exec.(*Cmd).Wait(0xc0002738c0, 0x0, 0x0)</span><br><span class="line">        /usr/local/go/src/os/exec/exec.go:514 +0x127</span><br><span class="line">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.(*defaultMonitor).Start.func1(0xc0002738c0, 0xc00035e4e0)</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/monitor.go:55 +0x31</span><br><span class="line">created by github.com/containerd/containerd/vendor/github.com/containerd/go-runc.(*defaultMonitor).Start</span><br><span class="line">        /tmp/tmp.0JSku0IZFM/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/monitor.go:53 +0xa7</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åªæ˜¯å¶å°”çš„æŠ¥é”™ï¼Œå¶å°”ä¹Ÿä¼šæŠ¥é”™ <code>segment fault</code>ï¼ŒåŒæ—¶æ ¹ç›®å½•ä¹Ÿæœ‰ coredump ç”Ÿæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ ll /</span><br><span class="line">æ€»ç”¨é‡ 145912</span><br><span class="line">lrwxrwxrwx.   1 root root         7 10æœˆ 13 2021 bin -&gt; usr/bin</span><br><span class="line">dr-xr-xr-x.   5 root root      4096 4æœˆ  11 14:55 boot</span><br><span class="line">-rw-------    1 root root 230711296 4æœˆ  15 13:59 core.28650</span><br><span class="line">-rw-------    1 root root 187424768 4æœˆ  15 13:46 core.3977</span><br><span class="line">drwxr-xr-x   12 xxx  xxx        156 10æœˆ 29 11:32 data</span><br><span class="line">drwxr-xr-x   19 root root      3180 4æœˆ  15 12:38 dev</span><br><span class="line">drwxr-xr-x.  85 root root      8192 4æœˆ  15 12:44 etc</span><br><span class="line">drwxr-xr-x.   3 root root        17 10æœˆ 28 13:30 home</span><br><span class="line">lrwxrwxrwx.   1 root root         7 10æœˆ 13 2021 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root         9 10æœˆ 13 2021 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x.   3 root root       127 10æœˆ 28 13:32 media</span><br><span class="line">drwxr-xr-x.   2 root root         6 4æœˆ  11 2018 mnt</span><br><span class="line">drwxr-xr-x.   3 root root        24 10æœˆ 28 13:38 opt</span><br><span class="line">dr-xr-xr-x  253 root root         0 4æœˆ  15 12:38 proc</span><br><span class="line">dr-xr-x---.   7 root root       258 4æœˆ  15 13:13 root</span><br><span class="line">drwxr-xr-x   30 root root       960 4æœˆ  15 14:11 run</span><br><span class="line">lrwxrwxrwx.   1 root root         8 10æœˆ 13 2021 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root         6 4æœˆ  11 2018 srv</span><br><span class="line">dr-xr-xr-x   13 root root         0 4æœˆ  15 13:12 sys</span><br><span class="line">drwxrwxrwt.  14 root root      4096 4æœˆ  15 14:28 tmp</span><br><span class="line">drwxr-xr-x.  13 root root       155 10æœˆ 13 2021 usr</span><br><span class="line">drwxr-xr-x.  19 root root       267 10æœˆ 13 2021 var</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿæ²¡æŸåï¼ŒæŸ¥çœ‹äº†è¿›ç¨‹ï¼Œä¹Ÿæ²¡æœ‰å•¥å®‰å…¨è½¯ä»¶ï¼ŒæŸ¥çœ‹ä¸‹ç³»ç»Ÿæ—¥å¿—ï¼Œå…¶å®åœ¨ä¸Šé¢æ’æŸ¥è¿‡ç¨‹ä¸­ ssh ä¹Ÿä¼šå¶å°”æ–­å¼€ï¼Œç„¶å strace ä¹Ÿæ˜¯æ²¡æœ‰å•¥å¤´ç»ªã€‚</p><p>ç³»ç»Ÿæ—¥å¿—é‡Œè¿‡æ»¤ä¸€äº›æ— ç”¨çš„ä¿¡æ¯åï¼Œå‘ç° bash ä¹Ÿä¼š <code>segfault</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Apr 15 13:46:32 xxx supervisord: 2022-04-15 13:46:32,958 INFO exited: prometheus_00 (exit status 2; expected)</span><br><span class="line">Apr 15 13:46:33 xxx supervisord: 2022-04-15 13:46:33,962 INFO spawned: &#x27;prometheus_00&#x27; with pid 3751</span><br><span class="line">Apr 15 13:46:35 xxx supervisord: 2022-04-15 13:46:35,379 INFO success: prometheus_00 entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)</span><br><span class="line">Apr 15 13:46:35 xxx dockerd: failed to start daemon: failed to dial &quot;/run/containerd/containerd.sock&quot;: failed to dial &quot;/run/containerd/containerd.sock&quot;: context deadline exceeded</span><br><span class="line">Apr 15 13:46:35 xxx systemd: docker.service: main process exited, code=exited, status=1/FAILURE</span><br><span class="line">Apr 15 13:46:35 xxx systemd: Unit docker.service entered failed state.</span><br><span class="line">Apr 15 13:46:35 xxx systemd: docker.service failed.</span><br><span class="line">Apr 15 13:46:40 xxx systemd: docker.service holdoff time over, scheduling restart.</span><br><span class="line">Apr 15 13:46:40 xxx systemd: Starting Docker Application Container Engine...</span><br><span class="line">Apr 15 13:46:40 xxx systemd: Started Docker Application Container Engine.</span><br><span class="line">Apr 15 13:46:40 xxx systemd: docker.service: main process exited, code=killed, status=11/SEGV</span><br><span class="line">Apr 15 13:46:40 xxx systemd: Unit docker.service entered failed state.</span><br><span class="line">Apr 15 13:46:40 xxx systemd: docker.service failed.</span><br><span class="line">Apr 15 13:46:42 xxx kernel: bash[4028]: segfault at fa8 ip 0000000000440c58 sp 00007fff8528e830 error 4 in bash[400000+de000]</span><br></pre></td></tr></table></figure><p>å•ç‹¬çœ‹çœ‹ <code>segfault</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ grep kernal /var/log/messages | grep -i segfault</span><br><span class="line"></span><br><span class="line">Apr 15 11:17:31 xxx kernel: celery[13267]: segfault at 6de410 ip 000000000041b720 sp 00007ffccf1813c0 error 4 in python3.7[400000+293000]</span><br><span class="line">Apr 15 11:20:35 xxx kernel: redis-server[21118]: segfault at 5dd030 ip 00000000005dd030 sp 00007ffc05cbe440 error 14 in redis-server[6dd000+1000]</span><br><span class="line">Apr 15 11:20:35 xxx kernel: supervisord[20844]: segfault at 29 ip 000000000045c030 sp 00007ffd48aa29d0 error 4 in python3.7[400000+293000]</span><br><span class="line">Apr 15 11:20:51 xxx kernel: gunicorn[23241]: segfault at 8 ip 00000000004272c8 sp 00007ffc0c4f34e0 error 4 in python3.7[400000+293000]</span><br><span class="line">Apr 15 11:20:56 xxx kernel: celery[23193]: segfault at 10 ip 0000000000454a29 sp 00007ffd17acce78 error 4 in python3.7[400000+293000]</span><br><span class="line">Apr 15 11:20:56 xxx kernel: python[23196]: segfault at 154c0ab0 ip 0000000000420eb0 sp 00007fff43b9fe08 error 6 in python3.7[400000+293000]</span><br><span class="line">Apr 15 12:38:34 xxx kernel: init.ipv6-globa[1154]: segfault at 68 ip 000000000044f62f sp 00007ffc2cf307a8 error 6 in bash[400000+de000]</span><br><span class="line">Apr 15 12:59:25 xxx kernel: bash[11112]: segfault at 18 ip 0000000000449dc9 sp 00007ffffbc2dac8 error 4 in bash[400000+de000]</span><br><span class="line">Apr 15 13:00:58 xxx kernel: bash[14117]: segfault at ffffffff8d48ffff ip 0000000000440c36 sp 00007ffe9be29640 error 7 in bash[400000+de000]</span><br><span class="line">Apr 15 13:01:19 xxx kernel: strace[14852]: segfault at 0 ip           (null) sp 00007ffc836a2be8 error 14 in strace[400000+f7000]</span><br><span class="line">Apr 15 13:10:44 xxx kernel: grep[2587]: segfault at a0d ip 000000000040c43f sp 00007ffcda056be8 error 4 in grep[400000+25000]</span><br><span class="line">Apr 15 13:14:06 xxx kernel: strace[9484]: segfault at ffffffff89489abc ip 00000000004336c2 sp 00007ffcb217a758 error 7 in strace[400000+f7000]</span><br><span class="line">Apr 15 13:27:57 xxx kernel: grep[32713]: segfault at 0 ip           (null) sp 00007ffebf181d10 error 14 in grep[400000+25000]</span><br><span class="line">Apr 15 13:30:22 xxx kernel: bash[5138]: segfault at 108 ip 000000000040cc32 sp 00007ffd55de2728 error 4 in bash[400000+de000]</span><br><span class="line">Apr 15 13:35:56 xxx kernel: strace[15846]: segfault at 0 ip           (null) sp 00007ffef0a931e0 error 14 in strace[400000+f7000]</span><br><span class="line">Apr 15 13:36:27 xxx kernel: bash[16818]: segfault at 33173b0 ip 000000000046d584 sp 00007ffdb71ff5c8 error 6 in bash[400000+de000]</span><br><span class="line">Apr 15 13:37:04 xxx kernel: bash[17993]: segfault at 46a0 ip 0000000000440c58 sp 00007fffd76cf1e0 error 4 in bash[400000+de000]</span><br><span class="line">Apr 15 13:39:49 xxx kernel: bash[23124]: segfault at 5aa0 ip 0000000000440c58 sp 00007fff98271ac0 error 4 in bash[400000+de000]</span><br><span class="line">Apr 15 13:46:42 xxx kernel: bash[4028]: segfault at fa8 ip 0000000000440c58 sp 00007fff8528e830 error 4 in bash[400000+de000]</span><br><span class="line">Apr 15 13:59:04 xxx kernel: redis_exporter-[21520]: segfault at 43b8ba ip 000000000043b892 sp 000000c000057f48 error 7 in redis_exporter-1.23.1.linux-x86_64[400000+41f000]</span><br><span class="line">Apr 15 14:12:12 xxx kernel: grepconf.sh[20714]: segfault at 0 ip           (null) sp 00007ffe3009c158 error 14 in bash[400000+de000]</span><br><span class="line">Apr 15 14:14:43 xxx kernel: bash[25463]: segfault at 313f4023 ip 00000000313f4023 sp 00007ffd25075948 error 14 in ISO8859-1.so[7f6335587000+2000]</span><br><span class="line">Apr 15 14:22:32 xxx kernel: bash[7390]: segfault at 18 ip 0000000000449dc9 sp 00007ffc765d0558 error 4 in bash[400000+de000]</span><br><span class="line">Apr 15 14:38:21 xxx kernel: prometheus[26806]: segfault at 440eb5 ip 0000000000421391 sp 000000c0002f1f38 error 7 in prometheus[400000+20ec000]</span><br><span class="line">Apr 15 14:38:21 xxx kernel: prometheus[26801]: segfault at bffffffff8 ip 0000000000440ea3 sp 000000c000000000 error 6 in prometheus[400000+20ec000]</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹å†…å­˜å®¹é‡ä¹Ÿæ­£å¸¸ï¼Œå¾ˆå¤šä¸œè¥¿éƒ½ä¼šè§¦å‘ segmenft faultï¼Œä½†æ˜¯æœ€å¸¸è§çš„å°±æ˜¯å†…å­˜è¶Šç•Œï¼Œä½†æ˜¯æ ¹æ®ç³»ç»Ÿæ—¥å¿—çœ‹å¹¶ä¸å­˜åœ¨å†…å­˜è¶Šç•Œï¼ˆæ¯•ç«Ÿè¿™ä¹ˆå¤šè¿›ç¨‹éƒ½ segfaultï¼Œä¸å¯èƒ½è¿™ä¹ˆå¤šè¿›ç¨‹ä»£ç å†™çš„æœ‰é—®é¢˜ï¼‰ï¼Œä½¿ç”¨ <code>rpm -V glibc</code> ä¹Ÿæ²¡çœ‹åˆ° so æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œåˆæ­¥æ€€ç–‘å®¢æˆ·çš„å®¿ä¸»æœºå†…å­˜æœ‰é—®é¢˜ï¼Œè®©å®¢æˆ·è¿ç§»ä¸‹è¿™å°æœºå™¨ã€‚</p><h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>2022&#x2F;04&#x2F;22 åé¦ˆè¿ç§»åä¸€åˆ‡éƒ½æ­£å¸¸äº†ã€‚</p><h2 id="coredump-çš„é…ç½®å‚è€ƒ"><a href="#coredump-çš„é…ç½®å‚è€ƒ" class="headerlink" title="coredump çš„é…ç½®å‚è€ƒ"></a>coredump çš„é…ç½®å‚è€ƒ</h2><p>å‚è€ƒæ–‡ç«  <a href="https://www.cnblogs.com/arnoldlu/p/11160510.html">coredumpé…ç½®ã€äº§ç”Ÿã€åˆ†æä»¥åŠåˆ†æç¤ºä¾‹</a> coredump çš„ä¸€äº›é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/sys/kernel/core_pattern </span><br><span class="line">core</span><br></pre></td></tr></table></figure><p>ä¸´æ—¶ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;core-%e-%p-%t-%s&quot; &gt; /proc/sys/kernel/core_pattern </span><br></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%% - å•ä¸ª%å­—ç¬¦</span><br><span class="line">%p - æ·»åŠ pid</span><br><span class="line">%u - æ·»åŠ å½“å‰uid</span><br><span class="line">%g - æ·»åŠ å½“å‰gid</span><br><span class="line">%s - æ·»åŠ å¯¼è‡´äº§ç”Ÿcoreçš„ä¿¡å·</span><br><span class="line">%t - æ·»åŠ coreæ–‡ä»¶ç”Ÿæˆæ—¶çš„unixæ—¶é—´</span><br><span class="line">%h - æ·»åŠ ä¸»æœºå</span><br><span class="line">%e - æ·»åŠ ç¨‹åºæ–‡ä»¶å </span><br></pre></td></tr></table></figure><p>sysctl å›ºåŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel.core_pattern=core-%e-%p-%t-%s</span><br><span class="line">kernel.core_uses_pid=1</span><br></pre></td></tr></table></figure><p><code>limit.d/*.conf</code> é…ç½® coredump æ–‡ä»¶é™åˆ¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* soft core 1024</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;å®¢æˆ·ç¯å¢ƒ docker å’Œ containerd å¯åŠ¨æ—¶ä¸æ—¶ segment fault çš„ä¸€æ¬¡å¤„ç†è¿‡ç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="segfault" scheme="http://zhangguanzhang.github.io/tags/segfault/"/>
    
  </entry>
  
  <entry>
    <title>ecs ä¸­æ¯’çš„ä¸€æ¬¡å¤„ç†è¿‡ç¨‹</title>
    <link href="http://zhangguanzhang.github.io/2022/04/21/ecs-xmrig/"/>
    <id>http://zhangguanzhang.github.io/2022/04/21/ecs-xmrig/</id>
    <published>2022-04-21T19:17:30.000Z</published>
    <updated>2022-04-21T19:17:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€æ¬¡å®¢æˆ· ecs ä¸­æ¯’çš„å¤„ç†è¿‡ç¨‹ï¼Œå¯ä»¥ç»™è¯»è€…å‚è€ƒä¸‹ä¸­æ¯’çš„å¤„ç†è¿‡ç¨‹ã€‚</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å®¢æˆ·æœºå™¨ä¸­æ¯’äº†ï¼Œpm æ‰¾æˆ‘æ¥è®©å¤„ç†ä¸‹ï¼Œè®°å½•ä¸‹ï¼Œç»™å…¶ä»–äººåšä¸ªå¤„ç†è¿‡ç¨‹çš„å‚è€ƒã€‚</p><h2 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h2><p>æœºå™¨æ˜¯ centos ï¼Œå…ˆåˆ©ç”¨ <code>rpm -V &lt;pkg_name&gt;</code> ç¡®è®¤åŸºç¡€çš„æ’æŸ¥å‘½ä»¤æ²¡è¢«ä¿®æ”¹è¿‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qf `<span class="built_in">which</span> ps`</span><br><span class="line">procps-ng-3.3.10-23.el7.x86_64</span><br><span class="line">$ rpm -V procps-ng </span><br><span class="line">$ rpm -qf `<span class="built_in">which</span> top`</span><br><span class="line">procps-ng-3.3.10-23.el7.x86_64</span><br><span class="line"><span class="comment"># çœ‹sshd çš„ soè¢«ä¿®æ”¹äº†æ²¡ï¼Œé…ç½®æ–‡ä»¶ä¹Ÿå¯ä»¥çœ‹ä¸‹</span></span><br><span class="line">$ rpm -v `<span class="built_in">which</span> sshd`</span><br><span class="line">S.5....T.  c /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p>top çœ‹åˆ°å¼‚å¸¸ cpu çš„è¿›ç¨‹å ç”¨ cpu å¾ˆé«˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ top</span><br><span class="line">top - 19:44:29 up 34 days,  5:08,  4 users,  load average: 612.03, 617.15, 482.75</span><br><span class="line">Tasks: 2014 total,  66 running, 1946 sleeping,   0 stopped,   2 zombie</span><br><span class="line">%Cpu(s): 96.6 us,  3.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.3 si,  0.0 st</span><br><span class="line">KiB Mem : 13186040+total,  2722452 free, 48820448 used, 80317504 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used. 78946784 avail Mem </span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                                                                </span><br><span class="line"> 1206 root      20   0 5251748   2.3g   3584 S  2956  1.8 465:37.77 ld-linux-x86-64</span><br></pre></td></tr></table></figure><p>ç»™å®ƒ <code>STOP</code> ä¿¡å·ä¸è®© cpu åˆ‡æ¢åˆ°å®ƒï¼Œè€Œä¸æ˜¯ç›´æ¥ kill æ‰å®ƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kill -STOP 1206</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ¥æºå’Œæ¸…ç†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ll /proc/1206/exe</span><br><span class="line">lrwxrwxrwx 1 root root 0 Apr 21 19:44 /proc/1206/exe -&gt; /dev/shm/.x/stak/ld-linux-x86-64.so.2</span><br></pre></td></tr></table></figure><h3 id="æ¸…ç†å®šæ—¶ä»»åŠ¡"><a href="#æ¸…ç†å®šæ—¶ä»»åŠ¡" class="headerlink" title="æ¸…ç†å®šæ—¶ä»»åŠ¡"></a>æ¸…ç†å®šæ—¶ä»»åŠ¡</h3><p>æ’æŸ¥å®šæ—¶ä»»åŠ¡ï¼Œå‘ç°æœ‰å†…å®¹ï¼Œæ¸…ç†æ‰ï¼Œ crond çš„å­ç›®å½•ä¹Ÿçœ‹ä¸‹ï¼Œæ–‡ä»¶å†…å®¹å’Œå¤šäº†çš„å­æ–‡ä»¶ä¹Ÿå¤„ç†ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ crontab -l</span><br><span class="line">* * * * * /dev/shm/.x/upd &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">@reboot /dev/shm/.x/upd &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">$ find /etc/cron.* -type f </span><br><span class="line">/etc/cron.d/0hourly</span><br><span class="line">/etc/cron.d/sysstat</span><br><span class="line">/etc/cron.daily/logrotate</span><br><span class="line">/etc/cron.daily/man-db.cron</span><br><span class="line">/etc/cron.deny</span><br><span class="line">/etc/cron.hourly/0anacron</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹ç›®å½•æ˜¯å¦æœ‰å…¶ä»–ç”¨æˆ·çš„ crontab æ–‡ä»¶</span><br><span class="line">$ ls -l /var/spool/cron/</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹è¿›ç¨‹æ ‘ï¼Œæ˜¯å¦æœ‰çˆ¶è¿›ç¨‹æ‹‰èµ· <code>1206</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ pstree -sp 1206</span><br><span class="line">systemd(1)â”€â”€â”€ld-linux-x86-64(1206)â”€â”¬â”€&#123;ld-linux-x86-64&#125;(1209)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(1211)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(1216)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(1217)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(1218)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6436)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6437)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6439)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6440)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6441)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6443)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6471)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6472)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6476)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6484)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6489)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6495)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6501)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6504)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6505)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6508)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6509)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6511)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6523)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6527)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6529)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6531)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6535)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6547)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6554)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6563)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6567)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6568)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6569)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6572)</span><br><span class="line">                                   â”œâ”€&#123;ld-linux-x86-64&#125;(6579)</span><br><span class="line">                                   â””â”€&#123;ld-linux-x86-64&#125;(6580)</span><br></pre></td></tr></table></figure><p>å‘ç°å¹¶æ²¡æœ‰ï¼ŒæŸ¥çœ‹ä¸‹è¿›ç¨‹çš„ <code>cmdline</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ xargs -0 &lt; /proc/1206/cmdline</span><br><span class="line">xmrig   </span><br><span class="line">    --library-path stak stak/xmrig -o 185.82.200.52:443 -k</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥ç³»ç»Ÿçš„-so-å’Œå¼€æœºå¯åŠ¨é¡¹"><a href="#æ£€æŸ¥ç³»ç»Ÿçš„-so-å’Œå¼€æœºå¯åŠ¨é¡¹" class="headerlink" title="æ£€æŸ¥ç³»ç»Ÿçš„ so å’Œå¼€æœºå¯åŠ¨é¡¹"></a>æ£€æŸ¥ç³»ç»Ÿçš„ so å’Œå¼€æœºå¯åŠ¨é¡¹</h3><p>æœäº†ä¸‹è¿™ä¸ª ip æ˜¯å¤–å›½çš„ï¼ŒæŸ¥çœ‹ä¸‹ ld çš„ so å¯¼å…¥é…ç½®æ–‡ä»¶ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰è¢«åŠ å…¥é¢å¤–çš„ so å¯¼å…¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qf /etc/ld.so.conf</span><br><span class="line">glibc-2.17-260.el7.x86_64</span><br><span class="line"># glibc ä¹Ÿæä¾›äº†å¾ˆå¤šåŸºç¡€çš„ soï¼Œè¿™æ­¥åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥</span><br><span class="line"># åŸºç¡€çš„ so æœ‰è¢«æ›¿æ¢ä¸</span><br><span class="line">$ rpm -V glibc</span><br></pre></td></tr></table></figure><p>åŒç†æŸ¥çœ‹ä¸‹ systemd çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -V systemd</span><br><span class="line">.M.......  c /etc/machine-id</span><br><span class="line">SM5....T.  c /etc/rc.d/rc.local # è¿™ä¸ªæ–‡ä»¶ä¹Ÿè®°å¾—æŸ¥ä¸‹</span><br><span class="line">S.5....T.  c /etc/systemd/system.conf</span><br><span class="line">.M.......  g /etc/udev/hwdb.bin</span><br><span class="line">.M.......  g /var/lib/systemd/random-seed</span><br><span class="line">.M....G..  g /var/log/journal</span><br><span class="line">.M....G..  g /var/log/wtmp</span><br><span class="line">.M....G..  g /var/run/utmp</span><br><span class="line"># æŸ¥çœ‹ä¸‹æœ‰æ²¡æœ‰è¢«æ·»åŠ  systemd çš„å¼€æœºå¯åŠ¨ä»»åŠ¡ï¼Œå¼‚å¸¸çš„ timer</span><br><span class="line">$ systemctl list-units</span><br></pre></td></tr></table></figure><h3 id="æ¸…ç†è¿›ç¨‹ç›¸å…³"><a href="#æ¸…ç†è¿›ç¨‹ç›¸å…³" class="headerlink" title="æ¸…ç†è¿›ç¨‹ç›¸å…³"></a>æ¸…ç†è¿›ç¨‹ç›¸å…³</h3><p>æˆ‘ä»¬ç¯å¢ƒæ˜¯ k8s å’Œ docker çš„ï¼Œetcd æ²¡è¯ä¹¦ï¼Œkubelet çš„ http å¯å†™ï¼Œdocker å¼€ç½‘ç»œç«¯å£ä¸ tlsï¼Œredis æ— å¯†ç è¿™ç§ç°è±¡æ˜¯ä¸å­˜åœ¨çš„ã€‚çœ‹äº†ä¸‹æˆ‘ä»¬é…ç½®çš„éƒ¨ç½²é…ç½®æ–‡ä»¶ï¼Œåˆæ­¥æ€€ç–‘æ˜¯ä¸€ä¸ªæœ‰ sudo çš„å¼±å¯†ç ç”¨æˆ·è¢«çˆ†ç ´å¯¼è‡´çš„ä¸­æ¯’ï¼ŒæŸ¥çœ‹äº†å…·æœ‰ sudo æƒé™å’Œ root çš„ <code>~/.ssh/authorized_keys</code> ä¹Ÿæ²¡è¢«æ·»åŠ åˆ«äººçš„å…¬é’¥ï¼ˆæœ‰çš„è¯è®°å¾—æ¸…ç†ä¸‹ï¼‰ï¼Œå¼€å§‹åˆ é™¤æŒ–çŸ¿è¿›ç¨‹çš„ç›®å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /dev/shm/.x/</span><br><span class="line">kill -9 1206</span><br></pre></td></tr></table></figure><h3 id="æ’æŸ¥ç½‘ç»œ"><a href="#æ’æŸ¥ç½‘ç»œ" class="headerlink" title="æ’æŸ¥ç½‘ç»œ"></a>æ’æŸ¥ç½‘ç»œ</h3><p>çœ‹çœ‹æ˜¯å¦è¿˜æœ‰å…¶ä»–åå°è¿›ç¨‹ä¸ŠæŠ¥æˆ–è€…ä¸‹è½½çš„ï¼Œçœ‹äº†ä¸‹ udp çš„æ­£å¸¸ï¼Œtcpç›‘å¬çš„ç«¯å£ä¹Ÿæ²¡è«åå…¶å¦™çš„ç«¯å£ï¼Œæ‰€ä»¥æå–æ‰€æœ‰æ´»è·ƒçš„ tcp è¿æ¥ ip çœ‹çœ‹æœ‰å¼‚å¸¸çš„ IP æ²¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -ant |&amp; grep -Po &#x27;(\d&#123;1,3&#125;\.)&#123;3&#125;\d&#123;1,3&#125;&#x27; | sort | grep -v 10.187.0 | uniq -c</span><br><span class="line">     49 0.0.0.0</span><br><span class="line">      2 119.82.135.65</span><br><span class="line">    111 127.0.0.1</span><br><span class="line">      4 169.254.169.254</span><br><span class="line">   2271 192.168.0.235</span><br><span class="line">     13 2xx.1xx.15.161</span><br><span class="line">      1 3x.1xx.2x.7</span><br><span class="line">     27 4x.x.1xx.x3</span><br><span class="line">      1 xx.1xx.6x.x54</span><br><span class="line"></span><br><span class="line">$ netstat -ant | grep 119.82.135.65</span><br><span class="line">tcp        0   1281 192.168.0.235:22        119.82.135.65:38525     LAST_ACK   </span><br><span class="line">tcp        0      1 192.168.0.235:22        119.82.135.65:54598     LAST_ACK   </span><br><span class="line">$ lsof -nPi :38525</span><br><span class="line">$ lsof -nPi :54598</span><br><span class="line">$ </span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹åªæœ‰ä¸æ–­è¢«å¤–å›½ IP æš´åŠ› ssh çš„ IPï¼Œå…¶ä½™å‡ ä¸ª IP æ˜¯æˆ‘å’Œå®¢æˆ·é‚£è¾¹çš„äººå‘˜ IPã€‚è®©å®¢æˆ·æ”¹å¯†ç åå†è§‚å¯Ÿä¸‹ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åªæ˜¯åˆ—ä¸¾äº†å¤§æ¦‚çš„æ’æŸ¥èŒƒå›´ï¼Œæœ‰å…¶ä»–çš„è‡ªå·±ç‹¬ç‰¹çš„æ’æŸ¥èŒƒå›´ä¹Ÿå¯ä»¥å°è¯•ä¸‹ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€æ¬¡å®¢æˆ· ecs ä¸­æ¯’çš„å¤„ç†è¿‡ç¨‹ï¼Œå¯ä»¥ç»™è¯»è€…å‚è€ƒä¸‹ä¸­æ¯’çš„å¤„ç†è¿‡ç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="ecs" scheme="http://zhangguanzhang.github.io/tags/ecs/"/>
    
    <category term="xmrig" scheme="http://zhangguanzhang.github.io/tags/xmrig/"/>
    
  </entry>
  
  <entry>
    <title>æ— æ•°æ®çš„ tcp é“¾æ¥è¢« SDN/é˜²ç«å¢™ å¹²æ‰çš„ä¸€ç§å¤„ç†åŠæ³•</title>
    <link href="http://zhangguanzhang.github.io/2022/04/11/sdn-tcp-keepalive/"/>
    <id>http://zhangguanzhang.github.io/2022/04/11/sdn-tcp-keepalive/</id>
    <published>2022-04-11T11:28:30.000Z</published>
    <updated>2022-04-11T11:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>å®¢æˆ·çš„ç¯å¢ƒä¸‹ï¼Œä¸šåŠ¡è¿è¡Œåœ¨ dmz åŒºï¼Œmysql åœ¨é dmz åŒºï¼Œä¸šåŠ¡è¿ mysql çš„ç©ºé—² tcp è¿æ¥ 240s åä¼šè¢« SDN å¹²æ‰ï¼Œæœ¬æ–‡å®é™…ä»‹ç»ä¸€ç§ä¸åŠ¨ä¸šåŠ¡(ä»£ç )ï¼Œåˆ©ç”¨ä»£ç†çš„è§£å†³åŠæ³•</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å®¢æˆ·æä¾›çš„ç¯å¢ƒæ˜¯ ACS è™šæ‹ŸåŒ–å¹³å°ï¼Œæˆ‘ä»¬ä¸šåŠ¡éƒ¨ç½²åœ¨ä»–ä»¬çš„ dmz åŒºï¼Œmysql ä»–ä»¬æä¾›çš„ï¼Œåœ¨é dmz åŒºï¼Œéƒ¨ç½²åæœ‰ä¸ªé—®é¢˜å°±æ˜¯é¡µé¢ç»å¸¸ 504ï¼Œ504 ååˆ·æ–°ä¸‹å°±å¥½äº†ï¼Œæœ€åæ’æŸ¥åˆ°æ˜¯ä¸šåŠ¡è¿ mysql çš„ tcp è¿æ¥æ²¡æœ‰æ•°æ®ä¼ è¾“è¶…è¿‡ 240s åä¼šè¢« SDN å¹²æ‰ã€‚</p><h2 id="è§£å†³è¿‡ç¨‹"><a href="#è§£å†³è¿‡ç¨‹" class="headerlink" title="è§£å†³è¿‡ç¨‹"></a>è§£å†³è¿‡ç¨‹</h2><p>ä¸šåŠ¡çš„äº§å“æŒºå¤šçš„ï¼Œä¸šåŠ¡çš„ db è¿æ¥æ± æ¢æ´»å°±ç«‹åˆ»åé¦ˆäº§å“ï¼Œè®©ä¸‹ä¸ªç‰ˆæœ¬åŠ è¿›å»é¿å…è¿™ç§é—®é¢˜ï¼Œä½†æ˜¯å®¢æˆ·ç°åœºçœ‹çœ‹æ˜¯å¦æœ‰ä¸åŠ¨ä¸šåŠ¡çš„è§£å†³åŠæ³•ï¼Œåé¢å¤§è‡´çœ‹äº†ä¸‹ tcp çš„ keepalive å¯èƒ½è§£å†³ã€‚</p><h3 id="ä¸ºå•¥éœ€è¦-tcp-çš„-keepalive"><a href="#ä¸ºå•¥éœ€è¦-tcp-çš„-keepalive" class="headerlink" title="ä¸ºå•¥éœ€è¦ tcp çš„ keepalive"></a>ä¸ºå•¥éœ€è¦ tcp çš„ keepalive</h3><p>ä¸æ˜¯ vrrp å’Œ lvs çš„ keepalived é‚£ä¸ªï¼Œå…¶å®è¿™ä¸ªé—®é¢˜ç°è±¡å’Œå®¢æˆ·çš„ SDN å…³ç³»ä¸å¤§ï¼ˆæˆ‘æ„æ€æ˜¯è¯´æ²¡å¿…è¦å»è¦æ±‚å®¢æˆ·è°ƒæ•´ SDN çš„é…ç½®å•¥çš„ï¼‰ï¼Œå¸¸è§çš„å›­åŒº NAT ç½‘ç»œç¯å¢ƒä¸‹ä¹Ÿæœ‰ç±»ä¼¼é—®é¢˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># å‡å¦‚å†…ç½‘æœ¬æœºè®¿é—®å…¬ç½‘çš„ 1.1.1.1:80 </span><br><span class="line"></span><br><span class="line"># client ç«¯ä¼šéšæœºåˆ†é…ä¸€ä¸ª client port ç”¨äºå’Œç›®æ ‡ ip å»ºç«‹ tcp è¿æ¥</span><br><span class="line">CLIENT 192.168.1.2:47914 </span><br><span class="line">    ||</span><br><span class="line">    ||</span><br><span class="line">    ||</span><br><span class="line">    \/</span><br><span class="line">GW/FW SNAT # ç½‘å…³æˆ–è€…è¾¹ç•Œæœ‰å…¬ç½‘ ip çš„é˜²ç«å¢™åš SNAT</span><br><span class="line">    ||</span><br><span class="line">    ||</span><br><span class="line">    ||</span><br><span class="line">    \/</span><br><span class="line">REAL SERVER 1.1.1.1:80</span><br></pre></td></tr></table></figure><p>å‡å¦‚è¾¹ç•Œé˜²ç«å¢™çš„å…¬ç½‘ IP ä¸º <code>61.183.112.202</code>ï¼Œåœ¨å®¢æˆ·ç«¯è®¿é—®çš„æ—¶å€™ä¼šæœ‰ä¸ªç®¡ç† nat æ¡ç›®çš„è¡¨ï¼š</p><table><thead><tr><th>å†…ç½‘IP</th><th>å†…ç½‘IPçš„ç«¯å£</th><th>æœ¬èº«çš„ç«¯å£</th><th>ç›®çš„ä¸»æœºIP</th><th>ç›®çš„ä¸»æœºç«¯å£</th></tr></thead><tbody><tr><td>192.168.1.2</td><td>47914</td><td>52617</td><td>1.1.1.1</td><td>80</td></tr></tbody></table><p>è¿œç«¯çš„ <code>1.1.1.1:80</code> çœ‹åˆ°çš„ client tcp ä¿¡æ¯æ˜¯ <code>61.183.112.202:52617</code>ï¼Œè¾¹ç•Œçš„å…¬ç½‘é˜²ç«å¢™ç”±äºå›­åŒºå†…è®¾å¤‡å¤ªå¤šï¼Œè¿™ä¸ªç«¯å£è½¬æ¢è¡¨ç”±äºç«¯å£æ•°é‡æœ‰é™ï¼ˆ0~65535ï¼‰ï¼Œå¯¹äºè¿‡æœŸçš„è®°å½•ï¼Œéœ€è¦åˆ é™¤æ‰ã€‚å¤§ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># ä¸‹é¢å­—ç¬¦ç”»æ¨è pc ç«¯æµè§ˆï¼Œå¦åˆ™ä¼šé”™ä½</span><br><span class="line"></span><br><span class="line">      clientç«¯       ä¸­é—´è®¾å¤‡         æœåŠ¡ç«¯</span><br><span class="line">      â””â”€â”€â”¬â”€â”€â”˜        â””â”€â”€â”¬â”€â”€â”˜        â””â”€â”€â”¬â”€â”€â”˜</span><br><span class="line">         â”‚    â”Œâ”€â”€â”€â”€â”    â”‚              â”‚</span><br><span class="line">         â”œâ”€â”€â”€â”€â”¼dataâ”¼â”€â”€â”€â–ºâ”‚    â”Œâ”€â”€â”€â”€â”    â”‚</span><br><span class="line">         â”‚    â””â”€â”€â”€â”€â”˜    â”œâ”€â”€â”€â”€â”¼dataâ”¼â”€â”€â”€â–ºâ”‚</span><br><span class="line">         â”‚              â”‚    â””â”€â”€â”€â”€â”˜    â”‚</span><br><span class="line">         â”‚              â”‚    â”Œâ”€â”€â”€â”€â”    â”‚</span><br><span class="line">         â”‚    â”Œâ”€â”€â”€â”€â”    â”‚â—„â”€â”€â”€â”¼ACK â”¼â”€â”€â”€â”€â”¤</span><br><span class="line">         â”‚â—„â”€â”€â”€â”¼ACK â”¼â”€â”€â”€â”€â”¤    â””â”€â”€â”€â”€â”˜    â”‚</span><br><span class="line">         â”‚    â””â”€â”€â”€â”€â”˜   /â”‚              â”‚</span><br><span class="line">         â”‚            â”‚ â”‚              â”‚</span><br><span class="line">         â”‚            â”‚ â”‚              â”‚</span><br><span class="line">         â”‚    no data&lt;  â”‚              â”‚</span><br><span class="line">         â”‚            â”‚ â”‚              â”‚</span><br><span class="line">         â”‚            â”‚ â”‚              â”‚</span><br><span class="line">         â”‚             \â”‚              â”‚</span><br><span class="line">         â”‚              â”‚é•¿æ—¶é—´æ— æ•°æ®äº¤äº’â”‚</span><br><span class="line">         â”‚              â”‚è®¾å¤‡åˆ æ‰è¡¨æ¡ç›® â”‚</span><br><span class="line">         â”‚    â”Œâ”€â”€â”€â”€â”    â”‚              â”‚</span><br><span class="line">client   â”œâ”€â”€â”€â”€â”¼dataâ”¼â”€â”€â”€â–ºâ”‚æ— è¿æ¥ä¿¡æ¯     â”‚</span><br><span class="line">å‘é€æ•°æ®  â”‚    â””â”€â”€â”€â”€â”˜    â”‚ç›´æ¥å‘é€RST    â”‚</span><br><span class="line">         â”‚    â”Œâ”€â”€â”€â”€â”    â”‚ æˆ–ä¸¢å¼ƒ        â”‚</span><br><span class="line">åº”ç”¨å¼‚å¸¸  â”‚â—„â”€â”€â”€â”¼RST â”¼â”€â”€â”€â”€â”¤              â”‚</span><br><span class="line">         â”‚    â””â”€â”€â”€â”€â”˜    â”‚              â”‚</span><br></pre></td></tr></table></figure><p>ç°åœºçš„ SDN å°±æ˜¯ 240s åå¹²æ‰è¿™ä¸ª tcp è¿æ¥ï¼Œè§£å†³åŠæ³•å°±æ˜¯ TCP è¿™å±‚çš„ keepalive æœºåˆ¶ç»´æŒé•¿è¿æ¥ï¼Œè®©ç½‘å…³çš„ nat æ¡ç›® ttl ä¿æ´»ã€‚</p><h3 id="tcp-keepalive-ä»‹ç»"><a href="#tcp-keepalive-ä»‹ç»" class="headerlink" title="tcp keepalive ä»‹ç»"></a>tcp keepalive ä»‹ç»</h3><p>ç›¸å…³çš„å†…æ ¸å‚æ•°æœ‰ä¸‰ä¸ªï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -a |&amp; grep tcp.keepalive_</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 75</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 9</span><br><span class="line">net.ipv4.tcp_keepalive_time = 7200</span><br></pre></td></tr></table></figure><p>å¯ç”¨ tcp keepalive çš„ä¸€ç«¯ï¼Œåœ¨æ²¡æœ‰æ•°æ®ä¼ è¾“çš„æ—¶å€™ï¼Œä¼šæœ‰å®šæ—¶å™¨ï¼ˆä¹Ÿæœ‰äººç¿»è¯‘ç§°ä¸ºè®¡æ•°å™¨ï¼‰å·¥ä½œï¼Œåˆ°äº† <code>tcp_keepalive_time</code> ç§’è¿˜æ²¡æœ‰æ•°æ®ä¼ è¾“ï¼Œå°±å‘ä¸€æ¬¡ TCP æ¢æµ‹åŒ…ã€‚æ¯éš” <code>tcp_keepalive_intvl</code> å‘ä¸€æ¬¡ï¼Œå¦‚æœé¦–æ¬¡å¯¹ç«¯å“åº” keepalive æŠ¥æ–‡ï¼Œåé¢å°±ä¸å‘é€äº†ï¼Œå¦‚æœæ²¡å“åº”ä¹Ÿå°±æ˜¯ä¸€ç›´ <code>tcp_keepalive_probes</code> æ¬¡å‘é€éƒ½æ²¡å“åº”åï¼Œå°±ä¼šè®¤ä¸ºå¯¹æ–¹æŒ‚äº†ã€‚</p><blockquote><ul><li>TCP æ¢æµ‹åŒ…æ˜¯ä¸€ä¸ªçº¯ ACK åŒ…ï¼ˆ<a href="https://tools.ietf.org/html/rfc1122#section-4.2.3.6">RFC1122#TCP Keep-Alives</a> è§„èŒƒå»ºè®®ï¼šä¸åº”è¯¥åŒ…å«ä»»ä½•æ•°æ®ï¼Œä½†ä¹Ÿå¯ä»¥åŒ…å«1ä¸ªæ— æ„ä¹‰çš„å­—èŠ‚ï¼Œæ¯”å¦‚0x0ï¼‰ï¼Œå…¶ Seqå· ä¸ä¸Šä¸€ä¸ªåŒ…æ˜¯é‡å¤çš„ï¼Œæ‰€ä»¥å…¶å®æ¢æµ‹ä¿æ´»æŠ¥æ–‡ä¸åœ¨çª—å£æ§åˆ¶èŒƒå›´å†…ã€‚</li></ul></blockquote><p>æˆ‘ä»¬è°ƒæ•´äº†ä¸šåŠ¡æœºå™¨ä¸Šçš„è¿™ä¸‰ä¸ªå‚æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯ä¾æ—§çš„é—®é¢˜ï¼Œå‘ç°å¿…é¡»åœ¨åº”ç”¨å±‚åˆ›å»º socket çš„æ—¶å€™è®¾ç½® <code>SO_KEEPALIVE</code> å¥—æ¥å­—é€‰é¡¹æ‰èƒ½ç”Ÿæ•ˆã€‚ä¾‹å¦‚ c è¯­è¨€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conn.setsockopt(socket.SOL_SOCKET, socket.SO_KEEPALIVE, True)</span><br><span class="line">conn.setsockopt(socket.SOL_TCP, socket.TCP_KEEPIDLE, <span class="number">20</span>) # è¦†ç›–tcp_keepalive_time</span><br><span class="line">conn.setsockopt(socket.SOL_TCP, socket.TCP_KEEPCNT, <span class="number">5</span>)  # è¦†ç›–tcp_keepalive_probes</span><br><span class="line">conn.setsockopt(socket.SOL_TCP, socket.TCP_KEEPINTVL, <span class="number">10</span>) # è¦†ç›–tcp_keepalive_intvl</span><br></pre></td></tr></table></figure><p>å…¶ä»–è¯­è¨€ï¼Œä¾‹å¦‚ golang çš„è¯å¯ä»¥çœ‹è¿™ä¸ªæ–‡ç«  <a href="https://zhuanlan.zhihu.com/p/69337371">çŸ¥ä¹: golang ç¨‹åºå¼€å¯ tcp keepalive</a></p><h3 id="nginx-tcp-ä»£ç†æ€è·¯"><a href="#nginx-tcp-ä»£ç†æ€è·¯" class="headerlink" title="nginx tcp ä»£ç†æ€è·¯"></a>nginx tcp ä»£ç†æ€è·¯</h3><p>å’Œé¢†å¯¼è®¨è®ºåè¯´ç”¨ nginx åšä»£ç†è¯•ä¸‹ï¼Œæ ¹æ® nginx å®˜æ–¹æ–‡æ¡£çš„ <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#listen">listen å­—æ®µ</a> çš„ <code>[so_keepalive=on|off|[keepidle]:[keepintvl]:[keepcnt]]</code> çœ‹åˆ° nginx å¯ä»¥å¼€å¯ <code>so_keepalive</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    # http://nginx.org/en/docs/http/ngx_http_core_module.html#listen</span><br><span class="line">    #listen 0.0.0.0:3306 so_keepalive=on;</span><br><span class="line">    # å¦‚æœä¸Šé¢è¿™æ ·å°±ä½¿ç”¨ å†…æ ¸å‚æ•°çš„å€¼ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™æ ·å¯¹åº”ä¸‰ä¸ªå‚æ•°</span><br><span class="line">    listen 0.0.0.0:3306 so_keepalive=60s:20:10;</span><br><span class="line">    proxy_pass xxxx:3306;</span><br><span class="line">    </span><br><span class="line">    #å»ºç«‹è¿æ¥æ—¶é—´</span><br><span class="line">    proxy_connect_timeout 5s;</span><br><span class="line">    #ä¿æŒè¿æ¥æ—¶é—´</span><br><span class="line">    proxy_timeout 3600s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•äº†ä¸‹å‘ç°è¿˜æ˜¯ä¸è¡Œï¼Œæœ¬åœ°æ­å»ºä¸ªç¯å¢ƒè¯•è¯•ã€‚</p><h3 id="æœ¬åœ°ç¯å¢ƒå®æˆ˜"><a href="#æœ¬åœ°ç¯å¢ƒå®æˆ˜" class="headerlink" title="æœ¬åœ°ç¯å¢ƒå®æˆ˜"></a>æœ¬åœ°ç¯å¢ƒå®æˆ˜</h3><p>æœºå™¨ä¿¡æ¯ï¼š</p><table><thead><tr><th>IP</th><th>role</th></tr></thead><tbody><tr><td>192.168.2.111</td><td>mysql</td></tr><tr><td>192.168.2.112</td><td>nginx</td></tr></tbody></table><p><code>192.168.2.111</code> ä¸Šåˆ©ç”¨ docker èµ·ä¸ª mysql:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span> </span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3306</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">zgz</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">zgz</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">zhangguanzhang</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">zhangguanzhang</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">json-file</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">20k</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;3&#x27;</span></span><br></pre></td></tr></table></figure><p><code>192.168.2.112</code> ä¸Šåˆ©ç”¨ docker èµ·ä¸ª nginx åšä»£ç†:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.4&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/:/etc/nginx/conf.d/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./stream.d/:/etc/nginx/stream.d/</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">&quot;host&quot;</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">json-file</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure><p><code>nginx.conf</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log notice;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    include /etc/nginx/stream.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>stream.d/test.conf</code> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    # http://nginx.org/en/docs/http/ngx_http_core_module.html#listen</span><br><span class="line">    listen 0.0.0.0:3307 so_keepalive=60s:20:9;</span><br><span class="line">    proxy_pass 192.168.2.111:3306;</span><br><span class="line">    </span><br><span class="line">    #å»ºç«‹è¿æ¥æ—¶é—´</span><br><span class="line">    proxy_connect_timeout 2s;</span><br><span class="line">    #ä¿æŒè¿æ¥æ—¶é—´</span><br><span class="line">    #proxy_timeout 3600s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èµ·æ¥åç”¨ mysqlçš„é•œåƒèµ· mysql å®¢æˆ·ç«¯:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -ti --net host mysql:5.7 bash</span><br><span class="line">mysql -u root -p -h 192.168.2.112 -P 3307</span><br></pre></td></tr></table></figure><p>æŠ“åŒ… <code>port 3306 and host 192.168.2.111</code> æ²¡æœ‰çœ‹åˆ° keepalive çš„åŒ…ï¼Œç„¶åçªç„¶æ„è¯†åˆ° <code>listen</code> çš„ <code>so_keepalive</code> æ˜¯ nginx ä½œä¸º server ç«¯å»æ¢æµ‹ client ç«¯çš„ï¼Œè€Œä¸æ˜¯ proxy çš„ï¼Œæœäº†ä¸‹æœåˆ° <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_socket_keepalive">proxy_socket_keepalive å­—æ®µ</a>ï¼Œ<code>stream.d/test.conf</code> é…ç½® server æ®µé‡ŒåŠ ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_socket_keepalive on;</span><br></pre></td></tr></table></figure><p>ç„¶åå‘ç°è¿™ä¸ªå¼€äº†åæ¢æµ‹æ—¶é—´å’Œé—´éš”æ˜¯æŒ‰ç…§çš„å†…æ ¸å‚æ•°ï¼Œè°ƒæ•´äº†ä¸‹å†…æ ¸å‚æ•°ï¼Œåç»­è®°å¾—è‡ªè¡ŒæŒä¹…åŒ–åˆ° <code>/etc/sysctl.d/xxx.conf</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -a |&amp; grep tcp.keepalive_</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 6</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 5</span><br><span class="line">net.ipv4.tcp_keepalive_time = 60</span><br></pre></td></tr></table></figure><p>mysql å®¢æˆ·ç«¯è¿æ¥ä¸ŠåæŠ“åŒ…çœ‹åˆ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">18:53:35.347954 IP 192.168.2.112.34492 &gt; 192.168.2.111.3306: Flags [.], ack 2504, win 501, options [nop,nop,TS val 3972839466 ecr 4160374696], length 0</span><br><span class="line">18:53:35.348410 IP 192.168.2.111.3306 &gt; 192.168.2.112.34492: Flags [.], ack 618, win 243, options [nop,nop,TS val 4160435115 ecr 3972779047], length 0</span><br><span class="line">18:54:36.787902 IP 192.168.2.112.34492 &gt; 192.168.2.111.3306: Flags [.], ack 2504, win 501, options [nop,nop,TS val 3972900906 ecr 4160435115], length 0</span><br><span class="line">18:54:36.788318 IP 192.168.2.111.3306 &gt; 192.168.2.112.34492: Flags [.], ack 618, win 243, options [nop,nop,TS val 4160496556 ecr 3972779047], length 0</span><br><span class="line">18:55:38.227896 IP 192.168.2.112.34492 &gt; 192.168.2.111.3306: Flags [.], ack 2504, win 501, options [nop,nop,TS val 3972962346 ecr 4160496556], length 0</span><br><span class="line">18:55:38.228185 IP 192.168.2.111.3306 &gt; 192.168.2.112.34492: Flags [.], ack 618, win 243, options [nop,nop,TS val 4160557996 ecr 3972779047], length 0</span><br><span class="line">18:56:39.667973 IP 192.168.2.112.34492 &gt; 192.168.2.111.3306: Flags [.], ack 2504, win 501, options [nop,nop,TS val 3973023786 ecr 4160557996], length 0</span><br><span class="line">18:56:39.668303 IP 192.168.2.111.3306 &gt; 192.168.2.112.34492: Flags [.], ack 618, win 243, options [nop,nop,TS val 4160619436 ecr 3972779047], length 0</span><br></pre></td></tr></table></figure><p>å› ä¸ºå®¢æˆ·ç«¯ mysql è¿æ¥ä¸Šåæ²¡æ‰§è¡Œä»»ä½• sqlï¼Œç„¶å nginx æ¯éš” net.ipv4.tcp_keepalive_time çš„ 60s å‘é€ä¿æ´»æŠ¥æ–‡ï¼Œmysql server ç«¯ä¹Ÿå›å¤äº†ï¼ˆå°±ä¸è¿›è¡Œ5æ¬¡é—´éš”6sçš„åç»­æ¢æ´»äº†ï¼‰ï¼Œæ‰€ä»¥ç»“æœå°±å¦‚ä¸Šå›¾æŠ“åŒ…æ‰€ç¤ºï¼Œ60s å‘ä¸€æ¬¡ä¿æ´»çš„æŠ¥æ–‡ã€‚</p><p>åé¢è®©å®¢æˆ·è°ƒæ•´äº†ä¸‹ä¸šåŠ¡æœºå™¨ä¸Šçš„è¿™ä¸‰ä¸ªå†…æ ¸å‚æ•°è§£å†³äº†è¯¥é—®é¢˜ã€‚</p><h3 id="wireshark-æŠ“åŒ…"><a href="#wireshark-æŠ“åŒ…" class="headerlink" title="wireshark æŠ“åŒ…"></a>wireshark æŠ“åŒ…</h3><p>å®é™…å¦‚æœæ˜¯åœ¨ mysql client å»ºç«‹è¿æ¥åå»æŠ“åŒ…å¯¼å…¥ wireshark ï¼Œå¿ƒè·³åŒ…ä¼šè¢«è¯†åˆ«æˆ <code>TCP Dup ACK</code>ï¼Œåªæœ‰æŠ“å®Œæ•´çš„æŠ¥æ–‡ wireshark æ‰ä¼šè¯†åˆ«ä¸º <code>TCP Keep-Alive ACK</code>ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>åº”ç”¨å±‚åœ¨å¥—æ¥å­—å¼€å¯ <code>SO_KEEPALIVE</code> æ‰å¯ä»¥ä½¿ç”¨ keepalive èƒ½åŠ›ã€‚</li><li>åŸºæœ¬åªæœ‰ c è¯­è¨€æ‰æœ‰å‡½æ•°èƒ½ä¸èµ°å†…æ ¸å‚æ•°ï¼Œæ¥è‡ªå®šä¹‰è‡ªå·±çš„ keepalive ä¸‰ä¸ªå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´å¤§å¤šæ•°åº”ç”¨å±‚å¼€å¯ keepalive åï¼Œè¿˜éœ€è¦è°ƒæ•´è¿è¡Œçš„æœºå™¨çš„è¿™ä¸‰ä¸ªå†…æ ¸å‚æ•°ã€‚</li><li>åœ¨ IM å¼€å‘ç»éªŒé‡Œï¼Œå®¢æˆ·ç«¯å»ä½¿ç”¨ keepalive æ‰æ˜¯æœ€æ­£ç¡®çš„ã€‚</li><li>redis server æœ‰é…ç½®å¼€å¯ keepalive</li><li>kafka å®˜æ–¹é»˜è®¤å¼€å¯äº† keepaliveï¼Œè§ <a href="https://issues.apache.org/jira/browse/KAFKA-2096">Enable keepalive socket option for broker</a> å’Œ <a href="https://github.com/apache/kafka/blob/2.1.1/core/src/main/scala/kafka/network/SocketServer.scala#L465">å®˜æ–¹æºç é‡Œçš„ socketChannel.socket().setKeepAlive(true) </a></li></ol><p>å…¶å®æœ¬æ¬¡ nginx åšä»£ç†ï¼Œåœ¨æ€æƒ³ä¸ŠæŒºåƒ sidecar çš„ç†å¿µçš„ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.jianshu.com/p/e3791f975d7b">ç®€ä¹¦: TCP keepalive è¯¦è§£</a></li><li><a href="http://www.52im.net/thread-3506-1-1.html">å³æ—¶é€šè®¯ç½‘: å½»åº•ææ‡‚TCPåè®®å±‚çš„KeepAliveä¿æ´»æœºåˆ¶</a></li><li><a href="https://zhuanlan.zhihu.com/p/69337371">çŸ¥ä¹: golang ç¨‹åºå¼€å¯ tcp keepalive</a></li><li><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#listen">nginx doc: listen å­—æ®µ</a></li><li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_socket_keepalive">nginx doc: proxy_socket_keepalive å­—æ®µ</a></li><li><a href="https://plantegg.github.io/2017/06/02/%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82TCP--wireshark-dup-ack-issue/">åšå®¢: TCP-wireshark-dup-ack-issue</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å®¢æˆ·çš„ç¯å¢ƒä¸‹ï¼Œä¸šåŠ¡è¿è¡Œåœ¨ dmz åŒºï¼Œmysql åœ¨é dmz åŒºï¼Œä¸šåŠ¡è¿ mysql çš„ç©ºé—² tcp è¿æ¥ 240s åä¼šè¢« SDN å¹²æ‰ï¼Œæœ¬æ–‡å®é™…ä»‹ç»ä¸€ç§ä¸åŠ¨ä¸šåŠ¡(ä»£ç )ï¼Œåˆ©ç”¨ä»£ç†çš„è§£å†³åŠæ³•&lt;/p&gt;</summary>
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="tcp" scheme="http://zhangguanzhang.github.io/tags/tcp/"/>
    
    <category term="keepalive" scheme="http://zhangguanzhang.github.io/tags/keepalive/"/>
    
  </entry>
  
  <entry>
    <title>python kubernetes client list permission</title>
    <link href="http://zhangguanzhang.github.io/2022/03/24/python-list-kubernetes-permission/"/>
    <id>http://zhangguanzhang.github.io/2022/03/24/python-list-kubernetes-permission/</id>
    <published>2022-03-24T20:28:30.000Z</published>
    <updated>2022-03-24T20:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>è¿™å‡ å¤©å†…éƒ¨æœ‰ä¸ªåŠŸèƒ½å°±æ˜¯çœ‹ kubernetes client çš„æƒé™æœ‰å“ªäº›</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="kubeconfig-ç”Ÿæˆ"><a href="#kubeconfig-ç”Ÿæˆ" class="headerlink" title="kubeconfig ç”Ÿæˆ"></a>kubeconfig ç”Ÿæˆ</h3><p>å…ˆåˆ¶ä½œä¸€ä¸ªé admin çš„ kubeconfigï¼Œè®°å¾—ä»¥å‰æœ‰ä¸ªé¡¹ç›®æ˜¯éƒ¨ç½²åå¯ä»¥ç”Ÿæˆ kubeconfig çš„ï¼Œè¯¢é—®äº†ä¸€ç•ªåï¼Œå…¶ä»–ç¾¤å‹æç¤ºä¸‹æƒ³èµ·æ¥æ˜¯ <a href="https://github.com/sighupio/permission-manager">permission-manager</a>ï¼Œéƒ¨ç½²åç»“æœå‘ç°ç”Ÿæˆçš„ kubeconfig å‹æ ¹ä¸èƒ½ç”¨ï¼ŒæŠ¥é”™æœªçŸ¥æœºæ„ç­¾ç½²çš„ï¼Œç»“æœè¿˜æ˜¯æŒ‰ç…§ä»¥å‰ <a href="https://zhangguanzhang.github.io/2018/10/27/create-kubeconfig/">ç”Ÿæˆkubeconfigå¸¸è§„çš„ä¸¤ç§æ–¹æ³•</a> ç”Ÿæˆäº†ä¸€ä¸ªç®€å•çš„ã€‚</p><h3 id="å°è¯•è¿‡ç¨‹"><a href="#å°è¯•è¿‡ç¨‹" class="headerlink" title="å°è¯•è¿‡ç¨‹"></a>å°è¯•è¿‡ç¨‹</h3><p>å…¶å®ä¸€å¼€å§‹æ‰“ç®—è‡ªå·±å†™é€»è¾‘ï¼Œå¢åˆ æ”¹æŸ¥éœ€è¦çš„èµ„æºä¾¿åˆ©æ¥æ£€æŸ¥ï¼Œç„¶åçªç„¶æƒ³èµ·æ¥ kubectl (å¿˜äº†å“ªä¸ªç‰ˆæœ¬å¼€å§‹)æœ‰ä¸ª auth å­å‘½ä»¤çš„ <code>can-i</code> æ¥åˆ—å‡ºæƒé™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl --kubeconfig=/etc/kubernetes/develoop.kubeconfig  auth can-i --namespace xxx --list -v=8</span><br><span class="line">I0325 15:58:24.972928   31603 loader.go:379] Config loaded from file:  /etc/kubernetes/develoop.kubeconfig</span><br><span class="line">I0325 15:58:24.974793   31603 request.go:1107] Request Body: &#123;&quot;kind&quot;:&quot;SelfSubjectRulesReview&quot;,&quot;apiVersion&quot;:&quot;authorization.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;creationTimestamp&quot;:null&#125;,&quot;spec&quot;:&#123;&quot;namespace&quot;:&quot;xxx&quot;&#125;,&quot;status&quot;:&#123;&quot;resourceRules&quot;:null,&quot;nonResourceRules&quot;:null,&quot;incomplete&quot;:false&#125;&#125;</span><br><span class="line">I0325 15:58:24.974912   31603 round_trippers.go:422] POST https://127.0.0.1:8443/apis/authorization.k8s.io/v1/selfsubjectrulesreviews</span><br><span class="line">I0325 15:58:24.974927   31603 round_trippers.go:429] Request Headers:</span><br><span class="line">I0325 15:58:24.974938   31603 round_trippers.go:433]     Accept: application/json, */*</span><br><span class="line">I0325 15:58:24.974947   31603 round_trippers.go:433]     Content-Type: application/json</span><br><span class="line">I0325 15:58:24.974957   31603 round_trippers.go:433]     User-Agent: kubectl/v1.20.6 (linux/amd64) kubernetes/8a62859</span><br><span class="line">I0325 15:58:24.974968   31603 round_trippers.go:433]     Authorization: Bearer &lt;masked&gt;</span><br><span class="line">I0325 15:58:25.007471   31603 round_trippers.go:448] Response Status: 201 Created in 32 milliseconds</span><br><span class="line">I0325 15:58:25.007513   31603 round_trippers.go:451] Response Headers:</span><br><span class="line">I0325 15:58:25.007523   31603 round_trippers.go:454]     Cache-Control: no-cache, private</span><br><span class="line">I0325 15:58:25.007530   31603 round_trippers.go:454]     Content-Type: application/json</span><br><span class="line">I0325 15:58:25.007537   31603 round_trippers.go:454]     X-Kubernetes-Pf-Flowschema-Uid: 39e31546-1002-4e5b-a810-7bbeb09467a5</span><br><span class="line">I0325 15:58:25.007547   31603 round_trippers.go:454]     X-Kubernetes-Pf-Prioritylevel-Uid: 08ee1b31-c8de-4f8a-aa1c-b098f4e02ae1</span><br><span class="line">I0325 15:58:25.007554   31603 round_trippers.go:454]     Content-Length: 1028</span><br><span class="line">I0325 15:58:25.007561   31603 round_trippers.go:454]     Date: Fri, 25 Mar 2022 07:58:25 GMT</span><br><span class="line">I0325 15:58:25.007656   31603 request.go:1107] Response Body: &#123;&quot;kind&quot;:&quot;SelfSubjectRulesReview&quot;,&quot;apiVersion&quot;:&quot;authorization.k8s.io/v1&quot;,&quot;metadata&quot;:&#123;&quot;creationTimestamp&quot;:null&#125;,&quot;spec&quot;:&#123;&#125;,&quot;status&quot;:&#123;&quot;resourceRules&quot;:[&#123;&quot;verbs&quot;:[&quot;create&quot;],&quot;apiGroups&quot;:[&quot;authorization.k8s.io&quot;],&quot;resources&quot;:[&quot;selfsubjectaccessreviews&quot;,&quot;selfsubjectrulesreviews&quot;]&#125;,&#123;&quot;verbs&quot;:[&quot;*&quot;],&quot;apiGroups&quot;:[&quot;*&quot;],&quot;resources&quot;:[&quot;secrets&quot;,&quot;configmaps&quot;,&quot;serviceaccounts&quot;,&quot;endpoints&quot;,&quot;events&quot;,&quot;pods&quot;,&quot;pods/log&quot;,&quot;pods/portforward&quot;,&quot;podtemplates&quot;,&quot;resourcequotas&quot;,&quot;limitranges&quot;,&quot;services&quot;,&quot;replicationcontrollers&quot;,&quot;daemonsets&quot;,&quot;deployments&quot;,&quot;replicasets&quot;,&quot;statefulsets&quot;,&quot;cronjobs&quot;,&quot;jobs&quot;,&quot;persistentvolumeclaims&quot;,&quot;ingresses&quot;,&quot;networkpolicies&quot;,&quot;poddisruptionbudgets&quot;]&#125;],&quot;nonResourceRules&quot;:[&#123;&quot;verbs&quot;:[&quot;get&quot;],&quot;nonResourceURLs&quot;:[&quot;/healthz&quot;,&quot;/livez&quot;,&quot;/readyz&quot;,&quot;/version&quot;,&quot;/version/&quot;]&#125;,&#123;&quot;verbs&quot;:[&quot;get&quot;],&quot;nonResourceURLs&quot;:[&quot;/api&quot;,&quot;/api/*&quot;,&quot;/apis&quot;,&quot;/apis/*&quot;,&quot;/healthz&quot;,&quot;/livez&quot;,&quot;/openapi&quot;,&quot;/openapi/*&quot;,&quot;/readyz&quot;,&quot;/version&quot;,&quot;/version/&quot;]&#125;,&#123;&quot;verbs&quot;:[&quot;get&quot;],&quot;nonResourceURLs&quot;:[&quot;/.well-known/openid-configuration&quot;,&quot;/openid/v1/jwks&quot;]&#125;],&quot;incomplete&quot;:fals [truncated 4 chars]</span><br><span class="line">Resources                                       Non-Resource URLs                     Resource Names   Verbs</span><br><span class="line">configmaps.*                                    []                                    []               [*]</span><br><span class="line">cronjobs.*                                      []                                    []               [*]</span><br><span class="line">daemonsets.*                                    []                                    []               [*]</span><br><span class="line">deployments.*                                   []                                    []               [*]</span><br><span class="line">endpoints.*                                     []                                    []               [*]</span><br><span class="line">events.*                                        []                                    []               [*]</span><br><span class="line">ingresses.*                                     []                                    []               [*]</span><br><span class="line">jobs.*                                          []                                    []               [*]</span><br><span class="line">limitranges.*                                   []                                    []               [*]</span><br><span class="line">networkpolicies.*                               []                                    []               [*]</span><br><span class="line">persistentvolumeclaims.*                        []                                    []               [*]</span><br><span class="line">poddisruptionbudgets.*                          []                                    []               [*]</span><br><span class="line">pods.*/log                                      []                                    []               [*]</span><br><span class="line">pods.*/portforward                              []                                    []               [*]</span><br><span class="line">pods.*                                          []                                    []               [*]</span><br><span class="line">podtemplates.*                                  []                                    []               [*]</span><br><span class="line">replicasets.*                                   []                                    []               [*]</span><br><span class="line">replicationcontrollers.*                        []                                    []               [*]</span><br><span class="line">resourcequotas.*                                []                                    []               [*]</span><br><span class="line">secrets.*                                       []                                    []               [*]</span><br><span class="line">serviceaccounts.*                               []                                    []               [*]</span><br><span class="line">services.*                                      []                                    []               [*]</span><br><span class="line">statefulsets.*                                  []                                    []               [*]</span><br><span class="line">selfsubjectaccessreviews.authorization.k8s.io   []                                    []               [create]</span><br><span class="line">selfsubjectrulesreviews.authorization.k8s.io    []                                    []               [create]</span><br><span class="line">                                                [/.well-known/openid-configuration]   []               [get]</span><br><span class="line">                                                [/api/*]                              []               [get]</span><br><span class="line">                                                [/api]                                []               [get]</span><br><span class="line">                                                [/apis/*]                             []               [get]</span><br><span class="line">                                                [/apis]                               []               [get]</span><br><span class="line">                                                [/healthz]                            []               [get]</span><br><span class="line">                                                [/healthz]                            []               [get]</span><br><span class="line">                                                [/livez]                              []               [get]</span><br><span class="line">                                                [/livez]                              []               [get]</span><br><span class="line">                                                [/openapi/*]                          []               [get]</span><br><span class="line">                                                [/openapi]                            []               [get]</span><br><span class="line">                                                [/openid/v1/jwks]                     []               [get]</span><br><span class="line">                                                [/readyz]                             []               [get]</span><br><span class="line">                                                [/readyz]                             []               [get]</span><br><span class="line">                                                [/version/]                           []               [get]</span><br><span class="line">                                                [/version/]                           []               [get]</span><br><span class="line">                                                [/version]                            []               [get]</span><br><span class="line">                                                [/version]                            []               [get]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœç´¢ python kubernetes client selfsubjectrulesreviews æœåˆ°å®˜æ–¹çš„ <a href="https://github.com/kubernetes-client/python/blob/master/kubernetes/docs/AuthorizationV1Api.md#create_self_subject_rules_review">create_self_subject_rules_review ç¤ºä¾‹</a></p><p>è¯•äº†ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat t2</span><br><span class="line"></span><br><span class="line">from kubernetes import client, config</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    body = client.V1SelfSubjectRulesReview()</span><br><span class="line">    print(body)</span><br><span class="line">$ python t2</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;t2&quot;, line 5, in &lt;module&gt;</span><br><span class="line">    body = client.V1SelfSubjectRulesReview()</span><br><span class="line">  File &quot;/usr/local/lib/python3.7/site-packages/kubernetes/client/models/v1_self_subject_rules_review.py&quot;, line 70, in __init__</span><br><span class="line">    self.spec = spec</span><br><span class="line">  File &quot;/usr/local/lib/python3.7/site-packages/kubernetes/client/models/v1_self_subject_rules_review.py&quot;, line 160, in spec</span><br><span class="line">    raise ValueError(&quot;Invalid value for `spec`, must not be `None`&quot;)  # noqa: E501</span><br><span class="line">ValueError: Invalid value for `spec`, must not be `None`</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚çœ‹äº†ä¸‹è¿™ä¸ªç±» <code>V1SelfSubjectRulesReview</code>ï¼Œéœ€è¦ä¼ é€’ spec å±æ€§æ‰ä¸ä¼šæŠ¥é”™ï¼Œç‚¹å‡»è·³è½¬åˆ°æ¨¡å—æºç é‡Œï¼Œæ²¡çœ‹åˆ°å•¥æœ‰ç”¨çš„å‚è€ƒï¼Œæ¯•ç«Ÿå¼±è¯­è¨€ç±»å‹ã€‚åé¢æ‰¾äº†ä¸ª <a href="https://github.com/kubernetes-client/python/blob/master/kubernetes/docs/V1SelfSubjectRulesReviewSpec.md">V1SelfSubjectRulesReviewSpec</a>ï¼Œå•ç‹¬ä¼ ä¸ªç©ºçš„ v1 spec å°±ä¼šæŠ¥é”™ç¼ºå°‘ namespaceï¼ŒæŒ‰ç…§ python çš„ client åº“ä¹ æƒ¯ï¼Œå°è¯•äº†ä¸‹é¢çš„è¿˜æ˜¯æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rule_review_spec = client.V1SelfSubjectAccessReviewSpec(namespace=&#x27;xxx&#x27;)</span><br><span class="line">body = c.V1SelfSubjectRulesReview(spec=rule_review_spec)</span><br></pre></td></tr></table></figure><p>æœ€åæ‘¸ç´¢å‡ºæ¥ä¸‹é¢è¿™æ ·æ‰å¯¹ï¼ŒçœŸæ˜¯æ— è¯­äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">body = client.V1SelfSubjectRulesReview(spec=&#123;<span class="string">&quot;namespace&quot;</span>: namespace&#125;)</span><br><span class="line">result = client.AuthorizationV1Api().create_self_subject_rules_review(body=body)</span><br><span class="line"><span class="keyword">return</span> result.status.resource_rules</span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&#x27;api_groups&#x27;: [&#x27;authorization.k8s.io&#x27;],</span><br><span class="line"> &#x27;resource_names&#x27;: None,</span><br><span class="line"> &#x27;resources&#x27;: [&#x27;selfsubjectaccessreviews&#x27;, &#x27;selfsubjectrulesreviews&#x27;],</span><br><span class="line"> &#x27;verbs&#x27;: [&#x27;create&#x27;]&#125;, &#123;&#x27;api_groups&#x27;: [&#x27;*&#x27;],</span><br><span class="line"> &#x27;resource_names&#x27;: None,</span><br><span class="line"> &#x27;resources&#x27;: [&#x27;secrets&#x27;,</span><br><span class="line">               &#x27;configmaps&#x27;,</span><br><span class="line">               &#x27;serviceaccounts&#x27;,</span><br><span class="line">               &#x27;endpoints&#x27;,</span><br><span class="line">               &#x27;events&#x27;,</span><br><span class="line">               &#x27;pods&#x27;,</span><br><span class="line">               &#x27;pods/log&#x27;,</span><br><span class="line">               &#x27;pods/portforward&#x27;,</span><br><span class="line">               &#x27;podtemplates&#x27;,</span><br><span class="line">               &#x27;resourcequotas&#x27;,</span><br><span class="line">               &#x27;limitranges&#x27;,</span><br><span class="line">               &#x27;services&#x27;,</span><br><span class="line">               &#x27;replicationcontrollers&#x27;,</span><br><span class="line">               &#x27;daemonsets&#x27;,</span><br><span class="line">               &#x27;deployments&#x27;,</span><br><span class="line">               &#x27;replicasets&#x27;,</span><br><span class="line">               &#x27;statefulsets&#x27;,</span><br><span class="line">               &#x27;cronjobs&#x27;,</span><br><span class="line">               &#x27;jobs&#x27;,</span><br><span class="line">               &#x27;persistentvolumeclaims&#x27;,</span><br><span class="line">               &#x27;ingresses&#x27;,</span><br><span class="line">               &#x27;networkpolicies&#x27;,</span><br><span class="line">               &#x27;poddisruptionbudgets&#x27;],</span><br><span class="line"> &#x27;verbs&#x27;: [&#x27;*&#x27;]&#125;]</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/kubernetes-client/python/blob/master/kubernetes/README.md#documentation-for-api-endpoints">documentation-for-api-endpoints</a></li><li><a href="https://github.com/kubernetes-client/python/blob/master/kubernetes/README.md">å®˜æ–¹ client åº“çš„ readmeï¼Œé‡Œé¢æœ‰æ–¹æ³•åå­—å¯¹åº”è°ƒç”¨çš„å“ªä¸ª URL</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;è¿™å‡ å¤©å†…éƒ¨æœ‰ä¸ªåŠŸèƒ½å°±æ˜¯çœ‹ kubernetes client çš„æƒé™æœ‰å“ªäº›&lt;/p&gt;
&lt;h2 id=&quot;è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#è¿‡ç¨‹&quot; cl</summary>
      
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="python" scheme="http://zhangguanzhang.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>server ç«¯çš„ cannot assign requested address</title>
    <link href="http://zhangguanzhang.github.io/2022/03/16/cannot-assign-requested-address/"/>
    <id>http://zhangguanzhang.github.io/2022/03/16/cannot-assign-requested-address/</id>
    <published>2022-03-16T20:28:30.000Z</published>
    <updated>2022-03-16T20:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ä»Šå¤©ç¢°åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æœ€ç»ˆç»“æœå‡ºä¹æ„æ–™</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="é¡¹ç›®ç›¸å…³éƒ¨åˆ†"><a href="#é¡¹ç›®ç›¸å…³éƒ¨åˆ†" class="headerlink" title="é¡¹ç›®ç›¸å…³éƒ¨åˆ†"></a>é¡¹ç›®ç›¸å…³éƒ¨åˆ†</h3><p>å®¢æˆ·çš„ OA å¯¹æ¥æˆ‘ä»¬çš„åº”ç”¨ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨æˆ‘ä»¬çš„æ¥å£ï¼Œæˆ‘ä»¬çš„æ¥å£å†å›è°ƒå®¢æˆ·çš„å›è°ƒåœ°å€ã€‚è°ƒç”¨æµæ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ· OA åç«¯ ----&gt; æˆ‘ä»¬åº”ç”¨ A çš„åç«¯ -----&gt; æˆ‘ä»¬åº”ç”¨ B åç«¯  -----&gt; å®¢æˆ·å†™çš„å›è°ƒåœ°å€</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ¥å£ A è¿”å› B è®¿é—®å›è°ƒçš„æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Get http://10.192.xxx.xxx/xxxxinfo?...: dial tcp 10.192.xxx.xxx:80: connect: cannot assign requested address&quot;</span><br></pre></td></tr></table></figure><h3 id="æ’æŸ¥è¿‡ç¨‹"><a href="#æ’æŸ¥è¿‡ç¨‹" class="headerlink" title="æ’æŸ¥è¿‡ç¨‹"></a>æ’æŸ¥è¿‡ç¨‹</h3><p>ä¸€å¼€å§‹çœ‹åˆ°è¿™ä¸ªæŠ¥é”™çš„æ—¶å€™å°±çŸ¥é“ï¼Œè¿™ä¸ªæŠ¥é”™æ˜¯ TCP å››å…ƒç»„å“ªä¸ªç»„ä¸å¤Ÿç”¨éƒ½ä¼šæŠ¥é”™è¿™ä¸ªçš„ï¼Œä½†æ˜¯æœ€ä¼˜å…ˆå’Œæœ€å¸¸è§çš„å°±æ˜¯ client çš„ç«¯å£è€—å°½ï¼Œä¹Ÿå°±æ˜¯ client ç«¯çš„ port range ä¸å¤Ÿç”¨äº†ï¼Œä¸€èˆ¬æ˜¯è¿™ä¸ª B æœåŠ¡æœºå™¨ä¸Š client çš„ç«¯å£è¾¾åˆ°ä¸Šé™äº†ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å‚æ•°è°ƒæ•´ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -a |&amp; grep port | grep range</span><br></pre></td></tr></table></figure><p>ç»“æœå®é™…ä¸Šä¸Šå» B æœåŠ¡ä¸Š curl è¿™ä¸ª url èƒ½è¿”å› http çŠ¶æ€ç ã€‚èµ·åˆä»¥ä¸ºçœŸçš„æ˜¯æˆ‘ä»¬æœåŠ¡ B åœ¨ç¬é—´æœ‰ç«¯å£æ²¡é‡Šæ”¾çš„ bugï¼Œä½†æ˜¯ curl èƒ½è¿”å› http çŠ¶æ€ç ï¼ˆä½†æ˜¯å†…å®¹æ˜¯ç©ºçš„ï¼‰ï¼Œè¯´æ˜ tcp å±‚é¢æ²¡é—®é¢˜ã€‚å› ä¸º http è¿”å›ä¿¡æ¯æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬åˆæ­¥æ€€ç–‘åˆ°æ˜¯å®¢æˆ·çš„å›è°ƒæœåŠ¡å·å·æ›´æ–°äº†åå¯¼è‡´çš„ã€‚åé¢è®©å®¢æˆ·å–æ¶ˆæ‰ä»–ä»¬å›è°ƒ url çš„åç«¯æ ¡éªŒ token é€»è¾‘ã€‚ä»–ä»¬æ¢äº†åè¿˜æ˜¯ä¸€æ ·ï¼Œç„¶åä»–ä»¬æŠŠè¿™ä¸ªæ¥å£çš„é€»è¾‘ä»£ç æˆªå›¾äº†ï¼Œä»¥åŠæŠŠå›è°ƒæœåŠ¡çš„æ—¥å¿—å‘è¿‡æ¥çš„ã€‚</p><p>çœ‹äº†ä¸‹æ—¥å¿—ï¼Œå‘ç°æŠ¥é”™ä¿¡æ¯é‡Œæœ‰ token æ ¡éªŒè¿‡çš„å’Œæ²¡æœ‰æ ¡éªŒæˆåŠŸçš„ï¼Œæ ¡éªŒå¤±è´¥çš„é‚£äº›åŸå› éƒ½æ˜¯è¿‡æœŸäº†ã€‚è¯¢é—®äº†ä¸‹å‘ç°å›è°ƒçš„ IP åé¢æœ‰å¥½å‡ ä¸ªæœåŠ¡å‰¯æœ¬ï¼Œè®©å®¢æˆ·ä»–ä»¬å»æ£€æŸ¥æœºå™¨æ—¶é—´è¯•è¯•ï¼Œç„¶åå®¢æˆ·ä¸‹ç­äº†ï¼Œå¦ä¸€ä¸ªåŒäº‹è¯´å¯ä»¥å•ç‹¬ä¿®æ”¹æˆ‘ä»¬æœåŠ¡ B çš„è®¾ç½®ï¼ŒæŒ‡å‘å•å°å‰¯æœ¬ç»•è¿‡è´Ÿè½½å‡è¡¡è¯•è¯•ï¼Œæœ€åå‘ç° 5 ä¸ªæ¯ä¸ªå•ç‹¬éƒ½æ­£å¸¸ï¼ŒæŒ‡å‘è´Ÿè½½å‡è¡¡çš„ IP å°±ä¸è¡Œï¼Œè¯¢é—®åå‘ç°æ˜¯ç¡¬ä»¶è´Ÿè½½å‡è¡¡ã€‚æœ€åç¬¬äºŒå¤©å®¢æˆ·æ’æŸ¥åˆ°æ˜¯ç¡¬ä»¶è´Ÿè½½å‡è¡¡çš„è¿æ¥æ•°å¼‚å¸¸ã€‚æ˜¯æ·±ä¿¡æœçš„ç¡¬ä»¶è´Ÿè½½å‡è¡¡ã€‚</p><h2 id="ç»“è®ºå’Œå­¦ä¹ "><a href="#ç»“è®ºå’Œå­¦ä¹ " class="headerlink" title="ç»“è®ºå’Œå­¦ä¹ "></a>ç»“è®ºå’Œå­¦ä¹ </h2><p>å…¶å®ä¸€å¼€å§‹çš„ curl æ­£å¸¸èƒ½è¿”å› http çŠ¶æ€ç å°±è¯´æ˜ tcp æ²¡é—®é¢˜ï¼Œä¸è¿‡è¿™æ¬¡ä¹Ÿç®—æ˜¯è§è¯†åˆ°äº†ï¼Œserver ç«¯çš„ç«¯å£ä¸å¤Ÿä¹Ÿä¼šè¿”å› <code>cannot assign requested address</code> çš„æŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯ä¸»åŠ¨æ‰“å¼€è¿˜æ˜¯è¢«åŠ¨æ‰“å¼€ï¼Œè¿™ä¸ªé”™è¯¯çš„ä¿¡æ¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;ä»Šå¤©ç¢°åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æœ€ç»ˆç»“æœå‡ºä¹æ„æ–™&lt;/p&gt;
&lt;h2 id=&quot;è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#è¿‡ç¨‹&quot; class=&quot;headerlink&quot; </summary>
      
    
    
    
    
    <category term="tcp" scheme="http://zhangguanzhang.github.io/tags/tcp/"/>
    
    <category term="golang" scheme="http://zhangguanzhang.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>keepalived static link build</title>
    <link href="http://zhangguanzhang.github.io/2022/02/24/keepalived-static-build/"/>
    <id>http://zhangguanzhang.github.io/2022/02/24/keepalived-static-build/</id>
    <published>2022-02-24T14:28:30.000Z</published>
    <updated>2022-02-24T14:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ä¹‹å‰é‚£ç¯‡ ipvs svc çš„æ–‡ç« ï¼Œå†…éƒ¨å·²ç»ä¸Šç”Ÿäº§äº†ï¼Œå®¢æˆ·çš„ç¯å¢ƒå¯èƒ½å®Œå…¨å†…ç½‘ï¼ŒåŒ…ç®¡ç†å®‰è£… keepalived ä¸ç°å®ï¼Œæ‰€ä»¥ keepalived æ˜¯éƒ¨ç½²å®¹å™¨é‡Œçš„ã€‚åœ¨å®¹ç¾æµ‹è¯•çš„æ—¶å€™ï¼Œä¾‹å¦‚ 3 å°æœºå™¨éƒ¨ç½²å¥½ä¸šåŠ¡ï¼Œç„¶åè·‘å‹æµ‹è„šæœ¬æ¨¡æ‹Ÿç”¨æˆ·ä½¿ç”¨ï¼Œå‘ç°å…³å°æœºå™¨çš„æ—¶å€™æ•…éšœæ—¶é—´å¾ˆçŸ­ï¼Œä½†æ˜¯è¿™ä¸ªæœºå™¨å¼€æœºçš„æœŸé—´ï¼Œè¿˜æ˜¯å¾ˆå¤§æ¦‚ç‡æ•…éšœæ—¶é—´å¾ˆé•¿ï¼Œä½“ç°åœ¨æ¥å£çš„é”™è¯¯æ•°é‡å¾ˆå¤šã€‚å¤§æ¦‚çœ‹äº†ä¸‹ï¼Œæ˜¯ keepalived å¯åŠ¨æ…¢ï¼Œå…ˆè¯•å¯åŠ¨ docker daemonï¼Œç„¶åå®¹å™¨å¯åŠ¨æ˜¯é¡ºåºä¸å›ºå®šï¼Œå¯èƒ½ keepalived å¾ˆåèµ·æ¥ï¼Œäºæ˜¯å°±æƒ³ç€çœ‹çœ‹èƒ½ä¸èƒ½ keepalived æ‹¿å‡ºæ¥ï¼Œä¹Ÿå°±æ˜¯é™æ€ç¼–è¯‘ã€‚</p><h3 id="buildx-ä½¿ç”¨"><a href="#buildx-ä½¿ç”¨" class="headerlink" title="buildx ä½¿ç”¨"></a>buildx ä½¿ç”¨</h3><p>è§æ–‡ç«  <a href="https://github.com/zhangguanzhang/docker-need-to-know/blob/master/2.docker-image/dockerfile/buildx.md">buildx ä½¿ç”¨</a></p><h3 id="æŠ˜è…¾"><a href="#æŠ˜è…¾" class="headerlink" title="æŠ˜è…¾"></a>æŠ˜è…¾</h3><p>åœ¨å®˜æ–¹ä»“åº“æäº† issue <a href="https://github.com/acassen/keepalived/issues/2107">is there any way to static build</a> åï¼Œå’Œå¼€å‘è€…æ²Ÿé€šå°è¯•è¿‡ä¸å°‘å§¿åŠ¿éƒ½ä¸è¡Œï¼Œç„¶åæœ‰ä¸ªå¤§ä½¬ hack ä¸‹ç¼–è¯‘æˆåŠŸäº†ã€‚å¼€å‘è€…å‚ç…§æ”¹äº†ä¸‹åæˆ‘è¯•äº†ä¸‹æœ€æ–°æºç è¯•å¯ä»¥æ•´å‡ºæ¥äº†ã€‚</p><p>ä¸»è¦æ˜¯åœ¨ alpine å®¹å™¨æ„å»º:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/acassen/keepalived.git</span><br><span class="line"><span class="built_in">cd</span> keepalived</span><br><span class="line">docker run -v <span class="variable">$PWD</span>:/opt --workdir /opt --<span class="built_in">rm</span> -ti alpine</span><br></pre></td></tr></table></figure><p>æ„å»ºä¾èµ–å‚è€ƒä»“åº“é‡Œçš„ <a href="https://github.com/acassen/keepalived/blob/master/Dockerfile.in">Dockerfile.in</a> , static åº“ä¹‹ç±»çš„å¯ä»¥ <a href="https://pkgs.alpinelinux.org/packages?name=*-static*&branch=edge&repo=main">alpinelinux</a> ä¸Šå»æœç´¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">if [ -f /etc/apk/repositories ];then sed -i &#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27; /etc/apk/repositories; fi &amp;&amp; \</span><br><span class="line">    if [ -f /etc/apt/sources.list ];then sed -ri &#x27;s/(deb|security).debian.org/mirrors.aliyun.com/g&#x27; /etc/apt/sources.list; fi &amp;&amp; \</span><br><span class="line">    if [ ! -e /etc/nsswitch.conf ];then echo &#x27;hosts: files dns myhostname&#x27; &gt; /etc/nsswitch.conf; fi</span><br><span class="line"></span><br><span class="line">apk --no-cache add \</span><br><span class="line">    binutils \</span><br><span class="line">    file \</span><br><span class="line">    file-dev \</span><br><span class="line">    gcc \</span><br><span class="line">    glib \</span><br><span class="line">    glib-dev \</span><br><span class="line">    ipset \</span><br><span class="line">    ipset-dev \</span><br><span class="line">    iptables \</span><br><span class="line">    iptables-dev \</span><br><span class="line">    libmnl-dev \</span><br><span class="line">    libnftnl-dev \</span><br><span class="line">    libnl3 \</span><br><span class="line">    libnl3-dev \</span><br><span class="line">    make \</span><br><span class="line">    musl-dev \</span><br><span class="line">    net-snmp-dev \</span><br><span class="line">    openssl \</span><br><span class="line">    openssl-dev \</span><br><span class="line">    openssl-libs-static \</span><br><span class="line">    pcre2 \</span><br><span class="line">    pcre2-dev \</span><br><span class="line">    autoconf \</span><br><span class="line">    automake zlib-static  alpine-sdk linux-headers  libmnl-static</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä½ ä¼šå‘ç°æ²¡æœ‰ <code>configure</code> è„šæœ¬ï¼Œå¯ä»¥å‚ç…§ <a href="https://github.com/acassen/keepalived/blob/master/INSTALL">INSTALL</a> é‡Œæ‰§è¡Œ <code>./autogen.sh</code> ç”Ÿæˆï¼ŒINSTALL é‡Œå¯ä»¥å‚è€ƒä¸‹ï¼Œæœ‰äº›åŒ…ååœ¨ os ä¸Šå¯èƒ½æ¢äº†åå­—ã€‚åŒæ—¶å¦‚æœè¦æŠ˜è…¾çš„è¯ï¼Œå»ºè®®çœ‹ä¸‹ <code>--help</code> çš„å†…å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./autogen.sh</span><br><span class="line">./configure --help</span><br></pre></td></tr></table></figure><p>é™æ€ç¼–è¯‘çš„é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CFLAGS=&#x27;-static -s&#x27; LDFLAGS=-static ./configure  --disable-dynamic-linking \</span><br><span class="line">    --prefix=/usr \</span><br><span class="line">    --exec-prefix=/usr \</span><br><span class="line">    --bindir=/usr/bin \</span><br><span class="line">    --sbindir=/usr/sbin \</span><br><span class="line">    --sysconfdir=/etc \</span><br><span class="line">    --datadir=/usr/share \</span><br><span class="line">    --localstatedir=/var \</span><br><span class="line">    --mandir=/usr/share/man \</span><br><span class="line">    --enable-bfd \</span><br><span class="line">    --enable-snmp \</span><br><span class="line">    --enable-snmp-rfc \</span><br><span class="line">    --enable-nftables \</span><br><span class="line">    --enable-regex \</span><br><span class="line">    --enable-json  --with-init=systemd --enable-vrrp --enable-libnl-dynamic</span><br></pre></td></tr></table></figure><p>é…ç½®ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Keepalived version       : 2.2.7</span><br><span class="line">Compiler                 : gcc gcc (Alpine 10.3.1_git20211027) 10.3.1 20211027</span><br><span class="line">Preprocessor flags       : -D_GNU_SOURCE -DNETSNMP_NO_INLINE</span><br><span class="line">Compiler flags           : -g -static -s -Wall -Wextra -Wunused -Wstrict-prototypes -Wabi -Wabsolute-value -Waddress-of-packed-member -Walloca -Walloc-zero -Warith-conversion -Warray-bounds=2 -Wattribute-alias=2 -Wbad-function-cast -Wc11-c2x-compat -Wcast-align -Wcast-qual -Wdate-time -Wdisabled-optimization -Wdouble-promotion -Wduplicated-branches -Wduplicated-cond -Wfloat-conversion -Wfloat-equal -Wformat-overflow -Wformat-security -Wformat-signedness -Wformat-truncation -Wframe-larger-than=5120 -Wimplicit-fallthrough=3 -Winit-self -Winline -Winvalid-pch -Wjump-misses-init -Wlogical-op -Wmissing-declarations -Wmissing-field-initializers -Wmissing-include-dirs -Wmissing-prototypes -Wnested-externs -Wnormalized -Wnull-dereference -Wold-style-definition -Woverlength-strings -Wpointer-arith -Wredundant-decls -Wshadow -Wshift-overflow=2 -Wstack-protector -Wstrict-overflow=4 -Wstringop-overflow=2 -Wstringop-truncation -Wsuggest-attribute=cold -Wsuggest-attribute=const -Wsuggest-attribute=format -Wsuggest-attribute=malloc -Wsuggest-attribute=noreturn -Wsuggest-attribute=pure -Wsync-nand -Wtrampolines -Wundef -Wuninitialized -Wunknown-pragmas -Wunsafe-loop-optimizations -Wunsuffixed-float-constants -Wunused-const-variable=2 -Wvariadic-macros -Wwrite-strings -fPIE -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -O2</span><br><span class="line">Linker flags             : -static -pie -Wl,-z,relro -Wl,-z,now -L/usr/lib</span><br><span class="line">Extra Lib                : -lm -lssl -lcrypto -lnftnl -lmnl -lpcre2-8 -lnetsnmpmibs -lnetsnmpagent -lnetsnmp -lcrypto</span><br><span class="line">Use IPVS Framework       : Yes</span><br><span class="line">IPVS use libnl           : No</span><br><span class="line">IPVS syncd attributes    : Yes</span><br><span class="line">IPVS 64 bit stats        : Yes</span><br><span class="line">HTTP_GET regex support   : Yes</span><br><span class="line">fwmark socket support    : Yes</span><br><span class="line">Use VRRP Framework       : Yes</span><br><span class="line">Use VRRP VMAC            : Yes</span><br><span class="line">Use VRRP authentication  : Yes</span><br><span class="line">With track_process       : Yes</span><br><span class="line">With linkbeat            : Yes</span><br><span class="line">Use BFD Framework        : Yes</span><br><span class="line">SNMP vrrp support        : Yes</span><br><span class="line">SNMP checker support     : Yes</span><br><span class="line">SNMP RFCv2 support       : Yes</span><br><span class="line">SNMP RFCv3 support       : Yes</span><br><span class="line">SNMP send V3 for V2      : Yes</span><br><span class="line">DBUS support             : No</span><br><span class="line">Use JSON output          : Yes</span><br><span class="line">libnl version            : None</span><br><span class="line">Use IPv4 devconf         : Yes</span><br><span class="line">Use iptables             : No</span><br><span class="line">Use nftables             : Yes</span><br><span class="line">init type                : systemd</span><br><span class="line">systemd notify           : No</span><br><span class="line">Strict config checks     : No</span><br><span class="line">Build documentation      : No</span><br><span class="line">Default runtime options  : -D</span><br><span class="line"></span><br><span class="line">*** WARNING - this build will not support IPVS with IPv6. Please install libnl/libnl-3 dev libraries to support IPv6 with IPVS.</span><br></pre></td></tr></table></figure><p><code>libnl/libnl-3</code> è¿™ä¸ªæˆ‘è¯•äº†ä¸‹åŠ ä¸è¿›å»ï¼Œ<code>apk add libnl-dev</code> å¯ä»¥åŠ ä¸Šå»ï¼Œä½†æ˜¯æˆ‘çœ‹äº† alpine é‡Œ <code>keepalived -v</code> çš„ configure é‡Œä¹Ÿæ²¡æˆ‘ä¸Šé¢å¼€çš„å¤šã€‚å¼ºå¼€æˆ‘è¯•äº† <code>CPPFLAGS=&#39;-I/usr/include/libnl3&#39; LDLIBS=&#39;-lnl3 -lnl-genl-3&#39; </code> å’Œä¸‹è½½ libnl-3 ç¼–è¯‘å®‰è£…åéƒ½ä¸è¡Œï¼Œæƒ³æŠ˜è…¾å’Œä¼ é€’å‚æ•°å•¥çš„è¯ï¼Œå¤šçœ‹çœ‹ <code>configure</code> æ–‡ä»¶é‡Œçš„å†…å®¹ã€‚</p><p>ç¼–è¯‘å’Œå®‰è£…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/opt # keepalived -v</span><br><span class="line">Keepalived v2.2.7 (02/23,2022), git commit v2.2.7-22-geb533a93</span><br><span class="line"></span><br><span class="line">Copyright(C) 2001-2022 Alexandre Cassen, &lt;acassen@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Built with kernel headers for Linux 5.10.41</span><br><span class="line">Running on Linux 5.4.0-99-generic #112-Ubuntu SMP Thu Feb 3 13:50:55 UTC 2022</span><br><span class="line">Distro: Alpine Linux v3.15</span><br><span class="line"></span><br><span class="line">configure options: --disable-dynamic-linking --prefix=/usr --exec-prefix=/usr --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --datadir=/usr/share --localstatedir=/var --mandir=/usr/share/man --enable-bfd --enable-snmp --enable-snmp-rfc --enable-nftables --enable-regex --enable-json --with-init=systemd --enable-vrrp --enable-libnl-dynamic CFLAGS=-static -s LDFLAGS=-static</span><br><span class="line"></span><br><span class="line">Config options:  NFTABLES LVS REGEX VRRP VRRP_AUTH VRRP_VMAC JSON BFD OLD_CHKSUM_COMPAT SNMP_V3_FOR_V2 SNMP_VRRP SNMP_CHECKER SNMP_RFCV2 SNMP_RFCV3 INIT=systemd</span><br><span class="line"></span><br><span class="line">System options:  VSYSLOG MEMFD_CREATE IPV6_MULTICAST_ALL IPV4_DEVCONF RTA_ENCAP RTA_EXPIRES RTA_NEWDST RTA_PREF FRA_SUPPRESS_PREFIXLEN FRA_SUPPRESS_IFGROUP FRA_TUN_ID RTAX_CC_ALGO RTAX_QUICKACK RTEXT_FILTER_SKIP_STATS FRA_L3MDEV FRA_UID_RANGE RTAX_FASTOPEN_NO_COOKIE RTA_VIA FRA_PROTOCOL FRA_IP_PROTO FRA_SPORT_RANGE FRA_DPORT_RANGE RTA_TTL_PROPAGATE IFA_FLAGS LWTUNNEL_ENCAP_MPLS LWTUNNEL_ENCAP_ILA NET_LINUX_IF_H_COLLISION NETINET_LINUX_IF_ETHER_H_COLLISION IPVS_DEST_ATTR_ADDR_FAMILY IPVS_SYNCD_ATTRIBUTES IPVS_64BIT_STATS IPVS_TUN_TYPE IPVS_TUN_CSUM IPVS_TUN_GRE VRRP_IPVLAN IFLA_LINK_NETNSID INET6_ADDR_GEN_MODE VRF SO_MARK</span><br><span class="line">/opt # file `which keepalived`</span><br><span class="line">/usr/sbin/keepalived: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped</span><br><span class="line">/opt # ldd `which keepalived`</span><br><span class="line">/lib/ld-musl-x86_64.so.1: /usr/sbin/keepalived: Not a valid dynamic program</span><br></pre></td></tr></table></figure><h3 id="buildx-ä¸€æ­¥åˆ°ä½"><a href="#buildx-ä¸€æ­¥åˆ°ä½" class="headerlink" title="buildx ä¸€æ­¥åˆ°ä½"></a>buildx ä¸€æ­¥åˆ°ä½</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine as build</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="keyword">if</span> [ -f /etc/apk/repositories ];<span class="keyword">then</span> sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ -f /etc/apt/sources.list ];<span class="keyword">then</span> sed -ri <span class="string">&#x27;s/(deb|security).debian.org/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ ! -e /etc/nsswitch.conf ];<span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&#x27;hosts: files dns myhostname&#x27;</span> &gt; /etc/nsswitch.conf; <span class="keyword">fi</span>  &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apk --no-cache add \</span></span><br><span class="line"><span class="language-bash">        binutils \</span></span><br><span class="line"><span class="language-bash">        file \</span></span><br><span class="line"><span class="language-bash">        file-dev \</span></span><br><span class="line"><span class="language-bash">        gcc \</span></span><br><span class="line"><span class="language-bash">        glib \</span></span><br><span class="line"><span class="language-bash">        glib-dev \</span></span><br><span class="line"><span class="language-bash">        ipset \</span></span><br><span class="line"><span class="language-bash">        ipset-dev \</span></span><br><span class="line"><span class="language-bash">        iptables \</span></span><br><span class="line"><span class="language-bash">        iptables-dev \</span></span><br><span class="line"><span class="language-bash">        libmnl-dev \</span></span><br><span class="line"><span class="language-bash">        libnftnl-dev \</span></span><br><span class="line"><span class="language-bash">        libnl3 \</span></span><br><span class="line"><span class="language-bash">        libnl3-dev \</span></span><br><span class="line"><span class="language-bash">        make \</span></span><br><span class="line"><span class="language-bash">        musl-dev \</span></span><br><span class="line"><span class="language-bash">        net-snmp-dev \</span></span><br><span class="line"><span class="language-bash">        openssl \</span></span><br><span class="line"><span class="language-bash">        openssl-dev \</span></span><br><span class="line"><span class="language-bash">        openssl-libs-static \</span></span><br><span class="line"><span class="language-bash">        pcre2 \</span></span><br><span class="line"><span class="language-bash">        pcre2-dev \</span></span><br><span class="line"><span class="language-bash">        autoconf \</span></span><br><span class="line"><span class="language-bash">        automake zlib-static  alpine-sdk linux-headers  libmnl-static git</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> https://github.com/acassen/keepalived.git</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -ex &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> /opt/keepalived &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    ./autogen.sh &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    CFLAGS=<span class="string">&#x27;-static -s&#x27;</span> LDFLAGS=-static ./configure  --disable-dynamic-linking \</span></span><br><span class="line"><span class="language-bash">    --prefix=/usr \</span></span><br><span class="line"><span class="language-bash">    --exec-prefix=/usr \</span></span><br><span class="line"><span class="language-bash">    --bindir=/usr/bin \</span></span><br><span class="line"><span class="language-bash">    --sbindir=/usr/sbin \</span></span><br><span class="line"><span class="language-bash">    --sysconfdir=/etc \</span></span><br><span class="line"><span class="language-bash">    --datadir=/usr/share \</span></span><br><span class="line"><span class="language-bash">    --localstatedir=/var \</span></span><br><span class="line"><span class="language-bash">    --mandir=/usr/share/man \</span></span><br><span class="line"><span class="language-bash">    --enable-bfd \</span></span><br><span class="line"><span class="language-bash">    --enable-snmp \</span></span><br><span class="line"><span class="language-bash">    --enable-snmp-rfc \</span></span><br><span class="line"><span class="language-bash">    --enable-nftables \</span></span><br><span class="line"><span class="language-bash">    --enable-regex \</span></span><br><span class="line"><span class="language-bash">    --enable-json  --with-init=systemd --enable-vrrp --enable-libnl-dynamic</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -ex &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> /opt/keepalived &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make DESTDIR=/install_root install &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    find /install_root &amp;&amp; \</span></span><br><span class="line"><span class="language-bash"><span class="comment"># delete the docs</span></span></span><br><span class="line">    rm -rf /install_root/usr/share</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch AS bin</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /install_root /</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ„å»º:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker buildx build  . --platform linux/amd64,linux/arm64 \</span><br><span class="line">    --target bin --output . </span><br></pre></td></tr></table></figure><p>ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ ./usr/sbin/keepalived -v</span><br><span class="line">Keepalived v2.2.7 (02/23,2022), git commit v2.2.7-22-geb533a93</span><br><span class="line"></span><br><span class="line">Copyright(C) 2001-2022 Alexandre Cassen, &lt;acassen@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Built with kernel headers for Linux 5.10.41</span><br><span class="line">Running on Linux 5.4.0-99-generic #112-Ubuntu SMP Thu Feb 3 13:50:55 UTC 2022</span><br><span class="line">Distro: Ubuntu 20.04.3 LTS</span><br><span class="line"></span><br><span class="line">configure options: --disable-dynamic-linking --prefix=/usr --exec-prefix=/usr --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --datadir=/usr/share --localstatedir=/var --mandir=/usr/share/man --enable-bfd --enable-snmp --enable-snmp-rfc --enable-nftables --enable-regex --enable-json --with-init=systemd --enable-vrrp --enable-libnl-dynamic CFLAGS=-static -s LDFLAGS=-static</span><br><span class="line"></span><br><span class="line">Config options:  NFTABLES LVS REGEX VRRP VRRP_AUTH VRRP_VMAC JSON BFD OLD_CHKSUM_COMPAT SNMP_V3_FOR_V2 SNMP_VRRP SNMP_CHECKER SNMP_RFCV2 SNMP_RFCV3 INIT=systemd</span><br><span class="line"></span><br><span class="line">System options:  VSYSLOG MEMFD_CREATE IPV6_MULTICAST_ALL IPV4_DEVCONF RTA_ENCAP RTA_EXPIRES RTA_NEWDST RTA_PREF FRA_SUPPRESS_PREFIXLEN FRA_SUPPRESS_IFGROUP FRA_TUN_ID RTAX_CC_ALGO RTAX_QUICKACK RTEXT_FILTER_SKIP_STATS FRA_L3MDEV FRA_UID_RANGE RTAX_FASTOPEN_NO_COOKIE RTA_VIA FRA_PROTOCOL FRA_IP_PROTO FRA_SPORT_RANGE FRA_DPORT_RANGE RTA_TTL_PROPAGATE IFA_FLAGS LWTUNNEL_ENCAP_MPLS LWTUNNEL_ENCAP_ILA NET_LINUX_IF_H_COLLISION NETINET_LINUX_IF_ETHER_H_COLLISION IPVS_DEST_ATTR_ADDR_FAMILY IPVS_SYNCD_ATTRIBUTES IPVS_64BIT_STATS IPVS_TUN_TYPE IPVS_TUN_CSUM IPVS_TUN_GRE VRRP_IPVLAN IFLA_LINK_NETNSID INET6_ADDR_GEN_MODE VRF SO_MARK</span><br><span class="line"></span><br><span class="line">$ ldd ./usr/sbin/keepalived </span><br><span class="line">not a dynamic executable</span><br><span class="line">$ file ./usr/sbin/keepalived</span><br><span class="line">./usr/sbin/keepalived: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped</span><br><span class="line">$ ls -lh ./usr/sbin/keepalived</span><br><span class="line">-rwxr-xr-x 1 root root 4.4M Feb 24 17:56 ./usr/sbin/keepalived</span><br></pre></td></tr></table></figure><p>è¯•äº†ä¸‹ arm64çš„ä¹Ÿå¯ä»¥æ„å»º <code>--platform linux/amd64,linux/arm64</code> å³å¯ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;ä¹‹å‰é‚£ç¯‡ ipvs svc çš„æ–‡ç« ï¼Œå†…éƒ¨å·²ç»ä¸Šç”Ÿäº§äº†ï¼Œå®¢æˆ·çš„ç¯å¢ƒå¯èƒ½å®Œå…¨å†…ç½‘ï¼ŒåŒ…ç®¡ç†å®‰è£… keepalived ä¸ç°å®ï¼Œæ‰€ä»¥ keepali</summary>
      
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="keepalived" scheme="http://zhangguanzhang.github.io/tags/keepalived/"/>
    
  </entry>
  
  <entry>
    <title>proxmox å¼€æœº error: disk &#39;lvmid/[vg uuid]/[lv uuid]&#39; not found</title>
    <link href="http://zhangguanzhang.github.io/2022/02/18/proxmox-boot-disk-lvmid-not-found/"/>
    <id>http://zhangguanzhang.github.io/2022/02/18/proxmox-boot-disk-lvmid-not-found/</id>
    <published>2022-02-18T14:17:30.000Z</published>
    <updated>2022-02-18T14:17:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€æ¬¡ proxmox æœºå™¨çªç„¶å®•æœºï¼Œå¼€æœºåè¿›å…¥ grub resuce æ— æ³•å¯åŠ¨çš„å¤„ç†è¿‡ç¨‹</p><span id="more"></span><h2 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h2><p>ä¸Šåˆ ssh åˆ° proxmox ä¸Šçš„è™šæœºä¸Šåšå®éªŒï¼Œçªç„¶æœºå™¨æ–­å¼€äº†ï¼Œä»¥ä¸ºæ˜¯è™šæœºçš„é—®é¢˜ï¼Œç»“æœå‘ç°æ˜¯ proxmox æœºå™¨æœ‰é—®é¢˜äº†ï¼Œæ¥ä¸Šæ˜¾ç¤ºå™¨é‡å¯çœ‹åˆ°è¿›å…¥äº† grub rescue æ¨¡å¼ã€‚</p><p>pve ç‰ˆæœ¬ä¿¡æ¯ä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pveversion</span><br><span class="line">pve-manager/6.2-4/9824574a (running kernel: 5.4.34-1-pve)</span><br><span class="line"># 2022/04/06 </span><br><span class="line"># å¸®åˆ«äººä¸€ä¸ª 7.1-7 çš„è¿™æ ·é—®é¢˜ä¹Ÿæ˜¯æŒ‰ç…§æ–‡ç« æ­¥éª¤æ¢å¤çš„</span><br><span class="line"># å¹¶æ›´æ–°æ–‡ç« é‡Œéƒ¨åˆ†å‘½ä»¤å’Œä»‹ç»</span><br></pre></td></tr></table></figure><h2 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h2><h3 id="é”™è¯¯ä¿¡æ¯"><a href="#é”™è¯¯ä¿¡æ¯" class="headerlink" title="é”™è¯¯ä¿¡æ¯"></a>é”™è¯¯ä¿¡æ¯</h3><p>é”™è¯¯ä¿¡æ¯ä¸ºå¦‚ä¸‹ï¼Œæš‚æ—¶çœ‹äº†ä¸‹ lvm æ˜¯å­˜åœ¨çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error: disk `lvmid/ExzA22-yHkV-0ymE-XbMT-zrD6-69Wp-bboRVP/zbB3V2-Kg2Y-EdI6-dbs1-6uSo-e6wk-ZRBJdh&#x27; not found.</span><br><span class="line">Entering rescue mode...</span><br><span class="line">grub rescue&gt; ls</span><br><span class="line">(lvm/pve-root) (lvm/pve-swap) (hd0) (hd1) (hd1,gpt3) (hd1,gpt2) (hd1,gpt1) </span><br></pre></td></tr></table></figure><h3 id="è¿›å…¥-rescue-æ¨¡å¼"><a href="#è¿›å…¥-rescue-æ¨¡å¼" class="headerlink" title="è¿›å…¥ rescue æ¨¡å¼"></a>è¿›å…¥ rescue æ¨¡å¼</h3><p>æä¸ª u ç›˜ï¼ŒæŠŠ CentOS 7.9 minimal çš„ ISO çƒ§å½•è¿›å»åï¼Œæ’åˆ° proxmox çš„ USB å£å­ä¸Šï¼Œå¼€æœº F12 é€‰æ‹©ä» U ç›˜å¯åŠ¨ã€‚<br>é€‰æ‹© <code>Troubleshooting â€“&gt; Rescue</code> é€‰ä¸­ <code>Rescue a CentOS system</code> ï¼Œä¸€ç›´ç­‰å¾…ï¼Œæœ‰äº¤äº’åï¼Œé€‰æ‹© 3ï¼Œä¹Ÿå°±æ˜¯ <code>3) Skip to shell</code>ã€‚</p><p>å…ˆçœ‹ä¸‹ lvm ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ pvs</span><br><span class="line">  PV         VG  Fmt  Attr PSize    PFree  </span><br><span class="line">  /dev/sda1  pve lvm2 a--  &lt;931.51g 697.50g</span><br><span class="line">  /dev/sdb3  pve lvm2 a--  &lt;476.44g      0</span><br><span class="line">$ vgs</span><br><span class="line">  VG  #PV #LV #SN Attr   VSize VFree  </span><br><span class="line">  pve   2  23   0 wz--n- 1.37t 697.50g</span><br><span class="line">$ lvs</span><br><span class="line">  LV                           VG  Attr       LSize    Pool Origin          Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">  base-101-disk-0              pve Vri---tz-k   10.00g data                                                        </span><br><span class="line">  base-106-disk-0              pve Vri---tz-k   20.00g data                                                        </span><br><span class="line">  data                         pve twi-aotz-- &lt;550.29g                      73.93  6.08                            </span><br><span class="line">  root                         pve -wi-ao----  146.00g                                                             </span><br><span class="line">  snap_vm-102-disk-0_a20210429 pve Vri---tz-k   30.00g data vm-102-disk-0                                          </span><br><span class="line">  swap                         pve -wi-ao----    7.00g                                                             </span><br><span class="line">  vm-100-cloudinit             pve Vwi-a-tz--    4.00m data                 9.38                                   </span><br><span class="line">  vm-100-disk-0                pve Vwi-a-tz--   10.00g data base-101-disk-0 16.65                                  </span><br><span class="line">  vm-100-disk-1                pve Vwi-a-tz--    7.00g data                 0.17                                   </span><br><span class="line">  vm-101-cloudinit             pve Vwi-a-tz--    4.00m data                 0.00                                   </span><br><span class="line">  vm-102-cloudinit             pve Vwi-aotz--    4.00m data                 9.38                                   </span><br><span class="line">  vm-102-disk-0                pve Vwi-aotz--  100.00g data                 73.78                                  </span><br><span class="line">  vm-102-state-a20210429       pve Vwi-a-tz--   &lt;8.49g data                 44.03                                  </span><br><span class="line">  vm-103-disk-0                pve Vwi-a-tz--   25.00g data                 99.98                                  </span><br><span class="line">  vm-104-disk-0                pve Vwi-a-tz--   &lt;2.02g data                 99.31                                  </span><br><span class="line">  vm-105-cloudinit             pve Vwi-a-tz--    4.00m data                 9.38                                   </span><br><span class="line">  vm-105-disk-0                pve Vwi-a-tz--   10.00g data                 85.13                                  </span><br><span class="line">  vm-106-cloudinit             pve Vwi-a-tz--    4.00m data                 0.00                                   </span><br><span class="line">  vm-107-cloudinit             pve Vwi-a-tz--    4.00m data                 9.38                                   </span><br><span class="line">  vm-107-disk-0                pve Vwi-a-tz--   30.00g data                 65.94                                  </span><br><span class="line">  vm-108-cloudinit             pve Vwi-aotz--    4.00m data                 9.38                                   </span><br><span class="line">  vm-108-disk-0                pve Vwi-aotz--  250.00g data                 99.21                                  </span><br><span class="line">  vm-200-disk-0                pve Vwi-aotz--   &lt;2.02g data                 99.31 </span><br></pre></td></tr></table></figure><p>æ¿€æ´»ä¸‹ vg çœ‹çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ vgchange -a y</span><br><span class="line">/usr/sbin/dmeventd: stat failed: No such file or directory</span><br><span class="line">WARNING: Failed to monirot pve/data.</span><br><span class="line">/usr/sbin/dmeventd: stat failed: No such file or directory</span><br><span class="line">WARNING: Failed to monirot pve/data.</span><br><span class="line">/usr/sbin/dmeventd: stat failed: No such file or directory</span><br><span class="line">WARNING: Failed to monirot pve/data.</span><br><span class="line">/usr/sbin/dmeventd: stat failed: No such file or directory</span><br><span class="line">WARNING: Failed to monirot pve/data.</span><br><span class="line">/usr/sbin/dmeventd: stat failed: No such file or directory</span><br><span class="line">WARNING: Failed to monirot pve/data.</span><br><span class="line">/usr/sbin/dmeventd: stat failed: No such file or directory</span><br><span class="line">WARNING: Failed to monirot pve/data.</span><br><span class="line">...</span><br><span class="line">20 logical volume(s) in volume group &quot;pve&quot; now active</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨æŒ‚è½½ä¸‹çœ‹çœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mount /dev/mapper/pve-root /mnt/sysimage</span><br><span class="line"></span><br><span class="line"># å¦‚æœæŠ¥é”™ </span><br><span class="line">       mount: wrong fs type, bad option, bad superblock on /dev/mapper/pve-root,</span><br><span class="line">       missing codepage or helper program, or other error</span><br><span class="line"></span><br><span class="line">       In some cases useful info is found in syslog - try</span><br><span class="line">       dmesg | tail or so.</span><br><span class="line"># å»ºè®® pve çš„ iso è¿›å…¥æ•‘æ´æ¨¡å¼ï¼Œå»ä¿®å¤ä¸Šé¢çš„åˆ†åŒºè·¯å¾„ï¼Œpve çš„ root åˆ†åŒºä¸€èˆ¬æ˜¯ ext4 æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ä¿®å¤ä¸‹è¯•è¯•</span><br><span class="line">$ fsck.ext4 -y /dev/mapper/pve-root</span><br><span class="line"></span><br><span class="line"># å¦‚æœæ˜¯ centos çš„ iso rescue é‡Œä½¿ç”¨ e2fsck ï¼Œå¯èƒ½ä¼šæŠ¥é”™ç‰ˆæœ¬ä½ï¼š</span><br><span class="line">e2fsck 1.42.9 (28-Dec-2013)</span><br><span class="line">/dev/mapper/pve-root has unsupported feature(s): metadata_csum</span><br><span class="line">e2fsck: Get a newer version of e2fsck!</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cd /mnt/sysimage</span><br><span class="line">$ ls -l boot/</span><br><span class="line">total 58496</span><br><span class="line">-rw-r--r-- 1 root root   237698 May  7  2020 config-5.4.34-1-pve</span><br><span class="line">drwxr-xr-x 3 root root     4096 Jan  1  1970 efi</span><br><span class="line">drwxr-xr-x 6 root root     4096 Feb 18 12:59 grub</span><br><span class="line">-rw-r--r-- 1 root root 42573458 Aug 18  2021 initrd.img-5.4.34-1-pve</span><br><span class="line">-rw-r--r-- 1 root root   182704 Jun 26  2015 memtest86+.bin</span><br><span class="line">-rw-r--r-- 1 root root   184840 Jun 26  2015 memtest86+_multiboot.bin</span><br><span class="line">drwxr-xr-x 2 root root     4096 Sep  9  2020 pve</span><br><span class="line">-rw-r--r-- 1 root root  4795341 May  7  2020 System.map-5.4.34-1-pve</span><br><span class="line">-rw-r--r-- 1 root root 11901312 May  7  2020 vmlinuz-5.4.34-1-pve</span><br><span class="line">$ cp etc/lvm/backup/pve root/pve</span><br></pre></td></tr></table></figure><p>ç„¶å chroot è¿›å»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mount -o bind /dev /mnt/sysimage/dev</span><br><span class="line">mount -o bind /proc /mnt/sysimage/proc</span><br><span class="line">mount -o bind /run /mnt/sysimage/run</span><br><span class="line">mount -o bind /sys /mnt/sysimage/sys</span><br><span class="line"># ä¸Šé¢å¦‚æœåœ¨chrootä¹‹å‰ä¸ mount ä¼šå¯¼è‡´ä¸€äº›lstat /dev /proc /sys çš„å‘½ä»¤æŠ¥é”™æ— æ³•è¯»å–è¿™äº›ç›®å½• </span><br><span class="line">chroot /mnt/sysimage</span><br></pre></td></tr></table></figure><p>é‡Œé¢å»æŠ˜è…¾äº†ä¸‹ï¼Œå¥½åƒæ˜¯ vg å’Œ lv çš„ uuid å˜äº†ï¼Œå°è¯•<code>vgcfgrestore</code> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ç»“å°¾ pve æ˜¯ root æ‰€åœ¨çš„ vg åå­—</span><br><span class="line">vgcfgrestore --test -f /etc/lvm/backup/pve pve</span><br><span class="line"># è¾“å…¥ y å›è½¦ï¼Œå¤±è´¥äº†å°±ä¸‹é¢çš„ --force é€‰é¡¹è¿è¡Œ</span><br><span class="line">vgcfgrestore --force -f /etc/lvm/backup/pve pve</span><br></pre></td></tr></table></figure><p>é‡å¯è¿˜æ˜¯ä¸è¡Œï¼Œçœ‹äº†ä¸‹ <code>/etc/lvm/backup/pve</code> ä¹Ÿæ²¡å•¥é—®é¢˜ã€‚</p><h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><p>lvm ä¿¡æ¯å’Œæ–‡ä»¶éƒ½åœ¨ï¼Œå¯èƒ½æ˜¯ grub æŸåäº†ã€‚å°è¯•å¤‡ä»½ grub.cfg å <code>grub-mkconfig</code> äº†ä¸‹ï¼Œ diff å¯¹æ¯”äº†ä¸‹ä¹Ÿæ²¡å˜å•¥ uuid ç›¸å…³çš„åœ°æ–¹ï¼Œç„¶åé‡å¯å†è¿› CentOS Rescue æ¨¡å¼é‡Œï¼Œé€‰æ‹© 1 è‡ªåŠ¨æŒ‚è½½ã€‚ç„¶åå°è¯• chroot è¿›å» <code>grub-install</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># æ²¡é€‰è‡ªåŠ¨æŒ‚è½½çš„è¯è®°å¾—ä¸‹é¢è¿™äº›å‘½ä»¤</span><br><span class="line">mount /dev/mapper/pve-root /mnt/sysimage</span><br><span class="line">mount -o bind /dev /mnt/sysimage/dev</span><br><span class="line">mount -o bind /proc /mnt/sysimage/proc</span><br><span class="line">mount -o bind /run /mnt/sysimage/run</span><br><span class="line">mount -o bind /sys /mnt/sysimage/sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># é€€å‡ºäº† chroot çš„è¯å°±å† chroot è¿›æ¥</span><br><span class="line">chroot /mnt/sysimage</span><br><span class="line">cd /boot/grub</span><br><span class="line">cp grub.cfg grub.cfg.bak</span><br><span class="line">lvscan</span><br><span class="line">vgscan</span><br><span class="line">pvscan</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>/boot/efi</code> æœ‰äº›æœºå™¨ä¸æ˜¯ uefi å¯åŠ¨çš„ï¼Œè¿™ä¸ªæ—¶å€™å…ˆçœ‹ä¸‹ <code>/etc/fstab</code> é‡Œæœ‰ <code>/boot/efi</code> çš„æŒ‚è½½æ²¡ï¼Œæœ‰çš„è¯å°±éœ€è¦ä¸‹é¢è¿™æ ·æŒ‚è½½ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/fstab æ‰¾åˆ° /boot/efi çš„åˆ†åŒºçš„ UUIDï¼Œlsblk æ‰¾åˆ°è¯¥ UUID çš„ dev è®¾å¤‡</span><br><span class="line"># ä¾‹å¦‚æˆ‘çš„æ˜¯ /dev/sda2 æ‰§è¡Œä¸‹é¢å‘½ä»¤æŒ‚è½½ /boot/efi</span><br><span class="line">mount /dev/sda2 /boot/efi</span><br></pre></td></tr></table></figure><p>grub-install </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># pve æ˜¯ grub-install ä¸æ˜¯ grub2 ä¹Ÿæ²¡æœ‰ grub2-install</span><br><span class="line">grub-install --debug --recheck --root-directory=/ /dev/mapper/pve-root</span><br><span class="line"># ä¸Šé¢çš„ grub-install æ²¡å¤±è´¥å°±å¯ä»¥äº†</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¥½äº†ã€‚</p><h3 id="ä¸€äº›å…¶ä»–å‘½ä»¤"><a href="#ä¸€äº›å…¶ä»–å‘½ä»¤" class="headerlink" title="ä¸€äº›å…¶ä»–å‘½ä»¤"></a>ä¸€äº›å…¶ä»–å‘½ä»¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grub-probe -d /dev/mapper/pve-root -t drive</span><br><span class="line"># å¦‚æœä¸‹é¢å‘½ä»¤æŠ¥é”™å°±æ— æ³• grub-install</span><br><span class="line">$ grub-probe -d /dev/mapper/pve-root </span><br><span class="line">ext2</span><br><span class="line"># ç”¨äºæ›´æ–° grub ä¿¡æ¯ï¼Œä½†æ˜¯ä¸€èˆ¬å¯¹è¿™ç§æƒ…å†µæ²¡å¤šå¤§ç”¨è²Œä¼¼</span><br><span class="line">grup-update</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸€æ¬¡ proxmox æœºå™¨çªç„¶å®•æœºï¼Œå¼€æœºåè¿›å…¥ grub resuce æ— æ³•å¯åŠ¨çš„å¤„ç†è¿‡ç¨‹&lt;/p&gt;</summary>
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="grub" scheme="http://zhangguanzhang.github.io/tags/grub/"/>
    
  </entry>
  
  <entry>
    <title>18.09.03 docker daemon layer broken çš„ä¸€æ¬¡ä¸ä¼˜é›…å¤„ç†</title>
    <link href="http://zhangguanzhang.github.io/2022/02/10/docker-daemon-layer-broken/"/>
    <id>http://zhangguanzhang.github.io/2022/02/10/docker-daemon-layer-broken/</id>
    <published>2022-02-10T14:28:30.000Z</published>
    <updated>2022-02-10T14:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€æ¬¡ 18.09.03 docker daemon å­˜å‚¨çš„å±‚æŸåæ— æ³•ä¿®å¤çš„è¿‡ç¨‹ï¼Œè™½ç„¶ä¸ä¼˜é›…ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°æ›´å¥½çš„è§£å†³åŠæ³•ï¼Œæš‚æ—¶è®°å½•ä»…ä¾›å‚è€ƒã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>æœºå™¨é‡å¯åï¼Œéƒ¨åˆ† pod æ— æ³•å¯åŠ¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ docker info</span><br><span class="line">Containers: 51</span><br><span class="line"> Running: 27</span><br><span class="line"> Paused: 0</span><br><span class="line"> Stopped: 24</span><br><span class="line">Images: 23</span><br><span class="line">Server Version: 18.09.3</span><br><span class="line">Storage Driver: overlay2</span><br><span class="line"> Backing Filesystem: xfs</span><br><span class="line"> Supports d_type: true</span><br><span class="line"> Native Overlay Diff: true</span><br><span class="line">Logging Driver: json-file</span><br><span class="line">Cgroup Driver: cgroupfs</span><br><span class="line">Plugins:</span><br><span class="line"> Volume: local</span><br><span class="line"> Network: bridge host macvlan null overlay</span><br><span class="line"> Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog</span><br><span class="line">Swarm: inactive</span><br><span class="line">Runtimes: runc</span><br><span class="line">Default Runtime: runc</span><br><span class="line">Init Binary: docker-init</span><br><span class="line">containerd version: e6b3f5632f50dbc4e9cb6288d911bf4f5e95b18e</span><br><span class="line">runc version: 6635b4f0c6af3810594d2770f662f34ddc15b40d</span><br><span class="line">init version: fec3683</span><br><span class="line">Security Options:</span><br><span class="line"> seccomp</span><br><span class="line">  Profile: default</span><br><span class="line">Kernel Version: 3.10.0-693.el7.x86_64</span><br><span class="line">Operating System: CentOS Linux 7 (Core)</span><br><span class="line">OSType: linux</span><br><span class="line">Architecture: x86_64</span><br><span class="line">CPUs: 8</span><br><span class="line">Total Memory: 15.51GiB</span><br><span class="line">Name: hdzwvm000006238.novalocal</span><br><span class="line">ID: AUFF:32CM:54KK:FA2F:M3GS:EI77:2VSQ:HH3T:2LXM:7AFG:WXAQ:IKSV</span><br><span class="line">Docker Root Dir: /data/kube/docker</span><br><span class="line">Debug Mode (client): false</span><br><span class="line">Debug Mode (server): false</span><br><span class="line">Registry: https://index.docker.io/v1/</span><br><span class="line">Labels:</span><br></pre></td></tr></table></figure><h2 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h2><p>åˆæ­¥æ’æŸ¥äº†ä¸‹ç¡®è®¤éƒ¨åˆ†é•œåƒæŸåäº†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªï¼Œ<code>history --no-trunc</code> çœ‹äº†ä¸‹è¿™ä¸ªé•œåƒçš„ rootfs æ˜¯ ubuntu ï¼Œç»“æœæŠ¥é”™ä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm -ti --entrypoint bash xxx.cn/base/xxxxxx-amd64:v2</span><br><span class="line">standard_init_linux.go:207: exec user process caused &quot;no such file or directory&quot;</span><br></pre></td></tr></table></figure><p>ä¹‹å‰ä¹Ÿæœ‰ç±»ä¼¼æƒ…å†µï¼Œä½†æ˜¯ rmiå loadå°±å¥½äº†ã€‚è¿™æ¬¡æ˜¯ rmi æ‰åæ‰‹åŠ¨ load ä¹Ÿä¸è¡Œï¼Œå¯¹æ¯”äº†é•œåƒç¦»çº¿æ–‡ä»¶çš„ md5sum å’ŒåŒ…é‡Œçš„æ˜¯ä¸€æ ·çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ md5sum ./images/xxxxxx-amd64-v2#release_zzzzzzz </span><br><span class="line">cd1cf11ac90d6df59a31460cb1624933  ./images/xxxxxx-amd64-v2#release_zzzzzzz</span><br><span class="line"></span><br><span class="line">$ docker rmi xxx.cn/base/xxxxxx-amd64:v2</span><br><span class="line">Untagged: xxx.cn/base/xxxxxx-amd64:v2</span><br><span class="line">Deleted: sha256:fe7c32d1138c5215dba9fbfa4f675eff47f1a30605d9914fff34a5db00ad45f0</span><br><span class="line">$ docker load -i  xxxxxx-amd64-v2#release_zzzzzzz </span><br><span class="line">Loaded image: xxx.cn/base/xxxxxx-amd64:v2</span><br><span class="line">$ docker run --rm -ti --entrypoint bash xxx.cn/base/xxxxxx-amd64:v2</span><br><span class="line">standard_init_linux.go:207: exec user process caused &quot;no such file or directory&quot;</span><br></pre></td></tr></table></figure><p>ç„¶åæ’æŸ¥åˆ°æœ‰å®‰å…¨è½¯ä»¶ <code>sangfor</code>ï¼Œå¹¶ä¸”æœºå™¨é‡å¯è¿‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ ps aux | grep san</span><br><span class="line">root      1183  0.0  0.0 113184  1492 ?        S    Feb09   0:03 /bin/bash /sangfor/edr/agent/bin/eps_services_ctrl</span><br><span class="line">root      5132  0.0  0.0 113436  1696 ?        S    Feb09   0:17 /bin/bash /sangfor/edr/agent/bin/abs_monitor</span><br><span class="line">root      5164  0.0  0.0  48092  3392 ?        S    Feb09   0:04 /sangfor/edr/agent/bin/abs_deployer</span><br><span class="line">root      5205  0.0  0.0  43036  1552 ?        Ss   Feb09   0:07 /sangfor/edr/agent/bin/edr_monitor</span><br><span class="line">root      5378  0.0  0.0 194948  6260 ?        Sl   Feb09   0:04 /sangfor/edr/agent/bin/sfupdatemgr -p edr_monitor</span><br><span class="line">root      5379  0.0  0.0  43360  3560 ?        S    Feb09   0:01 /sangfor/edr/agent/bin/ipc_proxy</span><br><span class="line">root      5380  0.6  0.1 708028 29892 ?        Sl   Feb09   6:56 /sangfor/edr/agent/bin/edr_agent</span><br><span class="line">root      5381  0.1  0.0  17060  1332 ?        S&lt;   Feb09   1:58 /sangfor/edr/agent/bin/cpulimit --limit=50 --exe=edr_agent</span><br><span class="line">root      5382  0.0  0.0 113568  1900 ?        S    Feb09   0:28 /bin/bash /sangfor/edr/agent/bin/asset_collection_cpulimit.sh</span><br><span class="line">root      5383  0.0  0.0 128944  5444 ?        Sl   Feb09   0:27 /sangfor/edr/agent/bin/edr_sec_plan</span><br><span class="line">root      5384  0.0  0.0 117656  8956 ?        S    Feb09   0:00 /sangfor/edr/agent/bin/lloader /sangfor/edr/agent/bin/../lmodules/isolate_area_tool.lua</span><br><span class="line">root      5385  0.0  0.0  68916  3928 ?        S    Feb09   0:01 /sangfor/edr/agent/bin/lloader /sangfor/edr/agent/bin/../lmodules/isolate_area_main.lua</span><br><span class="line">root     22594  0.0  0.0 112712   976 pts/2    S+   11:37   0:00 grep --color=auto san</span><br><span class="line">$ uptime -s</span><br><span class="line">2022-02-09 17:19:09</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br><span class="line">$ tail -n 40 /var/spool/mail/root</span><br><span class="line">...</span><br><span class="line">edr pid 5205</span><br><span class="line">ls: cannot access /sangfor/edr/agent/bin/../packages/: No such file or directory</span><br><span class="line"></span><br><span class="line">$ ll /etc/cron.d</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r--. 1 root root 128 Aug  3  2017 0hourly</span><br><span class="line">-rw-r--r--  1 root root  60 Dec 10  2020 edr_agent</span><br><span class="line">-rw-------. 1 root root 235 Apr  1  2020 sysstat</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br><span class="line">$ cat edr_agent </span><br><span class="line">* * * * * root /sangfor/edr/agent/bin/eps_services_check.sh</span><br></pre></td></tr></table></figure><p>è®©å®¢æˆ·å¸è½½æ‰åè¿˜æ˜¯ä¸è¡Œï¼Œç„¶å save äº†ä¸‹å‘ç°äº†é—®é¢˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ docker save -o test.tar xxx.cn/base/xxxxxx-amd64:v2 </span><br><span class="line">Error response from daemon: open /data/kube/docker/overlay2/920a06a6d4eb64db0898234cd3a81b01115d6fcc2cfc50c5107e0205f7230318/diff/lib/x86_64-linux-gnu/ld-2.23.so: no such file or directory</span><br><span class="line">$ docker inspect xxx.cn/base/xxxxxx-amd64:v2 | grep 920a0</span><br><span class="line"> &quot;LowerDir&quot;: ...:/data/kube/docker/overlay2/920a06a6d4eb64db0898234cd3a81b01115d6fcc2cfc50c5107e0205f7230318/diff&quot;,</span><br><span class="line"></span><br><span class="line">$ ls -l /data/kube/docker/overlay2/920a06a6d4eb64db0898234cd3a81b01115d6fcc2cfc50c5107e0205f7230318/diff/lib/x86_64-linux-gnu/ | head</span><br><span class="line">total 10684</span><br><span class="line">lrwxrwxrwx 1 root root      10 Feb  6  2019 ld-linux-x86-64.so.2 -&gt; ld-2.23.so</span><br><span class="line">lrwxrwxrwx 1 root root      15 Feb  7  2016 libacl.so.1 -&gt; libacl.so.1.1.0</span><br><span class="line">-rw-r--r-- 1 root root   31232 Feb  7  2016 libacl.so.1.1.0</span><br><span class="line">-rw-r--r-- 1 root root   14992 Feb  6  2019 libanl-2.23.so</span><br><span class="line">lrwxrwxrwx 1 root root      14 Feb  6  2019 libanl.so.1 -&gt; libanl-2.23.so</span><br><span class="line">lrwxrwxrwx 1 root root      20 May 29  2019 libapparmor.so.1 -&gt; libapparmor.so.1.4.0</span><br><span class="line">-rw-r--r-- 1 root root   64144 May 29  2019 libapparmor.so.1.4.0</span><br><span class="line">lrwxrwxrwx 1 root root      16 Sep  9  2014 libattr.so.1 -&gt; libattr.so.1.1.0</span><br><span class="line">-rw-r--r-- 1 root root   18624 Sep  9  2014 libattr.so.1.1.0</span><br></pre></td></tr></table></figure><p>æŠŠé‚£ä¸ªé•œåƒçš„ç¦»çº¿æ–‡ä»¶æ‹¿åˆ°å…¶ä»–æœºå™¨ä¸Š load åçœ‹äº†ä¸‹è¯¥å±‚æ˜¯æœ‰æ–‡ä»¶ <code>ld-2.23.so</code> çš„:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ll b5f1b3d6665a476b9460532568499f2923c1621d710f6a1e20cf7f3e1a928e17/diff/lib/x86_64-linux-gnu/</span><br><span class="line">total 10844</span><br><span class="line">-rwxr-xr-x 1 root root  162632 Feb  6  2019 ld-2.23.so</span><br><span class="line">lrwxrwxrwx 1 root root      10 Feb  6  2019 ld-linux-x86-64.so.2 -&gt; ld-2.23.so</span><br></pre></td></tr></table></figure><p>æœ€åæœ¬åœ°è¯•äº†ä¸‹ï¼Œå‘ç°å¦‚æœ daemon çš„å±‚æŸåäº†ï¼Œrmi å load æ˜¯ä¸ä¼šé‡æ–°è¦†ç›–çš„ï¼Œæ­£å¸¸ load ä¸€ä¸ªæ–°é•œåƒ load çš„æ—¶å€™æ˜¯ä¼šæœ‰å±‚æ˜¾ç¤ºçš„ï¼Œç±»ä¼¼ä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ docker load -i netshoot#latest </span><br><span class="line">b2d5eeeaba3a: Loading layer [==================================================&gt;]   5.88MB/5.88MB</span><br><span class="line">681ff9ab4914: Loading layer [==================================================&gt;]  301.4MB/301.4MB</span><br><span class="line">0e91662a9cb3: Loading layer [==================================================&gt;]  8.683MB/8.683MB</span><br><span class="line">fdcdfe126cc0: Loading layer [==================================================&gt;]  13.63MB/13.63MB</span><br><span class="line">270c883ade5e: Loading layer [==================================================&gt;]  45.31MB/45.31MB</span><br><span class="line">06e19b7687c5: Loading layer [==================================================&gt;]  14.54MB/14.54MB</span><br><span class="line">def3433d213c: Loading layer [==================================================&gt;]  4.566MB/4.566MB</span><br><span class="line">5b6adb9801a8: Loading layer [==================================================&gt;]  869.9kB/869.9kB</span><br><span class="line">765e2d110fbc: Loading layer [==================================================&gt;]  1.831MB/1.831MB</span><br><span class="line">eead121d6964: Loading layer [==================================================&gt;]  7.168kB/7.168kB</span><br><span class="line">400127227d7a: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">2b4f749a4a39: Loading layer [==================================================&gt;]  6.571MB/6.571MB</span><br><span class="line">Loaded image: netshoot:latest</span><br><span class="line">$ docker load -i netshoot#latest </span><br><span class="line">Loaded image: netshoot:latest</span><br></pre></td></tr></table></figure><p>åªæœ‰é•œåƒå­˜åœ¨çš„æƒ…å†µä¸‹åªæ˜¾ç¤ºä¸€ä¸ª <code>Loaded image</code>ï¼Œå›çœ‹ä¹‹å‰æˆ‘ä»¬ rmi å load å°±æ˜¯æ²¡æœ‰å±‚æ˜¾ç¤ºã€‚çœ‹äº†ä¸‹ä»£ç æš‚æ—¶æ²¡çœ‹å‡ºæ€ä¹ˆåˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨çš„ï¼Œç„¶åæŠŠ overlay2 ç›®å½•åˆ äº†æš‚æ—¶è§£å†³çš„ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•ä¸€æ¬¡ 18.09.03 docker daemon å­˜å‚¨çš„å±‚æŸåæ— æ³•ä¿®å¤çš„è¿‡ç¨‹ï¼Œè™½ç„¶ä¸ä¼˜é›…ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°æ›´å¥½çš„è§£å†³åŠæ³•ï¼Œæš‚æ—¶è®°å½•ä»…ä¾›å‚è€ƒã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨ docker buildx é™æ€ç¼–è¯‘ nginx</title>
    <link href="http://zhangguanzhang.github.io/2022/01/26/nginx-static-build/"/>
    <id>http://zhangguanzhang.github.io/2022/01/26/nginx-static-build/</id>
    <published>2022-01-26T14:28:30.000Z</published>
    <updated>2022-01-26T14:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å†…éƒ¨æœ‰éœ€æ±‚éœ€è¦é™æ€ç¼–è¯‘ nginxï¼Œå°è¯•äº†ä¸‹ï¼Œæå‡ºæ¥äº†ã€‚å…ˆæ˜¯æŒ‰ç…§å®˜æ–¹ nginx Dockerfile çš„é€»è¾‘èµ°ä¸é€šï¼Œåé¢ä¸‹è½½ nginx å®˜æ–¹æºç ç¼–è¯‘æ‰è¡Œã€‚</p><h3 id="buildx-ä½¿ç”¨"><a href="#buildx-ä½¿ç”¨" class="headerlink" title="buildx ä½¿ç”¨"></a>buildx ä½¿ç”¨</h3><p>è§æ–‡ç«  <a href="https://github.com/zhangguanzhang/docker-need-to-know/blob/master/2.docker-image/dockerfile/buildx.md">buildx ä½¿ç”¨</a></p><h3 id="nginx-Dockerfile"><a href="#nginx-Dockerfile" class="headerlink" title="nginx Dockerfile"></a>nginx Dockerfile</h3><p>å…ˆè¯´ä¸‹å®˜æ–¹çš„å¤±è´¥å°è¯•ã€‚å…ˆ clone é¡¹ç›®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/nginxinc/docker-nginx.git</span><br><span class="line"><span class="built_in">cd</span> docker-nginx</span><br></pre></td></tr></table></figure><p>åˆ†ä¸º <code>stable</code> å’Œ <code>mainline</code>ã€‚å¤§æ¦‚ç ”ç©¶äº†ä¸‹ï¼Œå‘ç° <code>case &quot;$apkArch&quot; in x86_64|aarch64)</code> çš„æƒ…å†µæ˜¯åˆ©ç”¨åŒ…ç®¡ç†ç›´æ¥å®‰è£…çš„ï¼Œå…¶ä»–çš„æ¶æ„æ‰æ˜¯æºç ç¼–è¯‘å®‰è£…ã€‚æ”¹äº†ä¸‹è¿™ä¸ª case ï¼Œå…ˆç”¨ arm64 çš„è¯•ä¸‹èµ°æºç ç¼–è¯‘ã€‚ç„¶åçœ‹ä¸‹é€»è¾‘æ˜¯ä¸‹è½½æºç è¿›å» <code>make all</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -f -O https://hg.nginx.org/pkg-oss/archive/$&#123;NGINX_VERSION&#125;-$&#123;PKG_RELEASE&#125;.tar.gz</span><br><span class="line">tar xzvf $&#123;NGINX_VERSION&#125;-$&#123;PKG_RELEASE&#125;.tar.gz</span><br><span class="line">&amp;&amp; cd pkg-oss-$&#123;NGINX_VERSION&#125;-$&#123;PKG_RELEASE&#125; \</span><br><span class="line">&amp;&amp; cd alpine \</span><br><span class="line">&amp;&amp; make all </span><br></pre></td></tr></table></figure><p>è€Œæºç é‡Œ <code>Makefile</code> çš„å‰é¢å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ifeq ($(MODULE_TARGET), plus)</span><br><span class="line">APKBUILD_TEMPLATE=APKBUILD-plus-module.in</span><br><span class="line">MODULE_SUFFIX=-plus</span><br><span class="line">MODULE_SUMMARY_PREFIX=NGINX Plus</span><br><span class="line">TARGET_VERSION=$(PLUS_VERSION)</span><br><span class="line">MODULE_PACKAGE_PREFIX=nginx-plus-module</span><br><span class="line">else</span><br><span class="line">APKBUILD_TEMPLATE=APKBUILD-module.in</span><br><span class="line">MODULE_SUMMARY_PREFIX=nginx</span><br><span class="line">TARGET_VERSION=$(BASE_VERSION)</span><br><span class="line">MODULE_PACKAGE_PREFIX=nginx-module</span><br><span class="line">endif</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸æ˜¯æ„å»º <code>nginx-plus</code> æ‰€ä»¥æˆ‘ä»¬çœ‹ <code>cat APKBUILD-module.in</code> é‡Œæ‰¾åˆ°äº†ä¸‹é¢çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">build() &#123;</span><br><span class="line">cd &quot;$builddir&quot;</span><br><span class="line"></span><br><span class="line">_nproc=`getconf _NPROCESSORS_ONLN`</span><br><span class="line">if [ $_nproc -gt 1 ]; then</span><br><span class="line">_make_opts=&quot;-j$_nproc&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">%%MODULE_PREBUILD%%</span><br><span class="line"></span><br><span class="line">cd &quot;$builddir&quot;</span><br><span class="line"></span><br><span class="line">CFLAGS= %%MODULE_ENV%% ./configure %%BASE_CONFIGURE_ARGS%% %%MODULE_CONFIGURE_ARGS%% --with-cc-opt=&quot;$CFLAGS %%MODULE_CC_OPT_DEBUG%%&quot; --with-ld-opt=&quot;$LDFLAGS %%MODULE_LD_OPT_DEBUG%%&quot; --with-debug</span><br><span class="line">make $_make_opts modules</span><br><span class="line">for so in `find objs/ -maxdepth 1 -type f -name &quot;*.so&quot;`; do \</span><br><span class="line">debugso=`echo $&#123;so&#125; | sed -e &#x27;s|\.so$|-debug.so|&#x27;` ; \</span><br><span class="line">mv $&#123;so&#125; $&#123;debugso&#125; ; \</span><br><span class="line">        done</span><br><span class="line">CFLAGS= %%MODULE_ENV%% ./configure %%BASE_CONFIGURE_ARGS%% %%MODULE_CONFIGURE_ARGS%% --with-cc-opt=&quot;$CFLAGS %%MODULE_CC_OPT%%&quot; --with-ld-opt=&quot;$LDFLAGS %%MODULE_LD_OPT%%&quot;</span><br><span class="line">make $_make_opts modules</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>CFLAGS</code> å’Œ <code>LDFLAGS</code> æ˜¯æ”¯æŒç¯å¢ƒå˜é‡ä¼ å…¥çš„ï¼Œæ‰€ä»¥æ”¹ä¸‹ Dockerfile åŠ å…¥ä¸‹é¢çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ARG CFLAGS</span><br><span class="line">ARG LDFLAGS</span><br></pre></td></tr></table></figure><p>ç„¶åå¼€å§‹æ„å»ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker buildx build -t zhangguanzhang/nginx:arm64-static . \</span><br><span class="line">    --platform linux/arm64 \</span><br><span class="line">    --build-arg=&quot;CFLAGS=&#x27;-static -s&#x27;&quot; --build-arg=LDFLAGS=-static</span><br></pre></td></tr></table></figure><p>ç„¶åå¤±è´¥ï¼ŒæŠ¥é”™ <code>./configure: error: the invalid value in --with-ld-opt=&quot;-static&quot;</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#6 481.1 &gt;&gt;&gt; nginx: Unpacking /tmp/tmp.OciAKf/pkg-oss-1.21.5-1/alpine/abuild-base/nginx-1.21.5.tar.gz...</span><br><span class="line">#6 482.9 checking for OS</span><br><span class="line">#6 482.9  + Linux 5.4.0-91-generic aarch64</span><br><span class="line">#6 482.9 checking for C compiler ... found</span><br><span class="line">#6 483.6  + using GNU C compiler</span><br><span class="line">#6 483.7  + gcc version: 10.3.1 20211027 (Alpine 10.3.1_git20211027) </span><br><span class="line">#6 483.7 checking for gcc -pipe switch ... found</span><br><span class="line">#6 484.3 checking for --with-ld-opt=&quot;-static&quot; ... not found</span><br><span class="line">#6 484.3 ./configure: error: the invalid value in --with-ld-opt=&quot;-static&quot;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ Dockerfile é‡Œ apk add åŠ äº† <code>glibc-static</code> è¿˜æ˜¯ä¸€æ ·æŠ¥é”™ã€‚ç„¶åå°è¯•ä¸‹å®˜æ–¹çš„</p><h3 id="è‡ªå·±ç¼–è¯‘"><a href="#è‡ªå·±ç¼–è¯‘" class="headerlink" title="è‡ªå·±ç¼–è¯‘"></a>è‡ªå·±ç¼–è¯‘</h3><h4 id="æ‰‹åŠ¨æ­¥éª¤"><a href="#æ‰‹åŠ¨æ­¥éª¤" class="headerlink" title="æ‰‹åŠ¨æ­¥éª¤"></a>æ‰‹åŠ¨æ­¥éª¤</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -ti --name t1 test alpine</span><br></pre></td></tr></table></figure><p>å‰ç½®ä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">if [ -f /etc/apk/repositories ];then sed -i &#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27; /etc/apk/repositories; fi &amp;&amp; \</span><br><span class="line">    if [ -f /etc/apt/sources.list ];then sed -ri &#x27;s/(deb|security).debian.org/mirrors.aliyun.com/g&#x27; /etc/apt/sources.list; fi &amp;&amp; \</span><br><span class="line">    if [ ! -e /etc/nsswitch.conf ];then echo &#x27;hosts: files dns myhostname&#x27; &gt; /etc/nsswitch.conf; fi</span><br><span class="line"></span><br><span class="line">apk add --no-cache --virtual .build-deps \</span><br><span class="line">                gcc \</span><br><span class="line">                libc-dev \</span><br><span class="line">                make \</span><br><span class="line">                openssl-dev \</span><br><span class="line">                pcre2-dev \</span><br><span class="line">                zlib-dev \</span><br><span class="line">              openssl-libs-static zlib-static  \</span><br><span class="line">                linux-headers \</span><br><span class="line">                libxslt-dev \</span><br><span class="line">                gd-dev \</span><br><span class="line">                geoip-dev \</span><br><span class="line">                perl-dev \</span><br><span class="line">                libedit-dev \</span><br><span class="line">                bash \</span><br><span class="line">                alpine-sdk \</span><br><span class="line">                findutils</span><br><span class="line">bash</span><br></pre></td></tr></table></figure><p>ä¸‹è½½æºç åŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://nginx.org/download/nginx-1.21.6.tar.gz</span><br><span class="line">tar zxf nginx-1.21.6.tar.gz</span><br><span class="line">cd nginx-1.21.6</span><br></pre></td></tr></table></figure><p>æ‰¾ä¸‹å®˜æ–¹çš„ç¼–è¯‘å‚æ•°ï¼Œä¸‹é¢æ˜¯æˆ‘ arm64 ä¸Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm --entrypoint nginx nginx:alpine-perl -V</span><br><span class="line">nginx version: nginx/1.21.6</span><br><span class="line">built by gcc 10.3.1 20211027 (Alpine 10.3.1_git20211027) </span><br><span class="line">built with OpenSSL 1.1.1l  24 Aug 2021</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --with-perl_modules_path=/usr/lib/perl5/vendor_perl --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&#x27;-Os -fomit-frame-pointer -g&#x27; --with-ld-opt=-Wl,--as-needed,-O1,--sort-common</span><br><span class="line">$ docker run --rm --entrypoint nginx nginx:alpine-perl -V |&amp; grep -Po -- &quot;--[a-z_-]+(=(&#x27;[^&#x27;]+&#x27;|\S+))?&quot;</span><br><span class="line">--prefix=/etc/nginx</span><br><span class="line">--sbin-path=/usr/sbin/nginx</span><br><span class="line">--modules-path=/usr/lib/nginx/modules</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf</span><br><span class="line">--error-log-path=/var/log/nginx/error.log</span><br><span class="line">--http-log-path=/var/log/nginx/access.log</span><br><span class="line">--pid-path=/var/run/nginx.pid</span><br><span class="line">--lock-path=/var/run/nginx.lock</span><br><span class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp</span><br><span class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp</span><br><span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp</span><br><span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp</span><br><span class="line">--with-perl_modules_path=/usr/lib/perl5/vendor_perl</span><br><span class="line">--user=nginx</span><br><span class="line">--group=nginx</span><br><span class="line">--with-compat</span><br><span class="line">--with-file-aio</span><br><span class="line">--with-threads</span><br><span class="line">--with-http_addition_module</span><br><span class="line">--with-http_auth_request_module</span><br><span class="line">--with-http_dav_module</span><br><span class="line">--with-http_flv_module</span><br><span class="line">--with-http_gunzip_module</span><br><span class="line">--with-http_gzip_static_module</span><br><span class="line">--with-http_mp</span><br><span class="line">--with-http_random_index_module</span><br><span class="line">--with-http_realip_module</span><br><span class="line">--with-http_secure_link_module</span><br><span class="line">--with-http_slice_module</span><br><span class="line">--with-http_ssl_module</span><br><span class="line">--with-http_stub_status_module</span><br><span class="line">--with-http_sub_module</span><br><span class="line">--with-http_v</span><br><span class="line">--with-mail</span><br><span class="line">--with-mail_ssl_module</span><br><span class="line">--with-stream</span><br><span class="line">--with-stream_realip_module</span><br><span class="line">--with-stream_ssl_module</span><br><span class="line">--with-stream_ssl_preread_module</span><br><span class="line">--with-cc-opt=&#x27;-Os -fomit-frame-pointer -g&#x27;</span><br><span class="line">--with-ld-opt=-Wl,--as-needed,-O1,--sort-common</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>with-http_mp</code> å’Œ <code>with-http_v</code> ä¼¼ä¹å¯¹åº” <code>--with-http_mp4_module</code> å’Œ <code>--with-http_v2_module</code>ï¼Œæ›´å¤šç¼–è¯‘å‚æ•°å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="http://nginx.org/en/docs/configure.html">nginx-configure</a><br>æ”¹ä¸‹ <code>--with-cc-opt</code> å’Œ <code>--with-ld-opt</code> åç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">  --prefix=/etc/nginx \</span><br><span class="line">  --sbin-path=/usr/sbin/nginx \</span><br><span class="line">  --modules-path=/usr/lib/nginx/modules \</span><br><span class="line">  --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">  --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">  --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">  --pid-path=/var/run/nginx.pid \</span><br><span class="line">  --lock-path=/var/run/nginx.lock \</span><br><span class="line">  --http-client-body-temp-path=/var/cache/nginx/client_temp \</span><br><span class="line">  --http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span><br><span class="line">  --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span><br><span class="line">  --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line">  --http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">  --with-perl_modules_path=/usr/lib/perl5/vendor_perl \</span><br><span class="line">  --user=nginx \</span><br><span class="line">  --group=nginx \</span><br><span class="line">  --with-compat \</span><br><span class="line">  --with-file-aio \</span><br><span class="line">  --with-threads \</span><br><span class="line">  --with-http_addition_module \</span><br><span class="line">  --with-http_auth_request_module \</span><br><span class="line">  --with-http_dav_module \</span><br><span class="line">  --with-http_flv_module \</span><br><span class="line">  --with-http_gunzip_module \</span><br><span class="line">  --with-http_gzip_static_module \</span><br><span class="line">  --with-http_mp4_module \</span><br><span class="line">  --with-http_random_index_module \</span><br><span class="line">  --with-http_realip_module \</span><br><span class="line">  --with-http_secure_link_module \</span><br><span class="line">  --with-http_slice_module \</span><br><span class="line">  --with-http_ssl_module \</span><br><span class="line">  --with-http_stub_status_module \</span><br><span class="line">  --with-http_sub_module \</span><br><span class="line">  --with-http_v2_module \</span><br><span class="line">  --with-mail \</span><br><span class="line">  --with-mail_ssl_module \</span><br><span class="line">  --with-stream \</span><br><span class="line">  --with-stream_realip_module \</span><br><span class="line">  --with-stream_ssl_module \</span><br><span class="line">  --with-stream_ssl_preread_module \</span><br><span class="line">  --with-cc-opt=<span class="string">&#x27;-static -s&#x27;</span> \</span><br><span class="line">  --with-ld-opt=-static</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">make install</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Dockerfile-æ„å»º"><a href="#Dockerfile-æ„å»º" class="headerlink" title="Dockerfile æ„å»º"></a>Dockerfile æ„å»º</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine AS build</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> NGINX_VERSION=<span class="number">1.21</span>.<span class="number">6</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="keyword">if</span> [ -f /etc/apk/repositories ];<span class="keyword">then</span> sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ -f /etc/apt/sources.list ];<span class="keyword">then</span> sed -ri <span class="string">&#x27;s/(deb|security).debian.org/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ ! -e /etc/nsswitch.conf ];<span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&#x27;hosts: files dns myhostname&#x27;</span> &gt; /etc/nsswitch.conf; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apk add --no-cache --virtual .build-deps \</span></span><br><span class="line"><span class="language-bash">                gcc \</span></span><br><span class="line"><span class="language-bash">                libc-dev \</span></span><br><span class="line"><span class="language-bash">                make \</span></span><br><span class="line"><span class="language-bash">                openssl-dev \</span></span><br><span class="line"><span class="language-bash">                pcre2-dev \</span></span><br><span class="line"><span class="language-bash">                zlib-dev \</span></span><br><span class="line"><span class="language-bash">              openssl-libs-static zlib-static  \</span></span><br><span class="line"><span class="language-bash">                linux-headers \</span></span><br><span class="line"><span class="language-bash">                libxslt-dev \</span></span><br><span class="line"><span class="language-bash">                gd-dev \</span></span><br><span class="line"><span class="language-bash">                geoip-dev \</span></span><br><span class="line"><span class="language-bash">                perl-dev \</span></span><br><span class="line"><span class="language-bash">                libedit-dev \</span></span><br><span class="line"><span class="language-bash">                bash \</span></span><br><span class="line"><span class="language-bash">                alpine-sdk \</span></span><br><span class="line"><span class="language-bash">                findutils &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget http://nginx.org/download/nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar.gz &amp;&amp; tar zxf nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    ./configure \</span></span><br><span class="line"><span class="language-bash">    --prefix=/etc/nginx \</span></span><br><span class="line"><span class="language-bash">    --sbin-path=/usr/sbin/nginx \</span></span><br><span class="line"><span class="language-bash">    --modules-path=/usr/lib/nginx/modules \</span></span><br><span class="line"><span class="language-bash">    --conf-path=/etc/nginx/nginx.conf \</span></span><br><span class="line"><span class="language-bash">    --error-log-path=/var/log/nginx/error.log \</span></span><br><span class="line"><span class="language-bash">    --http-log-path=/var/log/nginx/access.log \</span></span><br><span class="line"><span class="language-bash">    --pid-path=/var/run/nginx.pid \</span></span><br><span class="line"><span class="language-bash">    --lock-path=/var/run/nginx.lock \</span></span><br><span class="line"><span class="language-bash">    --http-client-body-temp-path=/var/cache/nginx/client_temp \</span></span><br><span class="line"><span class="language-bash">    --http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span></span><br><span class="line"><span class="language-bash">    --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span></span><br><span class="line"><span class="language-bash">    --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span></span><br><span class="line"><span class="language-bash">    --http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span></span><br><span class="line"><span class="language-bash">    --with-perl_modules_path=/usr/lib/perl5/vendor_perl \</span></span><br><span class="line"><span class="language-bash">    --user=nginx \</span></span><br><span class="line"><span class="language-bash">    --group=nginx \</span></span><br><span class="line"><span class="language-bash">    --with-compat \</span></span><br><span class="line"><span class="language-bash">    --with-file-aio \</span></span><br><span class="line"><span class="language-bash">    --with-threads \</span></span><br><span class="line"><span class="language-bash">    --with-http_addition_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_auth_request_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_dav_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_flv_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_gunzip_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_gzip_static_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_mp4_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_random_index_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_realip_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_secure_link_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_slice_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_ssl_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_stub_status_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_sub_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_v2_module \</span></span><br><span class="line"><span class="language-bash">    --with-mail \</span></span><br><span class="line"><span class="language-bash">    --with-mail_ssl_module \</span></span><br><span class="line"><span class="language-bash">    --with-stream \</span></span><br><span class="line"><span class="language-bash">    --with-stream_realip_module \</span></span><br><span class="line"><span class="language-bash">    --with-stream_ssl_module \</span></span><br><span class="line"><span class="language-bash">    --with-stream_ssl_preread_module \</span></span><br><span class="line"><span class="language-bash">    --with-cc-opt=<span class="string">&#x27;-static -s&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    --with-ld-opt=-static &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make install &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> `<span class="built_in">which</span> nginx` /nginx-$(<span class="built_in">cat</span> /etc/apk/arch)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch AS bin</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /nginx-* /</span></span><br></pre></td></tr></table></figure><p>æ„å»º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker buildx build  . --platform linux/amd64,linux/arm64 \</span><br><span class="line">    --target bin --output . \</span><br><span class="line">    --build-arg=NGINX_VERSION=1.21.6</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># ll                          </span><br><span class="line">total 4                                    </span><br><span class="line">drwxr-xr-x 4 root root   62 Jan 26 16:21 ./             </span><br><span class="line">drwxr-xr-x 6 root root   98 Jan 26 15:31 ../   </span><br><span class="line">-rw-r--r-- 1 root root 2718 Jan 26 16:05 Dockerfile </span><br><span class="line">drwxr-xr-x 2 root root   26 Jan 26 16:21 linux_amd64/                                          </span><br><span class="line">drwxr-xr-x 2 root root   27 Jan 26 16:21 linux_arm64/ </span><br><span class="line"># ll linux_a*</span><br><span class="line">linux_amd64:</span><br><span class="line">total 20424</span><br><span class="line">drwxr-xr-x 2 root root       26 Jan 26 16:21 ./</span><br><span class="line">drwxr-xr-x 4 root root       62 Jan 26 16:21 ../</span><br><span class="line">-rwxr-xr-x 1 root root 20910696 Jan 26 16:12 nginx-x86_64*</span><br><span class="line"></span><br><span class="line">linux_arm64:</span><br><span class="line">total 20444</span><br><span class="line">drwxr-xr-x 2 root root       27 Jan 26 16:21 ./</span><br><span class="line">drwxr-xr-x 4 root root       62 Jan 26 16:21 ../</span><br><span class="line">-rwxr-xr-x 1 root root 20932656 Jan 26 16:21 nginx-aarch64*</span><br><span class="line"># ./linux_amd64/nginx-x86_64 -V</span><br><span class="line">nginx version: nginx/1.21.6</span><br><span class="line">built by gcc 10.3.1 20211027 (Alpine 10.3.1_git20211027) </span><br><span class="line">built with OpenSSL 1.1.1l  24 Aug 2021</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --with-perl_modules_path=/usr/lib/perl5/vendor_perl --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&#x27;-static -s&#x27; --with-ld-opt=-static</span><br><span class="line"># file ./linux_amd64/nginx-x86_64 </span><br><span class="line">./linux_amd64/nginx-x86_64: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, with debug_info, not stripped</span><br><span class="line"># file ./linux_arm64/nginx-aarch64 </span><br><span class="line">./linux_arm64/nginx-aarch64: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), statically linked, with debug_info, not stripped</span><br></pre></td></tr></table></figure><p>ç¬¦å·é“¾æ¥å¯ä»¥ <code>strip -s $(which nginx)</code> å»æ‰å‡å°‘å¤§å°ã€‚</p><h4 id="å¯¹æ¥åˆ°çœŸå®åœºæ™¯"><a href="#å¯¹æ¥åˆ°çœŸå®åœºæ™¯" class="headerlink" title="å¯¹æ¥åˆ°çœŸå®åœºæ™¯"></a>å¯¹æ¥åˆ°çœŸå®åœºæ™¯</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:alpine AS conf</span><br><span class="line"><span class="keyword">FROM</span> alpine AS build</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> NGINX_VERSION=<span class="number">1.21</span>.<span class="number">6</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="keyword">if</span> [ -f /etc/apk/repositories ];<span class="keyword">then</span> sed -i <span class="string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ -f /etc/apt/sources.list ];<span class="keyword">then</span> sed -ri <span class="string">&#x27;s/(deb|security).debian.org/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ ! -e /etc/nsswitch.conf ];<span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&#x27;hosts: files dns myhostname&#x27;</span> &gt; /etc/nsswitch.conf; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apk add --no-cache --virtual .build-deps \</span></span><br><span class="line"><span class="language-bash">                gcc \</span></span><br><span class="line"><span class="language-bash">                libc-dev \</span></span><br><span class="line"><span class="language-bash">                make \</span></span><br><span class="line"><span class="language-bash">                openssl-dev \</span></span><br><span class="line"><span class="language-bash">                pcre2-dev \</span></span><br><span class="line"><span class="language-bash">                zlib-dev \</span></span><br><span class="line"><span class="language-bash">              openssl-libs-static zlib-static  \</span></span><br><span class="line"><span class="language-bash">                linux-headers \</span></span><br><span class="line"><span class="language-bash">                libxslt-dev \</span></span><br><span class="line"><span class="language-bash">                gd-dev \</span></span><br><span class="line"><span class="language-bash">                geoip-dev \</span></span><br><span class="line"><span class="language-bash">                perl-dev \</span></span><br><span class="line"><span class="language-bash">                libedit-dev \</span></span><br><span class="line"><span class="language-bash">                bash \</span></span><br><span class="line"><span class="language-bash">                alpine-sdk \</span></span><br><span class="line"><span class="language-bash">                findutils &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    wget http://nginx.org/download/nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar.gz &amp;&amp; tar zxf nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    ./configure \</span></span><br><span class="line"><span class="language-bash">    --prefix=/etc/nginx \</span></span><br><span class="line"><span class="language-bash">    --sbin-path=/usr/sbin/nginx \</span></span><br><span class="line"><span class="language-bash">    --modules-path=/usr/lib/nginx/modules \</span></span><br><span class="line"><span class="language-bash">    --conf-path=/etc/nginx/nginx.conf \</span></span><br><span class="line"><span class="language-bash">    --error-log-path=/var/log/nginx/error.log \</span></span><br><span class="line"><span class="language-bash">    --http-log-path=/var/log/nginx/access.log \</span></span><br><span class="line"><span class="language-bash">    --pid-path=/var/run/nginx.pid \</span></span><br><span class="line"><span class="language-bash">    --lock-path=/var/run/nginx.lock \</span></span><br><span class="line"><span class="language-bash">    --http-client-body-temp-path=/var/cache/nginx/client_temp \</span></span><br><span class="line"><span class="language-bash">    --http-proxy-temp-path=/var/cache/nginx/proxy_temp \</span></span><br><span class="line"><span class="language-bash">    --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</span></span><br><span class="line"><span class="language-bash">    --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span></span><br><span class="line"><span class="language-bash">    --http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span></span><br><span class="line"><span class="language-bash">    --with-perl_modules_path=/usr/lib/perl5/vendor_perl \</span></span><br><span class="line"><span class="language-bash">    --user=nginx \</span></span><br><span class="line"><span class="language-bash">    --group=nginx \</span></span><br><span class="line"><span class="language-bash">    --with-compat \</span></span><br><span class="line"><span class="language-bash">    --with-file-aio \</span></span><br><span class="line"><span class="language-bash">    --with-threads \</span></span><br><span class="line"><span class="language-bash">    --with-http_addition_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_auth_request_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_dav_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_flv_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_gunzip_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_gzip_static_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_mp4_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_random_index_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_realip_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_secure_link_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_slice_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_ssl_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_stub_status_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_sub_module \</span></span><br><span class="line"><span class="language-bash">    --with-http_v2_module \</span></span><br><span class="line"><span class="language-bash">    --with-mail \</span></span><br><span class="line"><span class="language-bash">    --with-mail_ssl_module \</span></span><br><span class="line"><span class="language-bash">    --with-stream \</span></span><br><span class="line"><span class="language-bash">    --with-stream_realip_module \</span></span><br><span class="line"><span class="language-bash">    --with-stream_ssl_module \</span></span><br><span class="line"><span class="language-bash">    --with-stream_ssl_preread_module \</span></span><br><span class="line"><span class="language-bash">    --with-cc-opt=<span class="string">&#x27;-static -s&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    --with-ld-opt=-static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> /install_root &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make DESTDIR=/install_root install &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -f /install_root/etc/nginx/*.default &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rmdir</span> /install_root/var/run ; <span class="literal">true</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /install_root/var/cache/nginx/ \</span></span><br><span class="line"><span class="language-bash">      /install_root/usr/lib/nginx/modules \</span></span><br><span class="line"><span class="language-bash">      /install_root/etc/nginx/conf.d \</span></span><br><span class="line"><span class="language-bash">      /install_root/usr/share/nginx &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> /install_root/etc/nginx/html /install_root/usr/share/nginx/ &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">ln</span> -sf /dev/stdout /install_root/var/log/nginx/access.log &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">ln</span> -sf /dev/stderr /install_root/var/log/nginx/error.log </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=conf /etc/nginx/nginx.conf /install_root/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=conf /etc/nginx/conf.d /install_root/etc/nginx/conf.d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash">  find /install_root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /install_root /</span></span><br><span class="line"><span class="comment"># alpine create nginx user/group </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> addgroup -g 101 -S nginx &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    adduser -S -D -H -u 101 -h /var/cache/nginx -s /sbin/nologin -G nginx -g nginx nginx &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ ! -e /etc/nsswitch.conf ];<span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&#x27;hosts: files dns myhostname&#x27;</span> &gt;&gt; /etc/nsswitch.conf; <span class="keyword">fi</span></span></span><br><span class="line"><span class="comment"># debian create nginx user/group </span></span><br><span class="line"><span class="comment"># RUN addgroup --system --gid 101 nginx &amp;&amp; \</span></span><br><span class="line"><span class="comment">#     adduser --system --disabled-login --ingroup nginx --no-create-home --home /nonexistent --gecos &quot;nginx user&quot; --shell /bin/false --uid 101 nginx  &amp;&amp; \</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ³¨æ„ <code>worker_processes  auto;</code> åœ¨é«˜æ ¸å¿ƒ cpu ä¸Šä¼šéå¸¸åƒé…ç½®å’Œæµªè´¹é…ç½®ï¼Œç‰¹åˆ«æ˜¯ arm64 çš„å›½äº§æœåŠ¡å™¨ä¸Šï¼Œéœ€è¦æ”¹æˆå›ºå®šçš„æ•°å­—ã€‚</p><h3 id="åç»­ä¸€äº›é¢å¤–æ¨¡å—æµ‹è¯•"><a href="#åç»­ä¸€äº›é¢å¤–æ¨¡å—æµ‹è¯•" class="headerlink" title="åç»­ä¸€äº›é¢å¤–æ¨¡å—æµ‹è¯•"></a>åç»­ä¸€äº›é¢å¤–æ¨¡å—æµ‹è¯•</h3><p>vts æ¨¡å—éªŒè¯ä¸å½±å“é™æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    wget https://github.com/vozlt/nginx-module-vts/archive/refs/tags/v0.1.18.tar.gz &amp;&amp; \</span><br><span class="line">    tar zxf v0.1.18.tar.gz -C /tmp/ &amp;&amp; \</span><br><span class="line">    rm -rf v0.1.18.tar.gz</span><br><span class="line"></span><br><span class="line">RUN cd nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \</span><br><span class="line">    ...</span><br><span class="line">    --add-module=/tmp/nginx-module-vts-0.1.18 \</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.v2ex.com/t/757913">https://www.v2ex.com/t/757913</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;å†…éƒ¨æœ‰éœ€æ±‚éœ€è¦é™æ€ç¼–è¯‘ nginxï¼Œå°è¯•äº†ä¸‹ï¼Œæå‡ºæ¥äº†ã€‚å…ˆæ˜¯æŒ‰ç…§å®˜æ–¹ nginx Dockerfile çš„é€»è¾‘èµ°ä¸é€šï¼Œåé¢ä¸‹è½½ nginx </summary>
      
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="nginx" scheme="http://zhangguanzhang.github.io/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>EmuELEC ç¬”è®°</title>
    <link href="http://zhangguanzhang.github.io/2022/01/22/EmuELEC/"/>
    <id>http://zhangguanzhang.github.io/2022/01/22/EmuELEC/</id>
    <published>2022-01-22T14:28:30.000Z</published>
    <updated>2022-01-22T14:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="EmuELEC-ç¬”è®°"><a href="#EmuELEC-ç¬”è®°" class="headerlink" title="EmuELEC ç¬”è®°"></a>EmuELEC ç¬”è®°</h1><p>åç»­å…³äº EmuELEC çš„ç¬”è®°å’ŒçŸ¥è¯†ç‚¹éƒ½ä¼šåœ¨è¿™é‡Œæ›´æ–°ï¼Œå‡å®šçœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„äººéƒ½å…·å¤‡ä¸€äº› Linux åŸºç¡€ï¼Œå‘½ä»¤ï¼Œpathï¼Œåˆ†åŒºï¼ŒæŒ‚è½½ä¹‹ç±»çš„çŸ¥è¯†ã€‚</p><h2 id="EmuELEC-ä»‹ç»"><a href="#EmuELEC-ä»‹ç»" class="headerlink" title="EmuELEC ä»‹ç»"></a>EmuELEC ä»‹ç»</h2><p>EmuELEC æ˜¯ä¸“ä¸º Amlogicï¼ˆæ™¶æ™¨ï¼‰S905&#x2F;S912 æ–¹æ¡ˆçš„ç›’å­å¼€å‘çš„æ¸¸æˆç³»ç»Ÿï¼Œå®ƒåŸºäº CoreELEC ç³»ç»Ÿï¼Œåœ¨ CoreELEC çš„åŸºç¡€ä¸Šç§»æ¤äº† RetroArch å’Œä¼—å¤šçš„ç‹¬ç«‹æ¨¡æ‹Ÿå™¨ã€‚EmuELEC å‰èº«ä¸º Sx05REã€‚Sx05RE æ•´åˆäº† Lakkaã€KODIã€EmulationStationï¼Œå¸¸è¢«äººç®€ç§°ä¸ºä¸‰åˆä¸€ã€‚å®ƒå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª Linux ç³»ç»Ÿï¼Œæœ€æ–°ç‰ˆæœ¬å¼€å§‹åªæ”¯æŒ arm64 æ¶æ„äº†ã€‚</p><p>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ä¾¿å®œçš„ç”µè§†ç›’å­ï¼ˆåŸºæœ¬9æˆéƒ½æ˜¯æ™¶æ™¨çš„ cpuï¼‰æ¥åˆ· EmuELEC ç³»ç»Ÿï¼Œç„¶åé…åˆæ‰‹æŸ„ï¼ˆxboxåè®®ï¼Œpsã€pspå’Œ30å—é’±å·¦å³çš„æ— çº¿æ‰‹æŸ„ï¼‰èƒ½ç©å¾ˆå¤šå¹³å°çš„æ¸¸æˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3do    atari2600 atarilynx    coleco  downloadsgameandwatch  gbah     genh      megadrive        n64     nesopenbor     pcfx      pspminis  screenshots  sg-1000 solarus  uzebox      wonderswan</span><br><span class="line">amiga    atari5200 atarist     c128    cps1    dreamcastgamegear      gbc      gw      megadrive-japan  naomi   neshpc    pico-8    psx  scummvm      sgfx splash   vectrex     wonderswancolor</span><br><span class="line">amigacd32   atari7800 atomiswave  c16     cps2    famicomgamegearh     gbch     intellivision  mplayer       nds     ngppc98    pokemini  saturn  sega32x      snes tg16  vic20       x68000</span><br><span class="line">amstradcpc  atari800 bezels      c64     cps3    fbneogb      gbh      mame      msx       neocd   ngpcpcengine    ports     savestates  segacd       snesh tg16cd   videopac    zx81</span><br><span class="line">arcade    atarijaguar  BGM     capcom  daphne  fdsgba      genesis  mastersystem   msx2       neogeo  odysseypcenginecd  psp       sc-3000  sfc       snesmsu1  tic-80   virtualboy  zxspectrum</span><br></pre></td></tr></table></figure><p>arcadeã€mameã€neogeo capcomï¼ˆè¿™å››ä¸ªæ˜¯è¡—æœºï¼‰ã€nesã€ndsã€gbaã€psã€pspã€fcã€sfcã€å¾ˆå¤šå¹³å°çš„æ¸¸æˆã€‚æˆ‘ä¸ªäººæ˜¯ä½¿ç”¨ N1 ç›’å­ï¼Œä½†æ˜¯ä¸æ¨èï¼Œå¾ˆå¤šé‚£ç§å®½å¸¦é€çš„ç”µè§†ç›’å­ä¹Ÿè¡Œï¼Œæ ¹æ®ç°åœ¨çš„è®¯æ¯å»çœ‹å“ªä¸ªåˆé€‚ã€‚å›½å†…çš„è¯èƒ½è®¨è®ºè¿™æ–¹é¢çš„æœ‰ä»¥ä¸‹å‡ ä¸ªå¹³å°ï¼š</p><ul><li><a href="https://www.right.com.cn/forum/forum.php">æ©å±±</a>ï¼Œæ©å±±æ˜¯è½¯è·¯ç”±ä¸ºä¸»ï¼Œæ³¨æ„ç”µè§†ç›’å­æ¿å—å»è®¨è®º</li><li><a href="https://www.emuelec.cn/">EmuELEC ä¸­æ–‡ç½‘</a></li><li><a href="https://tieba.baidu.com/f?kw=emuelec&ie=utf-8">emuelecè´´å§</a>ï¼Œå¦‚æœä½  pc web è´´å§å‘å¸–è®©ä½ ä¸‹ app ç«¯ï¼Œä½ å¯ä»¥ç¼–è¾‘å¥½å†…å®¹å ctrl + å›è½¦ç›´æ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶å‘å¸–</li><li><a href="https://post.smzdm.com/">ä»€ä¹ˆå€¼å¾—ä¹°</a>ï¼Œè¯¥è®ºå›çš„ç”µè§†ç›’å­ç‰ˆå—ä¹Ÿæœ‰äººä¼šè®¨è®ºè¿™ä¸ª</li><li><a href="https://space.bilibili.com/97745521/video">bç«™çš„äººä¸­æ—¥æœˆå¤§ä½¬</a>ï¼Œä»–ä¸€èˆ¬æä¾›äº†æ•´åˆåŒ…ï¼Œä¸šå†…ä¹Ÿæœ‰åæ°”</li></ul><h2 id="åˆ·æœº"><a href="#åˆ·æœº" class="headerlink" title="åˆ·æœº"></a>åˆ·æœº</h2><p>ä¸€èˆ¬æ˜¯ä¸¤ç§:</p><ul><li>ç”µè§†ç›’å­è§£å¯†(å¹¶ä¸æ˜¯æ‰€æœ‰ç›’å­éƒ½èƒ½æŠ˜è…¾è¿™ä¸ª)åï¼Œåœ¨ç›’å­ä¸Šå®‰è£… <code>Reboot to LibreELEC</code> çš„ apk ï¼Œè¿è¡Œå®ƒä»å®‰å“ç”µè§†ç³»ç»Ÿåˆ‡æ¢åˆ° U ç›˜å¯åŠ¨ï¼Œä»è€Œè¿›å…¥åˆ°æ¸¸æˆç³»ç»Ÿã€‚</li><li>ä½ ç›’å­æœ¬èº«æ”¯æŒä» U ç›˜å¯åŠ¨ï¼Œä½  U ç›˜å†™å…¥ EmuELEC çš„ img æ–‡ä»¶åæ’åˆ°ç›’å­ä¸Šå¼€æœºå³å¯ã€‚</li></ul><p>åˆ·æœºè½¯ä»¶æ¨è <a href="https://www.balena.io/etcher/">balenaEtcher</a>ï¼Œå»ºè®®ä¸‹è½½ Portable å…å®‰è£…çš„ç‰ˆæœ¬ã€‚EmuELEC çš„é•œåƒå»æœä½ è®¾å¤‡å…³é”®å­—+EmuELC æ‰¾ã€‚</p><p>åˆæ¬¡æ‰“å¼€éœ€è¦è®¾ç½®æ‰‹æŸ„ï¼Œæ‰‹æŸ„æ˜ å°„å›¾<br><img src="https://raw.githubusercontent.com/zhangguanzhang/Image-Hosting/master/picgo/xbox-set.png"><br><img src="https://raw.githubusercontent.com/zhangguanzhang/Image-Hosting/master/picgo/controller-360.png"></p><h2 id="åˆ†åŒºè®²è§£"><a href="#åˆ†åŒºè®²è§£" class="headerlink" title="åˆ†åŒºè®²è§£"></a>åˆ†åŒºè®²è§£</h2><p>EmuELEC çš„ img åˆ·åˆ°å†…å­˜å¡æˆ–è€… Uç›˜é‡Œåï¼Œwindows ä¼šå¼¹å‡ºçš„è®©ä½ æ˜¯å¦æ ¼å¼åŒ–ï¼Œè®°å¾—ç‚¹å‡»å¦ï¼Œä¸€èˆ¬æ˜¯ä¸¤ä¸ªåˆ†åŒºï¼š</p><ul><li>EMUELEC çš„ FAT32 åˆ†åŒº ï¼Œå†…å­˜æ”¾æœ‰ dtbï¼ˆdevice treeï¼‰çš„åˆ†åŒºï¼Œä¸åŒç”µè§†ç›’å­çš„ dtb æ–‡ä»¶ä¸ä¸€æ ·ï¼Œä¸€èˆ¬åˆæ¬¡éœ€è¦æˆ‘ä»¬è¿›é‡Œé¢çš„ç›®å½• device_trees é‡ŒæŠŠä½ è®¾å¤‡çš„ xxx-dtb.img æ‹·è´åˆ°æ ¹ç›®å½•çš„ <code>dtb.img</code></li><li>ext4 çš„åˆ†åŒºï¼Œ windows æ— æ³•è¯†åˆ«ï¼Œå•ç‹¬å­˜æ”¾æ¸¸æˆ roms çš„åˆ†åŒºã€‚ä¹Ÿæ˜¯ä¸€äº›å¯¹å¤–å¼€æ”¾çš„é…ç½®å¼•å…¥ã€‚å•ç‹¬ä¼šè¢«æŒ‚è½½æˆ <code>/storage</code> ç›®å½•</li><li>EEROMS , 4.0 åå¼€å§‹æ–°å¢çš„çš„åˆ†åŒºï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„ <code>/storage/roms</code> å•ç‹¬æŠ½å‡ºæ¥çš„ä¸€ä¸ªå•ç‹¬åˆ†åŒºï¼Œæ¸¸æˆéƒ½ä¼šå­˜æ”¾åœ¨è¿™é‡Œã€‚</li></ul><p>å‰è€…æ˜¯ç³»ç»Ÿåˆ†åŒºï¼Œä¸€èˆ¬å‡çº§çš„è¯å‡çº§è¿™ä¸ªå°±è¡Œäº†ã€‚æ·»åŠ æ¸¸æˆå•¥çš„å¯ä»¥åœ¨åè€…åˆ†åŒºé‡ŒæŒ‰ç…§å¹³å°æ·»åŠ ï¼Œåè€…åˆ†åŒºå¯ä»¥åœ¨ windows ä¸Šä½¿ç”¨ <a href="https://www.diskgenius.cn/">DiskGenius</a> æ‰“å¼€ã€‚ä¸è¿‡ä½ åˆ·å¥½å¼€æœºä»¥åŠè”ç½‘åï¼Œå…¶å®ä¼šè‡ªå¸¦ä¸€ä¸ª ssh å’Œ sambaã€‚éƒ½å¯ä»¥è¿ä¸Šå»æ“ä½œï¼Œssh ç™»å½•ä¿¡æ¯æ˜¯ <code>root/emuelec</code>ã€‚ å¼€æœºæŒ‚è½½ <code>/storage/roms</code> çš„é€»è¾‘å¯ä»¥çœ‹è„šæœ¬ <code>cat /usr/bin/mount_romfs.sh</code></p><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">EmuELEC:~ # df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">devtmpfs                791.1M      4.0K    791.1M   0% /dev</span><br><span class="line">/dev/sda1                 1.0G    694.4M    330.6M  68% /flash</span><br><span class="line">/dev/loop0              673.5M    673.5M         0 100% /</span><br><span class="line">/dev/sda2                26.1G     21.8G      4.3G  84% /storage</span><br><span class="line">tmpfs                   902.1M         0    902.1M   0% /dev/shm</span><br><span class="line">tmpfs                   902.1M      9.2M    892.8M   1% /run</span><br><span class="line">tmpfs                   902.1M         0    902.1M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs                   902.1M      2.6M    899.5M   0% /var</span><br><span class="line">tmpfs                   902.1M         0    902.1M   0% /tmp</span><br><span class="line">none                     26.1G     21.8G      4.3G  84% /tmp/database</span><br><span class="line">none                     26.1G     21.8G      4.3G  84% /tmp/cores</span><br><span class="line">none                     26.1G     21.8G      4.3G  84% /tmp/joypads</span><br><span class="line">none                     26.1G     21.8G      4.3G  84% /tmp/shaders</span><br><span class="line">none                     26.1G     21.8G      4.3G  84% /tmp/overlays</span><br><span class="line">none                     26.1G     21.8G      4.3G  84% /tmp/assets</span><br></pre></td></tr></table></figure><p>å¯åŠ¨å, EMUELEC åˆ†åŒºè¢«æŒ‚è½½ä¸º <code>/flash</code>, STORAGE åˆ†åŒºè¢«æŒ‚è½½ä¸º <code>/storage</code>, system.img(ä¹Ÿå¯èƒ½æ˜¯é‚£ä¸ª SYSTEM) é€šè¿‡ <code>/dev/loop0</code> è¢«æŒ‚è½½ä¸ºç³»ç»Ÿæ ¹ç›®å½• <code>/</code> ã€‚æ‰€ä»¥, ç”¨æˆ·èƒ½ä¿®æ”¹çš„ä»…ä»…æ˜¯ <code>/flash</code> å’Œ <code>/storage</code> ç›®å½•ä¸‹çš„å†…å®¹<br>rootç”¨æˆ·çš„ home ç›®å½•è¢«å®šä½åˆ° <code>/storage</code>, å¦‚æœéœ€è¦æ·»åŠ ç™»å½•åè‡ªåŠ¨æ‰§è¡Œçš„å‘½ä»¤(ä¾‹å¦‚æ·»åŠ alias), å¯ä»¥ç›´æ¥åœ¨ <code>/storage</code> ç›®å½•ä¸‹æ–°å»º <code>.profile</code> æ–‡ä»¶æ¥å®ç°ã€‚</p><h3 id="wifi"><a href="#wifi" class="headerlink" title="wifi"></a>wifi</h3><p>æ–‡ä»¶ <code>/storage/.config/emuelec/configs/emuelec.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">## Activate wifi (0,1)</span><br><span class="line">wifi.enabled=1</span><br><span class="line">wifi.ssid=CMCC-5G</span><br><span class="line">wifi.key=zhangguanzhang</span><br><span class="line"># secondary wifi (not configurable via the user interface)</span><br><span class="line">#wifi2.ssid=new ssid</span><br><span class="line">#wifi2.key=new key</span><br><span class="line"># third wifi (not configurable via the user interface)</span><br><span class="line">#wifi3.ssid=new ssid</span><br><span class="line">#wifi3.key=new key</span><br></pre></td></tr></table></figure><p>RA é…ç½®æ–‡ä»¶ <code>/storage/.config/retroarch/retroarch.cfg</code></p><h2 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h2><p>ä¸‹è½½æºç è¿›å…¥ <code>make image</code>ï¼Œä¸“é—¨å¹³å°å°±åŠ å˜é‡ç¼–è¯‘ï¼Œä¾‹å¦‚:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROJECT=Amlogic-ce DEVICE=Amlogic-ng ARCH=aarch64 DISTRO=EmuELEC make image</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚è´´å§ä¹Ÿæœ‰äººå‘è‡ªå·±ç¼–è¯‘çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯è¿™äº›æ¯”ä¸€èˆ¬ä¼šé” sshï¼Œä¸è®©åˆ«äººä¿®æ”¹ï¼Œå½“ç„¶ä½ æ‡‚ Linux çš„è¯å¯ä»¥ img æ–‡ä»¶æŒ‚è½½äº†å»æ”¹ã€‚ç½‘ä¸Šä¹ŸåŸºæœ¬æœä¸åˆ°å•¥å…³äºé•¿ç¯‡å¤§è®ºè®²ç¼–è¯‘çš„æ•™ç¨‹ã€‚å»ºè®®è¿˜æ˜¯å…ˆçœ‹å®˜æ–¹çš„ <a href="https://github.com/EmuELEC/EmuELEC">README.md</a> </p><h2 id="ä½¿ç”¨é—®é¢˜"><a href="#ä½¿ç”¨é—®é¢˜" class="headerlink" title="ä½¿ç”¨é—®é¢˜"></a>ä½¿ç”¨é—®é¢˜</h2><h3 id="ä¸ªåˆ«-HDMI-å±å¹•æ²¡å£°éŸ³"><a href="#ä¸ªåˆ«-HDMI-å±å¹•æ²¡å£°éŸ³" class="headerlink" title="ä¸ªåˆ« HDMI å±å¹•æ²¡å£°éŸ³"></a>ä¸ªåˆ« HDMI å±å¹•æ²¡å£°éŸ³</h3><p>æ²¡å£°éŸ³çš„è¯å°è¯• EmuELEC setting â€“ éŸ³é¢‘ 0,0 0,1 åé‡å¯è¯•è¯•ã€‚</p><h3 id="å»¶è¿Ÿ"><a href="#å»¶è¿Ÿ" class="headerlink" title="å»¶è¿Ÿ"></a>å»¶è¿Ÿ</h3><p>æœ‰äº›äººè¯´æ˜¯æ‰‹æŸ„é—®é¢˜ï¼Œæœ‰çº¿å¥½äº &gt; æ— çº¿ï¼ŒæŸäº›ç‰Œå­æ— çº¿ &gt; å¦å¤–çš„æ— çº¿ã€‚ä¹Ÿæœ‰äººè¯´ç”µè§†çš„åŸå› ã€‚<br>æˆ‘ä¸ªäººæ˜¯åœ¨ ra é‡Œè®¾ç½® é™ä½å»¶è¿Ÿçš„é€‰é¡¹ï¼Œæ‰“å¼€ä»¥åå‚æ•°è®¾ä¸º 1 å’Œ 2éƒ½è¯•äº†ä¸‹ï¼Œ2å¥½ç‚¹ï¼Œä½†æ˜¯ 2 å¯èƒ½æ¯”è¾ƒåƒé…ç½®ï¼Œå¡çš„è¯å°±è¯•è¯• 1</p><h2 id="è¿›é˜¶ç©æ³•"><a href="#è¿›é˜¶ç©æ³•" class="headerlink" title="è¿›é˜¶ç©æ³•"></a>è¿›é˜¶ç©æ³•</h2><p><a href="https://github.com/EmuELEC/EmuELEC/wiki/bios">https://github.com/EmuELEC/EmuELEC/wiki/bios</a> bioså­˜æ”¾è·¯å¾„</p><h3 id="roms-ç½‘ç«™"><a href="#roms-ç½‘ç«™" class="headerlink" title="roms ç½‘ç«™"></a>roms ç½‘ç«™</h3><ul><li><a href="https://www.oldmanemu.net/">è€ç”·äºº</a></li><li><a href="https://vimm.net/">vimmâ€™s lair</a></li><li><a href="https://wowroms.com/en/all-roms">wowroms</a> åŸºæœ¬å•¥éƒ½æœ‰</li><li><a href="https://www.gamulator.com/roms">www.gamulator.com</a></li></ul><h3 id="ç¼©å®¹å’Œæå–-roms"><a href="#ç¼©å®¹å’Œæå–-roms" class="headerlink" title="ç¼©å®¹å’Œæå– roms"></a>ç¼©å®¹å’Œæå– roms</h3><p>éœ€è¦ç¼©å®¹æ˜¯å› ä¸º img é‡Œæ‰€æœ‰åˆ†åŒºè¡¨å¤§å°åŠ èµ·æ¥ä¼šè¶…è¿‡ U ç›˜å®¹é‡ã€‚</p><h4 id="windows-ç¼©å®¹å’Œæå–-roms"><a href="#windows-ç¼©å®¹å’Œæå–-roms" class="headerlink" title="windows ç¼©å®¹å’Œæå– roms"></a>windows ç¼©å®¹å’Œæå– roms</h4><p>æŠŠ img æ–‡ä»¶æ‹–åˆ° <code>DiskGenius</code> é‡Œï¼Œç„¶ååˆ æ‰å‡ ä¸ªå¤§æ¸¸æˆï¼Œç‰¹åˆ« psp é‡Œçš„ã€‚åˆ æ‰ååˆ†åŒºè¡¨å¤§å°å¹¶æ²¡å˜å°ï¼Œç„¶ååˆ©ç”¨åˆ†åŒºå…‹éš†å·¥å…·ï¼ŒæŒ‰ç…§é EEROMS çš„åˆ†åŒºåœ¨ä½  U ç›˜ä¸Šåˆ›å»ºåå‰é¢çš„åˆ†åŒºï¼Œç„¶åå‰©ä¸‹åˆ†åŒºç»™ EEROMSã€‚æ ¼å¼åŒ–çš„æ—¶å€™è®°å¾—æ¯ä¸ªåˆ†åŒºçš„å·æ ‡åè¦è®¾ç½®ä¸Šï¼Œ<code>EMUELEC</code>ã€<code>STORAGE</code> å’Œ <code>EEROMS</code>ã€‚æå–çš„è¯ç›´æ¥å¤åˆ¶å‡ºæ¥å³å¯ã€‚</p><h4 id="Linux-ç¼©å®¹å’Œæå–-roms"><a href="#Linux-ç¼©å®¹å’Œæå–-roms" class="headerlink" title="Linux ç¼©å®¹å’Œæå– roms"></a>Linux ç¼©å®¹å’Œæå– roms</h4><p>å¸®åŒäº‹å¼„çš„æ—¶å€™ä»– U ç›˜å°äº 64G ï¼Œ<code>DiskGenius</code> é‡Œåˆ†åŒºå…‹éš†è¯´ä¸èƒ½å…‹éš†ï¼Œæ°”å¾—æˆ‘åœ¨ Linux ä¸Šæã€‚æ³¨æ„å®¹é‡ï¼Œå…ˆæŠŠ 64G çš„è¿™ä¸ª img æ–‡ä»¶æ‹·è´åˆ° Linux ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l emuelec4.3æ­£å¼ç‰ˆ-s905x3-58g-3.img </span><br><span class="line">-rw-r--r-- 1 root root 62302191616 Jan 24 19:17 emuelec4.3æ­£å¼ç‰ˆ-s905x3-58g-3.img</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¸‹ img åˆ†åŒºä¿¡æ¯</span></span><br><span class="line">$ parted emuelec4.3æ­£å¼ç‰ˆ-s905x3-58g-3.img u s p</span><br><span class="line">Model:  (file)</span><br><span class="line">Disk /data/emuelec4.3æ­£å¼ç‰ˆ-s905x3-58g-3.img: 121683968s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: msdos</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start     End         Size        Type     File system  Flags</span><br><span class="line"> 1      8192s     4202495s    4194304s    primary  fat32        boot, lba</span><br><span class="line"> 2      4202496s  8388608s    4186113s    primary  ext4</span><br><span class="line"> 3      8390656s  121683967s  113293312s  primary  fat32        lba</span><br></pre></td></tr></table></figure><h5 id="img-æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•"><a href="#img-æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•" class="headerlink" title="img æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•"></a>img æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ç¬¬ä¸€ä¸ªç©ºé—²çš„ loop è®¾å¤‡</span></span><br><span class="line">LOOP_D=$(losetup --find)</span><br><span class="line"><span class="comment"># æŠŠ img æ–‡ä»¶æ‰«æåˆ° loop è®¾å¤‡ä¸Š</span></span><br><span class="line">losetup --partscan <span class="variable">$LOOP_D</span>  emuelec4.3æ­£å¼ç‰ˆ-s905x3-58g-3.img</span><br><span class="line"><span class="comment"># è¿™é‡Œæˆ‘çš„ img é‡Œæ˜¯ ä¸‰ä¸ªåˆ†åŒº</span></span><br><span class="line"><span class="comment"># EMUELEC å’Œ EEROMS åˆ†åŒºéƒ½æ˜¯ fat32 ï¼Œé‡Œé¢æœ‰ä¸­æ–‡æ¸¸æˆï¼Œéœ€è¦æŒ‚è½½å¸¦ä¸Š iocharset=utf8</span></span><br><span class="line"><span class="built_in">mkdir</span> -p p1 p2 p3</span><br><span class="line">mount  -o iocharset=utf8 <span class="variable">$&#123;LOOP_D&#125;</span>p1 p1</span><br><span class="line">mount  <span class="variable">$&#123;LOOP_D&#125;</span>p2 p2</span><br><span class="line">mount  -o iocharset=utf8 <span class="variable">$&#123;LOOP_D&#125;</span>p3 p3</span><br></pre></td></tr></table></figure><h5 id="å…‹éš†æ–‡ä»¶ç³»ç»Ÿåˆ°-U-ç›˜ä¸Š"><a href="#å…‹éš†æ–‡ä»¶ç³»ç»Ÿåˆ°-U-ç›˜ä¸Š" class="headerlink" title="å…‹éš†æ–‡ä»¶ç³»ç»Ÿåˆ° U ç›˜ä¸Š"></a>å…‹éš†æ–‡ä»¶ç³»ç»Ÿåˆ° U ç›˜ä¸Š</h5><p>åˆ›å»º U ç›˜åˆ†åŒºè¡¨ï¼Œstart å’Œ end æŒ‰ç…§ img æ–‡ä»¶é‡Œçš„ä¿¡æ¯æ¥ï¼Œæœ€ååˆ†åŒºç»“å°¾æ˜¯ <code>100%</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk <span class="comment"># æ‰¾åˆ° U ç›˜ï¼Œæˆ‘è¿™é‡Œæ˜¯ sdc</span></span><br><span class="line">sdc                                     8:32   1  57.6G  0 disk</span><br><span class="line"><span class="comment"># U ç›˜æ²¡åˆ†åŒºè¡¨çš„ï¼Œæœ‰çš„è¯è‡ªå·±æ¸…ç©ºä¸‹</span></span><br><span class="line"><span class="comment"># åœ¨ U ç›˜ä¸Šåˆ›å»ºåˆ†åŒºè¡¨</span></span><br><span class="line">parted /dev/sdc mkpart p fat32 8192s 4202495s</span><br><span class="line">parted /dev/sdc <span class="built_in">set</span> 1 boot on</span><br><span class="line">parted /dev/sdc mkpart p ext4 4202496s 8388608s</span><br><span class="line">parted /dev/sdc mkpart p fat32 8390656s 100% <span class="comment"># æœ€åä¸€ä¸ªç›´æ¥100%</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹ u ç›˜åˆ†åŒºä¿¡æ¯å’Œ img ä¿¡æ¯æ˜¯ç¬¦åˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ parted /dev/sdc u s p</span><br><span class="line">Model: Kingston DataTraveler 3.0 (scsi)</span><br><span class="line">Disk /dev/sdc: 120845300s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: msdos</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start     End         Size        Type     File system  Flags</span><br><span class="line"> 1      8192s     4202495s    4194304s    primary               boot, lba</span><br><span class="line"> 2      4202496s  8388608s    4186113s    primary</span><br><span class="line"> 3      8390656s  120844287s  112453632s  primary               lba</span><br></pre></td></tr></table></figure><p>æ ¼å¼åŒ–å‡º U ç›˜æ–‡ä»¶ç³»ç»Ÿï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„è¦å¸¦ä¸Š LABEL åï¼šEMUELEC STORAGE EEROMS</span></span><br><span class="line"><span class="comment"># openwrt ä¸Šæ²¡æœ‰ mkfs.vfat, éœ€è¦å®‰è£… dosfstools å ln -sf /usr/sbin/mkfs.fat /usr/sbin/mkfs.vfat</span></span><br><span class="line">mkfs.vfat -F 32 -n EMUELEC /dev/sdc1</span><br><span class="line">mkfs.ext4 -L STORAGE      /dev/sdc2</span><br><span class="line">mkfs.vfat -F 32 -n EEROMS /dev/sdc3</span><br></pre></td></tr></table></figure><p>å¦‚æœå¿˜è®° LABELï¼Œåé¢æ‰“ä¹Ÿè¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fatlabel /dev/sdc1 EMUELEC</span><br><span class="line">tune2fs -L STORAGE /dev/sdc2</span><br><span class="line">fatlabel /dev/sdc3 EEROMS</span><br><span class="line"># æŸ¥çœ‹ LABEL</span><br><span class="line">lsblk -o PATH,LABEL</span><br></pre></td></tr></table></figure><p>U ç›˜æ–‡ä»¶æŒ‚è½½åˆ°æœ¬åœ°ï¼Œå¹¶å¼€å§‹å¤åˆ¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mkdir -p u&#123;1..3&#125;</span><br><span class="line">mount  -o iocharset=utf8 /dev/sdc1 u1</span><br><span class="line">mount  /dev/sdc2 u2</span><br><span class="line">mount  -o iocharset=utf8 /dev/sdc3 u3</span><br><span class="line"></span><br><span class="line"># æ‹·è´ä¹‹å‰ df -h çœ‹ä¸‹ p3 çš„å·²ä½¿ç”¨å¤§å°æ˜¯å¦å°äºç­‰äº u3 åˆ†åŒºè¡¨å¤§å°</span><br><span class="line"># å¦‚æœä¸æ˜¯ å¯ä»¥åˆ æ‰ EEROMS åˆ†åŒºä¸‹é¢ psp é‡Œçš„å¤§æ¸¸æˆå…ˆ</span><br><span class="line">rsync -vzrtopgl  p1/ u1/</span><br><span class="line">rsync -vzrtopgl  p2/ u2/</span><br><span class="line">rsync -vzrtopgl  p3/ u3/</span><br><span class="line"></span><br><span class="line">å–æ¶ˆ U ç›˜æŒ‚è½½</span><br><span class="line">```bash</span><br><span class="line">umount u&#123;1..3&#125;</span><br></pre></td></tr></table></figure><h5 id="åˆ¶ä½œçœŸæ­£ç¼©å®¹çš„-img"><a href="#åˆ¶ä½œçœŸæ­£ç¼©å®¹çš„-img" class="headerlink" title="åˆ¶ä½œçœŸæ­£ç¼©å®¹çš„ img"></a>åˆ¶ä½œçœŸæ­£ç¼©å®¹çš„ img</h5><p>å‰é¢çš„ img æŒ‚è½½ä¸è¦å–æ¶ˆï¼Œæˆ‘ä»¬æ¥åˆ¶ä½œä¸€ä¸ªç¼©å°å®¹é‡çš„ img æ–‡ä»¶æ¥åˆ†äº«ç»™åˆ«äººä½¿ç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># åˆ¶ä½œä¸€ä¸ª 57G çš„ç©ºæ–‡ä»¶</span><br><span class="line">truncate -s 57G test.img</span><br><span class="line"># å¯¹æ–‡ä»¶å¼€å§‹åˆ†åŒºï¼Œåˆ†åŒºä¿¡æ¯å‚è€ƒä¸‹ img</span><br><span class="line">parted test.img mklabel msdos</span><br><span class="line">parted test.img mkpart p fat32 8192s 4202495s</span><br><span class="line">parted test.img set 1 boot on</span><br><span class="line">parted test.img mkpart p ext4 4202496s 8388608s</span><br><span class="line">parted test.img mkpart p fat32 8390656s 100%</span><br></pre></td></tr></table></figure><p>æŒ‚è½½æˆ‘ä»¬çš„ img æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LOOP_D2=$(losetup --find)</span><br><span class="line">losetup --partscan $LOOP_D2  test.img</span><br><span class="line"># åˆ›å»ºåˆ†åŒºè¡¨</span><br><span class="line">mkfs.vfat -F 32 -n EMUELEC $&#123;LOOP_D2&#125;p1</span><br><span class="line">mkfs.ext4 -L STORAGE $&#123;LOOP_D2&#125;p2</span><br><span class="line">mkfs.vfat -F 32 -n EEROMS $&#123;LOOP_D2&#125;p3</span><br><span class="line"># æŒ‚è½½</span><br><span class="line">mkdir -p u&#123;1..3&#125;</span><br><span class="line">mount  -o iocharset=utf8 $&#123;LOOP_D2&#125;p1 u1</span><br><span class="line">mount   $&#123;LOOP_D2&#125;p2 u2</span><br><span class="line">mount  -o iocharset=utf8 $&#123;LOOP_D2&#125;p3 u3</span><br></pre></td></tr></table></figure><p>æ‹·è´åˆ°æˆ‘ä»¬çš„æ–° img é‡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rsync -vzrtopgl  p1/ u1/</span><br><span class="line">rsync -vzrtopgl  p2/ u2/</span><br><span class="line">rsync -vzrtopgl  p3/ u3/</span><br><span class="line">umount u&#123;1..3&#125;</span><br></pre></td></tr></table></figure><p>å–æ¶ˆä¸¤ä¸ª img æ–‡ä»¶æ˜ å°„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">umount p&#123;1..3&#125;</span><br><span class="line">losetup -D  $&#123;LOOP_D2&#125;</span><br><span class="line">losetup -D  $&#123;LOOP_D&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ–°çš„ img æ–‡ä»¶å°±å¯ä»¥ç›´æ¥åˆ· U ç›˜äº†ã€‚</p><h3 id="å¤–ç½®-roms"><a href="#å¤–ç½®-roms" class="headerlink" title="å¤–ç½® roms"></a>å¤–ç½® roms</h3><p>ä¹Ÿå°±æ˜¯ä½ å¯èƒ½ä¸€ä¸ª 2G æˆ–è€… 4G çš„ U ç›˜åˆ·çº¯å‡€ç³»ç»Ÿï¼Œç„¶åæ¸¸æˆ roms éƒ½å­˜æ”¾åœ¨å…¶ä»–åœ°æ–¹ï¼š</p><ul><li>å…¶ä»–å­˜å‚¨ä»‹è´¨ï¼Œä¾‹å¦‚å¦ä¸€ä¸ª u ç›˜æˆ–è€…ç§»åŠ¨ç¡¬ç›˜ã€‚ä¸æ‡‚ Linux çš„è¯å¯ä»¥æ ¼å¼åŒ–æˆ fat32ï¼Œè¿™æ · windows å¯ä»¥è¯†åˆ«ï¼Œåˆ†åŒºé‡Œæ–°å»ºä¸€ä¸ª roms æ–‡ä»¶å¤¹ï¼Œç„¶å roms é‡Œå­˜æ”¾ä¸€ä¸ªç©ºç™½æ–‡ä»¶ <code>emuelecroms</code> ï¼Œroms ç›®å½•é‡Œå­˜æ”¾å„ä¸ªç›®å½•å³å¯ã€‚ç§»åŠ¨ç¡¬ç›˜ä¸€èˆ¬æ˜¯ <code>exfat</code> åˆ†åŒºï¼Œlinux å’Œ windows éƒ½èƒ½è¯†åˆ«ã€‚ samba çš„è¯å®˜æ–¹æ¨èä½¿ç”¨ systemd mount æŒ‚è½½ï¼Œè§ <a href="https://github.com/EmuELEC/EmuELEC/wiki/ROMS-on-CIFS-SAMBA-shares">sabma share</a></li><li>ç½‘ç»œå­˜å‚¨ï¼Œnasä¸Šåˆ†äº«æˆ sambaï¼Œæˆ–è€…ä½ è‡ªå·±ç”µè„‘ä¸Šå¼€å…±äº«ã€‚</li><li>é˜¿é‡Œäº‘ç›˜ webdav æŒ‚è½½ï¼Œæˆ‘è‡ªå·±ç ”ç©¶å‡ºæ¥çš„</li></ul><p>é»˜è®¤è¡Œä¸ºå¯ä»¥çœ‹è„šæœ¬ <code>cat /usr/bin/mount_romfs.sh</code></p><h4 id="exfat-ç§»åŠ¨ç¡¬ç›˜"><a href="#exfat-ç§»åŠ¨ç¡¬ç›˜" class="headerlink" title="exfat ç§»åŠ¨ç¡¬ç›˜"></a>exfat ç§»åŠ¨ç¡¬ç›˜</h4><p>ç§»åŠ¨ç¡¬ç›˜æ ¼å¼åŒ–æˆ exfat æ ¼å¼ï¼Œç„¶åæ¸¸æˆ roms æ‹·è´è¿›å»ï¼Œæ’ä¸Šå»åä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ªåˆ†åŒºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">EmuELEC:~ # df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">devtmpfs                791.1M      4.0K    791.1M   0% /dev</span><br><span class="line">/dev/sda1                 1.0G    694.4M    330.6M  68% /flash</span><br><span class="line">/dev/loop0              673.5M    673.5M         0 100% /</span><br><span class="line">/dev/sda2                26.1G     21.9G      4.2G  84% /storage</span><br><span class="line">tmpfs                   902.1M         0    902.1M   0% /dev/shm</span><br><span class="line">tmpfs                   902.1M     10.3M    891.8M   1% /run</span><br><span class="line">tmpfs                   902.1M         0    902.1M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs                   902.1M      2.6M    899.5M   0% /var</span><br><span class="line">tmpfs                   902.1M         0    902.1M   0% /tmp</span><br><span class="line">none                     26.1G     21.9G      4.2G  84% /tmp/overlays</span><br><span class="line">none                     26.1G     21.9G      4.2G  84% /tmp/joypads</span><br><span class="line">none                     26.1G     21.9G      4.2G  84% /tmp/assets</span><br><span class="line">none                     26.1G     21.9G      4.2G  84% /tmp/cores</span><br><span class="line">none                     26.1G     21.9G      4.2G  84% /tmp/database</span><br><span class="line">none                     26.1G     21.9G      4.2G  84% /tmp/shaders</span><br><span class="line">/dev/sdb1               119.2G     43.1G     76.2G  36% /var/media/ZGZ # è¿™é‡Œæˆ‘çš„å·åå­—æ˜¯ ZGZ</span><br><span class="line"></span><br><span class="line"># umount æ‰ /var/media/ZGZ åæŒ‚è½½åˆ° /storage/roms</span><br><span class="line">EmuELEC:~ # umount /var/media/ZGZ/</span><br><span class="line">EmuELEC:~ # mount -t exfat -o nonempty /dev/sdb1 /storage/roms</span><br></pre></td></tr></table></figure><h4 id="webdav"><a href="#webdav" class="headerlink" title="webdav"></a>webdav</h4><p>é˜¿é‡Œäº‘ç›˜ webdav æ˜¯æˆ‘è‡ªå·±æ‘¸ç´¢å‡ºæ¥çš„ï¼Œå› ä¸ºæœ‰ aliyundrive-webdav é¡¹ç›®èƒ½æŠŠé˜¿é‡Œäº‘ç›˜æŠ½è±¡æˆ webdav ï¼Œä½†æ˜¯æˆ‘ ssh ä¸Šå»çœ‹äº†ä¸‹æˆ‘çš„å›ºä»¶é‡Œå¹¶ä¸è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EmuELEC:~ # mount</span><br><span class="line">mount             mount.exfat       mount.exfat-fuse  mount.fuse        mount.ntfs        mountpoint</span><br></pre></td></tr></table></figure><p>åœ¨å®˜æ–¹ github ä¸Š <a href="https://github.com/EmuELEC/EmuELEC/issues/793">æäº† issue</a> åï¼Œå¼€å‘è€…å‘Šè¯‰æˆ‘ <code>installentware</code> åèƒ½ä½¿ç”¨ opkgï¼Œæˆ‘å°±æ•´å‡ºæ¥äº†ã€‚</p><h5 id="aliyundrive-webdav"><a href="#aliyundrive-webdav" class="headerlink" title="aliyundrive-webdav"></a>aliyundrive-webdav</h5><p>å…ˆå‡†å¤‡ç”¨å¤§ä½¬çš„ <a href="https://github.com/messense/aliyundrive-webdav">messense&#x2F;aliyundrive-webdav</a> æŠŠ é˜¿é‡Œäº‘ç›˜ æŠ½è±¡æˆå±€åŸŸç½‘çš„ webdavã€‚æœ‰ä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯ openwrt ä¸Šï¼Œä¸€ç§æ˜¯é openwrt ä¸Šï¼Œé openwrt ä¸Šæˆ‘æ˜¯ Linux è·‘ dockerï¼Œwindows è‡ªå·±å» release ä¸Šä¸‹è½½ windows çš„ã€‚Linux çš„è¯ docker-compose å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">aliyundrive-webdav:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">aliyundrive-webdav</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;REFRESH_TOKEN=xxxxxx&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HOST=0.0.0.0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PORT=8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WEBDAV_AUTH_USER=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WEBDAV_AUTH_PASSWORD=root</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">messense/aliyundrive-webdav</span></span><br><span class="line">    <span class="attr">command:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/bin/aliyundrive-webdav</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--auto-index</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--root=/person/life/Game/EmuELEC/roms</span> <span class="comment"># é˜¿é‡Œäº‘ç›˜ä¸Š roms è·¯å¾„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cache-ttl=10</span></span><br></pre></td></tr></table></figure><h5 id="æŒ‚è½½-webdav"><a href="#æŒ‚è½½-webdav" class="headerlink" title="æŒ‚è½½ webdav"></a>æŒ‚è½½ webdav</h5><p>å®é™…ä¸Šæˆ‘ç ”ç©¶å‡ºä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯åˆ©ç”¨ rcloneï¼Œä¸€ç§æ˜¯å®‰è£… davfs2 æŒ‚è½½</p><h6 id="rclone"><a href="#rclone" class="headerlink" title="rclone"></a>rclone</h6><p>å…ˆssh ä¸Šå» wget <a href="https://github.com/rclone/rclone/releases">ä¸‹è½½ linux-arm64.zip</a> åï¼Œ<code>unzip -x </code> è§£å‹å®ƒåæŒ‚è½½ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ å¯†å¯†ç </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;root&quot;</span> | ./rclone obscure -</span><br><span class="line"><span class="comment"># æŒ‚è½½åˆ°å½“å‰ roms ç›®å½•</span></span><br><span class="line">./rclone mount :webdav: roms --webdav-url http://192.168.101.1:8080 --webdav-user root --webdav-pass DRggunKeWmBO8A9b9T2ZmkPFaR8 --cache-dir /tmp --allow-other --vfs-cache-mode writes --allow-non-empty</span><br></pre></td></tr></table></figure><p>rclone webdav æ–‡æ¡£ï¼š</p><ul><li><a href="https://rclone.org/webdav/">https://rclone.org/webdav/</a></li><li><a href="https://rclone.org/commands/rclone_obscure/">https://rclone.org/commands/rclone_obscure/</a> # ä¸ºå•¥å¯†ç è¦åŠ å¯†</li></ul><h6 id="mount-t-davfs"><a href="#mount-t-davfs" class="headerlink" title="mount -t davfs"></a>mount -t davfs</h6><p>å…ˆ ssh ä¸Šå»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œä¸‹é¢è¿™ä¸ªï¼Œä¸€è·¯yes åé‡å¯</span></span><br><span class="line">installentware</span><br></pre></td></tr></table></figure><p>ç„¶åä½ å°±èƒ½ä½¿ç”¨ opkg äº†ï¼Œå®‰è£…ä¸‹ <code>davfs2</code>ï¼Œæºåœ¨å›½å¤–ï¼Œä¸èƒ½å®‰è£…å°±å»ä¸Šé¢çš„ <a href="https://github.com/EmuELEC/EmuELEC/issues/793#issuecomment-1018214935">issue é‡Œ</a>çœ‹æˆ‘å®‰è£…æ—¶å€™çš„ url </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opkg install davfs2</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™æ ·æ˜¯æ— æ³•åœ¨ EmuELEC é‡Œä½¿ç”¨çš„ï¼Œå°±åƒæˆ‘æçš„ issue é‡Œï¼Œéœ€è¦ä¿®æ”¹å‡ ä¸ªåœ°æ–¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠŠ dav_user å’Œ dav_group å–æ¶ˆæ³¨é‡Šï¼Œå¹¶æ”¹æˆå­˜åœ¨çš„ç”¨æˆ·ï¼Œè¿™é‡Œæˆ‘æ˜¯æ”¹æˆ root</span></span><br><span class="line">vi /opt/etc/davfs2/davfs2.conf </span><br></pre></td></tr></table></figure><p>æ”¹å®Œåç”¨ <code>grep -Ev &#39;^\s*$|^\s*#&#39; /opt/etc/davfs2/davfs2.conf</code> æŸ¥çœ‹æ˜¯è¿™æ ·çš„å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dav_user        root            # system wide config file only</span><br><span class="line">dav_group       root            # system wide config file only</span><br></pre></td></tr></table></figure><p>ç„¶åæ›´æ”¹ secret çš„æ–‡ä»¶æƒé™ï¼Œå¦åˆ™æŒ‚è½½ webdav çš„æ—¶å€™ä¼šæŠ¥é”™ <code>mount.davfs: file /opt/etc/davfs2/secrets has wrong permissions</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 0600 /opt/etc/davfs2/secrets</span><br></pre></td></tr></table></figure><p>æŒ‚è½½ webdavï¼ŒæŒ‚è½½å®Œåå»ºè®® <code>ls /storage/roms</code>ä¸‹ï¼Œåˆæ¬¡æœ‰ä¸€ç‚¹å¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t davfs  http://192.168.101.1:8080 /storage/roms</span><br></pre></td></tr></table></figure><p>åç»­æŒ‚è½½å‰è®°å¾—æ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f /opt/var/run/mount.davfs/storage-roms.pid</span><br></pre></td></tr></table></figure><p>æŒ‚è½½å®Œåè¿›èœå•åˆ·æ–°ä¸‹æ¸¸æˆã€‚</p><p>å…³äº webdav çš„ä¸€äº›æ–‡æ¡£:</p><ul><li><a href="https://man.archlinux.org/man/mount.davfs.8.en">https://man.archlinux.org/man/mount.davfs.8.en</a></li></ul><p>åç»­å¯ä»¥å‚è€ƒ samba å†™ä¸€ä¸ª systemd çš„ mount</p><h3 id="è‡ªåˆ¶-roms"><a href="#è‡ªåˆ¶-roms" class="headerlink" title="è‡ªåˆ¶ roms"></a>è‡ªåˆ¶ roms</h3><p>æˆ‘è¿™é‡Œæ˜¯è‡ªå·±æ‰“åŒ…ä¸€ä¸ªçº¯å‡€çš„ N1 img å’Œç½‘ä¸Šå…¶ä»– img é‡Œçš„ ROMS å¤åˆ¶è¿›å»ä¸ºä¸»ã€‚</p><p>N1 æ˜¯ä¸ªç‰¹æ®Šå­˜åœ¨ï¼Œå‚ç…§ä¸‹é¢ä¸¤ä¸ªå¸–å­ï¼š</p><ul><li>æ©å±± <a href="https://www.right.com.cn/forum/thread-4090331-1-1.html">EmuELEC 4.2 è‡ªä¸»å®‰è£…</a>é‡Œçš„ï¼Œ</li><li>è´´å§ <a href="https://tieba.baidu.com/p/7619382778?pn=1&p_tk=1322QifLqSShpTFmTFD890NZYhknA/BTlYv+JMFCYG1WaXS0J558KEir1sr/GhyhKoYcYhmNaHzkHIG4uN84DH58wemMHpNVngGfh7poXSCPq1KfAiXaTvOnRW+aIz8lXqSf&p_timestamp=1643350078&p_sign=37ee8f2d0a49b58124628a8003121082&p_signature=f28e253e43066beb6450b9130d8fe53d&__pc2ps_ab=1322QifLqSShpTFmTFD890NZYhknA/BTlYv+JMFCYG1WaXS0J558KEir1sr/GhyhKoYcYhmNaHzkHIG4uN84DH58wemMHpNVngGfh7poXSCPq1KfAiXaTvOnRW+aIz8lXqSf%7C1643350078%7Cf28e253e43066beb6450b9130d8fe53d%7C37ee8f2d0a49b58124628a8003121082&red_tag=0480290028&qq-pf-to=pcqq.group">N1å¯ç”¨çš„é¬¼ç­ä¹‹åˆƒEmuELEC v4.3</a></li></ul><p>ä¸‹è½½å®˜æ–¹çš„ img æ–‡ä»¶ï¼Œç„¶å N1 çš„è¡¥ä¸æ–‡ä»¶æˆ‘ç”¨åœ¨ 4.3 çš„å®˜æ–¹æ–‡ä»¶é‡Œå»æ›¿æ¢æ˜¯å¯ä»¥çš„ã€‚å¯¹æ¯”äº†ä¸‹æˆ‘ä¹‹å‰çš„äººä¸­æ—¥æœˆçš„å›ºä»¶å’Œå®˜æ–¹ img æ›¿æ¢äº† N1 è¡¥ä¸æ–‡ä»¶åï¼Œå‘ç°å†…æ ¸æ˜¯ä¸€æ ·çš„éƒ½æ˜¯ <code>3.14.29</code>ï¼Œè¯´æ˜äººä¸­æ—¥æœˆæ‰“åŒ…ä¹Ÿåªæ˜¯åŸºç¡€è®¾ç½®+æ¸¸æˆ roms è€Œå·²ã€‚<br>å…ˆå®˜æ–¹çš„ img æ–‡ä»¶åˆ·åˆ° U ç›˜é‡Œï¼Œç„¶å windows ä¸ŠæŠŠè¡¥ä¸è¦†ç›–åˆ°ç¬¬ä¸€ä¸ªåˆ†åŒºã€‚ç„¶åæ’ N1 å¼€æœºå¯åŠ¨åè®¾ç½®å¦‚ä¸‹ï¼š</p><ul><li>emuelec èœå•æ—¶åŒºï¼Œä¹Ÿå¯ä»¥å¯ä»¥ ssh ä¸Šå»</li><li>ra çš„ä¸­æ–‡ä¹±ç ï¼Œ<code>systemctl cat tmp-assets.mount</code> ï¼Œ <code>cp -a /tmp/assets/* /storage/assets/</code> åæå–ä¸­æ–‡å­—ä½“è¦†ç›– <code>/storage/assets/ozone/</code> ä¸‹çš„ä¿© ttf åï¼ˆä¼¼ä¹ä¸‹é¢çš„ pkg ç›®å½•ä¹Ÿè¦å¤„ç†ï¼Ÿï¼‰ã€‚é‡å¯æœºå™¨åé€‰æ‹©ä¸­æ–‡ï¼Œç„¶åå†åœ¨ RA é‡Œé€‰æ‹©ä¿å­˜ä¸‹é…ç½®ã€‚</li><li>è‡ªå®¶ wifi è®¾ç½®å•¥çš„</li></ul><p>ç„¶åæ‹”ä¸‹æ¥ï¼Œæ’ Linux ä¸Šã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ parted /dev/sda u s p</span><br><span class="line">Model: SanDisk Extreme Pro (scsi)</span><br><span class="line">Disk /dev/sda: 250085376s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: msdos</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start     End         Size        Type     File system  Flags</span><br><span class="line"> 1      8192s     4202495s    4194304s    primary  fat32        boot, lba</span><br><span class="line"> 2      4202496s  8388608s    4186113s    primary  ext4</span><br><span class="line"> 3      8390656s  250085375s  241694720s  primary  fat32        lba</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æœ‰ä¸‰ä¸ªåˆ†åŒºï¼Œå…ˆæ‰“åŒ…ä¸€ä¸ªçº¯å‡€ç‰ˆï¼Œè€ƒè™‘åˆ° U ç›˜å®¹é‡é—®é¢˜å’Œç°åœ¨è´­ä¹°åŸºæœ¬éƒ½æ˜¯ 16Gï¼ˆjd ä¸Šå¥½åƒæœ€å° 8Gï¼‰ï¼Œæ‰“åŒ…ä¸€ä¸ª 7350M çš„çº¯å‡€ç‰ˆã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truncate -s 7350M test.img</span><br></pre></td></tr></table></figure><p>å…ˆæŠŠè®¾ç½®åçš„ U ç›˜å†…æ–‡ä»¶ç³»ç»Ÿçš„ä¸œè¥¿å¯¼å‡ºæ¥åˆ° test.img é‡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> e1 e2 e3</span><br><span class="line">mount  -o iocharset=utf8 /dev/sda1 e1</span><br><span class="line">mount  /dev/sda2 e2</span><br><span class="line">mount  -o iocharset=utf8 /dev/sda1 e3</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹æ–‡ä»¶å¼€å§‹åˆ†åŒºï¼Œåˆ†åŒºä¿¡æ¯å‚è€ƒä¸‹ img</span></span><br><span class="line">parted test.img mklabel msdos</span><br><span class="line">parted test.img mkpart p fat32 8192s 4202495s</span><br><span class="line">parted test.img <span class="built_in">set</span> 1 boot on</span><br><span class="line">parted test.img mkpart p ext4 4202496s 8388608s</span><br><span class="line">parted test.img mkpart p fat32 8390656s 100%</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†æˆ‘ä»¬çš„ img æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">LOOP_D=$(losetup --find)</span><br><span class="line">losetup --partscan <span class="variable">$LOOP_D</span>  test.img</span><br><span class="line"><span class="comment"># åˆ›å»ºåˆ†åŒºè¡¨</span></span><br><span class="line">mkfs.vfat -F 32 -n EMUELEC <span class="variable">$&#123;LOOP_D&#125;</span>p1</span><br><span class="line">mkfs.ext4 -L STORAGE <span class="variable">$&#123;LOOP_D&#125;</span>p2</span><br><span class="line">mkfs.vfat -F 32 -n EEROMS <span class="variable">$&#123;LOOP_D&#125;</span>p3</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½</span></span><br><span class="line"><span class="built_in">mkdir</span> -p u&#123;1..3&#125;</span><br><span class="line">mount  -o iocharset=utf8 <span class="variable">$&#123;LOOP_D&#125;</span>p1 u1</span><br><span class="line">mount   <span class="variable">$&#123;LOOP_D&#125;</span>p2 u2</span><br><span class="line">mount  -o iocharset=utf8 <span class="variable">$&#123;LOOP_D&#125;</span>p3 u3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹·è´æ–‡ä»¶</span></span><br><span class="line">rsync -vzrtopgl  e1/ u1/</span><br><span class="line"></span><br><span class="line">rsync -vzrtopgl  e2/ u2/</span><br><span class="line"><span class="comment"># EEROMS</span></span><br><span class="line">rsync -vzrtopgl  e3/ u3/</span><br><span class="line"><span class="comment"># æ·»åŠ å‘½ä»¤åˆ«å</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;alias ll=&#x27;ls -l&#x27;&quot;</span> &gt;&gt; u2/.config/profile.d/99-emuelec_functions.conf</span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥è‡ªå·±ä¿®æ”¹ä¸€äº›æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>æ‹·è´å®Œæˆåï¼Œå¯ä»¥è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œä¾‹å¦‚åé¢çš„èœå•æ±‰åŒ–å’Œä¸»é¢˜ä¿®æ”¹ã€‚æ”¹å®Œäº†åå°±å¯ä»¥æ”¶å°¾å·¥ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">umount e&#123;1..2&#125; u&#123;1..3&#125;</span><br><span class="line">losetup -D $LOOP_D</span><br><span class="line"></span><br><span class="line">mv test.img EmuELEC-4.3-N1-3.img</span><br><span class="line">gzip EmuELEC-4.3-N1-3.img</span><br></pre></td></tr></table></figure><h2 id="ä¸€äº›å…¶ä»–ç¬”è®°"><a href="#ä¸€äº›å…¶ä»–ç¬”è®°" class="headerlink" title="ä¸€äº›å…¶ä»–ç¬”è®°"></a>ä¸€äº›å…¶ä»–ç¬”è®°</h2><h3 id="ssh-çš„ä¸€äº›è®¾ç½®"><a href="#ssh-çš„ä¸€äº›è®¾ç½®" class="headerlink" title="ssh çš„ä¸€äº›è®¾ç½®"></a>ssh çš„ä¸€äº›è®¾ç½®</h3><p><code>/storage/.config/emuelec/configs/emuelec.conf</code> é‡Œä¿®æ”¹æ—¶åŒº <code>system.timezone=Asia/Shanghai</code></p><h4 id="è“ç‰™ç›¸å…³"><a href="#è“ç‰™ç›¸å…³" class="headerlink" title="è“ç‰™ç›¸å…³"></a>è“ç‰™ç›¸å…³</h4><p>è¿è“ç‰™æ‰‹æŸ„å‚è€ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œåè¿›å…¥ bluetoothctl äº¤äº’</span></span><br><span class="line">bluetoothctl</span><br><span class="line"></span><br><span class="line">default-agent</span><br><span class="line">power on</span><br><span class="line">discoverable on</span><br><span class="line">pairable on</span><br><span class="line">scan on</span><br></pre></td></tr></table></figure><p>ç„¶åä¼šå¼€å§‹æ‰«æ è“ç‰™ï¼Œè®°å½•ä¸‹ä½ çš„è“ç‰™æ‰‹æŸ„ MACï¼Œå¼€å§‹é…å¯¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trust AC:FD:93:CB:3E:BE</span><br><span class="line">pair AC:FD:93:CB:3E:BE</span><br><span class="line">connect AC:FD:93:CB:3E:BE</span><br></pre></td></tr></table></figure><p>ç§»é™¤è®¾å¤‡çš„è¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remove AC:FD:93:CB:3E:BE</span><br></pre></td></tr></table></figure><h4 id="ä¸»é¢˜"><a href="#ä¸»é¢˜" class="headerlink" title="ä¸»é¢˜"></a>ä¸»é¢˜</h4><p>å»å®˜æ–¹ä»“åº“æ‰¾ï¼Œä¾‹å¦‚ <a href="https://github.com/EmuELEC/es-theme-alekfull-EmueELEC">EmuELEC&#x2F;es-theme-alekfull-EmueELEC</a>ï¼Œè¿›å…¥ä¸‹é¢ç›®å½•ä¸‹è½½åè§£å‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /storage/.config/emulationstation/themes</span><br><span class="line">wget https://github.com/EmuELEC/es-theme-alekfull-EmueELEC/archive/refs/heads/master.zip</span><br><span class="line">unzip -x master.zip &amp;&amp; rm -f master.zip</span><br><span class="line">mv es-theme-alekfull-EmueELEC-* es-theme-alekfull-EmueELEC</span><br></pre></td></tr></table></figure><p>ä¸»é¢˜è®¾ç½®åœ¨ <code>/storage/.config/emulationstation/es_settings.cfg</code> é‡Œçš„ <code>ThemeSet</code></p><h4 id="èœå•æ±‰åŒ–çš„è¯"><a href="#èœå•æ±‰åŒ–çš„è¯" class="headerlink" title="èœå•æ±‰åŒ–çš„è¯"></a>èœå•æ±‰åŒ–çš„è¯</h4><p>å–„ç”¨ find ï¼Œä¾‹å¦‚æˆ‘çœ‹äº†ä¸‹èœå•é‡Œæœ‰éƒ¨åˆ†è¿˜æ˜¯è‹±æ–‡ï¼Œä¾‹å¦‚ <code>DANGER ZONE</code>ï¼Œç”¨å‘½ä»¤æŸ¥ <code>find / -type f -exec grep -Eil &#39;DANGER\s+zone&#39; &#123;&#125; \;</code>ï¼Œæ‰¾åˆ°å¦‚ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/storage/.config/emulationstation/resources/mamenames.xml</span><br><span class="line">/storage/.config/emuelec/configs/locale/de/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/pt_PT/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/ko/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/hu/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/nb_NO/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/pl/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/ca/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/zh_TW/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/pt_BR/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/it/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/he/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/uk_UA/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/ru_RU/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/sv_SE/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/oc_FR/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/eu_ES/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/nl/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/el/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/zh_CN/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/zh_CN/LC_MESSAGES/emulationstation2.po~</span><br><span class="line">/storage/.config/emuelec/configs/locale/cy_GB/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/ja_JP/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/nn_NO/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/es_MX/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/tr/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/es/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/es/LC_MESSAGES/emulationstation2.po~</span><br><span class="line">/storage/.config/emuelec/configs/locale/fr/LC_MESSAGES/emulationstation2.po</span><br><span class="line">/storage/.config/emuelec/configs/locale/ar/LC_MESSAGES/emulationstation2.po</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚æˆ‘è¦æ±‰åŒ– <code>DANGER ZONE</code> è¿™ä¸ªèœå•ï¼ŒæŒ‰ç…§ä¸‹é¢æ­¥éª¤ä¿®æ”¹æ–‡ä»¶å†…å®¹åå‘å¸ƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /storage/.config/emuelec/configs/locale/zh_CN/LC_MESSAGES/</span><br><span class="line">vi emulationstation2.po</span><br><span class="line"># msgfmt åœ¨åŒ… gettext é‡Œ</span><br><span class="line">msgfmt -o emulationstation2.mo emulationstation2.po</span><br></pre></td></tr></table></figure><h3 id="N1-è¡¥ä¸åå¼€æœº-CoreELEC-å›¾æ ‡è§£å†³"><a href="#N1-è¡¥ä¸åå¼€æœº-CoreELEC-å›¾æ ‡è§£å†³" class="headerlink" title="N1 è¡¥ä¸åå¼€æœº CoreELEC å›¾æ ‡è§£å†³"></a>N1 è¡¥ä¸åå¼€æœº CoreELEC å›¾æ ‡è§£å†³</h3><p>å‚ç…§ <a href="https://www.qishe.org/3774.html#">N1 å¯åŠ¨åŸç‰ˆ EmuELEC</a>:</p><p>ç›®å‰ N1è·‘ Emuelec çš„åŠæ³•éƒ½æ˜¯æ›¿æ¢è¡¥ä¸ï¼Œè¡¥ä¸é‡Œçš„å†…æ ¸æ˜¯ä» CoreELEC ç¼–è¯‘æ¥çš„ï¼Œæ‰€ä»¥å¯åŠ¨æ—¶ä¼šæ˜¾ç¤º CoreELEC çš„ logoï¼Œå¯¹äºæ´ç™–å…šæ¥è¯´ä¸èƒ½å¿å—ï¼Œè€Œä¸”ä¸€ç›´ç”¨è¿™ä¸ªè¡¥ä¸å†…æ ¸çš„è¯ï¼Œå°±ä¸èƒ½éš EmuELEC çš„æ›´æ–°è€Œæ›´æ–°ã€‚å“ªæœ‰æ²¡æœ‰åŠæ³•ç›´æ¥å¯åŠ¨åŸç‰ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚é¦–å…ˆå¾—ææ¸…æ¥šä¸ºä»€ä¹ˆN1ä¸èƒ½å¯åŠ¨åŸç‰ˆçš„åŸå› ã€‚é‚£æ˜¯å› ä¸º EmuELEC çš„å†…æ ¸æ‰“åŒ…æˆ Android boot image æ ¼å¼ï¼Œè€Œ N1 çš„ uboot å´åªæ”¯æŒæœªç»å‹ç¼©çš„å†…æ ¸ï¼Œé‚£æˆ‘ä»¬åªè¦æƒ³åŠæ³•ä» EmuELEC çš„ä¸­è§£åŒ…å‡ºæ¥æœªç»å‹ç¼©çš„å†…æ ¸å’Œ initramfs å°±å¯ä»¥äº†ã€‚<br>ä»æ–°ç‰ˆçš„EmuELECé•œåƒä¸­è·å– kernel.imgï¼Œç„¶åä¸‹è½½ <a href="http://whiteboard.ping.se/Android/Unmkbootimg">è¿™ä¸ªé¡µé¢ç‚¹é‚£ä¸ª download ä¸‹è½½ unmkbootimg</a>ï¼Œè§£å‹ï¼Œåœ¨ linux ç¯å¢ƒè¿è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½ unmkbootimg</span></span><br><span class="line">wget http://whiteboard.ping.se/uploads/Android/unmkbootimg.gz</span><br><span class="line">gzip  -d unmkbootimg.gz</span><br><span class="line"><span class="built_in">chmod</span> a+x unmkbootimg</span><br><span class="line"></span><br><span class="line">./unmkbootimg kernel.img  </span><br><span class="line"><span class="comment"># ä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„æ–‡ä»¶ï¼š</span></span><br><span class="line">initramfs.cpio.gz  </span><br><span class="line">zImage</span><br><span class="line"><span class="comment"># åŒæ—¶è®°ä½è¾“å‡ºé‡Œçš„  Kernel address</span></span><br><span class="line">To recompile this image, use:</span><br><span class="line">  mkbootimg --kernel zImage --ramdisk initramfs.cpio.gz ...</span><br></pre></td></tr></table></figure><p>å¦‚æœæ­¤æ—¶éœ€è¦ä¿®æ”¹å¼€æœºå›¾ç‰‡çš„è¯ï¼Œå¯ä»¥æ‰§è¡Œä¸‹é¢æ“ä½œï¼Œè¿™ä¸ªæ­¥éª¤æ˜¯é€šç”¨çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> initramfs</span><br><span class="line"><span class="built_in">cd</span> initramfs</span><br><span class="line"><span class="comment"># æˆ‘çœ‹æœ‰äº› initramfs.cpio.gz å¹¶ä¸æ˜¯ gzipå‹ç¼©çš„ï¼Œæ‰€ä»¥ä¸‹é¢æŠ¥é”™çš„è¯å…ˆè¯•è¯• file initramfs.cpio.gz çœ‹çœ‹ï¼Œæ˜¯ gzipçš„è¯å°± gzip -d initramfs.cpio.gz</span></span><br><span class="line">cpio -idmv &lt; ../initramfs.cpio.gz</span><br><span class="line"><span class="comment"># æ›¿æ¢ splash/ä¸‹çš„ splash-1080.png å³å¯ï¼Œå¿…é¡»æ ¼å¼ä¹Ÿæ˜¯ï¼Œè€Œä¸æ˜¯åç¼€</span></span><br><span class="line"><span class="built_in">ls</span> -l splash/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢å®Œæˆåæ‰“åŒ…å› initramfs.cpio.gz</span></span><br><span class="line"><span class="comment"># find . | cpio --create --format=&#x27;newc&#x27; &gt; ../initramfs.cpio.gz</span></span><br><span class="line">find . -print0 | cpio --null --create --format=newc &gt; ../initramfs.cpio.gz</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="comment"># æŠŠä¸Šé¢ unmkbootimg è¾“å‡ºçš„ mkbootimg å‘½ä»¤æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># https://github.com/EmuELEC/EmuELEC/search?q=mkbootimg  https://github.com/EmuELEC/EmuELEC/search?q=ANDROID_BOOTIMG_OPTIONS</span></span><br><span class="line">mkbootimg --kernel zImage --ramdisk initramfs.cpio.gz --base 0x0 --kernel_offset 0x1080000 -o new_kernel.img</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„æ²¡è¯•è¿‡ï¼Œä¸»è¦æ˜¯ N1 çš„æ­¥éª¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># https://www.right.com.cn/forum/thread-6632323-1-1.html</span><br><span class="line"># æŠŠ initramfs.cpio.gz æ‰“åŒ…æˆ uInitrdã€‚</span><br><span class="line">mkimage -A arm64 -O linux -T kernel -C none -d initramfs.cpio.gz uInitrd</span><br><span class="line"></span><br><span class="line">#è¿™é‡Œå¾—åˆ°çš„ kernel å°±æ˜¯æœªå‹ç¼©çš„å†…æ ¸ï¼ŒæŠŠä»–æ”¹åæˆ kernel.imgã€‚</span><br><span class="line">lzop -d zImage -o kernel.img.new</span><br></pre></td></tr></table></figure><p>å¤§åŠŸå‘Šæˆï¼ŒæŠŠ kernel.img å’Œ uInitrd æ›¿æ¢è¡¥ä¸é‡Œçš„åŒåæ–‡ä»¶ï¼Œå¯åŠ¨æ—¶å°±æ˜¯ç”¨åŸç‰ˆå†…æ ¸äº†</p><h3 id="å¼€æœºå¯åŠ¨é¡ºåº"><a href="#å¼€æœºå¯åŠ¨é¡ºåº" class="headerlink" title="å¼€æœºå¯åŠ¨é¡ºåº"></a>å¼€æœºå¯åŠ¨é¡ºåº</h3><p><a href="https://blog.csdn.net/michaelchain/article/details/119628601">https://blog.csdn.net/michaelchain/article/details/119628601</a> å‚è€ƒè¿™ä¸ªï¼Œæ›´å¤šçš„ä¸å†™è¿›æ¥äº†</p><p>è¿™ä¸ªæ˜¯åœ¨ uboot ä¸­è¿›è¡Œç®¡ç†çš„, å¯ä»¥é€šè¿‡ <code>fw_printenv</code> å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">EmuELEC:~ # fw_printenv</span><br><span class="line">...</span><br><span class="line">baudrate=115200</span><br><span class="line">boot_count=0</span><br><span class="line">bootcmd=if test $&#123;bootfromnand&#125; = 1; then setenv bootfromnand 0; saveenv; else run bootfromsd; run bootfromusb; fi; run storeboot</span><br><span class="line">bootcount_check=echo bootcounts=$&#123;boot_count&#125;; if itest $&#123;boot_count&#125; == 0; then setenv boot_count 1;saveenv;else if itest $&#123;boot_count&#125; == 1; then setenv boot_count 2;saveenv;else if itest $&#123;boot_count&#125; == 2; then setenv boot_count 3;saveenv;else if itest $&#123;boot_count&#125; == 3; then setenv boot_count 4;saveenv;else if itest $&#123;boot_count&#125; == 4; then run recovery_from_flash;fi;fi;fi;fi;fi</span><br><span class="line">bootdelay=0</span><br><span class="line">bootfromnand=0</span><br><span class="line">bootfromsd=mmcinfo; if fatload mmc 0 $&#123;loadaddr&#125; kernel.img; then run sddtb; setenv bootargs $&#123;bootargs&#125; bootfromsd; bootm; fi</span><br><span class="line">bootfromusb=usb start 0; if fatload usb 0 $&#123;loadaddr&#125; kernel.img; then run usbdtb; setenv bootargs $&#123;bootargs&#125; bootfromusb; bootm; fi</span><br><span class="line">bootmode_check=get_rebootmode; echo reboot_mode=$&#123;reboot_mode&#125;;if test $&#123;reboot_mode&#125; = factory_reset; then defenv_reserv;setenv upgrade_step 2; save;fi;</span><br><span class="line">cmdline_keys=if keyman init 0x1234; then if sec_keyunify read mac $&#123;loadaddr&#125; str; then setenv bootargs $&#123;bootargs&#125; mac=$&#123;mac&#125; androidboot.mac=$&#123;mac&#125;;fi;fi;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶ä¸­çš„ bootfromnand å˜é‡æ˜¯ç”¨äºæ§åˆ¶è®¾å¤‡çš„å¯åŠ¨é¡ºåº, å¦‚æœå€¼ä¸º1, é‚£ä¹ˆä»nand(è®¾å¤‡å†…éƒ¨å­˜å‚¨, eMMCç­‰), å¦‚æœå€¼ä¸º0, é‚£ä¹ˆä¾æ¬¡ä»sd, ä»usbå¯åŠ¨, åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœæŸä¸ªä»‹è´¨å¯ä»¥å¯åŠ¨äº†, å°±æŠŠè¿™ä¸ªæ–¹å¼åŠ åˆ°bootargså˜é‡çš„å€¼å½“ä¸­å», ä¾‹å¦‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs $&#123;bootargs&#125; bootfromsd;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;EmuELEC-ç¬”è®°&quot;&gt;&lt;a href=&quot;#EmuELEC-ç¬”è®°&quot; class=&quot;headerlink&quot; title=&quot;EmuELEC ç¬”è®°&quot;&gt;&lt;/a&gt;EmuELEC ç¬”è®°&lt;/h1&gt;&lt;p&gt;åç»­å…³äº EmuELEC çš„ç¬”è®°å’ŒçŸ¥è¯†ç‚¹éƒ½ä¼šåœ¨è¿™é‡Œæ›´æ–°ï¼Œå‡å®šçœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„äºº</summary>
      
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="EmuELEC" scheme="http://zhangguanzhang.github.io/tags/EmuELEC/"/>
    
  </entry>
  
  <entry>
    <title>openwrt çš„åœ¨çº¿å‡çº§å›ºä»¶å’Œæ‰©å®¹çš„ç ”ç©¶</title>
    <link href="http://zhangguanzhang.github.io/2021/12/19/openwrt-update/"/>
    <id>http://zhangguanzhang.github.io/2021/12/19/openwrt-update/</id>
    <published>2021-12-19T21:28:30.000Z</published>
    <updated>2021-12-19T21:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ‰‹ä¸Šæœ‰ r2sã€N1 å’Œ x86_64 çš„å›ºä»¶ç»´æŠ¤ï¼Œr2s çš„å‚ç…§åˆ«äººçš„è„šæœ¬æäº†åœ¨çº¿å‡çº§å›ºä»¶çš„è„šæœ¬ï¼Œåˆ«äººçš„è„šæœ¬åªæ”¯æŒ ext4 å‡çº§ï¼Œè€Œåé¢æˆ‘ä¹ŸæŠŠ squashfs æ ¼å¼çš„å›ºä»¶å‡çº§æå‡ºæ¥äº†ã€‚æ©å±±ä¸Šæœ‰çš„äººçš„å›ºä»¶æˆ‘ä¹Ÿçœ‹ x86_64 ä¹Ÿå¯ä»¥åœ¨çº¿å‡çº§ï¼Œåé¢æˆ‘ä¹Ÿä¼šå»æµ‹ä¸‹ x86_64 çš„ï¼Œç†è®ºä¸Šæ˜¯é€šç”¨çš„ã€‚</p><h2 id="å‡çº§è¿‡ç¨‹"><a href="#å‡çº§è¿‡ç¨‹" class="headerlink" title="å‡çº§è¿‡ç¨‹"></a>å‡çº§è¿‡ç¨‹</h2><p>ä»¥ r2s ä¸ºä¾‹è®²è§£ã€‚å‚ç…§ç›®å‰çœ‹åˆ°çš„çš„ <a href="https://github.com/klever1988/nanopi-openwrt/raw/master/scripts/autoupdate.sh">1988 çš„å‡çº§è„šæœ¬</a> ï¼Œæœ€åˆçš„äººä¸çŸ¥é“æ˜¯è°æçš„åœ¨çº¿å‡çº§ï¼Œå› ä¸ºå¾ˆä¹…ä¹‹å‰å°±çœ‹åˆ°æœ‰äº›äººçš„å›ºä»¶èƒ½åœ¨çº¿å‡çº§äº†ã€‚</p><h3 id="å‡çº§å‰å‡†å¤‡"><a href="#å‡çº§å‰å‡†å¤‡" class="headerlink" title="å‡çº§å‰å‡†å¤‡"></a>å‡çº§å‰å‡†å¤‡</h3><h4 id="ç›¸å…³å‘½ä»¤"><a href="#ç›¸å…³å‘½ä»¤" class="headerlink" title="ç›¸å…³å‘½ä»¤"></a>ç›¸å…³å‘½ä»¤</h4><p>ç¡®ä¿å›ºä»¶æœ‰ä¸‹é¢å‘½ä»¤ï¼š</p><table><thead><tr><th align="left">command</th><th align="left">package name</th><th align="left">ç”¨é€”</th></tr></thead><tbody><tr><td align="left">parted</td><td align="left">parted</td><td align="left">ä¿®æ”¹åˆ†åŒºå’Œè·å–åˆ†åŒºä¿¡æ¯</td></tr><tr><td align="left">losetup</td><td align="left">losetup</td><td align="left">loop device å‘½ä»¤ï¼Œç”¨äºæŒ‚è½½å›ºä»¶é‡Œçš„æ–‡ä»¶åˆ†åŒº</td></tr><tr><td align="left">resize2fs</td><td align="left">resize2fs</td><td align="left">resize ext4 éœ€è¦</td></tr><tr><td align="left">truncate</td><td align="left">coreutils-truncate</td><td align="left">å¡«å……å’Œæ¸…ç©ºæ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯å¡«å……æ‰©å®¹</td></tr><tr><td align="left">curl</td><td align="left">curl</td><td align="left">ä¸‹è½½ï¼Œä»¥åŠhttp è°ƒç”¨ä¸€äº› api</td></tr><tr><td align="left">wget</td><td align="left">wget</td><td align="left">ä¸‹è½½å‘½ä»¤</td></tr><tr><td align="left">mksquashfs</td><td align="left">squashfs-tools-mksquashfs</td><td align="left">squashfsæ ¼å¼éœ€è¦</td></tr><tr><td align="left">unsquashfs</td><td align="left">squashfs-tools-unsquashfs</td><td align="left">squashfsæ ¼å¼éœ€è¦</td></tr></tbody></table><h4 id="KERNEL-PARTSIZE-å’Œ-ROOTFS-PARTSIZE"><a href="#KERNEL-PARTSIZE-å’Œ-ROOTFS-PARTSIZE" class="headerlink" title="KERNEL_PARTSIZE å’Œ ROOTFS_PARTSIZE"></a>KERNEL_PARTSIZE å’Œ ROOTFS_PARTSIZE</h4><p><code>CONFIG_TARGET_KERNEL_PARTSIZE</code> å’Œ <code>CONFIG_TARGET_ROOTFS_PARTSIZE</code> æ˜¯ <code>.config</code> æ–‡ä»¶é‡Œçš„ï¼Œå•ä½æ˜¯ <code>M</code>ï¼Œå‰è€…æ˜¯ç±»ä¼¼å¸¸è§„å¤§å‹ linux os é‡Œçš„ <code>/boot</code> åˆ†åŒºï¼Œopenwrt é»˜è®¤å°±åªæœ‰è¿™ä¸¤ä¸ªåˆ†åŒºã€‚</p><p>r2s çš„è¯ <code>KERNEL_PARTSIZE</code> ä¸€èˆ¬ <code>12M</code> å°±å¤Ÿç”¨äº†ï¼Œä½†æ˜¯å¾ˆå¤šç½‘ä¸Šäº’ç›¸æŠ„çš„äººåœ¨ r2s çš„ <code>.config</code> é‡Œç»™ 32ã€64 ä¹‹ç±»çš„éå¸¸æµªè´¹ã€‚<code>ROOTFS_PARTSIZE</code> æ˜¯æœ€ç»ˆçš„æ ¹åˆ†åŒºå¤§å°ï¼Œç»™å°äº†å› ä¸ºç¼–è¯‘å¸¦å¾ˆå¤šæ’ä»¶ï¼Œå¯¼è‡´æœ€ç»ˆçš„æ‰“åŒ…é•œåƒå®¹é‡ä¸å¤Ÿï¼Œæˆ‘çš„å›ºä»¶æ˜¯ <code>635</code>ã€‚ç„¶å r2s æ˜¯å†…å­˜å¡ï¼Œä¸€èˆ¬ç°åœ¨å†…å­˜å¤§å¤§å°éƒ½æ˜¯ 4G ä»¥ä¸Šï¼Œä¹Ÿå°±æ˜¯åˆ·å®Œå›ºä»¶åï¼Œæ ¹åˆ†åŒºå°±æ˜¯ 635M ï¼Œå¡çš„å‰©ä¸‹ç©ºé—´éƒ½æ²¡ä½¿ç”¨ï¼Œå½“ç„¶ï¼Œx86_64 ä¹Ÿæ˜¯ä¸€æ ·çš„é—®é¢˜ã€‚æ‰€ä»¥å°±æœ‰äº†è¿™ä¸ªå‡çº§é¡ºå¸¦æ‰©å®¹çš„æ­¥éª¤ã€‚</p><h4 id="æå‰çš„å®¹é‡å­˜å‚¨æ–°å›ºä»¶"><a href="#æå‰çš„å®¹é‡å­˜å‚¨æ–°å›ºä»¶" class="headerlink" title="æå‰çš„å®¹é‡å­˜å‚¨æ–°å›ºä»¶"></a>æå‰çš„å®¹é‡å­˜å‚¨æ–°å›ºä»¶</h4><p>1988 çš„å›ºä»¶éå¸¸å°ï¼Œä¸‹è½½ 300Mï¼Œä»ä¸€ä¸ªæ–°æ‰‹åˆæ¬¡å°è¯•æ¥è¯´ï¼Œå¾ˆå¯èƒ½å°´å°¬çš„æƒ…å†µå°±æ˜¯å¡åˆ·å rootfs æ˜¯ 600Mï¼Œç„¶åå¯ç”¨å°±200Mï¼Œå›ºä»¶å‹ç¼©å350Mï¼Œæ‰€ä»¥æˆ‘å›ºä»¶åœ¨åˆæ¬¡æ‰©å®¹å‡çº§ä¼šæš‚æ—¶æ–°å»ºä¸€ä¸ªåˆ†åŒºï¼Œç”¨äºå­˜å‚¨ä¸‹è½½å‡çº§çš„å›ºä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸€èˆ¬å¾ˆå¤šå›ºä»¶ /opt å•ç‹¬æŒ‚è½½ï¼Œæˆ–è€…å±äº / ï¼Œæ‰€ä»¥å¦‚æœå·²ç»åœ¨å‡çº§é˜¶æ®µæ‰©å®¹äº†ï¼Œå›ºä»¶å°±å­˜ /optä¸‹ï¼Œæ²¡æ‰©å®¹è¿‡ï¼Œå°±å­˜æŒ‚è½½ç‚¹ /tmp/update/download</span></span><br><span class="line">if [ $(df  -m /opt | awk &#x27;NR==2&#123;print $4&#125;&#x27;) -lt 2400 ];then</span><br><span class="line">    NEED_GROW=1</span><br><span class="line">    mkdir -p /tmp/update/download</span><br><span class="line">    warning &#x27;æ£€æµ‹åˆ°å½“å‰æœªæ‰©å®¹ï¼Œå…ˆå€Ÿç”¨åˆç‰ˆå›ºä»¶æ‰©å®¹ï¼Œåç»­è¯·å†æ‰§è¡Œå‡çº§è„šæœ¬&#x27;</span><br><span class="line">    df -h</span><br><span class="line">    parted /dev/$block_device p</span><br><span class="line">    # è¯¥æ–‡ä»¶å­˜ part_num ï¼Œé˜²æ­¢æœºå™¨é‡å¯åé‡å¤æ–°å»ºäº†åˆ†åŒºè¡¨</span><br><span class="line">    if [ ! -f &#x27;/opt/.parted&#x27; ];then</span><br><span class="line">        start_sec=$(parted /dev/$block_device unit s print free | awk &#x27;$1~&quot;s&quot;&#123;a=$1&#125;END&#123;print a&#125;&#x27;)</span><br><span class="line">        parted /dev/$block_device mkpart p ext4 $&#123;start_sec&#125; 4G</span><br><span class="line">        part_num=$( parted /dev/$block_device p | awk &#x27;$5==&quot;primary&quot;&#123;a=$1&#125;END&#123;print a&#125;&#x27; )</span><br><span class="line">        sleep 3 # æ­¤å¤„ä¼šè‡ªåŠ¨æŒ‚è½½é€ æˆè›‹ç–¼</span><br><span class="line">        if grep -E /dev/$&#123;block_device&#125;p$&#123;part_num&#125; /proc/mounts;then</span><br><span class="line">            if mountpoint -q  /mnt/$&#123;block_device&#125;p$&#123;part_num&#125;;then</span><br><span class="line">                touch /mnt/$&#123;block_device&#125;p$&#123;part_num&#125;/test &amp;&gt;/dev/null || NEED_MKFS=1</span><br><span class="line">                umount /mnt/$&#123;block_device&#125;p$&#123;part_num&#125;</span><br><span class="line">            fi</span><br><span class="line">            [ -n &quot;$NEED_MKFS&quot; ] &amp;&amp; mkfs.ext4 -F /dev/$&#123;block_device&#125;p$&#123;part_num&#125;</span><br><span class="line">        else</span><br><span class="line">            mkfs.ext4 -F /dev/$&#123;block_device&#125;p$&#123;part_num&#125;</span><br><span class="line">        fi</span><br><span class="line">        echo $&#123;part_num&#125; &gt; /opt/.parted</span><br><span class="line">    else</span><br><span class="line">        part_num=$(cat /opt/.parted)</span><br><span class="line">    fi</span><br><span class="line">    mountpoint -q  /tmp/update/download || mount /dev/$&#123;block_device&#125;p$&#123;part_num&#125; /tmp/update/download</span><br><span class="line">    USER_FILE=/tmp/update/download/openwrt.img.gz</span><br><span class="line">    rm -f $&#123;USER_FILE&#125;</span><br><span class="line">    # å› ä¸ºåˆæ¬¡æ²¡æ‰©å®¹ï¼Œæˆ‘çš„å›ºä»¶æ˜¯å­˜æ”¾åœ¨ docker é•œåƒé‡Œçš„ï¼Œå¯èƒ½æ‹‰å– docker é•œåƒå°±å®¹é‡æ»¡äº†ï¼Œæ‰€ä»¥æˆ‘å•ç‹¬æœ‰ä¸ªrelease å­˜æ”¾ç¼–è¯‘å¥½çš„å›ºä»¶ï¼Œç›´æ¥ä¸‹è½½ï¼Œç”¨äºåˆæ¬¡</span><br><span class="line">    wget https://ghproxy.com/https://github.com/zhangguanzhang/Actions-OpenWrt/releases/download/fs/openwrt-rockchip-armv8-friendlyarm_nanopi-r2s-ext4-sysupgrade.img.gz -O $&#123;USER_FILE&#125;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>å¯¹äºåé¢çš„ä¸‹è½½æ–°ç‰ˆæœ¬å›ºä»¶ï¼Œ1988 çš„è„šæœ¬æˆ‘çœ‹ä»–æ˜¯ github action æ¯å¤©å®šæ—¶ç¼–è¯‘å‘å¸ƒå­˜ releaseï¼Œæ„Ÿè§‰åé¢ä»–å¯èƒ½ä¼šè¢« github ç»™ banäº†ã€‚ æˆ‘è„šæœ¬é‡Œæ˜¯å­˜ docker hub çš„é•œåƒé‡Œï¼Œæˆ‘çš„å›ºä»¶éƒ½è‡ªå¸¦ dockerï¼Œdocker æ‹‰å–é•œåƒåæå–é•œåƒæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;$&#123;BUILD_DIR&#125;/Dockerfile &lt;&lt; EOF</span><br><span class="line">FROM alpine</span><br><span class="line">LABEL FILE=$file</span><br><span class="line">LABEL NUM=$&#123;GITHUB_RUN_NUMBER&#125;</span><br><span class="line">COPY * /</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>github action ä¸Šåˆ©ç”¨ buildx æ„å»ºå­˜å‚¨è¿™ä¸ªé•œåƒï¼Œç”¨ LABEL æŒ‡å®šæ–‡ä»¶è·¯å¾„åï¼Œç›´æ¥ copy å‡ºæ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull zhangguanzhang/r2s:$&#123;VER&#125;</span><br><span class="line">CTR_PATH=$( docker inspect zhangguanzhang/r2s:$&#123;VER&#125; --format &#x27;&#123;&#123; .Config.Labels &#125;&#125;&#x27; | grep -Eo &#x27;openwrt-.+img.gz&#x27; )</span><br><span class="line">docker create --name update zhangguanzhang/r2s:$&#123;VER&#125;</span><br><span class="line">docker cp update:/$&#123;CTR_PATH&#125; $&#123;USER_FILE&#125;</span><br><span class="line">docker rm update</span><br><span class="line">docker rmi zhangguanzhang/r2s:$&#123;VER&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰©å®¹å’Œå‡çº§"><a href="#æ‰©å®¹å’Œå‡çº§" class="headerlink" title="æ‰©å®¹å’Œå‡çº§"></a>æ‰©å®¹å’Œå‡çº§</h3><p>å›ºä»¶åˆ†ä¸ºä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ŒSquashFS å’Œ Ext4ã€‚</p><p>SquashFSï¼ˆæ¨èï¼‰ï¼šå›ºä»¶æ–‡ä»¶åå¸¦æœ‰ â€œsquashfsâ€ï¼ŒSquashFS ä¸ºåªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒç³»ç»Ÿè¿˜åŸï¼ˆæ”¯æŒç‰©ç† ResetæŒ‰é’® è¿˜åŸï¼‰ï¼Œæ”¯æŒåå°å›ºä»¶å‡çº§ï¼Œæ›´èƒ½é¿å… SD å¡æ–‡ä»¶ç³»ç»Ÿè§¦å‘å†™ä¿æŠ¤ï¼Œé€‚åˆç»å¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨ã€‚</p><p>Ext4ï¼šå›ºä»¶æ–‡ä»¶åå¸¦æœ‰ â€œext4â€ï¼ŒExt4 æ–‡ä»¶ç³»ç»Ÿå…·å¤‡æ•´ä¸ªåˆ†åŒºå¯è¯»å†™æ€§è´¨ï¼Œæ›´é€‚åˆç†Ÿæ‚‰ Linux ç³»ç»Ÿçš„ç”¨æˆ·ä½¿ç”¨ï¼Œä½†æ„å¤–æ–­ç”µæœ‰å‡ ç‡é€ æˆåˆ†åŒºå†™å…¥ä¿æŠ¤ã€‚</p><h4 id="ext4"><a href="#ext4" class="headerlink" title="ext4"></a>ext4</h4><p>å‰é¢ä¸¤ä¸ªç« èŠ‚æ˜¯ä¸‹è½½å’Œå­˜æ”¾å›ºä»¶ img.gz ï¼Œç°åœ¨å¼€å§‹æ‰©å®¹å’Œå‡çº§ï¼Œæ‰©å®¹å°±æ˜¯åˆ©ç”¨ truncate ä¸‹å›ºä»¶æ–‡ä»¶çš„å¤§å°ï¼Œç„¶åä¿®å¤å›ºä»¶æ–‡ä»¶é‡Œçš„ç¬¬äºŒä¸ªåˆ†åŒºã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å› ä¸ºæœ€ç»ˆä¼šæŠŠä¿®æ”¹åçš„å›ºä»¶å†™å…¥åˆ°æ ¹åˆ†åŒºæ‰€åœ¨çš„å—è®¾å¤‡ï¼Œæ‰€ä»¥å›ºä»¶éœ€è¦å­˜æ”¾åœ¨ /tmp ç›®å½•ä¸‹</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤§å°å’Œå†…å­˜æŒ‚é’©ï¼Œæ‰€ä»¥ä¸è¦sizeå¤ªå¤§</span></span><br><span class="line">mount -t tmpfs -o remount,size=870m tmpfs /tmp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åé¢çš„ <span class="literal">true</span> æ˜¯å› ä¸º github action çš„æ‰“åŒ…ä¼šå½±å“è§£å‹ï¼Œè™½ç„¶æœ€ç»ˆæŠ¥é”™ï¼Œä½†æ˜¯è§£å‹çš„å›ºä»¶è¿˜æ˜¯èƒ½ç”¨çš„</span></span><br><span class="line">gzip -dc openwrt.img.gz &gt; /tmp/update/openwrt.img || true</span><br><span class="line"></span><br><span class="line">block_device=&#x27;mmcblk0&#x27;</span><br><span class="line">[ ! -d /sys/block/$block_device ] &amp;&amp; block_device=&#x27;mmcblk1&#x27;</span><br><span class="line">bs=`expr $(cat /sys/block/$block_device/size) \* 512`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹æ–‡ä»¶å¤§å°</span></span><br><span class="line">truncate -s $bs /tmp/update/openwrt.img</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ç¬¬äºŒä¸ªåˆ†åŒºå¤§å°ï¼Œ1988ç”¨çš„æ˜¯ <span class="built_in">echo</span> <span class="string">&quot;, +&quot;</span> | sfdisk -N 2 /tmp/update/openwrt.img å¯è¯»æ€§ä¸å¥½</span></span><br><span class="line">parted /tmp/update/openwrt.img resizepart 2 100%</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†é•œåƒæ–‡ä»¶è™šæ‹Ÿæˆå—è®¾å¤‡ï¼Œç±»ä¼¼äº windows çš„é‚£ç§åŒå‡» iso åçš„è£…è½½ iso ï¼Œå¯¹äºå—è®¾å¤‡çš„æ“ä½œéƒ½ä¼šæ—¶åˆ»å†™å…¥åˆ° img æ–‡ä»¶é‡Œ</span></span><br><span class="line">lodev=$(losetup -f)</span><br><span class="line">losetup -P $lodev /tmp/update/openwrt.img</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒ‚è½½ rootfs è§£å‹å¤‡ä»½æ–‡ä»¶</span></span><br><span class="line">mkdir -p /mnt/img</span><br><span class="line">mount -t ext4 $&#123;lodev&#125;p2 /mnt/img</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">op çš„å¤‡ä»½å‘½ä»¤</span></span><br><span class="line">sysupgrade -b back.tar.gz</span><br><span class="line">tar zxf back.tar.gz -C /mnt/img</span><br><span class="line">    if ! grep -q macaddr /etc/config/network; then</span><br><span class="line">        warning &#x27;æ³¨æ„ï¼šç”±äºå·²çŸ¥çš„é—®é¢˜ï¼Œâ€œç½‘ç»œæ¥å£â€é…ç½®æ— æ³•ç»§æ‰¿ï¼Œé‡å¯åéœ€è¦é‡æ–°è®¾ç½®WANæ‹¨å·å’ŒLANç½‘æ®µä¿¡æ¯&#x27;</span><br><span class="line">        rm /mnt/img/etc/config/network;</span><br><span class="line">    fi</span><br><span class="line">mountpoint -q  /mnt/img &amp;&amp; umount /mnt/img</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">openwrt å­˜åœ¨ auto mountï¼Œæ­¤å¤„å–æ¶ˆæŒ‚è½½</span></span><br><span class="line">grep -q $&#123;lodev&#125;p1 /proc/mounts &amp;&amp; umount $&#123;lodev&#125;p1</span><br><span class="line">grep -q $&#123;lodev&#125;p2 /proc/mounts &amp;&amp; umount $&#123;lodev&#125;p2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®å¤å›ºä»¶é‡Œæ‰©å®¹çš„åˆ†åŒº</span></span><br><span class="line">e2fsck -yf $&#123;lodev&#125;p2 || true</span><br><span class="line">resize2fs $&#123;lodev&#125;p2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å–æ¶ˆ img æ–‡ä»¶çš„æŒ‚è½½</span></span><br><span class="line">losetup -d $lodev</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/sysrq</span><br><span class="line">echo u &gt; /proc/sysrq-trigger &amp;&amp; umount / || true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿™ä¸ª ddnz å‘½ä»¤ä»ä»–é‚£é‡Œå¤åˆ¶çš„</span></span><br><span class="line">/tmp/ddnz /tmp/update/openwrt.img /dev/$block_device</span><br><span class="line">printf &#x27;%b\n&#x27; &quot;\033[1;32m[SUCCESS] åˆ·æœºå®Œæ¯•ï¼Œæ­£åœ¨é‡å¯...\033[0m&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯</span></span><br><span class="line">echo b &gt; /proc/sysrq-trigger</span><br></pre></td></tr></table></figure><h4 id="squashfs"><a href="#squashfs" class="headerlink" title="squashfs"></a>squashfs</h4><p>openwrt çš„å¦ä¸€ç§æ–‡ä»¶ç³»ç»Ÿå›ºä»¶ï¼Œå°±æ˜¯ä¸€ä¸ªåªå¯è¯»å†™çš„å‹ç¼©çš„ rootfs è§£å‹å¼€ä½œä¸º <code>overlay</code> çš„ lower dir åªè¯»ï¼Œæä¾›ç»™ç”¨æˆ·çš„æ˜¯ overlay çš„ upper dir å»å†™å…¥ï¼Œé•¿æŒ‰è®¾å¤‡ä¸Šçš„ reset æŒ‰é’®æ¢å¤å‡ºå‚è®¾ç½®å°±æ˜¯æŠŠ overlay çš„ä¸Šå±‚ä¸¢å¼ƒæ‰ï¼Œæ‰€ä»¥ squashfs ç±»å‹çš„å›ºä»¶å¸¦å¿«ç…§åŠŸèƒ½ã€‚å½“ç„¶å¸‚é¢ä¸Šæœäº†ä¸‹ä¹Ÿæ²¡æ‰¾åˆ° squashfs ç±»å‹çš„å›ºä»¶åœ¨å‡çº§çš„æ—¶å€™æ‰©å®¹çš„æ­¥éª¤ï¼Œè‡ªå·±ç ”ç©¶äº†ä¸‹æå‡ºæ¥äº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒ‚è½½ rootfs è§£å‹å¤‡ä»½æ–‡ä»¶</span></span><br><span class="line">mkdir -p /mnt/img</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿™é‡Œä¼šæŠ¥é”™ wrong fs <span class="built_in">type</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mount -t ext4 <span class="variable">$&#123;lodev&#125;</span>p2 /mnt/img</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¢«æˆ‘æ”¹æˆè¿™æ ·</span></span><br><span class="line">mount $&#123;lodev&#125;p2 /mnt/img</span><br><span class="line">IMG_FSTYPE=$(df -T /mnt/img | awk &#x27;NR==2&#123;print $2&#125;&#x27;)</span><br></pre></td></tr></table></figure><p>å–åˆ°äº† <code>IMG_FSTYPE</code> åèµ°ä¸åŒçš„é€»è¾‘ï¼Œè¿™é‡Œå®ƒçš„å€¼æ˜¯ <code>squashfs</code> ï¼Œè€ŒæŒ‚è½½åçš„ <code>/mnt/img</code> æ˜¯æ— æ³•å†™å…¥ä»»ä½•æ–‡ä»¶çš„ã€‚ç„¶åæœäº†ä¸‹ <code>squashfs</code> ç›¸å…³ï¼Œè‡ªå·±æŠ˜è…¾çš„è¯éœ€è¦ <code>mksquashfs</code> å’Œ <code>unsquashfs</code> çš„ä¸¤ä¸ªå‘½ä»¤ç©ã€‚ä¸€å¼€å§‹æ˜¯å°è¯•è§£å‹ <code>$&#123;lodev&#125;p2</code> ï¼Œç»“æœç»å¸¸ oom ï¼Œå»æ‰¾ squashfs-tools æºç ä½œè€…è¯¢é—®å¦‚ä½•é™åˆ¶å†…å­˜å¾—åˆ°ä¸‹é¢ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># https://github.com/plougher/squashfs-tools/issues/139#issuecomment-991779738</span><br><span class="line">unsquashfs -da 10 -fr 10 $&#123;lodev&#125;p2</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¸€ç›´å¡ç€ï¼Œæ¯•ç«Ÿæœ€åè‚¯å®šè¦é‡æ–° <code>mksquashfs</code> æ‰“åŒ…çš„ï¼Œç„¶åç›´æ¥ cp å¾—äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;$IMG_FSTYPE&quot; = &#x27;squashfs&#x27; ];then</span><br><span class="line">    info &quot;æ£€æµ‹åˆ°ä½¿ç”¨ squashfs å›ºä»¶ï¼Œå¼€å§‹å¯¼å‡ºæ–‡ä»¶ç³»ç»Ÿ&quot;</span><br><span class="line">    # https://github.com/plougher/squashfs-tools/issues/139#issuecomment-991779738</span><br><span class="line">    # unsquashfs -da 10 -fr 10 /dev/loop0p2</span><br><span class="line">    # è¿™ä¸ªè§£å‹å¤ªè€—æ—¶äº†ï¼Œåªèƒ½æ‹·è´æ•´äº†</span><br><span class="line">    mkdir -p /mnt/img_sq</span><br><span class="line">    cp -a /mnt/img/* /mnt/img_sq</span><br><span class="line">    umount /mnt/img/</span><br><span class="line">    rm -rf /mnt/img</span><br><span class="line">    mv /mnt/img_sq /mnt/img</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>ç„¶åè¿™ä¸ªç›®å½•å†™å…¥å¤‡ä»½æ–‡ä»¶ï¼Œç„¶åå°±æ‰“åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mksquashfs /mnt/img /opt/op.squashfs</span><br></pre></td></tr></table></figure><p>ç»“æœæ‰“åŒ…ä¹Ÿç»å¸¸ oom ï¼Œçœ‹äº†ä¸‹å‘½ä»¤çš„å¸®åŠ©ï¼Œå‘ç°æœ‰å†…å­˜é™åˆ¶çš„ï¼ŒåŠ ä¸Šä¹Ÿå¶å°” oom</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mksquashfs /mnt/img /opt/op.squashfs -mem 20M </span><br></pre></td></tr></table></figure><p>æœ€åé€¼æˆ‘ç”¨ <code>oom_score_adj</code> è°ƒæ•´ oom ä¼˜å…ˆçº§äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -998 &gt; /proc/$$/oom_score_adj 2&gt;/dev/null || true</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå®é™…æ‰“åŒ…å¾ˆå¤šé€‰é¡¹çš„ï¼Œå¯ä»¥å…ˆåˆ©ç”¨ <code>unsquashfs</code> çœ‹ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">unsquashfs -s $&#123;lodev&#125;p2 &gt; squashfs.info</span><br><span class="line"></span><br><span class="line">comp=$(awk &#x27;$1==&quot;Compression&quot;&#123;print $2&#125;&#x27; squashfs.info)</span><br><span class="line">sq_block_size=$(awk &#x27;$1==&quot;Block&quot;&#123;print $NF&#125;&#x27; squashfs.info)</span><br><span class="line">xattrs=&#x27;-xattrs&#x27; # CONFIG_SELINUX=y</span><br><span class="line">grep -Eq &#x27;Xattrs.+?not&#x27; squashfs.info &amp;&amp; xattrs=&#x27;-no-xattrs&#x27;</span><br><span class="line"></span><br><span class="line">echo -998 &gt; /proc/$$/oom_score_adj 2&gt;/dev/null || true</span><br><span class="line"></span><br><span class="line">mksquashfs /mnt/img /opt/op.squashfs -comp $&#123;comp&#125; \</span><br><span class="line">    -b $[sq_block_size/1024]k $xattrs -mem 20M</span><br></pre></td></tr></table></figure><p>ç„¶åå†™å…¥åˆ°å—è®¾å¤‡ä¸Š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/opt/op.squashfs of=$&#123;lodev&#125;p2</span><br></pre></td></tr></table></figure><p>ç„¶åå¸è½½ ${lodev} åˆ·å…¥å›ºä»¶å‘ç°æ— æ³•å¼€æœºï¼Œåœ¨ lede çš„æºç é‡Œ find grep åæ‰¾åˆ°äº† mksquashfs å‚æ•°æ¥æºäºæºç ä¸‹ <code>./include/image.mk</code> çš„ <code>SQUASHFSOPT</code> å’Œ <code>define Image/mkfs/squashfs-common</code></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_TARGET_SQUASHFS_BLOCK_SIZE=1024k</span><br><span class="line">SQUASHFS_BLOCKSIZE := <span class="variable">$(CONFIG_TARGET_SQUASHFS_BLOCK_SIZE)</span>k</span><br><span class="line">SQUASHFSOPT := -b <span class="variable">$(SQUASHFS_BLOCKSIZE)</span></span><br><span class="line">SQUASHFSOPT += -p &#x27;/dev d 755 0 0&#x27; -p &#x27;/dev/console c 600 0 0 5 1&#x27;</span><br><span class="line">SQUASHFSOPT += <span class="variable">$(<span class="built_in">if</span> <span class="variable">$(CONFIG_SELINUX)</span>,-xattrs,-no-xattrs)</span></span><br><span class="line">SQUASHFSCOMP := gzip</span><br><span class="line">LZMA_XZ_OPTIONS := -Xpreset 9 -Xe -Xlc 0 -Xlp 2 -Xpb 2</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(CONFIG_SQUASHFS_XZ)</span>,y)</span><br><span class="line">  <span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">filter</span> arm x86 powerpc sparc,<span class="variable">$(LINUX_KARCH)</span>)</span>,)</span><br><span class="line">    BCJ_FILTER:=-Xbcj <span class="variable">$(LINUX_KARCH)</span>   <span class="comment"># ä¾‹å¦‚æ­¤å¤„  -Xbcj x86</span></span><br><span class="line">  <span class="keyword">endif</span></span><br><span class="line">  SQUASHFSCOMP := xz <span class="variable">$(LZMA_XZ_OPTIONS)</span> <span class="variable">$(BCJ_FILTER)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure><p>æœ¬åœ°æä¸ªç¼–è¯‘ openwrt çš„æ—¶å€™ make å¸¦ä¸Š <code>-V=s</code> å¼€è¯¦ç»†ä¿¡æ¯çœ‹åˆ°ä¸‹é¢ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/home/guanzhang/lede/staging_dir/host/bin/mksquashfs4 /home/guanzhang/lede/build_dir/target-aarch64_generic_musl/root-rockchip /home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/root.squashfs -nopad -noappend -root-owned -comp xz -Xpreset 9 -Xe -Xlc 0 -Xlp 2 -Xpb 2  -b 1024k -p <span class="string">&#x27;/dev d 755 0 0&#x27;</span> -p <span class="string">&#x27;/dev/console c 600 0 0 5 1&#x27;</span> -no-xattrs -processors 6</span></span><br><span class="line">Pseudo file &quot;/dev&quot; exists in source filesystem &quot;/home/guanzhang/lede/build_dir/target-aarch64_generic_musl/root-rockchip/dev&quot;.</span><br><span class="line">Ignoring, exclude it (-e/-ef) to override.</span><br><span class="line">Parallel mksquashfs: Using 6 processors</span><br><span class="line">Creating 4.0 filesystem on /home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/root.squashfs, block size 1048576.</span><br><span class="line">[=============================================================-] 8430/8430 100%</span><br><span class="line"></span><br><span class="line">Exportable Squashfs 4.0 filesystem, xz compressed, data block size 1048576</span><br><span class="line">compressed data, compressed metadata, compressed fragments,</span><br><span class="line">no xattrs, compressed ids</span><br><span class="line">duplicates are removed</span><br><span class="line">Filesystem size 135525.99 Kbytes (132.35 Mbytes)</span><br><span class="line">25.39% of uncompressed filesystem size (533693.75 Kbytes)</span><br><span class="line">Inode table size 60908 bytes (59.48 Kbytes)</span><br><span class="line">20.00% of uncompressed inode table size (304503 bytes)</span><br><span class="line">Directory table size 85796 bytes (83.79 Kbytes)</span><br><span class="line">38.42% of uncompressed directory table size (223339 bytes)</span><br><span class="line">Number of duplicate files found 1164</span><br><span class="line">Number of inodes 9212</span><br><span class="line">Number of files 8077</span><br><span class="line">Number of fragments 123</span><br><span class="line">Number of symbolic links  647</span><br><span class="line">Number of device nodes 1</span><br><span class="line">Number of fifo nodes 0</span><br><span class="line">Number of socket nodes 0</span><br><span class="line">Number of directories 487</span><br><span class="line">Number of ids (unique uids + gids) 1</span><br><span class="line">Number of uids 1</span><br><span class="line">root (0)</span><br><span class="line">Number of gids 1</span><br><span class="line">root (0)</span><br></pre></td></tr></table></figure><p>å¤§è‡´å‚æ•°å°±æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-nopad -noappend -root-owned -comp xz -Xpreset 9 -Xe -Xlc 0 -Xlp 2 -Xpb 2  -b 1024k -p &#x27;/dev d 755 0 0&#x27; -p &#x27;/dev/console c 600 0 0 5 1&#x27; -no-xattrs -processors 6</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ openwrt å’Œ Centos ä¸Šå®‰è£…çš„ <code>squashfs-tools</code> çš„ mksquashfs xz å‹ç¼©æ—¶å€™éƒ½æ²¡æœ‰ <code>-Xpreset 9 -Xe -Xlc 0 -Xlp 2 -Xpb 2</code> è¿™äº›å‚æ•°ï¼Œåé¢å‘ç°äº†æ˜¯ openwrt ç¼–è¯‘çš„æ—¶å€™ä¸‹è½½ squashfs-tools åæ‰“äº† patch ç¼–è¯‘åæ‰æœ‰çš„ï¼Œä¸è¿‡åé¢æµ‹è¯•è¿™å‡ ä¸ªé€‰é¡¹ä¸å½±å“ã€‚åŒæ—¶çœ‹åˆ°äº†æ‰“åŒ…çš„è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PADDING=1 /home/guanzhang/lede/scripts/gen_image_generic.sh /home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/tmp/openwrt-rockchip-armv8-friendlyarm_nanopi-r2s-squashfs-sysupgrade.img.gz 18 /home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/tmp/openwrt-rockchip-armv8-friendlyarm_nanopi-r2s-squashfs-sysupgrade.img.gz.boot 635 /home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/root.squashfs 32768</span><br></pre></td></tr></table></figure><p>å¾—åˆ°äº†å‚æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ dd if=/dev/zero of=/home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/tmp/openwrt-rockchip-armv8-friendlyarm_nanopi-r2s-squashfs-sysupgrade.img.gz bs=512 seek=131072 conv=notrunc count=1300480</span><br><span class="line">1300480+0 records in</span><br><span class="line">1300480+0 records out</span><br><span class="line">665845760 bytes (666 MB, 635 MiB) copied, 2.12896 s, 313 MB/s</span><br><span class="line">+ dd if=/home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/root.squashfs of=/home/guanzhang/lede/build_dir/target-aarch64_generic_musl/linux-rockchip_armv8/tmp/openwrt-rockchip-armv8-friendlyarm_nanopi-r2s-squashfs-sysupgrade.img.gz bs=512 seek=131072 conv=notrunc</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯ç›´æ¥å†™ img æ–‡ä»¶çš„ï¼Œè¿™é‡Œè™½ç„¶æ˜¾ç¤ºçš„æ˜¯ img.gz ï¼Œä½†æ˜¯å¦‚æœå‹ç¼©åçš„æ–‡ä»¶çš„è¯ï¼Œé‚£ seek å¤§å°å°±ä¸å¯¹ã€‚å®é™…ä¸Šåé¢æ‰å‹ç¼©çš„ï¼Œæ‰€ä»¥æˆ‘çš„å‚æ•°ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">part2_seek=$(parted /tmp/update/openwrt.img u s p | awk &#x27;$1==2&#123;print +$2&#125;&#x27;)</span><br><span class="line">mksquashfs /mnt/img /opt/op.squashfs -nopad -noappend -root-owned \</span><br><span class="line">    -comp $&#123;comp&#125; $&#123;LZMA_XZ_OPTIONS&#125; \</span><br><span class="line">    -b $[sq_block_size/1024]k \</span><br><span class="line">    -p &#x27;/dev d 755 0 0&#x27; -p &#x27;/dev/console c 600 0 0 5 1&#x27; \</span><br><span class="line">    $xattrs -mem 20M </span><br><span class="line"></span><br><span class="line">losetup -l -O NAME -n | grep -Eqw $lodev &amp;&amp; losetup -d $lodev</span><br><span class="line">dd if=/opt/op.squashfs of=/tmp/update/openwrt.img bs=512 seek=$&#123;part2_seek&#125; conv=notrunc</span><br></pre></td></tr></table></figure><p>ç„¶åå†™å…¥å³å¯</p><h2 id="æœ€ç»ˆå‚è€ƒ"><a href="#æœ€ç»ˆå‚è€ƒ" class="headerlink" title="æœ€ç»ˆå‚è€ƒ"></a>æœ€ç»ˆå‚è€ƒ</h2><p>æˆ‘çš„è„šæœ¬å½“å‰å­˜æ”¾åœ¨ test åˆ†æ”¯ï¼Œå¯èƒ½åç»­åˆ‡åˆ° main åˆ†æ”¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">https://github.com/zhangguanzhang/Actions-OpenWrt/blob/test/build/scripts/update.sh</span><br><span class="line"></span><br><span class="line">https://github.com/zhangguanzhang/Actions-OpenWrt/blob/main/build/scripts/update.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/klever1988/nanopi-openwrt/raw/master/scripts/autoupdate.sh">1988 çš„å‡çº§è„šæœ¬</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æ‰‹ä¸Šæœ‰ r2sã€N1 å’Œ x86_64 çš„å›ºä»¶ç»´æŠ¤ï¼Œr2s çš„å‚ç…§åˆ«äººçš„è„šæœ¬æäº†åœ¨çº¿å‡çº§å›ºä»¶çš„è„šæœ¬ï¼Œåˆ«äººçš„è„šæœ¬åªæ”¯æŒ ext4 å‡çº§ï¼Œè€Œåé¢</summary>
      
    
    
    
    
    <category term="openwrt" scheme="http://zhangguanzhang.github.io/tags/openwrt/"/>
    
    <category term="squashfs" scheme="http://zhangguanzhang.github.io/tags/squashfs/"/>
    
  </entry>
  
  <entry>
    <title>dockeræ•°æ®ç›˜æŸååå¯åŠ¨æŠ¥é”™ Error starting daemon: Error initializing network controller: Error creating default &quot;bridge&quot; network: package not installed</title>
    <link href="http://zhangguanzhang.github.io/2021/12/12/mod-rejected-by-service/"/>
    <id>http://zhangguanzhang.github.io/2021/12/12/mod-rejected-by-service/</id>
    <published>2021-12-12T23:28:30.000Z</published>
    <updated>2021-12-12T23:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å®¢æˆ·ç°åœºçš„æ•°æ®ç›˜æŸåäº†ï¼Œä¿®å¤å¯åŠ¨æœºå™¨å docker æ— æ³•å¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@db1 docker]# /data/kube/bin/dockerd</span><br><span class="line">WARN[0000] The &quot;graph&quot; config file option is deprecated. Please use &quot;data-root&quot; instead. </span><br><span class="line">WARN[2021-12-11T21:16:07.917969366+08:00] could not change group /var/run/docker.sock to docker: group docker not found </span><br><span class="line">WARN[2021-12-11T21:16:07.942745757+08:00] failed to load plugin io.containerd.snapshotter.v1.btrfs  error=&quot;path /data/kube/docker/containerd/daemon/io.containerd.snapshotter.v1.btrfs must be a btrfs filesystem to be used with the btrfs snapshotter&quot;</span><br><span class="line">WARN[2021-12-11T21:16:07.944020734+08:00] failed to load plugin io.containerd.snapshotter.v1.aufs  error=&quot;modprobe aufs failed: &quot;modprobe: FATAL: Module aufs not found.\n&quot;: exit status 1&quot;</span><br><span class="line">WARN[2021-12-11T21:16:07.944275670+08:00] failed to load plugin io.containerd.snapshotter.v1.zfs  error=&quot;path /data/kube/docker/containerd/daemon/io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter&quot;</span><br><span class="line">WARN[2021-12-11T21:16:07.944314186+08:00] could not use snapshotter btrfs in metadata plugin  error=&quot;path /data/kube/docker/containerd/daemon/io.containerd.snapshotter.v1.btrfs must be a btrfs filesystem to be used with the btrfs snapshotter&quot;</span><br><span class="line">WARN[2021-12-11T21:16:07.944324941+08:00] could not use snapshotter aufs in metadata plugin  error=&quot;modprobe aufs failed: &quot;modprobe: FATAL: Module aufs not found.\n&quot;: exit status 1&quot;</span><br><span class="line">WARN[2021-12-11T21:16:07.944333098+08:00] could not use snapshotter zfs in metadata plugin  error=&quot;path /data/kube/docker/containerd/daemon/io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter&quot;</span><br><span class="line">WARN[2021-12-11T21:16:09.131994686+08:00] Running modprobe bridge br_netfilter failed with message: modprobe: ERROR: could not insert &#x27;bridge&#x27;: Key was rejected by service</span><br><span class="line">modprobe: ERROR: could not insert &#x27;br_netfilter&#x27;: Key was rejected by service</span><br><span class="line">insmod /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko </span><br><span class="line">insmod /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko </span><br><span class="line">, error: exit status 1 </span><br><span class="line">Error starting daemon: Error initializing network controller: Error creating default &quot;bridge&quot; network: package not installed</span><br></pre></td></tr></table></figure><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><h3 id="ç›¸å…³ä¿¡æ¯"><a href="#ç›¸å…³ä¿¡æ¯" class="headerlink" title="ç›¸å…³ä¿¡æ¯"></a>ç›¸å…³ä¿¡æ¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ dockerd --version</span><br><span class="line">Docker version 18.09.3, build 774a1f4</span><br><span class="line">$ uname -a </span><br><span class="line">Linux db1 3.10.0-514.el7.x86_64 #1 SMP Tue Nov 22 16:42:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">$ cat /etc/redhat-release </span><br><span class="line">CentOS Linux release 7.3.1611 (Core) </span><br></pre></td></tr></table></figure><h3 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h3><p>å…ˆçœ‹ä¸‹æ˜¯ä¸æ˜¯æŠŠå†…æ ¸æ¨¡å—ç¦æ­¢äº†ï¼Œå‘ç°æ²¡ç¦æ­¢ï¼Œæ‰‹åŠ¨åŠ è½½ä¹ŸæŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ grep -r black /etc/modprobe.d/*.conf</span><br><span class="line">$ modprobe overlay</span><br><span class="line">$ modprobe bridge</span><br><span class="line">modprobe: ERROR: could not insert &#x27;bridge&#x27;: Key was rejected by service</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹ä¹Ÿæ²¡å¼€å¯ <code>enforcemodulesig</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg | grep enforcemodulesig=1</span><br><span class="line">$ cat /proc/cmdline </span><br><span class="line">BOOT_IMAGE=/vmlinuz-3.10.0-514.el7.x86_64 root=UUID=5ab681a0-7e5c-4ab7-9c88-27d788f725b3 ro crashkernel=auto rhgb quiet LANG=en_US.UTF-8</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯èƒ½æŸ¥çœ‹åˆ°å†…æ ¸æ¨¡å—ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ modinfo bridge</span><br><span class="line">filename:       /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko</span><br><span class="line">alias:          rtnl-link-bridge</span><br><span class="line">version:        2.3</span><br><span class="line">license:        GPL</span><br><span class="line">rhelversion:    7.3</span><br><span class="line">srcversion:     FF0448CD85C271287DE1963</span><br><span class="line">depends:        stp,llc</span><br><span class="line">intree:         Y</span><br><span class="line">vermagic:       3.10.0-514.el7.x86_64 SMP mod_unload modversions </span><br><span class="line">signer:         CentOS Linux kernel signing key</span><br><span class="line">sig_key:        D4:88:63:A7:C1:6F:CC:27:41:23:E6:29:8F:74:F0:57:AF:19:FC:54</span><br><span class="line">sig_hashalgo:   sha256</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰æ˜¯å†…æ ¸ç­¾åå¯¹ä¸ä¸Šï¼ŒæŸ¥çœ‹ä¸‹æ¨¡å—å“ˆå¸Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ md5sum /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko</span><br><span class="line">62001928100a30bace9bc6493b956e2f  /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko</span><br></pre></td></tr></table></figure><p>æ‰¾äº†å¦ä¸€å°æœºå™¨å¯¹æ¯”ä¸‹ï¼Œå‘ç°æ¨¡å—æŸåäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux db2 3.10.0-514.el7.x86_64 #1 SMP Tue Nov 22 16:42:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">$ modinfo bridge</span><br><span class="line">filename:       /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko</span><br><span class="line">alias:          rtnl-link-bridge</span><br><span class="line">version:        2.3</span><br><span class="line">license:        GPL</span><br><span class="line">rhelversion:    7.3</span><br><span class="line">srcversion:     FF0448CD85C271287DE1963</span><br><span class="line">depends:        stp,llc</span><br><span class="line">intree:         Y</span><br><span class="line">vermagic:       3.10.0-514.el7.x86_64 SMP mod_unload modversions </span><br><span class="line">signer:         CentOS Linux kernel signing key</span><br><span class="line">sig_key:        D4:88:63:A7:C1:6F:CC:27:41:23:E6:29:8F:74:F0:57:AF:19:FC:54</span><br><span class="line">sig_hashalgo:   sha256</span><br><span class="line">$ md5sum /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko</span><br><span class="line">41c62afa67e66d107cc2a9e471910726  /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko</span><br></pre></td></tr></table></figure><p>ä¿®å¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/</span><br><span class="line">cp bridge.ko bridge.ko.bak</span><br><span class="line">scp root@xxxx:/lib/modules/3.10.0-514.el7.x86_64/kernel/net/bridge/bridge.ko .</span><br></pre></td></tr></table></figure><p>ç„¶åèƒ½å¯åŠ¨äº†</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.oracle.com/technical-resources/articles/linux/signed-kernel-modules.html">https://www.oracle.com/technical-resources/articles/linux/signed-kernel-modules.html</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å®¢æˆ·ç°åœºçš„æ•°æ®ç›˜æŸåäº†ï¼Œä¿®å¤å¯åŠ¨æœºå™¨å docker æ— æ³•å¯åŠ¨&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext</summary>
      
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>1.15 kubelet åœ¨ nodefs å®¹é‡å¯Œè£•ä¸‹å¾ªç¯ reclaim ephemeral-storage</title>
    <link href="http://zhangguanzhang.github.io/2021/10/29/kubelet-ephemeral-storage-loop-evicted/"/>
    <id>http://zhangguanzhang.github.io/2021/10/29/kubelet-ephemeral-storage-loop-evicted/</id>
    <published>2021-10-29T14:08:06.000Z</published>
    <updated>2021-10-29T14:08:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ•…éšœ"><a href="#æ•…éšœ" class="headerlink" title="æ•…éšœ"></a>æ•…éšœ</h2><p>ç°åœº k8s node å¾ˆå¤š pod éƒ½è¢«ç¡¬æ€§é©±é€æ˜¾ç¤º <code>Evicted</code> ï¼Œç°åœºäººå‘˜æŸ¥çœ‹åˆ†åŒºå®¹é‡å’Œ inode éƒ½æ­£å¸¸ï¼Œä½†æ˜¯ä¸€ç›´ <code>reclaim ephemeral-storage</code>ã€‚</p><h2 id="å¤„ç†"><a href="#å¤„ç†" class="headerlink" title="å¤„ç†"></a>å¤„ç†</h2><h3 id="ç¯å¢ƒä¿¡æ¯"><a href="#ç¯å¢ƒä¿¡æ¯" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux xxx-2 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">$ cat /etc/os-release</span><br><span class="line">CentOS Linux release 7.4.1708 (Core) </span><br><span class="line">$ kubectl version -o json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;clientVersion&quot;: &#123;</span><br><span class="line">    &quot;major&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;minor&quot;: &quot;15&quot;,</span><br><span class="line">    &quot;gitVersion&quot;: &quot;v1.15.5&quot;,</span><br><span class="line">    &quot;gitCommit&quot;: &quot;20c265fef0741dd71a66480e35bd69f18351daea&quot;,</span><br><span class="line">    &quot;gitTreeState&quot;: &quot;clean&quot;,</span><br><span class="line">    &quot;buildDate&quot;: &quot;2019-10-15T19:16:51Z&quot;,</span><br><span class="line">    &quot;goVersion&quot;: &quot;go1.12.10&quot;,</span><br><span class="line">    &quot;compiler&quot;: &quot;gc&quot;,</span><br><span class="line">    &quot;platform&quot;: &quot;linux/amd64&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;serverVersion&quot;: &#123;</span><br><span class="line">    &quot;major&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;minor&quot;: &quot;15&quot;,</span><br><span class="line">    &quot;gitVersion&quot;: &quot;v1.15.5&quot;,</span><br><span class="line">    &quot;gitCommit&quot;: &quot;20c265fef0741dd71a66480e35bd69f18351daea&quot;,</span><br><span class="line">    &quot;gitTreeState&quot;: &quot;clean&quot;,</span><br><span class="line">    &quot;buildDate&quot;: &quot;2019-10-15T19:07:57Z&quot;,</span><br><span class="line">    &quot;goVersion&quot;: &quot;go1.12.10&quot;,</span><br><span class="line">    &quot;compiler&quot;: &quot;gc&quot;,</span><br><span class="line">    &quot;platform&quot;: &quot;linux/amd64&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ docker info</span><br><span class="line">Containers: 5</span><br><span class="line"> Running: 4</span><br><span class="line"> Paused: 0</span><br><span class="line"> Stopped: 1</span><br><span class="line">Images: 40</span><br><span class="line">Server Version: 18.09.3</span><br><span class="line">Storage Driver: overlay2</span><br><span class="line"> Backing Filesystem: xfs</span><br><span class="line"> Supports d_type: true</span><br><span class="line"> Native Overlay Diff: true</span><br><span class="line">Logging Driver: json-file</span><br><span class="line">Cgroup Driver: cgroupfs</span><br><span class="line">Plugins:</span><br><span class="line"> Volume: local</span><br><span class="line"> Network: bridge host macvlan null overlay</span><br><span class="line"> Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog</span><br><span class="line">Swarm: inactive</span><br><span class="line">Runtimes: runc</span><br><span class="line">Default Runtime: runc</span><br><span class="line">Init Binary: docker-init</span><br><span class="line">containerd version: e6b3f5632f50dbc4e9cb6288d911bf4f5e95b18e</span><br><span class="line">runc version: 6635b4f0c6af3810594d2770f662f34ddc15b40d</span><br><span class="line">init version: fec3683</span><br><span class="line">Security Options:</span><br><span class="line"> seccomp</span><br><span class="line">  Profile: default</span><br><span class="line">Kernel Version: 3.10.0-693.el7.x86_64</span><br><span class="line">Operating System: CentOS Linux 7 (Core)</span><br><span class="line">OSType: linux</span><br><span class="line">Architecture: x86_64</span><br><span class="line">CPUs: 32</span><br><span class="line">Total Memory: 62.91GiB</span><br><span class="line">Name: SCJY-2</span><br><span class="line">ID: XZ33:PHUQ:U2CI:7PXH:SYFG:Y6LK:3K3U:XXM6:QJWP:U3B3:MW4M:XPJS</span><br><span class="line">Docker Root Dir: /data/kube/docker</span><br><span class="line">Debug Mode (client): false</span><br><span class="line">Debug Mode (server): false</span><br><span class="line">Registry: https://index.docker.io/v1/</span><br><span class="line">Labels:</span><br><span class="line">Experimental: false</span><br><span class="line">Insecure Registries:</span><br><span class="line"> reg.xxx.lan:5000</span><br><span class="line"> treg.yun.xxx.cn</span><br><span class="line"> 127.0.0.0/8</span><br><span class="line">Registry Mirrors:</span><br><span class="line"> https://registry.docker-cn.com/</span><br><span class="line"> https://docker.mirrors.ustc.edu.cn/</span><br><span class="line">Live Restore Enabled: false</span><br><span class="line">Product License: Community Engine</span><br></pre></td></tr></table></figure><h3 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h3><p>å‘æ—¥è‘µè¿œç¨‹ä¸Šå»çœ‹äº†ä¸‹ï¼Œæ ¹åˆ†åŒºå®¹é‡éƒ½æ˜¯æ­£å¸¸çš„ï¼Œinode ä¹Ÿæ˜¯ã€‚çœ‹äº†ä¸‹ <code>uptime -s</code> é‡å¯è¿‡ï¼Œç°åœºè¯´é‡å¯è¿‡è¿˜æ˜¯æ²¡ç”¨ã€‚é‡å¯ kubelet çš„è¯ï¼Œçœ‹äº†ä¸‹è¿˜æ˜¯ä¸€ç›´ <code>reclaim ephemeral-storage</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">du</span> -h</span><br><span class="line">Filesystem                 Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/rootvg-lvroot   30G  5.2G   25G  18% /</span><br><span class="line">devtmpfs                    32G     0   32G   0% /dev</span><br><span class="line">tmpfs                       32G  160K   32G   1% /dev/shm</span><br><span class="line">tmpfs                       32G   26M   32G   1% /run</span><br><span class="line">tmpfs                       32G     0   32G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sdb                   600G   36G  565G   6% /data</span><br><span class="line">/dev/sda1                 1014M  160M  855M  16% /boot</span><br><span class="line">/dev/mapper/rootvg-lvopt    10G   33M   10G   1% /opt</span><br><span class="line">/dev/mapper/rootvg-lvhome 1014M   39M  976M   4% /home</span><br><span class="line">/dev/mapper/rootvg-lvvar   2.0G  1.2G  888M  57% /var</span><br><span class="line">overlay                    600G   36G  565G   6% /data/kube/docker/overlay2/788ee4620da0a3f76ef5f4b24755a68de0e66c8f2425d8332d5a792116d7659f/merged</span><br><span class="line">overlay                    600G   36G  565G   6% /data/kube/docker/overlay2/d2b5f08e9873f5c9365aaf57eeca492734631a3842ccb2f379aa89998b0c7304/merged</span><br><span class="line">overlay                    600G   36G  565G   6% /data/kube/docker/overlay2/c4793b6c3f774cc960ef23e18b61405040698be698306ee993d4d501bdcf485a/merged</span><br><span class="line">overlay                    600G   36G  565G   6% /data/kube/docker/overlay2/b5a0fc544935db77c92bd978db9c1c7018e5e09bba9d2bf53bd300e96c656cec/merged</span><br><span class="line">shm                         64M     0   64M   0% /data/kube/docker/containers/ad86ab9b01e1ce0d62e1f98249274d9bfe75eca6efd8ce0e8f1c591d5570d75f/mounts/shm</span><br><span class="line">shm                         64M     0   64M   0% /data/kube/docker/containers/e3ebeac9a82264869429f44ea6834bcbc94b79013621490c071ef002b4b8e90e/mounts/shm</span><br><span class="line">shm                         64M     0   64M   0% /data/kube/docker/containers/a917bd3b8006198a58900efb5c82c6e162cfc4e732c7e588eaadfb59294ea22b/mounts/shm</span><br><span class="line">shm                         64M     0   64M   0% /data/kube/docker/containers/aa52df1894ad495f4f269d77ddd90954fdc7bbd0fbf25d9d4aa0674a76ff6a6c/mounts/shm</span><br><span class="line">tmpfs                      6.3G   12K  6.3G   1% /run/user/42</span><br><span class="line">tmpfs                      6.3G     0  6.3G   0% /run/user/1003</span><br><span class="line">tmpfs                      6.3G     0  6.3G   0% /run/user/1000</span><br><span class="line"></span><br><span class="line">$ dh -i</span><br><span class="line">Filesystem                   Inodes  IUsed     IFree IUse% Mounted on</span><br><span class="line">/dev/mapper/rootvg-lvroot  15726592 184878  15541714    2% /</span><br><span class="line">devtmpfs                    8242230    527   8241703    1% /dev</span><br><span class="line">tmpfs                       8246150     41   8246109    1% /dev/shm</span><br><span class="line">tmpfs                       8246150    735   8245415    1% /run</span><br><span class="line">tmpfs                       8246150     16   8246134    1% /sys/fs/cgroup</span><br><span class="line">/dev/sdb                  314572800 303816 314268984    1% /data</span><br><span class="line">/dev/sda1                    524288    327    523961    1% /boot</span><br><span class="line">/dev/mapper/rootvg-lvopt    5242880      7   5242873    1% /opt</span><br><span class="line">/dev/mapper/rootvg-lvhome    524288    397    523891    1% /home</span><br><span class="line">/dev/mapper/rootvg-lvvar    1048576  10179   1038397    1% /var</span><br><span class="line">overlay                   314572800 303816 314268984    1% /data/kube/docker/overlay2/788ee4620da0a3f76ef5f4b24755a68de0e66c8f2425d8332d5a792116d7659f/merged</span><br><span class="line">overlay                   314572800 303816 314268984    1% /data/kube/docker/overlay2/d2b5f08e9873f5c9365aaf57eeca492734631a3842ccb2f379aa89998b0c7304/merged</span><br><span class="line">overlay                   314572800 303816 314268984    1% /data/kube/docker/overlay2/c4793b6c3f774cc960ef23e18b61405040698be698306ee993d4d501bdcf485a/merged</span><br><span class="line">overlay                   314572800 303816 314268984    1% /data/kube/docker/overlay2/b5a0fc544935db77c92bd978db9c1c7018e5e09bba9d2bf53bd300e96c656cec/merged</span><br><span class="line">shm                         8246150      1   8246149    1% /data/kube/docker/containers/ad86ab9b01e1ce0d62e1f98249274d9bfe75eca6efd8ce0e8f1c591d5570d75f/mounts/shm</span><br><span class="line">shm                         8246150      1   8246149    1% /data/kube/docker/containers/e3ebeac9a82264869429f44ea6834bcbc94b79013621490c071ef002b4b8e90e/mounts/shm</span><br><span class="line">shm                         8246150      1   8246149    1% /data/kube/docker/containers/a917bd3b8006198a58900efb5c82c6e162cfc4e732c7e588eaadfb59294ea22b/mounts/shm</span><br><span class="line">shm                         8246150      1   8246149    1% /data/kube/docker/containers/aa52df1894ad495f4f269d77ddd90954fdc7bbd0fbf25d9d4aa0674a76ff6a6c/mounts/shm</span><br><span class="line">tmpfs                       8246150      9   8246141    1% /run/user/42</span><br><span class="line">tmpfs                       8246150      1   8246149    1% /run/user/1003</span><br><span class="line">tmpfs                       8246150      1   8246149    1% /run/user/1000</span><br><span class="line"></span><br><span class="line">$ kubectl describe node xx.xx.112.135</span><br><span class="line">...</span><br><span class="line">Capacity:</span><br><span class="line"> cpu:                32</span><br><span class="line"> ephemeral-storage:  2038Mi</span><br><span class="line"> hugepages-2Mi:      0</span><br><span class="line"> memory:             65969200Ki</span><br><span class="line"> pods:               110</span><br><span class="line">Allocatable:</span><br><span class="line"> cpu:                31800m</span><br><span class="line"> ephemeral-storage:  1014Mi</span><br><span class="line"> hugepages-2Mi:      0</span><br><span class="line"> memory:             65469200Ki</span><br><span class="line"> pods:               110</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                   Age                      From                    Message</span><br><span class="line">  ----     ------                   ----                     ----                    -------</span><br><span class="line">  Warning  EvictionThresholdMet     3m57s (x1434 over 4h3m)  kubelet, xx.xx.112.135  Attempting to reclaim ephemeral-storage</span><br><span class="line">  Normal   Starting                 37s                      kubelet, xx.xx.112.135  Starting kubelet.</span><br><span class="line">  Normal   NodeHasSufficientMemory  37s                      kubelet, xx.xx.112.135  Node xx.xx.112.135 status is now: NodeHasSufficientMemory</span><br><span class="line">  Normal   NodeHasNoDiskPressure    37s (x2 over 37s)        kubelet, xx.xx.112.135  Node xx.xx.112.135 status is now: NodeHasNoDiskPressure</span><br><span class="line">  Normal   NodeHasSufficientPID     37s                      kubelet, xx.xx.112.135  Node xx.xx.112.135 status is now: NodeHasSufficientPID</span><br><span class="line">  Normal   NodeNotReady             37s                      kubelet, xx.xx.112.135  Node xx.xx.112.135 status is now: NodeNotReady</span><br><span class="line">  Normal   NodeAllocatableEnforced  37s                      kubelet, xx.xx.112.135  Updated Node Allocatable <span class="built_in">limit</span> across pods</span><br><span class="line">  Normal   NodeReady                37s                      kubelet, xx.xx.112.135  Node xx.xx.112.135 status is now: NodeReady</span><br><span class="line">  Normal   NodeHasDiskPressure      27s                      kubelet, xx.xx.112.135  Node xx.xx.112.135 status is now: NodeHasDiskPressure</span><br><span class="line">  Warning  EvictionThresholdMet     7s (x4 over 37s)         kubelet, xx.xx.112.135  Attempting to reclaim ephemeral-storage</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸€ä¼šå„¿åå‘ç°ä¸Šé¢çš„ <code>ephemeral-storage</code> ä¸å¯¹ï¼Œ<code>Capacity</code> å±…ç„¶æ˜¯ <code>2038Mi</code> ã€‚</p><h3 id="æºç çš„ä¸€äº›æ¢ç´¢"><a href="#æºç çš„ä¸€äº›æ¢ç´¢" class="headerlink" title="æºç çš„ä¸€äº›æ¢ç´¢"></a>æºç çš„ä¸€äº›æ¢ç´¢</h3><p>æœ¬åœ°å¼€å‘ç¯å¢ƒèµ·äº†ä¸‹ kubelet è°ƒè¯•äº†ä¸‹ï¼Œä¸€äº›ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">./build/run.sh make kubelet GOFLAGS=&quot;-v -tags=nokmem&quot; GOGCFLAGS=&quot;all=-N -l&quot;  KUBE_BUILD_PLATFORMS=linux/amd64</span><br><span class="line"></span><br><span class="line">cp  _output/dockerized/bin/linux/amd64/kubelet .</span><br><span class="line"></span><br><span class="line">dlv exec --check-go-version=false ./kubelet  -- --cgroup-driver=systemd</span><br><span class="line"></span><br><span class="line"># æ¨èä¸‹é¢ä¸¤ä¸ªæ–­ç‚¹</span><br><span class="line">vendor/github.com/google/cadvisor/container/docker/handler.go#L421</span><br><span class="line"></span><br><span class="line">vendor/github.com/google/cadvisor/container/docker/handler.go:364</span><br><span class="line"></span><br><span class="line">   724:func (self *manager) GetFsInfo(label string) ([]v2.FsInfo, error) &#123;</span><br><span class="line">=&gt; 725:var empty time.Time</span><br><span class="line">   726:// Get latest data from filesystems hanging off root container.</span><br><span class="line">   727:stats, err := self.memoryCache.RecentStats(&quot;/&quot;, empty, empty, 1)</span><br><span class="line">   728:if err != nil &#123;</span><br><span class="line">   729:return nil, err</span><br><span class="line">   730:&#125;</span><br><span class="line">(dlv) so</span><br><span class="line">&gt; k8s.io/kubernetes/vendor/github.com/google/cadvisor/manager.(*manager).getFsInfoByDeviceName() _output/dockerized/go/src/k8s.io/kubernetes/vendor/github.com/google/cadvisor/manager/manager.go:1311 (PC: 0x1fc7180)</span><br><span class="line">Values returned:</span><br><span class="line">~r1: []k8s.io/kubernetes/vendor/github.com/google/cadvisor/info/v2.FsInfo len: 2, cap: 2, [</span><br><span class="line">&#123;</span><br><span class="line">Timestamp: (*time.Time)(0xc0002262d0),</span><br><span class="line">Device: &quot;/dev/sda1&quot;,</span><br><span class="line">Mountpoint: &quot;/&quot;,</span><br><span class="line">Capacity: 75150372864,</span><br><span class="line">Available: 36613033984,</span><br><span class="line">Usage: 38537338880,</span><br><span class="line">Labels: []string len: 2, cap: 2, [</span><br><span class="line">&quot;docker-images&quot;,</span><br><span class="line">&quot;root&quot;,</span><br><span class="line">],</span><br><span class="line">Inodes: *36699584,</span><br><span class="line">InodesFree: *35850609,&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Timestamp: (*time.Time)(0xc000226348),</span><br><span class="line">Device: &quot;tmpfs&quot;,</span><br><span class="line">Mountpoint: &quot;/dev/shm&quot;,</span><br><span class="line">Capacity: 1986203648,</span><br><span class="line">Available: 1986203648,</span><br><span class="line">Usage: 0,</span><br><span class="line">Labels: []string len: 0, cap: 0, [],</span><br><span class="line">Inodes: *484913,</span><br><span class="line">InodesFree: *484912,&#125;,</span><br><span class="line">]</span><br><span class="line">~r2: error nil</span><br></pre></td></tr></table></figure><p>å®¹é‡è¿™éƒ¨åˆ†æˆ‘ç°åœºé€šè¿‡ç‰¹æ€§ <code>--feature-gates=LocalStorageCapacityIsolation=false</code> ååˆ æ‰ node restart å describe çœ‹ä¸åˆ° <code>ephemeral-storage</code> äº†ï¼Œä½†æ˜¯è¿˜æ˜¯é—®é¢˜è¿˜åœ¨ï¼Œçœ‹äº†ä¸‹æºç ï¼Œè¿™ä¸ªå®¹é‡å¤§å°æ˜¯ <code>vendor/github.com/google/cadvisor/container/docker</code> ä¸‹ä» docker è·å–çš„ï¼ŒåµŒå¥—çš„ interface å¤ªå¤šäº†ï¼ŒæŸ¥çœ‹éº»çƒ¦ã€‚ç°åœºæ˜¯å·²ç»é‡å¯è¿‡æœºå™¨äº†ï¼Œdocker æˆ‘é‡å¯å’ŒæŸ¥çœ‹æ—¥å¿—ä¹Ÿæ²¡å•¥æœ‰ç”¨çš„åœ°æ–¹ã€‚</p><h3 id="æœ€ç»ˆè§£å†³"><a href="#æœ€ç»ˆè§£å†³" class="headerlink" title="æœ€ç»ˆè§£å†³"></a>æœ€ç»ˆè§£å†³</h3><p><code>ephemeral-storage</code> è¿™ä¸ª limit æ˜¯ 1.15 alpha çš„ï¼Œæš‚æ—¶ä¸æƒ³æŠ˜è…¾äº†ã€‚ å°è¯•æ¢ä¸‹ kubelet çš„ root ç›®å½•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl cat kubelet</span><br><span class="line"># /etc/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">...</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/data/kube/bin/kubelet \</span><br><span class="line">  ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸»è¦ä¿®æ”¹ <code>WorkingDirectory</code> å’Œç»™ kubelet å¢åŠ å‚æ•° <code>--root-dir</code> ä»¥åŠ <code>--docker-root</code> ï¼Œç°åœº <code>/data</code> æ˜¯å•ç‹¬åˆ†åŒºçš„ï¼Œåˆ‡åˆ° <code>/data/kube/kubelet</code> ä¸‹ï¼Œ<code>--docker-root</code> åˆ™æ˜¯ docker çš„ <code>data-root</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/systemd/system/kubelet.service</span><br><span class="line">...</span><br><span class="line">WorkingDirectory=/data/kube/kubelet</span><br><span class="line">ExecStart=/data/kube/bin/kubelet \</span><br><span class="line">  --root-dir=/data/kube/kubelet \</span><br><span class="line">  --docker-root=/data/kube/docker \</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure><p>é—®é¢˜è§£å†³ã€‚åé¢æ‰å‘ç° &#x2F;var æ˜¯å•ç‹¬åˆ†åŒºçš„ï¼Œå®¢æˆ·ç°åœºåŠ¨è¿‡åˆ†åŒºè¡¨ï¼Œä¹‹å‰æ˜¯ &#x2F;var æ²¡æœ‰å•ç‹¬åˆ†åŒºï¼Œåé¢ä»–ä»¬åˆ›å»ºäº†ä¸ª lv å¹¶å†™åœ¨ &#x2F;etc&#x2F;fstab é‡Œï¼Œå¹¶æ²¡æœ‰æŒ‚è½½å’Œé‡å¯ã€‚ä¸€å‘¨å‰ä»–ä»¬é‡å¯äº†ä¸‹ï¼Œè€Œä¸”æœ‰ä¸€äº›æœåŠ¡åœ¨ &#x2F;var&#x2F;log è¾“å‡ºæ—¥å¿—ï¼Œæ‰€ä»¥é€ æˆäº†è¿™æ¬¡æ•…éšœã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/kubernetes/kubernetes/tree/v1.15.5/vendor/github.com/google/cadvisor/manager/manager.go#L724">https://github.com/kubernetes/kubernetes/tree/v1.15.5/vendor/github.com/google/cadvisor/manager/manager.go#L724</a></li><li><a href="https://github.com/kubernetes/kubernetes/tree/v1.15.5/vendor/github.com/google/cadvisor/container/libcontainer/handler.go">https://github.com/kubernetes/kubernetes/tree/v1.15.5/vendor/github.com/google/cadvisor/container/libcontainer/handler.go</a></li><li><a href="https://github.com/kubernetes/kubernetes/tree/v1.15.5/vendor/github.com/docker/docker/pkg/mount/mountinfo_linux.go">https://github.com/kubernetes/kubernetes/tree/v1.15.5/vendor/github.com/docker/docker/pkg/mount/mountinfo_linux.go</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;æ•…éšœ&quot;&gt;&lt;a href=&quot;#æ•…éšœ&quot; class=&quot;headerlink&quot; title=&quot;æ•…éšœ&quot;&gt;&lt;/a&gt;æ•…éšœ&lt;/h2&gt;&lt;p&gt;ç°åœº k8s node å¾ˆå¤š pod éƒ½è¢«ç¡¬æ€§é©±é€æ˜¾ç¤º &lt;code&gt;Evicted&lt;/code&gt; ï¼Œç°åœºäººå‘˜æŸ¥çœ‹åˆ†åŒºå®¹é‡å’Œ inode éƒ½æ­£</summary>
      
    
    
    
    
    <category term="kubelet" scheme="http://zhangguanzhang.github.io/tags/kubelet/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨éå®¹å™¨ç¯å¢ƒä¸Šå®ç°æ•£è£…çš„ IPVS SVC</title>
    <link href="http://zhangguanzhang.github.io/2021/09/28/ipvs-svc/"/>
    <id>http://zhangguanzhang.github.io/2021/09/28/ipvs-svc/</id>
    <published>2021-09-28T19:28:30.000Z</published>
    <updated>2021-09-28T19:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å†…éƒ¨æœ‰é K8S ç¯å¢ƒä¸Šéœ€è¦ç±»ä¼¼ SVC çš„è´Ÿè½½å®ç°ï¼Œä¸€å¼€å§‹æ˜¯ç”¨ NGINX åšçš„ï¼Œæ‰€æœ‰ SVC åŸŸåéƒ½è§£ææˆä¸€ä¸ª dummy IP ï¼Œç„¶å NGINX æ ¹æ® <code>server_name</code> å» proxy ä¸åŒçš„ upstream ã€‚ å¼€å§‹è¿˜æ˜¯èƒ½ç”¨çš„ï¼Œç»“æœåé¢å¾ˆå¤šæœåŠ¡ä¾èµ– <code>host</code> è¿™ä¸ª header ï¼ŒæŠ¥é”™ç­¾åé”™è¯¯ï¼Œè€Œä¸”æ¯•ç«Ÿè¿™æ ·æ˜¯åœ¨ç”¨æˆ·æ€ï¼Œæ•ˆç‡ä¸å¦‚å†…æ ¸æ€é«˜ã€‚äºæ˜¯æ‰“ç®—æä¸‹ä¹‹å‰çš„æ‰“ç®—ï¼šæŠŠ IPVS çš„ <code>ClusterIP</code> çš„ SVC æ‰£åˆ°é K8S ç¯å¢ƒä¸Šä½¿ç”¨ã€‚</p><p>kube-proxy çš„ SVC ç®€å•è®²å°±æ˜¯ node ä¸Šä»»ä½•è¿›ç¨‹è®¿é—® <code>SVC IP:SVC PORT</code> ä¼šè¢« dnat æˆ <code>endpoint</code> ï¼Œæ˜¯å·¥ä½œåœ¨å†…æ ¸æ€çš„å››å±‚è´Ÿè½½ï¼Œä¸ä¼šåœ¨æœºå™¨ä¸Šçœ‹åˆ°ç«¯å£ç›‘å¬ï¼Œè€Œé»˜è®¤éé›†ç¾¤çš„æœºå™¨æ˜¯æ— æ³•è®¿é—® SVC IP ã€‚åœ¨ K8S é‡Œï¼Œendpoint çš„ ip æ— éå°±æ˜¯ <code>POD IP</code>ï¼Œ<code>host IP</code>ã€‚å‰è€…å°±æ˜¯ SVC é€‰ä¸­ POD ï¼Œåè€…ä¾‹å¦‚ <code>kubernetes</code> è¿™ä¸ª SVC ï¼Œä¼š DNAT æˆæ¯ä¸ª <code>kube-apiserver</code> çš„ <code>host IP:6443</code> ç«¯å£ï¼Œä¹Ÿå¯èƒ½æ˜¯ <code>ExternalName</code> æˆ–è€…æ‰‹åŠ¨åˆ›å»ºçš„ endpoint ã€‚æ—¢ç„¶ <code>kubernetes</code> è¿™ä¸ª SVC å¯ä»¥ã€‚é‚£æˆ‘çš„æ‰“ç®—åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ã€‚ä½†æ˜¯ä¸€å¼€å§‹å®é™…æŒ‰ç…§æ€è·¯è¯•äº†ä¸‹å‘ç°ä¸è¡Œï¼Œç½‘ä¸Šçš„æ–‡ç« åŸºæœ¬éƒ½æ˜¯åœ¨å•æœº docker æˆ–è€…ç°æœ‰çš„ K8S ç¯å¢ƒä¸Šæçš„ï¼Œæ¼æ‰äº†å¾ˆå¤šç²¾åå’Œæ ¸å¿ƒæ€æƒ³ï¼Œè¿™é‡Œè®°å½•ä¸‹æˆ‘çš„æ€è·¯å’Œå®ç°è¿‡ç¨‹ã€‚</p><h2 id="ç¯å¢ƒä¿¡æ¯"><a href="#ç¯å¢ƒä¿¡æ¯" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h2><p>å‰é¢è¯´çš„ SVC ç°è±¡æ˜¯å’Œ <code>kube-proxy</code> çš„æ¨¡å¼æ— å…³çš„ã€‚<code>iptables</code> æ¨¡å¼æ’æŸ¥ä¸ç›´è§‚ï¼Œæˆ‘æ›´å€¾å‘äº <code>IPVS</code> å»æï¼Œå®ƒæ›´ç›´è§‚ï¼Œè€Œä¸”æ”¯æŒæ›´å¤šçš„è°ƒåº¦ç®—æ³•ã€‚ç®¡ç† IPVS è§„åˆ™çš„è¯æˆ‘ä»¬éœ€è¦å®‰è£… <code>ipvsadm</code> ï¼Œè¿™é‡Œæˆ‘æ˜¯ä¸¤å°å¹²å‡€çš„ CentOS 7.8 æ¥åšç¯å¢ƒã€‚</p><table><thead><tr><th align="left">IP</th></tr></thead><tbody><tr><td align="left">192.168.2.111</td></tr><tr><td align="left">192.168.2.222</td></tr></tbody></table><p>å…ˆå®‰è£…ä¸‹åŸºç¡€éœ€è¦çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ipvsadm curl wget tcpdump ipset conntrack-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯è½¬å‘</span></span><br><span class="line"></span><br><span class="line">sysctl -w net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤ iptables è§„åˆ™æ¸…ç©º</span></span><br><span class="line">$ iptables -S</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">$ iptables -t nat -S</span><br><span class="line">-P PREROUTING ACCEPT</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-P POSTROUTING ACCEPT</span><br></pre></td></tr></table></figure><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p>å…ˆæ€è€ƒä¸‹ kube-proxy çš„ IPVS ï¼Œå› ä¸º SVC ç«¯å£å’Œ POD çš„ç«¯å£ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ kube-proxy ä½¿ç”¨çš„ <code>nat</code> æ¨¡å¼ã€‚æš‚ä¸”æ‰“ç®—æ·»åŠ ä¸€ä¸ªä¸‹é¢ç±»ä¼¼çš„ SVC ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IP:                169.254.11.2</span><br><span class="line">Port:              https  80/TCP</span><br><span class="line">TargetPort:        8080/TCP</span><br><span class="line">Endpoints:         192.168.2.111:8080,192.168.2.222:8080</span><br><span class="line">Session Affinity:  None</span><br></pre></td></tr></table></figure><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>web çš„è¯æˆ‘æ˜¯ä½¿ç”¨çš„ golang çš„ä¸€ä¸ªç®€å• web äºŒè¿›åˆ¶èµ·çš„ <a href="https://github.com/m3ng9i/ran">ran</a> :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/m3ng9i/ran/releases/download/v0.1.6/ran_linux_amd64.zip</span><br><span class="line">unzip -x ran_linux_amd64.zip</span><br><span class="line"><span class="built_in">mkdir</span> www</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸¤ä¸ªæœºå™¨åˆ›å»ºä¸åŒçš„ index æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> 192.168.2.111 &gt; www/test</span><br><span class="line"><span class="built_in">echo</span> 192.168.2.222 &gt; www/test</span><br><span class="line"></span><br><span class="line">./ran_linux_amd64 -port 8080 -listdir www</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæœºå™¨çš„è¿™ä¸ª web éƒ½èµ·æ¥åæˆ‘ä»¬å¼€ä¸ªçª—å£å» <code>192.168.2.111</code> ä¸Šç»§ç»­åé¢çš„æ“ä½œã€‚</p><h3 id="lvs-nat"><a href="#lvs-nat" class="headerlink" title="lvs nat"></a>lvs nat</h3><p>kube-proxy å¹¶æ²¡æœ‰åƒ lvs nat é‚£æ ·æœ‰å•ç‹¬çš„æœºå™¨åš <code>NAT GW</code>ï¼Œæˆ–è€…è®¤ä¸ºæ¯ä¸ª node éƒ½æ˜¯è‡ªå·±çš„ <code>NAT GW</code>ã€‚ç°åœ¨æ¥æ·»åŠ  <code>169.254.11.2:80</code> è¿™ä¸ª SVC ï¼Œä½¿ç”¨ ipvsadm æ·»åŠ ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm --add-service --tcp-service 169.254.11.2:80 --scheduler rr</span><br></pre></td></tr></table></figure><p>å…ˆæ·»åŠ æœ¬åœ°çš„ web ä½œä¸º real server ï¼Œä¸‹é¢å«ä¹‰æ˜¯æ·»åŠ ä¸ºä¸€ä¸ª nat ç±»å‹çš„ real server ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm --add-server --tcp-service 169.254.11.2:80 \</span><br><span class="line">  --real-server 192.168.2.111:8080 --masquerading --weight 1</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹å½“å‰åˆ—è¡¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ipvsadm -<span class="built_in">ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  169.254.11.2:80 rr</span><br><span class="line">  -&gt; 192.168.2.111:8080           Masq    1      0          0 </span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯è‡ªå·±çš„ <code>NAT GW</code>ï¼Œæ‰€ä»¥ VIP é…ç½®åœ¨è‡ªå·±èº«ä¸Šï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 169.254.11.2/32 dev eth0</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸‹è®¿é—®çœ‹çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¸Šå¦ä¸€ä¸ªèŠ‚ç‚¹çš„ 8080ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ipvsadm --add-server --tcp-service 169.254.11.2:80 \</span><br><span class="line">  --real-server 192.168.2.222:8080 --masquerading --weight 1</span><br><span class="line"></span><br><span class="line">$ ipvsadm -<span class="built_in">ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  169.254.11.2:80 rr</span><br><span class="line">  -&gt; 192.168.2.111:8080           Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.2.222:8080           Masq    1      0          0</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸‹è®¿é—®çœ‹çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‘ç° curl åœ¨å¡ä½å’Œèƒ½è®¿é—®è¿”å› <code>192.168.2.111</code> ä¹‹é—´åˆ‡æ¢ï¼Œæ²¡æœ‰è¿”å› <code>192.168.2.222</code> çš„ã€‚æŸ¥çœ‹ä¸‹ IPVS çš„ connection ï¼Œå‘ç°è°ƒåº¦åˆ°éæœ¬æœºæ‰ä¼šå¡ä½ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ipvsadm -lnc</span><br><span class="line">IPVS connection entries</span><br><span class="line">pro expire state       <span class="built_in">source</span>             virtual            destination</span><br><span class="line">TCP 00:48  SYN_RECV    169.254.11.2:50698 169.254.11.2:80    192.168.2.222:8080</span><br></pre></td></tr></table></figure><p>åœ¨ <code>192.168.2.222</code> ä¸ŠæŠ“åŒ…çœ‹çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -i eth0 port 8080</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">07:38:26.360716 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags [S], <span class="built_in">seq</span> 768065283, win 43690, options [mss 65495,sackOK,TS val 12276183 ecr 0,nop,wscale 7], length 0</span><br><span class="line">07:38:26.360762 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags [S.], <span class="built_in">seq</span> 2142784980, ack 768065284, win 28960, options [mss 1460,sackOK,TS val 676518144 ecr 12276183,nop,wscale 7], length 0</span><br><span class="line">07:38:27.362848 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags [S], <span class="built_in">seq</span> 768065283, win 43690, options [mss 65495,sackOK,TS val 12277186 ecr 0,nop,wscale 7], length 0</span><br><span class="line">07:38:27.362884 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags [S.], <span class="built_in">seq</span> 2142784980, ack 768065284, win 28960, options [mss 1460,sackOK,TS val 676519146 ecr 12276183,nop,wscale 7], length 0</span><br><span class="line">07:38:28.562629 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags [S.], <span class="built_in">seq</span> 2142784980, ack 768065284, win 28960, options [mss 1460,sackOK,TS val 676520346 ecr 12276183,nop,wscale 7], length 0</span><br><span class="line">07:38:29.368811 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags [S], <span class="built_in">seq</span> 768065283, win 43690, options [mss 65495,sackOK,TS val 12279192 ecr 0,nop,wscale 7], length 0</span><br><span class="line">07:38:29.368853 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags [S.], <span class="built_in">seq</span> 2142784980, ack 768065284, win 28960, options [mss 1460,sackOK,TS val 676521152 ecr 12276183,nop,wscale 7], length 0</span><br><span class="line">07:38:31.562633 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags [S.], <span class="built_in">seq</span> 2142784980, ack 768065284, win 28960, options [mss 1460,sackOK,TS val 676523346 ecr 12276183,nop,wscale 7], length 0</span><br><span class="line">07:38:33.376829 IP 169.254.11.2.50710 &gt; 192.168.2.222.8080: Flags [S], <span class="built_in">seq</span> 768065283, win 43690, options [mss 65495,sackOK,TS val 12283200 ecr 0,nop,wscale 7], length 0</span><br><span class="line">07:38:33.376869 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags [S.], <span class="built_in">seq</span> 2142784980, ack 768065284, win 28960, options [mss 1460,sackOK,TS val 676525160 ecr 12276183,nop,wscale 7], length 0</span><br><span class="line">07:38:37.562632 IP 192.168.2.222.8080 &gt; 169.254.11.2.50710: Flags [S.], <span class="built_in">seq</span> 2142784980, ack 768065284, win 28960, options [mss 1460,sackOK,TS val 676529346 ecr 12276183,nop,wscale 7], length 0</span><br></pre></td></tr></table></figure><p>ä» <code>Flags</code> çœ‹ï¼Œå°±æ˜¯ tcp é‡ä¼ ï¼Œå¹¶ä¸” <code>SRC IP</code> æ˜¯ VIP ã€‚èŠ‚ç‚¹ <code>192.168.2.222.8080</code> ç»™ <code>169.254.11.2.50710</code> å›åŒ…ä¼šèµ°åˆ°ç½‘å…³ä¸Šå»ã€‚ç½‘å…³ä¸ŠæŠ“åŒ…ä¹Ÿçœ‹åˆ°ç¡®å®å¦‚æ­¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -i eth0 host 169.254.11.2</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">19:39:47.487362 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags [S.], <span class="built_in">seq</span> 4149799699, ack 251479303, win 28960, options [mss 1460,sackOK,TS val 676599263 ecr 12357303,nop,wscale 7], length 0</span><br><span class="line">19:39:47.487405 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags [S.], <span class="built_in">seq</span> 4149799699, ack 251479303, win 28960, options [mss 1460,sackOK,TS val 676599263 ecr 12357303,nop,wscale 7], length 0</span><br><span class="line">19:39:48.487838 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags [S.], <span class="built_in">seq</span> 4149799699, ack 251479303, win 28960, options [mss 1460,sackOK,TS val 676600264 ecr 12357303,nop,wscale 7], length 0</span><br><span class="line">19:39:48.487868 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags [S.], <span class="built_in">seq</span> 4149799699, ack 251479303, win 28960, options [mss 1460,sackOK,TS val 676600264 ecr 12357303,nop,wscale 7], length 0</span><br><span class="line">19:39:49.569667 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags [S.], <span class="built_in">seq</span> 4149799699, ack 251479303, win 28960, options [mss 1460,sackOK,TS val 676601346 ecr 12357303,nop,wscale 7], length 0</span><br><span class="line">19:39:49.569699 IP 192.168.2.222.8080 &gt; 169.254.11.2.50714: Flags [S.], <span class="built_in">seq</span> 4149799699, ack 251479303, win 28960, options [mss 1460,sackOK,TS val 676601346 ecr 12357303,nop,wscale 7], length 0</span><br></pre></td></tr></table></figure><h4 id="lvs-å’Œ-netfilter"><a href="#lvs-å’Œ-netfilter" class="headerlink" title="lvs å’Œ netfilter"></a>lvs å’Œ netfilter</h4><p>åœ¨ä»‹ç» lvs çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ netfilter ï¼ŒLinux çš„æ‰€æœ‰æ•°æ®åŒ…éƒ½ä¼šç»è¿‡å®ƒï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨çš„ iptables æ˜¯ç”¨æˆ·æ€æä¾›çš„æ“ä½œå·¥å…·ä¹‹ä¸€ã€‚Linux å†…æ ¸å¤„ç†è¿›å‡ºçš„æ•°æ®åŒ…åˆ†ä¸ºäº† 5 ä¸ªé˜¶æ®µã€‚netfilter åœ¨è¿™ 5 ä¸ªé˜¶æ®µæä¾›äº† hook ç‚¹ï¼Œæ¥è®©æ³¨å†Œçš„ hook å‡½æ•°æ¥å®ç°å¯¹åŒ…çš„è¿‡æ»¤å’Œä¿®æ”¹ã€‚ä¸‹å›¾çš„ local process å°±æ˜¯ä¸Šå±‚çš„åè®®æ ˆã€‚</p><p>ä¸‹é¢æ˜¯ IPVS åœ¨ netfilter é‡Œçš„æ¨¡å‹å›¾ï¼ŒIPVS ä¹Ÿæ˜¯åŸºäº netfilter æ¡†æ¶çš„ï¼Œä½†åªå·¥ä½œåœ¨ <code>INPUT</code> é“¾ä¸Šï¼Œé€šè¿‡æ³¨å†Œ <code>ip_vs_in</code> é’©å­å‡½æ•°æ¥å¤„ç†è¯·æ±‚ã€‚å› ä¸º VIP æˆ‘ä»¬é…ç½®åœ¨æœºå™¨ä¸Šï¼ˆå¸¸è§„çš„ lvs nat çš„ VIP æ˜¯åœ¨ NAT GW ä¸Šï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯è‡ªå·±ï¼‰ï¼Œæˆ‘ä»¬ curl çš„æ—¶å€™å°±ä¼šè¿›åˆ° <code>INPUT</code> é“¾ï¼Œ<code>ip_vs_in</code> ä¼šåŒ¹é…ç„¶åç›´æ¥è·³è½¬è§¦å‘ <code>POSTROUTING</code> é“¾ï¼Œè·³è¿‡ iptables è§„åˆ™ã€‚</p><p><img src="https://raw.githubusercontent.com/zhangguanzhang/Image-Hosting/master/picgo/lvs-netfilter.png" alt="lvs-netfilter"></p><p>æ‰€ä»¥è¯·æ±‚æµç¨‹æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># CIP: client IP    # RIP: real server IP</span><br><span class="line"></span><br><span class="line">CLIENT</span><br><span class="line">   | CIP:CPORT -&gt; VIP:VPORT</span><br><span class="line">   |||</span><br><span class="line">   |\/</span><br><span class="line">       | CIP:CPORT -&gt; VIP:VPORT</span><br><span class="line">   LVS DNAT</span><br><span class="line">      | CIP:CPORT -&gt; RIP:RPORT</span><br><span class="line">      |||</span><br><span class="line">   |\/</span><br><span class="line">   | CIP:CPORT -&gt; RIP:RPORT</span><br><span class="line">   +</span><br><span class="line">REAL SERVER</span><br></pre></td></tr></table></figure><p>lvs åšäº† DNAT å¹¶æ²¡æœ‰åš SNAT ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨ iptables åš SNAT ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -t nat -A POSTROUTING -m ipvs --vaddr 169.254.11.2 --vport 80 -j MASQUERADE</span><br></pre></td></tr></table></figure><p>è®¿é—®çœ‹çœ‹è¿˜æ˜¯ä¸é€šï¼ŒæŠ“åŒ…çœ‹è¿˜æ˜¯æ²¡ç”Ÿæ•ˆï¼Œnat æ˜¯ä¾èµ– <code>conntrack</code> çš„ï¼Œè€Œ IPVS é»˜è®¤ä¸ä¼šè®°å½• conntrackï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯ IPVS çš„ conntrack æ‰å¯ä»¥è®© MASQUERADE ç”Ÿæ•ˆã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®© Netfilter çš„ conntrack çŠ¶æ€ç®¡ç†åŠŸèƒ½ä¹Ÿèƒ½åº”ç”¨äº IPVS æ¨¡å—</span></span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt;  /proc/sys/net/ipv4/vs/conntrack</span><br><span class="line">$  curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.222</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.222</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.222</span><br></pre></td></tr></table></figure><p>ç°åœ¨å®ç°äº†å•ä¸ª SVC çš„ï¼Œä½†æ˜¯ä»”ç»†æ€è€ƒä¸‹è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå¦‚æœåç»­å¢åŠ å¦ä¸€ä¸ª SVC åˆå¾—å¢åŠ ä¸€ä¸ª iptables è§„åˆ™äº†ï¼Œé‚£å°±åˆå›åˆ° iptables çš„åŒ¹é…å¤æ‚åº¦è€—æ—¶é•¿ä¸Šå»äº†ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ iptables çš„ mark å’Œ ipset é…åˆå‡å°‘ iptables è§„åˆ™ã€‚</p><h3 id="åˆ©ç”¨-ipset-å’Œ-iptable-çš„-mark"><a href="#åˆ©ç”¨-ipset-å’Œ-iptable-çš„-mark" class="headerlink" title="åˆ©ç”¨ ipset å’Œ iptable çš„ mark"></a>åˆ©ç”¨ ipset å’Œ iptable çš„ mark</h3><p><img src="https://raw.githubusercontent.com/zhangguanzhang/Image-Hosting/master/picgo/iptables_netfilter.png" alt="iptables_netfilter"></p><p>iptables çš„äº”é“¾å››è¡¨å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å…ˆåˆ æ‰åŸæœ‰çš„è§„åˆ™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -t nat -D POSTROUTING -m ipvs --vaddr 169.254.11.2 --vport 80 -j MASQUERADE</span><br></pre></td></tr></table></figure><p>å¹³æ—¶è‡ªå·±å®¶é‡Œä½¿ç”¨äº† openwrt ï¼Œä¹‹å‰çœ‹äº†ä¸‹ä¸Šé¢çš„ iptables è§„åˆ™è®¾è®¡æŒºå¥½çš„ï¼Œç‰¹åˆ«æ˜¯é¢„ç•™äº†å¾ˆå¤šé“¾ä¸“é—¨ç»™ç”¨æˆ·åœ¨åˆé€‚çš„ä½ç½®æ’å…¥è§„åˆ™ï¼Œæ¯”å¦‚ä¸‹é¢çš„ <code>INPUT</code> è§„åˆ™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -i eth0 -m comment --comment <span class="string">&quot;!fw3&quot;</span> -j zone_lan_input</span><br><span class="line">...</span><br><span class="line">-A zone_lan_input -m comment --comment <span class="string">&quot;!fw3: Custom lan input rule chain&quot;</span> -j input_lan_rule</span><br><span class="line">-A zone_lan_input -m conntrack --ctstate DNAT -m comment --comment <span class="string">&quot;!fw3: Accept port redirections&quot;</span> -j ACCEPT</span><br><span class="line">-A zone_lan_input -m comment --comment <span class="string">&quot;!fw3&quot;</span> -j zone_lan_src_ACCEPT</span><br></pre></td></tr></table></figure><p><code>zone_lan_src_ACCEPT</code> æ˜¯æœ€åé¢ï¼Œ<code>zone_lan_input</code> æ˜¯æœ€å¼€å§‹ï¼Œé‚£ç”¨æˆ·å‘ <code>input_lan_rule</code> é“¾é‡Œæ’å…¥è§„åˆ™å³å¯ï¼Œåˆ©ç”¨å¤šä¸ªé“¾æ¥è®¾è®¡ä¹Ÿæ–¹ä¾¿åˆ«äººã€‚<br>è§„åˆ™è®¾è®¡æˆ‘ä»¬å…ˆé€†ç€æ¥æ€è€ƒä¸‹ï¼Œæœ€åè‚¯å®šæ˜¯ <code>MASQUERADE</code> çš„ï¼Œå¾—åœ¨ nat è¡¨çš„ <code>POSTROUTING</code> é“¾åˆ›å»º <code>MASQUERADE</code> çš„è§„åˆ™ã€‚</p><p>ä½†æ˜¯æ·»åŠ ä¹‹å‰å…ˆæ€è€ƒä¸‹ï¼Œlvs åšäº† DNAT åï¼Œæœ€ååŒ…èµ°å‘äº† <code>POSTROUTING</code> é“¾ï¼Œè€Œä¸”åé¢æˆ‘ä»¬æ˜¯æœ‰å¤šä¸ª SVC çš„ã€‚æ­¤åˆ»åŒ…çš„ <code>SRC IP</code> ä¼šæ˜¯ <code>VIP</code>ï¼Œè§ä¸Šé¢æŠ“åŒ…çš„ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># å‡è®¾æ²¡åš masq çš„æ—¶å€™(åˆšå¥½è°ƒåº¦åˆ°éæœ¬åœ°çš„ real server ä¸Š</span><br><span class="line">#ä¹Ÿå°±æ˜¯ä¸Šé¢ä¹‹å‰ä¸é€šåœ¨ç›®æ ‡æœºå™¨ä¸ŠæŠ“åŒ…)åŒ…çš„é˜¶æ®µ</span><br><span class="line"></span><br><span class="line">SRC:169.254.11.2:xxxx</span><br><span class="line">DST:169.254.11.2:80</span><br><span class="line">      ||</span><br><span class="line">      || æ²¡ç»è¿‡ POSTROUTING masq snat çš„æ—¶å€™</span><br><span class="line">      \/</span><br><span class="line">SRC:169.254.11.2:xxxx</span><br><span class="line">DST:192.168.2.222:80</span><br></pre></td></tr></table></figure><p>è€Œä¸”åç»­å¯èƒ½æ˜¯åœ¨ docker ç¯å¢ƒä¸Šéƒ¨ç½²ï¼Œå¯èƒ½é»˜è®¤æ¡¥æ¥ç½‘ç»œä¸‹çš„å®¹å™¨ä¹Ÿä¼šå»è®¿é—® <code>SVC</code>ï¼Œæ­¤åˆ»çš„ <code>SRC IP</code> å°±ä¸ä¼šæ˜¯ç½‘å¡ä¸Šçš„ <code>VIP</code> äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ PREROUTING é˜¶æ®µ dest IP,dest Port æ˜¯ svc ä¿¡æ¯åˆ™åš masq snatã€‚<br>å¯ä»¥åœ¨æ­¤åˆ»åˆ©ç”¨ä¸€ä¸ª ipset å­˜å‚¨æ‰€æœ‰çš„ <code>SVC_IP:SVC_PORT</code> åŒ¹é…ï¼Œç„¶åæ‰“ä¸Š markï¼Œç„¶ååœ¨ <code>POSTROUTING</code> é“¾å»æ ¹æ® mark å»åš <code>MASQUERADE</code> ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PREROUTING é˜¶æ®µå¤„ç†</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æä¾›ä¸€ä¸ªå…¥å£é“¾ï¼Œè€Œä¸æ˜¯ç›´æ¥æ·»åŠ åœ¨ PREROUTING é“¾ä¸Š</span></span><br><span class="line">iptables -t nat -N ZGZ-SERVICES</span><br><span class="line">iptables -t nat -A PREROUTING -m comment --comment <span class="string">&quot;zgz service portals&quot;</span> -j ZGZ-SERVICES</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ PREROUTING å­é“¾é‡Œå» ipset åŒ¹é…ï¼Œè·³è½¬åˆ°æˆ‘ä»¬æ‰“ mark çš„é“¾</span></span><br><span class="line">iptables -t nat -N ZGZ-MARK-MASQ</span><br><span class="line"><span class="comment"># åˆ›å»ºå­˜å‚¨æ‰€æœ‰ `SVC_IP:SVC_PORT` çš„ ipset </span></span><br><span class="line">ipset create ZGZ-CLUSTER-IP <span class="built_in">hash</span>:ip,port -exist</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸“é—¨ mark çš„é“¾</span></span><br><span class="line">iptables -t nat -A ZGZ-MARK-MASQ -j MARK --set-xmark 0x2000/0x2000</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒ¹é… svc ipï¼šsvc port çš„æ‰è·³è½¬åˆ°æ‰“ mark çš„é“¾é‡Œ</span></span><br><span class="line">iptables -t nat -A ZGZ-SERVICES -m comment --comment <span class="string">&quot;zgz service cluster ip + port for masquerade purpose&quot;</span> -m <span class="built_in">set</span> --match-set ZGZ-CLUSTER-IP dst,dst -j ZGZ-MARK-MASQ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># POSTROUTING é˜¶æ®µå¤„ç†</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æä¾›ä¸€ä¸ªå…¥å£é“¾ï¼Œè€Œä¸æ˜¯ç›´æ¥æ·»åŠ åœ¨ POSTROUTING é“¾ä¸Š</span></span><br><span class="line">iptables -t nat -N ZGZ-SERVICES-POSTROUTING</span><br><span class="line">iptables -t nat -A POSTROUTING -m comment --comment <span class="string">&quot;zgz postrouting rules&quot;</span> -j ZGZ-SERVICES-POSTROUTING</span><br><span class="line"><span class="comment"># åœ¨ POSTROUTING é˜¶æ®µï¼Œæœ‰ mark æ ‡è®°çš„å°±åš snat</span></span><br><span class="line">iptables -t nat -A ZGZ-SERVICES-POSTROUTING -m comment --comment <span class="string">&quot;zgz service traffic requiring SNAT&quot;</span> -m mark --mark 0x2000/0x2000 -j MASQUERADE</span><br></pre></td></tr></table></figure><p>ç„¶åæ·»åŠ ä¸‹ <code>SVC_IP:SVC_PORT</code> åˆ°æˆ‘ä»¬çš„ ipset é‡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipset add ZGZ-CLUSTER-IP 169.254.11.2,tcp:80 -exist</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„ ipset é‡Œ <code>ip,port</code> å’Œ iptables é‡Œ <code>--match-set</code> åé¢çš„ <code>dst,dst</code> ç»„åˆåœ¨ä¸€èµ·å°±æ˜¯ <code>DEST IP</code> å’Œ <code>DEST PORT</code> åŒæ—¶åŒ¹é…ï¼Œä¸‹é¢æ˜¯ä¸€äº›ä¸¾ä¾‹ï¼š</p><table><thead><tr><th align="left">ipset type</th><th align="left">iptables match-set</th><th align="left">Packet fields</th></tr></thead><tbody><tr><td align="left">hash:net,port,net</td><td align="left">src,dst,dst</td><td align="left">src IP CIDR address, dst port, dst IP CIDR address</td></tr><tr><td align="left">hash:net,port,net</td><td align="left">dst,src,src</td><td align="left">dst IP CIDR address, src port, src IP CIDR address</td></tr><tr><td align="left">hash:ip,port,ip</td><td align="left">src,dst,dst</td><td align="left">src IP address, dst port, dst IP address</td></tr><tr><td align="left">hash:ip,port,ip</td><td align="left">dst,src,src</td><td align="left">dst IP address, src port, src ip address</td></tr><tr><td align="left">hash:mac</td><td align="left">src</td><td align="left">src mac address</td></tr><tr><td align="left">hash:mac</td><td align="left">dst</td><td align="left">dst mac address</td></tr><tr><td align="left">hash:ip,mac</td><td align="left">src,src</td><td align="left">src IP address, src mac address</td></tr><tr><td align="left">hash:ip,mac</td><td align="left">dst,dst</td><td align="left">dst IP address, dst mac address</td></tr><tr><td align="left">hash:ip,mac</td><td align="left">dst,src</td><td align="left">dst IP address, src mac address</td></tr></tbody></table><p>ç„¶åè®¿é—®ä¸‹è¿˜æ˜¯ä¸é€šï¼Œé€šè¿‡ä¸¤å°æœºå™¨è½®è¯¢è´Ÿè½½å‡è¡¡çš„ curl html è¿”å›å†…å®¹çœ‹åˆ°äº†è®¿é—®ä¸é€šçš„æ—¶å€™éƒ½æ˜¯è°ƒåº¦åˆ°éæœ¬æœºï¼Œä¹Ÿå°±æ˜¯æ­¤åˆ»çš„ curl åªç»è¿‡ <code>OUTPUT</code> é“¾ï¼Œè¿‡ <code>POSTROUTING</code> çš„æ—¶å€™å¹¶æ²¡æœ‰ mark ä¹Ÿå°±ä¸ä¼šåš masq ï¼Œ è°ƒè¯•äº†ä¸‹å‘ç°ç¡®å®ä¼šèµ° <code>OUTPUT</code> é“¾ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;kern.warning /var/log/iptables.log&#x27;</span> &gt;&gt; /etc/rsyslog.conf</span><br><span class="line">$ systemctl restart rsyslog</span><br><span class="line">$ iptables -t nat -I OUTPUT -m <span class="built_in">set</span> --match-set ZGZ-CLUSTER-IP dst,dst  -j LOG --log-prefix <span class="string">&#x27;**log-test**&#x27;</span></span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">^C</span><br><span class="line">$ <span class="built_in">cat</span> /var/log/iptables.log</span><br><span class="line">Sep 27 23:17:51 centos7 kernel: **log-test**IN= OUT=lo SRC=169.254.11.2 DST=169.254.11.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=44864 DF PROTO=TCP SPT=50794 DPT=80 WINDOW=43690 RES=0x00 SYN URGP=0 </span><br><span class="line">Sep 27 23:17:52 centos7 kernel: **log-test**IN= OUT=lo SRC=169.254.11.2 DST=169.254.11.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=2010 DF PROTO=TCP SPT=50796 DPT=80 WINDOW=43690 RES=0x00 SYN URGP=0 </span><br></pre></td></tr></table></figure><p>éœ€è¦æ·»åŠ ä¸‹é¢è§„åˆ™ï¼Œè®©å®ƒä¹Ÿè¿›ä¸‹ svc åˆ¤æ–­å’Œæ‰“ markï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A OUTPUT -m comment --comment <span class="string">&quot;zgz service portals&quot;</span> -j ZGZ-SERVICES</span><br></pre></td></tr></table></figure><h3 id="keepalived-çš„è‡ªåŠ¨åŒ–å®ç°"><a href="#keepalived-çš„è‡ªåŠ¨åŒ–å®ç°" class="headerlink" title="keepalived çš„è‡ªåŠ¨åŒ–å®ç°"></a>keepalived çš„è‡ªåŠ¨åŒ–å®ç°</h3><p>åˆ°ç›®å‰ä¸ºæ­¢éƒ½æ˜¯æ‰‹åŠ¨æŒ¡ï¼Œè€Œä¸”æ²¡å¥åº·æ£€æŸ¥ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ keepalived åšä¸ªè‡ªåŠ¨æŒ¡çš„ã€‚</p><h4 id="å®‰è£…-keepalived-2"><a href="#å®‰è£…-keepalived-2" class="headerlink" title="å®‰è£… keepalived 2"></a>å®‰è£… keepalived 2</h4><p>CentOS7 è‡ªå¸¦çš„æºé‡Œ <code>keepalived</code> ç‰ˆæœ¬å¾ˆä½ï¼Œæˆ‘ä»¬å®‰è£…ä¸‹æ¯”è‡ªå¸¦æ–°çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y http://www.nosuchhost.net/~cheese/fedora/packages/epel-7/x86_64/cheese-release-7-1.noarch.rpm</span><br><span class="line">yum install -y keepalived</span><br><span class="line"><span class="comment"># å¤‡ä»½ä¸‹è‡ªå¸¦çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cp</span> /etc/keepalived/keepalived.conf&#123;,.bak&#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®-keepalived"><a href="#é…ç½®-keepalived" class="headerlink" title="é…ç½® keepalived"></a>é…ç½® keepalived</h4><p>æˆ‘ä»¬éœ€è¦é…ç½®ä¸‹ keepalived ï¼Œä¿®æ”¹ä¹‹å‰å…ˆçœ‹ä¸‹é»˜è®¤ç›¸å…³çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl <span class="built_in">cat</span> keepalived</span><br><span class="line"><span class="comment"># /usr/lib/systemd/system/keepalived.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=LVS and VRRP High Availability Monitor</span><br><span class="line">After=syslog.target network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">KillMode=process</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/keepalived</span><br><span class="line">ExecStart=/usr/sbin/keepalived <span class="variable">$KEEPALIVED_OPTIONS</span></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">$ <span class="built_in">cat</span> /etc/sysconfig/keepalived</span><br><span class="line"><span class="comment"># Options for keepalived. See `keepalived --help&#x27; output and keepalived(8) and</span></span><br><span class="line"><span class="comment"># keepalived.conf(5) man pages for a list of all options. Here are the most</span></span><br><span class="line"><span class="comment"># common ones :</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># --vrrp               -P    Only run with VRRP subsystem.</span></span><br><span class="line"><span class="comment"># --check              -C    Only run with Health-checker subsystem.</span></span><br><span class="line"><span class="comment"># --dont-release-vrrp  -V    Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.</span></span><br><span class="line"><span class="comment"># --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.</span></span><br><span class="line"><span class="comment"># --dump-conf          -d    Dump the configuration data.</span></span><br><span class="line"><span class="comment"># --log-detail         -D    Detailed log messages.</span></span><br><span class="line"><span class="comment"># --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">&quot;-D&quot;</span></span><br></pre></td></tr></table></figure><p><code>/etc/sysconfig/keepalived</code> é‡Œä¿®æ”¹ä¸ºä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KEEPALIVED_OPTIONS=&quot;-D --log-console --log-detail --use-file=/etc/keepalived/keepalived.conf&quot;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€‰æ‹©åœ¨ä¸»é…ç½®æ–‡ä»¶é‡Œå» include å­é…ç½®æ–‡ä»¶ï¼Œkeepalivd æ¥æ”¶ <code>kill -HUP</code> ä¿¡å·è§¦å‘ reload ï¼Œåç»­è‡ªåŠ¨åŒ–æ·»åŠ  SVC çš„æ—¶å€™æ·»åŠ å­é…ç½®æ–‡ä»¶åå‘é€ä¿¡å·å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">! Configuration File for keepalived</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">global_defs &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"># è®°ä½ keepalived çš„ä»»ä½•é…ç½®æ–‡ä»¶ä¸èƒ½æœ‰ x æƒé™</span></span><br><span class="line"><span class="string">include /etc/keepalived/conf.d/*.conf</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/keepalived/conf.d/</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†™ä¸€ä¸ªè„šæœ¬ï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥æ·»åŠ ä¸€ä¸ªå­é…ç½®æ–‡ä»¶é‡Œçš„ç›¸å…³ä¿¡æ¯åˆ° ipset é‡Œï¼Œå¦ä¸€æ–¹é¢ä¹Ÿè®©å®ƒåœ¨é‡å¯æˆ–è€…å¯åŠ¨ keepalived çš„æ—¶å€™æ¯æ¬¡èƒ½åˆå§‹åŒ–ï¼Œå…ˆæ·»åŠ  systemd çš„éƒ¨åˆ†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/lib/systemd/system/keepalived.service.d</span><br><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/keepalived.service.d/10.keepalived.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStartPre=/etc/keepalived/ipvs.sh</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>ç„¶åç¼–å†™è„šæœ¬ <code>/etc/keepalived/ipvs.sh</code> :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">dummy_if=svc</span><br><span class="line">CONF_DIR=/etc/keepalived/conf.d/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ipset_init</span></span>()&#123;</span><br><span class="line">    ipset create ZGZ-CLUSTER-IP <span class="built_in">hash</span>:ip,port -exist</span><br><span class="line">    ipset flush ZGZ-CLUSTER-IP</span><br><span class="line">    <span class="built_in">local</span> f ip port protocol</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> $(find  <span class="variable">$&#123;CONF_DIR&#125;</span> -maxdepth 1 -<span class="built_in">type</span> f -name <span class="string">&#x27;*.conf&#x27;</span>);<span class="keyword">do</span></span><br><span class="line">        awk <span class="string">&#x27;&#123;if($1==&quot;virtual_server&quot;)&#123;printf $2&quot; &quot;$3&quot; &quot;;flag=1;&#125;;if(flag==1 &amp;&amp; $1==&quot;protocol&quot;)&#123;print $2;flag=0&#125;&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$f</span>&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> ip port protocol;<span class="keyword">do</span></span><br><span class="line">            <span class="comment"># SVC IP port æ’å…¥ ipset é‡Œ</span></span><br><span class="line">            ipset add ZGZ-CLUSTER-IP <span class="variable">$&#123;ip&#125;</span>,<span class="variable">$&#123;protocol,,&#125;</span>:<span class="variable">$&#123;port&#125;</span> -exist</span><br><span class="line">            <span class="comment"># æ·»åŠ  SVC IP åˆ° dummy æ¥å£ä¸Š</span></span><br><span class="line">            <span class="keyword">if</span> ! ip r g <span class="variable">$&#123;ip&#125;</span> | grep -qw lo;<span class="keyword">then</span></span><br><span class="line">                ip addr add <span class="variable">$&#123;ip&#125;</span>/32 dev <span class="variable">$&#123;dummy_if&#125;</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">create_Chain_in_nat</span></span>()&#123;</span><br><span class="line">    <span class="comment"># delete use -X</span></span><br><span class="line">    <span class="built_in">local</span> Chain option</span><br><span class="line">    option=<span class="string">&quot;-t nat --wait&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> Chain <span class="keyword">in</span> <span class="variable">$@</span>;<span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> ! iptables <span class="variable">$option</span> -S | grep -Eq -- <span class="string">&quot;-N\s+<span class="variable">$&#123;Chain&#125;</span>$&quot;</span>;<span class="keyword">then</span></span><br><span class="line">        iptables <span class="variable">$option</span> -N <span class="variable">$&#123;Chain&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">create_Rule_in_nat</span></span>()&#123;</span><br><span class="line">    <span class="built_in">local</span> cmd=<span class="string">&#x27;iptables -t nat --wait &#x27;</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="variable">$&#123;cmd&#125;</span>  --check <span class="string">&quot;<span class="variable">$@</span>&quot;</span> 2&gt;/dev/null;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;cmd&#125;</span> -A <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">iptables_init</span></span>()&#123;</span><br><span class="line">    create_Chain_in_nat ZGZ-SERVICES  ZGZ-SERVICES-POSTROUTING ZGZ-SERVICES-MARK-MASQ</span><br><span class="line"></span><br><span class="line">    create_Rule_in_nat ZGZ-SERVICES-MARK-MASQ -j MARK --set-xmark 0x2000/0x2000</span><br><span class="line"></span><br><span class="line">    create_Rule_in_nat ZGZ-SERVICES -m comment --comment <span class="string">&quot;zgz service cluster ip + port for masquerade purpose&quot;</span> -m <span class="built_in">set</span> --match-set ZGZ-CLUSTER-IP dst,dst -j ZGZ-SERVICES-MARK-MASQ</span><br><span class="line"></span><br><span class="line">    create_Rule_in_nat PREROUTING -m comment --comment <span class="string">&quot;zgz service portals&quot;</span> -j ZGZ-SERVICES</span><br><span class="line">    create_Rule_in_nat OUTPUT -m comment --comment <span class="string">&quot;zgz service portals&quot;</span> -j ZGZ-SERVICES</span><br><span class="line"></span><br><span class="line">    create_Rule_in_nat ZGZ-SERVICES-POSTROUTING -m comment --comment <span class="string">&quot;zgz service traffic requiring SNAT&quot;</span> -m mark --mark 0x2000/0x2000 -j MASQUERADE</span><br><span class="line">    create_Rule_in_nat POSTROUTING -m comment --comment <span class="string">&quot;zgz postrouting rules&quot;</span> -j ZGZ-SERVICES-POSTROUTING</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ipvs_svc_run</span></span>()&#123;</span><br><span class="line">  ip addr flush dev <span class="variable">$&#123;dummy_if&#125;</span></span><br><span class="line">  ipset_init</span><br><span class="line">  iptables_init</span><br><span class="line">  <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/vs/conntrack</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># æ— å‚æ•°åˆ™æ˜¯ keepalived å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶å•ä¸ªé…ç½®æ–‡ä»¶å‚æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line">  <span class="keyword">if</span> [ ! -d /proc/sys/net/ipv4/conf/<span class="variable">$&#123;dummy_if&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">    ip <span class="built_in">link</span> add <span class="variable">$&#123;dummy_if&#125;</span> <span class="built_in">type</span> dummy</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    ipvs_svc_run</span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> file fullFile ip port protocol</span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$@</span>;<span class="keyword">do</span></span><br><span class="line">    fullFile=<span class="variable">$&#123;CONF_DIR&#125;</span>/<span class="variable">$file</span></span><br><span class="line">      awk <span class="string">&#x27;&#123;if($1==&quot;virtual_server&quot;)&#123;printf $2&quot; &quot;$3&quot; &quot;;flag=1;&#125;;if(flag==1 &amp;&amp; $1==&quot;protocol&quot;)&#123;print $2;flag=0&#125;&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$f</span>&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> ip port protocol;<span class="keyword">do</span></span><br><span class="line">          <span class="comment"># SVC IP port æ’å…¥ ipset é‡Œ</span></span><br><span class="line">          ipset add ZGZ-CLUSTER-IP <span class="variable">$&#123;ip&#125;</span>,<span class="variable">$&#123;protocol,,&#125;</span>:<span class="variable">$&#123;port&#125;</span> -exist</span><br><span class="line">          <span class="comment"># æ·»åŠ  SVC IP åˆ° dummy æ¥å£ä¸Š</span></span><br><span class="line">          <span class="keyword">if</span> ! ip r g <span class="variable">$&#123;ip&#125;</span> | grep -qw lo;<span class="keyword">then</span></span><br><span class="line">              ip addr add <span class="variable">$&#123;ip&#125;</span>/32 dev <span class="variable">$&#123;dummy_if&#125;</span></span><br><span class="line">          <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="comment"># é‡æ–° reload </span></span><br><span class="line">  pkill --signal HUP keepalived</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="variable">$@</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è„šæœ¬å°±å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œè¯»å– keepalived çš„ lvs æ–‡ä»¶ï¼ŒæŠŠ <code>VIP:PORT</code> åŠ åˆ° ipset é‡Œï¼ŒVIP åŠ åˆ° <code>dummy</code> æ¥å£ä¸Šï¼Œä¹‹å‰æ˜¯åŠ åˆ° eth0 ä¸Šï¼Œä½†æ˜¯ä¸šåŠ¡ç½‘å¡å¯èƒ½ä¼šé‡å¯å½±å“ï¼Œdummy æ¥å£å’Œ loopback ç±»ä¼¼ï¼Œå®ƒæ€»æ˜¯ up çš„ï¼Œé™¤éä½  down æ‰å®ƒï¼ŒSVC åœ°å€é…ç½®åœ¨å®ƒä¸Šé¢ä¸ä¼šéšç€ç‰©ç†æ¥å£çŠ¶æ€å˜åŒ–è€Œå—åˆ°å½±å“ã€‚åˆ é™¤æ‰ä¹‹å‰ eth0 ä¸Šçš„ VIP <code>ip addr del 169.254.11.2/32 dev eth0</code>ï¼Œç„¶åæŠŠå‰é¢çš„è½¬æˆ keepalived çš„é…ç½®æ–‡ä»¶æµ‹è¯•ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> a+x /etc/keepalived/ipvs.sh</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/conf.d/test.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">virtual_server 169.254.11.2 80 &#123;</span></span><br><span class="line"><span class="string">    delay_loop 3</span></span><br><span class="line"><span class="string">    lb_algo rr</span></span><br><span class="line"><span class="string">    lb_kind NAT</span></span><br><span class="line"><span class="string">    protocol TCP</span></span><br><span class="line"><span class="string">    alpha #é»˜è®¤æ˜¯ç¦ç”¨ï¼Œä¼šå¯¼è‡´åœ¨å¯åŠ¨daemonæ—¶ï¼Œæ‰€æœ‰rséƒ½ä¼šä¸Šæ¥ï¼Œå¼€å¯æ­¤é€‰é¡¹ä¸‹åˆ™æ˜¯æ‰€æœ‰çš„RSåœ¨daemonå¯åŠ¨çš„æ—¶å€™æ˜¯downçŠ¶æ€ï¼Œhealthcheckå¥åº·æ£€æŸ¥failedã€‚è¿™æœ‰åŠ©äºå…¶å¯åŠ¨æ—¶è¯¯æŠ¥é”™è¯¯</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    real_server  192.168.2.111 8080 &#123;</span></span><br><span class="line"><span class="string">        weight 1</span></span><br><span class="line"><span class="string">        HTTP_GET  &#123;</span></span><br><span class="line"><span class="string">            url &#123;</span></span><br><span class="line"><span class="string">              path /404</span></span><br><span class="line"><span class="string">              status_code 404</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            connect_port    8080</span></span><br><span class="line"><span class="string">            connect_timeout 2</span></span><br><span class="line"><span class="string">            retry 2</span></span><br><span class="line"><span class="string">            delay_before_retry 2</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    real_server  192.168.2.222 8080 &#123;</span></span><br><span class="line"><span class="string">        weight 1</span></span><br><span class="line"><span class="string">        HTTP_GET  &#123;</span></span><br><span class="line"><span class="string">            url &#123;</span></span><br><span class="line"><span class="string">              path /404</span></span><br><span class="line"><span class="string">              status_code 404</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            connect_port    8080</span></span><br><span class="line"><span class="string">            connect_timeout 2</span></span><br><span class="line"><span class="string">            retry 2</span></span><br><span class="line"><span class="string">            delay_before_retry 2</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># å…ˆæ¸…ç†æ‰ä¹‹å‰æ‰‹åŠ¨æ·»åŠ çš„</span><br><span class="line">ipvsadm --clear</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart keepalived</span><br><span class="line"></span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.222</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.222</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ ip a s svc</span><br><span class="line">4: svc: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether e6:a3:29:07:fa:57 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 169.254.11.2/32 scope global svc</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>åœæ‰ä¸€ä¸ª web ååœ¨æˆ‘ä»¬é…ç½®çš„å¥åº·æ£€æŸ¥å‡ ç§’ä¹Ÿå‰”é™¤äº† rs ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">curl: (7) Failed connect to 169.254.11.2:80; Connection refused</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br><span class="line">$ curl 169.254.11.2/www/test</span><br><span class="line">192.168.2.111</span><br></pre></td></tr></table></figure><h4 id="ç³»ç»Ÿçš„ç›¸å…³é…ç½®"><a href="#ç³»ç»Ÿçš„ç›¸å…³é…ç½®" class="headerlink" title="ç³»ç»Ÿçš„ç›¸å…³é…ç½®"></a>ç³»ç»Ÿçš„ç›¸å…³é…ç½®</h4><p>åé¢é‡å¯åå‘ç°ä¸é€šï¼Œå‘ç°å†…æ ¸æ¨¡å—æ²¡åŠ è½½ï¼Œä½¿ç”¨ <code>systemd-modules-load</code> å»å¼€æœºåŠ è½½ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span>  &gt; /etc/modules-load.d/ipvs.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">ip_vs</span></span><br><span class="line"><span class="string">ip_vs_rr</span></span><br><span class="line"><span class="string">ip_vs_wrr</span></span><br><span class="line"><span class="string">ip_vs_sh</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/90.ipvs.conf &lt;&lt; <span class="string">EOF </span></span><br><span class="line"><span class="string"># https://github.com/moby/moby/issues/31208 </span></span><br><span class="line"><span class="string"># ipvsadm -l --timout</span></span><br><span class="line"><span class="string"># ä¿®å¤ipvsæ¨¡å¼ä¸‹é•¿è¿æ¥timeouté—®é¢˜ å°äº900å³å¯</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time=600</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl=30</span></span><br><span class="line"><span class="string">net.ipv4.vs.conntrack=1</span></span><br><span class="line"><span class="string"># https://github.com/kubernetes/kubernetes/issues/70747 https://github.com/kubernetes/kubernetes/pull/71114</span></span><br><span class="line"><span class="string">net.ipv4.vs.conn_reuse_mode=0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="docker-è¿è¡Œçš„æ–¹æ¡ˆ"><a href="#docker-è¿è¡Œçš„æ–¹æ¡ˆ" class="headerlink" title="docker è¿è¡Œçš„æ–¹æ¡ˆ"></a>docker è¿è¡Œçš„æ–¹æ¡ˆ</h3><p><code>docker-compose</code> æ–‡ä»¶å¦‚ä¸‹ï¼Œè‡ªå·±æŠŠè„šæœ¬æŒ‚è½½è¿›å»å³å¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.5&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">keepalived:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;registry.aliyuncs.com/zhangguanzhang/keepalived:v2.2.0&#x27;</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&#x27;keepalived-ipvs&#x27;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;keepalived-ipvs&quot;</span></span><br><span class="line">    <span class="attr">labels:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">app=keepalived</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cap_drop:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/lib/modules:/lib/modules</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/run/xtables.lock:/run/xtables.lock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d/:/etc/keepalived/conf.d/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./keepalived.conf:/etc/keepalived/keepalived.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./always-initsh.d:/always-initsh.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./tools:/etc/tools/</span></span><br><span class="line">    <span class="attr">command:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">--dont-fork</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--log-console</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--log-detail</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--use-file=/etc/keepalived/keepalived.conf</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">json-file</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-file:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">20m</span></span><br></pre></td></tr></table></figure><p>å®¹å™¨è¿è¡Œæ–¹æ¡ˆæ³¨æ„ä¸€ä¸ªå›½äº§åŒ–çš„é—®é¢˜ï¼Œuos çš„ iptables æ˜¯ nf_tables æ¨¡å¼ï¼Œä¼šæ²¡é”æ–‡ä»¶ <code>/run/xtables.lock</code>ï¼Œéœ€è¦åˆ‡æˆ <code>iptables-legacy</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -V</span><br><span class="line">iptables v1.8.2 (nf_tables)</span><br><span class="line"></span><br><span class="line">update-alternatives --set iptables /usr/sbin/iptables-legacy</span><br><span class="line">update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy</span><br><span class="line">update-alternatives --set arptables /usr/sbin/arptables-legacy</span><br><span class="line">update-alternatives --set ebtables /usr/sbin/ebtables-legacy</span><br><span class="line"></span><br><span class="line">$ iptables -V</span><br><span class="line">iptables v1.8.2 (legacy)</span><br></pre></td></tr></table></figure><h3 id="æ ¹æ®èŠ‚ç‚¹-ip-æ‰©å®¹"><a href="#æ ¹æ®èŠ‚ç‚¹-ip-æ‰©å®¹" class="headerlink" title="æ ¹æ®èŠ‚ç‚¹ ip æ‰©å®¹"></a>æ ¹æ®èŠ‚ç‚¹ ip æ‰©å®¹</h3><p>åç»­æˆ‘ä»¬æœ‰ä¸ªéœ€æ±‚ï¼Œæ ¹æ®èŠ‚ç‚¹ IP æ‰©å®¹ï¼Œå› ä¸ºé…ç½®éƒ½æ˜¯ ansible æ¸²æŸ“çš„ï¼Œè€Œä¸å¯èƒ½è®© ansible é‡æ–°æ¸²æŸ“æ‰€æœ‰çš„æ–‡ä»¶ï¼Œä¹Ÿä¸æƒ³é€ è½®å­ï¼Œçªç„¶æƒ³åˆ°ç”¨è„šæœ¬è§£å†³å¾—äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">: $&#123;node_file:=/etc/tools/node_list.txt&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¯”è¾ƒ index ï¼Œ æ¥ä¿®æ”¹ keepalived é…ç½®æ–‡ä»¶é‡Œçš„ ip</span></span><br><span class="line">: $&#123;new_node_file:=/etc/tools/node_list.txt.new&#125;</span><br><span class="line">: $&#123;CONF_DIR:=/etc/keepalived/conf.d&#125;</span><br><span class="line">: $&#123;DT:=date  +&#x27;%Y-%m-%dT%H:%M:%S%z&#x27;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">logging <span class="built_in">functions</span></span></span><br><span class="line">log() &#123;</span><br><span class="line">local type=&quot;$1&quot;; shift</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">accept argument string or stdin</span></span><br><span class="line">local text=&quot;$*&quot;; if [ &quot;$#&quot; -eq 0 ]; then text=&quot;$(cat)&quot;; fi</span><br><span class="line">local dt; dt=&quot;$($DT)&quot;</span><br><span class="line">printf &#x27;%s [%s] [scale.sh]: %s\n&#x27; &quot;$dt&quot; &quot;$type&quot; &quot;$text&quot;</span><br><span class="line">&#125;</span><br><span class="line">log_note() &#123;</span><br><span class="line">log Note &quot;$@&quot;</span><br><span class="line">&#125;</span><br><span class="line">log_warn() &#123;</span><br><span class="line">log Warn &quot;$@&quot; &gt;&amp;2</span><br><span class="line">&#125;</span><br><span class="line">log_error() &#123;</span><br><span class="line">log ERROR &quot;$@&quot; &gt;&amp;2</span><br><span class="line">exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function generated_new()&#123;</span><br><span class="line">    local file=$1 print_flag=0 rs_port= end_block=0 start_block=0 block_str= </span><br><span class="line">    local new_file=$&#123;file&#125;.new h line</span><br><span class="line"></span><br><span class="line">    # æ²¡æœ‰æ³¨é‡Š node_scale=true åˆ™è·³è¿‡ï¼Œå› ä¸ºæ‰€æœ‰keepalive é…ç½®æ–‡ä»¶éƒ½åœ¨ä¸€ä¸ªç›®å½•</span><br><span class="line">    # éƒ¨åˆ†é…ç½®æ–‡ä»¶å¯¹åº”çš„æœåŠ¡ä¸æ˜¯åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥ apps ç±»éœ€è¦æ‰©å®¹çš„åº”ç”¨éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œæ³¨é‡Šè¡¨æ˜å¯ä»¥æ‰©å®¹</span><br><span class="line">    grep -Eqw &#x27;node_scale=true&#x27; $file || return 0</span><br><span class="line">    rm -f $&#123;new_file&#125;;touch $&#123;new_file&#125;</span><br><span class="line">    # IFS ä¿æŒåŸæ ·è¾“å‡º</span><br><span class="line">    while IFS= read line;do</span><br><span class="line"></span><br><span class="line">        # æ³¨é‡Šå’Œç©ºè¡Œè¾“å‡º</span><br><span class="line">        if echo &quot;$line&quot; | grep -Eq &#x27;^\s*$|^\s*#&#x27;;then</span><br><span class="line">            echo &quot;$line&quot; &gt;&gt; $&#123;new_file&#125;</span><br><span class="line">            continue</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        echo &quot;$line&quot; | grep -Eq &#x27;^\s*virtual_server&#x27; &amp;&amp; &#123;</span><br><span class="line">            print_flag=1</span><br><span class="line">            block_str=</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # è·³è¿‡å‰©ä¸‹çš„ real_serverï¼Œå› ä¸ºæ‰€æœ‰ real server çš„å†…éƒ¨å±æ€§ä¸€æ ·</span><br><span class="line">        [ $print_flag -eq 5 ] &amp;&amp; continue</span><br><span class="line"></span><br><span class="line">        echo &quot;$line&quot; | grep -Eq &#x27;^\s*real_server&#x27; &amp;&amp; &#123;</span><br><span class="line">            print_flag=2</span><br><span class="line">            rs_port=$( echo $line | awk &#x27;&#123;print $3&#125;&#x27; )</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if [ $print_flag -eq 2 ];then</span><br><span class="line">            (( start_block+=$(echo &quot;$line&quot; | sed &#x27;s@#.+@@&#x27; | grep -Eo &#x27;\&#123;&#x27; | wc -l) ))</span><br><span class="line">            (( end_block+=$(echo &quot;$line&quot; | sed &#x27;s@#.+@@&#x27; | grep -Eo &#x27;\&#125;&#x27; | wc -l) ))</span><br><span class="line">            [ -z &quot;$block_str&quot; ] &amp;&amp; block_str=&quot;$&#123;line&#125;&quot; || block_str=&quot;$&#123;block_str&#125;</span><br><span class="line">    $&#123;line&#125;&quot;</span><br><span class="line"></span><br><span class="line">            if [ &quot;$end_block&quot; -ne 0 ] &amp;&amp; [ &quot;$start_block&quot; -eq &quot;$end_block&quot; ];then</span><br><span class="line"></span><br><span class="line">                for h in $&#123;node_array[@]&#125;;do</span><br><span class="line">                    printf &quot;    real_server %s %s &#123;\n%s\n    &#125;\n&quot; $h $rs_port &quot;$block_str&quot; &gt;&gt; $&#123;new_file&#125;</span><br><span class="line">                done</span><br><span class="line">                echo &#x27;&#125;&#x27; &gt;&gt; $&#123;new_file&#125;</span><br><span class="line">                start_block=0</span><br><span class="line">                end_block=0</span><br><span class="line">                print_flag=5</span><br><span class="line">            fi</span><br><span class="line"></span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        if [ $print_flag -eq 1 ];then</span><br><span class="line">            echo &quot;$line&quot; &gt;&gt; $&#123;new_file&#125;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">    done &lt; $file</span><br><span class="line">    cat $&#123;new_file&#125; &gt; $file</span><br><span class="line">    rm -f $&#123;new_file&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function main()&#123;</span><br><span class="line"></span><br><span class="line">    if [ -z &quot;$&#123;CONF_DIR&#125;&quot; ] || [ ! -f &quot;$node_file&quot; ];then</span><br><span class="line">        return 0</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    read -a node_array &lt; &quot;$node_file&quot;</span><br><span class="line"></span><br><span class="line">    if [ -f &quot;$new_node_file&quot; ];then</span><br><span class="line">        read -a new_node_array &lt; &quot;$new_node_file&quot;</span><br><span class="line">        if [ &quot;$&#123;#node_array[@]&#125;&quot; -ne $&#123;#new_node_array[@]&#125; ];then</span><br><span class="line">            log_error &quot;æ–°è€ node_list æ–‡ä»¶é‡Œ IP æ•°é‡ä¸åŒ¹é…ï¼Œæ— æ³•æ‰§è¡Œæ›´æ”¹ IP æ“ä½œ&quot;</span><br><span class="line">        fi</span><br><span class="line">        for((i=0;i&lt;$&#123;#node_array[@]&#125;;i++))</span><br><span class="line">        do</span><br><span class="line">            #echo sed -ri &quot;s#$&#123;node_array[$i]&#125;#$&#123;new_node_array[$i]&#125;#&quot; $&#123;CONF_DIR&#125;/*.conf</span><br><span class="line">            # æ›¿æ¢æˆæ–°çš„ IP</span><br><span class="line">            sed -ri &quot;s#$&#123;node_array[$i]&#125;#$&#123;new_node_array[$i]&#125;#&quot; $&#123;CONF_DIR&#125;/*.conf</span><br><span class="line">        done</span><br><span class="line">        cat &quot;$new_node_file&quot; &gt; &quot;$node_file&quot;</span><br><span class="line">        rm -f &quot;$new_node_file&quot;</span><br><span class="line">    else</span><br><span class="line">        export -f generated_new</span><br><span class="line">        if [ &quot;$&#123;#node_array[@]&#125;&quot; -le 2 ];then</span><br><span class="line">            # é€ä¼  node_array</span><br><span class="line">            find $&#123;CONF_DIR&#125; -type f -name &#x27;*.conf&#x27; | xargs -n1 -I &#123;&#125; -P 0 bash -c &quot;`declare -p node_array`; generated_new &#123;&#125;&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è„šæœ¬å­˜åœ¨å®¹å™¨é‡Œçš„ <code>/etc/tools/sacle.sh</code> ï¼Œç„¶åæ‰€æœ‰çš„èŠ‚ç‚¹ IP å­˜åœ¨ <code>tools/node_list.txt</code> ï¼Œè®© <code>sacle.sh</code> è¯»å–è¿›æ¥å½¢æˆ array ï¼Œç„¶åå¯¹æ¯ä¸ªé…ç½®æ–‡ä»¶æ‰§è¡Œä¸Šé¢è„šæœ¬ã€‚</p><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul><li><a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.filter_rules.html">Interaction between LVS and netfilter</a></li><li><a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.LVS-NAT.html#lvs_nat_intro">lvs nat</a></li><li><a href="https://github.com/liexusong/linux-source-code-analyze/blob/master/lvs-principle-and-source-analysis-part2.md">lvs-principle-and-source-analysis</a></li><li><a href="https://www.zsythink.net/archives/1199">æœ±åŒå°å¤§ä½¬çš„ iptables æŠ€æœ¯ç³»åˆ—</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å†…éƒ¨æœ‰é K8S ç¯å¢ƒä¸Šéœ€è¦ç±»ä¼¼ SVC çš„è´Ÿè½½å®ç°ï¼Œä¸€å¼€å§‹æ˜¯ç”¨ NGINX åšçš„ï¼Œæ‰€æœ‰ SVC åŸŸåéƒ½è§£ææˆä¸€ä¸ª dummy IP ï¼Œç„¶å</summary>
      
    
    
    
    
    <category term="lvs" scheme="http://zhangguanzhang.github.io/tags/lvs/"/>
    
    <category term="ipvsadm" scheme="http://zhangguanzhang.github.io/tags/ipvsadm/"/>
    
    <category term="kube-proxy" scheme="http://zhangguanzhang.github.io/tags/kube-proxy/"/>
    
  </entry>
  
  <entry>
    <title>è§£å†³ docker çš„ read unix @-&gt;/run/containerd/s/xxx read: connection reset by peer: unknown</title>
    <link href="http://zhangguanzhang.github.io/2021/09/16/read-containerd-con-reset/"/>
    <id>http://zhangguanzhang.github.io/2021/09/16/read-containerd-con-reset/</id>
    <published>2021-09-16T18:14:06.000Z</published>
    <updated>2021-09-16T18:14:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ä¸ºäº†æµ‹è¯•å…³æœºå¯¹é›†ç¾¤çš„å½±å“ï¼Œå…³æœºäº†å‡ å°æœºå™¨åå¾ˆå¤š pod ä¸€ç›´ <code>CrashLoopBackOff</code> å’Œ <code>RunContainerError</code> æˆ–è€…ä¸€ç›´æ— æ³•å°±ç»ª</p><h3 id="ç¯å¢ƒä¿¡æ¯"><a href="#ç¯å¢ƒä¿¡æ¯" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS76 ~]# docker info</span><br><span class="line">Client:</span><br><span class="line"> Debug Mode: false</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 404</span><br><span class="line">  Running: 258</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 146</span><br><span class="line"> Images: 110</span><br><span class="line"> Server Version: 19.03.14</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: true</span><br><span class="line">  Native Overlay Diff: true</span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: local</span><br><span class="line">  Network: bridge host ipvlan macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: runc</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: ea765aba0d05254012b0b9e595e995c09186427f</span><br><span class="line"> runc version: v1.0.0-0-g84113eef6fc2</span><br><span class="line"> init version: fec3683</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 3.10.0-1160.36.2.el7.x86_64</span><br><span class="line"> Operating System: CentOS Linux 7 (Core)</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 16</span><br><span class="line"> Total Memory: 62.76GiB</span><br><span class="line"> Name: CentOS76</span><br><span class="line"> ID: BJ2X:EX7H:SCME:Q3AD:IP2M:IB2D:E4RL:XA4C:EOMQ:7S3F:DIA6:WQ2C</span><br><span class="line"> Docker Root Dir: /data/kube/docker</span><br><span class="line"> Debug Mode: false</span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: false</span><br><span class="line"> Insecure Registries:</span><br><span class="line">  reg.xxx.lan:5000</span><br><span class="line">  treg.yun.xxx.cn</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Registry Mirrors:</span><br><span class="line">  https://registry.docker-cn.com/</span><br><span class="line">  https://docker.mirrors.ustc.edu.cn/</span><br><span class="line"> Live Restore Enabled: false</span><br><span class="line"> Product License: Community Engine</span><br></pre></td></tr></table></figure><h2 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h2><p>æ—¥å¿—æŸ¥çœ‹å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunContainerError: failed to start container &quot;90353b19ae6c7209ba1785286c292f2362fa069b578f2e2731e93747c5ba1912&quot;: Error response from daemon: OCI runtime create failed: unable to retrieve OCI runtime error (open /run/docker/containerd/daemon/io.containerd.runtime.v1.linux/moby/90353b19ae6c7209ba1785286c292f2362fa069b578f2e2731e93747c5ba1912/log.json: no such file or directory): runc did not terminate sucessfully: unknown</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸‹é¢æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runc did not terminate sucessfully: runtime/cgo: pthread_create failed: Resource temporarily unavailable</span><br><span class="line"></span><br><span class="line">container 9853a196008b92033a299e098d73d4268a76ce58faecfe40ca3411857d44a776: unknown error after kill: fork/exec /data/kube/bin/runc: resource temporarily unavailable: : unknown&quot;</span><br></pre></td></tr></table></figure><p>åº”è¯¥èµ„æºé™åˆ¶äº†ï¼Œçœ‹äº†ä¸‹é»˜è®¤çš„ <code>kernel.pid_max</code> å¤ªå°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -n kernel.pid_max</span><br><span class="line">32768</span><br></pre></td></tr></table></figure><p>åé¢é™†é™†ç»­ç»­è°ƒæ•´äº†ä¸€äº›ä¸‹é¢çš„å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/security/limits.d/21-custom.conf&lt;&lt;EOF</span><br><span class="line">*       soft    nproc   131072</span><br><span class="line">*       hard    nproc   131072</span><br><span class="line">*       soft    nofile  131072</span><br><span class="line">*       hard    nofile  131072</span><br><span class="line">root    soft    nproc   131072</span><br><span class="line">root    hard    nproc   131072</span><br><span class="line">root    soft    nofile  131072</span><br><span class="line">root    hard    nofile  131072</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sed -ri &#x27;s/^#(DefaultLimitCORE)=/\1=100000/&#x27; /etc/systemd/system.conf</span><br><span class="line">sed -ri &#x27;s/^#(DefaultLimitNOFILE)=/\1=100000/&#x27; /etc/systemd/system.conf</span><br></pre></td></tr></table></figure><p>ç„¶åé‡å¯å pod è¿˜æ²¡æœ‰å¥½è½¬ï¼Œå¯åŠ¨ä¸€ç›´å¤„äº Create çš„å®¹å™¨ä¼šæœ‰ä¸‹é¢é”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS76 ~]# docker start 034f</span><br><span class="line">Error response from daemon: read unix @-&gt;/run/containerd/s/2ac09cf054eb19b79336b25efe1aeeaf22bcf0d9559ca79b8459c3490cd6034f: read: connection reset by peer: unknown</span><br><span class="line">Error: failed to start containers: 034f</span><br></pre></td></tr></table></figure><p>æ‰‹åŠ¨èµ·å®¹å™¨æŠ¥é”™ä¸‹é¢çš„ï¼Œè°ƒæ•´å‚æ•°åæ›´å¤šæ˜¯ä¸Šé¢çš„æŠ¥é”™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm nginx:1.19-alpine</span><br><span class="line">docker: Errpr response from daemon: failed to start shim: fork/exec /usr/bin/containerd-shim: resource temporarily unavailable: unknown.</span><br></pre></td></tr></table></figure><p><code> read unix @-&gt;/run/containerd/s</code> è¿™ä¸ªæŒ‰ç…§æµç¨‹èµ°å°±æ˜¯ contained çš„é—®é¢˜äº†ï¼Œå¯ä»¥ä» <a href="https://github.com/docker/docker-ce/blob/d7080c17a580919f5340a15a8e5e013133089680/components/engine/libcontainerd/remote_daemon.go#L244">æºç </a> å¾—çŸ¥ï¼Œå¦‚æœæ²¡å¯åŠ¨ containerd ï¼Œdocker åˆ™ä¼š os.Exec èµ·ä¸€ä¸ª <code>containerd</code> ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps aux | grep &#x27;\scontainerd\s&#x27;</span><br><span class="line">root     147580  2.4  0.1 10375568 104588 ?     Ssl  17:06   3:15 containerd --config /var/run/docker/containerd/containerd.toml --log-level warn</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ docker æ˜¯å®˜æ–¹çš„ static äºŒè¿›åˆ¶å®‰è£…çš„ï¼Œå»çœ‹äº†ä¸‹ rpm å®‰è£…çš„è¯ä¼šåˆ†ç¦»å¼€ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸ª containerd çš„ rpmï¼Œæœ‰ä¸€ä¸ª <code>containerd.service</code> æœåŠ¡ã€‚ æƒ³ç€çœ‹ä¸‹æˆ‘ä»¬ç¯å¢ƒä¸Šçš„ containerd çš„è¾“å‡ºæ—¥å¿—ï¼Œä½†æ˜¯æºç çœ‹çš„è¯å‘½ä»¤çš„è¾“å‡ºéƒ½æ˜¯ç»‘å®šåˆ° docker çš„è¾“å‡ºçš„ã€‚è€Œä¸”å‘½ä»¤è¡Œå‚æ•°å›ºå®šçš„ã€æ— æ³•æ”¹ä¸º debug levelã€‚</p><p>æ‰‹åŠ¨æ€æ‰å¯åŠ¨ä¸‹è¯•è¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 147580 &amp;&amp; containerd --config /var/run/docker/containerd/containerd.toml --log-level debug</span><br></pre></td></tr></table></figure><p>å¦å¤–å¼€ä¸ª ssh çª—å£å‘ç° pod çŠ¶æ€éƒ½æ­£å¸¸äº†ã€‚è¯´æ˜äº† systemd å¯åŠ¨çš„ docker æœ‰é™åˆ¶ï¼Œå» dockerd çš„ proc ç›®å½•å•¥çš„æŸ¥æ‰¾äº†ä¸‹çœ‹æ²¡è¾¾åˆ°æ–‡ä»¶å•¥çš„é™åˆ¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS76 ~]# pgrep dockerd</span><br><span class="line">113233</span><br><span class="line">[root@CentOS76 ~]# lsof -p 113233  | wc -l</span><br><span class="line">956</span><br></pre></td></tr></table></figure><p>æœ€åæ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼Œä¸‹é¢çš„<code>Tasks: 2043 (limit: 2048)</code> é™åˆ¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS76 ~]# systemctl status docker</span><br><span class="line">â— docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/docker.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since å›› 2021-09-16 16:53:21 CST; 4min 16s ago</span><br><span class="line">     Docs: http://docs.docker.io</span><br><span class="line">  Process: 113228 ExecStopPost=/bin/sh -c /sbin/iptables --wait -D INPUT -i cni0 -j ACCEPT &amp;&gt; /dev/null || : (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 113225 ExecStopPost=/bin/sh -c /sbin/iptables --wait -D FORWARD -s 0.0.0.0/0 -j ACCEPT &amp;&gt; /dev/null || : (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 113236 ExecStartPost=/sbin/iptables --wait -I INPUT -i cni0 -j ACCEPT (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 113234 ExecStartPost=/sbin/iptables --wait -I FORWARD -s 0.0.0.0/0 -j ACCEPT (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 113231 ExecStartPre=/bin/bash -c test -d /var/run/docker.sock &amp;&amp; rmdir /var/run/docker.sock || true (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 113233 (dockerd)</span><br><span class="line">    Tasks: 2043 (limit: 2048)</span><br><span class="line">   Memory: 1.1G</span><br><span class="line">   CGroup: /system.slice/docker.service</span><br><span class="line">           â”œâ”€ 89710 containerd-shim -namespace</span><br></pre></td></tr></table></figure><p>systemd çš„ <code>DefaultTasksMax</code> æ˜¯ <code>2048</code> ï¼Œå¦å¤–å¯¹æ¯”äº†å®˜æ–¹çš„ <code>docker.service</code> æ˜¯ä¸é™åˆ¶ Tasks çš„ï¼Œæˆ‘ä»¬æ²¡åŠ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl cat docker</span><br><span class="line">..</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŠ äº†åé‡å¯ docker å°±å¥½äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/systemd/system/docker.service</span><br><span class="line">TasksMax=infinity</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://plpan.github.io/docker-exec-%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85/">https://plpan.github.io/docker-exec-%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85/</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;ä¸ºäº†æµ‹è¯•å…³æœºå¯¹é›†ç¾¤çš„å½±å“ï¼Œå…³æœºäº†å‡ å°æœºå™¨åå¾ˆå¤š pod ä¸€ç›´ &lt;code&gt;CrashLoopBackOff&lt;/code&gt; å’Œ &lt;code&gt;R</summary>
      
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="containerd" scheme="http://zhangguanzhang.github.io/tags/containerd/"/>
    
  </entry>
  
  <entry>
    <title>[æŒç»­æ›´æ–°] - Openwrt USB ç½‘ç»œ</title>
    <link href="http://zhangguanzhang.github.io/2021/09/03/openwrt-usb-net/"/>
    <id>http://zhangguanzhang.github.io/2021/09/03/openwrt-usb-net/</id>
    <published>2021-09-03T22:29:08.000Z</published>
    <updated>2021-09-03T22:29:08.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="about"><a href="#about" class="headerlink" title="about"></a>about</h2><p>è®°å½•ä¸‹ openwrt ä¸‹ usb ç½‘ç»œçš„æŠ˜è…¾ï¼Œåç»­æŠ˜è…¾è¿™å—å†…å®¹çš„è¯ä¹Ÿåœ¨è¿™ä¸ªæ–‡ç« å†…æ›´æ–°</p><h2 id="N1-ä¸Šçš„-usb-ç½‘ç»œå…±äº«æŠ˜è…¾"><a href="#N1-ä¸Šçš„-usb-ç½‘ç»œå…±äº«æŠ˜è…¾" class="headerlink" title="N1 ä¸Šçš„ usb ç½‘ç»œå…±äº«æŠ˜è…¾"></a>N1 ä¸Šçš„ usb ç½‘ç»œå…±äº«æŠ˜è…¾</h2><h3 id="å›ºä»¶ä¾èµ–"><a href="#å›ºä»¶ä¾èµ–" class="headerlink" title="å›ºä»¶ä¾èµ–"></a>å›ºä»¶ä¾èµ–</h3><p>æš‚æ—¶æ²¡å®Œå…¨åŒºåˆ† usb ç½‘ç»œå…±äº«å’Œ <code>usb-cdc</code> çš„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ç¼–è¯‘çš„æ—¶å€™æŠŠå¾ˆå¤š <code>usb-net-xxx</code> éƒ½ç¼–è¯‘è¿›å»äº†</p><p>å¬å…¶ä»–å¤§ä½¬è¯´ç¼–è¯‘çš„æ—¶å€™ä¸»è¦æœ‰ä¸‹é¢çš„åŒ…:</p><ul><li>å®‰å“: <code>kmod-usb-net kmod-usb-net-rndis</code></li><li>è‹¹æœ: <code>kmod-usb-net-ipheth usbmuxd</code></li></ul><p>å»ºè®®ä¸‹é¢è¿™äº›ä¹Ÿå®‰è£…ä¸Šæ–¹ä¾¿è°ƒè¯•:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_PACKAGE_luci-proto-3g=y</span><br><span class="line">CONFIG_PACKAGE_luci-proto-ncm=y</span><br><span class="line">CONFIG_PACKAGE_luci-proto-qmi=y</span><br><span class="line"></span><br><span class="line">CONFIG_BUSYBOX_DEFAULT_LSPCI=y</span><br><span class="line">CONFIG_BUSYBOX_DEFAULT_LSUSB=y</span><br><span class="line">CONFIG_BUSYBOX_DEFAULT_IPROUTE=y</span><br><span class="line"></span><br><span class="line">CONFIG_PACKAGE_usb-modeswitch=y</span><br><span class="line">CONFIG_PACKAGE_usbutils=y</span><br><span class="line">CONFIG_PACKAGE_usbreset=y</span><br><span class="line">CONFIG_PACKAGE_qmi-utils=y</span><br><span class="line">CONFIG_PACKAGE_libqmi=y</span><br><span class="line"></span><br><span class="line">CONFIG_PACKAGE_bind-dig=y</span><br><span class="line">CONFIG_PACKAGE_tcpdump=y</span><br><span class="line"></span><br><span class="line">CONFIG_PACKAGE_pciutils=y</span><br></pre></td></tr></table></figure><p>è¿™äº›å¥½åƒæ˜¯ usb 4g ç½‘å¡çš„åŒ…ï¼Œä¸€èˆ¬æ˜¯ <code>E3372</code>(è”é€š4G) å’Œ <code>E8372</code>(å…¨ç½‘é€š4Gç‰ˆæœ¬) ï¼Œ</p><p>ç¼ºçœåº”è¯¥éƒ½å¯ä»¥ç”¨hilinkæ¨¡å¼ï¼ŒæŠŠä¸‹é¢è¿™äº›é©±åŠ¨è£…ä¸Šå³å¯:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hilink mode: hilink mode çš„ç½‘å¡å æ˜¯  ethX ä¹Ÿå¯ä»¥è¯´ usb0ï¼Œncmæ¨¡å¼çš„åˆ™æ˜¯wwan0ï¼Œ lsusb æˆ–è€… usb-mode -l æŸ¥çœ‹è®¾å¤‡è¯†åˆ«å¦</span><br><span class="line">kmod-usb-net-rndis kmod-usb-net kmod-usb2 usb-modeswitch</span><br><span class="line"></span><br><span class="line">NCM mode:</span><br><span class="line">gcom kmod-usb-net-huawei-cdc-ncm  kmod-usb2 usb-modeswitch kmod-usb-serial-wwan</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_PACKAGE_uqmi=y</span><br><span class="line">kmod-usb-acm kmod-usb-net kmod-usb-net-qmi-wwan kmod-usb-ohci kmod-usb-serial kmod-usb-serial-option</span><br></pre></td></tr></table></figure><h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>N1 å»ºè®®å¼€ä¸‹æ— çº¿ï¼Œè™½ç„¶è¾£é¸¡ï¼Œä½†æ˜¯å®ƒåªæœ‰ä¸€ä¸ªç½‘å£ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ“ä½œã€‚æˆ‘æ˜¯æˆ‘çš„ <code>redmi k30s</code> usb ç½‘ç»œå…±äº«æ’ç»™ N1ï¼Œå¦ä¸€ä¸ªæ‰‹æœºè¿ N1 æ— çº¿å ssh ä¸Šå»æ•²å‘½ä»¤çš„ã€‚</p><p>å…ˆå¤‡ä»½ä¸‹ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œé˜²æ­¢åé¢æå´©äº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/config/network /etc/config/network.bak</span><br></pre></td></tr></table></figure><p>æ’ä¸Šå»åæœ‰ä¸ª <code>usb0</code> ç½‘å¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# ip a s</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/sit 0.0.0.0 brd 0.0.0.0</span><br><span class="line">3: ip6tnl0@NONE: &lt;NOARP&gt; mtu 1452 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/tunnel6 :: brd :: permaddr d636:b99c:d56d::</span><br><span class="line">4: eth0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq master br-lan state DOWN group default qlen 1000</span><br><span class="line">    link/ether 0e:02:db:93:b8:20 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">6: dummy0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether f2:09:65:33:97:88 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">7: bond0: &lt;BROADCAST,MULTICAST,MASTER&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether 7e:ad:dd:05:72:66 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">8: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master br-lan state UP group default qlen 1000</span><br><span class="line">    link/ether 0e:02:db:93:b8:1f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::c02:dbff:fe93:b81f/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: br-lan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 0e:02:db:93:b8:20 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.1/24 brd 192.168.1.255 scope global br-lan</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fd4e:8614:5748::1/60 scope global noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::c02:dbff:fe93:b820/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">10: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:14:ab:d8:da brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.31.0.1/24 brd 172.31.0.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: usb0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ether 82:e0:7e:db:2c:25 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>udhcpc</code> å‘é€ dhcp è¯·æ±‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# udhcpc -i usb0</span><br><span class="line">udhcpc: started, v1.33.1</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sendto: Network is down</span><br><span class="line">udhcpc: read error: Network is down, reopening socket</span><br><span class="line">udhcpc: sending discover</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹ usbï¼Œç¡®å®æœ‰æˆ‘çš„ æ‰‹æœºï¼Œå±…ç„¶è¦æ‰‹åŠ¨ up å®ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# lsusb</span><br><span class="line">Bus 001 Device 004: ID 2717:ff80 Xiaomi M2007J3SC</span><br><span class="line">Bus 002 Device 001: ID 1d6b:0003 Linux 5.13.13-flippy-63+ xhci-hcd xHCI Host Controller</span><br><span class="line">Bus 001 Device 001: ID 1d6b:0002 Linux 5.13.13-flippy-63+ xhci-hcd xHCI Host Controller</span><br><span class="line"></span><br><span class="line">root@OpenWrt:~# ip link set usb0 up</span><br><span class="line">root@OpenWrt:~# ip a s usb0</span><br><span class="line"></span><br><span class="line">13: usb0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether 0a:01:0f:46:3a:e6 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::801:fff:fe46:3ae6/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">root@OpenWrt:~# udhcpc -i usb0</span><br><span class="line">udhcpc: started, v1.33.1</span><br><span class="line">udhcpc: sending discover</span><br><span class="line">udhcpc: sending select for 192.168.42.128</span><br><span class="line">udhcpc: lease of 192.168.42.128 obtained, lease time 3599</span><br><span class="line">udhcpc: ip addr add 192.168.42.128/255.255.255.0 broadcast 192.168.42.255 dev usb0</span><br><span class="line">udhcpc: setting default routers: 192.168.42.129</span><br></pre></td></tr></table></figure><p>è¯·æ±‚è¿‡ç¨‹ä¸­ä¹ŸæŠŠé»˜è®¤è·¯ç”±è®¾ç½®ä¸ºå®ƒäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~# ip r g 1</span><br><span class="line">1.0.0.0 via 192.168.42.129 dev usb0 src 192.168.42.128 uid 0</span><br><span class="line">    cache</span><br><span class="line">root@OpenWrt:~# ping baudu.com</span><br><span class="line">^C</span><br><span class="line">root@OpenWrt:~# ping 114.114.114.114</span><br><span class="line">PING 114.114.114.114 (114.114.114.114): 56 data bytes</span><br><span class="line">64 bytes from 114.114.114.114: seq=0 ttl=64 time=73.218 ms</span><br><span class="line">64 bytes from 114.114.114.114: seq=1 ttl=70 time=45.460 ms</span><br><span class="line">64 bytes from 114.114.114.114: seq=2 ttl=71 time=43.823 ms</span><br><span class="line">64 bytes from 114.114.114.114: seq=3 ttl=81 time=40.963 ms</span><br><span class="line">^C</span><br><span class="line">--- 114.114.114.114 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 40.963/50.866/73.218 ms</span><br><span class="line">root@OpenWrt:~#</span><br></pre></td></tr></table></figure><p>å» web ä¸Šï¼Œç½‘ç»œæ¥å£ï¼ŒæŠŠ wan çš„å£å­(å¦‚æœæ²¡æœ‰å°±æ·»åŠ )ï¼Œ<code>dhcpå®¢æˆ·ç«¯</code>ï¼Œæ¥å£è®¾é€‰ <code>usb0</code>ã€‚æ·»åŠ åè®¾ç½®ä¸‹æ–°æ·»åŠ æ¥å£çš„ <code>é˜²ç«å¢™è®¾ç½®</code> ï¼Œå°†å…¶è®¾ç½®ä¸º <code>wan: </code>ï¼Œè¦æ³¨æ„ï¼Œä¸Šé¢åçš„ dns æ˜¯ dhcp è·å–çš„ï¼Œä¹Ÿå°±æ˜¯ dnsmasq ä½¿ç”¨ <code>è§£ææ–‡ä»¶</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmp/resolv.conf.auto</span><br></pre></td></tr></table></figure><p>ä½ ä½¿ç”¨è‡ªå·±çš„dns ä¾‹å¦‚ adg ä¹‹ç±»çš„ï¼Œå¯ä»¥å…³é—­ä¸Šé¢çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uci set dhcp.@dnsmasq[0].server=&#x27;127.0.0.1#5300&#x27;</span><br><span class="line">uci set dhcp.@dnsmasq[0].noresolv=&#x27;1&#x27;</span><br><span class="line">uci commit dhcp</span><br><span class="line">/etc/init.d/dnsmasq reload</span><br></pre></td></tr></table></figure><h3 id="hotplug-è„šæœ¬"><a href="#hotplug-è„šæœ¬" class="headerlink" title="hotplug è„šæœ¬"></a>hotplug è„šæœ¬</h3><p>è‡ªè¡Œç™¾åº¦æˆ–è€…è°·æ­Œäº†è§£åŸºç¡€ï¼Œå…ˆè·å–åŸºç¡€ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/hotplug.d/net/01_usb-rndis.sh &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;$DEVTYPE&quot; = usb_device </span></span><br><span class="line"><span class="comment"># [ &quot;$ACTION&quot; = add -a &quot;$DEVTYPE&quot; = usb_device ] || exit 0</span></span><br><span class="line"></span><br><span class="line">. /lib/functions.sh</span><br><span class="line">. /lib/netifd/netifd-proto.sh</span><br><span class="line">logger -t RNDIS: <span class="string">&quot;<span class="subst">$(env)</span>&quot;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>æ‰‹æœºæ’ usb åï¼Œ<code>logread</code> æŸ¥çœ‹æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user.notice RNDIS:: DEVNAME=bus/usb/001/003 USER=root ACTION=add SHLVL=1 HOME=/ SEQNUM=2012 BUSNUM=001 MAJOR=189 HOTPLUG_TYPE=usb DEVPATH=/devices/platform/17000000.usb/usb1/1-1 LOGNAME=root DEVICENAME=1-1 TERM=linux SUBSYSTEM=usb PATH=/usr/sbin:/usr/bin:/sbin:/bin MINOR=2 TYPE=0/0/0 DEVNUM=003 PRODUCT=2717/ff88/419 PWD=/ DEVTYPE=usb_device</span><br><span class="line"></span><br><span class="line">user.notice RNDIS:: USER=root ACTION=add SHLVL=1 HOME=/ SEQNUM=2059 IFINDEX=17 HOTPLUG_TYPE=net DEVPATH=/devices/platform/17000000.usb/usb1/1-1/1-1:1.0/net/usb0 LOGNAME=root DEVICENAME=usb0 TERM=linux SUBSYSTEM=net PATH=/usr/sbin:/usr/bin:/sbin:/bin INTERFACE=usb0 PWD=/</span><br></pre></td></tr></table></figure><p>æ ¹æ®æ­¤ä¿¡æ¯ç¼–å†™å‡ºæˆ‘è‡ªå·±çš„ usb-rndis çš„ <code>hotplug</code> è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/hotplug.d/net/01_usb-rndis.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ &quot;$DEVICENAME&quot; = usb0 ]</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DEVPATH</span> | grep -Eq <span class="string">&#x27;/net/usb0$&#x27;</span> || <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line">. /lib/functions.sh</span><br><span class="line">. /lib/netifd/netifd-proto.sh</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">add)</span><br><span class="line">        <span class="keyword">if</span> [ -L /sys/class/net/usb0 ];<span class="keyword">then</span></span><br><span class="line">            ip <span class="built_in">link</span> <span class="built_in">set</span> usb0 up</span><br><span class="line">            udhcpc -i usb0</span><br><span class="line">            <span class="comment">#sleep 1</span></span><br><span class="line">            key_name=ifname</span><br><span class="line">            uci show network.loopback | grep -Eq <span class="string">&#x27;\.device=&#x27;</span> &amp;&amp; key_name=device</span><br><span class="line">            uci <span class="built_in">set</span> network.mobile=interface</span><br><span class="line">            uci <span class="built_in">set</span> network.mobile.proto=<span class="string">&#x27;dhcp&#x27;</span></span><br><span class="line">            uci <span class="built_in">set</span> network.mobile.<span class="variable">$&#123;key_name&#125;</span>=<span class="string">&#x27;usb0&#x27;</span></span><br><span class="line">            <span class="comment"># è®¾ç½®æœ¬æœº dns å¥½åƒä¼š loop</span></span><br><span class="line">            <span class="comment"># op_local_ip=$(ip r s | grep -Ev &#x27;docker|usb0&#x27; | awk &#x27;$0~&quot;src&quot;&#123;print $NF&#125;&#x27;)</span></span><br><span class="line">            <span class="comment"># uci set network.mobile.dns=&quot;$&#123;op_local_ip&#125;&quot;</span></span><br><span class="line">            uci show network.mobile.dns  2&gt;/dev/null &amp;&amp; uci delete network.mobile.dns || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">            uci commit network</span><br><span class="line">            <span class="comment">#sleep 1</span></span><br><span class="line">            ifup mobile</span><br><span class="line"></span><br><span class="line">            wan_zone_network=$(uci get firewall.@zone[1].network)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$wan_zone_network</span>&quot;</span> | grep -q mobile;<span class="keyword">then</span></span><br><span class="line">                uci <span class="built_in">set</span> firewall.@zone[1].network=<span class="string">&quot;<span class="variable">$wan_zone_network</span> mobile&quot;</span></span><br><span class="line">                uci commit firewall</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">if</span> ! grep -Eq <span class="string">&#x27;^\s*nameserver &#x27;</span> /etc/resolv.conf;<span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;nameserver 127.0.0.1 # sed-for-rndis&#x27;</span> &gt;&gt; /etc/resolv.conf</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>ç†è®ºä¸Šè·å–é…ç½®å’Œä¿®æ”¹é…ç½®åº”è¯¥ä½¿ç”¨ <code>/lib/functions.sh</code> é‡Œæä¾›çš„å‡½æ•°ï¼Œä½†æ˜¯æˆ‘æ²¡ç»†çœ‹ï¼Œä¸Šé¢è„šæœ¬æˆ‘åœ¨é N1 è®¾å¤‡æµ‹è¯•çš„ã€‚</p><h3 id="å‘½ä»¤è®¾ç½®-wifi"><a href="#å‘½ä»¤è®¾ç½®-wifi" class="headerlink" title="å‘½ä»¤è®¾ç½® wifi"></a>å‘½ä»¤è®¾ç½® wifi</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># https://openwrt.org/docs/guide-quick-start/basic_wifi</span><br><span class="line"></span><br><span class="line">uci set wireless.default_radio0.ssid=&#x27;OpenWrt-5G&#x27;</span><br><span class="line">uci set wireless.default_radio0.encryption=&#x27;psk-mixed&#x27;</span><br><span class="line">uci set wireless.default_radio0.key=&#x27;password&#x27;</span><br><span class="line">uci set wireless.radio0.legacy_rates=&#x27;1&#x27;</span><br><span class="line"></span><br><span class="line">uci set wireless.default_radio1.ssid=&#x27;OpenWrt&#x27;</span><br><span class="line">uci set wireless.default_radio1.encryption=&#x27;psk-mixed&#x27;</span><br><span class="line">uci set wireless.default_radio1.key=&#x27;password&#x27;</span><br><span class="line">uci set wireless.radio1.legacy_rates=&#x27;1&#x27;</span><br><span class="line">uci commit wireless</span><br><span class="line">wifi reload</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ:"></a>å‚è€ƒ:</h2><ul><li><a href="https://www.right.com.cn/forum/thread-220887-1-1.html">https://www.right.com.cn/forum/thread-220887-1-1.html</a></li><li><a href="https://iyzm.net/openwrt/775.html">https://iyzm.net/openwrt/775.html</a></li><li><a href="https://blog.umoe.vip/2020/12/31/bb3180dd6d20/">https://blog.umoe.vip/2020/12/31/bb3180dd6d20/</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;about&quot;&gt;&lt;a href=&quot;#about&quot; class=&quot;headerlink&quot; title=&quot;about&quot;&gt;&lt;/a&gt;about&lt;/h2&gt;&lt;p&gt;è®°å½•ä¸‹ openwrt ä¸‹ usb ç½‘ç»œçš„æŠ˜è…¾ï¼Œåç»­æŠ˜è…¾è¿™å—å†…å®¹çš„è¯ä¹Ÿåœ¨è¿™ä¸ªæ–‡ç« å†…æ›´æ–°&lt;/p&gt;
&lt;h2 id=&quot;N1</summary>
      
    
    
    
    <category term="openwrt" scheme="http://zhangguanzhang.github.io/categories/openwrt/"/>
    
    
    <category term="usb-net" scheme="http://zhangguanzhang.github.io/tags/usb-net/"/>
    
  </entry>
  
  <entry>
    <title>fio é™æ€ç¼–è¯‘å’ŒåŸºç¡€ä½¿ç”¨</title>
    <link href="http://zhangguanzhang.github.io/2021/09/02/fio/"/>
    <id>http://zhangguanzhang.github.io/2021/09/02/fio/</id>
    <published>2021-09-02T14:28:30.000Z</published>
    <updated>2021-09-02T14:28:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>amd64,arm64 çš„é™æ€ç¼–è¯‘å’ŒåŸºç¡€ä½¿ç”¨</p><h3 id="buildx-ä½¿ç”¨"><a href="#buildx-ä½¿ç”¨" class="headerlink" title="buildx ä½¿ç”¨"></a>buildx ä½¿ç”¨</h3><p>è§æ–‡ç«  <a href="https://github.com/zhangguanzhang/docker-need-to-know/blob/master/2.docker-image/dockerfile/buildx.md">buildx ä½¿ç”¨</a></p><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p>buildx Dockerfile æ„å»º:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu as build</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"><span class="keyword">ARG</span> VER=fio-<span class="number">3.29</span></span><br><span class="line"><span class="comment">#ARG DEBIAN_FRONTEND=noninteractive</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="keyword">if</span> [  -e /etc/apt/sources.list ];<span class="keyword">then</span> sed -ri <span class="string">&#x27;s/[a-zA-Z0-9.]+(debian.org|ubuntu.com)/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list; <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">export</span> DEBIAN_FRONTEND=noninteractive &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y git gcc make cmake libaio1 libaio-dev zlib1g zlib1g-dev </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> https://github.com/axboe/fio.git &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> fio  &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    git checkout <span class="variable">$&#123;VER&#125;</span> </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> fio  &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    ./configure --build-static &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make &amp;&amp; make install  &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> `<span class="built_in">which</span> fio` /fio-$(dpkg --print-architecture)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch AS bin</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /fio-* /</span></span><br></pre></td></tr></table></figure><p>æ„å»º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker buildx build  . --platform linux/amd64,linux/arm64 \</span><br><span class="line">    --target bin --output . \</span><br><span class="line">    --build-arg=VER=fio-3.29</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ll</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 660 Feb  9 21:32 Dockerfile</span><br><span class="line">drwxr-xr-x 2 root root  23 Feb  9 21:44 linux_amd64</span><br><span class="line">drwxr-xr-x 2 root root  23 Feb  9 21:44 linux_arm64</span><br><span class="line">$ tree .</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ linux_amd64</span><br><span class="line">â”‚Â Â  â””â”€â”€ fio-amd64</span><br><span class="line">â””â”€â”€ linux_arm64</span><br><span class="line">    â””â”€â”€ fio-arm64</span><br><span class="line">$ ldd linux_amd64/fio-amd64 linux_arm64/fio-arm64 </span><br><span class="line">linux_amd64/fio-amd64:</span><br><span class="line">not a dynamic executable</span><br><span class="line">linux_arm64/fio-arm64:</span><br><span class="line">not a dynamic executable</span><br><span class="line">$ file linux_amd64/fio-amd64 linux_arm64/fio-arm64 </span><br><span class="line">linux_amd64/fio-amd64: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, BuildID[sha1]=30dddb2ae5ca67f3533b8e54aa0900ee701c7b01, for GNU/Linux 3.2.0, not stripped</span><br><span class="line">linux_arm64/fio-arm64: ELF 64-bit LSB executable, ARM aarch64, version 1 (GNU/Linux), statically linked, BuildID[sha1]=6a644c0696153f99d2d527948e0400720742a002, for GNU/Linux 3.7.0, not stripped</span><br><span class="line">$ </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¬¦å·é“¾æ¥å¯ä»¥ <code>strip -s $(which nginx)</code> å»æ‰å‡å°‘å¤§å°ã€‚</p><h3 id="fio-æµ‹é€Ÿè¯´æ˜"><a href="#fio-æµ‹é€Ÿè¯´æ˜" class="headerlink" title="fio æµ‹é€Ÿè¯´æ˜"></a>fio æµ‹é€Ÿè¯´æ˜</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--eta-newline=5s   5såˆ‡åˆ°æ–°çš„è¡Œç»§ç»­è¾“å‡ºé€Ÿåº¦çŠ¶æ€</span><br><span class="line">--filename        å†™å…¥åˆ°å“ªä¸ªæ–‡ä»¶ï¼Œå¿…é¡»ä½¿ç”¨ç»å¯¹è·¯å¾„</span><br><span class="line">--rw=write         å‰é¢æ²¡å¸¦randå°±æ˜¯é¡ºåºï¼Œæ­¤å¤„æ˜¯é¡ºåºå†™ï¼Œä¾‹å¦‚rwåˆ™æ˜¯é¡ºåºè¯»å†™ï¼Œrandwriteåˆ™æ˜¯éšæœºå†™ï¼Œæµ‹é€Ÿæ¨èé¡ºåºå†™</span><br><span class="line">--ioengine         libaio æ˜¯å¤šçº¿ç¨‹å†…æ ¸æ€ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä¸æ¨èç”¨å®ƒæµ‹é€Ÿï¼Œæ¨èä½¿ç”¨ psync å•çº¿ç¨‹æµ‹é€Ÿ</span><br><span class="line">--runtime          ç§’æ•°ï¼Œæµ‹é€Ÿçš„æ—¶é—´</span><br><span class="line">--time_based      æ—¶é—´ç®—é€Ÿåº¦</span><br><span class="line">--output-format=json  å¦‚æœæœ‰å–è¾“å‡ºçš„è¯ï¼Œå¯ä»¥å¸¦ä¸Šè¿™ä¸ªï¼Œå¸¦ä¸Šè¿™ä¸ªå°±æ˜¯ç»“æŸåè¾“å‡ºjsonï¼Œä¸Šé¢çš„ --eta-newline å°±æ²¡æœ‰æ„ä¹‰äº†</span><br></pre></td></tr></table></figure><p>æµ‹é€Ÿæ³¨æ„æ–‡ä»¶è½åœ°è·¯å¾„ï¼Œioengine ä¸è¦ç”¨ libaio è¿™ç§å†…æ ¸æ€çš„å¹¶å‘è¯»å†™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./fio --name TEST --eta-newline=5s \</span><br><span class="line">  --filename=/root/fio-tempfile.dat \</span><br><span class="line">   --rw=write --size=2g --io_size=2g --blocksize=4k \</span><br><span class="line">   --ioengine=psync --fsync=1 --iodepth=8 --direct=1 \</span><br><span class="line">   --numjobs=1 --runtime=300 --group_reporting --time_based </span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚è¿™ä¸ªæ˜¯ä¸ªäººç”µè„‘ Linux çš„æµ‹é€Ÿï¼Œä¸ä¼šæ˜¯é‚£ç§ vcenter å’Œè™šæ‹ŸåŒ–ä¸Šå—å…¶ä»–è™šæœºå’Œå­˜å‚¨æ± çš„å½±å“ï¼Œè¿™å° Linux åˆ†åŒºæ˜¯ hdd å’Œ SDD åšçš„ lvmï¼Œæœ€ç»ˆçš„ avg æ˜¯ avg&#x3D;837.02ã€‚ç°åœºæµ‹é€Ÿè®°å¾—å‚æ•° â€“filename&#x3D; æ”¹æˆ data å®é™…è·¯å¾„æµ‹é€Ÿæ–‡ä»¶ ï¼Œä¸‹é¢æ•°æ®ç»“æœå¯ä»¥å‚è€ƒä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">root@pve:~# fio --name TEST --eta-newline=5s --filename=/root/fio-tempfile.dat \</span><br><span class="line">  --rw=write --size=500m --io_size=2g --blocksize=4k  \</span><br><span class="line">  --ioengine=psync --fsync=1 --iodepth=8 --direct=1 \</span><br><span class="line">  --numjobs=1 --runtime=300 --group_reporting --time_based </span><br><span class="line">TEST: (g=0): rw=write, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=psync, iodepth=8</span><br><span class="line">fio-3.12</span><br><span class="line">Starting 1 process</span><br><span class="line">Jobs: 1 (f=1): [W(1)][2.3%][w=3275KiB/s][w=818 IOPS][eta 04m:53s]</span><br><span class="line">Jobs: 1 (f=1): [W(1)][4.3%][w=3383KiB/s][w=845 IOPS][eta 04m:47s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][6.3%][w=3295KiB/s][w=823 IOPS][eta 04m:41s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][8.3%][w=3263KiB/s][w=815 IOPS][eta 04m:35s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][10.3%][w=3304KiB/s][w=826 IOPS][eta 04m:29s]</span><br><span class="line">Jobs: 1 (f=1): [W(1)][12.3%][w=3324KiB/s][w=831 IOPS][eta 04m:23s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][14.3%][w=3523KiB/s][w=880 IOPS][eta 04m:17s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][16.3%][w=3368KiB/s][w=842 IOPS][eta 04m:11s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][18.3%][w=3407KiB/s][w=851 IOPS][eta 04m:05s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][20.3%][w=3395KiB/s][w=848 IOPS][eta 03m:59s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][22.3%][w=3335KiB/s][w=833 IOPS][eta 03m:53s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][24.3%][w=3335KiB/s][w=833 IOPS][eta 03m:47s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][26.3%][w=3467KiB/s][w=866 IOPS][eta 03m:41s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][28.3%][w=3328KiB/s][w=832 IOPS][eta 03m:35s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][30.3%][w=3284KiB/s][w=821 IOPS][eta 03m:29s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][32.3%][w=3295KiB/s][w=823 IOPS][eta 03m:23s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][34.3%][w=3399KiB/s][w=849 IOPS][eta 03m:17s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][36.3%][w=3391KiB/s][w=847 IOPS][eta 03m:11s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][38.3%][w=3347KiB/s][w=836 IOPS][eta 03m:05s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][40.3%][w=3331KiB/s][w=832 IOPS][eta 02m:59s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][42.3%][w=3211KiB/s][w=802 IOPS][eta 02m:53s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][44.3%][w=3351KiB/s][w=837 IOPS][eta 02m:47s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][46.3%][w=3267KiB/s][w=816 IOPS][eta 02m:41s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][48.3%][w=3320KiB/s][w=830 IOPS][eta 02m:35s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][50.3%][w=3419KiB/s][w=854 IOPS][eta 02m:29s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][52.3%][w=3344KiB/s][w=836 IOPS][eta 02m:23s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][54.3%][w=3427KiB/s][w=856 IOPS][eta 02m:17s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][56.3%][w=3388KiB/s][w=847 IOPS][eta 02m:11s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][58.3%][w=3516KiB/s][w=879 IOPS][eta 02m:05s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][60.3%][w=3320KiB/s][w=830 IOPS][eta 01m:59s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][62.3%][w=3184KiB/s][w=796 IOPS][eta 01m:53s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][64.3%][w=3468KiB/s][w=867 IOPS][eta 01m:47s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][66.3%][w=3399KiB/s][w=849 IOPS][eta 01m:41s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][68.3%][w=3540KiB/s][w=885 IOPS][eta 01m:35s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][70.3%][w=3304KiB/s][w=826 IOPS][eta 01m:29s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][72.3%][w=3187KiB/s][w=796 IOPS][eta 01m:23s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][74.3%][w=3428KiB/s][w=857 IOPS][eta 01m:17s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][76.3%][w=3751KiB/s][w=937 IOPS][eta 01m:11s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][78.3%][w=3336KiB/s][w=834 IOPS][eta 01m:05s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][80.3%][w=3456KiB/s][w=864 IOPS][eta 00m:59s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][82.3%][w=3259KiB/s][w=814 IOPS][eta 00m:53s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][84.3%][w=3416KiB/s][w=854 IOPS][eta 00m:47s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][86.3%][w=3384KiB/s][w=846 IOPS][eta 00m:41s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][88.3%][w=3299KiB/s][w=824 IOPS][eta 00m:35s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][90.3%][w=3427KiB/s][w=856 IOPS][eta 00m:29s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][92.3%][w=3176KiB/s][w=794 IOPS][eta 00m:23s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][94.3%][w=3295KiB/s][w=823 IOPS][eta 00m:17s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][96.3%][w=3359KiB/s][w=839 IOPS][eta 00m:11s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][98.3%][w=3532KiB/s][w=883 IOPS][eta 00m:05s] </span><br><span class="line">Jobs: 1 (f=1): [W(1)][100.0%][w=3351KiB/s][w=837 IOPS][eta 00m:00s]</span><br><span class="line">TEST: (groupid=0, jobs=1): err= 0: pid=6687: Mon Jan 24 11:42:39 2022</span><br><span class="line">  write: IOPS=837, BW=3348KiB/s (3429kB/s)(981MiB/300001msec); 0 zone resets</span><br><span class="line">    clat (usec): min=29, max=5771, avg=107.72, stdev=56.50</span><br><span class="line">     lat (usec): min=29, max=5772, avg=108.00, stdev=56.50</span><br><span class="line">    clat percentiles (usec):</span><br><span class="line">     |  1.00th=[   34],  5.00th=[   42], 10.00th=[   47], 20.00th=[   73],</span><br><span class="line">     | 30.00th=[   82], 40.00th=[  102], 50.00th=[  113], 60.00th=[  128],</span><br><span class="line">     | 70.00th=[  137], 80.00th=[  143], 90.00th=[  147], 95.00th=[  151],</span><br><span class="line">     | 99.00th=[  163], 99.50th=[  169], 99.90th=[  184], 99.95th=[  208],</span><br><span class="line">     | 99.99th=[ 3261]</span><br><span class="line">   bw (  KiB/s): min= 2760, max= 3872, per=100.00%, avg=3348.14, stdev=140.52, samples=600</span><br><span class="line">   iops        : min=  690, max=  968, avg=837.02, stdev=35.13, samples=600</span><br><span class="line">  lat (usec)   : 50=10.97%, 100=27.52%, 250=61.48%, 500=0.01%, 750=0.01%</span><br><span class="line">  lat (usec)   : 1000=0.01%</span><br><span class="line">  lat (msec)   : 2=0.01%, 4=0.02%, 10=0.01%</span><br><span class="line">  fsync/fdatasync/sync_file_range:</span><br><span class="line">    sync (usec): min=383, max=27349, avg=1084.44, stdev=480.22</span><br><span class="line">    sync percentiles (usec):</span><br><span class="line">     |  1.00th=[  701],  5.00th=[  725], 10.00th=[  742], 20.00th=[  766],</span><br><span class="line">     | 30.00th=[  799], 40.00th=[  816], 50.00th=[  832], 60.00th=[  840],</span><br><span class="line">     | 70.00th=[  947], 80.00th=[ 1696], 90.00th=[ 1811], 95.00th=[ 1876],</span><br><span class="line">     | 99.00th=[ 1975], 99.50th=[ 2040], 99.90th=[ 2180], 99.95th=[ 3458],</span><br><span class="line">     | 99.99th=[ 9634]</span><br><span class="line">  cpu          : usr=1.09%, sys=4.30%, ctx=678813, majf=0, minf=13</span><br><span class="line">  IO depths    : 1=200.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%</span><br><span class="line">     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%</span><br><span class="line">     issued rwts: total=0,251136,0,251136 short=0,0,0,0 dropped=0,0,0,0</span><br><span class="line">     latency   : target=0, window=0, percentile=100.00%, depth=8</span><br><span class="line"></span><br><span class="line">Run status group 0 (all jobs):</span><br><span class="line">  WRITE: bw=3348KiB/s (3429kB/s), 3348KiB/s-3348KiB/s (3429kB/s-3429kB/s), io=981MiB (1029MB), run=300001-300001msec</span><br><span class="line"></span><br><span class="line">Disk stats (read/write):</span><br><span class="line">    dm-1: ios=0/725828, merge=0/0, ticks=0/282020, in_queue=282020, util=99.90%, aggrios=240/651563, aggrmerge=0/74672, aggrticks=583/280037, aggrin_queue=620, aggrutil=99.90%</span><br><span class="line">  sdb: ios=240/651563, merge=0/74672, ticks=583/280037, in_queue=620, util=99.90%</span><br></pre></td></tr></table></figure><p><a href="https://etcd.io/docs/v3.5/op-guide/hardware/">https://etcd.io/docs/v3.5/op-guide/hardware/</a> etcd æ–‡æ¡£ä¸Šå†™ç€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcd å¯¹ç£ç›˜å†™å…¥å»¶è¿Ÿéå¸¸æ•æ„Ÿã€‚é€šå¸¸éœ€è¦ 50 ä¸ªé¡ºåº IOPSï¼ˆä¾‹å¦‚ï¼Œ7200 RPM ç£ç›˜ï¼‰ã€‚å¯¹äºè´Ÿè½½è¾ƒé‡çš„é›†ç¾¤ï¼Œå»ºè®®ä½¿ç”¨ 500 é¡ºåº IOPSï¼ˆä¾‹å¦‚ï¼Œå…¸å‹çš„æœ¬åœ° SSD æˆ–é«˜æ€§èƒ½è™šæ‹ŸåŒ–å—è®¾å¤‡ï¼‰ã€‚è¯·æ³¨æ„ï¼Œå¤§å¤šæ•°äº‘æä¾›å•†å‘å¸ƒå¹¶å‘ IOPS è€Œä¸æ˜¯é¡ºåº IOPSï¼›å‘å¸ƒçš„å¹¶å‘ IOPS å¯ä»¥æ˜¯é¡ºåº IOPS çš„ 10 å€ã€‚è¦æµ‹é‡å®é™…çš„é¡ºåº IOPSï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ç£ç›˜åŸºå‡†æµ‹è¯•å·¥å…·ï¼Œä¾‹å¦‚ diskbench æˆ– fioã€‚</span><br><span class="line">å¦‚æœè¦å–è¾“å‡ºé‡Œçš„éƒ¨åˆ†å€¼ï¼Œé‚£å°±å¸¦ä¸Š --output-format=json</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./fio --name TEST --eta-newline=5s --filename=/root/fio-tempfile.dat \</span><br><span class="line">  --rw=write --size=2g --io_size=2g --blocksize=4k \</span><br><span class="line">  --ioengine=psync --fsync=1 --iodepth=8 --direct=1 --numjobs=1 \</span><br><span class="line">  --runtime=300 --group_reporting --time_based \</span><br><span class="line">  --output-format=json</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æ¥è¯´ æ™®é€š 7200 çš„ç¡¬ç›˜ IOPS ä¹Ÿå°±æ˜¯ 60 å·¦å³ï¼Œ500 çš„ IOPS åŸºæœ¬å°±å¾—ç”¨ jbod æˆ–è€… raid10ï¼Œæˆ–è€…æ›´é«˜çš„ SSD äº†ã€‚<br>å¦‚æœæµ‹å¾—ä½çš„è¯å¯ä»¥è‚¯å®šæ˜¯ io ä¸è¡Œï¼Œé«˜çš„è¯ä¹Ÿä¸ä¸€å®šçœŸçš„å¿«ï¼Œç¡¬ç›˜å¯èƒ½æœ‰ç¼“å­˜ï¼Œå¯èƒ½ä¼šè™šé«˜ã€‚æ‰€ä»¥fioçš„éœ€è¦é•¿æ—¶é—´æµ‹è¯•ï¼Œæ¨è 3 åˆ†é’Ÿä»¥ä¸Šã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç”±æ¥&quot;&gt;&lt;a href=&quot;#ç”±æ¥&quot; class=&quot;headerlink&quot; title=&quot;ç”±æ¥&quot;&gt;&lt;/a&gt;ç”±æ¥&lt;/h2&gt;&lt;p&gt;amd64,arm64 çš„é™æ€ç¼–è¯‘å’ŒåŸºç¡€ä½¿ç”¨&lt;/p&gt;
&lt;h3 id=&quot;buildx-ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#buildx-ä½¿ç”¨&quot; cla</summary>
      
    
    
    
    
    <category term="linux" scheme="http://zhangguanzhang.github.io/tags/linux/"/>
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="fio" scheme="http://zhangguanzhang.github.io/tags/fio/"/>
    
  </entry>
  
</feed>
