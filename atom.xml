<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Zhangguanzhang</title>
  
  <subtitle>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</subtitle>
  <link href="http://zhangguanzhang.github.io/atom.xml" rel="self"/>
  
  <link href="http://zhangguanzhang.github.io/"/>
  <updated>2025-07-29T17:40:30.000Z</updated>
  <id>http://zhangguanzhang.github.io/</id>
  
  <author>
    <name>Zhangguanzhang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>python grpc ä½¿ç”¨åŸŸåç¬¬ä¸€æ¬¡è€—æ—¶é•¿é—®é¢˜</title>
    <link href="http://zhangguanzhang.github.io/2025/07/29/python-grpc-first-long/"/>
    <id>http://zhangguanzhang.github.io/2025/07/29/python-grpc-first-long/</id>
    <published>2025-07-29T17:40:30.000Z</published>
    <updated>2025-07-29T17:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ python grpc è€—æ—¶é•¿é—®é¢˜â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æ˜¨å¤©ä¸Šç€ç­çªç„¶è¢«ç¾¤é‡Œæ‹‰åˆ°ä¸€ä¸ªå¼€å‘ä»»åŠ¡ç¾¤é‡Œï¼Œçœ‹äº†ä¸‹èŠå¤©è®°å½•è¯´å•¥æ…¢ï¼Œè¯¢é—®äº†ä¸‹ç†æ¸…äº†æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> client    server1   model server</span><br><span class="line">â”Œâ”€â”€â”        â”Œâ”€â”€â”        â”Œâ”€â”€â” </span><br><span class="line">â””â”¬â”€â”˜        â””â”¬â”€â”˜        â””â”€â”¬â”˜ </span><br><span class="line"> â”œâ”€â”€â”€httpâ”€â”€â”€â–ºâ”‚            â”‚  </span><br><span class="line"> â”‚           â”œâ”€â”€â”€grpcâ”€â”€â”€â”€â–ºâ”‚  </span><br><span class="line"> â”‚           â”‚â—„â”€â”€grpcâ”€â”€â”€â”€â”€â”¤  </span><br><span class="line"> â”‚â—„â”€â”€â”€httpâ”€â”€â”€â”¤            â”‚  </span><br><span class="line">                          </span><br></pre></td></tr></table></figure><p>http å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡1ï¼Œå¸¦äº†æ¨¡å‹æœåŠ¡çš„ <code>model_url</code>ï¼Œserver1 ä¼š grpc è¯·æ±‚ <code>model_url</code>ï¼Œç„¶åå‘ç°å›å¤éå¸¸æ…¢ï¼ŒæŠŠ <code>ai-xxx</code> æ¢æˆå®é™…çš„å¤–éƒ¨ IP å°±ä¼šå¾ˆå¿«ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl --location &#x27;http://xxxx:8870/chat&#x27; \</span><br><span class="line">    --header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">    --data &#x27;&#123;</span><br><span class="line">        &quot;stream&quot;: true,</span><br><span class="line">        &quot;messages_type&quot;: 1,</span><br><span class="line">        &quot;title&quot;: &quot;äººå·¥æ™ºèƒ½&quot;,</span><br><span class="line">        &quot;inspiration&quot;: &quot;æ–‡é£ä¸¥è°¨ï¼Œè¯­è¨€ç®€æ´å‡ç»ƒ&quot;,</span><br><span class="line">        &quot;model_config&quot;: &#123;</span><br><span class="line">            &quot;default&quot;: true,</span><br><span class="line">            &quot;type&quot;: &quot;xxxx&quot;,</span><br><span class="line">            &quot;model_url&quot;: &quot;ai-xxx&quot;,</span><br><span class="line">            &quot;model_name&quot;: &quot;xxxxx-xxxx&quot;,</span><br><span class="line">            &quot;model&quot;: &quot;xxxxx&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#x27;</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒä¸Šæµ‹äº†ä¸‹æœç„¶æ˜¯ï¼Œserver1 çš„è®¿é—®æ—¥å¿—çœ‹æœ‰ 9s å·¦å³å»¶è¿Ÿï¼Œçœ‹äº†ä¸‹ç¯å¢ƒæ˜¯ k8sï¼Œ <code>ai-xxx</code> æ˜¯ç›´æ¥åˆ›å»ºçš„ svc å’Œ epï¼Œendpoint ä¸ºå¤–éƒ¨ä¸€ä¸ªæ¨¡å‹æœåŠ¡çš„ ip ç«¯å£ã€‚</p><h2 id="è§£å†³è¿‡ç¨‹"><a href="#è§£å†³è¿‡ç¨‹" class="headerlink" title="è§£å†³è¿‡ç¨‹"></a>è§£å†³è¿‡ç¨‹</h2><p>åˆæ­¥æ€€ç–‘æ˜¯ç ”å‘çš„ server1 åç«¯æ¥å£é€»è¾‘æœ‰é—®é¢˜ï¼Œä½†æ˜¯ä»–ä»¬è¯´æœ‰äº›ç¯å¢ƒæ­£å¸¸æœ‰äº›ä¸æ­£å¸¸ï¼Œäºæ˜¯æˆ‘è®©ä»–ä»¬ç»™ä¸ªæœ€å°çš„ python grpc client è®¿é—®æ¨¡å‹çš„ demoã€‚è¿™æ ·äºŒåˆ†æ’é™¤èŒƒå›´ï¼Œä¸ç„¶ä¸¤ä¸ªé“¾è·¯ä¸å¥½æŸ¥ã€‚æ²¡æƒ³åˆ°ä»Šå¤©æµ‹è¯•åˆå‚¬è¿™ä¸ªé—®é¢˜çœ‹å¾—å’‹æ ·äº†ã€‚ç„¶åè®©ç ”å‘æŠŠ demo å‘è¿‡æ¥çœ‹ã€‚</p><h3 id="demo-å¤ç°"><a href="#demo-å¤ç°" class="headerlink" title="demo å¤ç°"></a>demo å¤ç°</h3><p>æ‹¿åˆ° demo æœ‰ç‚¹æ— è¯­ï¼Œè¿™ç§è€—æ—¶çš„æ‰“å°å±…ç„¶æ˜¯ç”¨çš„ printï¼Œæ‰‹åŠ¨ä¿®æ”¹æˆ logging åæµ‹è¯•å¤ç°äº†ï¼Œå¤§æ¦‚é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server_urls = [</span><br><span class="line">    <span class="string">&quot;ai-xxx:80&quot;</span>,</span><br><span class="line">    <span class="string">&quot;10.xx.xx.xxx:10037&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> server_url <span class="keyword">in</span> server_urls:</span><br><span class="line">    grpc_test()</span><br></pre></td></tr></table></figure><p>æ‹·è´åˆ° server1 çš„å®¹å™¨é‡Œæ‰§è¡Œï¼Œè€—æ—¶ä¹…çš„é™„è¿‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2025-07-29 16:52:35 [INFO] ğŸ”¥ å¼€å§‹æµ‹è¯•GRPCè¿æ¥: ai-xxx:80</span><br><span class="line">2025-07-29 16:52:35 [INFO] ğŸ“¡ åˆ›å»ºTritonå®¢æˆ·ç«¯...</span><br><span class="line">2025-07-29 16:52:35 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 16:52:35 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</span><br><span class="line">2025-07-29 16:52:43 [INFO]    æœåŠ¡å™¨å­˜æ´»: âœ…</span><br><span class="line">2025-07-29 16:52:43 [INFO]    æœåŠ¡å™¨å°±ç»ª: âœ…</span><br><span class="line">2025-07-29 16:52:43 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br><span class="line">...</span><br><span class="line">2025-07-29 16:52:44 [INFO] ğŸ”¥ å¼€å§‹æµ‹è¯•GRPCè¿æ¥: 10.xx.xx.xxx:10037</span><br><span class="line">2025-07-29 16:52:44 [INFO] ğŸ“¡ åˆ›å»ºTritonå®¢æˆ·ç«¯...</span><br><span class="line">2025-07-29 16:52:44 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 16:52:44 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</span><br><span class="line">2025-07-29 16:52:44 [INFO]    æœåŠ¡å™¨å­˜æ´»: âœ…</span><br><span class="line">2025-07-29 16:52:44 [INFO]    æœåŠ¡å™¨å°±ç»ª: âœ…</span><br><span class="line">2025-07-29 16:52:44 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">triton_client = grpcclient.InferenceServerClient(</span><br><span class="line">    url=server_url,</span><br><span class="line">    verbose=<span class="literal">False</span></span><br><span class="line">)</span><br><span class="line">logging.info(<span class="string">&quot;âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live&quot;</span>)</span><br><span class="line">is_live = triton_client.is_server_live()</span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready&quot;</span>)</span><br><span class="line">is_ready = triton_client.is_server_ready()</span><br></pre></td></tr></table></figure><p><code>python -m pdb grpc-test.py</code> è°ƒè¯•äº†ä¸‹ï¼Œå‘ç°è¿™ä¸ªæ–¹æ³•åªæ˜¯ä¸€ä¸ªçº¯ç²¹çš„ grpc è¯·æ±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) n</span><br><span class="line">&gt; /usr/local/lib/python3<span class="number">.10</span>/site-packages/tritonclient/grpc/_client.py(<span class="number">294</span>)is_server_live()</span><br><span class="line">-&gt; <span class="keyword">try</span>:</span><br><span class="line">(Pdb) <span class="built_in">list</span></span><br><span class="line"><span class="number">289</span>          InferenceServerException</span><br><span class="line"><span class="number">290</span>              If unable to get liveness <span class="keyword">or</span> has timed out.</span><br><span class="line"><span class="number">291</span>  </span><br><span class="line"><span class="number">292</span>          <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">293          metadata = self._get_metadata(headers)</span></span><br><span class="line"><span class="string">294  -&gt;        try:</span></span><br><span class="line"><span class="string">295              request = service_pb2.ServerLiveRequest()</span></span><br><span class="line"><span class="string">296              if self._verbose:</span></span><br><span class="line"><span class="string">297                  print(&quot;is_server_live, metadata &#123;&#125;\n&#123;&#125;&quot;.format(metadata, request))</span></span><br><span class="line"><span class="string">298              response = self._client_stub.ServerLive(</span></span><br><span class="line"><span class="string">299                  request=request, metadata=metadata, timeout=client_timeout</span></span><br></pre></td></tr></table></figure><p>grpc å®¢æˆ·ç«¯ç”¨çš„ <code>tritonclient</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pip list | grep client</span></span><br><span class="line">tritonclient           2.57.0</span><br></pre></td></tr></table></figure><p><a href="https://pypi.org/project/tritonclient/#history">pypi</a> æŸ¥äº†ä¸‹è¿™ä¸ª grpc åº“å‘ç°æ‰¾åˆ°çš„ä»“åº“ <a href="https://github.com/triton-inference-server/client">triton-inference-server&#x2F;client</a> åˆ†æ”¯å’Œä¸Šé¢ç‰ˆæœ¬å·å¯¹ä¸ä¸Šï¼Œå¾ˆå¥‡æ€ªã€‚</p><p>è°·æ­Œæœäº†ä¸‹ <code>is_server_live long time</code> å‘ç°èƒ½æœåˆ°åŒæ ·é—®é¢˜ <a href="https://github.com/triton-inference-server/server/issues/3800">is_server_live() python GRPC client got no response</a>ï¼Œä½†æ˜¯åˆ«äººç”¨çš„æ˜¯ IP ï¼Œåé¢è¿˜æŠŠ issue å…³é—­äº†è¯´æ˜¯ä»–ä»¬è‡ªå·±çš„ç½‘ç»œé—®é¢˜ã€‚</p><p>ç„¶åè®©ç ”å‘æ‰¾ <code>is_server_live()</code> çš„ grpc server ç«¯ç ”å‘æŸ¥ä¸‹ <code>ServerLive</code> æ¥å£è°ƒç”¨é€»è¾‘ï¼Œå¦ä¸€æ–¹é¢è®© server1 ç ”å‘æŠŠ <code>is_server_live()</code> æ³¨é‡Šäº†è¯•è¯•ï¼Œä»–è¯´èµ° CI æµç¨‹ä¼šç¨å¾®æ…¢äº›ï¼Œè®©æˆ‘çœ‹çœ‹ç¯å¢ƒä¸Šèƒ½ç›´æ¥æ”¹ä¸ï¼Œäºæ˜¯å¤§å®¶ä¸€èµ·å¹¶è¡Œæ“ä½œã€‚</p><h3 id="ç¨æœ‰çœ‰ç›®"><a href="#ç¨æœ‰çœ‰ç›®" class="headerlink" title="ç¨æœ‰çœ‰ç›®"></a>ç¨æœ‰çœ‰ç›®</h3><p>å‘ç°ç¯å¢ƒæ”¹äº†åè¿˜æ˜¯å¤ç°ï¼Œäºæ˜¯æˆ‘åœ¨ demo é‡Œæ”¹äº†ä¸‹å‘ç°æ…¢åœ¨ç¬¬äºŒä¸ªäº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live&quot;</span>)</span><br><span class="line"><span class="comment"># is_live = triton_client.is_server_live()</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready&quot;</span>)</span><br><span class="line"><span class="comment"># is_ready = triton_client.is_server_ready()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logging.info(f&quot;   æœåŠ¡å™¨å­˜æ´»: &#123;&#x27;âœ…&#x27; if is_live else &#x27;âŒ&#x27;&#125;&quot;)</span></span><br><span class="line"><span class="comment"># logging.info(f&quot;   æœåŠ¡å™¨å°±ç»ª: &#123;&#x27;âœ…&#x27; if is_ready else &#x27;âŒ&#x27;&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if not is_live:</span></span><br><span class="line"><span class="comment">#     raise Exception(&quot;æœåŠ¡å™¨æœªå­˜æ´»&quot;)</span></span><br><span class="line"><span class="comment"># if not is_ready:</span></span><br><span class="line"><span class="comment">#     raise Exception(&quot;æœåŠ¡å™¨æœªå°±ç»ª&quot;)</span></span><br><span class="line"></span><br><span class="line">logging.info(<span class="string">&quot;âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è·å–æ¨¡å‹ä¿¡æ¯</span></span><br><span class="line">logging.info(<span class="string">&quot;ğŸ“‹ è·å–æ¨¡å‹ä¿¡æ¯...&quot;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    model_metadata = triton_client.get_model_metadata(<span class="string">&quot;xxxxx&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2025-07-29 17:32:32 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 17:32:32 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live</span><br><span class="line">2025-07-29 17:32:32 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready</span><br><span class="line">2025-07-29 17:32:32 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br><span class="line">2025-07-29 17:32:32 [INFO] ğŸ“‹ è·å–æ¨¡å‹ä¿¡æ¯...</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æˆåŠŸè·å–æ¨¡å‹å…ƒæ•°æ®</span><br><span class="line">2025-07-29 17:32:40 [INFO]    æ¨¡å‹åç§°: xxxx</span><br><span class="line">2025-07-29 17:32:40 [INFO]    æ¨¡å‹ç‰ˆæœ¬: [&#x27;1&#x27;]</span><br><span class="line">2025-07-29 17:32:40 [INFO] ğŸ§  æ‰§è¡Œç®€å•æ¨ç†æµ‹è¯•...</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æµå¯åŠ¨æˆåŠŸ</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æ¨ç†è¯·æ±‚å‘é€æˆåŠŸ</span><br><span class="line">2025-07-29 17:32:40 [INFO] â³ ç­‰å¾…å“åº”...</span><br><span class="line">2025-07-29 17:32:40 [INFO] âœ… æ”¶åˆ°æˆåŠŸå“åº”</span><br><span class="line">2025-07-29 17:32:40 [INFO]    è¾“å‡ºtokens: [9]</span><br><span class="line">2025-07-29 17:32:40 [INFO] ğŸ‰ GRPCè¿æ¥æµ‹è¯•å®Œå…¨æˆåŠŸ!</span><br><span class="line">2025-07-29 17:32:40 [INFO] ğŸ‰ åŠ¡å™¨ ai-xxx:80 æµ‹è¯•æˆåŠŸ!</span><br></pre></td></tr></table></figure><p>ä¸æ˜¯å‰é¢çš„ <code>is_server_live()</code> é—®é¢˜ï¼Œä»”ç»†çœ‹äº†ä¸‹ä»£ç æƒ³äº†ä¸‹æ˜¯ <code>grpcclient</code> çš„ç¬¬ä¸€ä¸ª grpc è¯·æ±‚é—®é¢˜ï¼Œæœç´¢äº†ä¸‹å‘ç°ä¸€æ ·ç›¸ä¼¼ä½†æ˜¯æ›´è€—æ—¶çš„é—®é¢˜çš„ï¼š</p><ul><li><a href="https://github.com/triton-inference-server/server/issues/1821">https://github.com/triton-inference-server/server/issues/1821</a></li></ul><p>ä¸è¿‡ä¸Šé¢ issue é‡Œ triton å®˜æ–¹è¯´æ˜¯ <code>grpc/grpc</code> çš„é—®é¢˜ï¼Œ æœåˆ° <a href="https://github.com/grpc/grpc/issues/22260">Communication from c++ server to python client is too slow</a> è¯´ python å¾ˆæ…¢ä½†æ˜¯ c++ çš„ä¸æ…¢ï¼Œpython çš„é¦–æ¬¡ grpc å»ºç«‹è¿æ¥è€—æ—¶å¾ˆé•¿ï¼Œåç»­çš„è¯·æ±‚éƒ½åœ¨ ms å†…å®Œæˆã€‚issue å†…ä¸‹é¢å¤§ä½¬æ’æŸ¥å‡ºè€—æ—¶å¤§éƒ¨åˆ†å¼€é”€éƒ½æ˜¯åœ¨ libc ç›¸å…³è°ƒç”¨ä¸Šã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œgrpc æ˜¯é•¿è¿æ¥åæ¨æµï¼Œè®©ç ”å‘è¦ä¸è¦æ”¹ä»£ç å†™æˆè¿æ¥æ± è¯•è¯•ï¼Œä»–ä»¬è¯´æ¥ä¸åŠã€‚</p><p>æ„Ÿè§‰æ—¢ç„¶å’Œ triton æ— å…³ï¼Œå°±æœ <code>python grpc dns first time long</code> æœåˆ°äº† <a href="https://github.com/grpc/grpc/issues/24018">Python client hangs on first connection</a> ç±»ä¼¼é—®é¢˜ï¼Œæ’æŸ¥å’Œ DNS ç›¸å…³ï¼Œå‘ç°å¤§ä½¬è¯´è¯•è¯• <code>GRPC_DNS_RESOLVER=native</code> ï¼Œæœäº†ä¸‹ <code>grpc/grpc</code> å®˜æ–¹æ–‡æ¡£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* GRPC_DNS_RESOLVER</span><br><span class="line">  Declares which DNS resolver to use. The default is ares if gRPC is built with</span><br><span class="line">  c-ares support. Otherwise, the value of this environment variable is ignored.</span><br><span class="line">  Available DNS resolver include:</span><br><span class="line">  - ares (default on most platforms except iOS, Android or Node)- a DNS</span><br><span class="line">    resolver based around the c-ares library</span><br><span class="line">  - native - a DNS resolver based around getaddrinfo(), creates a new thread to</span><br><span class="line">    perform name resolution</span><br></pre></td></tr></table></figure><p>é»˜è®¤æ˜¯ c çš„åº“ <code>c-ares</code> å»è§£æçš„ï¼Œè®¾ç½®ä¸º <code>native</code> åˆ™ä½¿ç”¨ç³»ç»Ÿ libc çš„ <code>getaddrinfo()</code> ï¼Œäºæ˜¯æµ‹è¯•äº†ä¸‹å¯ä»¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GRPC_DNS_RESOLVER=native python3  /root/test2.py</span> </span><br><span class="line">2025-07-29 17:59:43 [INFO] âœ… tritonclientå¯¼å…¥æˆåŠŸ</span><br><span class="line">2025-07-29 17:59:43 [INFO] ============================================================</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸš€ GRPCè¿æ¥æµ‹è¯•å·¥å…·</span><br><span class="line">2025-07-29 17:59:43 [INFO] ============================================================</span><br><span class="line">2025-07-29 17:59:43 [INFO] </span><br><span class="line">ğŸ“ æµ‹è¯•æœåŠ¡å™¨: ai-xxx:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] ----------------------------------------</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ” æµ‹è¯•DNSè§£æ: ai-xxx:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] âœ… DNSè§£ææˆåŠŸ: ai-xxx -&gt; 10.186.44.250:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ”¥ å¼€å§‹æµ‹è¯•GRPCè¿æ¥: ai-xxx:80</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ“¡ åˆ›å»ºTritonå®¢æˆ·ç«¯...</span><br><span class="line">2025-07-29 17:59:43 [INFO] âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ</span><br><span class="line">2025-07-29 17:59:43 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_live</span><br><span class="line">2025-07-29 17:59:44 [INFO] ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€is_server_ready</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æœåŠ¡å™¨å­˜æ´»: âœ…</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æœåŠ¡å™¨å°±ç»ª: âœ…</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥é€šè¿‡</span><br><span class="line">2025-07-29 17:59:44 [INFO] ğŸ“‹ è·å–æ¨¡å‹ä¿¡æ¯...</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æˆåŠŸè·å–æ¨¡å‹å…ƒæ•°æ®</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æ¨¡å‹åç§°: xxxx</span><br><span class="line">2025-07-29 17:59:44 [INFO]    æ¨¡å‹ç‰ˆæœ¬: [&#x27;1&#x27;]</span><br><span class="line">2025-07-29 17:59:44 [INFO] ğŸ§  æ‰§è¡Œç®€å•æ¨ç†æµ‹è¯•...</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æµå¯åŠ¨æˆåŠŸ</span><br><span class="line">2025-07-29 17:59:44 [INFO] âœ… æ¨ç†è¯·æ±‚å‘é€æˆåŠŸ</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ python grpc è€—æ—¶é•¿é—®é¢˜â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="python" scheme="http://zhangguanzhang.github.io/tags/python/"/>
    
    <category term="grpc" scheme="http://zhangguanzhang.github.io/tags/grpc/"/>
    
  </entry>
  
  <entry>
    <title>golang gitlab subgroup æ„å»ºé—®é¢˜</title>
    <link href="http://zhangguanzhang.github.io/2025/06/17/golang-gitlab-subgroup/"/>
    <id>http://zhangguanzhang.github.io/2025/06/17/golang-gitlab-subgroup/</id>
    <published>2025-06-17T14:40:30.000Z</published>
    <updated>2025-06-17T14:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ subgroup é—®é¢˜â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å¼€å‘æ„å»º Docker é•œåƒæŠ¥é”™æ²¡æƒé™æ‹‰å–ä¾èµ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xxxapi/middlewares imports</span><br><span class="line">xxx.xxxgitlab.net/x/xx/xxx/econtext: xxx.xxxgitlab.net/x/xx/xxx@v1.6.5-rc.7.0.20250609085545-4855369c0f1e: invalid version: git ls-remote -q origin in /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c: exit status 128:</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">remote: The project you were looking for could not be found or you don&#x27;t have permission to view it.</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><h2 id="è§£å†³è¿‡ç¨‹"><a href="#è§£å†³è¿‡ç¨‹" class="headerlink" title="è§£å†³è¿‡ç¨‹"></a>è§£å†³è¿‡ç¨‹</h2><p>é•œåƒå†…æœ‰ gitlab çš„ deploy keysï¼Œåˆæ­¥æ€€ç–‘æ˜¯æ²¡ä¾èµ–ä»“åº“æƒé™ï¼Œè®©å¼€å‘è”ç³»è¯¥ä¾èµ–ä»“åº“è´Ÿè´£äººï¼Œå»å¼€å¯ <code>Enabled deploy keys</code> åè¿˜æ˜¯ä¸€æ ·ã€‚</p><h3 id="æ‰‹åŠ¨æ„å»ºæµ‹è¯•"><a href="#æ‰‹åŠ¨æ„å»ºæµ‹è¯•" class="headerlink" title="æ‰‹åŠ¨æ„å»ºæµ‹è¯•"></a>æ‰‹åŠ¨æ„å»ºæµ‹è¯•</h3><p>ç™»å½•åˆ°æ„å»ºæœºå™¨ä¸Šï¼Œdocker build å®é™…å°±æ˜¯æŒ‰ç…§ Dockerfile æ¥ docker run å’Œ docker commit çš„ç»“åˆï¼Œæ‰¾åˆ°å¤±è´¥çš„ run çš„é•œåƒ idï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps -a</span></span><br><span class="line">b7c4be99d86d   ba54b82c5b1c                                                        &quot;/bin/sh -c &#x27;IN_DOCKâ€¦&quot;   4 hours ago    Exited (1) 1 hours ago              nervous_chandrasekhar</span><br></pre></td></tr></table></figure><p>ç”¨ä¸Šé¢çš„é•œåƒ ID å’Œ command æ‰‹åŠ¨æµ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --<span class="built_in">rm</span> -ti --entrypoint bash ba54b82c5b1c</span></span><br><span class="line">root@a9114c46d496:/go/src/xxx.xxxgitlab.net/xxxxx/# IN_DOCKER=1 bash ./build.sh</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ä¾æ—§ï¼Œ<code>GOPRIVATE</code> <code>GONOPROXY</code> å•¥çš„éƒ½é…ç½®äº†çš„ï¼Œä»¥åŠ ssh ç›¸å…³ <code>git config --global url.&quot;git@xxx.xxxgitlab.net:&quot;.insteadof &quot;https://xxx.xxxgitlab.net/&quot;</code>éƒ½æ˜¯ä»¥åŠé…ç½®äº†æ²¡é—®é¢˜çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> ~/.gitconfig</span></span><br><span class="line">[url &quot;git@xxx.xxxgitlab.net:&quot;]</span><br><span class="line">insteadof = https://xxx.xxxgitlab.net/</span><br></pre></td></tr></table></figure><p>ç”¨ git æµ‹è¯•ä¹Ÿæ²¡é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -T git@xxx.xxxgitlab.net</span></span><br><span class="line">Welcome to GitLab, @xxxx_reporter!</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> xxx.xxxgitlab.net/x/xx/xxx</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ go çš„ help ï¼Œå‘ç° <code>go mod</code> æ²¡æœ‰ debug level ç›¸å…³ cmdlineï¼Œä½†æ˜¯ <code>go get</code> æœ‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go get -x  xxx.xxxgitlab.net/x/xx/xxx</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx/xxx?go-get=1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx/xxx?go-get=1: 200 OK (0.063s)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/docmxini/xx?go-get=1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx?go-get=1: 200 OK (0.016s)</span></span><br><span class="line">mkdir -p /go/pkg/mod/cache/vcs # git3 https://xxx.xxxgitlab.net/x/xx.git</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lock /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c.lock</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c <span class="keyword">for</span> git3 https://xxx.xxxgitlab.net/x/fx.git</span></span><br><span class="line">cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git -c log.showsignature=false log --no-decorate -n1 &#x27;--format=format:%H %ct %D&#x27; 4855369c0f1e --</span><br><span class="line">0.002s # cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git -c log.showsignature=false log --no-decorate -n1 &#x27;--format=format:%H %ct %D&#x27; 4855369c0f1e --</span><br><span class="line">cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git ls-remote -q origin</span><br><span class="line">0.232s # cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git ls-remote -q origin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx.git</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">get https://xxx.xxxgitlab.net/x/xx.git: 200 OK (0.076s)</span></span><br><span class="line">cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git tag -l</span><br><span class="line">0.002s # cd /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c; git tag -l</span><br><span class="line">go: xxx.xxxgitlab.net/x/xx/xxx@v1.6.5-rc.7.0.20250609085545-4855369c0f1e: invalid version: git ls-remote -q origin in /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c: exit status 128:</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">remote: The project you were looking for could not be found or you don&#x27;t have permission to view it.</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æœ€åçš„å‘½ä»¤æŠ¥é”™ï¼Œcd è¿›å»æ‰§è¡Œä¸‹çœ‹çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /go/pkg/mod/cache/vcs/672638ca2205d3f2cdc0288db28840b769e58250b95fbbd31e553c6c8076fc3c</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git ls-remote</span></span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">remote: The project you were looking for could not be found or you don&#x27;t have permission to view it.</span><br><span class="line">remote: </span><br><span class="line">remote: ========================================================================</span><br><span class="line">remote: </span><br><span class="line">fatal: Could not read from remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct access rights</span><br><span class="line">and the repository exists.</span><br></pre></td></tr></table></figure><p>å…¶å®å‰é¢çš„ <code>go get -x</code> é‡Œå°±æœ‰é—®é¢˜è¯¦ç»†ä¿¡æ¯äº†ï¼Œè¿™é‡Œæˆ‘æ˜¯çœ‹ç›®å½•ä¸‹æ–‡ä»¶å‘ç°çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -al</span></span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x  7 root root  119 Jun 17 03:53 .</span><br><span class="line">drwxr-xr-x 20 root root 8192 Jun 17 03:53 ..</span><br><span class="line">-rw-r--r--  1 root root   23 Jun 17 03:53 HEAD</span><br><span class="line">drwxr-xr-x  2 root root    6 Jun 17 03:53 branches</span><br><span class="line">-rw-r--r--  1 root root  179 Jun 17 03:53 config</span><br><span class="line">-rw-r--r--  1 root root   73 Jun 17 03:53 description</span><br><span class="line">drwxr-xr-x  2 root root 4096 Jun 17 03:53 hooks</span><br><span class="line">drwxr-xr-x  2 root root   21 Jun 17 03:53 info</span><br><span class="line">drwxr-xr-x  4 root root   30 Jun 17 03:53 objects</span><br><span class="line">drwxr-xr-x  4 root root   31 Jun 17 03:53 refs</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> config</span></span><br><span class="line">[core]</span><br><span class="line">repositoryformatversion = 0</span><br><span class="line">filemode = true</span><br><span class="line">bare = true</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">url = https://xxx.xxxgitlab.net/x/xx.git</span><br><span class="line">fetch = +refs/heads/*:refs/remotes/origin/*</span><br></pre></td></tr></table></figure><p>ä»“åº“åœ°å€ä¸å¯¹ï¼Œæ”¹æˆ <code>url = https://xxx.xxxgitlab.net/x/xx/xxx.git</code> åå°±å¯ä»¥äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git ls-remote | <span class="built_in">head</span></span></span><br><span class="line">From git@xxx.xxxgitlab.net:x/xx/xxx.git</span><br><span class="line">74f35a28ecc0f9721a49c41fb5d7bffa071d1502HEAD</span><br><span class="line">295c3a79dfc0d27022459d0cec21411031edd5e8refs/heads/0xxx</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="gitlab-subgroup"><a href="#gitlab-subgroup" class="headerlink" title="gitlab subgroup"></a>gitlab subgroup</h3><p>æœäº†ä¸‹ï¼Œå‘ç°æ˜¯ gitlab çš„é‰´æƒå’Œ golang çš„ get é€»è¾‘å†²çªï¼ŒåŒæ–¹éƒ½è®¤ä¸ºå¯¹æ–¹ä¸è§„èŒƒï¼Œè°éƒ½ä¸è®©è°ï¼Œå…·ä½“è§æ–‡ç« :</p><ul><li><a href="https://mp.weixin.qq.com/s/D_AsV9QpOZ_5v8f1eKoxjQ">Go æ¨¡å—ä½¿ç”¨ GitLab subgroups çš„é—®é¢˜</a></li><li><a href="https://docs.gitlab.com/ee/user/project/use_project_as_go_package.html#authenticate-go-requests-to-private-projects">use_project_as_go_package</a></li><li><a href="https://go.dev/ref/mod#private-module-proxy-auth">private-module-proxy-auth</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/437005">Allow to set a go-modules folder for private Go projects</a></li></ul><p>è§£å†³æ–¹æ¡ˆåªæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ <code>~/.netrc</code> ä½†æ˜¯æ˜¯æ˜æ–‡å¯†ç ï¼Œä¸é€‚ç”¨äº CI&#x2F;CD æ„å»ºã€‚<br>ä½¿ç”¨ replace çš„è¯éœ€è¦æŒ‡å®šä¸€æ ·çš„ç‰ˆæœ¬ï¼Œè€Œ <code>go get</code> å‡çº§ä¾èµ–çš„æ—¶å€™ replace ä¸ä¼šåŠ¨ã€‚<br>å†™ shell åœ¨ <code>go build</code> å‰æ‰§è¡Œçš„è¯ï¼Œæ€•æ­£åˆ™è¾¹ç•Œå’Œæ¨¡ç³ŠåŒ¹é…åˆ°äº†å‰ç¼€ä¸€æ ·çš„ï¼Œå¹¶ä¸” <code>go mod edit -json</code> å¯ä»¥è¾“å‡º json ä¿¡æ¯ï¼Œå¥½åœ¨ golang ç¼–è¯‘é•œåƒæ˜¯ ubuntuï¼Œå†…éƒ¨æœ‰ pythonã€‚</p><h3 id="è„šæœ¬è§£å†³"><a href="#è„šæœ¬è§£å†³" class="headerlink" title="è„šæœ¬è§£å†³"></a>è„šæœ¬è§£å†³</h3><p>èŠ±äº†ç‚¹æ—¶é—´å†™äº†å¦‚ä¸‹ python è„šæœ¬ï¼Œæ‰§è¡Œæ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">go mod edit -json | python3 scripts/golang-subgroup.py \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æˆ–è€…</span></span><br><span class="line">go mod edit -json &gt; go.mod.json</span><br><span class="line">python3 scripts/golang-subgroup.py \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx \</span><br><span class="line">  --repo xxx.xxxgitlab.net/x/xx/xxx2</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;è§£å†³ go.mod é‡Œçš„ gitlab subgroups é—®é¢˜&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--repo&#x27;</span>, action=<span class="string">&#x27;append&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;è¦å¤„ç†çš„ä»“åº“åå­—ï¼Œä¾‹å¦‚: xx.gitlab.cn/a/b/c&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--mod&#x27;</span>, default=<span class="string">&quot;./go.mod&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;go.mod path&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">replace_repo</span>(<span class="params">repo_list, mod_json, mod_path</span>):</span><br><span class="line">    <span class="keyword">if</span> mod_json[<span class="string">&#x27;Replace&#x27;</span>]:</span><br><span class="line">        mod_replace_list = [ i[<span class="string">&#x27;Old&#x27;</span>][<span class="string">&#x27;Path&#x27;</span>] <span class="keyword">for</span> i <span class="keyword">in</span> mod_json[<span class="string">&#x27;Replace&#x27;</span>]]</span><br><span class="line">        repo_list = [repo <span class="keyword">for</span> repo <span class="keyword">in</span> repo_list <span class="keyword">if</span> repo <span class="keyword">not</span> <span class="keyword">in</span> mod_replace_list]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(repo_list) == <span class="number">0</span>:</span><br><span class="line">            logging.info(<span class="string">&quot;å·²ç»å…¨éƒ¨æ›¿æ¢&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    replace_list = [ i <span class="keyword">for</span> i <span class="keyword">in</span> mod_json[<span class="string">&#x27;Require&#x27;</span>] <span class="keyword">if</span> i[<span class="string">&#x27;Path&#x27;</span>] <span class="keyword">in</span> repo_list <span class="keyword">and</span> (<span class="keyword">not</span> i.get(<span class="string">&#x27;Indirect&#x27;</span>, <span class="literal">False</span>))]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(replace_list) == <span class="number">0</span>:</span><br><span class="line">        logging.error(<span class="string">&quot;æœªæ‰¾åˆ°éœ€è¦æ›¿æ¢çš„ä»“åº“: %s&quot;</span>, <span class="string">&#x27;,&#x27;</span>.join(repo_list))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(mod_path, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> replace_list:</span><br><span class="line">            replace_str = <span class="string">&quot;replace &#123;0&#125; =&gt; &#123;0&#125;.git &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(item[<span class="string">&#x27;Path&#x27;</span>], item[<span class="string">&#x27;Version&#x27;</span>])</span><br><span class="line">            logging.info(<span class="string">&quot;æ·»åŠ  %s&quot;</span>, replace_str)</span><br><span class="line">            f.writelines(replace_str+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">    args = parse_args()</span><br><span class="line">    <span class="keyword">if</span> args.repo <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(args.repo) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    mod_json = &#123;&#125;</span><br><span class="line">    mod_json_path = <span class="string">&quot;go.mod.json&quot;</span></span><br><span class="line">    <span class="keyword">if</span> os.isatty(<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(mod_json_path):</span><br><span class="line">            logging.error(<span class="string">&quot;è¯·ä»¥ go mod edit -json | python3 %s è¿è¡Œ&quot;</span>, __file__)</span><br><span class="line">            os._exit(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(mod_json_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            mod_json = json.load(file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        mod_json = json.loads(sys.stdin.read())</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> <span class="built_in">isinstance</span>(mod_json, <span class="built_in">dict</span>)) <span class="keyword">or</span> mod_json.get(<span class="string">&quot;Module&quot;</span>, <span class="string">&quot;&quot;</span>) == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        logging.error(<span class="string">&quot;è¯·ä»¥ go mod edit -json | python3 %s è¿è¡Œ&quot;</span>, __file__)</span><br><span class="line">        os._exit(<span class="number">2</span>)</span><br><span class="line">    replace_repo(args.repo, mod_json, args.mod)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ç»™åŒäº‹è§£å†³çš„ subgroup é—®é¢˜â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="http://zhangguanzhang.github.io/tags/golang/"/>
    
    <category term="gitlab" scheme="http://zhangguanzhang.github.io/tags/gitlab/"/>
    
    <category term="subgroup" scheme="http://zhangguanzhang.github.io/tags/subgroup/"/>
    
  </entry>
  
  <entry>
    <title>å°ç™½å‘çš„ kubernetes è¯ä¹¦è®²è§£</title>
    <link href="http://zhangguanzhang.github.io/2025/06/02/kubernetes-cert/"/>
    <id>http://zhangguanzhang.github.io/2025/06/02/kubernetes-cert/</id>
    <published>2025-06-02T20:40:30.000Z</published>
    <updated>2025-06-02T20:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åŒäº‹é‡åˆ°å‡ èµ·è¯ä¹¦ç›¸å…³é—®é¢˜ï¼Œä»å°ç™½è§’åº¦æ¥å†™ä¸‹ k8s è¯ä¹¦â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å¾ˆå¤šäººå¯¹  k8s è¯ä¹¦å’Œ kubeconfig æœ›è€Œå´æ­¥ï¼Œè¯ä¹¦è¿‡æœŸå’Œç›¸å…³æŠ¥é”™å°±æ— ä»ä¸‹æ‰‹ï¼Œå¸‚é¢ä¸Šæœ‰å†™è¯ä¹¦çš„æ–‡ç« åšå®¢ï¼Œä½†æ˜¯æ„Ÿè§‰å¾ˆé•¿çš„ç†è®ºä¼šè®©å¾ˆå¤šäººçœ‹ä¸ä¸‹å»ï¼Œå®é™…æ›´éœ€è¦çš„æ˜¯è§£å†³é—®é¢˜æ—¶å€™çš„å…·ä½“æ­¥éª¤å’Œæ–¹å‘ã€‚</p><h2 id="ç†è®ºéƒ¨åˆ†"><a href="#ç†è®ºéƒ¨åˆ†" class="headerlink" title="ç†è®ºéƒ¨åˆ†"></a>ç†è®ºéƒ¨åˆ†</h2><p>ç®€å•è®²è§£è¯ä¹¦ç†è®ºéƒ¨åˆ†ã€‚</p><h3 id="åŒå‘-SSL"><a href="#åŒå‘-SSL" class="headerlink" title="åŒå‘ SSL"></a>åŒå‘ SSL</h3><p>è®¿é—®ä¸€ä¸ª https ç½‘ç«™ï¼Œéœ€è¦ç›®æ ‡ web server é…ç½®æœ‰ ssl è¯ä¹¦ï¼Œè€Œè¯ä¹¦æ¥æºä¸¤ç§ï¼š</p><ol><li>CAï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰ä½¿ç”¨ç§é’¥ç­¾ç½²å‡º æ ¹ CA è¯ä¹¦ï¼ˆå…¬é’¥ï¼‰ï¼Œæµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿå†…ç½®è¿™äº› æ ¹ CA è¯ä¹¦ï¼Œ åªæœ‰ CA æœºæ„ç­¾ç½²çš„è¯ä¹¦æ‰ä¼šæ˜¯ç»¿é”ã€‚</li><li>ä½¿ç”¨è¯ä¹¦å·¥å…·æˆ–è€…éµå®ˆè¯ä¹¦è§„èŒƒçš„åº“ç”Ÿæˆçš„ CA ç§é’¥è‡ªå·±ç­¾ç½²å‡ºçš„è¯ä¹¦ï¼Œæµè§ˆå™¨æ˜¾ç¤ºçº¢è‰²è­¦å‘Šï¼ˆè¿æ¥ä¸å®‰å…¨&#x2F;æ— æ•ˆè¯ä¹¦ï¼‰</li></ol><p>k8s é‡‡ç”¨çš„æ˜¯åŸºäº X.509 V3 æ ‡å‡†çš„åŒå‘ SSLï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡ï¼Œéƒ½ä¼šéªŒè¯åŒæ–¹è¯ä¹¦ï¼Œæ ¹æ®åŒæ–¹æ˜¯å¦æ˜¯ä¸€æ ·çš„ CA ç­¾ç½²çš„è¯ä¹¦ï¼Œè€Œ CA ç§é’¥æ˜¯è‡ªå·±ç”Ÿæˆçš„ï¼Œä½ å¯ä»¥çœ‹åˆ° k8s ç»„ä»¶çš„ cmdline éƒ½æœ‰æŒ‡å®šå‚æ•° <code>ca-file|cert-file</code> ç›¸å…³ã€‚</p><h3 id="è¯ä¹¦å»ºè®®ç›¸å…³"><a href="#è¯ä¹¦å»ºè®®ç›¸å…³" class="headerlink" title="è¯ä¹¦å»ºè®®ç›¸å…³"></a>è¯ä¹¦å»ºè®®ç›¸å…³</h3><h4 id="æ—¶é—´"><a href="#æ—¶é—´" class="headerlink" title="æ—¶é—´"></a>æ—¶é—´</h4><p>æ— è®ºæ˜¯ openssl è¿˜æ˜¯ cfsslï¼Œæ¨èéƒ½æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®é«˜ä¸€äº›ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -x509 ... -days 10000</span><br><span class="line">$ cat ca-config.json</span><br><span class="line">...</span><br><span class="line">  &quot;expiry&quot;: &quot;876000h&quot;</span><br></pre></td></tr></table></figure><p>è€Œå¯¹äº kubeadmï¼Œç½‘ä¸Šæœ‰ä¿®æ”¹ç¼–è¯‘çš„ï¼Œæˆ–è€… go build çš„æ—¶å€™æ³¨å…¥è¦†ç›–é»˜è®¤çš„æ—¶é—´çš„ï¼Œè‡ªè¡Œæœç´¢ã€‚</p><h4 id="certSAN"><a href="#certSAN" class="headerlink" title="certSAN"></a>certSAN</h4><p>k8s é‡Œ <code>kube-apiserver</code> å’Œ <code>etcd</code> éƒ½æ˜¯éƒ¨ç½²åœ¨å¤šä¸ªæœºå™¨ä¸Šå®ç°é«˜å¯ç”¨çš„ï¼Œåœ¨ <code>openssl/cfssl/kubeadm</code> é‡Œæ¨èåŠ  IP ä»¥å¤–è¿˜è¦åŠ åŸŸåä»¥é˜²åç»­æ¢ IP ç›¸å…³ï¼š</p><ul><li>openssl é…ç½®æ–‡ä»¶å‚è€ƒ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/roles/etcd/templates/openssl.conf.j2">kubernetes-sigs&#x2F;kubespray çš„ openssl.conf</a></li><li>cfssl ä½¿ç”¨çš„ json æ–‡ä»¶é‡Œçš„ <code>hosts</code> å­—æ®µ</li><li>kubeadm çš„ <code>certSANs</code> å­—æ®µ</li></ul><p>è¿™é‡Œä»¥ ipv4 ä¸‹ kubeadm çš„æŒ‡å®š yml åˆ›å»ºé›†ç¾¤æ¥ä¸¾ä¾‹ä¸€èˆ¬å†™é‚£äº›ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ cat initconfig.yaml</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - 10.96.0.1 # service cidrçš„ç¬¬ä¸€ä¸ªip</span><br><span class="line">  - 127.0.0.1 # å¤šä¸ªmasterçš„æ—¶å€™è´Ÿè½½å‡è¡¡å‡ºé—®é¢˜äº†èƒ½å¤Ÿå¿«é€Ÿä½¿ç”¨localhostè°ƒè¯•</span><br><span class="line">  - localhost</span><br><span class="line">  - apiserver.k8s.local # è´Ÿè½½å‡è¡¡çš„åŸŸåæˆ–è€…vip</span><br><span class="line">  - 172.19.0.2 # ä¸‰å° kube-apiserver çš„ IP</span><br><span class="line">  - 172.19.0.3</span><br><span class="line">  - 172.19.0.4</span><br><span class="line">  - apiserver01.k8s.local </span><br><span class="line">  - apiserver02.k8s.local</span><br><span class="line">  - apiserver03.k8s.local</span><br><span class="line">  - apiserver04.k8s.local # é¢„ç•™åŸŸå</span><br><span class="line">  - apiserver05.k8s.local</span><br><span class="line">  - master</span><br><span class="line">  - kubernetes</span><br><span class="line">  - kubernetes.default</span><br><span class="line">  - kubernetes.default.svc</span><br><span class="line">  - kubernetes.default.svc.cluster.local # é›†ç¾¤å†… dns search å’Œ clusterDomain</span><br><span class="line">...</span><br><span class="line">etcd: # https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2#Etcd</span><br><span class="line">  local:</span><br><span class="line">    serverCertSANs:</span><br><span class="line">    - localhost</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">    - 172.19.0.2</span><br><span class="line">    - 172.19.0.3</span><br><span class="line">    - 172.19.0.4</span><br><span class="line">    - etcd01.k8s.local</span><br><span class="line">    - etcd02.k8s.local</span><br><span class="line">    - etcd03.k8s.local</span><br><span class="line">    - etcd04.k8s.local # é¢„ç•™åŸŸå</span><br><span class="line">    - etcd05.k8s.local</span><br><span class="line">    peerCertSANs:</span><br><span class="line">    - localhost</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">    - 172.19.0.2</span><br><span class="line">    - 172.19.0.3</span><br><span class="line">    - 172.19.0.4</span><br><span class="line">    - etcd01.k8s.local</span><br><span class="line">    - etcd02.k8s.local</span><br><span class="line">    - etcd03.k8s.local</span><br><span class="line">    - etcd04.k8s.local # é¢„ç•™åŸŸå</span><br><span class="line">    - etcd05.k8s.local</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åªåˆ—ä¸¾ IPv4 çš„ï¼Œå¦‚æœåç»­æœ‰åŒæ ˆå•¥çš„å¯ä»¥é¢„å…ˆå†™ä¸Šï¼Œå¦‚æœå†™æ¼äº†åŸŸåå’Œ IPï¼Œç®¡ç†ç»„ä»¶æˆ–è€… pod å†…é€šè¿‡ SDK è®¿é—® kube-apiserver çš„æ—¶å€™ä¼šæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unable to connect to the server: tls: failed to verify certificate: x509: certificate is valid for 10.96.0.1, yyyy, not xxxx</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯ä¹¦çš„ certSANs åªæœ‰ <code>10.96.0.1, yyyy</code> è€Œæ²¡æœ‰ <code>xxxx</code>ï¼Œå¯ä»¥ä½¿ç”¨åŸæœ‰ CA è¯ä¹¦ç­¾ç½²ä¸‹ã€‚å‘½ä»¤è¡ŒæŸ¥çœ‹è¯ä¹¦çš„ certSAN å¯ä»¥ä½¿ç”¨ openssl ï¼Œç¼–ç¨‹è¯­è¨€çš„è¯æ¨èå»ä½¿ç”¨åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸€èˆ¬ä¼šæŠŠè¯ä¹¦æ”¾åœ¨ /etc/kubernetes/pki æ‰¾ä¸åˆ°çš„æ‰¾ apiserver cmdline å‚æ•°è·¯å¾„</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -noout -text -<span class="keyword">in</span> apiserver.crt</span></span><br><span class="line">X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:localhost, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address: 172.19.0.2</span><br></pre></td></tr></table></figure><p>openssl ä¸Šé¢çš„è¾“å‡ºé‡Œå¾ˆå¤šä¿¡æ¯ï¼Œè¿˜åŒ…å«è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œè€Œä¸” openssl x509 ä¸‹å¾ˆå¤šé€‰é¡¹çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ©ç”¨ -certopt å’Œ -text é…åˆåªæ‰“å° certSANs</span></span><br><span class="line">openssl x509 -noout  -in apiserver.crt  -certopt no_subject,no_header,no_version,no_serial,no_signame,no_validity,no_issuer,no_pubkey,no_sigdump,no_aux -text</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åªæŸ¥çœ‹è¯ä¹¦æ—¶é—´</span></span><br><span class="line">openssl x509 -noout  -in apiserver.crt -dates</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åªå±•ç¤º subject</span></span><br><span class="line">openssl x509 -noout  -in apiserver.crt  -subject</span><br></pre></td></tr></table></figure><p>åªæœ‰åŒä¸€å¥— ca ç­¾ç½²è¯ä¹¦æ‰ç¬¦åˆè¦æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ openssl å‘½ä»¤æ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ apiserver.crt æ˜¯å¦æ˜¯ç”± ca.key ç­¾ç½²</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl verify -CAfile ca.crt apiserver.crt</span></span><br><span class="line">apiserver.crt: OK</span><br></pre></td></tr></table></figure><h3 id="k8s-role-å’Œ-RBAC"><a href="#k8s-role-å’Œ-RBAC" class="headerlink" title="k8s role å’Œ RBAC"></a>k8s role å’Œ RBAC</h3><p>åŒå‘ TLS è¿‡å»äº†ï¼Œä½†æ˜¯å…·ä½“æƒé™æ§åˆ¶ k8s æ€ä¹ˆåšçš„å‘¢ï¼Œå°±æ˜¯ X.509 è¯ä¹¦ç­¾ç½²ï¼ˆSubject å­—æ®µå†…ï¼‰çš„ <code>CN(Common Name)</code> ä¸ <code>O(Organization)</code> å­—æ®µï¼Œå¯¹åº” <code>User Name</code> å’Œ <code>Group</code>ï¼Œä¹Ÿå°±æ˜¯ k8s çš„ RBACï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get clusterrolebinding</span><br><span class="line">NAME                                                   ROLE                                                                               AGE</span><br><span class="line">cluster-admin                                          ClusterRole/cluster-admin                                                          81m</span><br><span class="line">kubeadm:get-nodes                                      ClusterRole/kubeadm:get-nodes                                                      81m</span><br><span class="line">kubeadm:kubelet-bootstrap                              ClusterRole/system:node-bootstrapper                                               81m</span><br><span class="line">kubeadm:node-autoapprove-bootstrap                     ClusterRole/system:certificates.k8s.io:certificatesigningrequests:nodeclient       81m</span><br><span class="line">kubeadm:node-autoapprove-certificate-rotation          ClusterRole/system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   81m</span><br><span class="line">kubeadm:node-proxier                                   ClusterRole/system:node-proxier                                                    81m</span><br><span class="line">...</span><br><span class="line">system:coredns                                         ClusterRole/system:coredns                                                         81m</span><br><span class="line">system:discovery                                       ClusterRole/system:discovery                                                       81m</span><br><span class="line">system:kube-controller-manager                         ClusterRole/system:kube-controller-manager                                         81m</span><br><span class="line">system:kube-dns                                        ClusterRole/system:kube-dns                                                        81m</span><br><span class="line">system:kube-scheduler                                  ClusterRole/system:kube-scheduler                                                  81m</span><br><span class="line">system:monitoring                                      ClusterRole/system:monitoring                                                      81m</span><br><span class="line">system:node                                            ClusterRole/system:node                                                            81m</span><br><span class="line">system:node-proxier                                    ClusterRole/system:node-proxier                                                    81m</span><br><span class="line">system:public-info-viewer                              ClusterRole/system:public-info-viewer                                              81m</span><br><span class="line">system:service-account-issuer-discovery                ClusterRole/system:service-account-issuer-discovery                                81m</span><br><span class="line">system:volume-scheduler                                ClusterRole/system:volume-scheduler                                                81m</span><br></pre></td></tr></table></figure><p>kube-apiserver å¯åŠ¨åä¼šåˆ›å»ºä¸Šé¢çš„ <code>clusterrolebinding</code>ï¼Œkubectl æœ¬è´¨å°±æ˜¯ä¸ª client + kubeconfig è®¿é—® <code>kube-apiserver</code> çš„ï¼ŒæŸ¥çœ‹ kubectl å½“å‰ä½¿ç”¨çš„ <code>kubeconfig</code> å¯ä»¥é€šè¿‡ k8s æ‰€æœ‰äºŒè¿›åˆ¶çš„ cmdline çš„ <code>-v</code> é€‰é¡¹ï¼Œä»è¯¦ç»†ä¿¡æ¯é‡Œè·å–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl config view -v=6</span></span><br><span class="line">I0604 10:40:46.836786   14513 loader.go:395] Config loaded from file:  /root/.kube/config</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä»ä¸Šé¢çœ‹åˆ°æ˜¯ <code>/root/.kube/config</code> ï¼Œä»¥ kubeadm çš„ä¸¾ä¾‹ï¼Œè¯¥æ–‡ä»¶å†…å®¹å†…æœ‰è¯ä¹¦å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /root/.kube/config</span><br><span class="line">certificate-authority-data  /etc/kubernetes/pki/ca.crt å†…å®¹ base64 åŠ å¯†åçš„å€¼</span><br><span class="line">client-certificate-data     /etc/kubernetes/pki/admin.crt å†…å®¹ base64 åŠ å¯†åçš„å€¼</span><br><span class="line">client-key-data             /etc/kubernetes/pki/admin.key å†…å®¹ base64 åŠ å¯†åçš„å€¼</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åé¢ä¿©å·²ç»å†…åµŒäº†ï¼Œæ‰€ä»¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰äº›äººè‡ªå»ºé›†ç¾¤ä¸Šé¢çš„åé¢å€¼æ˜¯è·¯å¾„ï¼Œæ˜¯å› ä¸º kubectl config ç”Ÿæˆ kubeconfig çš„æ—¶å€™æ²¡æŒ‡å®šé€‰é¡¹ <code>--embed-certs</code>ï¼Œå†…åµŒçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig /etc/kubernetes/admin.conf config set-credentials admin \</span><br><span class="line">        --client-certificate=/etc/kubernetes/pki/admin.crt \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --client-key=/etc/kubernetes/pki/admin.key&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">rm</span> -f /etc/kubernetes/pki/admin.???</span></span><br></pre></td></tr></table></figure><p>kubeadm golang ç›´æ¥æ²¡æœ‰è½åœ°æ–‡ä»¶ï¼Œç›´æ¥ç”Ÿæˆ yml å†…å®¹çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ‰£å‡ºè¯ä¹¦ä¿¡æ¯çœ‹çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> &lt;(kubectl config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d ) -noout -text</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> &lt;(kubectl config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d ) -noout  -subject</span></span><br><span class="line">subject= /O=system:masters/CN=kubernetes-admin</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>O=system:masters</code> ï¼Œå®é™…å¯¹åº” <code>clusterrolebinding cluster-admin</code> çš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get clusterrolebinding cluster-admin -o yaml</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  creationTimestamp: &quot;2025-06-03T07:36:44Z&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  resourceVersion: &quot;160&quot;</span><br><span class="line">  uid: d5638680-38de-4010-a2c9-084645a8ad21</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Group</span><br><span class="line">  name: system:masters</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ç»„ <code>system:masters</code> å…·å¤‡ clusterrole <code>cluster-admin</code> çš„æƒé™ã€‚</p><p>æœ¬å°ç»“å‚è€ƒï¼š</p><ul><li><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/">ä½¿ç”¨ RBAC é‰´æƒ</a></li><li><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/implementation-details/">kubeadm å®ç°ç»†èŠ‚</a></li></ul><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><p>è¯´å®Œç†è®ºéƒ¨åˆ†ï¼Œæ¥å®æˆ˜ä¸‹ï¼Œåˆ©ç”¨è¯ä¹¦çš„ <code>CN(Common Name)</code> ä¸ <code>O(Organization)</code> å­—æ®µæ¥åˆ›å»ºä¸¤ä¸ªæƒé™è¯ä¹¦æµ‹è¯•ä¸‹ï¼š</p><ul><li>ç”¨æˆ· test1 å…·å¤‡ default ns ä¸‹çš„ pod list æƒé™</li><li>ç»„ test2 å…·å¤‡æ‰€æœ‰ ns çš„ pod list æƒé™</li></ul><p>é¿å…è·¯å¾„ã€è¯ä¹¦åå­—å’Œåç¼€å’Œä¹ æƒ¯é—®é¢˜ï¼Œå®æˆ˜éƒ¨åˆ†ä»¥ cfssl åœ¨ kubeadm åˆå§‹åŒ–åçš„æ–‡ä»¶ç›®å½•å†…æ“ä½œã€‚</p><p>å¯¹è¯ä¹¦åšæ“ä½œä¹‹å‰è¦æœ‰å¤‡ä»½ä¹ æƒ¯ï¼Œæ— è®ºè¯ä¹¦æŸåè¿˜æ˜¯è¿‡æœŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes</span><br><span class="line">cp -a pki pki.bak</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºè¯ä¹¦"><a href="#åˆ›å»ºè¯ä¹¦" class="headerlink" title="åˆ›å»ºè¯ä¹¦"></a>åˆ›å»ºè¯ä¹¦</h3><p>åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># åˆ›å»º ca ç­¾ç½²è¯ä¹¦ç­¾åé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºè¯¥è¯ä¹¦æ˜¯åª client ä½¿ç”¨ï¼Œä¸éœ€è¦åœ¨ usages é‡Œå¸¦ &quot;server auth&quot;</span><br><span class="line"># å¦‚æœæ‰€æœ‰è¯ä¹¦æ‰‹åŠ¨ç”Ÿæˆæ—¶å€™ç”¨åŒä¸€ä¸ª ca-config.json å¯ä»¥å·æ‡’å¸¦ä¸Š &quot;server auth&quot;</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># cn å¯¹åº” user o å¯¹åº” group</span><br><span class="line">cat &gt; test1-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;test1&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;O&quot;: &quot;test1&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç­¾ç½²è¯ä¹¦ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert \</span><br><span class="line">        -ca=ca.crt \</span><br><span class="line">        -ca-key=ca.key \</span><br><span class="line">        -config=ca-config.json \</span><br><span class="line">        -profile=kubernetes test1-csr.json | cfssljson -bare test1</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è¯ä¹¦æƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é¿å… kubeconfig å¹²æ‰°ï¼Œæ”¹åä¸‹å®¶ç›®å½•æ–‡ä»¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config ~/.kube/config.bak</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">KUBECONFIG= kubectl --server=https://xxx:6443 \</span></span><br><span class="line"><span class="language-bash">  --certificate-authority=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="language-bash">  --client-certificate=/etc/kubernetes/pki/test1.pem \</span></span><br><span class="line"><span class="language-bash">  --client-key=/etc/kubernetes/pki/test1-key.pem get pod</span></span><br><span class="line">Error from server (Forbidden): pods is forbidden: User &quot;test1&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure><p>kube-apiserver æœ¬è´¨æ˜¯ http&#x2F;grpc serverï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ curl æµ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X GET \</span></span><br><span class="line"><span class="language-bash">  --cacert /etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="language-bash">  --cert /etc/kubernetes/pki/test1.pem \</span></span><br><span class="line"><span class="language-bash">  --key /etc/kubernetes/pki/test1-key.pem \</span></span><br><span class="line"><span class="language-bash">  -H <span class="string">&quot;Accept: application/json&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  <span class="string">&quot;https://xxx:6443/api/v1/namespaces/default/pods?limit=500&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;&#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;pods is forbidden: User \&quot;test1\&quot; cannot list resource \&quot;pods\&quot; in API group \&quot;\&quot; in the namespace \&quot;default\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;kind&quot;: &quot;pods&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åˆ›å»º <code>test1</code> çš„ <code>RBAC</code> ï¼Œä¹Ÿå°±æ˜¯ <code>rolebinding</code>ï¼Œåˆ›å»ºä¸‹åå†è¯•è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config.bak ~/.kube/config</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; test1-rbac.yml &lt;&lt; <span class="string">EOF</span></span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: test1-role</span><br><span class="line">  namespace: default</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: test1-rolebinding</span><br><span class="line">  namespace: default</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: test1-role</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: test1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">kubectl apply -f test1-rbac.yml</span></span></span><br></pre></td></tr></table></figure><p>ç„¶åå†æµ‹è¯•ï¼Œå¯ä»¥åˆ—å‡º default ä¸‹çš„ pod è€Œä¸èƒ½åˆ—å‡º svcï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> ~/.kube/config ~/.kube/config.bak</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">KUBECONFIG= kubectl --server=https://xxx:6443 \</span></span><br><span class="line"><span class="language-bash">  --certificate-authority=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="language-bash">  --client-certificate=/etc/kubernetes/pki/test1.pem \</span></span><br><span class="line"><span class="language-bash">  --client-key=/etc/kubernetes/pki/test1-key.pem get pod</span></span><br><span class="line">No resources found in default namespace.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">KUBECONFIG= kubectl --server=https://xxx:6443   --certificate-authority=/etc/kubernetes/pki/ca.crt   --client-certificate=/etc/kubernetes/pki/test1.pem   --client-key=/etc/kubernetes/pki/test1-key.pem get svc</span></span><br><span class="line">Error from server (Forbidden): services is forbidden: User &quot;test1&quot; cannot list resource &quot;services&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure><p>åŒæ ·ä½¿ç”¨ curl æµ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X GET  \</span></span><br><span class="line"><span class="language-bash">  --cacert /etc/kubernetes/pki/ca.crt  \</span></span><br><span class="line"><span class="language-bash">  --cert /etc/kubernetes/pki/test1.pem  \</span></span><br><span class="line"><span class="language-bash">  --key /etc/kubernetes/pki/test1-key.pem  \</span></span><br><span class="line"><span class="language-bash">   -H <span class="string">&quot;Accept: application/json&quot;</span>   <span class="string">&quot;https://10.xxx.xx.xxx:6443/api/v1/namespaces/default/pods?limit=500&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;PodList&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line">    &quot;resourceVersion&quot;: &quot;107116&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;items&quot;: []</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X GET  \</span></span><br><span class="line"><span class="language-bash">  --cacert /etc/kubernetes/pki/ca.crt  \</span></span><br><span class="line"><span class="language-bash">  --cert /etc/kubernetes/pki/test1.pem  \</span></span><br><span class="line"><span class="language-bash">  --key /etc/kubernetes/pki/test1-key.pem  \</span></span><br><span class="line"><span class="language-bash">   -H <span class="string">&quot;Accept: application/json&quot;</span>   <span class="string">&quot;https://10.xxx.xx.xxx:6443/api/v1/namespaces/default/services?limit=500&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;&#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;services is forbidden: User \&quot;test1\&quot; cannot list resource \&quot;services\&quot; in API group \&quot;\&quot; in the namespace \&quot;default\&quot;&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Forbidden&quot;,</span><br><span class="line">  &quot;details&quot;: &#123;</span><br><span class="line">    &quot;kind&quot;: &quot;services&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;code&quot;: 403</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯ä¹¦æƒé™ç¬¦åˆé¢„æœŸï¼Œkubeconfig é‡Œå¯ä»¥åŒ…å«å¤šä¸ªé…ç½®æ®µçš„ï¼Œå‰é¢çš„è¯ä¹¦ç”Ÿæˆ kubeconfig å¯ä»¥ä½¿ç”¨ kubectl ï¼ŒæŒ‰ç…§ä¸‹é¢æ­¥éª¤ç”Ÿæˆå¯¹åº”é…ç½®æ®µï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®é›†ç¾¤å‚æ•°ï¼ŒæŒ‡å®šCAè¯ä¹¦å’Œapiserveråœ°å€</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config set-cluster kubernetes \</span><br><span class="line">    --certificate-authority=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --server=https://xxx:6443</span><br><span class="line">        </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼ŒæŒ‡å®šä½¿ç”¨è¯ä¹¦å’Œç§é’¥</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config set-credentials test1 \</span><br><span class="line">    --client-certificate=test1.pem \</span><br><span class="line">    --embed-certs=true \</span><br><span class="line">    --client-key=test1-key.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿½åŠ ä¸€ä¸ªåä¸º kubernetes çš„ä¸Šä¸‹æ–‡å‚æ•°ï¼ŒæŒ‡å®šå®ƒä½¿ç”¨å‰é¢æ·»åŠ çš„ é›†ç¾¤ kubernetes å’Œåä¸º test1 çš„å‡­æ®</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config set-context kubernetes \</span><br><span class="line">    --cluster=kubernetes --user=test1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€‰æ‹©é»˜è®¤çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl --kubeconfig=test1.kubeconfig config use-context kubernetes</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨è¯¥ kubeconfig æµ‹è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zgz pki]# kubectl --kubeconfig=test1.kubeconfig get pod</span><br><span class="line">No resources found in default namespace.</span><br><span class="line">[root@zgz pki]# kubectl --kubeconfig=test1.kubeconfig get svc</span><br><span class="line">Error from server (Forbidden): services is forbidden: User &quot;test1&quot; cannot list resource &quot;services&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure><p>group test2 ä¸€æ ·æ“ä½œï¼Œå°±æ˜¯æ³¨æ„ <code>O</code> å­—æ®µå³å¯ï¼Œç„¶åæ˜¯ <code>clusterrole</code> å’Œ <code>clusterrolebinding</code> ï¼Œè‡ªè¡ŒæŒ‘æˆ˜ä¸‹ã€‚</p><h3 id="kube-apiserver-çš„-certSAN"><a href="#kube-apiserver-çš„-certSAN" class="headerlink" title="kube-apiserver çš„ certSAN"></a>kube-apiserver çš„ certSAN</h3><p>æ­¤éƒ¨åˆ†è§£å†³ kube-apiserver çš„è¯ä¹¦ï¼ˆè¿‡æœŸä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥ï¼‰ï¼Œä¾‹å¦‚å¾ˆå¤šäºº kubeadm åˆå§‹åŒ–åï¼ŒcertSAN ç¼ºå°‘ hosts æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ echo &#x27;127.0.0.1 santest&#x27; &gt;&gt; /etc/hosts</span><br><span class="line">$ kubectl --server https://santest:6443 get pod</span><br><span class="line">...</span><br><span class="line">Unable to connect to the server: tls: </span><br><span class="line">    failed to verify certificate: x509: </span><br><span class="line">    certificate is valid for kubernetes, kubernetes.default, kubernetes.default.svc, kubernetes.default.svc.cluster.local, node, not santest</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¯ä»¥ç”¨ ca ç­¾ç½²æ–°è¯ä¹¦æ¥åŒ…å« santest ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line"># åˆ›å»º ca ç­¾ç½²è¯ä¹¦ç­¾åé…ç½®æ–‡ä»¶ï¼Œå› ä¸ºè¯¥è¯ä¹¦æ˜¯åª server ä½¿ç”¨ï¼Œä¸éœ€è¦åœ¨ usages é‡Œå¸¦ &quot;client auth&quot;</span><br><span class="line"># å¦‚æœæ‰€æœ‰è¯ä¹¦æ‰‹åŠ¨ç”Ÿæˆæ—¶å€™ç”¨åŒä¸€ä¸ª ca-config.json å¯ä»¥å·æ‡’å¸¦ä¸Š &quot;client auth&quot;</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹ç°æœ‰ certSAN</span><br><span class="line">openssl x509 -noout  -in apiserver.crt  -certopt no_subject,no_header,no_version,no_serial,no_signame,no_validity,no_issuer,no_pubkey,no_sigdump,no_aux -text</span><br><span class="line"></span><br><span class="line"># æŠŠä¸Šé¢è€çš„å’Œè¦æ·»åŠ çš„ å†™åˆ°æ–‡ä»¶é‡Œ</span><br><span class="line">cat &gt; kubernetes-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;::1&quot;,</span><br><span class="line">    &quot;localhost&quot;,</span><br><span class="line">    &quot;santest&quot;</span><br><span class="line">    &quot;10.xx&quot;,</span><br><span class="line">    &quot;10.96.0.1&quot;,</span><br><span class="line">    &quot;kubernetes&quot;,</span><br><span class="line">    &quot;kubernetes.default&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># ç­¾ç½²è¯ä¹¦</span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">        -ca=ca.crt \</span><br><span class="line">        -ca-key=ca.key \</span><br><span class="line">        -config=ca-config.json \</span><br><span class="line">        -profile=kubernetes kubernetes-csr.json | cfssljson -bare apiserver2</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ kube-apiserver çš„ cmdline ä½¿ç”¨ <code>apiserver2.pem</code> å’Œ <code>apiserver2-key.pem</code> :</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /etc/kubernetes/manifests/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -E <span class="string">&#x27;apiserver.(crt|key)&#x27;</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line">    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span><br><span class="line">    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sed -ri -e <span class="string">&#x27;s#/apiserver.crt#/apiserver2.pem#&#x27;</span> -e <span class="string">&#x27;s#/apiserver.key#/apiserver2-key.pem#&#x27;</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -E -- <span class="string">&#x27;--tls-(cert|private)&#x27;</span> /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line">    - --tls-cert-file=/etc/kubernetes/pki/apiserver2.pem</span><br><span class="line">    - --tls-private-key-file=/etc/kubernetes/pki/apiserver2-key.pem</span><br></pre></td></tr></table></figure><p>ç„¶åç”¨ä¸Šé¢çš„ santest åŸŸåæµ‹è¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl --server https://santest:6443 get pod</span><br><span class="line">No resources found in default namespace.</span><br><span class="line">$ kubectl --server https://santest:6443 get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   1h</span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ¡ˆä¾‹"><a href="#æ•…éšœæ¡ˆä¾‹" class="headerlink" title="æ•…éšœæ¡ˆä¾‹"></a>æ•…éšœæ¡ˆä¾‹</h2><h3 id="kubectl-è¯ä¹¦è¿‡æœŸ"><a href="#kubectl-è¯ä¹¦è¿‡æœŸ" class="headerlink" title="kubectl è¯ä¹¦è¿‡æœŸ"></a>kubectl è¯ä¹¦è¿‡æœŸ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f /tmp/test-svc.yml</span></span><br><span class="line">... x509: certificate has exprired or is not yet valid: current time 2025-05-20T23:25:51+08:00 is after 2025-01-16T02:16:34Z</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ kubeconfig å†…åµŒçš„è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> &lt;(kubectl config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d ) -noout -enddate</span></span><br><span class="line">notAfter=Jan 16 02:16:34 2025 GMT</span><br></pre></td></tr></table></figure><p>è€Œ <code>admin.pem</code> çœ‹ç°åœºé‡æ–°ç­¾ç½²äº†ä¸‹ï¼Œæ—¶é—´æ²¡è¿‡æœŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> admin.pem -noout -dates</span></span><br><span class="line">notBefore=Jan 17 03:05:00 2024 GMT</span><br><span class="line">notAfter=Dec 24 03:05:00 2123 GMT</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å†…åµŒä¸‹è¯ä¹¦ç”Ÿæˆæ–°çš„ kubeconfig å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æˆ‘ä»¬è¯ä¹¦åç¼€å’Œæ–‡ä»¶è·¯å¾„ä¸ä¸€æ ·ï¼Œä¸è¦ç…§æŠ„ï¼Œ<span class="built_in">env</span> å’Œå‘½ä»¤è¡ŒæŒ‡å®šç”Ÿæˆçš„ kubeconfig å‡ä¸€æ ·</span></span><br><span class="line">cd /etc/kubernetes/cluster1/ssl</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">        kubectl config set-cluster kubernetes \</span><br><span class="line">        --certificate-authority=ca.pem \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --server=https://127.0.0.1:8443</span><br><span class="line">        </span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">        kubectl config set-credentials admin \</span><br><span class="line">        --client-certificate=admin.pem \</span><br><span class="line">        --embed-certs=true \</span><br><span class="line">        --client-key=admin-key.pem</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">        kubectl config set-context kubernetes \</span><br><span class="line">        --cluster=kubernetes --user=admin</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 \</span><br><span class="line">         kubectl config use-context kubernetes</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/cluster1/.kube/config2 kubectl get node</span><br></pre></td></tr></table></figure><h3 id="deploy-çš„-rs-åˆ›å»ºæŠ¥é”™è¿‡æœŸ"><a href="#deploy-çš„-rs-åˆ›å»ºæŠ¥é”™è¿‡æœŸ" class="headerlink" title="deploy çš„ rs åˆ›å»ºæŠ¥é”™è¿‡æœŸ"></a>deploy çš„ rs åˆ›å»ºæŠ¥é”™è¿‡æœŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n default describe deploy deployment-example</span><br><span class="line">Name:                   deployment-example</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Fri, 30 May 2025 15:45:03 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            &lt;none&gt;</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               2 desired | 0 updated | 0 total | 0 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:1.19-alpine</span><br><span class="line">    Port:         12343/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Progressing    False   ReplicaSetCreateError</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                 Age                From                   Message</span><br><span class="line">  ----     ------                 ----               ----                   -------</span><br><span class="line">  Warning  ReplicaSetCreateError  21s (x7 over 21s)  deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:13+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  20s (x2 over 20s)  deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:14+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  18s                deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:16+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  16s                deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:18+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  11s                deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:23+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">  Warning  ReplicaSetCreateError  0s                 deployment-controller  Failed to create new replica set &quot;deployment-example-b4f6c7989&quot;: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:06:34+08:00 is after 2024-08-28T14:45:36Z</span><br></pre></td></tr></table></figure><p>è¿™å¥—ç¯å¢ƒæ˜¯äºŒè¿›åˆ¶éƒ¨ç½²ï¼ŒReplicaSet æ˜¯ <code>kube-controller-manager</code> åˆ›å»ºçš„ï¼Œè¯¥æŠ¥é”™éœ€è¦çœ‹ kube-controller-manager æ—¥å¿—ï¼Œç„¶å k8s çš„ç®¡ç†ç»„ä»¶æ˜¯é€šè¿‡ lease å¯¹è±¡ä¿è¯åªæœ‰ä¸€ä¸ªçœŸæ­£å¤„ç†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl -n kube-system get lease</span></span><br><span class="line">NAME                      HOLDER                                                                     AGE</span><br><span class="line">kube-controller-manager   ubuntu-Standard-PC-i440FX-PIIX-1996_296a57fb-a219-4301-a0a6-62c3cd09e0f2   639d</span><br><span class="line">kube-scheduler            ubuntu-Standard-PC-i440FX-PIIX-1996_edd2caff-d647-4633-8bd5-2d9788986e1f   639d</span><br></pre></td></tr></table></figure><p>holder çš„åå­—ç”Ÿæˆè§„åˆ™å¦‚ä¸‹</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/kubernetes/kubernetes/blob/v1.29.5/cmd/kube-controller-manager/app/controllermanager.go#L256-L286</span></span><br><span class="line">id, err := os.Hostname()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add a uniquifier so that two processes on the same host don&#x27;t accidentally both become active</span></span><br><span class="line">id = id + <span class="string">&quot;_&quot;</span> + <span class="type">string</span>(uuid.NewUUID())</span><br></pre></td></tr></table></figure><p>å‘ç°æ¯å°æœºå™¨çš„ hostname ä¸€æ ·çš„ï¼Œå®Œå…¨ä¸çŸ¥é“å½“å‰æŒæœ‰ lease çš„ <code>kube-controller-manager</code> æ˜¯å“ªå°ï¼Œç®—äº†ï¼Œæ¯ä¸ªå»çœ‹æ—¥å¿—å§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xe --no-pager -u kube-controller-manager.service</span> </span><br><span class="line">-- Logs begin at Fri 2025-05-09 14:24:19 CST, end at Fri 2025-05-30 22:21:03 CST. --</span><br><span class="line">May 22 00:01:48 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[53418]: E0522 00:01:48.204891   53418 leaderelection.go:325] error retrieving resource lock kube-system/kube-controller-manager: etcdserver: leader changed</span><br><span class="line"></span><br><span class="line">May 30 22:08:57 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[22314]: E0530 22:08:57.593721   22314 deployment_controller.go:495] Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:08:57+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">May 30 22:08:57 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[22314]: I0530 22:08:57.593752   22314 deployment_controller.go:496] Dropping deployment &quot;default/deployment-example&quot; out of the queue: Get &quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:08:57+08:00 is after 2024-08-28T14:45:36Z</span><br><span class="line">May 30 22:08:57 ubuntu-Standard-PC-i440FX-PIIX-1996 kube-controller-manager[22314]: I0530 22:08:57.593824   22314 event.go:291] &quot;Event occurred&quot; object=&quot;default/deployment-example&quot; kind=&quot;Deployment&quot; apiVersion=&quot;apps/v1&quot; type=&quot;Warning&quot; reason=&quot;ReplicaSetCreateError&quot; message=&quot;Failed to create new replica set \&quot;deployment-example-b4f6c7989\&quot;: Get \&quot;https://[::1]:6443/api/v1/namespaces/default/resourcequotas\&quot;: x509: certificate has expired or is not yet valid: current time 2025-05-30T22:08:57+08:00 is after 2024-08-28T14:45:36Z&quot;</span><br></pre></td></tr></table></figure><p>ä» cmdline è·å– kubeconfig è·¯å¾„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl <span class="built_in">cat</span> kube-controller-manager.service</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/systemd/system/kube-controller-manager.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/data/kube/bin/kube-controller-manager \</span><br><span class="line">  --address=127.0.0.1 \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/cluster1/ssl/kube-controller-manager.kubeconfig \</span><br><span class="line">...</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‹æ—¶é—´</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl --kubeconfig  /etc/kubernetes/cluster1/ssl/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="language-bash">config view --raw -o jsonpath=<span class="string">&quot;&#123;.users[0][&#x27;user&#x27;][&#x27;client-certificate-data&#x27;]&#125;&quot;</span> | <span class="built_in">base64</span> -d &gt; test.pem</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openssl x509 -<span class="keyword">in</span> test.pem -noout -enddate</span></span><br><span class="line">notAfter=Aug  5 15:37:00 2123 GMT</span><br></pre></td></tr></table></figure><p>æ—¶é—´æ²¡é—®é¢˜ï¼Œç„¶åçœ‹äº†ä¸‹æ¯ä¸ª kube-controller-manager éƒ½æ²¡é—®é¢˜ï¼Œè½®æµé—´éš”é‡å¯äº†ä¸‹ <code>kube-controller-manager</code> è¿˜æ˜¯ä¸€æ ·ï¼Œç„¶åé‡å¯äº†ä¸‹ kube-apiserver æ‰å¥½ï¼Œæ„Ÿè§‰ kube-apiserver ç¼“å­˜ bugã€‚</p><h3 id="kubelet-è½®è½¬è¯ä¹¦"><a href="#kubelet-è½®è½¬è¯ä¹¦" class="headerlink" title="kubelet è½®è½¬è¯ä¹¦"></a>kubelet è½®è½¬è¯ä¹¦</h3><p>è¯ä¹¦ä½äº <code>/var/lib/kubelet</code> ï¼Œæœ‰æ—¶å€™ kubelet ä¸ä¼šè‡ªåŠ¨è½®è½¬ï¼Œè¯¥ç›®å½•å†…è¯ä¹¦å¤‡ä»½ä¸‹åé‡å¯ kubelet å³å¯ï¼Œä»¥åŠæ¨èè®¾ç½® kube-controller-manager çš„è½®è½¬è¯ä¹¦æ—¶é—´ä¹…äº›ã€‚</p><h2 id="ä¸€äº›å…¶ä»–çš„"><a href="#ä¸€äº›å…¶ä»–çš„" class="headerlink" title="ä¸€äº›å…¶ä»–çš„"></a>ä¸€äº›å…¶ä»–çš„</h2><p>ä¸å•å• k8s è¯ä¹¦ï¼Œ etcd è¯ä¹¦ä¸€æ ·ï¼Œk8s è®¿é—® etcd ç›¸å…³å¤§åŒå°å¼‚ï¼Œä¸Šé¢å®æˆ˜éƒ¨åˆ†å¦‚æœç†è§£èƒ½åŠ›ä¸è¡Œï¼Œåœ¨å…³äº <code>ca-config.json</code> çš„ usages å¯ä»¥å·æ‡’ä¸‹é¢ client å’Œ server éƒ½å†™ä¸Šäº†ï¼Œä¸€ä¸ª ca é…ç½®æ–‡ä»¶ç”¨äºæ‰€æœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;usages&quot;: [</span><br><span class="line">    &quot;signing&quot;,</span><br><span class="line">    &quot;key encipherment&quot;,</span><br><span class="line">    &quot;server auth&quot;,</span><br><span class="line">    &quot;client auth&quot;</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>ä»»ä½•å…³äºè¯ä¹¦æŠ¥é”™çš„ä¿¡æ¯å’Œæ—¥å¿—ä»”ç»†çœ‹ï¼Œè¯ä¹¦è¿‡æœŸã€ certSAN ä¸åŒ¹é…å’Œä¸æ˜¯ä¸€å¥— ca å¯¼è‡´æ ¡éªŒä¸é€šè¿‡ç­‰æ˜¯ä¸ä¸€æ ·çš„äº‹æƒ…ï¼Œä¸è¦æ— è„‘æ‰¾åˆ°å•¥è¯ä¹¦æ–‡ç« åšå®¢å°±è·Ÿç€çæ“ä½œï¼Œè¯ä¹¦æ“ä½œå‰è¦å¤‡ä»½å·²æœ‰è¯ä¹¦ï¼Œäº§ç”Ÿ kubeconfig æ–‡ä»¶çš„æ—¶å€™ï¼Œè¦ä½¿ç”¨ kubectl æŒ‡å®šæ–°è·¯å¾„ç”Ÿæˆï¼Œä¸è¦åŠ¨è€çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åŒäº‹é‡åˆ°å‡ èµ·è¯ä¹¦ç›¸å…³é—®é¢˜ï¼Œä»å°ç™½è§’åº¦æ¥å†™ä¸‹ k8s è¯ä¹¦â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="ssl" scheme="http://zhangguanzhang.github.io/tags/ssl/"/>
    
  </entry>
  
  <entry>
    <title>å¼€å‘ä¸€ä¸ªè®©æŒ‡å®šåº”ç”¨èµ°ä»£ç†çš„å®‰å“ app è¿‡ç¨‹</title>
    <link href="http://zhangguanzhang.github.io/2025/04/27/android-tun2sock/"/>
    <id>http://zhangguanzhang.github.io/2025/04/27/android-tun2sock/</id>
    <published>2025-04-27T20:40:30.000Z</published>
    <updated>2025-04-27T20:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å¼€å‘ä¸€ä¸ªè®©æŒ‡å®š app èµ° http ä»£ç†çš„ç»è¿‡â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æƒ³å¯¹ç½‘ç»œåšä¸€äº›éªŒè¯ï¼Œåˆæ­¥æƒ³æ³•æ˜¯æ‰¾ä¸‹ golang socks5 ä»£ç† server ä¸Šå¯¹æ¯ä¸ª conn çš„å­—èŠ‚æµååºåˆ—åŒ–ååšåŠ¨ä½œï¼Œç„¶åå‘ç°å¦‚æœè®¾å¤‡å¤šäº†çš„è¯ï¼Œæ²¡æœ‰ä»£ç†æ± åŸºæœ¬æº IP å°±æ˜¯ä¸€ä¸ªäº†ï¼Œæ‰€ä»¥æƒ³ç€æ‰‹æœºç«¯ä¸Šæœ‰æ²¡æœ‰é root ä¸‹è®©æŒ‡å®š app èµ°ä»£ç†çš„ä»£ç†è½¯ä»¶ã€‚</p><p>ç„¶åæƒ³èµ·äº† <code>v2rxxNG</code> é‡Œå¯ä»¥æŒ‡å®š app èµ°ä»£ç†ï¼Œäºæ˜¯ç ”ç©¶æŠ˜è…¾äº†ä¸€ç•ªåˆ°å­¦ä¹  kotlin å’Œå®‰å“ compose è‡ªå·±å¼€å‘å®‰å“ appã€‚</p><h2 id="åº•å±‚æ¢è®¨ç»è¿‡"><a href="#åº•å±‚æ¢è®¨ç»è¿‡" class="headerlink" title="åº•å±‚æ¢è®¨ç»è¿‡"></a>åº•å±‚æ¢è®¨ç»è¿‡</h2><p>å…ˆå¤§è‡´çœ‹äº†ä¸‹ <code>v2rxxNG</code> çš„ä»£ç ï¼Œå‘ç°ç”¨çš„ <code>tun2socks</code> æŠ€æœ¯ï¼Œä¸»è¦æ˜¯ tun æ¥å£ï¼Œä¹Ÿå°±æ˜¯ Linux çš„ tun æŠ€æœ¯ã€‚</p><h3 id="Tun"><a href="#Tun" class="headerlink" title="Tun"></a>Tun</h3><p>åœ¨ Linux é‡Œä¸€åˆ‡çš†æ–‡ä»¶ï¼ŒTap&#x2F;Tun æ˜¯ Linux æä¾›çš„ç”¨æˆ·æ€å°è£…æŠ¥æ–‡çš„æ¥å£ï¼ŒTap æ˜¯æ•°æ®é“¾è·¯å±‚äºŒå±‚ï¼ŒTun æ˜¯ç½‘ç»œ IP å±‚ä¸‰å±‚ï¼ŒTun ä¸€ç«¯è¿ç€å†…æ ¸çš„åè®®æ ˆï¼Œå¦ä¸€ç«¯è¿ç€ç”¨æˆ·æ€çš„è¿›ç¨‹ã€‚ä½¿ç”¨æµç¨‹æ˜¯ï¼š</p><ol><li>ç¨‹åºä½¿ç”¨ç°æœ‰æˆ–è€…åˆ›å»ºçš„è™šæ‹Ÿç½‘å¡ï¼ˆTap&#x2F;Tunï¼‰</li><li>ç¨‹åºéœ€è¦å¯¹æ”¶å’Œå‘çš„æŠ¥æ–‡è¿›è¡Œå¤„ç†ï¼ˆä¹Ÿå°±æ˜¯è¯»å†™ &#x2F;dev&#x2F;net&#x2F;tun å­—ç¬¦è®¾å¤‡ï¼‰ï¼Œç¨‹åºçš„é€»è¾‘å°±åƒç‰©ç†ç½‘å¡çš„ç¡¬ä»¶åŠŸèƒ½ä¸€æ ·</li></ol><p>è¯¦ç»†æµç¨‹è§<a href="https://www.junmajinlong.com/virtual/network/all_about_tun_tap/">ç†è§£Linuxè™šæ‹Ÿç½‘å¡è®¾å¤‡tun&#x2F;tapçš„ä¸€åˆ‡</a>ï¼Œä¸æå•¥è™šæ‹Ÿäº¤æ¢æœºï¼Œè€Œæ˜¯å¸¸è§„åšè½¯ä»¶ä»£ç†éš§é“å•¥çš„ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ Tunã€‚</p><p>ä¾‹å¦‚ linux æœºå™¨ä½¿ç”¨ socks5 tun æ¨¡å¼ä»£ç†ï¼š</p><ul><li>èµ°è·¯ç”±æˆ–è€… iptables fmark åŒ¹é…åˆ°å‘å¾€ tun ç½‘å¡</li><li>Linux åè®®æ ˆä¼šæŠŠ TCP&#x2F;IP æŠ¥æ–‡å‘åˆ°ç”¨æˆ·æ€ç¨‹åºçš„ socks5 client</li><li>client ç¨‹åºè§£æ IP å±‚çš„æ•°æ®ï¼Œå°è£…æˆ socks5 åè®®çš„åŒ…å‘å‡ºå»</li><li>åè®®æ ˆæ”¶åˆ°åå‘å¾€ç‰©ç†ç½‘å¡ï¼Œç‰©ç†ç½‘å¡å‘å‡ºå»</li><li>socks5 server ç«¯æ”¶åˆ°æŠ¥æ–‡ï¼Œè§£æåï¼Œæœ¬æœºå‘å¾€ç›®æ ‡åœ°å€</li></ul><p>è¿™æ ·ç›®æ ‡åœ°å€çœ‹åˆ°å°±æ˜¯ socks5 server çš„ IP è¯·æ±‚çš„è‡ªå·±äº†ï¼Œå’Œ socks5 æ— å…³ï¼Œä»£ç†éš§é“å•¥çš„åŸºæœ¬éƒ½æ˜¯è¿™æ ·çš„å·¥ä½œåŸç†ã€‚</p><p>æ›´è¯¦ç»†çš„å›¾æ–‡è§ï¼š</p><ul><li><a href="https://www.junmajinlong.com/virtual/network/data_flow_about_openvpn/">https://www.junmajinlong.com/virtual/network/data_flow_about_openvpn/</a></li><li><a href="https://www.zhaohuabing.com/post/2020-02-24-linux-taptun/">https://www.zhaohuabing.com/post/2020-02-24-linux-taptun/</a></li></ul><h3 id="å®‰å“å’Œ-Tun"><a href="#å®‰å“å’Œ-Tun" class="headerlink" title="å®‰å“å’Œ Tun"></a>å®‰å“å’Œ Tun</h3><p><a href="https://github.com/2dust/v2rayNG/blob/master/V2rayNG/app/src/main/java/com/v2ray/ang/service/V2RayVpnService.kt">v2rxxNG</a> æ˜¯æŠŠ <code>badvxn</code> ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¾åœ¨ libs ä¸‹å‘½åä¸º <code>libtun2socks.so</code>ï¼Œè¿™æ · Android åœ¨å®‰è£… app çš„æ—¶å€™ä¼šè‡ªåŠ¨ç»™ <code>.so</code> åç¼€çš„æ–‡ä»¶ <code>+rx</code> æ‰§è¡Œæƒé™ï¼Œåœ¨æ²¡æœ‰ root çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºæ˜¯æ— æ³•ç»™ä¸€ä¸ªæ–‡ä»¶å¢åŠ  x æƒé™çš„ï¼Œè¿™ä¹Ÿç®—æ˜¯ä¸€ä¸ªéªšæ“ä½œã€‚</p><p>ç„¶ååœ¨å®‰å“å¼€å‘çš„æ—¶å€™ï¼Œå®‰å“æä¾›äº†æ¥å£ï¼Œéœ€è¦ç»§æ‰¿ <a href="https://developer.android.com/reference/kotlin/android/net/VpnService">VxnService</a> ï¼Œåœ¨å…¶ç±»çš„å†…éƒ¨ä½¿ç”¨ <code>Builder()</code> åˆ›å»º tunï¼Œåªä¸è¿‡å®‰å“ä¸Šä¸å†æ˜¯ <code>/dev/net/tun</code> è€Œæ˜¯æ–‡ä»¶æè¿°ç¬¦äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ParcelFileDescriptor tunDevice = new Builder()</span><br><span class="line">    .addAddress(VXN_ADDRESS, 32)</span><br><span class="line">    .addRoute(VXN_ROUTE, 0)</span><br><span class="line">    .addDnsServer(VXN_DNS)</span><br><span class="line">    .addAllowedApplication(&quot;com.google.android.tethering&quot;)</span><br><span class="line">    .addAllowedApplication(&quot;com.google.android.tethering2&quot;)</span><br><span class="line">    .establish();</span><br><span class="line"></span><br><span class="line">fd = tunDevice.getFd()</span><br></pre></td></tr></table></figure><p>ç„¶å <code>libtun2socks</code> ä½¿ç”¨è¿™ä¸ª fd è¿è¡Œï¼Œ<code>badvxn</code> æ˜¯åŸºäº <code>LwIP</code> ä¿®æ”¹çš„å®ç°ï¼Œc è¯­è¨€åŸºæœ¬éƒ½å¿˜å…‰äº†ï¼Œæ‰¾äº†ä¸‹ golang çš„å®ç°çœ‹çœ‹ï¼Œæ‰¾åˆ°äº† <code>https://github.com/xjasonlyu/tun2socks</code> ï¼Œä¸ºå•¥é€‰å®ƒæ˜¯åº”ä¸ºå®ƒå†…ç½®äº†å¥½å‡ ä¸ªæ¨¡å¼ï¼Œä¾‹å¦‚ direct ï¼Œä¿®æ”¹èµ·æ¥åº”è¯¥æ¯”è¾ƒç®€å•ï¼ˆè¿™é‡Œæˆ‘ä¸å»è¿½æ±‚æ€§èƒ½æé™ï¼Œä»¥éœ€æ±‚ä¼˜å…ˆè€Œé€‰å‹ï¼‰ã€‚</p><h2 id="å®‰å“å¼€å‘"><a href="#å®‰å“å¼€å‘" class="headerlink" title="å®‰å“å¼€å‘"></a>å®‰å“å¼€å‘</h2><p>æœäº†ä¸‹ç›¸å…³æ²¡æœ‰æœåˆ°ç°æœ‰çš„è½®å­ï¼Œå”¯ä¸€ä¸€ä¸ªæ¯”è¾ƒæ¥è¿‘æˆ‘éœ€æ±‚çš„ <a href="https://github.com/ys1231/appproxy/tree/iyue">appproxy</a> æ˜¯ flutter å†™çš„ï¼Œå¹¶ä¸”ä»£ç†ç±»å‹åªæœ‰ http å’Œ socks5ï¼Œæ²¡åŠæ³•ï¼Œå°±å»å­¦ä¹ äº†ä¸‹ kotlin å’Œå®‰å“å¼€å‘ã€‚</p><h3 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h3><p>2025å¹´ï¼Œæè¿™ç§ç¨å¾®åå‘åº•å±‚çš„å¯¹æ¥çš„ï¼Œå½“ç„¶æ˜¯å­¦ä¹  kotlin æå®‰å“å¼€å‘äº†ï¼Œä¹‹å‰çœ‹åˆ°çš„ <a href="https://kotlin.liying-cn.net/home.html">kotlin ä¸­æ–‡ç¿»è¯‘æ–‡æ¡£</a> çœ‹äº†ä¸‹æ„Ÿè§‰ä»å­¦ä¹ è·¯çº¿æ¥çœ‹å¥½çç¢ï¼Œå®‰å“å®˜æ–¹å¼€å‘æ–‡æ¡£é¡µé¢åˆå¯¹ kotlin ä»‹ç»å¾ˆå°‘ï¼Œéƒ½æ˜¯è¯¾ç¨‹é‡Œç©¿æ’ç€åŸºç¡€çŸ¥è¯†ã€‚å®Œæ•´ä½“ç³»çš„è¿˜æ˜¯è¦ä»äº’è”ç½‘ä¸Šæ‰¾ä¸‹çœ‹çœ‹ï¼Œä¸‹é¢çš„ gist æ˜¯æ”¶è—çš„ä¸€äº›ï¼ŒåŸºæœ¬éƒ½çœ‹è¿‡çš„ï¼š</p><p><a href="https://gist.github.com/zhangguanzhang/cd2f3eb20de5a1314e5d3802401aa192">https://gist.github.com/zhangguanzhang/cd2f3eb20de5a1314e5d3802401aa192</a></p><p>å…ˆå­¦ kotlinï¼Œå†å»çœ‹å®‰å“å®˜æ–¹çš„æ•™ç¨‹ï¼Œå®‰å“å®˜æ–¹æ–‡æ¡£æ˜¯å®æˆ˜å¸¦ä½ å…¥é—¨å®‰å“å¼€å‘ï¼Œç›¸å¯¹äºå®Œæ•´å®‰å“å¼€å‘ä½“ç³»æ¥è¯´è¿˜æ˜¯ç¼ºå°‘å¾ˆå¤šå†…å®¹ï¼Œä¾‹å¦‚ Serviceã€Intent å’Œ Flow å•¥çš„è®²è§£å¾ˆå°‘æˆ–è€…åŸºæœ¬æ²¡è®²ã€‚</p><h3 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>ä¸»è¦éœ€æ±‚ä¸ºå¦‚ä¸‹ï¼š</p><ul><li>æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ä»£ç†é…ç½®</li><li>é€šçŸ¥æ çš„å‰å°è¿è¡Œé€šçŸ¥</li><li>å³ä¸‹è§’çš„æµ®åŠ¨å¼€å…³</li><li>tun2socks å¯¹æ¥å¯åŠ¨</li><li>app é€‰æ‹©ç•Œé¢é€‰æ‹©å“ªäº› app èµ°ä»£ç†</li></ul><p>å¿«é€Ÿçœ‹å®Œå®˜æ–¹æ–‡æ¡£çš„ compose å¼€å‘åï¼ŒåŸºäº <a href="https://github.com/google-developer-training/basic-android-kotlin-compose-training-inventory-app">inventory-app</a> å¤åˆ¶ä¿®æ”¹å¼€å§‹ï¼Œå„ä¸ªç•Œé¢è·³è½¬ç”¨ navigate ï¼Œå¦å¤–è¿˜å‘ç° <a href="https://github.com/tailscale/tailscale-android/tree/main/android">tailscale-android</a> ä¹Ÿæ˜¯å…¨éƒ¨ç”¨ kotlin + jetpack compose å¼€å‘çš„ï¼Œå¯ä»¥ä»é‡Œé¢å­¦ä¸‹ä»£ç ã€‚</p><h3 id="tun2socks-aar"><a href="#tun2socks-aar" class="headerlink" title="tun2socks aar"></a>tun2socks aar</h3><p>æ ¹æ®æ–‡æ¡£ tun2socks çš„ <a href="https://github.com/xjasonlyu/tun2socks/issues/123">How to use file descriptor in Android</a> å¾—çŸ¥ï¼Œé›†æˆåˆ°å®‰å“æ˜¯è¦åˆ©ç”¨ gomobile ç¼–è¯‘å‡ºå®‰å“çš„ aar åä»£ç é‡ŒåŠ è½½ï¼ˆè€Œä¸æ˜¯ <code>v2rxxNG</code> é‚£æ ·è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€‚å…ˆç¼–è¯‘å‡ºæ¥åå†™ä¸ªæœ€å° demo è¯•è¯•çœ‹ï¼Œéœ€è¦ NDK å’Œ SDK_TOOLS å’Œ golangï¼Œæœç´¢äº†ä¸‹ååˆ¶ä½œäº†ä¸€ä¸ªå¸¦ç¯å¢ƒçš„ docker é•œåƒï¼Œç›´æ¥ä¸‹é¢æ­¥éª¤å¿«é€Ÿç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/xjasonlyu/tun2socks</span><br><span class="line"><span class="built_in">cd</span> tun2socks</span><br><span class="line"><span class="comment"># ä¸è¦åœ¨ä½é…ç½®æœºå™¨ä¸Šç¼–è¯‘ï¼Œä¼šå¡æ­»æœºå™¨</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -ti \</span><br><span class="line"> -e GOPROXY=<span class="string">&#x27;https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,https://proxy.golang.com.cn,direct&#x27;</span> \</span><br><span class="line">  --entrypoint bash -v <span class="variable">$PWD</span>:/w -w /w registry.aliyuncs.com/zhangguanzhang/gomobile</span><br><span class="line">go get golang.org/x/mobile/bind</span><br><span class="line"><span class="built_in">mkdir</span> -p build</span><br><span class="line"><span class="comment">#  ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›go build å‚æ•° è¿™é‡Œæˆ‘æŒ‡å®š-androidapi 24æœ€ä½å…¼å®¹å®‰å“7ï¼Œé»˜è®¤å€¼æ˜¯16ï¼Œä½†æ˜¯è¾ƒæ–°çš„ NDK ä¸Šæ— æ³•ç¼–è¯‘ï¼Œ 23.1.7779620 å¯ä»¥ç¼–è¯‘</span></span><br><span class="line">gomobile <span class="built_in">bind</span> -ldflags=<span class="string">&quot;-s -w&quot;</span> -trimpath -o build/tun2socks.aar \</span><br><span class="line">-target android \</span><br><span class="line">-androidapi 24 \</span><br><span class="line">github.com/xjasonlyu/tun2socks/v2/engine</span><br><span class="line">$ <span class="built_in">ls</span> -l build/</span><br><span class="line">total 30580</span><br><span class="line">-rw-r--r-- 1 root root 31304576 Apr 27 11:50 tun2socks.aar</span><br><span class="line">-rw-r--r-- 1 root root     6927 Apr 27 11:50 tun2socks-sources.jar</span><br></pre></td></tr></table></figure><p>issue é‡ŒåŸºæœ¬éƒ½æ˜¯ java å¼€å‘çš„ï¼Œæˆ‘è¿™é‡Œæ˜¯ kotlin å’Œæœ€æ–°ç‰ˆæœ¬çš„ <code>Android Studio</code>ï¼Œæœ€æ–°çš„ç‰ˆæœ¬é‡Œï¼Œéƒ½æ˜¯ç”¨ kotlin çš„ DSL gradle äº†ï¼ŒæŒ‰ç…§ issue é‡Œçš„æ·»åŠ ååœ¨ <code>Android Studio</code> é‡Œä¸€ç›´æŠ¥çº¢ï¼Œç„¶åæœç´¢åä¸‹é¢çš„æ‰è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># app ä¸‹çš„ buid.grade.kts çš„ ä¾èµ–ä¸‹æ·»åŠ </span><br><span class="line">implementation(files(&quot;libs/tun2socks.aar&quot;))</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢çš„ aar æ–‡ä»¶æ”¾ <code>app/libs/</code> ä¸‹å³å¯ï¼Œä½¿ç”¨å’Œ issue é‡Œä¸€æ ·ã€‚</p><p>gomobile ä¸€äº›å®è·µå‚è€ƒ:</p><ul><li><a href="https://mbox.dev/dev/go/go-mobile/03/">GoMobile 3: åœ¨ iOS &amp; Android ä¸Šçš„é›†æˆ</a></li><li><a href="https://apkdv.com/creating-android-ios-cross-platform-libraries-with-gomobile.html">ä½¿ç”¨ GoMobile åˆ›å»º Androidã€iOS è·¨å¹³å° WebSocket Library</a></li></ul><h3 id="å‰å°"><a href="#å‰å°" class="headerlink" title="å‰å°"></a>å‰å°</h3><p>å®˜æ–¹çš„ demo <a href="https://android.googlesource.com/platform/development/+/master/samples/ToyVpn">Toy</a> éå¸¸è€ï¼Œè€Œä¸”æ˜¯ java çš„ï¼Œè¿™é‡Œæ˜¯æˆ‘æ‰¾çš„å®˜æ–¹æ–‡æ¡£å’Œä¸€äº›å‚è€ƒä»£ç ï¼š</p><ul><li><a href="https://developer.android.com/develop/background-work/services/fgs?hl=zh-cn">å‰å°æœåŠ¡</a></li><li><a href="https://github.com/satishnada/android-vpn-implementation-guide/blob/master/app/src/main/java/com/satish/vpnguide/service/LocalVpnService.kt">android-vxn-implementation-guide</a></li><li><a href="https://github.com/microsoft/HydraLab/blob/main/android_client/app/src/main/java/com/microsoft/hydralab/android/client/vpn/HydraLabVpnService.kt">https://github.com/microsoft/HydraLab/blob/main/android_client/app/src/main/java/com/microsoft/hydralab/android/client/vpn/HydraLabVpnService.kt</a></li></ul><p>å‰å°æœåŠ¡è¿è¡Œéœ€è¦ <code>Notification</code> ï¼Œå‚è€ƒä¸‹åˆ«äººä»£ç å <code>Android Studio</code> æ¨¡æ‹Ÿå™¨é‡ŒçŠ¶æ€æ å‰å°éœ€è¦çš„é€šçŸ¥å‡ºä¸æ¥ï¼Œåœ¨çœŸæœºå®‰å“ 11 è¯•äº†ä¸‹æ²¡é—®é¢˜ï¼Œå‘ç°æ¨¡æ‹Ÿå™¨çš„å®‰å“ç‰ˆæœ¬å¤ªé«˜äº†ï¼Œè°·æ­Œäº†ä¸‹éœ€è¦åŠ ä¸‹é¢ä»£ç ç”³è¯·ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresApi(Build.VERSION_CODES.TIRAMISU)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">checkNotificationPermission</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> permission = android.Manifest.permission.POST_NOTIFICATIONS</span><br><span class="line">    <span class="keyword">when</span> &#123;</span><br><span class="line">        ContextCompat.checkSelfPermission(</span><br><span class="line">            <span class="keyword">this</span>,</span><br><span class="line">            permission</span><br><span class="line">        ) == PackageManager.PERMISSION_GRANTED -&gt; &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        shouldShowRequestPermissionRationale(permission) -&gt; &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">            requestNotificationPermission.launch(permission)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> requestNotificationPermission =</span><br><span class="line">    registerForActivityResult(ActivityResultContracts.RequestPermission()) &#123; isGranted -&gt;</span><br><span class="line">        <span class="keyword">if</span> (isGranted) Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;é€šçŸ¥æƒé™å·²æˆäºˆ&quot;</span>, Toast.LENGTH_SHORT)</span><br><span class="line">            .show()</span><br><span class="line">        <span class="keyword">else</span> Toast.makeText(<span class="keyword">this</span>, <span class="string">&quot;é€šçŸ¥æƒé™è¢«æ‹’ç»&quot;</span>, Toast.LENGTH_SHORT)</span><br><span class="line">            .show()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨ä»£ç†é—ªé€€ï¼Œå‘ç°æ²¡æœ‰åƒä»¥å‰ç”¨çš„ app é‚£æ ·å¼¹çª—å£å’Œé’¥åŒ™ï¼Œå°±æ˜¯è¯´è¯¥ app ç”³è¯· <code>vpn</code> æ¥å£ï¼Œä¼šå¯¹å•¥å•¥çš„ï¼Œéœ€è¦è°ƒç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VpnService.prepare(this)</span><br></pre></td></tr></table></figure><h3 id="ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜"><a href="#ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜" class="headerlink" title="ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜"></a>ä¸€äº›å…¶ä»–ç»†èŠ‚é—®é¢˜</h3><p>å¯åŠ¨åï¼Œåˆ‡å‡ºå»ï¼Œå†ä»é€šçŸ¥æ è¿›æ¥ï¼Œå‘ç°æµ®åŠ¨æŒ‰é’®çŠ¶æ€å’Œå®é™…ä¸ä¸€è‡´ï¼Œæœ€åè¿˜æ˜¯æŒ‰ç…§ Binder å’Œ Service é€šä¿¡æ‰è¡Œï¼Œä»¥åŠ <code>Broadcast</code> è®©æŒ‰é’®çŠ¶æ€å’Œå®é™…ä¸€è‡´ã€‚<br>å®Œæ•´ä»£ç åœ¨ <a href="https://github.com/zhangguanzhang/appproxy">appproxy</a></p><p>æ‰“åŒ…å‘ç»™å…¶ä»–äººï¼Œå‘ç°å®‰è£…ä¸ä¸Šï¼Œæœ€åå‘ç°æ˜¯ç­¾åé—®é¢˜ï¼Œæ²¡ç­¾åå®‰è£…ä¸äº†ï¼Œå·æ‡’å¯ä»¥æš‚æ—¶ <code>Build -&gt; Generate App Bundles or APKs -&gt; Generate APKs</code> å¼¹å‡ºçš„ç‚¹ locate é‡Œã€‚è¿˜å¯ä»¥åˆ†æ¶æ„æ‰“éä¸€ä½“åŒ…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">splits &#123;</span><br><span class="line">    abi &#123;</span><br><span class="line">        isEnable = true</span><br><span class="line">        reset()</span><br><span class="line">        include(&quot;armeabi-v7a&quot;, &quot;arm64-v8a&quot;, &quot;x86_64&quot;)</span><br><span class="line">        isUniversalApk = false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>app å¼€å‘å®Œæˆåï¼Œåç»­å°±æ˜¯ fork tun2socks å¤åˆ¶ direct ååœ¨ conn å¯¹æµè§£æå’Œä¿®æ”¹å‘é€ ï¼Œå½“ç„¶å¯ä»¥å¤©é©¬è¡Œç©ºä¸‹ä¸è¦å±€é™åœ¨ä»£ç†å±‚é¢ï¼Œä¾‹å¦‚ç”¨æˆ·æ€ kotlin ç›´æ¥å¯¹ fd çš„æµè½¬å‘ä¸‹åªç»Ÿè®¡è®¿é—® ipï¼Œå°±å¯ä»¥åšä¸€ä¸ªç®€å•çš„ç½‘ç»œè®¿é—®ç»Ÿè®¡äº†ã€‚</p><p>tun2socks å¥½å¤šå…¨å±€å˜é‡å’Œ init é‡Œåšæ“ä½œï¼Œè¿™é‡Œè®°å½•ä¸‹æ¢³ç†çš„ä¸€äº›å¯åŠ¨æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. main.go é‡Œçš„ engine.Start()</span><br><span class="line">2. engine/engine.go é‡Œçš„ start()</span><br><span class="line">3. engine/engine.go é‡Œçš„ netstack() å†…çš„ `tunnel.T().SetDialer(_defaultProxy)`</span><br><span class="line">4. ä¸Šé¢ import äº† tunnel æ‰§è¡Œäº† tunnel/global.go å†…çš„ init() çš„ T().ProcessAsync()</span><br><span class="line">5. go t.process(ctx)</span><br><span class="line">func (t *Tunnel) process(ctx context.Context) &#123;</span><br><span class="line">for &#123;</span><br><span class="line">select &#123;</span><br><span class="line">case conn := &lt;-t.tcpQueue:</span><br><span class="line">go t.handleTCPConn(conn)</span><br><span class="line">case conn := &lt;-t.udpQueue:</span><br><span class="line">go t.handleUDPConn(conn)</span><br><span class="line">case &lt;-ctx.Done():</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæ˜¯ aar å¼•ç”¨ï¼Œå…¥å£æ˜¯ <code>engine/engine.go</code> å†…çš„ <code>engine.Start()</code> æ–¹æ³•ï¼Œå¯¹äºæ—¥å¿—ï¼Œå¦‚æœæœ‰æ‰“å°åˆ°æ–‡ä»¶çš„éœ€æ±‚çš„è¦åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œä¿®æ”¹ï¼Œç”±äºé»˜è®¤ <code>cwd</code> æ˜¯ <code>/</code> ä¼šæŠ¥é”™åªè¯»ï¼Œæ¨èç»™ Key æ·»åŠ  <code>Dir</code> å‚æ•°åœ¨ <code>engine/engine.go</code> é‡Œï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">general</span><span class="params">(k *Key)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">level, err := log.ParseLevel(k.LogLevel)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filename := path.Join(_defaultKey.Dir, <span class="string">&quot;tun2socks.log&quot;</span>)</span><br><span class="line">cfg := zap.NewProductionConfig()</span><br><span class="line">cfg.OutputPaths = []<span class="type">string</span>&#123;filename&#125;</span><br><span class="line">cfg.Level.SetLevel(level)</span><br><span class="line">log.SetLogger(zap.Must(cfg.Build()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// log.SetLogger(log.Must(log.NewLeveled(level)))</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ service é‡Œç»™ <code>key.dir</code> ä¼ é€’ <code>getExternalFilesDir(null)?.absolutePath</code>ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/storage/emulated/0/Android/data/&lt;package_name&gt;/files/</span><br></pre></td></tr></table></figure><p>è¿™æ · engine æ—¥å¿—å°±å¯ä»¥æ‰“å°åœ¨ä¸Šé¢ç›®å½•å†…ï¼Œå¦å¤–å¯¹äº tcp é“¾æ¥ï¼Œæ ¸å¿ƒå°±æ˜¯è¿™å—ä»£ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Tunnel)</span></span> handleTCPConn(originConn adapter.TCPConn) &#123;</span><br><span class="line"><span class="keyword">defer</span> originConn.Close()</span><br><span class="line"></span><br><span class="line">id := originConn.ID()</span><br><span class="line">metadata := &amp;M.Metadata&#123;</span><br><span class="line">Network: M.TCP,</span><br><span class="line">SrcIP:   parseTCPIPAddress(id.RemoteAddress),</span><br><span class="line">SrcPort: id.RemotePort,</span><br><span class="line">DstIP:   parseTCPIPAddress(id.LocalAddress),</span><br><span class="line">DstPort: id.LocalPort,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), tcpConnectTimeout)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">remoteConn, err := t.Dialer().DialContext(ctx, metadata)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Warnf(<span class="string">&quot;[TCP] dial %s: %v&quot;</span>, metadata.DestinationAddress(), err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">metadata.MidIP, metadata.MidPort = parseNetAddr(remoteConn.LocalAddr())</span><br><span class="line"></span><br><span class="line">remoteConn = statistic.NewTCPTracker(remoteConn, metadata, t.manager)</span><br><span class="line"><span class="keyword">defer</span> remoteConn.Close()</span><br><span class="line"></span><br><span class="line">log.Infof(<span class="string">&quot;[TCP] %s &lt;-&gt; %s&quot;</span>, metadata.SourceAddress(), metadata.DestinationAddress())</span><br><span class="line">pipe(originConn, remoteConn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼Œå®¢æˆ·ç«¯å‘èµ·è¿æ¥åˆ° tun2socksï¼Œç„¶å tun2socks <code>t.Dialer().DialContext(ctx, metadata)</code> è¿æ¥ç›®æ ‡åœ°å€ï¼Œç„¶å pipe ä¸¤ä¸ª conn</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä¹Ÿå¯ä»¥å»çœ‹çœ‹ core/tcp.go</span><br><span class="line">client ----originConn----&gt; tun2socks -----remoteConn----&gt; server</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦ tun2socks ä¸»åŠ¨ç»™ client å›åŒ…ï¼Œéœ€è¦æŠŠ remoteConn ä¼ é€’è¿‡å»ï¼ŒåŒæ—¶åœ¨ <code>t.Dialer().DialContext</code> å†…äº§ç”Ÿçš„ <code>net.Conn</code> çš„ <code>Read</code> çš„ <code>[]byte</code> len å‘ç°æœ‰ç‚¹å°ï¼Œæˆ‘è‡ªå·±ç»´æŠ¤äº†ä¸ª buf åšå¤„ç†ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *mirrorStream)</span></span> Read(p []<span class="type">byte</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">tmp := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(p))</span><br><span class="line">n, err := m.rawConn.Read(tmp)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">copy</span>(p, tmp[:n])</span><br><span class="line">m.buf = <span class="built_in">append</span>(m.buf, tmp[:n]...)</span><br><span class="line">m.mirrorMessages()</span><br><span class="line"><span class="keyword">return</span> n, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://blog.csdn.net/qq_45649553/article/details/136543933">å®‰å“åŸºç¡€-applicationè¯¦è§£</a></li><li><a href="https://github.com/xjasonlyu/tun2socks/discussions/139">tun2socks è‡ªå®šä¹‰ä»£ç†</a></li><li><a href="https://ivanfan.site/2022/01/05/Android/VPN%E4%BB%A3%E7%90%86%E5%8A%A0%E9%80%9F/">ä»£ç†åŠ é€Ÿ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘å¼€å‘ä¸€ä¸ªè®©æŒ‡å®š app èµ° http ä»£ç†çš„ç»è¿‡â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="android" scheme="http://zhangguanzhang.github.io/tags/android/"/>
    
    <category term="tun2sock2" scheme="http://zhangguanzhang.github.io/tags/tun2sock2/"/>
    
  </entry>
  
  <entry>
    <title>kube-log-runner ä½¿ç”¨å’Œé€‚é… logrotate æ”¹é€ </title>
    <link href="http://zhangguanzhang.github.io/2025/04/21/kube-log-runner/"/>
    <id>http://zhangguanzhang.github.io/2025/04/21/kube-log-runner/</id>
    <published>2025-04-21T10:40:30.000Z</published>
    <updated>2025-04-21T10:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ä½¿ç”¨ kube-log-runner çš„ç»å†â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>kubelet å’Œä¸€äº› kube ç»„ä»¶åœ¨äºŒè¿›åˆ¶ systemd service ç®¡ç†ä¸‹ï¼Œæ—¥å¿—æœ€ç»ˆä¼šåœ¨ <code>/var/log/messages</code> é‡Œï¼Œæˆ‘ä»¬çš„å®¢æˆ·å¯¹è¯¥æ–‡ä»¶ä¼šæœ‰å…³é”®å­—ï¼ˆErrorã€Failed â€¦ï¼‰ç›‘æ§ï¼Œè®©æˆ‘ä»¬æŠŠç›¸å…³ç»„ä»¶æ—¥å¿—å†™åˆ°å…¶ä»–æ–‡ä»¶é‡Œå»ã€‚</p><h2 id="ç»è¿‡"><a href="#ç»è¿‡" class="headerlink" title="ç»è¿‡"></a>ç»è¿‡</h2><h3 id="é€‰å‹"><a href="#é€‰å‹" class="headerlink" title="é€‰å‹"></a>é€‰å‹</h3><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/system-logs/">ç³»ç»Ÿæ—¥å¿—</a> å¾—çŸ¥ <code>v1.26</code> å¼€å§‹ç§»é™¤äº†ä»¥å‰çš„æ—¥å¿—æ–‡ä»¶ã€ç›®å½•å’Œè½®è½¬ä¹‹ç±»çš„å‚æ•°ï¼Œè€Œæ˜¯è®©ä½¿ç”¨ <code>kube-log-runner</code> ä»£æ›¿ï¼Œè¯¥äºŒè¿›åˆ¶å·²ç»å†…ç½®åœ¨äºŒè¿›åˆ¶ä¸‹è½½å‹ç¼©åŒ…é‡Œäº†ã€‚å¦‚æœæ˜¯ä½¿ç”¨é•œåƒï¼Œå®˜æ–¹çš„å®¹å™¨é•œåƒå†…ç½®äº†ï¼Œåªæ˜¯åå­—å«åš <code>/go-runner</code>ã€‚</p><p>æ ¹æ® <a href="https://github.com/kubernetes/component-base/tree/master/logs/kube-log-runner">github kube-log-runner</a> å¾—çŸ¥ä½¿ç”¨æ–¹å¼å’Œæºç ï¼Œå®ƒå°±æ˜¯ golang å†™çš„ä¸€ä¸ªç®€å•å·¥å…·ï¼Œå¯åŠ¨å‘½ä»¤ï¼ŒæŠŠå‘½ä»¤çš„æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºæ•è·å†™åˆ°æ–‡ä»¶ï¼Œç„¶åè½¬å‘ä¿¡å·ç»™è¿›ç¨‹ã€‚</p><h3 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl cat --no-pager kube-apiserver</span><br><span class="line">...</span><br><span class="line">ExecStart=/usr/local/bin/kube-log-runner \</span><br><span class="line">  --log-file=/var/logs/kube-apiserver.log \</span><br><span class="line">  /usr/local/bin/kube-apiserver </span><br></pre></td></tr></table></figure><p>ç›´æ¥æµ‹è¯•äº†ä¸‹å‘ç°å¯åŠ¨æŠ¥é”™ä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4æœˆ 18 10:30:25 xxx systemd[1]: Got notification message from PID 9885, but reception only permitted for main PID 9880</span><br></pre></td></tr></table></figure><p>å¦‚æœå¯¹ systemd æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥ç›´æ¥çœ‹å‡ºé—®é¢˜ã€‚å› ä¸ºæˆ‘ä»¬è¿™è¾¹ç”¨çš„ <code>Type=notify</code>ï¼Œè¯¥è®¾ç½®ä¸‹ï¼ŒæœåŠ¡å¯åŠ¨åä¼šå‘é€ <code>sd_notify</code> ç»™ systemdï¼Œè¿™æ · systemd ç¡®è®¤è¯¥æœåŠ¡æ­£å¸¸å¯åŠ¨ã€‚è¿™ä¸ªæŠ¥é”™å°±æ˜¯ï¼š</p><ol><li>systemd æ‹‰èµ·çš„ä¸»è¿›ç¨‹ Pid æ˜¯ 9880</li><li>ä»éä¸»è¿›ç¨‹çš„ 9885 æ”¶åˆ°äº† notification æ¶ˆæ¯</li></ol><p>è§£å†³è¯¥é—®é¢˜å¾ˆç®€å•ï¼Œsystemd ç»™äº†é…ç½®é€‰é¡¹æ¥æ”¶æ‰€æœ‰çš„ notify ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NotifyAccess=all</span><br></pre></td></tr></table></figure><h3 id="logrotate"><a href="#logrotate" class="headerlink" title="logrotate"></a>logrotate</h3><p>æ—¥å¿—è¦å†™å…¥åˆ°æ–‡ä»¶ï¼Œé‚£å°±ä¸€å®šè¦éµå®ˆ Linux è§„èŒƒé…ç½® logrotate é¿å…æ—¥å¿—å†™æ»¡åˆ†åŒºã€‚ç„¶åç›¸å…³é…ç½®å®Œï¼Œå†™å®Œé…ç½®ç”¨ä¸€ä¸ªå°çš„ size å‚æ•°æµ‹è¯•äº† logrotate å‘ç°ä¸è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -v /etc/logrotate.d/kube-apiserver</span><br></pre></td></tr></table></figure><p>logrotate è½®è½¬æ—¥å¿—åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œcreate å’Œ copytruncateï¼Œé»˜è®¤æ˜¯ createï¼Œä¸¤ç§å¤§è‡´åŸç†å¦‚ä¸‹ï¼š</p><ul><li>createï¼šé‡å‘½åæ—¥å¿—æ–‡ä»¶ï¼Œå†åˆ›å»ºåŸæœ‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œç­‰åŒäº mv + touch</li><li>copytruncateï¼š<code>cp xx.log xx.log.1 &amp;&amp; truncate -s 0 xx.log</code></li></ul><p>Linux ä¸Šæ‰“å¼€æ–‡ä»¶åå®é™…æ˜¯æ“ä½œ inodeï¼Œæ–‡ä»¶ååœ¨æ‰“å¼€ inode åæ”¹åæˆ–è€…åˆ æ‰æ–‡ä»¶ path å¯¹è¿›ç¨‹å¹¶ä¸ä¼šæœ‰å½±å“ï¼Œcreate æ–¹å¼éœ€è¦è¿›ç¨‹æ”¯æŒ reopen æ—¥å¿—æ–‡ä»¶è·¯å¾„ä½¿ç”¨æ–°çš„ inodeï¼Œç±»ä¼¼ nginx çš„ logrotate é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/var/log/nginx/*.log /var/log/nginx/*/*.log&#123;</span><br><span class="line">daily</span><br><span class="line">missingok</span><br><span class="line">rotate 14</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">create 640 root adm</span><br><span class="line">sharedscripts</span><br><span class="line">postrotate</span><br><span class="line">[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>kube-apiserver å¹¶æ²¡æœ‰æ”¯æŒè¿™ç§è¡Œä¸ºï¼Œå°±å°è¯•äº†ä¸‹ <code>copytruncate</code> å‘ç°ä¹Ÿä¸è¡Œï¼Œç„¶åå» <a href="https://github.com/kubernetes/enhancements/issues/2845">kep çš„ kube-log-runner</a> ä¸‹å›å¤äº†ä¸‹è¯·æ±‚æ·»åŠ  logrotate æ”¯æŒã€‚</p><h3 id="ä¿®æ”¹"><a href="#ä¿®æ”¹" class="headerlink" title="ä¿®æ”¹"></a>ä¿®æ”¹</h3><p>ç­‰å®˜æ–¹ä¼°è®¡å¾ˆä¹…äº†ï¼Œå…ˆè‡ªå·±ä¿®æ”¹ä¸‹æºç æ”¯æŒä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;os/exec&quot;</span></span><br><span class="line"><span class="string">&quot;os/signal&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">logFilePath    = flag.String(<span class="string">&quot;log-file&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;If non-empty, save stdout to this file&quot;</span>)</span><br><span class="line">alsoToStdOut   = flag.Bool(<span class="string">&quot;also-stdout&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;useful with log-file, log to standard output as well as the log file&quot;</span>)</span><br><span class="line">redirectStderr = flag.Bool(<span class="string">&quot;redirect-stderr&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;treat stderr same as stdout&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å¢å…¨å±€å˜é‡</span></span><br><span class="line">logFile         *os.File</span><br><span class="line">logFileMu       sync.Mutex</span><br><span class="line">globalLogFile   <span class="type">string</span></span><br><span class="line">globalAlsoStdOut <span class="type">bool</span></span><br><span class="line">globalRedirectStderr <span class="type">bool</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SyncWriter æ”¯æŒåŠ¨æ€åˆ‡æ¢ Writer</span></span><br><span class="line"><span class="keyword">type</span> SyncWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">mu sync.Mutex</span><br><span class="line">w  io.Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sw *SyncWriter)</span></span> Write(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">sw.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> sw.mu.Unlock()</span><br><span class="line"><span class="keyword">return</span> sw.w.Write(p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sw *SyncWriter)</span></span> SetWriter(w io.Writer) &#123;</span><br><span class="line">sw.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> sw.mu.Unlock()</span><br><span class="line">sw.w = w</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">outputSync = &amp;SyncWriter&#123;w: os.Stdout&#125;</span><br><span class="line">errSync    = &amp;SyncWriter&#123;w: os.Stderr&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := configureAndRun(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configureAndRun</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// ä¿å­˜å‚æ•°åˆ°å…¨å±€å˜é‡</span></span><br><span class="line">globalLogFile = *logFilePath</span><br><span class="line">globalAlsoStdOut = *alsoToStdOut</span><br><span class="line">globalRedirectStderr = *redirectStderr</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> globalLogFile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">logFile, err = os.OpenFile(globalLogFile, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to open log file: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalAlsoStdOut &#123;</span><br><span class="line">outputSync.SetWriter(io.MultiWriter(os.Stdout, logFile))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">outputSync.SetWriter(logFile)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalRedirectStderr &#123;</span><br><span class="line">errSync.SetWriter(outputSync)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">args := flag.Args()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;not enough arguments to run&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exe := args[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">var</span> exeArgs []<span class="type">string</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">exeArgs = args[<span class="number">1</span>:]</span><br><span class="line">&#125;</span><br><span class="line">cmd := exec.Command(exe, exeArgs...)</span><br><span class="line">cmd.Stdout = outputSync</span><br><span class="line">cmd.Stderr = errStream()</span><br><span class="line"></span><br><span class="line">log.Printf(<span class="string">&quot;Running command:\n%v&quot;</span>, cmdInfo(cmd))</span><br><span class="line">err := cmd.Start()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;starting command: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡å·å¤„ç†</span></span><br><span class="line"><span class="keyword">go</span> setupSigHandler(cmd.Process)</span><br><span class="line"><span class="keyword">if</span> err := cmd.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;running command: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errStream</span><span class="params">()</span></span> io.Writer &#123;</span><br><span class="line"><span class="keyword">if</span> *redirectStderr &#123;</span><br><span class="line"><span class="keyword">return</span> outputSync</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> os.Stderr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cmdInfo</span><span class="params">(cmd *exec.Cmd)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(</span><br><span class="line"><span class="string">`Command env: (log-file=%v, also-stdout=%v, redirect-stderr=%v)</span></span><br><span class="line"><span class="string">Run from directory: %v</span></span><br><span class="line"><span class="string">Executable path: %v</span></span><br><span class="line"><span class="string">Args (comma-delimited): %v`</span>, *logFilePath, *alsoToStdOut, *redirectStderr,</span><br><span class="line">cmd.Dir, cmd.Path, strings.Join(cmd.Args, <span class="string">&quot;,&quot;</span>),</span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹åçš„ä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setupSigHandler</span><span class="params">(process *os.Process)</span></span> &#123;</span><br><span class="line">signals := []os.Signal&#123;</span><br><span class="line">syscall.SIGHUP, syscall.SIGINT,</span><br><span class="line">syscall.SIGTERM, syscall.SIGQUIT, syscall.SIGUSR1,</span><br><span class="line">&#125;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(c, signals...)</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">&quot;Now listening for signals&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> s := <span class="keyword">range</span> c &#123;</span><br><span class="line"><span class="keyword">if</span> s == syscall.SIGUSR1 &#123;</span><br><span class="line">handleLogRotate()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">forwardSignal(process, s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†æ—¥å¿—è½®è½¬</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLogRotate</span><span class="params">()</span></span> &#123;</span><br><span class="line">logFileMu.Lock()</span><br><span class="line"><span class="keyword">defer</span> logFileMu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalLogFile == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">log.Println(<span class="string">&quot;No log file configured, ignoring SIGUSR1&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­æ—§æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> logFile != <span class="literal">nil</span> &#123;</span><br><span class="line">logFile.Sync()</span><br><span class="line"><span class="keyword">if</span> err := logFile.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Error closing log file: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å¼€æ–°æ–‡ä»¶</span></span><br><span class="line">newFile, err := os.OpenFile(globalLogFile, os.O_APPEND|os.O_CREATE|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;ERROR: Failed to reopen log file: %v (logging to stdout)&quot;</span>, err)</span><br><span class="line">outputSync.SetWriter(os.Stdout)</span><br><span class="line"><span class="keyword">if</span> globalRedirectStderr &#123;</span><br><span class="line">errSync.SetWriter(os.Stdout)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logFile = newFile</span><br><span class="line">log.SetOutput(logFile)</span><br><span class="line">log.Println(<span class="string">&quot;Successfully reopened log file&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°è¾“å‡ºæµ</span></span><br><span class="line"><span class="keyword">if</span> globalAlsoStdOut &#123;</span><br><span class="line">outputSync.SetWriter(io.MultiWriter(os.Stdout, logFile))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">outputSync.SetWriter(logFile)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> globalRedirectStderr &#123;</span><br><span class="line">errSync.SetWriter(outputSync)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">forwardSignal</span><span class="params">(process *os.Process, s os.Signal)</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Forwarding signal %v to PID %v&quot;</span>, s, process.Pid)</span><br><span class="line"><span class="keyword">if</span> err := process.Signal(s); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Error forwarding signal %v: %v&quot;</span>, s, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸è½¬å‘ USR1 ä¿¡å·ç»™å¥—å¨ƒçš„è¿›ç¨‹ï¼Œè‡ªèº«å¤„ç† USR1 ä¿¡å·å°±æ˜¯ reopen æ—¥å¿—æ–‡ä»¶ã€‚ç„¶å logrotate è§¦å‘éœ€è¦ pid æ–‡ä»¶ï¼Œsystemd é‡Œå¢åŠ :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStartPost=/bin/sh -c &quot;echo $MAINPID &gt; /var/run/kube-apiserver.pid&quot;</span><br></pre></td></tr></table></figure><p>logrotate é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/var/logs/kube-apiserver.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 5</span><br><span class="line">    size 400M</span><br><span class="line">    missingok</span><br><span class="line">    compress</span><br><span class="line">    nomail</span><br><span class="line">    delaycompress</span><br><span class="line">    create</span><br><span class="line">    postrotate</span><br><span class="line">        [ ! -f /var/run/kube-apiserver.pid ] || kill -USR1 `cat /var/run/kube-apiserver.pid`</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://wsgzao.github.io/post/logrotate/">https://wsgzao.github.io/post/logrotate/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘ä½¿ç”¨ kube-log-runner çš„ç»å†â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="kube-log-runner" scheme="http://zhangguanzhang.github.io/tags/kube-log-runner/"/>
    
    <category term="logrotate" scheme="http://zhangguanzhang.github.io/tags/logrotate/"/>
    
  </entry>
  
  <entry>
    <title>é˜¿é‡Œäº‘ ecs ä¸Š etcd SSL reset</title>
    <link href="http://zhangguanzhang.github.io/2025/02/14/aliyun-ecs-ssl/"/>
    <id>http://zhangguanzhang.github.io/2025/02/14/aliyun-ecs-ssl/</id>
    <published>2025-02-14T13:40:30.000Z</published>
    <updated>2025-02-14T13:40:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>æŠ˜è…¾ä¸€äº›æ—¶é—´çš„ etcd ssl reset é—®é¢˜â€¦..</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å‡ å¹´å‰çš„ 120 å—çš„è…¾è®¯äº‘è½»é‡åº”ç”¨æœåŠ¡å™¨ä¹°äº†åå† 240 å—ç»­è´¹ä¸¤å¹´ï¼Œå¿«åˆ°æœŸäº†åé˜¿é‡Œäº‘ 90 å¿«å»ä¹°äº†ä¸€å¹´ã€‚ç„¶åä¸Šé¢æŠŠæˆ‘ä¹‹å‰çš„ etcd è¿ç§»è¿‡å»äº†ï¼Œè¯ä¹¦å½“åˆç”Ÿæˆçš„æ—¶å€™å¯ä»¥é¢„ç•™äº† cert SAN åŸŸåç›¸å…³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># openssl  x509 -in s1.pem -noout -text | grep -A1 &#x27;X509v3 Subject Alternative Name&#x27;</span><br><span class="line">            X509v3 Subject Alternative Name: </span><br><span class="line">                DNS:localhost, DNS:xxx.com, IP Address:127.0.0.1, IP Address:10.0.x.x, IP Address:10.2.0.1</span><br></pre></td></tr></table></figure><p>é¿å…å…¶ä»– etcd å®¢æˆ·ç«¯æ¢è¯ä¹¦çš„ï¼Œä¸€äº›éäº‘ä¸Šä¼šç”¨åˆ°è¯¥ etcd çš„ç›´æ¥æœ¬åœ°é…ç½® hosts xxx.com ï¼Œè¿™æ ·åç»­ ecs æ¢ ip äº†ç›´æ¥æ”¹ hosts æ–‡ä»¶å³å¯ã€‚</p><h2 id="ç»è¿‡"><a href="#ç»è¿‡" class="headerlink" title="ç»è¿‡"></a>ç»è¿‡</h2><p>è¿‡å¹´æ”¾å‡ä¹‹å‰ etcd æ•´åˆ°é˜¿é‡Œäº‘ ecs ä¸Šäº†ï¼Œç„¶åçœ‹ç€ä¹Ÿæ­£å¸¸ï¼Œåé¢çªç„¶å‡ ä¸ª agent è¿ä¸ä¸Š etcdï¼ŒåŒ…æ‹¬ curl ä¹Ÿæœ‰é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v https://xxx.com:22379 --resolve xxx.com:22379:x.x.x.x</span><br><span class="line">* Added xxx.com:22379:x.x.x.x to DNS cache</span><br><span class="line">* Hostname xxx.com was found <span class="keyword">in</span> DNS cache</span><br><span class="line">*   Trying x.x.x.x:22379...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to xxx.com (x.x.x.x) port 22379 (<span class="comment">#0)</span></span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully <span class="built_in">set</span> certificate verify locations:</span><br><span class="line">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">  CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* OpenSSL SSL_connect: SSL_ERROR_SYSCALL <span class="keyword">in</span> connection to xxx.com:22379 </span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (35) OpenSSL SSL_connect: SSL_ERROR_SYSCALL <span class="keyword">in</span> connection to xxx.com:22379</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç›´æ¥ ip å°±æ²¡é—®é¢˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ curl -v https://x.x.x.x:22379 --resolve xxx.com:22379:x.x.x.x</span><br><span class="line">* Added xxx.com:22379:x.x.x.x to DNS cache</span><br><span class="line">*   Trying x.x.x.x:22379...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* Connected to x.x.x.x (x.x.x.x) port 22379 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">  CApath: /etc/ssl/certs</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Request CERT (13):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.3 (OUT), TLS alert, unknown CA (560):</span><br><span class="line">* SSL certificate problem: unable to get local issuer certificate</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (60) SSL certificate problem: unable to get local issuer certificate</span><br><span class="line">More details here: https://curl.haxx.se/docs/sslcerts.html</span><br><span class="line"></span><br><span class="line">curl failed to verify the legitimacy of the server and therefore could not</span><br><span class="line">establish a secure connection to it. To learn more about this situation and</span><br><span class="line">how to fix it, please visit the web page mentioned above.</span><br></pre></td></tr></table></figure><p>è¿™äº›æ—¥å­æ²¡é‚£ä¹ˆå¿™äº†å°±çœ‹äº†ä¸‹ï¼Œå‘ç°å¥½å‡ ä¸ªåœ°æ–¹ç½‘ç»œè®¿é—®éƒ½è¿™æ ·ï¼Œæ ¹æ®æ’é™¤æ³•ä¸€å®šæ˜¯é˜¿é‡Œäº‘æœ‰é—®é¢˜äº†ã€‚æœäº†ä¸‹ aliyun ssl reset æœåˆ°æœç„¶æ˜¯é˜¿é‡Œäº‘æœ‰é—®é¢˜ã€‚è®¿é—®é˜¿é‡Œäº‘ ecs çš„æµé‡ä¼šå…ˆè¿›äº‘ç›¾ï¼Œä¼šæ ¹æ® SSL çš„ SNI åŸŸååšåˆ¤æ–­ï¼Œå¦‚æœæ²¡å¤‡æ¡ˆåˆ™ tcp resetã€‚æ— è¯­äº†ï¼Œæˆ‘è¿™åˆä¸æ˜¯ 80ã€8080ã€443 ç«¯å£ï¼Œæ²¡åŠæ³•æš‚æ—¶ç”¨ IP å§ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://developer.aliyun.com/article/708243">https://developer.aliyun.com/article/708243</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;æŠ˜è…¾ä¸€äº›æ—¶é—´çš„ etcd ssl reset é—®é¢˜â€¦..&lt;/p&gt;</summary>
    
    
    
    
    <category term="etcd" scheme="http://zhangguanzhang.github.io/tags/etcd/"/>
    
    <category term="ssl" scheme="http://zhangguanzhang.github.io/tags/ssl/"/>
    
    <category term="aliyun" scheme="http://zhangguanzhang.github.io/tags/aliyun/"/>
    
  </entry>
  
  <entry>
    <title>ç»™é²²é¹920å’Œä½ç‰ˆæœ¬é£è…¾ç¼–è¯‘arm64 clickhouse</title>
    <link href="http://zhangguanzhang.github.io/2025/02/13/clickhouse-arm64-v8.0-build/"/>
    <id>http://zhangguanzhang.github.io/2025/02/13/clickhouse-arm64-v8.0-build/</id>
    <published>2025-02-13T12:10:30.000Z</published>
    <updated>2025-02-13T12:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>clickhouse å®˜æ–¹ docker é•œåƒæ— æ³•åœ¨è€çš„ arm64 cpu ä¸Šè¿è¡Œï¼Œéœ€è¦ç¼–è¯‘</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ä¸šåŠ¡æ–¹æœ‰åœ¨ä½¿ç”¨ clickhouseï¼Œå½“æ—¶ç‰ˆæœ¬æ˜¯ <code>22.8.5.29</code>ï¼Œéšç€åé¢ä¹Ÿæœ‰ arm64 éœ€æ±‚ï¼Œåœ¨ arm64 æœºå™¨ä¸Šéƒ¨ç½²äº† ck åå³ä½¿æ²¡æœ‰ä¸šåŠ¡æ•°æ®å†…å­˜å ç”¨ä¹Ÿéå¸¸é«˜ï¼Œåœ¨æŒç»­åˆ·ä¸‹é¢æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__1::__function::__policy_storage const*) @ 0x8e8379c in /usr/bin/clickhouse</span><br><span class="line">26. ThreadPoolImpl&lt;std::__1::thread&gt;::worker(std::__1::__list_iterator&lt;std::__1::thread, void*&gt;) @ 0x8e7f950 in /usr/bin/clickhouse</span><br><span class="line">27. ? @ 0x8e82844 in /usr/bin/clickhouse</span><br><span class="line">28. start_thread @ 0x7624 in /usr/lib/aarch64-linux-gnu/libpthread-2.31.so</span><br><span class="line">29. ? @ 0xd149c in /usr/lib/aarch64-linux-gnu/libc-2.31.so</span><br><span class="line"> (version 22.8.5.29 (official build))</span><br><span class="line">2025.02.08 16:10:33.504961 [ 54 ] &#123;&#125; &lt;Error&gt; void DB::MergeTreeBackgroundExecutor&lt;DB::MergeMutateRuntimeQueue&gt;::routine(DB::TaskRuntimeDataPtr) [Queue = DB::MergeMutateRuntimeQueue]: Code: 241. DB::Exception: Memory limit (total) exceeded: would use 18.44 GiB (attempt to allocate chunk of 8709611 bytes), maximum: 18.00 GiB. OvercommitTracker decision: Memory overcommit isn&#x27;t used. Waiting time or overcommit denominator are set to zero. (MEMORY_LIMIT_EXCEEDED), Stack trace (when copying this message, always include the lines below):</span><br><span class="line"></span><br><span class="line">0. DB::Exception::Exception(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, int, bool) @ 0x8dcd368 in /usr/bin/clickhouse</span><br><span class="line">1. DB::Exception::Exception&lt;char const*, char const*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, long&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;, std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; &gt;(int, fmt::v8::basic_format_string&lt;char, fmt::v8::type_identity&lt;char const*&gt;::type, fmt::v8::type_identity&lt;char const*&gt;::type, fmt::v8::type_identity&lt;std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; &gt;::type, fmt::v8::type_identity&lt;long&amp;&gt;::type, fmt::v8::type_identity&lt;std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; &gt;::type, fmt::v8::type_identity&lt;std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt; &gt;::type&gt;, char const*&amp;&amp;, char const*&amp;&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;&amp;&amp;, long&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;&amp;&amp;, std::__1::basic_string_view&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp;&amp;) @ 0x8dbfe08 in /usr/bin/clickhouse</span><br><span class="line">2. MemoryTracker::allocImpl(long, bool, MemoryTracker*) @ 0x8dbf6d4 in /usr/bin/clickhouse</span><br><span class="line">3. MemoryTracker::allocImpl(long, bool, MemoryTracker*) @ 0x8dbf0f0 in /usr/bin/clickhouse</span><br><span class="line">4. MemoryTracker::allocImpl(long, bool, MemoryTracker*) @ 0x8dbf0f0 in /usr/bin/clickhouse</span><br><span class="line">5. DB::Memory&lt;Allocator&lt;false, false&gt; &gt;::alloc(unsigned long) @ 0x8e26118 in /usr/bin/clickhouse</span><br><span class="line">6. DB::WriteBufferFromFile::WriteBufferFromFile(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned long, int, unsigned int, char*, unsigned long) @ 0x8e46138 in /usr/bin/clickhouse</span><br><span class="line">7. DB::DiskLocal::writeFile(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned long, DB::WriteMode, DB::WriteSettings const&amp;) @ 0x1141bc88 in /usr/bin/clickhouse</span><br><span class="line">8. DB::DataPartStorageBuilderOnDisk::writeFile(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned long, DB::WriteSettings const&amp;) @ 0x1230e6e8 in /usr/bin/clickhouse</span><br><span class="line">9. DB::MergeTreeDataPartWriterOnDisk::Stream::Stream(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::shared_ptr&lt;DB::IDataPartStorageBuilder&gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::shared_ptr&lt;DB::ICompressionCodec&gt; const&amp;, unsigned long, DB::WriteSettings const&amp;) @ 0x12441ef0 in /usr/bin/clickhouse</span><br></pre></td></tr></table></figure><p>æœç´¢äº†çœ‹åˆ°å‡ ä¸ª issue éƒ½å»ºè®®å‡çº§ç‰ˆæœ¬ï¼š</p><ul><li><a href="https://github.com/ClickHouse/ClickHouse/issues/47642">https://github.com/ClickHouse/ClickHouse/issues/47642</a></li><li><a href="https://github.com/ClickHouse/ClickHouse/issues/40215">https://github.com/ClickHouse/ClickHouse/issues/40215</a></li></ul><p>åç»­ä¹Ÿå‘ç°äº†éƒ¨åˆ†å›½äº§ cpu ä¸Šæ— æ³•å¯åŠ¨ï¼Œä½¿ç”¨æœ¬æ–‡ç¼–è¯‘çš„åæ‰å¯ä»¥å¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker logs xxxxx</span></span><br><span class="line">Merging configuration file &#x27;/etc/clickhouse-server/config.d/docker_related_config.xml&#x27;.</span><br><span class="line">Including configuration file &#x27;/etc/metrika.xml&#x27;.</span><br><span class="line">2025.06.25 14:40:21.352040 [ 1 ] &#123;&#125; &lt;Information&gt; : Starting ClickHouse 22.8.5.29 with revision 54465, build id: 30D2CCC2A2FE0DE0, PID 1</span><br><span class="line">2025.06.25 14:40:21.352181 [ 1 ] &#123;&#125; &lt;Information&gt; Application: starting up</span><br><span class="line">2025.06.25 14:40:21.352201 [ 1 ] &#123;&#125; &lt;Information&gt; Application: OS name: Linux, version: 4.19.90-24.4.v2101.ky10.aarch64, architecture: aarch64</span><br><span class="line">2025.06.25 14:40:21.385220 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: ########################################</span><br><span class="line">2025.06.25 14:40:21.385298 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: (version 22.8.5.29 (official build), build id: 30D2CCC2A2FE0DE0) (from thread 1) (no query) Received signal Illegal instruction (4)</span><br><span class="line">2025.06.25 14:40:21.385327 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: Illegal opcode.</span><br><span class="line">2025.06.25 14:40:21.385358 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: Stack trace: 0xaaabccb2b12c 0xfffc5cb307c0</span><br><span class="line">2025.06.25 14:40:21.385459 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: 0. ? @ 0x8fdb12c in /usr/bin/clickhouse</span><br><span class="line">2025.06.25 14:40:21.385562 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: 1. ? @ 0xfffc5cb307c0 in ?</span><br><span class="line">2025.06.25 14:40:21.554513 [ 40 ] &#123;&#125; &lt;Fatal&gt; BaseDaemon: Integrity check of the executable skipped because the reference checksum could not be read. (calculated checksum: 05AC43DEA3E119694BFE830A4D95</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">lscpu</span></span><br><span class="line">æ¶æ„ï¼š                           aarch64</span><br><span class="line">CPU è¿è¡Œæ¨¡å¼ï¼š                   64-bit</span><br><span class="line">å­—èŠ‚åºï¼š                         Little Endian</span><br><span class="line">CPU:                             16</span><br><span class="line">åœ¨çº¿ CPU åˆ—è¡¨ï¼š                  0-15</span><br><span class="line">æ¯ä¸ªæ ¸çš„çº¿ç¨‹æ•°ï¼š                 1</span><br><span class="line">æ¯ä¸ªåº§çš„æ ¸æ•°ï¼š                   1</span><br><span class="line">åº§ï¼š                             16</span><br><span class="line">NUMA èŠ‚ç‚¹ï¼š                      1</span><br><span class="line">å‚å•† IDï¼š                        Phytium</span><br><span class="line">å‹å·ï¼š                           2</span><br><span class="line">å‹å·åç§°ï¼š                       FT-2000+/64</span><br><span class="line">æ­¥è¿›ï¼š                           0x1</span><br><span class="line">BogoMIPSï¼š                       100.00</span><br><span class="line">L1d ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L1i ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L2 ç¼“å­˜ï¼š                        8 MiB</span><br><span class="line">L3 ç¼“å­˜ï¼š                        512 MiB</span><br><span class="line">NUMA èŠ‚ç‚¹0 CPUï¼š                 0-15</span><br><span class="line">Vulnerability Itlb multihit:     Not affected</span><br><span class="line">Vulnerability L1tf:              Not affected</span><br><span class="line">Vulnerability Mds:               Not affected</span><br><span class="line">Vulnerability Meltdown:          Not affected</span><br><span class="line">Vulnerability Spec store bypass: Not affected</span><br><span class="line">Vulnerability Spectre v1:        Mitigation; __user pointer sanitization</span><br><span class="line">Vulnerability Spectre v2:        Not affected</span><br><span class="line">Vulnerability Srbds:             Not affected</span><br><span class="line">Vulnerability Tsx async abort:   Not affected</span><br><span class="line">æ ‡è®°ï¼š                           fp asimd evtstrm crc32 cpuid</span><br></pre></td></tr></table></figure><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="arm64-è¿è¡Œç¯å¢ƒ"><a href="#arm64-è¿è¡Œç¯å¢ƒ" class="headerlink" title="arm64 è¿è¡Œç¯å¢ƒ"></a>arm64 è¿è¡Œç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu</span><br><span class="line">æ¶æ„ï¼š                           aarch64</span><br><span class="line">CPU è¿è¡Œæ¨¡å¼ï¼š                   64-bit</span><br><span class="line">å­—èŠ‚åºï¼š                         Little Endian</span><br><span class="line">CPU:                             16</span><br><span class="line">åœ¨çº¿ CPU åˆ—è¡¨ï¼š                  0-15</span><br><span class="line">æ¯ä¸ªæ ¸çš„çº¿ç¨‹æ•°ï¼š                 1</span><br><span class="line">æ¯ä¸ªåº§çš„æ ¸æ•°ï¼š                   1</span><br><span class="line">åº§ï¼š                             16</span><br><span class="line">NUMA èŠ‚ç‚¹ï¼š                      1</span><br><span class="line">å‚å•† IDï¼š                        Phytium</span><br><span class="line">å‹å·ï¼š                           3</span><br><span class="line">å‹å·åç§°ï¼š                       ARMv8 CPU</span><br><span class="line">æ­¥è¿›ï¼š                           0x1</span><br><span class="line">CPU æœ€å¤§ MHzï¼š                   2100.0000</span><br><span class="line">CPU æœ€å° MHzï¼š                   2100.0000</span><br><span class="line">BogoMIPSï¼š                       100.00</span><br><span class="line">L1d ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L1i ç¼“å­˜ï¼š                       1 MiB</span><br><span class="line">L2 ç¼“å­˜ï¼š                        8 MiB</span><br><span class="line">L3 ç¼“å­˜ï¼š                        512 MiB</span><br><span class="line">NUMA èŠ‚ç‚¹0 CPUï¼š                 0-15</span><br><span class="line">Vulnerability Itlb multihit:     Not affected</span><br><span class="line">Vulnerability L1tf:              Not affected</span><br><span class="line">Vulnerability Mds:               Not affected</span><br><span class="line">Vulnerability Meltdown:          Not affected</span><br><span class="line">Vulnerability Mmio stale data:   Not affected</span><br><span class="line">Vulnerability Spec store bypass: Not affected</span><br><span class="line">Vulnerability Spectre v1:        Mitigation; __user pointer sanitization</span><br><span class="line">Vulnerability Spectre v2:        Not affected</span><br><span class="line">Vulnerability Srbds:             Not affected</span><br><span class="line">Vulnerability Tsx async abort:   Not affected</span><br><span class="line">æ ‡è®°ï¼š                           fp asimd evtstrm aes pmull sha1 sha2 crc32 cpuid</span><br></pre></td></tr></table></figure><h3 id="å‡çº§åèµ·ä¸æ¥"><a href="#å‡çº§åèµ·ä¸æ¥" class="headerlink" title="å‡çº§åèµ·ä¸æ¥"></a>å‡çº§åèµ·ä¸æ¥</h3><p>æ ¹æ® ck <a href="https://clickhouse.com/docs/en/operations/update">å®˜æ–¹ update æ–‡æ¡£</a> é‡Œå¯çŸ¥å®˜æ–¹åŠªåŠ›ä¿æŒä¸€å¹´å…¼å®¹æœŸï¼Œä¸¤ä¸ªç‰ˆæœ¬ä¹‹å‰å·®å¼‚å°äºä¸€å¹´æˆ–è€… LTS ç‰ˆæœ¬å°‘äºä¸¤ä¸ªå¯ä»¥å‡çº§ã€‚è€Œ 23 çš„ LTS ç‰ˆæœ¬æ˜¯ <code>v23.8.16.40-lts</code> ã€‚ç„¶åæ¢äº†é•œåƒåè¿è¡Œä¸èµ·æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/entrypoint.sh: line 40:    23 Illegal instruction     (core dumped) clickhouse extract-from-config --config-file &quot;$CLICKHOUSE_CONFIG&quot; --key=&#x27;storage_configuration.disks.*.path&#x27;</span><br><span class="line">/entrypoint.sh: line 41:    25 Illegal instruction     (core dumped) clickhouse extract-from-config --config-file &quot;$CLICKHOUSE_CONFIG&quot; --key=&#x27;storage_configuration.disks.*.metadata_path&#x27;</span><br></pre></td></tr></table></figure><p>ç„¶åå°è¯•äº†ä¸‹åˆ—ç‰ˆæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">23.5.5.92</span><br><span class="line">23.3.22.3</span><br><span class="line">23.3.9.55</span><br><span class="line">23.3.1</span><br><span class="line">22.12.6.22</span><br><span class="line">22.8.21.38</span><br><span class="line">22.10.7.13</span><br><span class="line">22.10.1</span><br><span class="line">22.9.1.2603</span><br><span class="line">22.9.7.34</span><br></pre></td></tr></table></figure><p>å‘ç° 22.9 æ‰èƒ½å¯åŠ¨ï¼ŒæŸ¥çœ‹ changelog <a href="https://clickhouse.com/docs/en/whats-new/changelog/2022#-clickhouse-release-2210-2022-10-25">https://clickhouse.com/docs/en/whats-new/changelog/2022#-clickhouse-release-2210-2022-10-25</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Aarch64 binaries now require at least ARMv8.2, released in 2016. Most notably, this enables use of ARM LSE, i.e. native atomic operations. \</span><br><span class="line">Also, CMake build option &quot;NO_ARMV81_OR_HIGHER&quot; has been added to allow compilation of binaries for older ARMv8.0 hardware, e.g. Raspberry Pi 4. #41610 (Robert Schulze).</span><br></pre></td></tr></table></figure><p>22.10 å¼€å§‹ä½¿ç”¨ arm LSE æŒ‡ä»¤é›†åšåŸå­æ“ä½œï¼Œä½†æ˜¯è¯¥æŒ‡ä»¤é›† armv8.2 æ‰æœ‰ï¼Œä½†æ˜¯ä¹Ÿåœ¨ Cmake æ·»åŠ äº†é€‰é¡¹ <code>NO_ARMV81_OR_HIGHER</code> å¯¹äº armv8.0 ç¼–è¯‘æ”¯æŒã€‚</p><h3 id="æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£"><a href="#æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£" class="headerlink" title="æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£"></a>æŸ¥çœ‹ç¼–è¯‘æ–‡æ¡£</h3><p>å®˜æ–¹è™½ç„¶æ–‡æ¡£å†™å¾—æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æ„Ÿè§‰æ¯”è¾ƒçç¢ã€‚è·Ÿç€å‰é¢ changelog çš„ pr <a href="https://github.com/ClickHouse/ClickHouse/pull/41987">#41987</a> çœ‹äº†ä¸‹å®˜æ–¹æ˜¯ github action ç¼–è¯‘çš„ã€‚github action æ„å»ºå†å²æœ‰ä¸Šé™ï¼Œæ‰¾ pr é‡Œçš„ <code>BuilderBinAarch64V80Compat</code> æ‰¾ä¸åˆ°ï¼Œç„¶ååœ¨æ–°ç‰ˆæœ¬ <code>.github/workflows/master.yml</code> é‡Œæ‰¾åˆ°äº† <code>build_arm_v80compat</code>ã€‚ä½†æ˜¯ç”¨çš„æ˜¯ä¸‹é¢ç¼–è¯‘å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m praktika run &#x27;Build (arm_v80compat)&#x27; --workflow &quot;MasterCI&quot; --ci</span><br></pre></td></tr></table></figure><p><code>praktika</code> è¿™ä¸ª pip ä»“åº“ä¸Šæ‰¾ä¸åˆ°ï¼Œäºæ˜¯æ‰¾åˆ°ç›¸å…³æœ€æ–°çš„ action é‡Œçœ‹ä¸‹å…·ä½“æ€ä¹ˆç¼–è¯‘çš„ï¼Œæ‰¾åˆ°äº†ç›¸å…³æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INFO:root:Pulling image clickhouse/binary-builder:54b46bb22708 - done</span><br><span class="line">INFO:root:Going to run packager with cd /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/docker/packager &amp;&amp; \</span><br><span class="line">  CMAKE_FLAGS=&#x27;-DENABLE_CLICKHOUSE_SELF_EXTRACTING=1&#x27; ./packager \</span><br><span class="line">  --output-dir=/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build \</span><br><span class="line">  --package-type=binary --compiler=clang-19-aarch64-v80compat \</span><br><span class="line">  --cache=sccache --s3-rw-access --s3-bucket=clickhouse-builds \</span><br><span class="line">  --docker-image-version=54b46bb22708 --with-profiler --with-buzzhouse --version=25.2.1.1773 --official</span><br><span class="line"></span><br><span class="line">2025-02-10 22:37:56,547 Will build ClickHouse pkg with cmd: &#x27;docker run --network=host --user=1000:1000 --rm  \</span><br><span class="line">  --volume=/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build:/output \</span><br><span class="line">  --volume=/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse:/build \</span><br><span class="line">   -e OUTPUT_DIR=/output -e DEB_ARCH=arm64 -e CC=clang-19 -e CXX=clang++-19 \</span><br><span class="line">   -e BUILD_TYPE=None -e SCCACHE_BUCKET=clickhouse-builds -e SCCACHE_S3_KEY_PREFIX=ccache/sccache \</span><br><span class="line">   -e VERSION_STRING=&#x27;25.2.1.1773&#x27; \</span><br><span class="line">   -e CMAKE_FLAGS=&quot;$CMAKE_FLAGS -DCMAKE_TOOLCHAIN_FILE=/build/cmake/linux/toolchain-aarch64.cmake \</span><br><span class="line">   -DNO_ARMV81_OR_HIGHER=1 -DCMAKE_C_COMPILER=clang-19 -DCMAKE_CXX_COMPILER=clang++-19 \</span><br><span class="line">   -DCOMPILER_CACHE=sccache -DENABLE_BUILD_PROFILING=1 \</span><br><span class="line">   -DENABLE_BUZZHOUSE=1 -DCLICKHOUSE_OFFICIAL_BUILD=1&quot; \</span><br><span class="line">   -e BUILD_TARGET=&#x27;clickhouse-bundle&#x27; --volume=/home/ubuntu/.cargo/registry:/rust/cargo/registry  \</span><br><span class="line">   clickhouse/binary-builder:54b46bb22708&#x27;</span><br></pre></td></tr></table></figure><p>æœäº†ä¸‹ç›¸å…³æºç ç›¸å…³å…³é”®å­— <code>binary-builder</code>ï¼Œå¤§ä½“äº†è§£äº†ä¸‹å®˜æ–¹ç¼–è¯‘æ­¥éª¤ï¼š</p><ul><li><code>docker/packager</code> ä¸‹æä¾›äº† <code>packager</code> äºŒè¿›åˆ¶(å®é™…æ˜¯pythonè„šæœ¬)æ¥ç¼–è¯‘</li><li><code>docker/packager/binary-builder</code> æ˜¯åˆ©ç”¨ docker æ‰“åŒ…ä¸€ä¸ªé•œåƒï¼Œé‡Œé¢åŒ…å« llvmã€rustã€clang ä¹‹ç±»çš„ç¼–è¯‘ç¯å¢ƒ</li></ul><p>è¯¥å®¹å™¨é•œåƒç”± CI æ„å»ºå®šæœŸæ¨é€åˆ° dockerhub ä¸Šï¼Œç„¶åä¸æƒ³å®¿ä¸»æœºä¸Šå®‰è£…ç¯å¢ƒå¯ä»¥ä½¿ç”¨å®ƒæ¥è¿›è¡Œç¼–è¯‘ï¼Œå…·ä½“å‚æ•°æŸ¥çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd docker/packager</span><br><span class="line">$ packager --help</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p>å¹¶ä¸”å®˜æ–¹æ–‡æ¡£æœ‰ <a href="https://clickhouse.com/docs/en/development/build#building-in-docker">building-in-docker</a> ï¼Œæ‰€ä»¥æ‰“ç®—ä½¿ç”¨å®˜æ–¹çš„ docker é•œåƒæ„å»ºï¼Œæœºå™¨è¦æå‰å®‰è£…å¥½ dockerï¼Œç¡¬ç›˜æœ€å¥½æœ‰ 50G å®¹é‡ï¼Œæºç éå¸¸å¤§ï¼Œè‡ªå¤‡ç¨³å®šçŒ«å’ªä¹‹ç±»çš„ã€‚æ‹‰å–æºç å’Œç¼–è¯‘å…¨ç¨‹å»ºè®®å¼€ä¸ª screen é‡Œæ“ä½œï¼š</p><h4 id="æ‹‰å–æºç "><a href="#æ‹‰å–æºç " class="headerlink" title="æ‹‰å–æºç "></a>æ‹‰å–æºç </h4><p>å› ä¸ºå­æ¨¡å—éå¸¸å¤šï¼Œå»ºè®®ä½¿ç”¨ git2 é¿å…ä¸€äº›å¥‡æ€ªé—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ClickHouse/ClickHouse.git</span><br></pre></td></tr></table></figure><p>åˆ‡åˆ°æŒ‡å®šåˆ†æ”¯å’Œæ‹‰å–å­æ¨¡å—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout v23.8.16.40-lts</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å­æ¨¡å—å®Œæ•´æ€§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line">git submodule status</span><br></pre></td></tr></table></figure><p>ç¡®è®¤æ‹‰å–å®Œæˆåå†å¼€å§‹åé¢æ“ä½œ</p><h4 id="å¤±è´¥çš„ç¼–è¯‘"><a href="#å¤±è´¥çš„ç¼–è¯‘" class="headerlink" title="å¤±è´¥çš„ç¼–è¯‘"></a>å¤±è´¥çš„ç¼–è¯‘</h4><p>æŸ¥çœ‹ <code>docker/packager/packager</code> å†…å®¹ç¼–è¯‘ arm64v8.0 æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./docker/packager</span><br><span class="line">packager --package-type=binary --output-dir=build_results \</span><br><span class="line"> --compiler=clang-16-aarch64-v80compat</span><br></pre></td></tr></table></figure><p>ç„¶åæŠ¥é”™ clang ç‰ˆæœ¬ç›¸å…³ï¼Œé»˜è®¤æ‹‰å–çš„ <code>clickhouse/binary-builder:latest</code>ï¼ŒæŸ¥çœ‹äº†ä¸‹ <code>packager</code> æºç å’Œ <code>--help</code> æœ‰é€‰é¡¹ <code>--docker-image-version</code> æŒ‡å®šé•œåƒ tagï¼Œå» dockerhub ä¸Šæ‰¾äº†ä¸‹ <code>clickhouse/binary-builder</code> çš„ clang 16 ç‰ˆæœ¬ï¼Œå‘ç° tag å¥½åƒæ˜¯ commitid ç›¸å…³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git log -n1</span><br><span class="line">commit e143a9039ba36ad0c25f2ed85503f36e88f61063 (HEAD, tag: v23.8.16.40-lts)</span><br><span class="line">Merge: 8afc5bd5d1c a60c914df11</span><br><span class="line">Author: Antonio Andelic &lt;antonio2368@users.noreply.github.com&gt;</span><br><span class="line">Date:   Thu Jul 25 20:50:17 2024 +0100</span><br><span class="line"></span><br><span class="line">    Merge pull request #66717 from ClickHouse/backport/23.8/66548</span><br><span class="line">    </span><br><span class="line">    Backport #66548 to 23.8: Correctly track memory for `Allocator::realloc`</span><br></pre></td></tr></table></figure><p>æœç´¢äº†ä¸‹ <a href="https://hub.docker.com/r/clickhouse/binary-builder/tags?name=e143a903">e143a903</a> æ‰¾åˆ°äº† tag <code>54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</code>ï¼Œä½†æ˜¯é•œåƒæ¯”è¾ƒå¤§ï¼Œç„¶åç”¨ daoCloud çš„åŒæ­¥äº†ä¸‹ï¼Œæ‹‰å–ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull m.daocloud.io/docker.io/clickhouse/binary-builder:54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br><span class="line">docker tag m.daocloud.io/docker.io/clickhouse/binary-builder:54187-e143a9039ba36ad0c25f2ed85503f36e88f61063 \</span><br><span class="line">        clickhouse/binary-builder:54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br></pre></td></tr></table></figure><p>ç„¶åç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./docker/packager/packager --package-type=binary --compiler=clang-16-aarch64-v80compat  \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br></pre></td></tr></table></figure><p>ç›¸å…³æŠ¥é”™ä¸€ç›´æ— æ³•è§£å†³ï¼Œæäº† <a href="https://github.com/ClickHouse/ClickHouse/issues/75923">issue 75923</a>ï¼Œå®˜æ–¹è¯´è¯¥ç‰ˆæœ¬å·²ç»ä¸ç»´æŠ¤ä¸æä¾›å¸®åŠ©ï¼Œè®©æˆ‘ä¸è¦è‡ªå·±ç¼–è¯‘ï¼Œè€Œæ˜¯å»ä¸‹è½½å®˜æ–¹ç¼–è¯‘çš„ã€‚ä¸‹è½½äº†å½“ç„¶æ˜¯ core dumpã€‚ç„¶åè‡ªå·±æ‰¾äº†ä¸‹å®˜æ–¹ç¼–è¯‘çš„ <code>build_arm_v80compat</code> ï¼Œåªæœ‰ä¸€ä¸ªä¸‹è½½ç›´é“¾ï¼Œä¸å­˜åœ¨è€ç‰ˆæœ¬ï¼Œaction é‡Œå¯ä»¥çœ‹åˆ°ä¸‹è½½é“¾æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">2025-02-10 22:46:45,343 Output placed into /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build</span><br><span class="line">INFO:root:Built successfully</span><br><span class="line">INFO:root:Build finished as success, log path /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build_log/build_log.log</span><br><span class="line">INFO:botocore.credentials:Found credentials from IAM Role: ec2_admin</span><br><span class="line">INFO:root:Processing file without compression</span><br><span class="line">INFO:root:File is too large, do not provide content type</span><br><span class="line">INFO:root:Upload /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse to https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse-full Meta: &#123;&#125;</span><br><span class="line">Notice: Binary static URL (with debug info): https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse-full</span><br><span class="line">INFO:root:Processing file without compression</span><br><span class="line">INFO:root:File is too large, do not provide content type</span><br><span class="line">INFO:root:Upload /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse-stripped to https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse Meta: &#123;&#125;</span><br><span class="line">Notice: Binary static URL (compact): https://s3.amazonaws.com/clickhouse-builds/master/aarch64v80compat/clickhouse</span><br><span class="line">Run action done for: [binary_aarch64_v80compat]</span><br><span class="line">INFO:botocore.credentials:Found credentials from IAM Role: ec2_admin</span><br><span class="line">INFO:root:Get token with 4322 remaining requests</span><br><span class="line">INFO:root:User robot-clickhouse-ci-1 with 4322 remaining requests is used</span><br><span class="line">&#123;&#125;</span><br><span class="line">=== Run script finished ===</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª action é‡Œéƒ½æœ‰é“¾æ¥ï¼Œä½†æ˜¯å¤ªæ—©çš„å°±æ²¡æœ‰äº†ï¼Œå› ä¸º github action åªä¿ç•™ä¸Šé™çš„æ„å»ºå†å²ã€‚çœ‹äº†ä¸‹åº”è¯¥æ˜¯æ„å»ºéƒ½å­˜åœ¨ s3 ä¸Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">=== Post run script [Build (arm_v80compat)], workflow [MasterCI] ===</span><br><span class="line">Job provides s3 artifacts [[Artifact.Config(name=&#x27;CH_ARMV80C_DARWIN_BIN&#x27;, type=&#x27;s3&#x27;, path=&#x27;/home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse&#x27;, _provided_by=&#x27;Build (arm_v80compat)&#x27;, _s3_path=&#x27;&#x27;)]]</span><br><span class="line">Run command: [ls -l /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse]</span><br><span class="line">-rwxr-xr-x 1 ubuntu ubuntu 770032980 Feb 10 23:27 /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse</span><br><span class="line">Run command [aws s3 cp /home/ubuntu/actions-runner/_work/ClickHouse/ClickHouse/ci/tmp/build/clickhouse s3://clickhouse-builds/REFs/master/57b1cafdcb704280f05ee61345e8fbad9a6af5ed/build_arm_v80compat/clickhouse]</span><br><span class="line">Artifact report enabled and will be uploaded: [&#123;&#x27;build_urls&#x27;: [&#x27;https://clickhouse-builds.s3.amazonaws.com/REFs/master/57b1cafdcb704280f05ee61345e8fbad9a6af5ed/build_arm_v80compat/clickhouse&#x27;]&#125;]</span><br><span class="line">Run command [aws s3 cp ./ci/tmp/artifact_report_build_arm_v80compat.json s3://clickhouse-builds/REFs/master/57b1cafdcb704280f05ee61345e8fbad9a6af5ed/build_arm_v80compat/artifact_report_build_arm_v80compat.json]</span><br><span class="line">Insert results to CIDB</span><br></pre></td></tr></table></figure><p>æ ¹æ®é“¾æ¥è§„åˆ™æ¨æ–­äº†ä¸‹ä¸‹è½½ urlï¼Œå‘ç° 403ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://clickhouse-builds.s3.amazonaws.com/REFs/master/e143a9039ba36ad0c25f2ed85503f36e88f61063/build_arm_v80compat/clickhouse</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶è¯´ v23 ä¸ç»´æŠ¤ï¼Œç„¶åå°è¯•äº† v24 çš„ lts ç‰ˆæœ¬ä¹Ÿä¸€æ ·ï¼Œç›¸å…³æŠ¥é”™ä¹Ÿæäº† <a href="https://github.com/ClickHouse/ClickHouse/issues/75960">issue 75960</a></p><h4 id="æˆåŠŸçš„ç¼–è¯‘"><a href="#æˆåŠŸçš„ç¼–è¯‘" class="headerlink" title="æˆåŠŸçš„ç¼–è¯‘"></a>æˆåŠŸçš„ç¼–è¯‘</h4><p>æŠ¥é”™éƒ½æ˜¯ <code>contrib/sysroot</code> å’Œ <code>contrib/thrift</code> è¿™ä¿©å­æ¨¡å—ï¼Œgithub ä¸Šçœ‹äº†ä¸‹å†å²è®°å½•ï¼Œè¿™ä¿©æ¨¡å—åŸºæœ¬æ²¡æ€ä¹ˆæ›´æ–°åˆ°æ–°ç‰ˆæœ¬ï¼Œæ„Ÿè§‰ä¸æ˜¯æ¨¡å—é—®é¢˜ã€‚æœäº†ä¸€äº›ç›¸å…³ç¼–è¯‘ï¼Œå‘ç°éƒ½æ˜¯ç¼–è¯‘ 22.10 ä¹‹å‰çš„ç‰ˆæœ¬å±…å¤šã€‚éº’éºŸçš„ yum æºé‡Œç‰ˆæœ¬ä¹Ÿæ¯”è¾ƒè€ï¼Œè”ç³»äº†éº’éºŸæœ‰æ²¡æœ‰æ–°ç‰ˆæœ¬ rpm åŒ…ï¼Œç„¶åéº’éºŸå‘äº†ä¸ªæ–°ç‰ˆæœ¬æºç ç¼–è¯‘å®‰è£…çš„æ–‡æ¡£è¿‡æ¥ï¼Œçœ‹äº†ä¸‹æ˜¯åœ¨ arm64 ä¸Šç¼–è¯‘çš„ 25 ç‰ˆæœ¬ï¼Œå¤§ä½“æ­¥éª¤ä¸ºï¼š</p><ul><li>rpm åŒ…å®‰è£… cmake 3.26</li><li>ç¼–è¯‘å®‰è£… gcc-11.3.0 å¹¶æ¢ std åº“</li><li>ç¼–è¯‘å®‰è£… clang-18.1.0</li><li>ç¼–è¯‘å®‰è£… llvm-18.1.0</li><li>å®‰è£… rust 1.80.0</li><li>å®‰è£… ccache src.rpm</li><li>å£°æ˜ CC&#x3D;clang CXX&#x3D;clang++ å<ul><li><code>mkdir build &amp;&amp; cd build</code></li><li><code>cmake .. -DCMAKE_INSTALL_PREFIX=/opt/clickhouse-bin -DNO_ARMV81_OR_HIGHER=1</code></li><li><code>ninja -j32</code></li><li><code>ninja install</code></li></ul></li></ul><p>æ ¹æ®ç¼–è¯‘ç›¸å…³ï¼Œ<code>packager</code> çš„ <code>--compiler=clang-16-aarch64-v80compat</code> ç›¸å…³é€»è¾‘ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ARM_V80COMPAT_SUFFIX = <span class="string">&quot;-aarch64-v80compat&quot;</span></span><br><span class="line">...</span><br><span class="line">is_cross_arm_v80compat = compiler.endswith(ARM_V80COMPAT_SUFFIX)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">elif</span> is_cross_arm_v80compat:</span><br><span class="line">        cc = compiler[: -<span class="built_in">len</span>(ARM_V80COMPAT_SUFFIX)]</span><br><span class="line">        cmake_flags.append(</span><br><span class="line">            <span class="string">&quot;-DCMAKE_TOOLCHAIN_FILE=/build/cmake/linux/toolchain-aarch64.cmake&quot;</span></span><br><span class="line">        )</span><br><span class="line">        cmake_flags.append(<span class="string">&quot;-DNO_ARMV81_OR_HIGHER=1&quot;</span>)</span><br><span class="line">        result.append(<span class="string">&quot;DEB_ARCH=arm64&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>-DNO_ARMV81_OR_HIGHER=1</code> æ˜¯å¿…å¡«çš„ï¼Œè€Œæ’å…¥çš„ <code>-DCMAKE_TOOLCHAIN_FILE</code> åˆ™æ˜¯é…ç½®ä½¿ç”¨äº¤å‰ç¼–è¯‘å·¥å…·é“¾ã€‚äº¤å‰ç¼–è¯‘ä¸€ç›´å¤±è´¥ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ arm64 æœºå™¨ä¸Šå’Œéº’éºŸé‚£æ ·æºç ç¼–è¯‘ clang ç­‰ç›¸å…³å†å°è¯•ç¼–è¯‘ ckï¼Œä½†æ˜¯æ–°å¼€çš„éº’éºŸ arm64 æœºå™¨ä¸Šæ²¡çŒ«å’ª gcc å’Œ llvm ä¸‹è½½éå¸¸æ…¢ã€‚å°±åŒæ­¥çœ‹äº†ä¸‹ <code>clickhouse/binary-builder</code> å‘ç°è¿˜æä¾›äº† arm64 çš„é•œåƒï¼Œæƒ³ç€ç›´æ¥ arm64 ä¸Šä¸æŒ‡å®š <code>ARM_V80COMPAT_SUFFIX</code> é‚£å°±ä¼šç”¨å†…ç½®çš„ arm64 gcc äº†ï¼Œç„¶åå†æŒ‡å®š <code>-DNO_ARMV81_OR_HIGHER=1</code> ç¼–è¯‘é€‰é¡¹é‚£å°±å’Œéº’éºŸä¸€æ ·äº†ã€‚å’Œä¹‹å‰ä¸€æ ·æ‰¾äº†ä¸ªé«˜é…ç½® arm64 æœºå™¨ä¸Šï¼š</p><ul><li>æ‹‰æºç ï¼Œè¿›å» checkout åˆ° <code>v23.8.16.40-lts</code>ï¼Œæ‹‰å–å­æ¨¡å—æºç </li><li>æ‹‰å–å¯¹åº”çš„ <code>clickhouse/binary-builder</code> å¹¶ tag</li></ul><p>æŸ¥çœ‹è„šæœ¬å¾—åˆ°ç¼–è¯‘å‘½ä»¤å’Œé€‰é¡¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_FLAGS=<span class="string">&#x27;-DNO_ARMV81_OR_HIGHER=1&#x27;</span> ./docker/packager/packager --package-type=binary \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåç»ˆäºæ²¡å¡åœ¨ <code>contrib/sysroot</code> å’Œ <code>contrib/thrift</code> äº†ï¼Œä½†æ˜¯æœ€åæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Feb 12 08:22:09 [3590/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/SubtargetFeatureInfo.cpp.o</span><br><span class="line">Feb 12 08:22:10 [3591/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/CompressInstEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:10 [3592/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/X86DisassemblerTables.cpp.o</span><br><span class="line">Feb 12 08:22:10 [3593/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/CodeExpander.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3594/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagEdge.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3595/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/WebAssemblyDisassemblerEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3596/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/X86RecognizableInstr.cpp.o</span><br><span class="line">Feb 12 08:22:11 [3596/10884] cd /build/build_docker/rust/skim &amp;&amp; /usr/bin/cmake -E make_directory /build/build_docker/rust/skim/RelWithDebInfo &amp;&amp; /usr/bin/cmake -E env CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=/usr/bin/clang++-16 CC_aarch64-unknown-linux-gnu=/usr/bin/clang-16 HOST_CC=/usr/bin/clang-16 CXX_aarch64-unknown-linux-gnu=/usr/bin/clang++-16 HOST_CXX=/usr/bin/clang++-16 CORROSION_BUILD_DIR=/build/build_docker/rust/skim CARGO_BUILD_RUSTC=/rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/rustc /rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/cargo rustc --target=aarch64-unknown-linux-gnu --package _ch_rust_skim_rust --manifest-path /build/build_docker/rust/skim/Cargo.toml --target-dir /build/build_docker/RelWithDebInfo/cargo/build --profile=release -- -Cdefault-linker-libraries=no -Clink-args=--target=aarch64-linux-gnu &amp;&amp; /usr/bin/cmake -E copy_if_different /build/build_docker/RelWithDebInfo/cargo/build/aarch64-unknown-linux-gnu/release/lib_ch_rust_skim_rust.a /build/build_docker/rust/skim/RelWithDebInfo</span><br><span class="line">Feb 12 08:22:11 error: package `cxx v1.0.140` cannot be built because it requires rustc 1.73 or newer, while the currently active rustc version is 1.72.0-nightly</span><br><span class="line">Feb 12 08:22:11 Either upgrade to rustc 1.73 or newer, or use</span><br><span class="line">Feb 12 08:22:11 cargo update -p cxx@1.0.140 --precise ver</span><br><span class="line">Feb 12 08:22:11 where `ver` is the latest version of `cxx` supporting rustc 1.72.0-nightly</span><br><span class="line">Feb 12 08:22:12 [3600/10884] Linking CXX static library contrib/ulid-c-cmake/lib_ulid.a</span><br><span class="line">Feb 12 08:22:12 FAILED: rust/skim/CMakeFiles/cargo-build__ch_rust_skim_rust rust/skim/RelWithDebInfo/lib_ch_rust_skim_rust.a /build/build_docker/rust/skim/CMakeFiles/cargo-build__ch_rust_skim_rust /build/build_docker/rust/skim/RelWithDebInfo/lib_ch_rust_skim_rust.a </span><br><span class="line">Feb 12 08:22:12 cd /build/build_docker/rust/skim &amp;&amp; /usr/bin/cmake -E make_directory /build/build_docker/rust/skim/RelWithDebInfo &amp;&amp; /usr/bin/cmake -E env CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=/usr/bin/clang++-16 CC_aarch64-unknown-linux-gnu=/usr/bin/clang-16 HOST_CC=/usr/bin/clang-16 CXX_aarch64-unknown-linux-gnu=/usr/bin/clang++-16 HOST_CXX=/usr/bin/clang++-16 CORROSION_BUILD_DIR=/build/build_docker/rust/skim CARGO_BUILD_RUSTC=/rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/rustc /rust/rustup/toolchains/nightly-2023-07-04-aarch64-unknown-linux-gnu/bin/cargo rustc --target=aarch64-unknown-linux-gnu --package _ch_rust_skim_rust --manifest-path /build/build_docker/rust/skim/Cargo.toml --target-dir /build/build_docker/RelWithDebInfo/cargo/build --profile=release -- -Cdefault-linker-libraries=no -Clink-args=--target=aarch64-linux-gnu &amp;&amp; /usr/bin/cmake -E copy_if_different /build/build_docker/RelWithDebInfo/cargo/build/aarch64-unknown-linux-gnu/release/lib_ch_rust_skim_rust.a /build/build_docker/rust/skim/RelWithDebInfo</span><br><span class="line">Feb 12 08:22:12 [3602/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/SearchableTableEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3603/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/CTagsEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3604/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/VarLenCodeEmitterGen.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3605/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/InstrInfoEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3606/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagOperands.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3607/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagInstr.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3608/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDag.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3609/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/X86FoldTablesEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3610/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagPredicateDependencyEdge.cpp.o</span><br><span class="line">Feb 12 08:22:12 [3611/10884] Building CXX object contrib/llvm-project/llvm/lib/BinaryFormat/CMakeFiles/LLVMBinaryFormat.dir/COFF.cpp.o</span><br><span class="line">Feb 12 08:22:13 [3612/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchDagPredicate.cpp.o</span><br><span class="line">Feb 12 08:22:13 [3613/10884] Building CXX object contrib/llvm-project/llvm/lib/BinaryFormat/CMakeFiles/LLVMBinaryFormat.dir/AMDGPUMetadataVerifier.cpp.o</span><br><span class="line">Feb 12 08:22:14 [3614/10884] Building CXX object contrib/llvm-project/llvm/lib/BinaryFormat/CMakeFiles/LLVMBinaryFormat.dir/Dwarf.cpp.o</span><br><span class="line">Feb 12 08:22:15 [3615/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/SubtargetEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:18 [3616/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/RegisterInfoEmitter.cpp.o</span><br><span class="line">Feb 12 08:22:19 [3617/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/GlobalISel/CMakeFiles/LLVMTableGenGlobalISel.dir/GIMatchTree.cpp.o</span><br><span class="line">Feb 12 08:22:24 [3618/10884] Building CXX object contrib/llvm-project/llvm/utils/TableGen/CMakeFiles/llvm-tblgen.dir/GlobalISelEmitter.cpp.o</span><br></pre></td></tr></table></figure><p>æŠ¥é”™è¯´ rust ç‰ˆæœ¬ 1.72 ä½äº†ï¼Œè¦æ±‚ 1.73ï¼Œæœäº†ä¸‹ <code>nightly-2023-07-04</code> æœä¸åˆ°æœ‰ç”¨çš„ï¼Œ<code>nightly</code> æ˜¯æ¯æ—¥å‘è¡Œç‰ˆæœ¬ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„ <code>1.73</code> æ˜¯å•¥æ—¥æœŸã€‚å¦‚æœç›´æ¥ä½¿ç”¨æ–°ç‰ˆæœ¬ <code>binary-builder</code> ï¼Œé‡Œé¢çš„ clang å’Œè¦ç¼–è¯‘çš„ ck ç‰ˆæœ¬å¯¹ä¸ä¸Šï¼Œäºæ˜¯æ ¹æ® <code>clickhouse/binary-builder</code> çš„ Dockerfile æ‰¾äº†ä¸‹ rust çš„ä¸´è¿‘æ›´æ–°æ˜¯ <code>nightly-2024-12-01</code>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl https://sh.rustup.rs -sSf | bash -s -- -y &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 777 -R /rust &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup toolchain install nightly-2024-12-01 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup default nightly-2024-12-01 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup toolchain remove stable &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup component add rust-src &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup target add x86_64-unknown-linux-gnu &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    rustup target add aarch64-unknown-linux-gnu &amp;&amp; \</span></span><br></pre></td></tr></table></figure><p>å‰é¢ç¼–è¯‘æŠ¥é”™ç»“å°¾ä¼šæœ‰ä¸€ä¸ª <code>docker run ...</code> å®Œæ•´å‘½ä»¤ï¼Œç»“å°¾åŠ ä¸€ä¸ª <code>bash</code> run èµ·æ¥åå†…éƒ¨å‡çº§ä¸‹ rust å°è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®°å¾—ä¾æ—§ä½¿ç”¨ screen</span></span><br><span class="line">docker run .... bash</span><br><span class="line">rustup toolchain install nightly-2024-12-01</span><br><span class="line">rustup default nightly-2024-12-01</span><br><span class="line">rustup component add rust-src <span class="comment">#&lt;--- ä¼¼ä¹æ²¡å¿…è¦æ‰§è¡Œ</span></span><br><span class="line">rustup target add aarch64-unknown-linux-gnu <span class="comment">#&lt;--- ä¼¼ä¹æ²¡å¿…è¦æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>å®é™… <code>clickhouse/binary-builder</code> å’Œ å®ƒçš„ Dockerfile CMD éƒ½æ˜¯æ‰§è¡Œï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;bash&quot;</span> <span class="string">&quot;-c&quot;</span> <span class="string">&quot;/build.sh 2&gt;&amp;1&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¸Šé¢çš„å®¹å™¨é‡Œç»§ç»­æ‰§è¡Œ <code>/build.sh</code> å°±å¯ä»¥ç¼–è¯‘äº†ï¼Œç¼–è¯‘æœŸé—´çœ‹äº†ä¸‹ <code>build.sh</code> å­˜åœ¨ä»¥ä¸‹é€»è¾‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> check_prebuild_exists /build/packages/pre-build</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="comment"># Execute all commands</span></span><br><span class="line">  <span class="keyword">for</span> file <span class="keyword">in</span> /build/packages/pre-build/*.sh ;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># The script may want to modify environment variables. Why not to allow it to do so?</span></span><br><span class="line">    <span class="comment"># shellcheck disable=SC1090</span></span><br><span class="line">    <span class="built_in">source</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;There are no subcommands to execute :)&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœä¸äº¤äº’å¼ç›´æ¥ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–ç¼–è¯‘çš„æ­¥éª¤ï¼Œåœ¨æ‹‰å– <code>clickhouse/binary-builder</code> å¯¹åº”é•œåƒåå¯ä»¥æ˜¯ä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p packages/pre-build</span><br><span class="line">cat &lt;&lt; EOF &gt; packages/pre-build/update-rust.sh</span><br><span class="line">rustup toolchain install nightly-2024-12-01</span><br><span class="line">rustup default nightly-2024-12-01</span><br><span class="line">EOF</span><br><span class="line">CMAKE_FLAGS=&#x27;-DNO_ARMV81_OR_HIGHER=1&#x27; ./docker/packager/packager --package-type=binary \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br></pre></td></tr></table></figure><p>æœ€åç¼–è¯‘å‡ºæ¥ 2.9G å¤§å°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Feb 12 10:39:51 Average compiler                  0.000 s</span><br><span class="line">Feb 12 10:39:51 Average cache read hit            0.000 s</span><br><span class="line">Feb 12 10:39:51 Failed distributed compilations       0</span><br><span class="line">Feb 12 10:39:51 Cache location                  Local disk: &quot;/root/.cache/sccache&quot;</span><br><span class="line">Feb 12 10:39:51 Version (client)                0.5.4</span><br><span class="line">Feb 12 10:39:51 + ccache --evict-older-than 1d</span><br><span class="line">Feb 12 10:39:51 + &#x27;[&#x27; &#x27;&#x27; == 1 &#x27;]&#x27;</span><br><span class="line">Feb 12 10:39:51 + &#x27;[&#x27; -n &#x27;&#x27; &#x27;]&#x27;</span><br><span class="line">Feb 12 10:39:51 + ls -l /output</span><br><span class="line">Feb 12 10:39:51 total 6200956</span><br><span class="line">Feb 12 10:39:51 -rwxr-xr-x 1 root root 3336977696 Feb 12 10:39 clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-benchmark -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-client -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-compressor -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-copier -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-disks -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-extract-from-config -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-format -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-git-import -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-keeper -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-keeper-client -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-keeper-converter -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-local -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-obfuscator -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-server -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-static-files-disk-uploader -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 lrwxrwxrwx 1 root root         10 Feb 12 10:39 clickhouse-su -&gt; clickhouse</span><br><span class="line">Feb 12 10:39:51 -rwxr-xr-x 1 root root 3012799232 Feb 12 10:39 unit_tests_dbms</span><br></pre></td></tr></table></figure><p>ç„¶ååŠ ä¸€äº›é€‰é¡¹ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_FLAGS=<span class="string">&#x27;-DNO_ARMV81_OR_HIGHER=1 -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTS=OFF -DENABLE_DEBUG=OFF -DSPLIT_DEBUG_SYMBOLS=ON&#x27;</span> \</span><br><span class="line">  ./docker/packager/packager --package-type=binary \</span><br><span class="line">  --output-dir=build_results --docker-image-version 54187-e143a9039ba36ad0c25f2ed85503f36e88f61063</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Feb 13 01:24:21 Failed distributed compilations       0</span><br><span class="line">Feb 13 01:24:21 Cache location                  Local disk: &quot;/root/.cache/sccache&quot;</span><br><span class="line">Feb 13 01:24:21 Version (client)                0.5.4</span><br><span class="line">Feb 13 01:24:21 + ccache --evict-older-than 1d</span><br><span class="line">Feb 13 01:24:21 + &#x27;[&#x27; &#x27;&#x27; == 1 &#x27;]&#x27;</span><br><span class="line">Feb 13 01:24:21 + &#x27;[&#x27; -n &#x27;&#x27; &#x27;]&#x27;</span><br><span class="line">Feb 13 01:24:21 + ls -l /output</span><br><span class="line">Feb 13 01:24:21 total 680996</span><br><span class="line">Feb 13 01:24:21 -rwxr-xr-x 1 root root 697336944 Feb 13 01:24 clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-benchmark -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-client -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-compressor -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-copier -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-disks -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-extract-from-config -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-format -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-git-import -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-keeper -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-keeper-client -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-keeper-converter -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-local -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-obfuscator -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-server -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-static-files-disk-uploader -&gt; clickhouse</span><br><span class="line">Feb 13 01:24:21 lrwxrwxrwx 1 root root        10 Feb 13 01:24 clickhouse-su -&gt; clickhouse</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ–‡ä»¶æ‰“åŒ…ï¼Œç„¶å core dump æœºå™¨ä¸Šæµ‹è¯•ä¸‹æ²¡é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./clickhouse <span class="built_in">local</span> -q <span class="string">&#x27;select 1&#x27;</span></span><br><span class="line">1</span><br><span class="line">./clickhouse-server --version</span><br><span class="line">ClickHouse server version 23.8.16.1.</span><br></pre></td></tr></table></figure><h3 id="æ‰“åŒ…-Docker-é•œåƒ"><a href="#æ‰“åŒ…-Docker-é•œåƒ" class="headerlink" title="æ‰“åŒ… Docker é•œåƒ"></a>æ‰“åŒ… Docker é•œåƒ</h3><p>æ ¹æ® <code>docker histort --no-trunc</code> ç¡®è®¤äº† Dockerfile æ˜¯ç”¨çš„ <a href="https://github.com/ClickHouse/ClickHouse/blob/v23.8.16.40-lts/docker/server/Dockerfile.ubuntu">docker&#x2F;server&#x2F;Dockerfile.ubuntu</a>ï¼Œä½†æ˜¯ç¼–è¯‘çš„é•œåƒæ˜¯åŸºäº ubuntu:22.04 çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/os-release </span></span><br><span class="line">PRETTY_NAME=<span class="string">&quot;Ubuntu 22.04.4 LTS&quot;</span></span><br><span class="line">NAME=<span class="string">&quot;Ubuntu&quot;</span></span><br><span class="line">VERSION_ID=<span class="string">&quot;22.04&quot;</span></span><br><span class="line">VERSION=<span class="string">&quot;22.04.4 LTS (Jammy Jellyfish)&quot;</span></span><br><span class="line">VERSION_CODENAME=jammy</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">HOME_URL=<span class="string">&quot;https://www.ubuntu.com/&quot;</span></span><br><span class="line">SUPPORT_URL=<span class="string">&quot;https://help.ubuntu.com/&quot;</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span></span><br><span class="line">PRIVACY_POLICY_URL=<span class="string">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span></span><br><span class="line">UBUNTU_CODENAME=jammy</span><br></pre></td></tr></table></figure><p>é¿å…æ„å¤–å’Œ CVEï¼Œè¿˜æ˜¯ç”¨ <code>ubuntu:22.04</code> ç¨³å¦¥äº›ï¼Œå‚è€ƒäº†ä¸‹æœ€æ–°çš„ master åˆ†æ”¯ä¸Šçš„ 22.04 æ•´äº†ä¸‹ <code>docker/server/Dockerfile.fix</code>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">22.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># see https://github.com/moby/moby/issues/4032#issuecomment-192327844</span></span><br><span class="line"><span class="comment"># It could be removed after we move on a version 23:04+</span></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="comment"># ARG for quick switch to a given ubuntu mirror</span></span><br><span class="line"><span class="keyword">ARG</span> apt_archive=<span class="string">&quot;http://archive.ubuntu.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We shouldn&#x27;t use `apt upgrade` to not change the upstream image. It&#x27;s updated biweekly</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># user/group precreated explicitly with fixed uid/gid on purpose.</span></span><br><span class="line"><span class="comment"># It is especially important for rootless containers: in that case entrypoint</span></span><br><span class="line"><span class="comment"># can&#x27;t do chown and owners of mounted volumes should be configured externally.</span></span><br><span class="line"><span class="comment"># We do that in advance at the begining of Dockerfile before any packages will be</span></span><br><span class="line"><span class="comment"># installed to prevent picking those uid / gid by some unrelated software.</span></span><br><span class="line"><span class="comment"># The same uid / gid (101) is used both for alpine and ubuntu.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&quot;s|http://archive.ubuntu.com|<span class="variable">$&#123;apt_archive&#125;</span>|g&quot;</span> /etc/apt/sources.list \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; groupadd -r clickhouse --gid=101 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; useradd -r -g clickhouse --uid=101 --home-dir=/var/lib/clickhouse --shell=/bin/bash clickhouse \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install --<span class="built_in">yes</span> --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">        ca-certificates \</span></span><br><span class="line"><span class="language-bash">        locales \</span></span><br><span class="line"><span class="language-bash">        tzdata \</span></span><br><span class="line"><span class="language-bash">        wget \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/* /var/cache/debconf /tmp/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> VERSION=<span class="string">&quot;25.1.3.23&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> single_binary_location_url=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install from a single binary</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;single_binary_location_url&#125;</span>&quot;</span> ]; <span class="keyword">then</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="built_in">echo</span> <span class="string">&quot;installing from single binary url: <span class="variable">$&#123;single_binary_location_url&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">rm</span> -rf /tmp/clickhouse_binary \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">mkdir</span> -p /tmp/clickhouse_binary \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; wget --progress=bar:force:noscroll <span class="string">&quot;<span class="variable">$&#123;single_binary_location_url&#125;</span>&quot;</span> -O /tmp/clickhouse_binary/clickhouse \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">chmod</span> +x /tmp/clickhouse_binary/clickhouse \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; /tmp/clickhouse_binary/clickhouse install --user <span class="string">&quot;clickhouse&quot;</span> --group <span class="string">&quot;clickhouse&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        &amp;&amp; <span class="built_in">rm</span> -rf /tmp/* ; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">fi</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The rest is the same in the official docker and in our build system</span></span><br><span class="line"><span class="comment">#docker-official-library:on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># post install</span></span><br><span class="line"><span class="comment"># we need to allow &quot;others&quot; access to clickhouse folder, because docker container</span></span><br><span class="line"><span class="comment"># can be started with arbitrary uid (openshift usecase)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> clickhouse-local -q <span class="string">&#x27;SELECT * FROM system.build_options&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mkdir</span> -p /var/lib/clickhouse /var/log/clickhouse-server /etc/clickhouse-server /etc/clickhouse-client \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> ugo+Xrw -R /var/lib/clickhouse /var/log/clickhouse-server /etc/clickhouse-server /etc/clickhouse-client</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> locale-gen en_US.UTF-8</span></span><br><span class="line"><span class="keyword">ENV</span> LANG=en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=UTC</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /docker-entrypoint-initdb.d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker_related_config.xml /etc/clickhouse-server/config.d/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> entrypoint.sh /entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">9000</span> <span class="number">8123</span> <span class="number">9009</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /var/lib/clickhouse</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> CLICKHOUSE_CONFIG=/etc/clickhouse-server/config.xml</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥æ‹·è´äºŒè¿›åˆ¶è¿›å»æ‰§è¡Œ clickhouse install ä¼šé€ æˆ overlay diff æµªè´¹ï¼Œæ‰€ä»¥éœ€è¦èµ·ä¸€ä¸ª web ä¸‹è½½ï¼Œç¼–è¯‘å®¹å™¨é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RANDOM_PORT=50358</span><br><span class="line">docker run -d --name ck -v <span class="variable">$PWD</span>/build_results:/usr/share/nginx/html/ \</span><br><span class="line">    -p 50358:80 \</span><br><span class="line">    m.daocloud.io/docker.io/library/nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> docker/server/</span><br><span class="line">docker build . --build-arg version=<span class="string">&quot;23.8.16.40&quot;</span> --network host \</span><br><span class="line">  --build-arg single_binary_location_url=http://127.0.0.1:50358/clickhouse \</span><br><span class="line">   -t clickhouse/clickhouse-server:23.8.16.40 -f Dockerfile.fix</span><br></pre></td></tr></table></figure><h3 id="ä¸€äº›å…¶ä»–ä¿¡æ¯"><a href="#ä¸€äº›å…¶ä»–ä¿¡æ¯" class="headerlink" title="ä¸€äº›å…¶ä»–ä¿¡æ¯"></a>ä¸€äº›å…¶ä»–ä¿¡æ¯</h3><p><code>clickhouse/binary-builder</code> æ–°ç‰ˆæœ¬çš„ tag ä¼¼ä¹ä¸æ˜¯ commidID äº†ï¼Œæ‰¾äº†ä¸‹ä¸€äº›ç‰ˆæœ¬ tag å’Œ clang å¯¹åº”ï¼š</p><ul><li>dd5e777b6745 18</li><li>54187-e143a9039ba36ad0c25f2ed85503f36e88f61063 16</li></ul><p>å®˜æ–¹å’Œç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ file ä¿¡æ¯å¯¹æ¯”ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, <span class="keyword">for</span> GNU/Linux 3.7.0, BuildID[sha1]=3e70066de2db0f08f97ca310827184d61111dc22, not stripped</span><br><span class="line">clickhouse: ELF 64-bit LSB shared object, ARM aarch64, version 1 (SYSV), dynamically linked (uses shared libs), <span class="keyword">for</span> GNU/Linux 3.7.0, BuildID[sha1]=586fe5a059c988b60f99dcd794e68f0e4cf69619, not stripped</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢å…¶ä»–ç‰ˆæœ¬çš„æ—¶å€™è¦å¤„ç†ä¸‹å­æ¨¡å—ï¼Œç›¸å…³å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --recursive --checkout</span><br><span class="line"></span><br><span class="line">git submodule foreach --recursive git reset --hard</span><br><span class="line">git submodule update  --recursive</span><br></pre></td></tr></table></figure><p>åˆ‡ç‰ˆæœ¬è¿˜è¦è®°å¾—æ¸…ç† <code>build_docker</code> ç›®å½•</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>å…¶å®ä¹Ÿæ²¡å‚è€ƒå¤šå°‘ï¼Œå°±æ˜¯è¿™äº›æ˜¯èƒ½æœåˆ°çš„ arm64 ç¼–è¯‘ç›¸å…³</p><ul><li><a href="https://clickhouse.com/docs/en/development/build#building-in-docker">https://clickhouse.com/docs/en/development/build#building-in-docker</a></li><li><a href="http://www.shadow-li.com.cn/kunpeng/">http://www.shadow-li.com.cn/kunpeng/</a></li><li><a href="https://blog.csdn.net/pzz490/article/details/103574403">https://blog.csdn.net/pzz490/article/details/103574403</a></li><li><a href="https://www.bookstack.cn/read/clickhouse-20.3-en/a6fe877844d4f2ad.md">https://www.bookstack.cn/read/clickhouse-20.3-en/a6fe877844d4f2ad.md</a></li><li><a href="https://programmersought.com/article/22059609594/">https://programmersought.com/article/22059609594/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;clickhouse å®˜æ–¹ docker é•œåƒæ— æ³•åœ¨è€çš„ arm64 cpu ä¸Šè¿è¡Œï¼Œéœ€è¦ç¼–è¯‘&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="arm64" scheme="http://zhangguanzhang.github.io/tags/arm64/"/>
    
    <category term="clickhouse" scheme="http://zhangguanzhang.github.io/tags/clickhouse/"/>
    
  </entry>
  
  <entry>
    <title>docker login hang</title>
    <link href="http://zhangguanzhang.github.io/2025/01/08/docker-login-hang/"/>
    <id>http://zhangguanzhang.github.io/2025/01/08/docker-login-hang/</id>
    <published>2025-01-08T17:10:30.000Z</published>
    <updated>2025-01-08T17:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>docker login å’Œ pod æ‹‰å–é•œåƒéå¸¸æ…¢çš„æ’æŸ¥</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ç°åœºå®¢æˆ·å•æœºæµ‹è¯•ç¯å¢ƒï¼Œåé¦ˆ docker login å’Œ docker pull å’Œ pod æ‹‰å–é•œåƒéå¸¸æ…¢ï¼Œç°åœºå¤§è‡´æŸ¥äº†ä¸‹æŸ¥ä¸å‡ºæ¥åæˆ‘ä¸Šå»è¿œç¨‹æŸ¥äº†ä¸‹ã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p>æˆ‘ä»¬ç§æœ‰åŒ–éƒ½ä¼šéƒ¨ç½²ä¸€ä¸ªé•œåƒä»“åº“çš„ï¼Œé•œåƒéƒ½æ¨é€åˆ°ä»“åº“ä¸Šï¼Œç°åœºè¯´æ‹‰å–é•œåƒå¾ˆæ…¢å’Œ docker login å¾ˆæ…¢</p><h3 id="ç¯å¢ƒä¿¡æ¯"><a href="#ç¯å¢ƒä¿¡æ¯" class="headerlink" title="ç¯å¢ƒä¿¡æ¯"></a>ç¯å¢ƒä¿¡æ¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/redhat-release </span><br><span class="line">Red Hat Enterprise Linux Server release 7.8 (Maipo)</span><br><span class="line">$ uname -a</span><br><span class="line">Linux poc-xxxx 3.10.0-1127.el7.x86_64 #1 SMP Tue Feb 18 16:39:12 EST 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><h3 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>ä¸Šå»çœ‹äº†ä¸‹ï¼Œlogin éå¸¸æ…¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u xxx -p xxxx reg.xxx.lan:5000</span><br></pre></td></tr></table></figure><p>strace çœ‹çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ strace docker login -u xxx -p xxxx reg.xxx.lan:5000</span><br><span class="line">...</span><br><span class="line">write(3, &quot;HEAD /_ping HTTP/1.1\r\nHost: api.&quot;..., 92) = 92</span><br><span class="line">futex(0xc000700148, FUTEX_WAKE_PRIVATE, 1) = 1</span><br><span class="line">futex(0x1ac5448, FUTEX_WAIT_PRIVATE, 0, NULLWARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">) = 0</span><br><span class="line">futex(0x1ac5448, FUTEX_WAIT_PRIVATE, 0, NULL) = 0</span><br><span class="line">futex(0x1ac5448, FUTEX_WAIT_PRIVATE, 0, NULL) = 0</span><br></pre></td></tr></table></figure><p>å‘ç°å¡åœ¨ä¸Šé¢ï¼Œä½†æ˜¯ curl å‘ä¸‹ HEAD è¯·æ±‚æ­£å¸¸ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -v reg.xxx.lan:5000/_ping -I</span></span><br><span class="line">* About to connect() to reg.xxx.lan port 5000 (#0)</span><br><span class="line">*   Trying 7.xx.x.125...</span><br><span class="line">* Connected to reg.xxx.lan (7.xx.x.125) port 5000 (#0)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET /_ping HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: reg.xxx.lan:5000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 404 Not Found</span></span><br><span class="line">&lt; Content-Type: text/plain; charset=utf-8</span><br><span class="line">&lt; Docker-Distribution-Api-Version: registry/2.0</span><br><span class="line">&lt; X-Content-Type-Options: nosniff</span><br><span class="line">&lt; Date: Wed, 08 Jan 2025 07:05:33 GMT</span><br><span class="line">&lt; Content-Length: 19</span><br><span class="line">&lt;</span><br><span class="line">404 page not found</span><br><span class="line">* Connection #0 to host reg.xxx.lan left intact</span><br></pre></td></tr></table></figure><p>ç„¶åè®©å®¢æˆ·å‡†å¤‡ç¬¬äºŒå°æœºå™¨åªå®‰è£…åŒæ ·çš„ docker ç‰ˆæœ¬ ï¼Œä¸Šå» docker login å°±å¾ˆå¿«ï¼Œæ’é™¤æ‰é•œåƒä»“åº“é—®é¢˜ã€‚çœ‹äº†ä¸‹è¿™å—ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/moby/moby/blob/6c523afaedcbb2e3e219dbf4d417efad5b9397b3/client/ping.go#L21</span><br></pre></td></tr></table></figure><p>å‘ç°ä»£ç é€»è¾‘ä¹Ÿæ²¡å•¥é€»è¾‘é—®é¢˜ï¼Œå…ˆå‘ HEAD è¯·æ±‚æœ‰é—®é¢˜å†å°è¯• GET è¯·æ±‚ã€‚æœºå™¨ä¸Šçœ‹äº†ä¸‹ä¹Ÿæ²¡å®‰å…¨è½¯ä»¶å•¥çš„ã€‚æœ€åå°è¯•ä¸‹ 127 è®¿é—®è¯•è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u xxx -p xxxx 127.0.0.1:5000</span><br></pre></td></tr></table></figure><p>å‘ç°å¾ˆå¿«ï¼Œæ„Ÿè§‰ä¸ä¼šæ˜¯ hosts è§£æç›¸å…³å§ï¼Œ<code>tcpdump -nn -i ens224 port 53 -v | grep -A2 reg.xxx.lan</code> çœ‹äº†ä¸‹æœç„¶å‘å¾€å¤–é¢äº†ã€‚æŸ¥çœ‹ä¸‹ <code>/etc/nsswitch.conf</code> å‘ç°æœç„¶è¢«ä¿®æ”¹äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep hosts /etc/nsswitch.conf</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">hosts:     db files nisplus nis dns</span></span><br><span class="line">hosts:      dns files myhostname</span><br></pre></td></tr></table></figure><p>æ”¹å›å°±æ­£å¸¸äº†ï¼Œè¯¢é—®å®¢æˆ·æ²¡æœ‰äººæ”¹ï¼Œåº”è¯¥æ˜¯ä»–ä»¬åˆ¶ä½œè™šæœºæ¨¡æ¿æ—¶å€™ä¿®æ”¹çš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;docker login å’Œ pod æ‹‰å–é•œåƒéå¸¸æ…¢çš„æ’æŸ¥&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="net" scheme="http://zhangguanzhang.github.io/tags/net/"/>
    
  </entry>
  
  <entry>
    <title>inotifywait å’Œ confd åœ¨ä¸€èµ·è¸©çš„å‘</title>
    <link href="http://zhangguanzhang.github.io/2024/11/24/inotifywait-and-confd/"/>
    <id>http://zhangguanzhang.github.io/2024/11/24/inotifywait-and-confd/</id>
    <published>2024-11-24T20:10:30.000Z</published>
    <updated>2024-11-24T20:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•æœ€è¿‘ç¢°åˆ°çš„ä¸€æ¬¡ confd å’Œ inotifywait é…åˆè¸©çš„å‘</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ç‰ˆæœ¬å¿«å‘ç‰ˆçš„æ—¶å€™ï¼Œæµ‹è¯•æµ‹å‡ºæ¥ç»å¸¸éƒ¨ç½²åº”ç”¨é˜¶æ®µ sql åˆå§‹åŒ–æœåŠ¡å¶ç°è¿æ¥æ•°æ®åº“ mysql è¶…æ—¶ï¼Œå¯¼è‡´æ²¡æœ‰åˆ›å»ºåº“æˆ–è€…è¡¨ï¼Œè€Œä¸šåŠ¡åŠŸèƒ½ä¸æ­£å¸¸ã€‚ç„¶åä¸´è¿‘å‘ç‰ˆæµ‹è¯•äººå‘˜ä¸ŠæŠ¥äº†é«˜é£é™©ã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="æ’æŸ¥"><a href="#æ’æŸ¥" class="headerlink" title="æ’æŸ¥"></a>æ’æŸ¥</h3><p>å¤ç°éå¸¸éº»çƒ¦ï¼Œä¸æ˜¯ä¸€ç›´è¶…æ—¶æ˜¯å¶å…ˆã€‚æ²¡åŠæ³•è¯¢é—®äº† sql åˆå§‹åŒ–ä¸šåŠ¡çš„å¼€å‘äººå‘˜ï¼Œå’Œå¤šä¸ªç¯å¢ƒå¾—åˆ°ä»¥ä¸‹å¯¹æ¯”ä¿¡æ¯ï¼š</p><ul><li>æœ€è¿‘æ— æ”¹åŠ¨ï¼Œåˆå§‹åŒ–æœåŠ¡å›é€€åˆ°ä¸Šä¸ªç‰ˆæœ¬ä¾æ—§</li><li>æ¯æ¬¡è¶…æ—¶æ˜¯ä¸åŒçš„åº“ï¼Œå¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œæ…¢ sql çœ‹äº†æ²¡æœ‰</li><li>k8s&#x2F;docker éƒ¨ç½²å‡ä¼šå‘ç”Ÿ</li></ul><p>å°±åœ¨ä¸€ç­¹è«å±•ä¹‹é™…ï¼Œå¦ä¸€ä¸ªéƒ¨é—¨çš„æµ‹è¯•äººå‘˜æ‰¾è¿‡æ¥ï¼Œä»–ä»¬éƒ¨ç½²åï¼Œæµè§ˆå™¨ä¸Šæµ‹è¯•å¾ˆå¤šæ¥å£æŠ¥é”™è¶…æ—¶ï¼ˆä¸»è¦æ˜¯å†…éƒ¨æ¶‰åŠåˆ°çš„è°ƒç”¨é“¾é•¿ï¼‰ï¼Œæœ‰äº†ç¨³å®šå¤ç°çš„ç¯å¢ƒçœŸå¥½ã€‚ä¸Šå»æ’æŸ¥äº†ä¸‹ï¼Œå‘ç° ipset çš„æ¡ç›®è¢«é¢‘ç¹æ¸…ç©ºå’Œåˆ›å»ºå¯¼è‡´çš„ã€‚</p><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>æˆ‘ä»¬ toB å’Œ toG ä¸ºäº†é¿å…å®¢æˆ·ç°åœºæ¼æ‰«å’Œå®‰å…¨ç›¸å…³ï¼Œæ¯å°æœºå™¨èµ·äº†å®¹å™¨ï¼Œåˆ©ç”¨ ipset å’Œ iptables åšç™½åå•ç«¯å£ç­–ç•¥ã€‚ç›¸å…³è§„åˆ™ä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -w -N BASE-RULE</span><br><span class="line">iptables -w -A BASE-RULE -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -w -A BASE-RULE -m set ! --match-set whiteiplist src -m set  --match-set whiteportlist dst -j DROP</span><br><span class="line">iptables -w -A BASE-RULE -j RETURN</span><br><span class="line">iptables -A INPUT -j BASE-RULE</span><br></pre></td></tr></table></figure><p>é»˜è®¤è¡Œä¸ºæ˜¯ DROPï¼Œä¹Ÿå°±æ˜¯ç™½åå•å®ç°ã€‚åœ¨æ¯ä¸ªèŠ‚ç‚¹æœºå™¨éƒ½éƒ¨ç½²æœ‰ ipset å®¹å™¨ï¼Œå†…éƒ¨ <code>entrypoint.sh</code> å†…å®¹å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exec inotifywait -mrq \</span><br><span class="line">    --timefmt &#x27;%d/%m/%y/%H:%M&#x27; \</span><br><span class="line">    --format &#x27;%T %w %f&#x27; \</span><br><span class="line">    -e modify,delete,close_write,move /data/kube/ | while read line;do</span><br><span class="line">        bash /iptables.sh</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><code>/iptables.sh</code> å†…éƒ¨å°±æ˜¯æ£€æŸ¥é“¾å’Œæ¯æ¬¡æ¸…ç©º ipset æ¡ç›®å’Œåˆ›å»ºã€‚ä¹‹å‰çš„é€»è¾‘æ˜¯ ansible åˆ†å‘ rule æ–‡ä»¶ï¼Œä¸Šä¸ªç‰ˆæœ¬è¢«å…¶ä»–åŒäº‹ä¿®æ”¹æˆä½¿ç”¨ confd ä» redis å†…è¯»å–æ›´æ–°åˆ°è¯¥æ–‡ä»¶ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># confd å®¹å™¨å†…ç›®å½•</span></span><br><span class="line"><span class="section">[template]</span></span><br><span class="line"><span class="attr">src</span> = <span class="string">&quot;ipsets-whiteiplist.tmpl&quot;</span></span><br><span class="line"><span class="attr">dest</span> = <span class="string">&quot;/root/kube/rule/whiteiplist.txt&quot;</span>  <span class="comment"># é…ç½®æ–‡ä»¶åœ°å€</span></span><br><span class="line"><span class="attr">keys</span> = [                 <span class="comment"># ç›‘å¬çš„key</span></span><br><span class="line">    <span class="string">&quot;/ipsets/whiteiplist&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/ipsets/mark&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="æ ¹æº"><a href="#æ ¹æº" class="headerlink" title="æ ¹æº"></a>æ ¹æº</h3><p>ç„¶åæˆ‘åœ¨ ipset å®¹å™¨å†…ä½¿ç”¨ inotifywait è§‚å¯Ÿäº†ä¸‹å‘ç°ä¸€ç›´äº§ç”Ÿä¸´æ—¶æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">inotifywait -mrq     --timefmt <span class="string">&#x27;%d/%m/%y/%H:%M&#x27;</span>     --format <span class="string">&#x27;%T %w %f&#x27;</span> -e modify,delete,close_write,move /data/kube/</span></span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br><span class="line">26/11/24/14:51 /data/kube/ .whiteportlist.txt3298417101</span><br></pre></td></tr></table></figure><p>çœ‹è¿™ä¸ªæ–‡ä»¶åå°±æ˜¯ confd ç”Ÿæˆçš„å¯¹æ¯”ä¸´æ—¶æ–‡ä»¶ï¼ŒæŸ¥çœ‹äº†ä¸‹æ–‡æ¡£å¹¶æ²¡æœ‰å‘ç°æœ‰è®¾ç½®ä¸´æ—¶æ–‡ä»¶çš„ dir ç›¸å…³å‚æ•°ï¼Œç„¶åæ‰¾åˆ°äº†ç›¸å…³é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/kelseyhightower/confd/blob/master/resource/template/resource.go#L138</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TemplateResource)</span></span> createStageFile() <span class="type">error</span> &#123;</span><br><span class="line">log.Debug(<span class="string">&quot;Using source template &quot;</span> + t.Src)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !util.IsFileExist(t.Src) &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;Missing template: &quot;</span> + t.Src)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log.Debug(<span class="string">&quot;Compiling source template &quot;</span> + t.Src)</span><br><span class="line"></span><br><span class="line">tmpl, err := template.New(filepath.Base(t.Src)).Funcs(t.funcMap).ParseFiles(t.Src)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Unable to process template %s, %s&quot;</span>, t.Src, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create TempFile in Dest directory to avoid cross-filesystem issues</span></span><br><span class="line">temp, err := ioutil.TempFile(filepath.Dir(t.Dest), <span class="string">&quot;.&quot;</span>+filepath.Base(t.Dest))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err = tmpl.Execute(temp, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">temp.Close()</span><br><span class="line">os.Remove(temp.Name())</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> temp.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the owner, group, and mode on the stage file now to make it easier to</span></span><br><span class="line"><span class="comment">// compare against the destination configuration file later.</span></span><br><span class="line">os.Chmod(temp.Name(), t.FileMode)</span><br><span class="line">os.Chown(temp.Name(), t.Uid, t.Gid)</span><br><span class="line">t.StageFile = temp</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TemplateResource)</span></span> sync() <span class="type">error</span> &#123;</span><br><span class="line">staged := t.StageFile.Name()</span><br><span class="line"><span class="keyword">if</span> t.keepStageFile &#123;</span><br><span class="line">log.Info(<span class="string">&quot;Keeping staged file: &quot;</span> + staged)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> os.Remove(staged)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯è¿™è¡Œ <code>ioutil.TempFile(filepath.Dir(t.Dest), &quot;.&quot;+filepath.Base(t.Dest))</code> ç›¸å½“äº <code>ç›®å½•ä¸‹ + .æ–‡ä»¶åå­— + TempFileéšæœºåç¼€</code>ï¼Œåœ¨ä¸‹é¢çš„ sync æ–¹æ³•é‡Œå¯¹æ¯”åå†åˆ æ‰ stageFileã€‚</p><p>ä»æºç äº†è§£åˆ°å¹¶æ²¡æœ‰ç›¸å…³ StageFileDir å‚æ•°ï¼Œæ²¡åŠæ³•è®©åŒäº‹æŠŠæ–‡ä»¶æ”¾å…¶ä»–åœ°æ–¹ï¼Œ åœ¨ reload_cmd cp è¿‡å»ï¼Œå¤§æ¦‚ç±»ä¼¼è¿™æ ·ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[template]</span></span><br><span class="line"><span class="attr">src</span> = <span class="string">&quot;ipsets-whiteiplist.tmpl&quot;</span></span><br><span class="line"><span class="attr">dest</span> = <span class="string">&quot;/root/kube/whiteiplist.txt&quot;</span>  <span class="comment"># é…ç½®æ–‡ä»¶åœ°å€</span></span><br><span class="line"><span class="attr">keys</span> = [                 <span class="comment"># ç›‘å¬çš„key</span></span><br><span class="line">    <span class="string">&quot;/ipsets/whiteiplist&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/ipsets/mark&quot;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="attr">check_cmd</span> = <span class="string">&quot;&quot;</span>    <span class="comment"># æœåŠ¡é…ç½®æ£€æŸ¥å‘½ä»¤</span></span><br><span class="line"><span class="attr">reload_cmd</span> = <span class="string">&quot;cp -f /root/kube/whiteiplist.txt /root/kube/rule/whiteiplist.txt&quot;</span> </span><br></pre></td></tr></table></figure><h3 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h3><p>é‡å†™äº†é‚£ä¸ª while å†…è¿‡æ»¤æ‰.å¼€å¤´çš„æ–‡ä»¶ï¼Œç„¶å ipset æ¸…ç©ºé€»è¾‘ä½¿ç”¨ swap æ–¹å¼ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•æœ€è¿‘ç¢°åˆ°çš„ä¸€æ¬¡ confd å’Œ inotifywait é…åˆè¸©çš„å‘&lt;/p&gt;</summary>
    
    
    
    
    <category term="ipset" scheme="http://zhangguanzhang.github.io/tags/ipset/"/>
    
    <category term="iptables" scheme="http://zhangguanzhang.github.io/tags/iptables/"/>
    
    <category term="inotifywait" scheme="http://zhangguanzhang.github.io/tags/inotifywait/"/>
    
    <category term="confd" scheme="http://zhangguanzhang.github.io/tags/confd/"/>
    
  </entry>
  
  <entry>
    <title>hostPort ä¸é€šæ’æŸ¥ï¼Œä»¥åŠæŒ–æ˜é—®é¢˜æ ¹æº</title>
    <link href="http://zhangguanzhang.github.io/2024/09/16/hostPort-problem/"/>
    <id>http://zhangguanzhang.github.io/2024/09/16/hostPort-problem/</id>
    <published>2024-09-16T18:10:30.000Z</published>
    <updated>2024-09-16T18:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•æœ€è¿‘ç¢°åˆ°çš„ä¸€æ¬¡ hostPort ä¸é€šæ’æŸ¥çš„ä¿¡æ¯è®°å½•</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å†…éƒ¨æœ‰æœåŠ¡é€šè¿‡ hostPort æš´æ¼çš„ï¼Œä¹‹å‰æ¯æ¬¡å‡ºé—®é¢˜éƒ½æ˜¯æœ‰äººå»æ¸…ç†ç›¸å…³ï¼Œè¿™æ¬¡å®Œæ•´è®°å½•ä¸‹æˆ‘å¤„ç†è¿‡ç¨‹</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="iptables-ç›¸å…³"><a href="#iptables-ç›¸å…³" class="headerlink" title="iptables ç›¸å…³"></a>iptables ç›¸å…³</h3><p>åªæœ‰ä¸€ä¸ªæœåŠ¡ hostPort æš´æ¼çš„ï¼Œæµ‹è¯•åé¦ˆéƒ¨ç½²äº†åæ— æ³•è®¿é—®ï¼ŒæŸ¥çœ‹äº†ä¸‹ iptables çš„ nat è¡¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t nat -S CNI-HOSTPORT-DNAT</span></span><br><span class="line">-N CNI-HOSTPORT-DNAT</span><br><span class="line">-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment &quot;dnat name: \&quot;cbr0\&quot; id: \&quot;fb7cdb0a4f8da673da0a9818ec9a1576f953a8e8decf87a081827c11e4aa7138\&quot;&quot; \</span><br><span class="line">   -m multiport --dports 443,9001,80,9002,9003,19004,19003,50051,25,465,993,995,7010,7020,12321 -j CNI-DN-b24a4eb3a38dc5843c23a</span><br><span class="line">-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment &quot;dnat name: \&quot;cbr0\&quot; id: \&quot;fb7cdb0a4f8da673da0a9818ec9a1576f953a8e8decf87a081827c11e4aa7138\&quot;&quot; \</span><br><span class="line">   -m multiport --dports 10001 -j CNI-DN-b24a4eb3a38dc5843c23a</span><br><span class="line">-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment &quot;dnat name: \&quot;cbr0\&quot; id: \&quot;0961bad27f1a52a28701b7038120b8188e7a78df21f57a08428f021ab3c071e2\&quot;&quot; \</span><br><span class="line">   -m multiport --dports 443,9001,80,9002,9003,19004,19003,50051,25,465,993,995,7010,7020,12321 -j CNI-DN-f2390ee4e08c581b1ea73</span><br><span class="line">-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment &quot;dnat name: \&quot;cbr0\&quot; id: \&quot;0961bad27f1a52a28701b7038120b8188e7a78df21f57a08428f021ab3c071e2\&quot;&quot; \</span><br><span class="line">   -m multiport --dports 10001 -j CNI-DN-f2390ee4e08c581b1ea73</span><br></pre></td></tr></table></figure><p>ç›¸å…³ PodIPï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod -o wide | grep xxxx-gateway</span></span><br><span class="line">xxxx-gateway-55fc694d76-rbxc7                   1/1     Running     0               3h53m   10.187.2.34   xxx.xx.xx.26   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>è€Œä¸¤ä¸ª CNI-DN é“¾çš„æœ€ç»ˆ IP ä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t nat -S CNI-DN-b24a4eb3a38dc5843c23a | grep -m1 to-destination</span></span><br><span class="line">-A CNI-DN-b24a4eb3a38dc5843c23a -p tcp -m tcp --dport 443 -j DNAT --to-destination 10.187.2.36:443</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t nat -S CNI-DN-f2390ee4e08c581b1ea73 | grep -m1 to-destination</span></span><br><span class="line">-A CNI-DN-f2390ee4e08c581b1ea73 -p tcp -m tcp --dport 443 -j DNAT --to-destination 10.187.2.34:443</span><br></pre></td></tr></table></figure><p>åè€…çš„æ‰æ˜¯å®é™…çš„ PodIPï¼Œå‰è€…çš„æ˜¯æ²¡æ¸…ç†çš„ï¼Œé€šè¿‡ cni plugin æ–‡ä»¶ä¹Ÿå¯ä»¥ç¡®è®¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /var/lib/cni/networks/cbr0/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -l fb7cdb0a *</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -l 0961bad27f *</span></span><br><span class="line">10.187.2.34</span><br></pre></td></tr></table></figure><p>å…ˆåŒ¹é…åˆ°ç¬¬ä¸€ä¸ªä¸å­˜åœ¨ Pod çš„ <code>CNI-DN-b24a4eb3a38dc5843c23a</code> å¯¼è‡´ dnat åˆ°ä¸å­˜åœ¨çš„ PodIP è€Œæ— æ³•è®¿é—®åˆ°ã€‚æ¸…ç†æ‰å®ƒç›¸å…³å°±è¡Œã€‚ä½†æ˜¯æ ¹æºè¦æ’æŸ¥ã€‚</p><h2 id="æ’æŸ¥ç›¸å…³"><a href="#æ’æŸ¥ç›¸å…³" class="headerlink" title="æ’æŸ¥ç›¸å…³"></a>æ’æŸ¥ç›¸å…³</h2><p>æ ¹æ® cni é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/cni/net.d/10-flannel.conflist</span> </span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="line">  &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">      &quot;delegate&quot;: &#123;</span><br><span class="line">        &quot;hairpinMode&quot;: true,</span><br><span class="line">        &quot;isDefaultGateway&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">      &quot;capabilities&quot;: &#123;</span><br><span class="line">        &quot;portMappings&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çš„ cni-plugins åªæœ‰ flannel å’Œ portmapï¼Œportmap å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬ 1.5.1 äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">portmap --version</span></span><br><span class="line">CNI portmap plugin v1.5.1</span><br><span class="line">CNI protocol versions supported: 0.1.0, 0.2.0, 0.3.0, 0.3.1, 0.4.0, 1.0.0</span><br></pre></td></tr></table></figure><p>é›†ç¾¤å’Œå†…æ ¸ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">uname</span> -a</span></span><br><span class="line">Linux centos79 3.10.0-1160.el7.x86_64 #1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl  get node -o wide</span></span><br><span class="line">NAME          STATUS   ROLES         AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">xx.xx.xx.37   Ready    master,node   4h10m   v1.27.16   xx.xx.xx.37   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   docker://26.1.4</span><br><span class="line">xx.xx.xx.38   Ready    master,node   4h10m   v1.27.16   xx.xx.xx.38   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   docker://26.1.4</span><br><span class="line">xx.xx.xx.26   Ready    master,node   4h10m   v1.27.16   xx.xx.xx.26   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   docker://26.1.4</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚çœ‹äº†ä¸‹ cni-plugin çš„ portmap æºç ï¼Œæ·»åŠ å’Œåˆ é™¤é€»è¾‘éƒ½æ²¡é—®é¢˜ï¼Œåˆ é™¤çš„æ—¶å€™æ£€æµ‹é“¾å­˜åœ¨å¦ï¼Œå­˜åœ¨å°±åˆ é™¤ï¼Œä¸å­˜åœ¨åˆ™è·³è¿‡ã€‚æ˜¯ container runtime è°ƒç”¨çš„ cni-pluginsï¼ŒæŒ‰ç…§å‰é¢ iptables çš„æ³¨é‡Šé‡Œçš„å®¹å™¨ ID æŸ¥çœ‹ä¸‹ cri-dockerd æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xe --no-pager -u cri-dockerd | grep fb7cdb0a4f8da</span></span><br><span class="line">9æœˆ 14 11:39:49 centos79 cri-dockerd[9246]: &#123;&quot;cniVersion&quot;:&quot;0.3.1&quot;,&quot;hairpinMode&quot;:true,&quot;ipMasq&quot;:false,&quot;ipam&quot;:&#123;&quot;ranges&quot;:[[&#123;&quot;subnet&quot;:&quot;10.187.2.0/24&quot;&#125;]],&quot;routes&quot;:[&#123;&quot;dst&quot;:&quot;10.187.0.0/16&quot;&#125;],&quot;type&quot;:&quot;host-local&quot;&#125;,&quot;isDefaultGateway&quot;:true,&quot;isGateway&quot;:true,&quot;mtu&quot;:1450,&quot;name&quot;:&quot;cbr0&quot;,&quot;type&quot;:&quot;bridge&quot;&#125;time=&quot;2024-09-14T11:39:49+08:00&quot; level=info msg=&quot;Will attempt to re-write config file /data/kube/docker/containers/fb7cdb0a4f8da673da0a9818ec9a1576f953a8e8decf87a081827c11e4aa7138/resolv.conf as [nameserver 10.186.0.2 search default123.svc.cluster1.local. svc.cluster1.local. cluster1.local. options ndots:5]&quot;</span><br></pre></td></tr></table></figure><p>è·³è½¬çš„é“¾åå­— <code>CNI-DN-XXX</code> çœ‹äº†ä¸‹ portmap æºç æ˜¯æ ¹æ® åå­—+ å®¹å™¨ID sha512 ç”Ÿæˆçš„ï¼Œæ‰‹åŠ¨è®¡ç®—å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">&#x27;cbr0fb7cdb0a4f8da673da0a9818ec9a1576f953a8e8decf87a081827c11e4aa7138&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">   | <span class="built_in">sha512sum</span> | <span class="built_in">cut</span> -c 1-21</span></span><br><span class="line">b24a4eb3a38dc5843c23a</span><br></pre></td></tr></table></figure><p>è¯´æ˜ç¡®å®æ˜¯è¿™ä¸ªå®¹å™¨ã€‚çœ‹äº†ä¸‹ portmap æºç ä½¿ç”¨çš„ iptables åº“å°è£…çš„å‘½ä»¤é€‰é¡¹æ˜¯æœ‰å¸¦ <code>--wait</code> é€‰é¡¹çš„ï¼Œå³ä½¿ iptables æ•°é‡å¤šä¹Ÿæ²¡é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -w -t nat -S | <span class="built_in">wc</span> -l</span></span><br><span class="line">1705</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -w -t nat -S | grep -Pv <span class="string">&#x27;KUBE-SVC|KUBE-SEP&#x27;</span> | <span class="built_in">wc</span> -l</span></span><br><span class="line">180</span><br></pre></td></tr></table></figure><p>ç†è®ºä¸Šå‘ç”Ÿçš„å¯èƒ½æ€§æ˜¯ cri-dockerd æ¸…ç†æ‰è€ Pod çš„æ—¶å€™æ²¡æ¸…ç†ï¼Œä½†æ˜¯çœ‹ä»£ç æ˜¯æœ‰æ¸…ç†çš„ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/Mirantis/cri-dockerd/blob/v0.3.14/core/sandbox_stop.go#L87-L92</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ds *dockerService)</span></span> StopPodSandbox(</span><br><span class="line">   ...</span><br><span class="line">ready, ok := ds.getNetworkReady(podSandboxID)</span><br><span class="line"><span class="keyword">if</span> !hostNetwork &amp;&amp; (ready || !ok) &#123;</span><br><span class="line"><span class="comment">// Only tear down the pod network if we haven&#x27;t done so already</span></span><br><span class="line">cID := config.BuildContainerID(runtimeName, podSandboxID)</span><br><span class="line">err := ds.network.TearDownPod(namespace, name, cID)</span><br></pre></td></tr></table></figure><p>æ¸…ç†çš„æ—¶å€™ä¼šæ‰“æ—¥å¿—ï¼Œä¹Ÿå­˜åœ¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ journalctl -xe --no-pager -u docker | grep fb7cdb0a4f8da</span><br><span class="line">9æœˆ 14 11:44:13 centos79 dockerd[2708]: time=&quot;2024-09-14T11:44:12.872235404+08:00&quot; level=warning msg=&quot;cleaning up after shim disconnected&quot; id=fb7cdb0a4f8da673da0a9818ec9a1576f953a8e8decf87a081827c11e4aa7138 namespace=moby</span><br></pre></td></tr></table></figure><p>è€ŒæŸ¥çœ‹éƒ¨ç½²æ—¥å¿—ï¼Œç›¸å…³æ—¶é—´ç‚¹ <code>11:44:13</code> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-09-14 11:44:02,249 - xxx INFO - å¼€å§‹å¸è½½docker...</span><br></pre></td></tr></table></figure><p>è¯¢é—®äº†ä¸‹æµ‹è¯•äººå‘˜ï¼Œè¯´è¿™ä¸ªæ—¶é—´ç‚¹æ‰§è¡Œäº†å¸è½½æ­¥éª¤ï¼Œæ‰€ä»¥æ•´ä¸ªé—®é¢˜æµç¨‹æ˜¯:</p><ul><li>æ‰§è¡Œå¸è½½æµç¨‹ï¼Œä¼šå…ˆkubectl delete åˆ æ‰æ‰€æœ‰èµ„æºï¼Œè§¦å‘ pod åˆ é™¤</li><li>kubelet è°ƒç”¨ cri-dockerd æ¸…ç†ä¸‹çº¿ç›¸å…³å®¹å™¨ï¼Œä½†æ˜¯åŒæ­¥çš„æˆ‘ä»¬å¸è½½æ­¥éª¤ä¼šåœæ­¢äº† docker å’Œåˆ äº† docker ç›®å½•</li><li>cri-dockerd æ¸…ç†è¿‡ç¨‹ä¸­è¿ä¸ä¸Š docker ï¼Œå¯¼è‡´ cri-dockerd æ¸…ç†å®¹å™¨çš„æ—¶å€™æ— æ³•æ‰§è¡Œå®Œæ•´çš„ <code>StopPodSandbox</code> æµç¨‹æ¸…ç†æ‰ nat è¡¨çš„ <code>CNI-HOSTPORT-DNAT</code> é“¾è§„åˆ™ã€‚</li><li>å¸è½½è¿‡ç¨‹ä¼šå®Œæˆåå†éƒ¨ç½²ç¯å¢ƒï¼Œæœ€å hostPort è€è§„åˆ™è¿˜åœ¨å…ˆåŒ¹é…</li></ul><p>é¿å…å°±æ˜¯å¸è½½ docker è¿‡ç¨‹ä¸­ï¼Œæ¸…ç†æ‰ nat è¡¨çš„ç›¸å…³è§„åˆ™ã€‚</p><h2 id="ç±»ä¼¼çš„æƒ…å†µ"><a href="#ç±»ä¼¼çš„æƒ…å†µ" class="headerlink" title="ç±»ä¼¼çš„æƒ…å†µ"></a>ç±»ä¼¼çš„æƒ…å†µ</h2><ul><li><a href="https://github.com/rancher/rke/issues/3440">Kube-proxy doesnâ€™t remove stale CNI-HOSTPORT-DNAT</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•æœ€è¿‘ç¢°åˆ°çš„ä¸€æ¬¡ hostPort ä¸é€šæ’æŸ¥çš„ä¿¡æ¯è®°å½•&lt;/p&gt;</summary>
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="hostPort" scheme="http://zhangguanzhang.github.io/tags/hostPort/"/>
    
    <category term="iptables" scheme="http://zhangguanzhang.github.io/tags/iptables/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ IPv6 å•æ ˆä¸‹é€‚é…éƒ¨ç½² K8Sã€ä¸­é—´ä»¶ã€åº”ç”¨é€‚é…</title>
    <link href="http://zhangguanzhang.github.io/2024/08/02/k8s-ipv6/"/>
    <id>http://zhangguanzhang.github.io/2024/08/02/k8s-ipv6/</id>
    <published>2024-08-02T18:10:30.000Z</published>
    <updated>2024-08-02T18:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•è¿‘æœŸ IPv6 å•æ ˆä¸‹ ä¸€äº›å‘</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>æœ‰å®¢æˆ·çš„ç¯å¢ƒæ˜¯ IPv6 å•æ ˆç¯å¢ƒï¼Œéœ€è¦éƒ¨ç½²æˆ‘ä»¬äº§å“ï¼Œè®°å½•ä¸‹é€‚é…é‡åˆ°çš„å‘ã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å†…éƒ¨çš„è™šæœºéƒ½æ˜¯åœ¨ esxi ä¸Šï¼Œè€Œåˆ°æˆ‘ä»¬åŠå…¬ç½‘å°å¼æœºåˆ° esxi çš„é“¾è·¯ä¸Šçš„äº¤æ¢æœºéƒ½ä¸æ”¯æŒ IPv6 è½¬å‘ã€‚ä½†æ˜¯è§†è§’æ”¾åœ¨åŒä¸€ä¸ª esxi host ä¸Šï¼Œä¸Šé¢çš„æ‰€æœ‰è™šæœºéƒ½æ˜¯åœ¨ esxi ä¸Šçš„ vswitch ä¸Šï¼Œvswitch æ˜¯ï¼ˆå†…æ ¸ï¼‰æ”¯æŒ IPv6 è½¬å‘çš„ã€‚æ‰€ä»¥åˆæ­¥çš„æ¨¡æ‹Ÿæ˜¯ä¸€ä¸ª esxi host ä¸Šå¼€ä¸‹é¢çš„å››å°æœºå™¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                                             </span><br><span class="line">IPv4+IPv6       IPv6      IPv6      IPv6      </span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”  </span><br><span class="line">â”‚      â”‚      â”‚       â”‚ â”‚       â”‚ â”‚       â”‚  </span><br><span class="line">â”‚      â”‚      â”‚       â”‚ â”‚       â”‚ â”‚       â”‚  </span><br><span class="line">â””â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜  </span><br><span class="line">   â”‚              â”‚         â”‚         â”‚      </span><br><span class="line">   â”‚              â”‚         â”‚         â”‚      </span><br><span class="line">   â”‚              â”‚         â”‚         â”‚      </span><br><span class="line">   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ </span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿˜æ¶‰åŠåˆ°åé¢çš„æµè§ˆå™¨è®¿é—®æµ‹è¯•ï¼Œæ‰€ä»¥å·¦è¾¹æ˜¯ Windows ï¼š</p><table><thead><tr><th>Os</th><th>IPv4</th><th>IPv6</th><th>æè¿°</th></tr></thead><tbody><tr><td>Windows</td><td>x.x.x.x</td><td><code>2002:db8:0:1::1/64</code></td><td>ä¹Ÿæ˜¯ä¸‹é¢ä¸‰å°æœºå™¨çš„ç½‘å…³</td></tr><tr><td>Centos 7.8</td><td></td><td><code>2002:db8:0:1::101/64</code></td><td></td></tr><tr><td>Centos 7.8</td><td></td><td><code>2002:db8:0:1::102/64</code></td><td></td></tr><tr><td>Centos 7.8</td><td></td><td><code>2002:db8:0:1::103/64</code></td><td></td></tr></tbody></table><p>ç½‘å¡é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">#IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">NAME=ens160</span><br><span class="line">UUID=8813b773-201c-4fe1-80b3-5ab62586xxxx</span><br><span class="line">DEVICE=ens160</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPV6_PRIVACY=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=no</span><br><span class="line">IPV6ADDR=2002:db8:0:1::101/64</span><br><span class="line">IPV6_DEFAULTGW=2002:db8:0:1::1</span><br></pre></td></tr></table></figure><p>centos7 è®°å¾—åˆ æ‰ <code>IPV6_ADDR_GEN_MODE=stable-privacy</code>ï¼Œä¸ç„¶æˆ‘å‘ç° IP ä¸ç”Ÿæ•ˆï¼Œwindows è®°å¾—å¼€ <code>æ–‡ä»¶å’Œæ‰“å°æœºå…±äº«(å›æ˜¾è¯·æ±‚)</code> çš„ ipv4 ipv6 ã€‚</p><h3 id="ç½‘å…³è·¯ç”±ç›¸å…³"><a href="#ç½‘å…³è·¯ç”±ç›¸å…³" class="headerlink" title="ç½‘å…³è·¯ç”±ç›¸å…³"></a>ç½‘å…³è·¯ç”±ç›¸å…³</h3><p>å‘ç°ä¸€äº›æœºå™¨é»˜è®¤è·¯ç”±æˆ–è€…äºŒå±‚è·¯ç”±åœ¨å¼€æœºå’Œé‡å¯åä¼šæ²¡æœ‰æ·»åŠ ï¼Œå½±å“æµ‹è¯•éƒ¨ç½²å•¥çš„ï¼Œä¸‹é¢æ˜¯ä¸€äº› os ä¸Šæ·»åŠ ç½‘å…³å’Œè·¯ç”±æ–¹å¼ï¼š</p><h4 id="netplan"><a href="#netplan" class="headerlink" title="netplan"></a>netplan</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">ens160:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">dhcp6:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.</span><span class="string">xx.xx.94/24</span></span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">10.</span><span class="string">xx.xx.1</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">10.</span><span class="string">xx.xx.1</span></span><br><span class="line">    <span class="attr">ens192:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">dhcp6:</span> <span class="literal">no</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">2408</span><span class="string">:8656:22df:ff01::14:fe02/119</span></span><br><span class="line">      <span class="attr">gateway6:</span> <span class="number">2408</span><span class="string">:8656:22df:ff01::14:fe01</span> <span class="comment"># åŒç«™æœºå™¨ä¸Šçš„å‡ç½‘å…³</span></span><br></pre></td></tr></table></figure><p>å…¶ä»– ipv6 å•æ ˆæœºå™¨æ·»åŠ è·¯ç”±å¯ä»¥ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">      <span class="attr">routes:</span>    <span class="comment"># è®¾ç½®é»˜è®¤è·¯ç”±è½¬å‘, å½“ç„¶ä¹Ÿå¯ä»¥å†™å¤šä¸ªçš„</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&quot;::/0&quot;</span></span><br><span class="line">         <span class="attr">via:</span> <span class="string">&quot;2408:8656:22df:ff01::14:fe02&quot;</span>    <span class="comment"># åŒæ ˆæœºå™¨ipv6åœ°å€</span></span><br><span class="line">         <span class="attr">on-link:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="x2F-etc-x2F-network-x2F-interfaces"><a href="#x2F-etc-x2F-network-x2F-interfaces" class="headerlink" title="&#x2F;etc&#x2F;network&#x2F;interfaces"></a>&#x2F;etc&#x2F;network&#x2F;interfaces</h4><p>ubuntu <code>/etc/network/interfaces</code> æ·»åŠ é»˜è®¤è·¯ç”±å’ŒäºŒå±‚è·¯ç”±å‚è€ƒï¼ˆç½‘å…³è‡ªå·±æŸ¥æ‰¾æ­£ç¡®çš„ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">auto eth0</span><br><span class="line">allow-hotplug eth0</span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line">up ip -6 route add default via fe80::ecff:ffff:feff:ffff dev eth0</span><br><span class="line">up ip -6 route add 2401:xxxx:xxx:xxxx::/64 dev eth0</span><br></pre></td></tr></table></figure><h4 id="yum-ç³»åˆ—ç½‘å…³è·¯ç”±é…ç½®"><a href="#yum-ç³»åˆ—ç½‘å…³è·¯ç”±é…ç½®" class="headerlink" title="yum ç³»åˆ—ç½‘å…³è·¯ç”±é…ç½®"></a>yum ç³»åˆ—ç½‘å…³è·¯ç”±é…ç½®</h4><p><a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/configuring-static-routes_configuring-and-managing-networking">configuring-static-routes</a> å†…å†™å¾—æ¯”è¾ƒè¯¦ç»†ï¼Œnmcli å’Œé…ç½®æ–‡ä»¶ <code>/etc/sysconfig/network-scripts/route6-enp1s0</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2001:db8:2::/64 via 2001:db8:1::10 dev enp1s0</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶çš„æ ¼å¼å’Œ <code>ip -6 route add</code> ä¸€æ ·</p><h3 id="ä¸€äº›çŸ¥è¯†"><a href="#ä¸€äº›çŸ¥è¯†" class="headerlink" title="ä¸€äº›çŸ¥è¯†"></a>ä¸€äº›çŸ¥è¯†</h3><p>IPv6 åœ°å€æ€»é•¿åº¦ä¸º 128 æ¯”ç‰¹ï¼Œé€šå¸¸åˆ†ä¸º 8 ç»„ï¼Œæ¯ç»„ä¸º 4 ä¸ªåå…­è¿›åˆ¶æ•°çš„å½¢å¼ï¼Œæ¯ç»„åå…­è¿›åˆ¶æ•°é—´ç”¨å†’å·åˆ†éš”ã€‚ ä¾‹å¦‚ï¼š</p><ul><li><code>FC00:0000:130F:0000:0000:09C0:876A:130B</code></li><li><code>FC00:0000:130F::09C0:876A:130B</code> å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ï¼Œè¿ç»­çš„ 0 å¯ä»¥ç¼©å†™ï¼Œ<strong>åªèƒ½ä¸€å¤„ç¼©å†™</strong></li></ul><p>bind çš„åœ°å€ï¼š</p><ul><li><code>::</code> ç­‰åŒäº ipv4 çš„ <code>0.0.0.0</code></li><li><code>::1</code> ç­‰åŒäºipv4 çš„ <code>127.0.0.1</code> å’Œ <code>localhost</code></li></ul><p>url æ ¼å¼æ˜¯ <code>http(s)://[xxx]:port</code> ï¼Œhost éƒ¨åˆ†å¤šäº†æ–¹æ‹¬å·ã€‚</p><h3 id="K8S"><a href="#K8S" class="headerlink" title="K8S"></a>K8S</h3><p>å†…éƒ¨æœ‰ ansible éƒ¨ç½²çš„ï¼Œä¸»è¦æ˜¯åŸºç¡€ä¸Šä¿®æ”¹ï¼Œä¹‹å‰èŠ‚ç‚¹åéƒ½æ˜¯ç”¨çš„ IPv4 åœ°å€ï¼Œç›´æ¥éƒ¨ç½²åæŠ¥é”™ kubelet èŠ‚ç‚¹åæ— æ•ˆï¼Œéœ€è¦ <code>RFC 1123</code> å‘½åè§„èŒƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubelet_node_status.go:92] &quot;Unable to register node with API server&quot; err=&quot;Node \&quot;2002.db8.0.1..101\&quot; is invalid: metadata.name: </span><br><span class="line">Invalid value: \&quot;2002.db8.0.1..101\&quot;: </span><br><span class="line">a lowercase RFC 1123 subdomain must consist of lower case alphanumeric characters, &#x27;-&#x27; or &#x27;.&#x27;, </span><br><span class="line">and must start and end with an alphanumeric character (e.g. &#x27;example.com&#x27;, </span><br><span class="line">regex used for validation is &#x27;[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*&#x27;)&quot; node=&quot;2002.db8.0.1..101&quot;</span><br></pre></td></tr></table></figure><p>ä»1.21 ç‰ˆæœ¬æ”¯æŒåŒæ ˆï¼Œä¸‹é¢çš„ CIDR æˆ‘åªé…ç½® IPv6 å•æ ˆï¼Œæ€»ç»“ä¸‹æ”¹çš„ç‚¹ï¼š</p><ul><li>æŠŠ <code>:</code> æ”¹æˆ <code>.</code> å½“ nodeName ä¸è¡Œï¼Œå› ä¸ºå­˜åœ¨ç¼©å†™æƒ…å†µä¼šè¢«æ›¿æ¢æˆä¸¤ä¸ª <code>..</code> è€Œä¸åŒ¹é… <code>RFC 1123</code> æŠ¥é”™ã€‚</li><li>kubelet csr çš„ CN <code>&quot;CN&quot;: &quot;system:node:xxx&quot;,</code> ä¹Ÿè¦å’ŒèŠ‚ç‚¹ä¸€è‡´</li><li>å› ä¸ºæ˜¯å•æ ˆï¼Œæ¶‰åŠåˆ° 127.0.0.1 å’Œ 0.0.0.0 çš„éƒ½æ”¹æˆå¯¹åº” IPv6</li><li>Service CIDR è®¾ç½®ä¸º <code>2001:cafe:43::/112</code>ï¼š<ul><li>kubernetes service ä¼šä½¿ç”¨ç¬¬ä¸€ä¸ªä¸»æœºä½ IP <code>2001:cafe:43::1</code>ï¼Œè®°å¾—å’Œ <code>::1</code> åŠ åˆ° csr çš„è¯ä¹¦ IP é‡Œ</li><li>DNS IP æ˜¯ç¬¬åä¸ªä¸»æœºä½ï¼Œæˆ‘è®¾ç½®çš„ <code>2001:cafe:43::a</code></li></ul></li><li>Cluster CIDR è®¾ç½®ä¸º <code>2001:cafe:42::/56</code>ï¼Œå¦‚æœé€‰æ‹©æ›´å¤§çš„æ©ç æ®µï¼Œéœ€è¦è®¾ç½® kube-controller-manager çš„ <code>--node-cidr-mask-size-ipv6=</code></li></ul><p>ä¸¤ä¸ªç½‘æ®µæ¥æºäºå‚è€ƒ <a href="https://docs.k3s.io/zh/networking/basic-network-options#dual-stack-ipv4--ipv6-networking">k3s çš„ dual-stack-ipv4â€“ipv6-networking</a></p><p>ä½¿ç”¨åŒæ ˆæœºå™¨åªéƒ¨ç½²å•æ ˆ IPv6 K8S çš„è¯ï¼Œå¦‚æœ <code>kube-apiserver</code> ç¼ºå°‘ <code>--advertise-address=&lt;ipv6&gt;</code> ä¼šæŠ¥é”™ä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err=&quot;error creating bootstrap controller: service IP family \&quot;2001:cafe:43::/112\&quot; must match public address family \&quot;10.x.x.x\&quot;&quot;</span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯æˆ‘æ ¹æ®æºç é‡Œæœ <code>must match public address family</code> æ‰¾åˆ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-apiserver/app/options/validation.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validatePublicIPServiceClusterIPRangeIPFamilies</span><span class="params">(extra Extra, generic genericoptions.ServerRunOptions)</span></span> []<span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// The &quot;kubernetes.default&quot; Service is SingleStack based on the configured ServiceIPRange.</span></span><br><span class="line"><span class="comment">// If the bootstrap controller reconcile the kubernetes.default Service and Endpoints, it must</span></span><br><span class="line"><span class="comment">// guarantee that the Service ClusterIPRepairConfig and the associated Endpoints have the same IP family, or</span></span><br><span class="line"><span class="comment">// it will not work for clients because of the IP family mismatch.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> revisit for dual-stack https://github.com/kubernetes/enhancements/issues/2438</span></span><br><span class="line"><span class="keyword">if</span> reconcilers.Type(extra.EndpointReconcilerType) != reconcilers.NoneEndpointReconcilerType &#123;</span><br><span class="line">serviceIPRange, _, err := controlplaneapiserver.ServiceIPRange(extra.PrimaryServiceClusterIPRange)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">error</span>&#123;fmt.Errorf(<span class="string">&quot;error determining service IP ranges: %w&quot;</span>, err)&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> netutils.IsIPv4CIDR(&amp;serviceIPRange) != netutils.IsIPv4(generic.AdvertiseAddress) &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">error</span>&#123;fmt.Errorf(<span class="string">&quot;service IP family %q must match public address family %q&quot;</span>, extra.PrimaryServiceClusterIPRange.String(), generic.AdvertiseAddress.String())&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h3><p>æœ€ç»ˆéƒ¨ç½²å®Œå‘ç° flannel æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vxlan_network.go:265] failed to add v6 vxlanRoute (2002:db8:42:2::/64 -&gt; 2002:db8:42:2::): All attempts fail:</span><br><span class="line">#1: no route to host</span><br><span class="line">#2: no route to host</span><br><span class="line"></span><br><span class="line">retry.go:29] #0: no route to host</span><br><span class="line">retry.go:29] #1: no route to host</span><br><span class="line">retry.go:29] #2: no route to host</span><br><span class="line"></span><br><span class="line"># è·¯ç”±ä¿¡æ¯</span><br><span class="line"># ip -6 r s | grep flannel</span><br><span class="line">2001:cafe:42:: dev flannel-v6.1 proto kernel metric 256 pref medium</span><br><span class="line">fe80::/64 dev flannel-v6.1 proto kernel metric 256 pref medium</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨å®˜æ–¹ä»“åº“æ–‡æ¡£æ‰¾åˆ°è¯´æ˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># https://github.com/flannel-io/flannel/blob/master/Documentation/configuration.md#dual-stack</span><br><span class="line">vxlan support ipv6 tunnel require kernel version &gt;= 3.12</span><br></pre></td></tr></table></figure><p><a href="https://gist.github.com/zhangguanzhang/d006be666922f001be13b7a2432d96b3">Centos 7 å‡çº§å†…æ ¸</a>è§£å†³ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl  get node -o wide</span><br><span class="line">NAME                                      STATUS   ROLES         AGE   VERSION    INTERNAL-IP         EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION            CONTAINER-RUNTIME</span><br><span class="line">2002.0db8.0000.0001.0000.0000.0000.0101   Ready    master,node   11d   v1.27.15   2002:db8:0:1::101   &lt;none&gt;        CentOS Linux 7 (Core)   4.19.113-300.el7.x86_64   docker://25.0.5</span><br><span class="line">2002.0db8.0000.0001.0000.0000.0000.0102   Ready    master,node   11d   v1.27.15   2002:db8:0:1::102   &lt;none&gt;        CentOS Linux 7 (Core)   4.19.113-300.el7.x86_64   docker://25.0.5</span><br><span class="line">2002.0db8.0000.0001.0000.0000.0000.0103   Ready    master,node   11d   v1.27.15   2002:db8:0:1::103   &lt;none&gt;        CentOS Linux 7 (Core)   4.19.113-300.el7.x86_64   docker://25.0.5</span><br><span class="line">$  kubectl get pod -n kube-system  -o wide</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS       AGE    IP                   NODE                                      NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-5b69bc466f-bkv7t              1/1     Running   1 (7d4h ago)   11d    2001:cafe:42:2::1a   2002.0db8.0000.0001.0000.0000.0000.0103   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-5b69bc466f-f8g7g              1/1     Running   1 (7d4h ago)   7d6h   2001:cafe:42:1::1a   2002.0db8.0000.0001.0000.0000.0000.0102   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-5b69bc466f-svvgz              1/1     Running   1              11d    2001:cafe:42:1::1b   2002.0db8.0000.0001.0000.0000.0000.0102   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-g6bkw                 1/1     Running   5 (3d ago)     11d    2002:db8:0:1::101    2002.0db8.0000.0001.0000.0000.0000.0101   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-r8nnb                 1/1     Running   1 (7d4h ago)   11d    2002:db8:0:1::102    2002.0db8.0000.0001.0000.0000.0000.0102   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-rlnlb                 1/1     Running   1 (7d4h ago)   11d    2002:db8:0:1::103    2002.0db8.0000.0001.0000.0000.0000.0103   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-state-metrics-5d47d4878c-cf974   1/1     Running   1 (7d4h ago)   11d    2001:cafe:42:2::19   2002.0db8.0000.0001.0000.0000.0000.0103   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-local-dns-92td8                  1/1     Running   9 (3d ago)     11d    2002:db8:0:1::101    2002.0db8.0000.0001.0000.0000.0000.0101   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-local-dns-c7tq6                  1/1     Running   2 (7d4h ago)   11d    2002:db8:0:1::102    2002.0db8.0000.0001.0000.0000.0000.0102   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-local-dns-r6g5f                  1/1     Running   2 (7d4h ago)   11d    2002:db8:0:1::103    2002.0db8.0000.0001.0000.0000.0000.0103   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è·¨èŠ‚ç‚¹é€šä¿¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ ping6 -c 2 2001:cafe:42:2::1a</span><br><span class="line">PING 2001:cafe:42:2::1a(2001:cafe:42:2::1a) 56 data bytes</span><br><span class="line">64 bytes from 2001:cafe:42:2::1a: icmp_seq=1 ttl=63 time=0.178 ms</span><br><span class="line">64 bytes from 2001:cafe:42:2::1a: icmp_seq=2 ttl=63 time=0.132 ms</span><br><span class="line"></span><br><span class="line">--- 2001:cafe:42:2::1a ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1027ms</span><br><span class="line">rtt min/avg/max/mdev = 0.132/0.155/0.178/0.023 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸŸåè§£æ</span></span><br><span class="line">$ dig @2001:cafe:42:2::1a  kubernetes.default.svc.cluster.local +short AAAA</span><br><span class="line">2001:cafe:43::1</span><br><span class="line"></span><br><span class="line">$ kubectl -n default describe svc kubernetes </span><br><span class="line">Name:              kubernetes</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            component=apiserver</span><br><span class="line">                   provider=kubernetes</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Family Policy:  SingleStack</span><br><span class="line">IP Families:       IPv6</span><br><span class="line">IP:                2001:cafe:43::1</span><br><span class="line">IPs:               2001:cafe:43::1</span><br><span class="line">Port:              https  443/TCP</span><br><span class="line">TargetPort:        6443/TCP</span><br><span class="line">Endpoints:         [2002:db8:0:1::101]:6443,[2002:db8:0:1::102]:6443,[2002:db8:0:1::103]:6443</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure><h3 id="nodelocaldns-å’Œ-link-local-é—®é¢˜"><a href="#nodelocaldns-å’Œ-link-local-é—®é¢˜" class="headerlink" title="nodelocaldns å’Œ link local é—®é¢˜"></a>nodelocaldns å’Œ link local é—®é¢˜</h3><p>å‘ç° nodelocaldns æœ‰ <a href="https://github.com/kubernetes/dns/pull/418/files">Add ipv6 support to node-local-dns</a> æ”¯æŒï¼Œä¹‹å‰ IPv4 nodelocaldns æ˜¯ä½¿ç”¨ IPv4 çš„ <code>Link-local address</code> çš„ <code>169.254.20.10</code> ï¼Œç„¶åå‚ç…§ pr é‡Œé¢çš„ IPv6 <code>fe80:169:254::1</code> å‘ç°æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error listening: listen tcp6 [fe80:169:254::1]:8080: bind: invalid argument</span><br></pre></td></tr></table></figure><p>æœ€åæ€€ç–‘ä¸æ˜¯ nodelocaldns é—®é¢˜ï¼Œå†™äº†ä¸ªå° demo éªŒè¯ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">serverIP := os.Args[<span class="number">1</span>]</span><br><span class="line">serverPort := <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬åœ°å€å’Œç«¯å£</span></span><br><span class="line">listener, err := net.Listen(<span class="string">&quot;tcp6&quot;</span>, fmt.Sprintf(<span class="string">&quot;[%s]:%d&quot;</span>, serverIP, serverPort))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Error listening:&quot;</span>, err.Error())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> listener.Close()</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;Listening on [%s]:%d\n&quot;</span>, serverIP, serverPort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Error accepting connection:&quot;</span>, err.Error())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> handleConnection(conn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConnection</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line">fmt.Println(<span class="string">&quot;Connection accepted.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ— æ³• bind <code>fe80</code> å¼€å¤´æŠ¥é”™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ip addr add ee80:169:254::1/128 dev lo</span><br><span class="line">$ ip addr add fe80:169:254::1/128 dev lo</span><br><span class="line">$ go run main.go ee80:169:254::1</span><br><span class="line">Listening on [ee80:169:254::1]:8080</span><br><span class="line">^Csignal: interrupt</span><br><span class="line">$ go run main.go fe80:169:254::1</span><br><span class="line">Error listening: listen tcp6 [fe80:169:254::1]:8080: <span class="built_in">bind</span>: invalid argument</span><br><span class="line">[root@guan ~/test/gotest]<span class="comment"># uname -a</span></span><br><span class="line">Linux guan 5.4.0-182-generic <span class="comment">#202-Ubuntu SMP Fri Apr 26 12:29:36 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">[root@guan ~/test/gotest]<span class="comment"># ip -6 a s lo</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    inet6 ee80:169:254::1/128 scope global </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80:169:254::1/128 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>è°ƒè¯•å‘ç°æœ€ç»ˆæ˜¯ syscall æŠ¥é”™ï¼Œä½¿ç”¨ python å†™ç±»ä¼¼ä»£ç ä¹Ÿä¸€æ ·ï¼Œç„¶å‘ç°åè¿™ä¸ªç½‘æ®µ <code>fe80::/10</code> åªèƒ½æŒ‡å®šç½‘å¡åæˆ–è€… indexï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go fe80:169:254::1%lo</span><br><span class="line">Listening on [fe80:169:254::1%lo]:8080</span><br><span class="line"><span class="comment"># å…¶ä»–çª—å£ curlï¼Œå¸¦ç½‘å¡åæ‰è¡Œ</span></span><br><span class="line">$ curl -g [fe80:169:254::1%lo]:8080</span><br><span class="line">curl: (56) Recv failure: Connection reset by peer</span><br><span class="line">$ curl -g [fe80:169:254::1]:8080</span><br><span class="line">curl: (7) Couldn<span class="string">&#x27;t connect to server</span></span><br></pre></td></tr></table></figure><p>éœ€è¦è·å–ç½‘å¡åå­—ï¼Œå¯ä»¥å‚ç…§æŠ„äº†ä¸‹ calico çš„ autoDetect æ–¹æ³•ä¿®æ”¹äº†ä¸‹å†™äº†ä¸ªä¼ å…¥ ipv6 ç›®æ ‡åœ°å€ï¼Œè·å–ä»æœ¬æœºå“ªå¼ ç½‘å¡å‡ºå»çš„åå­—ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/projectcalico/calico/blob/5d7c8554e2c7b75ec31ec2a7d234c42049742a4d/node/pkg/lifecycle/startup/autodetection/reachaddr.go#L27</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReachDestinationInterfaceName</span><span class="params">(dest <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open a UDP connection to determine which external IP address is</span></span><br><span class="line"><span class="comment">// used to access the supplied destination.</span></span><br><span class="line">protocol := <span class="string">&quot;udp6&quot;</span></span><br><span class="line"><span class="keyword">if</span> dest[<span class="number">0</span>] != <span class="string">&#x27;[&#x27;</span> &#123;</span><br><span class="line">dest = fmt.Sprintf(<span class="string">&quot;[%s]&quot;</span>, dest)</span><br><span class="line">&#125;</span><br><span class="line">address := fmt.Sprintf(<span class="string">&quot;%s:80&quot;</span>, dest)</span><br><span class="line">conn, err := net.Dial(protocol, address)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close() <span class="comment">// nolint: errcheck</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the local address as a golang IP and use that to find the matching</span></span><br><span class="line"><span class="comment">// interface CIDR.</span></span><br><span class="line">addr := conn.LocalAddr()</span><br><span class="line"><span class="keyword">if</span> addr == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;no address detected by connecting to %s&quot;</span>, dest)</span><br><span class="line">&#125;</span><br><span class="line">udpAddr := addr.(*net.UDPAddr)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a full list of interface and IPs and find the CIDR matching the</span></span><br><span class="line"><span class="comment">// found IP.</span></span><br><span class="line">netIfaces, err := net.Interfaces()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, iface := <span class="keyword">range</span> netIfaces &#123;</span><br><span class="line">netAddrs, err := iface.Addrs()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, netAddr := <span class="keyword">range</span> netAddrs &#123;</span><br><span class="line">ifNet, _, _ := net.ParseCIDR(netAddr.String())</span><br><span class="line"><span class="keyword">if</span> udpAddr.IP.Equal(ifNet) &#123;</span><br><span class="line"><span class="keyword">return</span> iface.Name, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;autodetected IPv6 address does not match any addresses found on local interfaces: %s&quot;</span>, udpAddr.IP.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª demoï¼Œè·å–è®¿é—®æŒ‡å®š ip ä¼šä½¿ç”¨æœ¬æœºå“ªå¼ ç½‘å¡å’Œ ipï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">ipStr := os.Args[<span class="number">1</span>]</span><br><span class="line">inetVersion := <span class="number">4</span></span><br><span class="line"><span class="keyword">if</span> strings.Contains(ipStr, <span class="string">&quot;:&quot;</span>) &#123;</span><br><span class="line">inetVersion = <span class="number">6</span></span><br><span class="line">&#125;</span><br><span class="line">localInterface, _ := ReachDestinationInterfaceName(ipStr, inetVersion)</span><br><span class="line">localIP, _ := GetInterfaceIPs(localInterface, inetVersion)</span><br><span class="line">fmt.Printf(<span class="string">&quot;interface:%s localIP:%s\n&quot;</span>, localInterface, localIP)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">splitByLastColon</span><span class="params">(s <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">string</span>) &#123;</span><br><span class="line"><span class="comment">// Find the last occurrence of &quot;:&quot;</span></span><br><span class="line">index := strings.LastIndex(s, <span class="string">&quot;:&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> index == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="comment">// No colon found, return the whole string as the first part</span></span><br><span class="line"><span class="keyword">return</span> s, <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Split the string into two parts</span></span><br><span class="line">part1 := s[:index]</span><br><span class="line">part2 := s[index+<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">return</span> part1, part2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReachDestinationInterfaceName</span><span class="params">(dest <span class="type">string</span>, version <span class="type">int</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open a UDP connection to determine which external IP address is</span></span><br><span class="line"><span class="comment">// used to access the supplied destination.</span></span><br><span class="line">protocol := fmt.Sprintf(<span class="string">&quot;udp%d&quot;</span>, version)</span><br><span class="line"><span class="keyword">if</span> dest[<span class="number">0</span>] != <span class="string">&#x27;[&#x27;</span> &#123;</span><br><span class="line">dest = fmt.Sprintf(<span class="string">&quot;[%s]&quot;</span>, dest)</span><br><span class="line">&#125;</span><br><span class="line">address := fmt.Sprintf(<span class="string">&quot;%s:80&quot;</span>, dest)</span><br><span class="line">conn, err := net.Dial(protocol, address)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close() <span class="comment">// nolint: errcheck</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the local address as a golang IP and use that to find the matching</span></span><br><span class="line"><span class="comment">// interface CIDR.</span></span><br><span class="line">addr := conn.LocalAddr()</span><br><span class="line"><span class="keyword">if</span> addr == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;no address detected by connecting to %s&quot;</span>, dest)</span><br><span class="line">&#125;</span><br><span class="line">udpAddr := addr.(*net.UDPAddr)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a full list of interface and IPs and find the CIDR matching the</span></span><br><span class="line"><span class="comment">// found IP.</span></span><br><span class="line">netIfaces, err := net.Interfaces()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, iface := <span class="keyword">range</span> netIfaces &#123;</span><br><span class="line">netAddrs, err := iface.Addrs()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, netAddr := <span class="keyword">range</span> netAddrs &#123;</span><br><span class="line">ifNet, _, _ := net.ParseCIDR(netAddr.String())</span><br><span class="line"><span class="keyword">if</span> udpAddr.IP.Equal(ifNet) &#123;</span><br><span class="line"><span class="keyword">return</span> iface.Name, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;autodetected IPv%d address does not match any addresses found on local interfaces: %s&quot;</span>, version, udpAddr.IP.String())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetInterfaceIPs</span><span class="params">(ifaceName <span class="type">string</span>, inetVersion <span class="type">int</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">iface, err := net.InterfaceByName(ifaceName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addrs, err := iface.Addrs()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ipAddr <span class="type">string</span></span><br><span class="line"><span class="keyword">for</span> _, addr := <span class="keyword">range</span> addrs &#123;</span><br><span class="line">ipNet, _, err := net.ParseCIDR(addr.String())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> inetVersion == <span class="number">4</span> &#123;</span><br><span class="line"><span class="keyword">if</span> ipNet.To4() != <span class="literal">nil</span> &#123;</span><br><span class="line">ipAddr = ipNet.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// æ’é™¤æ‰æœ¬åœ°é“¾è·¯åœ°å€</span></span><br><span class="line"><span class="keyword">if</span> ipNet.To16() != <span class="literal">nil</span> &amp;&amp; !ipNet.IsLinkLocalUnicast() &#123;</span><br><span class="line">ipAddr = ipNet.String()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ipAddr, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$./reach 223.5.5.5</span><br><span class="line">interface:ens18 localIP:192.168.2.112</span><br><span class="line">$ ./ ip a s ens18</span><br><span class="line">2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 7e:bf:9c:27:f5:9e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.112/24 brd 192.168.2.255 scope global ens18</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::7cbf:9cff:fe27:f59e/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">$ ./reach 2408:8656:22df:ff01::13:111</span><br><span class="line">interface:ens160 localIP:2408:8656:22df:ff01::13:181</span><br><span class="line">$ ip a s ens160</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:a0:df:2e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 2408:8656:22df:ff01::13:181/119 scope global </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::250:56ff:fea0:df2e/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><h3 id="ä¸­é—´ä»¶å±‚é¢"><a href="#ä¸­é—´ä»¶å±‚é¢" class="headerlink" title="ä¸­é—´ä»¶å±‚é¢"></a>ä¸­é—´ä»¶å±‚é¢</h3><p>å¤§éƒ¨åˆ†ä¸­é—´ä»¶éƒ½ä¼šè‡ªåŠ¨åˆ¤æ–­è€Œç›‘å¬ IPv6 åœ°å€ï¼Œä½†æ˜¯æœ‰äº›ä¼šæœ‰é—®é¢˜ã€‚</p><h4 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h4><p>es æ— æ³•ç»„ä»¶é›†ç¾¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;: &quot;server&quot;, &quot;timestamp&quot;: &quot;2024-07-23T10:59:43,648+08:00&quot;, &quot;level&quot;: &quot;WARN&quot;, &quot;component&quot;: &quot;o.e.d.HandshakingTransportAddressConnector&quot;, &quot;cluster.name&quot;: &quot;xxxes&quot;, </span><br><span class="line">&quot;node.name&quot;: &quot;es-host1.default&quot;, &quot;message&quot;: &quot;[connectToRemoteMasterNode[[2001:cafe:43::3250]:9300]] completed handshake with [&#123;es-host3.default&#125;&#123;3e7q-VGnRmWdh1XRtvb0Ww&#125;</span><br><span class="line">&#123;aCnHTNTLRp-rRVVg7N_z0Q&#125;&#123;127.0.0.1&#125;&#123;127.0.0.1:9300&#125;&#123;dm&#125;&#123;xpack.installed=true, transform.node=false&#125;] but followup connection failed&quot;, </span><br><span class="line">&quot;stacktrace&quot;: [&quot;org.elasticsearch.transport.ConnectTransportException: [es-host3.default][127.0.0.1:9300] handshake failed. unexpected remote node &#123;es-host1.default&#125;&#123;n19UyOGnQpiErI0TW_jOPw&#125;&#123;6Wawn96FShGZyhYlo9BgDQ&#125;&#123;127.0.0.1&#125;&#123;127.0.0.1:9300&#125;&#123;dm&#125;&#123;xpack.installed=true, transform.node=false&#125;&quot;,</span><br></pre></td></tr></table></figure><p>çœ‹æŠ¥é”™ä¿¡æ¯æ˜¯å…¶ä»–å‡ ä¸ª es ä¸ŠæŠ¥ IP æ˜¯ 127.0.0.1 äº†ï¼ŒPod å†…çš„ lo è¿˜æ˜¯æœ‰ 127.0.0.1 IP çš„ã€‚å‚ç…§å®˜æ–¹æ–‡æ¡£ <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#unicast.hosts">unicast.hosts</a> å’Œ <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html">modules-network</a> å°è¯• <code>network.publish_host:</code> è®¾ç½® <code>_global_</code> ä¹Ÿä¸è¡Œ <code>_site_ </code>ï¼Œæœ€åè®¾ç½®çš„ <code>network.publish_host: _eth0:ipv6_</code> ä¸ŠæŠ¥ IP æ‰æ­£ç¡®ã€‚</p><h4 id="rabbitmq"><a href="#rabbitmq" class="headerlink" title="rabbitmq"></a>rabbitmq</h4><p>é»˜è®¤é…ç½®æ— æ³•ç»„å»ºé›†ç¾¤ï¼Œæ ¹æ® <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1358311">redhat</a> å¾—çŸ¥ 3.6.3 ä»¥åéƒ½æ”¯æŒï¼Œç„¶åå‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://www.rabbitmq.com/docs/networking#distribution-ipv6">distribution-ipv6</a> æ·»åŠ  envï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># these flags will be used by RabbitMQ nodes</span><br><span class="line">RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=&quot;-kernel inetrc &#x27;/etc/rabbitmq/erl_inetrc&#x27; -proto_dist inet6_tcp&quot;</span><br><span class="line"># these flags will be used by CLI tools</span><br><span class="line">RABBITMQ_CTL_ERL_ARGS=&quot;-proto_dist inet6_tcp&quot;</span><br></pre></td></tr></table></figure><p>ç„¶å erl_inetrc å†™ä¸‹é¢å†…å®¹æŒ‚è½½è¿›å»ï¼Œå‹æ ¹æ— æ³•å¯åŠ¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;inet6,true&#125;.</span><br></pre></td></tr></table></figure><p>æœ€åæœç´¢æ‰¾åˆ° <a href="https://stackoverflow.com/questions/49107068/rabbitmq-wont-cluster-nxdomain">stackoverflow</a> è¯´è¿™äº› env è¦å†™ rabbitmq-env.conf ï¼Œç„¶åå°±å†™æ–‡ä»¶é‡Œå¯ä»¥å¯åŠ¨ï¼Œä½†æ˜¯æ­»æ´»åŠ ä¸äº†é›†ç¾¤ã€‚ç„¶åæŸ¥çœ‹ç«¯å£å‘ç°è¿˜æ˜¯ç›‘å¬çš„ ipv4ï¼Œå‚ç…§æ–‡æ¡£ <a href="https://www.rabbitmq.com/docs/configure#config-items">config-items</a> <a href="https://www.rabbitmq.com/docs/networking#distribution-interface">distribution-interface</a> åœ¨ rabbitmq.conf é‡Œæ·»åŠ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">distribution.listener.interface = ::</span><br><span class="line">listeners.tcp.default = 2408:8656:22df:ff01::13:182:5672</span><br><span class="line">listeners.tcp.management = 2408:8656:22df:ff01::13:182:15672</span><br></pre></td></tr></table></figure><p>åç›‘å¬ ip æ­£å¸¸äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³• join cluster æŠ¥é”™æ— æ³•è§£æåŸŸåï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -ti rabbitmq-2 bash -c <span class="string">&quot;rabbitmqctl stop_app &amp;&amp; rabbitmqctl  join_cluster rabbit@rabbitmq-cluster1 &amp;&amp; rabbitmqctl start_app&quot;</span></span></span><br><span class="line">rabbit@rabbitmq-cluster1:</span><br><span class="line">  * unable to connect to epmd (port 4369) on rabbitmq-cluster1: nxdomain (non-existing domain)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -ti rabbitmq-2  rabbitmq-diagnostics resolve_hostname rabbitmq-cluster1 --address-family IPv6</span> </span><br><span class="line">Asking node rabbitmq-cluster2@rabbitmq-cluster2 to resolve hostname rabbitmq-cluster1 to IPv6 addresses...</span><br><span class="line">2408:8656:22df:ff01::13:181</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -ti rabbitmq-2 getent hosts rabbitmq-cluster1</span></span><br><span class="line">2408:8656:22df:ff01::13:181 rabbitmq-cluster1</span><br></pre></td></tr></table></figure><p>æœ€åå‘ç°æ˜¯ nodename é”™äº†ï¼Œæ²¡ç”¨ prefix ç›´æ¥ç”¨çš„ rabbitmq-clusterx ï¼Œåº”è¯¥ä½¿ç”¨ <code>&lt;prefix&gt;@&lt;hostname&gt;</code> ï¼Œç›¸å…³ compose æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;rabbitmq:3.12&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;rabbitmq-2&quot;</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">&quot;rabbitmq-cluster2&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span> <span class="comment"># unless-stopped</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">&#x27;/etc/rabbitmq/&#x27;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbit@rabbitmq-cluster2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_ERLANG_COOKIE=xxxx</span></span><br><span class="line">        <span class="comment">#- ERL_INETRC=/etc/rabbitmq/erl_inetrc</span></span><br><span class="line">        <span class="comment">#- RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=&quot;-proto_dist inet6_tcp&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_CTL_ERL_ARGS=&quot;-proto_dist</span> <span class="string">inet6_tcp&quot;</span></span><br><span class="line">        <span class="comment">#- ERL_EPMD_ADDRESS=&quot;::1&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/lib/rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq-env.conf:/etc/rabbitmq/rabbitmq-env.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./hosts:/etc/hosts</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Hongkong:/etc/localtime</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œåæ§½ä¸‹ rabbitmq çš„ github äººå‘˜ï¼Œrabbitmq-diagnostics èƒ½è§£æåŸŸåï¼Œjoin æŠ¥é”™ï¼Œç›´æ¥æŠŠæˆ‘æçš„ discussions ç»™ lock æ‰è¿˜è¯´æ˜¯å±äºç½‘ç»œé—®é¢˜ã€‚ </p><h3 id="åº”ç”¨å±‚é¢"><a href="#åº”ç”¨å±‚é¢" class="headerlink" title="åº”ç”¨å±‚é¢"></a>åº”ç”¨å±‚é¢</h3><h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><p>æœ€å¼€å§‹æœ‰ä¸ªæ•°æ®åº“åˆå§‹åŒ–çš„ golang åº”ç”¨ï¼Œè¯¥åº”ç”¨ï¼ˆä½¿ç”¨ <a href="https://github.com/redis/go-redis">github.com&#x2F;redis&#x2F;go-redis</a> ï¼‰éœ€è¦è¿ redis æŠ¥é”™äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis setnx failed dial tcp: address 2002:db8:0:1::101:8531: too many colons in address</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé—®é¢˜æ˜¯ä»£ç é‡ŒæŠŠ <code>IPv6:Port</code> åœ°å€å½“æˆ <code>IPv4:Port</code> å»è§£æäº†ï¼Œç±»ä¼¼ <code>Split(&quot;:&quot;)</code> ä¸ç­‰äº 2 è€ŒæŠ¥é”™ã€‚ä½†æ˜¯ç ”å‘åé¦ˆå‡ºé”™çš„åœ°æ–¹æ˜¯æ¯æ¬¡å˜åŒ–çš„ï¼Œæ¯ä¸ªä½¿ç”¨ redis çš„åœ°æ–¹éƒ½ä¼šéšæœºå‡ºç°ï¼Œåé¢è®©ä»–å†™äº†ä¸ªæœ€å° demo æºç å‘ç»™æˆ‘ï¼Œæˆ‘ <a href="https://zhangguanzhang.github.io/2021/07/20/dlv-remote/">dlv è¿œç¨‹è°ƒè¯•äº†ä¸‹</a>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">(dlv) so</span><br><span class="line">&gt; github.com/go-redis/redis.(*ClusterClient).defaultProcess() D:/Install/Go/GOPATH/pkg/mod/github.com/go-redis/redis@v6.15.9+incompatible/cluster.go:954 (PC: 0x7b9385)</span><br><span class="line">Values returned:</span><br><span class="line">        moved: true</span><br><span class="line">        ask: false</span><br><span class="line">        addr: &quot;2002:db8:0:1::103:8533&quot;</span><br><span class="line"></span><br><span class="line">   949:                         continue</span><br><span class="line">   950:                 &#125;</span><br><span class="line">   951:</span><br><span class="line">   952:                 var moved bool</span><br><span class="line">   953:                 var addr string</span><br><span class="line">=&gt; 954:                 moved, ask, addr = internal.IsMovedError(err)</span><br><span class="line">   955:                 if moved || ask &#123;</span><br><span class="line">   956:                         node, err = c.nodes.GetOrCreate(addr)</span><br><span class="line">   957:                         if err != nil &#123;</span><br><span class="line">   958:                                 break</span><br><span class="line">   959:                         &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(dlv) so</span><br><span class="line">&gt; github.com/go-redis/redis.(*baseClient).defaultProcess() D:/Install/Go/GOPATH/pkg/mod/github.com/go-redis/redis@v6.15.9+incompatible/redis.go:186 (PC: 0x7fe612)</span><br><span class="line">Values returned:</span><br><span class="line">        ~r0: *github.com/go-redis/redis/internal/pool.Conn nil</span><br><span class="line">        ~r1: error(*net.OpError) *&#123;</span><br><span class="line">                Op: &quot;dial&quot;,</span><br><span class="line">                Net: &quot;tcp&quot;,</span><br><span class="line">                Source: net.Addr nil,</span><br><span class="line">                Addr: net.Addr nil,</span><br><span class="line">                Err: error(*net.AddrError) *&#123;</span><br><span class="line">                        Err: &quot;too many colons in address&quot;,</span><br><span class="line">                        Addr: &quot;2002:db8:0:1::103:8533&quot;,&#125;,&#125;</span><br><span class="line"></span><br><span class="line">   181:         for attempt := 0; attempt &lt;= c.opt.MaxRetries; attempt++ &#123;</span><br><span class="line">   182:                 if attempt &gt; 0 &#123;</span><br><span class="line">   183:                         time.Sleep(c.retryBackoff(attempt))</span><br><span class="line">   184:                 &#125;</span><br><span class="line">   185:</span><br><span class="line">=&gt; 186:                 cn, err := c.getConn()</span><br><span class="line">   187:                 if err != nil &#123;</span><br><span class="line">   188:                         cmd.setErr(err)</span><br><span class="line">   189:                         if internal.IsRetryableError(err, true) &#123;</span><br><span class="line">   190:                                 continue</span><br><span class="line">   191:                         &#125;</span><br><span class="line">(dlv)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(dlv) p c.opt</span><br><span class="line">(&quot;*github.com/go-redis/redis.Options&quot;)(0xc0000d8240)</span><br><span class="line">*github.com/go-redis/redis.Options &#123;</span><br><span class="line">        Network: &quot;tcp&quot;,</span><br><span class="line">        Addr: &quot;[2002:db8:0:1::101]:8531&quot;,</span><br><span class="line">...</span><br><span class="line">(dlv) c</span><br><span class="line">&gt; github.com/go-redis/redis.(*baseClient).defaultProcess() D:/Install/Go/GOPATH/pkg/mod/github.com/go-redis/redis@v6.15.9+incompatible/redis.go:186 (hits goroutine(1):45 total:52) (PC: 0x7fe5f3)</span><br><span class="line">   181:         for attempt := 0; attempt &lt;= c.opt.MaxRetries; attempt++ &#123;</span><br><span class="line">   182:                 if attempt &gt; 0 &#123;</span><br><span class="line">   183:                         time.Sleep(c.retryBackoff(attempt))</span><br><span class="line">   184:                 &#125;</span><br><span class="line">   185:</span><br><span class="line">=&gt; 186:                 cn, err := c.getConn()</span><br><span class="line">   187:                 if err != nil &#123;</span><br><span class="line">   188:                         cmd.setErr(err)</span><br><span class="line">   189:                         if internal.IsRetryableError(err, true) &#123;</span><br><span class="line">   190:                                 continue</span><br><span class="line">   191:                         &#125;</span><br><span class="line">(dlv) p c.opt</span><br><span class="line">(&quot;*github.com/go-redis/redis.Options&quot;)(0xc0000d8300)</span><br><span class="line">*github.com/go-redis/redis.Options &#123;</span><br><span class="line">        Network: &quot;tcp&quot;,</span><br><span class="line">        Addr: &quot;2002:db8:0:1::103:8533&quot;,</span><br><span class="line">        Dialer: github.com/go-redis/redis.(*Options).init.func1,</span><br><span class="line">        OnConnect: nil,</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°å¤§æ¦‚é—®é¢˜ï¼Œè¿™é‡Œ addr å˜æˆäº†æ²¡å¸¦æ–¹æ‹¬å·çš„ï¼Œaddr åªæœ‰ä¸€ä¸ªåœ°æ–¹ <code>moved, ask, addr = internal.IsMovedError(err)</code> è·å–çš„ï¼Œå†…éƒ¨é€»è¾‘æ˜¯ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsMovedError</span><span class="params">(err <span class="type">error</span>)</span></span> (moved <span class="type">bool</span>, ask <span class="type">bool</span>, addr <span class="type">string</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> !IsRedisError(err) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s := err.Error()</span><br><span class="line"><span class="keyword">if</span> strings.HasPrefix(s, <span class="string">&quot;MOVED &quot;</span>) &#123;</span><br><span class="line">moved = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.HasPrefix(s, <span class="string">&quot;ASK &quot;</span>) &#123;</span><br><span class="line">ask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ind := strings.LastIndex(s, <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> ind == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">addr = s[ind+<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯ redis è¿”å›çš„ <code>MOVED 14443 2002:db8:0:1::103:8533</code> é‡å®šå‘å­—æ ·é‡Œå– IP åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¸€å¼€å§‹ä» DSN å­—ç¬¦ä¸²æœ‰æ–¹æ‹¬å·æ˜¯èƒ½è¯†åˆ«æˆ IPv6 åœ°å€ï¼Œä½†æ˜¯åé¢æ“ä½œ redis å‘ç”Ÿé‡å®šå‘å°±ä½¿ç”¨è¿™ä¸ª IP å»åšè¿æ¥ï¼Œçœ‹ redis æœ€æ–°æºç  <code>void clusterRedirectClient</code> å‘ç° redis server å¹¶ä¸ä¼šè¿”å› IPv6 åœ°å€åŠ æ–¹æ‹¬å·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/redis/redis/blob/89742a95dbd4e95f5112136e4bcff698195e205c/src/cluster.c#L1179</span></span><br><span class="line">  addReplyErrorSds(c,sdscatprintf(sdsempty(),</span><br><span class="line">                      <span class="string">&quot;-%s %d %s:%d&quot;</span>,</span><br><span class="line">                      (error_code == CLUSTER_REDIR_ASK) ? <span class="string">&quot;ASK&quot;</span> : <span class="string">&quot;MOVED&quot;</span>,</span><br><span class="line">                      hashslot, clusterNodePreferredEndpoint(n), port));</span><br></pre></td></tr></table></figure><p>æœç´¢ redis move ipv6 æœåˆ°äº† issue <a href="https://github.com/redis/redis/issues/3076">redis-cli ipv6 issue on redis cluster</a>ï¼Œå‘ç°å…¶ä»–è¯­è¨€çš„ SDK éƒ½æ˜¯å¤„ç† MOVE åçš„åœ°å€åŠ åˆ¤æ–­ï¼Œäºæ˜¯å»çœ‹ <a href="https://github.com/redis/go-redis">github.com&#x2F;redis&#x2F;go-redis</a> æœ€æ–°ç‰ˆæœ¬ <code>isMovedError</code> æ–¹æ³•å‘ç° 4ä¸ªæœˆä¹‹å‰ä¿®å¤äº†ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/redis/go-redis/blob/00d98485f8357d016139ece133bd3272e7ff2526/error.go#L114/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMovedError</span><span class="params">(err <span class="type">error</span>)</span></span> (moved <span class="type">bool</span>, ask <span class="type">bool</span>, addr <span class="type">string</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> !isRedisError(err) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s := err.Error()</span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> strings.HasPrefix(s, <span class="string">&quot;MOVED &quot;</span>):</span><br><span class="line">moved = <span class="literal">true</span></span><br><span class="line"><span class="keyword">case</span> strings.HasPrefix(s, <span class="string">&quot;ASK &quot;</span>):</span><br><span class="line">ask = <span class="literal">true</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ind := strings.LastIndex(s, <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> ind == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addr = s[ind+<span class="number">1</span>:]</span><br><span class="line">addr = internal.GetAddr(addr) <span class="comment">// &lt;---- è¿™é‡Œæ˜¯å¤„ç†</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®©å‡çº§å¼•ç”¨åº“ç‰ˆæœ¬å¤§äºç­‰äº 9.5.2 åè§£å†³ã€‚</p><h4 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dial tcp [2002:db8:0:1::101:3306]:3306: connect: no route to host</span><br></pre></td></tr></table></figure><p>è¯¥é—®é¢˜æ˜¯å› ä¸º IPv6 åœ°å€å¯ä»¥ç¼©å†™ï¼Œç„¶å <code>:3306</code> åœ¨ DSN å­—ç¬¦ä¸²é‡Œ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[username[:password]@][protocol[(address)]]/dbname[?param1=value1&amp;...&amp;paramN=valueN]</span><br><span class="line">[username[:password]@][tcp[(2002:db8:0:1::101:3306)]]/dbname[?param1=value1&amp;...&amp;paramN=valueN]</span><br></pre></td></tr></table></figure><p>è¢«ä¸šåŠ¡çš„ mysql client SDK è§£æå½“ä½œ IPv6 ä¸»æœºä½è€Œè¿é”™ IPï¼Œç«¯å£å½“ä¸»æœºä½å…¶ä»–ç±»å‹çš„ SDK é‡Œä¹Ÿä¼šå‡ºç°ï¼Œæ³¨æ„ç†è§£è¯¥é—®é¢˜æœ¬è´¨ã€‚å¯ä»¥å‚ç…§å‰é¢ redis ç»“å°¾çš„å‡½æ•°å…ˆå¤„ç†å…ˆ mysql IP åœ°å€å†ä¼ å…¥ DSN å­—ç¬¦ä¸²é‡Œã€‚</p><h4 id="è¾¾æ¢¦"><a href="#è¾¾æ¢¦" class="headerlink" title="è¾¾æ¢¦"></a>è¾¾æ¢¦</h4><p>åé¢ golang ä¸Šè¾¾æ¢¦å•æœºä¸‹è¿ä¸ä¸Šï¼Œé©±åŠ¨ç”¨çš„ <a href="https://gitee.com/chunanyong/dm/">https://gitee.com/chunanyong/dm/</a> , å‡çº§ä¸‹å°±è§£å†³äº†ï¼ŒåŸå› æ˜¯ <code>net.ParseIP</code> ä¼šæŠŠ ipv6 çš„å·¦å³ä¾§æ–¹æ‹¬å·å»æ‰ã€‚<br>ç„¶åå¦ä¸€ä¸ªè¾¾æ¢¦è¿æ¥ä¸­é—´ä»¶ä»£ç†æœåŠ¡åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ä¹Ÿæµ‹å‡ºé—®é¢˜ï¼Œè¾¾æ¢¦å®˜æ–¹äººå‘˜ç»™çš„è¿æ¥é…ç½®æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/dm_svc.conf</span><br><span class="line">...</span><br><span class="line">DMCLUSTER=([2002:db8:0:1::101]:5236,[2002:db8:0:1::102]:5236)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ç§å½¢å¼ä¼šå¯¼è‡´æœ‰é—®é¢˜ï¼ŒæŠ¥é”™ <code>2002:db8:0:1::102:0 invalid port</code> å•¥çš„ï¼Œè°ƒè¯•å‘ç°é©±åŠ¨çš„é›†ç¾¤é…ç½®ä¸‹ï¼Œå– port é€»è¾‘æ²¡è€ƒè™‘é›†ç¾¤æ¨¡å¼ï¼Œæœ€åä¸€ä¸ª port æ²¡å–åˆ°ä½¿ç”¨ golang çš„é›¶å€¼ 0ï¼Œç„¶å hack ååˆå‘ç° ipv6 çš„æ–¹æ‹¬å·æ²¡äº†ï¼Œè¿™ä¿©é—®é¢˜å·²ç»æ <a href="https://gitee.com/chunanyong/dm/issues/IBAIHS">issue</a> åé¦ˆäº†ã€‚</p><p>å‡çº§é©±åŠ¨è§£å†³å•æœºè¾¾æ¢¦æ–¹æ‹¬å·é—®é¢˜ï¼Œè¾¾æ¢¦é›†ç¾¤æ¨¡å¼éœ€è¦ hack ä¸¤ä¸ªåœ°æ–¹ä»£ç ã€‚</p><h3 id="ç»„ç½‘æµ‹è¯•"><a href="#ç»„ç½‘æµ‹è¯•" class="headerlink" title="ç»„ç½‘æµ‹è¯•"></a>ç»„ç½‘æµ‹è¯•</h3><p>éšç€åç»­åº”ç”¨å¼€å§‹ä»‹å…¥ï¼Œé‚£ä¸ª windows ä¸æ”¯æŒå¤šäººåŒæ—¶ç™»å½•éå¸¸éš¾å—ï¼Œè®°å¾—ä»¥å‰é…ç½®è¿‡ï¼Œä½†æ˜¯è¿˜æœ‰ windows&#x2F;macOS ä¸Š app ç«¯ï¼Œè¿˜è¦çœ‹ app ç«¯èƒ½å¦ä½¿ç”¨ IPv6 è¿ serverã€‚å°±è€ƒè™‘æœ‰æ²¡æœ‰éš§é“çš„å½¢å¼ç»„ç½‘ï¼š</p><p><img src="https://raw.githubusercontent.com/zhangguanzhang/Image-Hosting/master/k8s/ipv6-on-ipv4-tunel.png" alt="ipv6-on-ipv4-tunel"></p><p>windows è‡ªå¸¦çš„å†…ç½®çš„æœ€å¥½äº†ï¼Œä¸ç„¶çœå¾—åç»­ç»™å¼€å‘å’Œæµ‹è¯•å†™ä¸ªå®‰è£…æ–‡æ¡£ï¼Œæœäº†ä¸‹æœ‰ä¸ª <code>Teredo</code> ä½†æ˜¯çœ‹äº†ä¸‹åªæœ‰ Client éƒ¨ç½²ï¼ŒServer çš„éƒ¨ç½²æ²¡æœ‰ï¼Œæœåˆ°å¼€æºçš„ miredoï¼Œä½†æ˜¯éƒ¨ç½² server åå¯åŠ¨æŠ¥é”™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/sbin/miredo-server -f -c /etc/miredo/miredo-server.conf</span><br><span class="line">...</span><br><span class="line">Teredo server UDP socket err: Server IPv4 address must be global unicast</span><br></pre></td></tr></table></figure><p>æŠ¥é”™è¯´ä¸æ˜¯ IPv4 ç»„æ’­åœ°å€ï¼Œä½†æ˜¯ä¸»æœºä½å†™ 255 è¿˜æ˜¯ä¸è¡Œï¼Œä»£ç é‡Œæœäº†ä¸‹è¿™ä¸ªæŠ¥é”™æ‰¾åˆ° <a href="https://www.remlab.net/miredo/lcov/trunk/libteredo/v4global.c.gcov.html">æ ¡éªŒé€»è¾‘</a>ã€‚ç„¶åæ²¡ç”¨è¿‡è¿™äº› c åº“çœ‹ä¸æ‡‚é€»è¾‘ï¼Œå°±æ¢ headscale å¾—äº†ã€‚</p><p>åŒæ ˆæœºå™¨ä¸Šï¼š</p><ul><li><a href="https://zhangguanzhang.github.io/2024/07/25/headscale/">å®‰è£… headsacle</a> ï¼Œ<code>ip_prefix</code> å…³é—­ IPv4 ä¿ç•™ IPv6 é‚£ä¸ªç½‘æ®µ <code>fd7a:115c:a1e0::/48</code></li><li>å®‰è£… derp + tailscaleï¼Œè¿™ä¸ª <code>tailscale up</code> æ—¶å€™å¸¦ä¸Š <code>--advertise-routes 2002:db8:0:1::/64</code></li><li>ç„¶åå¼€å¯è¿™ä¸ªçš„è·¯ç”± <code>headscale routes enable -r 1</code></li><li>åŒæ ˆæœºå™¨å¼€å¯ ipv4 ipv6 forward sysctl</li></ul><p>åé¢å‘ç° windows ä¸Šå¼€äº†å®¢æˆ·ç«¯åè®¿é—® 101 å‘ç°æ¥æº IP æ˜¯åŒæ ˆæœºå™¨çš„ IPv6 IPï¼Œå› ä¸º tailscale linux å®¢æˆ·ç«¯é»˜è®¤æ˜¯å¼€å¯äº† SNATï¼ŒæŠŠåŒæ ˆæœºå™¨ä¸Šçš„ snat å…³äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tailscale <span class="built_in">set</span> --snat-subnet-routes=<span class="literal">false</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºåŒæ ˆæœºå™¨æ˜¯ IPv6 æœºå™¨çš„ç½‘å…³ï¼Œæ‰€ä»¥è¿™æ ·æ²¡åš SNAT åï¼š</p><ul><li>windows&#x2F;MacOS&#x2F;æ‰‹æœºï¼ˆ<code>fd7a:115c:a1e0::/48</code>ï¼‰ è®¿é—® <code>2002:db8:0:1::/64</code> èµ°æœ¬æœºè·¯ç”±åˆ°æ¥å£ tailscale ï¼Œä¼šå°åŒ…éš§é“å‘å¾€åˆ°åŒæ ˆæœºå™¨ä¸Šã€‚</li><li>ç„¶ååŒæ ˆæœºå™¨ä¸Šè§£åŒ…åï¼Œæœ¬æœºå¼€äº†ipv4 ipv6 forward ï¼Œèµ°è·¯ç”± <code>2002:db8:0:1::/64</code> åˆ°å³ä¾§çš„å•æ ˆæœºå™¨ï¼Œå³ä¾§æœºå™¨å›åŒ…ï¼ˆ<code>fd7a:115c:a1e0::/48</code>ï¼‰èµ°è‡ªå·±é»˜è®¤è·¯ç”±åˆ°åŒæ ˆæœºå™¨ï¼Œå†å‘åˆ°å®¢æˆ·ç«¯ã€‚</li></ul><p>ç„¶åæµ‹è¯•äº†ä¸‹å‘ç°å¶å°”ä¼šæ–­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ssh 2002:db8:0:1::101</span><br><span class="line">ssh: connect to host 2002:db8:0:1::101 port 22: No route to host</span><br><span class="line">$ ssh 2002:db8:0:1::101</span><br><span class="line">root@2002:db8:0:1::101<span class="string">&#x27;s password: </span></span><br></pre></td></tr></table></figure><p>åŒæ ˆæœºå™¨ä¸Š <code>ip -6 r s | grep 2002:db8</code> çœ‹è·¯ç”±è¡¨åˆæ²¡é—®é¢˜ï¼Œæ€€ç–‘æ˜¯ <code>2002:db8:0:1::/64</code> çš„å¶å°”èµ°å‡ºå»åˆ°ç‰©ç†äº¤æ¢æœºä¸Šäº†ï¼Œç„¶åç»™åŒæ ˆæœºå™¨å¢åŠ äº†ä¸ªç½‘å¡éš”ç¦»å¼€ï¼Œä¹Ÿå°±æ˜¯æŠŠ IPv6 ä¸»æœºä½ 1 çš„ IP é…ç½®åœ¨è¯¥ç½‘å¡ä¸Šï¼Œæµ‹è¯•ä¸‹å‘ç°å¾ˆç¨³å®šã€‚</p><p>ç„¶åç»™ç ”å‘å’Œæµ‹è¯•å†™äº†ä¸ªå®‰è£… tailscale å®¢æˆ·ç«¯å’Œæ¥å…¥æ–‡æ¡£ï¼Œå¾ˆæ–¹ä¾¿ã€‚</p><h2 id="2024-x2F-10-åç»­çš„ä¸€äº›é—®é¢˜å’Œå‘ç°"><a href="#2024-x2F-10-åç»­çš„ä¸€äº›é—®é¢˜å’Œå‘ç°" class="headerlink" title="2024&#x2F;10 åç»­çš„ä¸€äº›é—®é¢˜å’Œå‘ç°"></a>2024&#x2F;10 åç»­çš„ä¸€äº›é—®é¢˜å’Œå‘ç°</h2><p>pc ç«¯ä¹Ÿæœ‰åº”ç”¨ç ”å‘ï¼Œé€‚é…åï¼Œåé¦ˆç”¨ ipv6 IP url è½¯ä»¶å†…çš„ç™»å½•é¡µæ˜¯æœ‰ç™»å½•æ¡†æ˜¾ç¤ºï¼Œé…ç½®çš„ hosts åŸŸååˆ™ä¸è¡Œä¹Ÿå°±æ˜¯ä¸‹é¢ç›¸å…³é€»è¾‘ï¼š</p><ol><li>ç‚¹å‡»ç™»å½•æŒ‰é’®åæœ‰ä¸ªå¼¹å‡ºçš„å†…åµŒé¡µé¢ï¼Œä¼šè¯·æ±‚åŸŸå url</li><li>æŠŠè·å–åˆ° http body å±•ç¤ºåœ¨å†…åµŒé¡µ</li></ol><p>ç°è±¡æ˜¯å†…åµŒé¡µä¸€ç›´æ˜¯ç©ºç™½ï¼Œåé¦ˆè¯´æ‰“å¼€ Charles æŠ“åŒ…å°±èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚æ²¡åŠæ³•åªæœ‰è®©ä»–æ”¹æºç ï¼Œè®©åœ¨ 1 çš„ç½‘ç»œè¯·æ±‚ç»“æœå’Œé”™è¯¯éƒ½æ‰“å°ä¸‹çœ‹çœ‹ï¼Œç»™æˆ‘åé¦ˆè¯´æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERR_NAME_NOT_RESOLVED</span><br></pre></td></tr></table></figure><p>ç¡®å®æ˜¯åŸŸåæ— æ³•è§£æï¼Œä½†æ˜¯æˆ‘ä»¬ä¸šåŠ¡ä¹Ÿå¯ä»¥ç›´æ¥æµè§ˆå™¨è®¿é—®ï¼Œæµè§ˆå™¨ç”¨ hosts åŸŸåå¯ä»¥è®¿é—®çš„ï¼Œæœ‰äº›è½¯ä»¶ä¼šæ— è§†ç³»ç»Ÿçš„ hosts æ–‡ä»¶æ˜¯è‡ªå·±å®ç°ç›¸å…³åŸŸåè§£æé€»è¾‘ï¼Œè®©ä»–ä»è¿™æ–¹é¢æ’æŸ¥ä¸‹çœ‹çœ‹ã€‚</p><p>ç¬¬äºŒå¤©ä»–åœ¨ Linux ä¸Šå‘ç°ç›¸å…³é—®é¢˜ï¼Œå¼€äº†çŒ«å’ªä»£ç†åå†…åµŒé¡µæœ‰å†…å®¹ï¼Œé—®ä»–æ˜¯ä¸æ˜¯çŒ«å’ªè‡ªåŠ¨æ›´æ–°äº†ï¼Œç»™æˆ‘æˆªå›¾äº†ä¸‹ç•Œé¢ï¼Œçœ‹äº†ä¸‹ <code>IPv6</code> é€‰é¡¹å¼€å¯çš„ï¼Œè®©ä»–å…³é—­åå†è¯•è¯•å°±ä¸è¡Œäº†ï¼Œè€Œ windows ä¸ŠçŒ«å’ªå¼€ä¸å¼€ IPv6 é€‰é¡¹éƒ½ä¸è¡Œã€‚<br>å‘ç°å¾ˆå¥‡æ€ªï¼Œå°±è¦æ¥äº†å®‰è£…åŒ…ï¼Œè‡ªå·±å¼€äº†ä¸ª windows ä¹Ÿå¤ç°è¿™ä¸ªäº†é—®é¢˜ï¼Œæƒ³ç€çœ‹äº†ä¸‹çŒ«å’ª meta å†…æ ¸æºç èƒ½ä¸èƒ½æ‰¾åˆ°çœ‰ç›®ï¼Œ yaml ipv6 å­—æ®µä½¿ç”¨çš„åœ°æ–¹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> General <span class="keyword">struct</span> &#123;</span><br><span class="line">Inbound</span><br><span class="line">Mode                    T.TunnelMode      <span class="string">`json:&quot;mode&quot;`</span></span><br><span class="line">UnifiedDelay            <span class="type">bool</span>              <span class="string">`json:&quot;unified-delay&quot;`</span></span><br><span class="line">LogLevel                log.LogLevel      <span class="string">`json:&quot;log-level&quot;`</span></span><br><span class="line">IPv6                    <span class="type">bool</span>              <span class="string">`json:&quot;ipv6&quot;`</span></span><br></pre></td></tr></table></figure><p>ç„¶åä¼ é€’é…ç½®å˜é‡é‡Œ</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> general.IPv6 != <span class="literal">nil</span> &#123;</span><br><span class="line">resolver.DisableIPv6 = !*general.IPv6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æè¡Œä¸ºç›¸å…³çš„å‡½æ•°</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LookupIPWithResolver</span><span class="params">(ctx context.Context, host <span class="type">string</span>, r Resolver)</span></span> ([]netip.Addr, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> node, ok := DefaultHosts.Search(host, <span class="literal">false</span>); ok &#123;</span><br><span class="line"><span class="keyword">return</span> node.IPs, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> r != <span class="literal">nil</span> &amp;&amp; r.Invalid() &#123;</span><br><span class="line"><span class="keyword">if</span> DisableIPv6 &#123;</span><br><span class="line"><span class="keyword">return</span> r.LookupIPv4(ctx, host)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> r.LookupIP(ctx, host)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> DisableIPv6 &#123;</span><br><span class="line"><span class="keyword">return</span> LookupIPv4WithResolver(ctx, host, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å¼€å¯ ipv6 èµ°çš„æ˜¯ <code>r.LookupIP</code> æ–¹æ³•ï¼Œè·³è½¬è¿‡å»æ˜¯èµ°çš„ ipv6 dns è§£æ</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Resolver)</span></span> LookupIP(ctx context.Context, host <span class="type">string</span>) (ips []netip.Addr, err <span class="type">error</span>) &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> []netip.Addr, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(ch)</span><br><span class="line">ip, err := r.lookupIP(ctx, host, D.TypeAAAA)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ch &lt;- ip</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>å¼€äº†çŒ«å’ªçš„ ipv6 å½±å“äº†è§£æç›¸å…³ï¼Œç±»ä¼¼å¼ºåˆ¶ä½¿ç”¨ ipv6 è§£æè€Œå¯¼è‡´æ­£å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜ä¸æ­£å¸¸ç°è±¡æ˜¯å› ä¸ºèµ°çš„ ipv4 è§£æäº†ï¼Œæ€ä¹ˆé…ç½®ä½¿ç”¨ IPv6 ä¼˜å…ˆçº§ï¼Œå‘ç° windows æ˜¯ä¸‹é¢æŸ¥çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;netsh interface ipv6 show prefixpolicies</span><br><span class="line">æŸ¥è¯¢æ´»åŠ¨çŠ¶æ€...</span><br><span class="line"></span><br><span class="line">ä¼˜å…ˆé¡ºåº    æ ‡ç­¾   å‰ç¼€</span><br><span class="line">----------  -----  --------------------------------</span><br><span class="line">        50      0  ::1/128   </span><br><span class="line">        40      1  ::/0</span><br><span class="line">        35      4  ::ffff:0:0/96</span><br><span class="line">        30      2  2002::/16</span><br><span class="line">         5      5  2001::/32</span><br><span class="line">         3     13  fc00::/7</span><br><span class="line">         1     11  fec0::/10</span><br><span class="line">         1     12  3ffe::/16</span><br><span class="line">         1      3  ::/96</span><br></pre></td></tr></table></figure><p>æœåˆ°çš„éƒ½æ˜¯è¿™ä¸ªé»˜è®¤é…ç½®æ˜¯ IPv6 ä¼˜å…ˆçº§æ¯” IPv4 é«˜ï¼Œå¾ˆå¤šäººæ˜¯æƒ³ä¼˜å…ˆä½¿ç”¨ IPv4 è€Œæ”¹ä¸Šé¢ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬è¿™ä¸ªé—®é¢˜æ˜¯æƒ³ IPv6 ä¼˜å…ˆçº§é«˜ï¼Œè¿™ä¸ªé»˜è®¤é…ç½®æ˜¯æ²¡æœ‰é—®é¢˜ã€‚æ²¡åŠæ³•äº†ï¼Œå°±åœ¨ä¸Šé¢çš„åŒæ ˆæœºå™¨æ­å»º dns server çœ‹ä¸‹è§£æè®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; docker-compose.yml &lt;&lt; EOF</span><br><span class="line">services:</span><br><span class="line">  coredns:</span><br><span class="line">    image: docker.m.daocloud.io/coredns/coredns:1.11.3</span><br><span class="line">    container_name: coredns</span><br><span class="line">    restart: always</span><br><span class="line">    network_mode: host</span><br><span class="line">    cap_drop:</span><br><span class="line">      - ALL</span><br><span class="line">    cap_add:</span><br><span class="line">      - NET_BIND_SERVICE</span><br><span class="line">    volumes:</span><br><span class="line">      - ./config/:/etc/coredns/</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">    command: [&quot;-conf&quot;, &quot;/etc/coredns/Corefile&quot;]</span><br><span class="line"></span><br><span class="line">mkdir -p ./config/</span><br><span class="line">cat &gt; ./config/Corefile &lt;&lt; EOF</span><br><span class="line">.:53 &#123;</span><br><span class="line">   bind 0.0.0.0 ::</span><br><span class="line">   #bind  ::</span><br><span class="line">   hosts &#123;</span><br><span class="line">     10.xxx.xx.63 xxx.xxx.cn</span><br><span class="line">     2002:db8:0:1::101 xxx.xxx.cn</span><br><span class="line">     fallthrough</span><br><span class="line">   &#125;</span><br><span class="line">   forward . 223.5.5.5</span><br><span class="line">   log </span><br><span class="line">   errors</span><br><span class="line">   reload</span><br><span class="line">&#125;</span><br><span class="line">chmod a+r ./config/Corefile</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>è¯¥åŸŸå A è®°å½•å’Œ AAAA è®°å½•éƒ½æœ‰ï¼Œè®¾ç½®ä¸‹æµ‹è¯• windows çš„ dns server æŒ‡å‘åŒæ ˆæœºå™¨ç‚¹äº†ä¸‹ç™»å½•åï¼Œå‘ç° coredns æ—¥å¿—é‡Œè§£æçš„æ˜¯ A è®°å½•è§£æè¯·æ±‚ï¼Œé—®é¢˜å°±æ˜¯è¿™äº†ï¼ŒA è®°å½•çš„ IP æœºå™¨ä¸ŠæŠ“åŒ…å‘ç° http GET è¯·æ±‚å‘è¿‡æ¥äº†ï¼Œä½†æ˜¯æœºå™¨æ²¡æœ‰ç›‘å¬è¿™ä¸ªç«¯å£ï¼Œæ‰€ä»¥å†…åµŒç™»å½•é¡µè¿˜æ˜¯ç©ºç™½å†…å®¹ã€‚</p><p>ä½†æ˜¯å¾ˆå¥‡æ€ªçš„æ˜¯ä¸ºå•¥ hosts æœ‰è¿˜èµ° dns è§£æè¯·æ±‚ï¼Œåé¢æµ‹è¯•äº†ä¸‹å‘ç°ä»¥ä¸‹å‡ ä¸ªç°è±¡ï¼š</p><ul><li>æœºå™¨ä¸Šé…ç½® IPv6 hostsï¼Œä¸å¯åŠ¨ tailscaleï¼š<ul><li>æ— æ³• ping é€šè¯¥åŸŸå</li><li><code>Resolve-DnsName xxx.xxx.cn</code> å¯ä»¥è§£æå‡ºåŸŸåï¼Œ<code>ipconfig /displaydns</code> é‡Œä¹Ÿæœ‰æ˜¾ç¤ºæœ‰ AAAA è®°å½•</li></ul></li><li>æœºå™¨ä¸Šé…ç½® IPv6 hostsï¼Œå¯åŠ¨ tailscaleï¼š<ul><li>å¯ä»¥è¢«è·¯ç”±çš„ IPv6 hosts åŸŸåå¯ä»¥è§£æ</li><li>ä¸å¯ä»¥è¢«è·¯ç”±çš„ IPv6 hosts åŸŸåæ— æ³•è§£æ</li></ul></li></ul><p>ç ”å‘åé¦ˆå†…åµŒé¡µç”¨åˆ°äº† Chromium Embedded Framework æ¡†æ¶ï¼Œä½†æ˜¯æˆ‘è‡ªå·±çš„ chrome æµè§ˆå™¨è®¿é—®åŸŸåä¸šåŠ¡æ˜¯å¯ä»¥çš„ï¼Œæƒ³ç€ä¼šä¸ä¼šç ”å‘ä»–ä»¬çš„ CEF æ¡†æ¶å†…çš„ chrome ç‰ˆæœ¬ä½çš„é—®é¢˜ï¼Œæœç›¸å…³å…³é”®å­— <code>chrome not use hosts file ipv6</code> æœåˆ°äº†åŒæ ·çš„é—®é¢˜ <a href="https://superuser.com/questions/1421602/chrome-not-using-hosts-file-for-ipv6-addresses-since-v73">Chrome not using hosts file for IPv6 addresses since v73</a></p><p>é“¾æ¥é‡Œä¸‹é¢çš„å›ç­”æ˜¯ chrome æ—©æœŸç‰ˆæœ¬æ¢æµ‹ IPv6 æ˜¯å¦å¯ç”¨æ˜¯çœ‹ <code>2001:4860:4860::8888/128</code> ç½‘æ®µæ˜¯å¦å¯ä»¥è¢«è·¯ç”±ï¼Œç„¶åå°è¯•äº† powershell ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ·»åŠ  IPv6 è·¯ç”±è§£å†³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface ipv6  add route 2001:4860:4860::8888/128 interface=1</span><br></pre></td></tr></table></figure><p>ç„¶åä¼˜é›…è§£å†³çš„è¯ï¼Œä¸èƒ½è®©ç›¸å…³ windows æµ‹è¯•äººå‘˜æœ¬æœºæ·»åŠ è·¯ç”±ï¼Œè€Œæ˜¯åˆ©ç”¨ headscale ä¸‹å‘è·¯ç”±ï¼Œç»™åŒæ ˆæœºå™¨ä¸Šçš„ tailscale å¢åŠ ä¸Šè¿™ä¸ªè·¯ç”±ä¸‹å‘åˆ°æ‰€æœ‰å…¶ä»– tailscale ä¸Šï¼ŒåŒæ ˆæœºå™¨ä¸Šä½¿ç”¨ tailscale setï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tailscale set --advertise-routes 2002:db8:0:1::/64,2001:4860:4860::8888/128 --snat-subnet-routes=false</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://ipw.cn/doc/ipv6/user/ipv4_ipv6_prefix_precedence.html">Windows 10&#x2F;11 è®¾ç½® IPv4&#x2F;IPv6 è®¿é—®ä¼˜å…ˆçº§</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•è¿‘æœŸ IPv6 å•æ ˆä¸‹ ä¸€äº›å‘&lt;/p&gt;</summary>
    
    
    
    
    <category term="headscale" scheme="http://zhangguanzhang.github.io/tags/headscale/"/>
    
    <category term="derper" scheme="http://zhangguanzhang.github.io/tags/derper/"/>
    
  </entry>
  
  <entry>
    <title>[æŒç»­æ›´æ–°] - headscale æ­å»ºå’Œåº”ç”¨åœºæ™¯</title>
    <link href="http://zhangguanzhang.github.io/2024/07/25/headscale/"/>
    <id>http://zhangguanzhang.github.io/2024/07/25/headscale/</id>
    <published>2024-07-25T23:10:30.000Z</published>
    <updated>2024-07-25T23:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>é•¿æœŸè®°å½•å’Œæ›´æ–°å…³äº headscale éƒ¨ç½²å’Œåº”ç”¨åœºæ™¯</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>è¿™å‡ å¤©æŠ˜è…¾äº†ä¸‹ headscale éƒ¨ç½²ï¼Œå‘ç°ç½‘ä¸Šå¾ˆå¤šéƒ¨ç½²æ–‡ç« éƒ½äº’ç›¸æŠ„è¢­æ²¡æœ‰è‡ªå·±çš„æŠ˜è…¾ç†è§£ï¼Œæ‰€ä»¥å†™ä¸‹éƒ¨ç½²ä»¥åŠè®²è§£ä¸€äº›å…³é”®åœ°æ–¹ï¼Œæœ¬æ–‡ç« é€‚åˆæœ‰ Linux åŸºç¡€å’Œéƒ¨ç½²è¿‡ headscale æˆ–è€…æƒ³éƒ¨ç½²ä½†æ˜¯æ„Ÿè§‰å¸‚é¢ä¸Šæ–‡ç« å†™å¾—æ²¡æœ‰é€‚åˆå‘½ä»¤è¡Œé€‰æ‰‹çš„ã€‚</p><h2 id="ä¸ºä»€ä¹ˆæˆ‘éœ€è¦-headscale"><a href="#ä¸ºä»€ä¹ˆæˆ‘éœ€è¦-headscale" class="headerlink" title="ä¸ºä»€ä¹ˆæˆ‘éœ€è¦ headscale"></a>ä¸ºä»€ä¹ˆæˆ‘éœ€è¦ headscale</h2><p>ä¹‹å‰ä¸€ç›´ä½¿ç”¨ <a href="https://zhangguanzhang.github.io/2020/08/05/wireguard-for-personal/">wireguard ç»„ç½‘</a>ï¼Œå„åœ°äº’è®¿æ˜¯æ²¡é—®é¢˜ã€‚</p><p><img src="https://raw.githubusercontent.com/zhangguanzhang/Image-Hosting/master/picgo/wireguard-simple.png" alt="wireguard-simple"></p><p>ä½†æ˜¯æœ€è¿‘è¿œç¨‹ scrcpy æ§åˆ¶å®¶é‡Œçš„æ‰‹æœºå‘ç°å¾ˆæ…¢å—ä¸äº†ï¼Œä¹Ÿå°±æ˜¯å› ä¸º wireguard æ‰€æœ‰ç«¯ï¼Œé™¤äº† ecs ä»¥å¤–éƒ½æ˜¯æ²¡æœ‰å…¬ç½‘ IPï¼Œéƒ½æ˜¯ ecs è½¬å‘è€Œå­˜åœ¨æœ¨æ¡¶æ•ˆåº”ï¼Œå³ä½¿æ¯ä¸ª wireguard èŠ‚ç‚¹æœ‰å…¬ç½‘ IPï¼Œéšç€ç«¯è¶Šæ¥è¶Šå¤šé…ç½®èµ·æ¥ä¹Ÿéå¸¸ç¹ççš„ã€‚</p><p>å¦‚æœåªéœ€è¦ä¸€ä¸ª ecs å…¬ç½‘ IPï¼Œç„¶åå„ä¸ªç«¯èƒ½ NAT æ‰“æ´ç›´è¿ï¼ˆä¾‹å¦‚ä¸Šé¢çš„å·¦è¾¹æ‰‹æœºå’Œå·¦ä¸‹è§’ç”µè„‘èƒ½æ‰“æ´æˆåŠŸç›´è¿ï¼Œä¸èµ° ecs ä¸­ç»§ï¼‰ï¼Œé€Ÿåº¦ä¹Ÿä¼šä¸é”™å‘¢ã€‚</p><p><img src="https://cdn.oss.link/markdown/MrF6yn.png" alt="nat-th"></p><p>æ²¡é”™ï¼Œtailscale å°±æ˜¯ä¹Ÿæ˜¯ä½¿ç”¨ wireguard åè®®ï¼ˆæ²¡æœ‰å†…æ ¸æ¨¡å—å°±ä½¿ç”¨ç”¨æˆ·æ€ï¼‰ï¼Œç„¶åæ§åˆ¶å¹³é¢å¾ˆå¼ºï¼ˆå¯ä»¥ç»™å„ä¸ªç«¯æ¨é€å’Œæ›´æ–°é…ç½®ï¼Œä»¥åŠè¿˜æ”¯æŒ ACLï¼‰ï¼Œè€Œ headscale å°±æ˜¯å¼€æºçš„ tailscale çš„æ§åˆ¶ç«¯ã€‚è¿™é‡Œä¸è®²è§£æ¥å…¥ tailscale å®˜æ–¹ï¼Œè€Œæ˜¯è‡ªå»º headscale ã€‚</p><p>å¯èƒ½æœ‰å…¶ä»–äººé—®ä¸ºå•¥ä¸ç”¨ zerotier æˆ–è€…å…¶ä»–å•¥çš„ï¼Œé‚£æ˜¯å› ä¸ºï¼š</p><ul><li>é¦–å…ˆ wireguard æ˜¯ Linux å†…æ ¸æ¨¡å—ï¼Œå³ä½¿ä¸æ”¯æŒçš„ä¹Ÿæœ‰ç”¨æˆ·æ€ wireguard çš„å¾ˆå¤šæˆç†Ÿè½®å­</li><li>tailscale çš„å¤šç«¯æ”¯æŒå¾ˆå¥½ï¼ŒiOSã€MacOS ã€å®‰å“ã€winã€Linux</li><li>å¹¶ä¸” tailscale æ”¯æŒ IPv6ï¼Œåœ¨å…¬å¸å†…éƒ¨å·²ç»ä½¿ç”¨æ­å»º IPv6 æµ‹è¯•ç¯å¢ƒç»è¿‡å¤šè½®éªŒè¯äº†</li><li>æ§åˆ¶ä¸­å¿ƒå³ä½¿ä¸ç”¨ tailscale çš„ä¹Ÿå¯ä»¥é€‰æ‹©ç”¨ headscale</li><li>tailscale å¤–å›½ç”¨æˆ·ç¾¤ä½“å¤§ï¼Œè€Œä¸” tailscale æœ‰é—®é¢˜åŸºæœ¬ä¸Š tailscale å¼€å‘è€…ä¼šä¿®å¤</li></ul><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>æœ¬æ•™ç¨‹éƒ½æ˜¯ ecs å…¬ç½‘ IP å½¢å¼éƒ¨ç½²ï¼Œè‡ªå·±æœ‰ https ç»¿é”è¯ä¹¦çš„ï¼Œç›¸å…³é…ç½®è‡ªå·±ç ”ç©¶ï¼Œæ–‡ç« æ¶‰åŠåˆ°çš„ç«¯å£éœ€è¦åœ¨ ecs å®‰å…¨ç»„ä»¥åŠé˜²ç«å¢™ç›¸å…³ç«¯å£è‡ªè¡Œæ”¾è¡Œ:</p><table><thead><tr><th>åè®®</th><th>ç«¯å£</th></tr></thead><tbody><tr><td>tcp</td><td>headscale web server ç«¯å£</td></tr><tr><td>tcp</td><td>headscale å†…ç½® derp çš„ https ç«¯å£</td></tr><tr><td>udp</td><td>derp çš„ stun ç«¯å£</td></tr></tbody></table><p>æœºå™¨åŸºç¡€å‚æ•°è‡ªè¡Œè®¾ç½®å¥½ï¼Œä¾‹å¦‚è½¬å‘å’Œæ–‡ä»¶æ‰“å¼€æ•°ã€‚</p><h3 id="å†å²ç‰ˆæœ¬"><a href="#å†å²ç‰ˆæœ¬" class="headerlink" title="å†å²ç‰ˆæœ¬"></a>å†å²ç‰ˆæœ¬</h3><p>å½’æ¡£åœ¨æˆ‘ gist ä¸Š <a href="https://gist.github.com/zhangguanzhang/db9f6862eef4c82f6918852953a48458">headscale</a></p><h3 id="headscale-éƒ¨ç½²å’Œè®¾ç½®"><a href="#headscale-éƒ¨ç½²å’Œè®¾ç½®" class="headerlink" title="headscale éƒ¨ç½²å’Œè®¾ç½®"></a>headscale éƒ¨ç½²å’Œè®¾ç½®</h3><p>å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://headscale.net/running-headscale-linux-manual/">running-headscale-linux-manual</a> ï¼Œå› ä¸º headscale ä¸ä¾èµ– CGOï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œå®˜æ–¹è¿™ä¸ªæ–‡æ¡£ä¹Ÿæ˜¯éšè—èµ·æ¥çš„ï¼Œæ€ä¹ˆéƒ¨ç½²éƒ½å¯ä»¥ï¼Œä¸ä¸€å®šè¦å’Œæˆ‘ä¸€æ ·ã€‚</p><p>æˆªè‡³ <code>2025/01/25</code> ï¼Œä»å®˜æ–¹ä»“åº“çœ‹ï¼Œæ­£å¼çš„ release ç‰ˆæœ¬æ˜¯ <code>v0.24.1</code>ï¼Œå¾ˆå¤šæ–‡ç« éƒ½æ˜¯ä» main ä¸‹è½½ <code>config-example.yaml</code> æ–‡ä»¶åæŒ‰ç…§ä»–ä»¬æ–‡ç« ä¿®æ”¹å­—æ®µå¯¹åº”ä¸ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/headscale/</span><br><span class="line"></span><br><span class="line">VER=0.24.1</span><br><span class="line"><span class="comment"># è‡ªè¡Œè§£å†³ä¸‹è½½é—®é¢˜  # æœ‰äº›è€ç³»ç»Ÿçš„ PATH é‡Œæ²¡ /usr/local/bin/ ï¼Œå¯ä»¥æ”¾å…¶ä»–è·¯å¾„é‡Œ</span></span><br><span class="line">wget https://github.com/juanfont/headscale/releases/download/v<span class="variable">$&#123;VER&#125;</span>/headscale_<span class="variable">$&#123;VER&#125;</span>_linux_amd64</span><br><span class="line"><span class="comment"># ä¸‹è½½åŒç‰ˆæœ¬çš„ç¤ºä¾‹é…ç½®æ–‡ä»¶</span></span><br><span class="line">wget -O /etc/headscale/config.yaml https://raw.githubusercontent.com/juanfont/headscale/v<span class="variable">$&#123;VER&#125;</span>/config-example.yaml</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> a+x /usr/local/bin/headscale</span><br></pre></td></tr></table></figure><p>åˆ›å»º headscale daemon systemd åå°æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/headscale.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=headscale controller</span></span><br><span class="line"><span class="string">After=syslog.target</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">User=headscale</span></span><br><span class="line"><span class="string">Group=headscale</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/headscale serve</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Optional security enhancements</span></span><br><span class="line"><span class="string">NoNewPrivileges=yes</span></span><br><span class="line"><span class="string">PrivateTmp=yes</span></span><br><span class="line"><span class="string">ProtectSystem=strict</span></span><br><span class="line"><span class="string">ProtectHome=yes</span></span><br><span class="line"><span class="string">WorkingDirectory=/var/lib/headscale</span></span><br><span class="line"><span class="string">ReadWritePaths=/var/lib/headscale /var/run/headscale</span></span><br><span class="line"><span class="string">AmbientCapabilities=CAP_NET_BIND_SERVICE</span></span><br><span class="line"><span class="string">RuntimeDirectory=headscale</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>å› ä¸º headscale æ˜¯ä¸€ä¸ªæ§åˆ¶ä¸­å¿ƒï¼Œä¸éœ€è¦ç‰¹æƒï¼Œæˆ‘ä»¬è¿è¡Œåœ¨é root ç”¨æˆ·ä¸‹ï¼Œæ·»åŠ ç”¨æˆ·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">useradd \</span><br><span class="line">  --create-home \</span><br><span class="line">  --home-dir /var/lib/headscale/ \</span><br><span class="line">  --system \</span><br><span class="line">  --user-group \</span><br><span class="line">  --shell /usr/sbin/nologin \</span><br><span class="line">  headscale</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /var/run/headscale/</span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ›å»ºç©ºçš„ SQLite æ•°æ®åº“æ–‡ä»¶å’Œ derp æ–‡ä»¶ï¼š</span></span><br><span class="line"><span class="built_in">touch</span> /var/lib/headscale/db.sqlite /etc/headscale/derp.yaml</span><br><span class="line"><span class="built_in">chown</span> -R headscale:headscale /var/run/headscale/ /var/lib/headscale</span><br><span class="line"><span class="built_in">chmod</span> a+r /etc/headscale/config.yaml /etc/headscale/derp.yaml</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ <code>vi /etc/headscale/config.yaml</code> å¯¹ç…§ä¸‹é¢æ³¨é‡Šè¯´æ˜, ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸€äº›å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># server_url å†™å¤–ç½‘è®¿é—®çš„ ip+ç«¯å£</span><br><span class="line"># ç”±äºæ˜¯ecsï¼Œæ‰€ä»¥å†™å…¬ç½‘ IPï¼Œä»¥åŠåé¢çš„ç«¯å£è¦å’Œ listen_addr çš„ä¸€è‡´</span><br><span class="line"># 80 443 8080 éœ€è¦å¤‡æ¡ˆ</span><br><span class="line">server_url: http://&lt;ecs_public_ip&gt;:8081</span><br><span class="line"># æ”¹ä¸ºå››ä¸ª0ï¼Œæˆ–è€…å¯¹åº”å…¬ç½‘ IP çš„å†…ç½‘ç½‘å¡ IP éƒ½è¡Œ</span><br><span class="line">listen_addr: 0.0.0.0:8081</span><br><span class="line"></span><br><span class="line">prefixes:</span><br><span class="line">  # å› ä¸ºæˆ‘æœºå™¨åœ¨é˜¿é‡Œäº‘ä¸Šä¿®æ”¹ä¸ºä¸‹é¢ç½‘æ®µï¼Œé˜¿é‡Œäº‘çš„ 100.63.0.0/10 æœ‰ç”¨</span><br><span class="line">  v4: 100.63.0.0/16</span><br><span class="line">  # å¦‚æœä¸å¸Œæœ›ç»™è®¾å¤‡ä¸‹å‘ ipv6 å¯ä»¥æ³¨é‡Šäº†</span><br><span class="line">  v6: fd7a:115c:a1e0::/48</span><br><span class="line"></span><br><span class="line">derp:</span><br><span class="line">  server:</span><br><span class="line">    # ä½¿ç”¨ç”¨ headscale å†…åµŒçš„ derper æœåŠ¡å™¨</span><br><span class="line">    enabled: false</span><br><span class="line">  # æ³¨é‡Šæ‰ä¸ä½¿ç”¨å®˜æ–¹çš„ derp æœåŠ¡</span><br><span class="line">  #urls: []</span><br><span class="line">#    - https://controlplane.tailscale.com/derpmap/default</span><br><span class="line">  # ä¸‹é¢å†™ ecs å…¬ç½‘ IP</span><br><span class="line">  ipv4: x.x.x.x</span><br><span class="line"></span><br><span class="line"># å…³é—­ headscale è‡ªåŠ¨æ›´æ–°ï¼Œé¿å… break change æ— æ³•å¯åŠ¨</span><br><span class="line">disable_check_updates: true</span><br><span class="line"></span><br><span class="line">dns:</span><br><span class="line">  # å…³é—­ magic_dns</span><br><span class="line">  magic_dns: false</span><br><span class="line">  # è®¾ç½®ä¸ºä½ è‡ªå·±çš„æ ‡è¯†ï¼Œå¦åˆ™åç»­ tailscale ç«¯è¿æ¥ä¸Šæ˜¾ç¤ºæ˜¯ user@example.com</span><br><span class="line">  base_domain: xxx</span><br><span class="line"></span><br><span class="line"># ä¸‹é¢å‰ä¿©ä¿®æ”¹ä¸ºå›½å†…çš„ dns</span><br><span class="line">  nameservers:</span><br><span class="line">    global:</span><br><span class="line">      - 223.5.5.5</span><br><span class="line">      - 223.6.6.6</span><br><span class="line"></span><br><span class="line"># éšæœºç«¯å£è¦æ‰“å¼€ï¼Œ tailscale å®¢æˆ·ç«¯ä¼šä½¿ç”¨41641 ç«¯å£å»ºç«‹ wireguard é“¾æ¥ï¼Œè¿™ä¸ªç«¯å£ä¼šè¢«ä¸­é—´ç½‘ç»œè®¾å¤‡é˜»æ­¢</span><br><span class="line">randomize_client_port: true</span><br></pre></td></tr></table></figure><p>å®‰è£…å’Œè®¾ç½® headscale è¡¥å…¨ï¼Œå› ä¸º headscale æ˜¯ daemon å’Œ cli ä¸¤éƒ¨åˆ†ï¼Œdaemon èµ·æ¥å cli å¾ˆå¤šå‘½ä»¤å¯ä»¥æ“ä½œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install -y bash-completion</span><br><span class="line">headscale completion bash &gt; /etc/bash_completion.d/headscale</span><br><span class="line">. /etc/bash_completion.d/headscale</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ headscale daemon è¿›ç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æµ‹è¯•æ–‡ä»¶</span></span><br><span class="line">headscale configtest</span><br><span class="line"></span><br><span class="line">headscale serve</span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶æ²¡é—®é¢˜å°± ctrl +c å–æ¶ˆæ‰ä½¿ç”¨ systemd å¯åŠ¨</span></span><br><span class="line"><span class="built_in">chown</span> -R headscale:headscale /var/lib/headscale</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now headscale</span><br></pre></td></tr></table></figure><h3 id="derp-éƒ¨ç½²"><a href="#derp-éƒ¨ç½²" class="headerlink" title="derp éƒ¨ç½²"></a>derp éƒ¨ç½²</h3><p>å…ˆecs ä¸Šä¹Ÿéƒ¨ç½²ä¸€ä¸ªï¼Œå…ˆæŸ¥çœ‹æœºå™¨ä¸Šçš„ iptables æ¨¡å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -w -V</span><br><span class="line">iptables v1.4.21</span><br><span class="line">iptables v1.8.4 (legacy)</span><br><span class="line"><span class="comment">#----</span></span><br><span class="line">iptables v1.8.9 (nf_tables)</span><br></pre></td></tr></table></figure><p>å‰è€…éƒ½æ˜¯ <code>legacy</code> æ¨¡å¼ï¼Œåè€…æ˜¯ <code>nf_tables</code>ï¼Œä¸‹é¢çš„ tailscale éœ€è¦è®¾ç½® <a href="https://tailscale.com/kb/1294/firewall-mode">firewall-mode</a> ä¸º <code>iptables</code> æˆ–è€… <code>nftables</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">docker-compose.yml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://tailscale.com/kb/1282/docker</span></span><br><span class="line">  <span class="attr">tailscale:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">tailscale</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">tailscale</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.m.daocloud.io/tailscale/tailscale:v1.74.1</span></span><br><span class="line">      <span class="comment">#image: tailscale/tailscale:unstable</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_RAW</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sys_module</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/lib/modules:/lib/modules</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/run/xtables.lock:/run/xtables.lock:rw</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/tailscale/:/var/run/tailscale/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./tailscale_data:/var/lib/tailscale</span></span><br><span class="line">    <span class="attr">devices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/dev/net/tun:/dev/net/tun</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TS_EXTRA_ARGS:</span> <span class="string">--advertise-tags=tag:container</span></span><br><span class="line">      <span class="attr">TS_AUTH_ONCE:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">TS_HOSTNAME:</span> <span class="string">ecs</span></span><br><span class="line">      <span class="attr">TS_USERSPACE:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="comment"># ç¦ç”¨æ”¶é›†æˆ–å‘é€ä»»ä½•æ—¥å¿—æ•°æ®ï¼Œä¼šå‘å¾€ https://log.tailscale.io</span></span><br><span class="line">      <span class="attr">TS_NO_LOGS_NO_SUPPORT:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">TS_SOCKET:</span> <span class="string">&quot;/var/run/tailscale/tailscaled.sock&quot;</span></span><br><span class="line">      <span class="attr">TS_STATE_DIR:</span> <span class="string">/var/lib/tailscale/</span></span><br><span class="line">        <span class="comment">#TS_LOGIN_SERVER: &quot;http://127.0.0.1:528&quot;</span></span><br><span class="line">        <span class="comment">#TS_CONTROL_IS_PLAINTEXT_HTTP: &quot;true&quot;</span></span><br><span class="line">      <span class="attr">TS_DEBUG_FIREWALL_MODE:</span> <span class="string">nftables</span> <span class="comment"># ä½¿ç”¨å’Œå®¿ä¸»æœºæ¨¡å¼ä¸€è‡´çš„</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">derper:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">derper</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/zhangguanzhang/derper:v1.70.0</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime:ro</span></span><br><span class="line">      <span class="comment"># å®¹å™¨ç”Ÿæˆçš„è¯ä¹¦å­˜æ”¾ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„ç»¿é”è¯ä¹¦ï¼Œå­˜æ”¾æ–‡ä»¶åä¸º</span></span><br><span class="line">      <span class="comment"># $DERP_DOMAIN.key $DERP_DOMAIN.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cert:/cert</span> </span><br><span class="line">      <span class="bullet">-</span>  <span class="string">/var/run/tailscale/:/var/run/tailscale/</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">DERP_DOMAIN:</span> <span class="string">my.mydomain.no</span> <span class="comment"># åŸŸåï¼Œç”±äºä¸æ˜¯ç»¿é” httpsï¼Œéšæ„å†™ï¼Œå’Œåé¢ derp.yaml ä¸€è‡´å³å¯</span></span><br><span class="line">      <span class="attr">DERP_ADDR:</span> <span class="string">&#x27;:12345&#x27;</span> <span class="comment"># https ç«¯å£</span></span><br><span class="line">      <span class="attr">DERP_STUN_PORT:</span> <span class="string">&#x27;3478&#x27;</span> <span class="comment"># udp port</span></span><br><span class="line">      <span class="attr">DERP_HTTP_PORT:</span> <span class="string">&#x27;-1&#x27;</span></span><br><span class="line">      <span class="attr">DERP_VERIFY_CLIENTS:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">DERP_CERT_DIR:</span> <span class="string">/cert</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tailscale</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="å®¢æˆ·ç«¯æ¥å…¥"><a href="#å®¢æˆ·ç«¯æ¥å…¥" class="headerlink" title="å®¢æˆ·ç«¯æ¥å…¥"></a>å®¢æˆ·ç«¯æ¥å…¥</h3><p>æ‰€æœ‰å®¢æˆ·ç«¯æœ‰å¾®çš®æ©çš„ï¼Œéœ€è¦æŠŠ ecs çš„å…¬ç½‘ IP è®¾ç½®æˆç›´è¿ä¸èµ°ä»£ç†ï¼Œä»¥åŠå¦‚æœæ˜¯å®¶é‡Œå®½å¸¦ï¼Œå¯ä»¥æŠŠ Upnp æ‰“å¼€ï¼Œè¿™æ ·æ‰“æ´ç›´è¿æˆåŠŸç‡ä¼šé«˜äº›ã€‚</p><h4 id="åˆ›å»º-authkeys"><a href="#åˆ›å»º-authkeys" class="headerlink" title="åˆ›å»º authkeys"></a>åˆ›å»º authkeys</h4><p>Tailscale ä¸­æœ‰ä¸€ä¸ªæ¦‚å¿µå« tailnetï¼Œä½ å¯ä»¥ç†è§£æˆç§Ÿæˆ·ï¼Œç§Ÿæˆ·ä¸ç§Ÿæˆ·ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå…·ä½“çœ‹å‚è€ƒ Tailscale çš„å®˜æ–¹æ–‡æ¡£ï¼š <a href="https://tailscale.com/kb/1136/tailnet">What is a tailnet</a>ã€‚<br>Headscale ä¹Ÿæœ‰ç±»ä¼¼çš„å®ç°å« userï¼Œå³ç”¨æˆ·ã€‚æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª userï¼Œä»¥ä¾¿åç»­å®¢æˆ·ç«¯æ¥å…¥ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">headscale user create default</span><br></pre></td></tr></table></figure><p>å…¶ä»–å®¢æˆ·ç«¯æ¥å…¥éœ€è¦é¦–å…ˆåœ¨æœåŠ¡ç«¯ç”Ÿæˆ pre-authkey çš„ key ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆä¸€ä¸ªè¿‡æœŸæ—¶é—´ 365d ä¸”å¯ä»¥é‡å¤ä½¿ç”¨çš„ authkey</span></span><br><span class="line">$ headscale preauthkeys --user default create --reusable --expiration 365d </span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·²ç»ç”Ÿæˆçš„ keyï¼š</span></span><br><span class="line">$ headscale preauthkeys --user default list</span><br><span class="line">ID | Key                                              | Reusable | Ephemeral | Used  | Expiration          | Created             | Tags</span><br><span class="line">1  | 49f9cd7f4e7b3e33023a9064xxxxxebf00778d2xxxxxxxxx | <span class="literal">false</span>    | <span class="literal">false</span>     | <span class="literal">false</span> | 2025-07-24 14:32:45 | 2024-07-24 14:32:45 | </span><br></pre></td></tr></table></figure><p>tailscale ä¹Ÿæ˜¯åˆ†ä¸º tailscaled çš„ daemon å’Œ tailscale çš„ cli å·¥å…·ï¼Œwindowsã€Linux ä»¥åŠå®‰å“çš„ Magisk æ¨¡å—ç­‰éƒ½å¯ä»¥ä½¿ç”¨ cli å·¥å…·æ“ä½œå’Œæ’æŸ¥ï¼Œè¿™ç‚¹å¾ˆé‡è¦ã€‚</p><p>ä¸‹é¢æ˜¯ tailscale up æ—¶å€™ä¸€äº›å¸¸ç”¨é€šç”¨é€‰é¡¹ï¼š</p><ul><li><code>--login-server</code>: æŒ‡å®šä½¿ç”¨çš„ä¸­å¤®æœåŠ¡å™¨åœ°å€(å¿…å¡«)</li><li><code>--advertise-routes</code>: å‘ä¸­å¤®æœåŠ¡å™¨æŠ¥å‘Šå½“å‰å®¢æˆ·ç«¯å¤„äºå“ªä¸ªå†…ç½‘ç½‘æ®µä¸‹, ä¾¿äºä¸­å¤®æœåŠ¡å™¨è®©åŒå†…ç½‘è®¾å¤‡ç›´æ¥å†…ç½‘ç›´è¿(å¯é€‰çš„)æˆ–è€…å°†å…¶ä»–è®¾å¤‡æŒ‡å®šæµé‡è·¯ç”±åˆ°å½“å‰å†…ç½‘(å¯é€‰)ï¼Œå¤šæ¡è·¯ç”±è‹±æ–‡é€—å·éš”å¼€</li><li><code>--accept-routes</code>: æ˜¯å¦æ¥å—ä¸­å¤®æœåŠ¡å™¨ä¸‹å‘çš„ç”¨äºè·¯ç”±åˆ°å…¶ä»–å®¢æˆ·ç«¯å†…ç½‘çš„è·¯ç”±è§„åˆ™(å¯é€‰)</li><li><code>--accept-dns</code>: æ˜¯å¦ä½¿ç”¨ä¸­å¤®æœåŠ¡å™¨ä¸‹å‘çš„ DNS ç›¸å…³é…ç½®(å¯é€‰, æ¨èå…³é—­)</li><li><code>--hostname</code>: è®¾ç½® machine nameï¼Œå¦åˆ™é»˜è®¤ä¼šä»¥ hostname æ³¨å†Œä¸Šå»ï¼Œç‰¹åˆ«å®‰å“çš„ hostname æ— æ³•ä¿®æ”¹</li></ul><p>tailscale cli å®˜æ–¹æ–‡æ¡£ <a href="https://tailscale.com/kb/1080/cli%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%87%AA%E5%B7%B1">https://tailscale.com/kb/1080/cliï¼Œä¹Ÿå¯ä»¥è‡ªå·±</a> <code>tailscale --help</code> çœ‹å‘½ä»¤å¸®åŠ©ã€‚</p><h4 id="Linux-æ¥å…¥"><a href="#Linux-æ¥å…¥" class="headerlink" title="Linux æ¥å…¥"></a>Linux æ¥å…¥</h4><h5 id="derp-ä¸Šçš„å®¢æˆ·ç«¯"><a href="#derp-ä¸Šçš„å®¢æˆ·ç«¯" class="headerlink" title="derp ä¸Šçš„å®¢æˆ·ç«¯"></a>derp ä¸Šçš„å®¢æˆ·ç«¯</h5><p>å…ˆæ¥å…¥ derp ä¹Ÿå°±æ˜¯ ecs ä¸Šé‚£ä¸ª tailscaleï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥æ‹·è´å‡ºæ¥å®¿ä¸»æœºä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># docker cp tailscale:/usr/local/bin/tailscale /usr/bin/tailscale</span></span><br><span class="line">docker <span class="built_in">exec</span> -ti tailscale sh</span><br><span class="line"></span><br><span class="line">tailscale up --login-server=http://&lt;HEADSCALE_PUB_ENDPOINT&gt;:8081 --accept-routes=<span class="literal">true</span> --hostname ecs --accept-dns=<span class="literal">false</span> --authkey 49f9cd....</span><br></pre></td></tr></table></figure><p>å¯ä»¥ headscale ä¸ŠæŸ¥çœ‹ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ headscale node list</span><br><span class="line">ID | Hostname  | Name   | MachineKey | NodeKey | User    | IP addresses | Ephemeral | Last seen           | Expiration          | Online  | Expired</span><br><span class="line">1  | ecs       | ecs    | [3ixoT]    | [VFZTB] | default | 100.63.0.1, | <span class="literal">false</span>     | 2025-01-25 05:20:50 | 0001-01-01 00:00:00 | online  | no</span><br></pre></td></tr></table></figure><p>Linux ä¸Š tailscale ä¼šåˆ©ç”¨ tun åˆ›å»ºç½‘å¡ï¼Œè·¯ç”±è¡¨åœ¨ 52 é‡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ip route show table 52</span><br></pre></td></tr></table></figure><h5 id="Linux-å®¢æˆ·ç«¯"><a href="#Linux-å®¢æˆ·ç«¯" class="headerlink" title="Linux å®¢æˆ·ç«¯"></a>Linux å®¢æˆ·ç«¯</h5><p>å®˜æ–¹ç›¸å…³æ–‡æ¡£ï¼š</p><ul><li><a href="https://tailscale.com/kb/1031/install-linux">https://tailscale.com/kb/1031/install-linux</a></li><li><a href="https://pkgs.tailscale.com/stable/#static">https://pkgs.tailscale.com/stable/#static</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://tailscale.com/install.sh | sh</span><br></pre></td></tr></table></figure><p>ç„¶åè‡ªå·± <code>tailscale up --......</code> ç™»å½•ã€‚</p><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><p>åœ¨ <a href="https://tailscale.com/download">https://tailscale.com/download</a> ä¸‹è½½å®‰è£…ï¼ˆå®‰è£…å¤±è´¥æ¢ msi å®‰è£…åŒ… <a href="https://pkgs.tailscale.com/stable/#windows">https://pkgs.tailscale.com/stable/#windows</a> ï¼‰ï¼Œå¦‚æœ msi å®‰è£…åŒ…å¯åŠ¨æŠ¥é”™ iphelp å•¥çš„ç›¸å…³ï¼Œåœ¨ <code>services.msc</code> é‡ŒæŠŠ <code>ip helper</code> å±æ€§è®¾ç½®è‡ªå¯åŠ¨åå¯åŠ¨ä¸‹ã€‚</p><p>å¯åŠ¨åï¼Œå®˜æ–¹æ–‡æ¡£ <a href="https://github.com/juanfont/headscale/blob/main/docs/windows-client.md">windows-client</a> è¯´éœ€è¦ powershell ä¿®æ”¹ä¸‹é¢çš„æ³¨å†Œè¡¨ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-Item</span> <span class="literal">-Path</span> <span class="string">&quot;HKLM:\SOFTWARE\Tailscale IPN&quot;</span></span><br><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:\Software\Tailscale IPN&#x27;</span> <span class="literal">-Name</span> UnattendedMode <span class="literal">-PropertyType</span> String <span class="literal">-Value</span> always</span><br><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;HKLM:\Software\Tailscale IPN&#x27;</span> <span class="literal">-Name</span> LoginURL <span class="literal">-PropertyType</span> String <span class="literal">-Value</span> http://YOUR<span class="literal">-HEADSCALE-URL</span>:<span class="number">8081</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ²¡å¿…è¦ï¼Œè€Œä¸”ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡ç‚¹å‡» login å¯èƒ½æ— æ³•å¼¹å‡ºæµè§ˆå™¨é¡µé¢ï¼Œå¯ä»¥ powershell æˆ–è€… gitbash é‡Œæ‰§è¡Œ tailscale cli æ³¨å†Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tailscale up --login-server http://xxx:8081 --hostname laptop --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --authkey 49f9cd....</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰§è¡Œåå¡ä½çš„ï¼Œåœ¨ <code>services.msc</code> é‡ŒæŠŠ tailscale é‡å¯ä¸‹åå†è¯•è¯•ã€‚</p><p>windows å¼€å¯ <code>--unattended</code> é”å±ä¸ä¼šæ–­å¼€è¿æ¥ï¼Œä¸€äº› windows æ—©æœŸç‰ˆæœ¬é—®é¢˜è§ä¸‹é¢ issue ï¼š</p><ul><li><a href="https://github.com/tailscale/tailscale/issues/7288">https://github.com/tailscale/tailscale/issues/7288</a></li></ul><p>windows å…³é—­ä¸Šä¼ æ—¥å¿—åˆ° log.tailscale.io å¯ä»¥åœ¨ <code>C:\ProgramData\Tailscale</code> ä¸‹æ–°å¢ <code>tailscaled-env.txt</code> å†™å…¥ envï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TS_NO_LOGS_NO_SUPPORT=true</span><br></pre></td></tr></table></figure><h4 id="å®‰å“"><a href="#å®‰å“" class="headerlink" title="å®‰å“"></a>å®‰å“</h4><p><a href="https://github.com/tailscale/tailscale-android">https://github.com/tailscale/tailscale-android</a></p><p>æ¨è <a href="https://f-droid.org/packages/com.tailscale.ipn/">https://f-droid.org/packages/com.tailscale.ipn/</a> ä¸‹è½½ï¼Œè¯·ä¸‹è½½ <code>1.72.0</code> ï¼Œå¦‚æœä¸æ˜¯ https url ä¸è¦å°è¯•ä½¿ç”¨ <code>v1.76 &lt;= x &lt; v1.80</code> æˆ‘å°è¯•å¼€å‘ç‰ˆæœ¬ <code>1.78.1-t89039</code> ç‰ˆæœ¬æ— æ³•æ³¨å†Œï¼Œè§åŸå›  <a href="https://github.com/tailscale/tailscale/issues/13794">https://github.com/tailscale/tailscale/issues/13794</a> ã€‚</p><p>å®‰è£…ååœ¨ <code>å³ä¸Šè§’ - Accounts - ä¸‰ä¸ªç‚¹ - Settings Accounts  Use an alternate server</code>ï¼Œè¾“å…¥ <code>http://xxx:8081</code>ï¼Œç„¶åä¸‹é¢ <code>Use an auth key</code> å¯èƒ½ä¼šæ²¡ä½¿ç”¨ authkey è·³è½¬åˆ°æµè§ˆå™¨å‡ºç°ä¸€ä¸ª <code>headscale nodes register ... --key nodekey:xxxx</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å›åˆ° headscale ä¸Šå‘½ä»¤æˆæƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¥å¿—é‡Œä¼šæ‰“å°é•¿ä¸² keyï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨å…¶ä»–ç«¯å¤åˆ¶ nodekey</span></span><br><span class="line">journalctl -xe --no-pager -u headscale | grep key</span><br><span class="line"></span><br><span class="line">headscale nodes register --user default --key mkey:xxxxx</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸€äº›æ²¡æœ‰æµè§ˆå™¨ä¹Ÿæ²¡ tailscale cli çš„éƒ½å¯ä»¥è¿™æ ·æ‰‹åŠ¨æˆæƒä¸‹ã€‚å®‰å“ä¸Šç‚¹å‡»æ¯ä¸ª peer è¿›å»çš„å³ä¸Šè§’å›¾æ ‡ç­‰äº <code>tailscale ping xxx</code> ï¼Œä¼šæ˜¾ç¤ºèƒ½å¦ç›´è¿å’Œå»¶è¿Ÿã€‚ä¹Ÿå¯ä»¥åç»­ä½¿ç”¨ Magisk tailscaleï¼Œé‚£æ ·å¯ä»¥æœ‰ cli äº†ï¼Œå¦å¤– apk æ˜¯ä½¿ç”¨ V-P-N å½¢å¼ï¼Œæ–­ç½‘å’Œåˆ‡æ¢æµé‡ä¼šæ–­å¼€ï¼Œè€Œ Magisk tailscale åˆ™ä¸ä¼šã€‚</p><p>adb å¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.tailscale.ipn/com.tailscale.ipn.MainActivity</span><br></pre></td></tr></table></figure><h4 id="openwrt"><a href="#openwrt" class="headerlink" title="openwrt"></a>openwrt</h4><p>å‚ç…§ <a href="https://github.com/adyanth/openwrt-tailscale-enabler">https://github.com/adyanth/openwrt-tailscale-enabler</a> ï¼Œéœ€è¦æœ‰ <code>kmod-tun</code> æ¨¡å—åŒ…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">VER=1.74.1</span><br><span class="line">wget https://pkgs.tailscale.com/stable/tailscale_<span class="variable">$&#123;VER&#125;</span>_arm64.tgz</span><br><span class="line">tar zxvf tailscale_*_arm64.tgz</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/tailscale/</span><br><span class="line"><span class="built_in">mv</span> tailscale_*_arm64/tailscal* /usr/bin</span><br><span class="line"><span class="built_in">rm</span> -rf tailscale_*_arm64</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/init.d/tailscale</span></span><br><span class="line"><span class="string">#!/bin/sh /etc/rc.common</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Copyright 2020 Google LLC.</span></span><br><span class="line"><span class="string"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">USE_PROCD=1</span></span><br><span class="line"><span class="string">START=99</span></span><br><span class="line"><span class="string">STOP=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">start_service() &#123;</span></span><br><span class="line"><span class="string">  procd_open_instance</span></span><br><span class="line"><span class="string">  procd_set_param command /usr/bin/tailscaled</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # Set the port to listen on for incoming VPN packets.</span></span><br><span class="line"><span class="string">  # Remote nodes will automatically be informed about the new port number,</span></span><br><span class="line"><span class="string">  # but you might want to configure this in order to set external firewall</span></span><br><span class="line"><span class="string">  # settings.</span></span><br><span class="line"><span class="string">  # procd_append_param command --port 41641</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # OpenWRT /var is a symlink to /tmp, so write persistent state elsewhere.</span></span><br><span class="line"><span class="string">  procd_append_param command --state /etc/config/tailscaled.state</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  # Persist files for TLS cert &amp; Taildrop files</span></span><br><span class="line"><span class="string">  procd_append_param command --statedir /etc/tailscale/</span></span><br><span class="line"><span class="string">  procd_append_param command -no-logs-no-support</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  procd_set_param env TS_DEBUG_FIREWALL_MODE=iptables</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  procd_set_param respawn</span></span><br><span class="line"><span class="string">  procd_set_param stdout 1</span></span><br><span class="line"><span class="string">  procd_set_param stderr 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  procd_close_instance</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">stop_service() &#123;</span></span><br><span class="line"><span class="string">  /usr/bin/tailscaled --cleanup</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> a+x /etc/init.d/tailscale</span><br><span class="line">/etc/init.d/tailscale <span class="built_in">enable</span></span><br><span class="line">/etc/init.d/tailscale start</span><br><span class="line"></span><br><span class="line">tailscale status</span><br></pre></td></tr></table></figure><p>ç™»å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tailscale up --login-server=http://&lt;HEADSCALE_PUB_ENDPOINT&gt;:8081 --accept-routes=<span class="literal">true</span> --hostname openwrt --accept-dns=<span class="literal">false</span> --authkey 49f9cd....</span><br><span class="line"></span><br><span class="line">tailscale status</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logread tailscaled</span><br></pre></td></tr></table></figure><p>ä¸»è·¯ç”±ä¸è®¾ç½®è·¯ç”±ä¸‹ï¼Œè½¬å‘æ”¾è¡Œ+ snatï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä¾‹å¦‚ n1 å–æ¶ˆæ¡¥æ¥å°±æ˜¯ -i eth0 äº†</span><br><span class="line">iptables -I ts-forward -i br-lan -o tailscale0 -j MARK --set-xmark 0x40000/0xff0000</span><br></pre></td></tr></table></figure><h3 id="tailscale-client-ä½¿ç”¨"><a href="#tailscale-client-ä½¿ç”¨" class="headerlink" title="tailscale client ä½¿ç”¨"></a>tailscale client ä½¿ç”¨</h3><p>æ¯ä¸ª tailscale ç«¯éƒ½å¯ä»¥æ‰§è¡Œå‘½ä»¤æ¥æŸ¥çœ‹å’Œæ’æŸ¥ä¸€äº›ä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># debug å‘½ä»¤éšè—åœ¨ --help äº†ï¼Œå¯ä»¥ tailscale debug --help è‡ªè¡ŒæŸ¥çœ‹</span></span><br><span class="line"><span class="comment"># æ‰“å° derp-map ä¿¡æ¯</span></span><br><span class="line">tailscale debug derp-map</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å’Œæ£€æµ‹å½“å‰ç½‘ç»œï¼Œä¼šè¾“å‡ºå½“å‰ derp æœåŠ¡å™¨ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale netcheck</span><br><span class="line"></span><br><span class="line">Report:</span><br><span class="line">* UDP: <span class="literal">true</span></span><br><span class="line">* IPv4: <span class="built_in">yes</span>, xx.x.xx.xxx:54417</span><br><span class="line">* IPv6: no, but OS has support</span><br><span class="line">* MappingVariesByDestIP: </span><br><span class="line">* PortMapping: </span><br><span class="line">* Nearest DERP: tx</span><br><span class="line">* DERP latency:</span><br><span class="line">- custom: 500Âµs   (tx)</span><br></pre></td></tr></table></figure><p>tailscale ping å‘½ä»¤å¯ä»¥ç”¨äºæµ‹è¯• IP è¿é€šæ€§, åŒæ—¶å¯ä»¥çœ‹åˆ°æ—¶å¦‚ä½•è¿æ¥ç›®æ ‡èŠ‚ç‚¹çš„. é»˜è®¤æƒ…å†µä¸‹ Ping å‘½ä»¤é¦–å…ˆä¼šä½¿ç”¨ Derper ä¸­ç»§èŠ‚ç‚¹é€šä¿¡, ç„¶åå°è¯• P2P è¿æ¥; ä¸€æ—¦ P2P è¿æ¥æˆåŠŸåˆ™è‡ªåŠ¨åœæ­¢ Ping:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tailscale ping 100.63.0.3</span><br><span class="line">pong from redmi8 (100.63.0.3) via DERP(custom) <span class="keyword">in</span> 30ms</span><br><span class="line">pong from redmi8 (100.63.0.3) via 192.168.0.107:47316 <span class="keyword">in</span> 32ms</span><br></pre></td></tr></table></figure><p>status æŸ¥çœ‹ä»¥åŠ peer çš„ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tailscale status</span><br><span class="line">tailscale status --json</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å½“å‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ”¯æŒä¿®æ”¹çš„å±æ€§ â€“help è‡ªè¡ŒæŸ¥çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tailscale set --help</span></span><br><span class="line">tailscale <span class="built_in">set</span> --hostname=xxx</span><br></pre></td></tr></table></figure><p>æˆ–è€…å¯ä»¥ down å up å¸¦å•ä¸€éœ€è¦ä¿®æ”¹çš„å‚æ•°æ‰§è¡Œä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tailscale down</span><br><span class="line">tailscale up --xxx</span><br><span class="line"><span class="comment"># ç„¶åä¼šæ‰“å°å…¨éƒ¨å‚æ•°ï¼Œå¤åˆ¶æ‰§è¡Œä¸‹</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰çš„å‚æ•°åˆ—è¡¨ï¼Œå®˜æ–¹æ²¡æœ‰ cmdline å½¢å¼æ‰“å°ï¼Œåªæœ‰ json çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tailscale debug prefs</span><br></pre></td></tr></table></figure><h3 id="æ‰“é€šå†…ç½‘"><a href="#æ‰“é€šå†…ç½‘" class="headerlink" title="æ‰“é€šå†…ç½‘"></a>æ‰“é€šå†…ç½‘</h3><p>Linux ç«¯éƒ½è¦å¼€å¯è½¬å‘ï¼Œwindows å’Œå®‰å“è½¬å‘è‡ªè¡ŒæŸ¥æ‰¾æ€ä¹ˆé…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> | <span class="built_in">tee</span> /etc/sysctl.d/ipforwarding.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv6.conf.all.forwarding = 1&#x27;</span> | <span class="built_in">tee</span> -a /etc/sysctl.d/ipforwarding.conf</span><br><span class="line">sysctl -p /etc/sysctl.d/ipforwarding.conf</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ server ç«¯æŸ¥çœ‹ node ID ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ headscale node list</span><br><span class="line">ID | Hostname  | Name   | MachineKey | NodeKey | User    | IP addresses | Ephemeral | Last seen           | Expiration          | Online  | Expired</span><br><span class="line">1  | ecs       | ecs    | [3ixoT]    | [VFZTB] | default | 100.63.0.1, | <span class="literal">false</span>     | 2025-01-26 07:12:50 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">2  | localhost | ax18   | [egfcx]    | [LzS5J] | default | 100.63.0.2, | <span class="literal">false</span>     | 2025-01-26 07:13:14 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">3  | localhost | redmi8 | [uqIVP]    | [l6sL7] | default | 100.63.0.3, | <span class="literal">false</span>     | 2025-01-26 07:13:06 | 0001-01-01 00:00:00 | online  | no</span><br></pre></td></tr></table></figure><p>å‡è®¾ <code>ID==1</code> çš„å±€åŸŸç½‘æ˜¯ <code>192.168.31.0/24</code> ç½‘æ®µï¼Œæˆ‘ä»¬å¸Œæœ›å…¶ä»– ID è®¾å¤‡ä¸Šèƒ½è®¿é—®åˆ°ï¼Œå…ˆæŸ¥çœ‹è·¯ç”±ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ headscale routes list</span><br><span class="line">ID | Machine | Prefix          | Advertised | Enabled | Primary</span><br><span class="line">.....</span><br><span class="line">1  | ax18    | 192.168.31.0/24 | <span class="literal">true</span>       | <span class="literal">false</span>   | <span class="literal">false</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">headscale routes <span class="built_in">enable</span> -r 1</span><br></pre></td></tr></table></figure><p>å…¶ä»–èŠ‚ç‚¹æŸ¥çœ‹è·¯ç”±ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip route show table 52 | grep <span class="string">&quot;192.168.31.0/24&quot;</span></span><br><span class="line">192.168.31.0/24 dev tailscale0</span><br></pre></td></tr></table></figure><blockquote><p>å…¶ä»–èŠ‚ç‚¹å¯åŠ¨æ—¶éœ€è¦å¢åŠ  <code>--accept-routes=true</code> é€‰é¡¹æ¥å£°æ˜ â€œæˆ‘æ¥å—å¤–éƒ¨å…¶ä»–èŠ‚ç‚¹å‘å¸ƒçš„è·¯ç”±â€ã€‚</p></blockquote><p>ç°åœ¨ä½ åœ¨ä»»ä½•ä¸€ä¸ª Tailscale å®¢æˆ·ç«¯æ‰€åœ¨çš„èŠ‚ç‚¹éƒ½å¯ä»¥ ping é€šå®¶åº­å†…ç½‘çš„æœºå™¨äº†ï¼Œä½ åœ¨å…¬å¸æˆ–è€…æ˜Ÿå·´å…‹ä¹Ÿå¯ä»¥åƒåœ¨å®¶é‡Œä¸€æ ·ç”¨åŒæ ·çš„ IP éšæ„è®¿é—®å®¶ä¸­çš„ä»»ä½•ä¸€ä¸ªè®¾å¤‡ã€‚</p><p>ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„èŠ‚ç‚¹å¢åŠ è·¯ç”±å¯ä»¥ä½¿ç”¨ set å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤šæ¡ç”¨è‹±æ–‡é€—å·é—´éš”</span></span><br><span class="line">tailscale <span class="built_in">set</span> --advertise-routes xx.xx.xx.0/24,xx,xxx.xxx.00.00/16</span><br></pre></td></tr></table></figure><h3 id="ä¿¡æ¯ä¿®æ”¹"><a href="#ä¿¡æ¯ä¿®æ”¹" class="headerlink" title="ä¿¡æ¯ä¿®æ”¹"></a>ä¿¡æ¯ä¿®æ”¹</h3><p>ä¿®æ”¹ node çš„ nameï¼Œä½¿ç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">headscale nodes rename -h</span><br></pre></td></tr></table></figure><p>å› ä¸ºé»˜è®¤ db ä½¿ç”¨ sqliteï¼Œå¯ä»¥ä¿®æ”¹ä¸€äº›ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sqlite3 /var/lib/headscale/db.sqlite</span><br><span class="line">.tables</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip_addresses=&quot;100.63.0.3&quot;</span></span><br><span class="line">ä¿®æ”¹ ip éœ€è¦å…ˆ tailscale down æ”¹å¥½åå† tailscale upï¼Œä¿®æ”¹åé…ç½®ä¼šåŒæ­¥åˆ°æ‰€æœ‰ tailscale client ä¸Šï¼Œç‰¹åˆ«æ˜¯æ¸¸æˆå¯èƒ½ä¼šé—ªæ–­ä¸‹</span><br></pre></td></tr></table></figure><p>å…¶ä»–çš„ä¿®æ”¹è‡ªå·±ç¢ç£¨ã€‚</p><h3 id="ä¸€äº›è¯´æ˜"><a href="#ä¸€äº›è¯´æ˜" class="headerlink" title="ä¸€äº›è¯´æ˜"></a>ä¸€äº›è¯´æ˜</h3><p>è¿™é‡Œåªä»‹ç»å¼‚åœ°ç»„ç½‘éƒ¨åˆ†ï¼Œå…¶ä»–çš„å»çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>è¯·æœ‰è‡ªå·±çš„ç†è§£èƒ½åŠ›ï¼Œä¸è¦éšä¾¿ç…§æŠ„ï¼Œç«¯å£å•¥çš„ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸‹ã€‚</p><ul><li><a href="https://kiprey.github.io/2023/11/tailscale-derp/">æµ…æ¢ Tailscale DERP ä¸­è½¬æœåŠ¡</a></li><li><a href="https://arthurchiao.art/blog/how-nat-traversal-works-zh/">NAT ç©¿é€æ€ä¹ˆå·¥ä½œçš„</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;é•¿æœŸè®°å½•å’Œæ›´æ–°å…³äº headscale éƒ¨ç½²å’Œåº”ç”¨åœºæ™¯&lt;/p&gt;</summary>
    
    
    
    
    <category term="headscale" scheme="http://zhangguanzhang.github.io/tags/headscale/"/>
    
    <category term="derper" scheme="http://zhangguanzhang.github.io/tags/derper/"/>
    
  </entry>
  
  <entry>
    <title>[æŒç»­æ›´æ–°] - å®‰å“æŠ˜è…¾ç¬”è®°</title>
    <link href="http://zhangguanzhang.github.io/2024/07/21/Linux-android/"/>
    <id>http://zhangguanzhang.github.io/2024/07/21/Linux-android/</id>
    <published>2024-07-21T20:10:30.000Z</published>
    <updated>2024-07-21T20:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>é•¿æœŸè®°å½•å’Œæ›´æ–°å…³äºå®‰å“å’Œ Linux çš„ä¸€äº›æŠ˜è…¾ç¬”è®°</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>é•¿æœŸè®°å½•å’Œæ›´æ–°å…³äºå®‰å“å’Œ Linux çš„ä¸€äº›æŠ˜è…¾ç¬”è®°ï¼Œæ²¡æœ‰ Linux å’Œåˆ·æœºåŸºç¡€çš„ä¸è¦çœ‹äº†ã€‚</p><h2 id="adb"><a href="#adb" class="headerlink" title="adb"></a>adb</h2><h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p><a href="https://developer.android.com/tools/releases/platform-tools?hl=zh-cn">platform-tools</a></p><h3 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h3><p><img src="https://raw.githubusercontent.com/Swind/pure-python-adb/master/docs/adb_cli.png" alt="adb-pic"></p><p>å°ç±³ç³»åˆ—æ‰‹æœºå¼€ adb éœ€è¦ç™»å½•è´¦å·å’Œæ’å…¥ sim å¡ï¼Œç„¶å Linux å’Œè½¯è·¯ç”±ä¸Šä¹Ÿå¯ä»¥å®‰è£… adbï¼ˆæ‰“é€šç½‘ç»œåå¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼‰ï¼Œä¸è¦å±€é™åœ¨çœ‹åˆ°çš„ç‰©ä½“æ€ç»´ä¸Šã€‚å¼€äº† usb adb åæ’å…¥ç”µè„‘ä¸Šï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è®¾å¤‡</span></span><br><span class="line">adb devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®©è®¾å¤‡ adb server ä»¥ 5555 æ–¹å¼è¿è¡Œï¼Œè€Œéä½¿ç”¨ usb</span></span><br><span class="line">adb tcpip 5555</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcp è¿æ¥</span></span><br><span class="line">adb connect &lt;ip&gt;:5555</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å¸¦è®¾å¤‡åå°±æ˜¯å…³é—­æ‰€æœ‰è¿æ¥</span></span><br><span class="line">adb disconnect [xxx]</span><br><span class="line"></span><br><span class="line"><span class="comment"># adb æ‰§è¡Œä»»ä½•å‘½ä»¤çš„æ—¶å€™ï¼Œå¦‚æœ server æœåŠ¡æ²¡æœ‰å¯åŠ¨å°±ä¼šå¯åŠ¨</span></span><br><span class="line"><span class="comment"># æ­¤å‘½ä»¤æ˜¯æ€æ‰ server è¿›ç¨‹ï¼ŒLinux å’Œ win éƒ½æœ‰ server æœåŠ¡</span></span><br><span class="line"><span class="comment"># daemon æ˜¯è¿è¡Œåœ¨æ‰‹æœºä¸Šçš„ï¼Œserver ç®¡ç† client å’Œ daemon ä¹‹é—´çš„é€šä¿¡</span></span><br><span class="line">adb kill-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®æœ¬æœº 8888 ç«¯å£è½¬å‘åˆ°è®¾å¤‡çš„ 8080 ç«¯å£</span></span><br><span class="line">adb forward tcp:8888 tcp:8080</span><br></pre></td></tr></table></figure><p>æ›´å¤šè§æ–‡æ¡£ <a href="https://developer.android.google.cn/tools/adb?hl=zh-cn">tools&#x2F;adb</a></p><h3 id="adb-shell"><a href="#adb-shell" class="headerlink" title="adb shell"></a>adb shell</h3><p>ä¸€äº› adb shell å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell dumpsys battery</span><br><span class="line">Current Battery Service state:</span><br><span class="line">  AC powered: <span class="literal">true</span>  &lt;-- æ¥å…¥å……ç”µå™¨</span><br><span class="line">  USB powered: <span class="literal">false</span></span><br><span class="line">  Wireless powered: <span class="literal">false</span></span><br><span class="line">  Max charging current: 0</span><br><span class="line">  Max charging voltage: 0</span><br><span class="line">  Charge counter: 2946000</span><br><span class="line">  status: 5</span><br><span class="line">  health: 2</span><br><span class="line">  present: <span class="literal">true</span></span><br><span class="line">  level: 100    &lt;--- å½“å‰ç”µé‡ç™¾åˆ†æ¯”</span><br><span class="line">  scale: 100</span><br><span class="line">  voltage: 4262  &lt;-- ç”µå‹</span><br><span class="line">  temperature: 426 &lt;-- æ¸©åº¦ 42.6 â„ƒ</span><br><span class="line">  technology: Li-poly</span><br><span class="line"><span class="comment"># å¼€å¯å±å¹•åˆ†ææŒ‡é’ˆ</span></span><br><span class="line">adb shell settings put system pointer_location 1</span><br><span class="line"><span class="comment"># åæ ‡æ˜¯åä¸Š0,0 å·¦åˆ°å³æ˜¯ X ä¸Šåˆ°ä¸‹æ˜¯ Yï¼Œä¸‹é¢æ˜¯æ¨ªå±ç‚¹å±å¹•ä¸Šä¸€ä¸ªæŒ‰é’®çš„åæ ‡</span></span><br><span class="line">adb shell input tap 1580 930</span><br><span class="line"><span class="comment"># è·å–äº‹ä»¶ï¼Œsendevent æ¨¡æ‹Ÿæ¯”è¾ƒéº»çƒ¦</span></span><br><span class="line">adb shell getevent -l</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://adbinstaller.com/commands">https://adbinstaller.com/commands</a></p><h3 id="ä¸€äº›é—®é¢˜"><a href="#ä¸€äº›é—®é¢˜" class="headerlink" title="ä¸€äº›é—®é¢˜"></a>ä¸€äº›é—®é¢˜</h3><p>æ‰“ç®—æŠŠ adb å¯åŠ¨åœ¨ Linux ä¸Šï¼Œå‘ç°å®ƒ daemon ç›‘å¬ç«¯å£ä¸æ˜¯ bind 0.0.0.0ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ss -nlpt | grep adb</span><br><span class="line">LISTEN 0      4          127.0.0.1:5037       0.0.0.0:*    <span class="built_in">users</span>:((<span class="string">&quot;adb&quot;</span>,pid=25471,fd=6))</span><br><span class="line"><span class="comment"># https://stackoverflow.com/questions/56130335/adb-port-forwarding-to-listen-on-all-interfaces</span></span><br><span class="line">$ adb -a nodaemon server start</span><br></pre></td></tr></table></figure><p>ç„¶åæœäº†ä¸‹æ²¡æœ‰å¥½çš„è§£å†³åŠæ³•ï¼Œæœ‰äººå» hack æºç çš„ï¼Œä¸Šé¢è¿™ä¸ªå‘½ä»¤æ˜¯å¤§ä½¬å‘çš„ï¼Œåªèƒ½å‰å°è¿è¡Œï¼Œå¯ä»¥é…åˆ screen æˆ–è€… systemd å•¥çš„å¸¸é©»ã€‚</p><h2 id="å®‰å“è™šæ‹ŸåŒ–"><a href="#å®‰å“è™šæ‹ŸåŒ–" class="headerlink" title="å®‰å“è™šæ‹ŸåŒ–"></a>å®‰å“è™šæ‹ŸåŒ–</h2><p>x86_64 æœºå™¨ä¸ŠæŠ˜è…¾çš„ä¸€äº›å®‰å“è™šæ‹ŸåŒ–ç¬”è®°ï¼Œå¦‚æœè¦åœ¨ x86_64 çš„å®‰å“å’Œå®‰å“è™šæ‹Ÿæœºæˆ–è€…å®¹å™¨å†…å®‰è£…è¿è¡Œ arm64 çš„ apk ï¼Œéœ€è¦å¸¦æœ‰ <code>Native Bridge</code>ã€‚</p><h3 id="Bliss-OS"><a href="#Bliss-OS" class="headerlink" title="Bliss OS"></a>Bliss OS</h3><p>ä¸€ä¸ª x86_64 å®‰å“ç³»ç»Ÿï¼Œç›¸å¯¹äº <a href="https://www.android-x86.org/">android-x86</a> ä¼¼ä¹æ›´æ–°é¢‘ç¹ï¼Œå¯ä»¥ pve ä¹‹ç±»è™šæ‹ŸåŒ–å¯¼å…¥å®‰è£…ï¼Œä½†æ˜¯æœ‰äº›ç‰ˆæœ¬æ²¡å¸¦è¿˜æ˜¯æŠŠ <code>Native Bridge</code> åˆ äº†ã€‚</p><h3 id="Waydroid"><a href="#Waydroid" class="headerlink" title="Waydroid"></a>Waydroid</h3><p>anbox åç»§ <a href="https://waydro.id/">Waydroid</a> è¿˜æ²¡è¯•è¿‡ï¼Œæ˜¯å®¹å™¨èµ·çš„æ¨¡æ‹Ÿå™¨ã€‚</p><h3 id="budtmo-x2F-docker-android"><a href="#budtmo-x2F-docker-android" class="headerlink" title="budtmo&#x2F;docker-android"></a>budtmo&#x2F;docker-android</h3><p><a href="https://github.com/budtmo/docker-android">https://github.com/budtmo/docker-android</a> æ„Ÿè§‰å¤ªé‡äº†ï¼Œè€Œä¸”æ²¡ arm64 æ¶æ„é•œåƒã€‚</p><h3 id="remote-android-x2F-redroid-doc"><a href="#remote-android-x2F-redroid-doc" class="headerlink" title="remote-android&#x2F;redroid-doc"></a>remote-android&#x2F;redroid-doc</h3><p><a href="https://github.com/remote-android/redroid-doc">https://github.com/remote-android/redroid-doc</a> å°è¯•è¿è¡Œ arm64 çš„ apk æˆåŠŸäº†ï¼Œchrome çš„æµè§ˆå™¨ä¸è¡Œï¼Œéœ€è¦æœ‰äº›ä¾èµ–æ‰å¯ä»¥è¿è¡Œï¼Œuc æµè§ˆå™¨ä¹Ÿä¸è¡Œï¼Œæœ€åç”¨çš„  arm64 firefox æµè§ˆå™¨ã€‚å¦å¤–å‘ç°æœ‰äº› apk å®‰è£…åæ‰“å¼€é»‘å±ï¼Œæœ€åä» proxmox è™šæ‹Ÿæœºåˆ‡åˆ°å®¿ä¸»æœºä¸Š docker èµ·æ‰è§£å†³ï¼Œä¹Ÿçœ‹åˆ°æœ‰äºº arm64 M1 mac ä¸Šèµ·å®‰å“å®¹å™¨ã€‚</p><h2 id="ä¸€äº›è½¯ä»¶"><a href="#ä¸€äº›è½¯ä»¶" class="headerlink" title="ä¸€äº›è½¯ä»¶"></a>ä¸€äº›è½¯ä»¶</h2><h3 id="scrcpy"><a href="#scrcpy" class="headerlink" title="scrcpy"></a>scrcpy</h3><p><a href="https://github.com/Genymobile/scrcpy">https://github.com/Genymobile/scrcpy</a> ç‰›é€¼çš„é¡¹ç›®ï¼Œä¸ç”¨å¤šè¯´ï¼Œé…åˆ adb ä½¿ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scrcpy</span><br><span class="line"> -S, --turn-screen-off # è¿œç¨‹æ—¶å€™ï¼Œå…³é—­è®¾å¤‡çš„å±å¹•</span><br><span class="line">#  --max-size 1024 --video-bit-rate=2M --max-fps=15 ä½ç”»è´¨</span><br></pre></td></tr></table></figure><p>å…³é—­å±å¹•è¿™ä¸ªï¼Œlcd çš„è§¦å‘åï¼Œå¦‚æœå…³é—­ scrcpy åé¢å±å¹•è¿˜ä¼šäº®ï¼Œè€Œ oled çš„åˆ™ä¸ä¼šï¼Œå•ç‹¬æƒ³ adb å®ç°å®ƒçš„å…³é—­å±å¹•æ˜¾ç¤ºè€Œä¸ä¼‘çœ ï¼Œå¯ä»¥å‚è€ƒ</p><ul><li><a href="https://meta.appinn.net/t/topic/46361">https://meta.appinn.net/t/topic/46361</a></li><li><a href="https://github.com/Genymobile/scrcpy/issues/2888">https://github.com/Genymobile/scrcpy/issues/2888</a></li><li><a href="https://github.com/barry-ran/QtScrcpy/issues/194">https://github.com/barry-ran/QtScrcpy/issues/194</a></li></ul><p>è¿˜æœ‰å…¶ä»–å¾ˆå¤š scrcpy é¡¹ç›®ï¼Œä»¥åŠå¯ä»¥å¾ˆå¤šç¼–ç¨‹è¯­è¨€æœ‰ scrcpy çš„åº“ï¼Œå¯ä»¥åšåˆ°å†™ä»£ç æ§åˆ¶æ‰‹æœºå’Œä¸Šé¢çš„åº”ç”¨ã€‚</p><h2 id="adb-åè®®"><a href="#adb-åè®®" class="headerlink" title="adb åè®®"></a>adb åè®®</h2><ul><li><a href="https://github.com/cstyan/adbDocumentation">https://github.com/cstyan/adbDocumentation</a></li></ul><h3 id="golang"><a href="#golang" class="headerlink" title="golang"></a>golang</h3><ul><li><a href="https://github.com/electricbubble/gadb">https://github.com/electricbubble/gadb</a></li></ul><h2 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h2><h3 id="æ•™ç¨‹"><a href="#æ•™ç¨‹" class="headerlink" title="æ•™ç¨‹"></a>æ•™ç¨‹</h3><ul><li><a href="https://www.52pojie.cn/thread-408645-1-1.html">https://www.52pojie.cn/thread-408645-1-1.html</a></li></ul><h3 id="å¸¸è§é€†å‘"><a href="#å¸¸è§é€†å‘" class="headerlink" title="å¸¸è§é€†å‘"></a>å¸¸è§é€†å‘</h3><ul><li>frida objection</li><li><a href="https://kuizuo.cn/docs/frida-so-hook/">https://kuizuo.cn/docs/frida-so-hook/</a></li></ul><h3 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h3><p>spwan</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-U usbï¼Œ -f æ˜¯Attachæ¨¡å¼ï¼Œä¸å¸¦-fæ˜¯Spawn æ¨¡å¼ï¼Œå‰è€…ä¼šå¯åŠ¨appæ³¨å…¥ï¼Œåè€…æ˜¯è‡ªå·±é€‰æ‹©å•¥æ—¶å€™æ³¨å…¥</span></span><br><span class="line">frida -U -f &lt;app_name&gt; -l hook.js</span><br></pre></td></tr></table></figure><p>js çš„è¯ï¼Œhook å†…å®¹å¦‚ä¸‹ç±»ä¼¼ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.example.MainActivity&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hook Java æ–¹æ³•</span></span><br><span class="line">        <span class="title class_">MainActivity</span>.<span class="property">foo</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">str</span>) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">var</span> ret = <span class="variable language_">this</span>.<span class="title function_">foo</span>(str);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Return value:&#x27;</span>, ret);</span><br><span class="line">            <span class="comment">// è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿‡æ£€æµ‹ frida <a href="https://github.com/Ylarod/Florida">Ylarod&#x2F;Florida</a></p><p>æŠ“åŒ…:</p><ul><li><a href="https://github.com/siyujie/OkHttpLogger-Frida">https://github.com/siyujie/OkHttpLogger-Frida</a></li></ul><h3 id="unit-æ¸¸æˆé€†å‘"><a href="#unit-æ¸¸æˆé€†å‘" class="headerlink" title="unit æ¸¸æˆé€†å‘"></a>unit æ¸¸æˆé€†å‘</h3><p><code>libs/&#123;libil2cpp,libmain,libunity,libxlua&#125;.so</code></p><ul><li><a href="https://veo.pub/2020/xlua/">https://veo.pub/2020/xlua/</a></li><li><a href="https://bbs.kanxue.com/thread-257678.htm">https://bbs.kanxue.com/thread-257678.htm</a> </li><li><a href="https://blog.csdn.net/linxinfa/article/details/116572369">https://blog.csdn.net/linxinfa/article/details/116572369</a></li><li><a href="https://github.com/vfsfitvnm/frida-il2cpp-bridge">https://github.com/vfsfitvnm/frida-il2cpp-bridge</a></li><li><a href="https://github.com/MlgmXyysd/IL2CppMemoryDumper">https://github.com/MlgmXyysd/IL2CppMemoryDumper</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://bbs.kanxue.com/thread-280500.htm</span></span><br><span class="line">npm install frida-compile</span><br><span class="line">npm install --save-dev frida-il2cpp-bridge</span><br><span class="line">npm run watch</span><br><span class="line"></span><br><span class="line">frida -f xxx -l hook.js</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/dnSpyEx/dnSpy">https://github.com/dnSpyEx/dnSpy</a></li><li><a href="https://www.youtube.com/watch?v=NBjGm7YAZUQ">https://www.youtube.com/watch?v=NBjGm7YAZUQ</a></li></ul><h3 id="è¾…åŠ©é€†å‘"><a href="#è¾…åŠ©é€†å‘" class="headerlink" title="è¾…åŠ©é€†å‘"></a>è¾…åŠ©é€†å‘</h3><ul><li><a href="https://blog.csdn.net/weixin_56039202/article/details/126980383">æŸç›´è£…å¤–æŒ‚å¡å¯†æ ¡éªŒé€†å‘åˆ†æ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;é•¿æœŸè®°å½•å’Œæ›´æ–°å…³äºå®‰å“å’Œ Linux çš„ä¸€äº›æŠ˜è…¾ç¬”è®°&lt;/p&gt;</summary>
    
    
    
    
    <category term="android" scheme="http://zhangguanzhang.github.io/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>hostPort è®¿é—®è¿›æ¥çš„æº IP æ˜¯ cni0 åœ°å€çš„æ’æŸ¥</title>
    <link href="http://zhangguanzhang.github.io/2024/06/17/hostPort-source-addr-cni0/"/>
    <id>http://zhangguanzhang.github.io/2024/06/17/hostPort-source-addr-cni0/</id>
    <published>2024-06-17T15:10:30.000Z</published>
    <updated>2024-06-17T15:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>hostPort è®¿é—®è¿›æ¥çš„æº IP æ˜¯ cni0 åœ°å€çš„é—®é¢˜æ’æŸ¥</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å†…éƒ¨ç½‘å…³çš„æ“ä½œæ—¥å¿—æ˜¾ç¤ºçš„æ¥æº IP éƒ½æ˜¯ cni0 åœ°å€ï¼Œç½‘å…³å¼€å‘å’Œæµ‹è¯•åé¦ˆä¹‹å‰æ˜¯å¥½çš„ï¼Œè¿˜ç»™äº†ä¸€ä¸ªæ­£å¸¸ç¯å¢ƒã€‚</p><h2 id="æ’æŸ¥è¿‡ç¨‹"><a href="#æ’æŸ¥è¿‡ç¨‹" class="headerlink" title="æ’æŸ¥è¿‡ç¨‹"></a>æ’æŸ¥è¿‡ç¨‹</h2><h3 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>æˆ‘ä»¬ç½‘å…³æ˜¯ hostPort 80 æš´æ¼çš„ï¼Œåªå…³æ³¨è¿™å—ï¼Œå…¶ä»–çš„ä¸éœ€è¦å…³æ³¨ï¼Œä¸¤å¥—ç¯å¢ƒä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get node -o wide</span></span><br><span class="line">NAME           STATUS   ROLES         AGE   VERSION    INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                                      KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">...</span><br><span class="line">10.xx.x6.112   Ready    master,node   18d   v1.27.12   10.xx.x6.112   &lt;none&gt;        Red Hat Enterprise Linux Server 7.9 (Maipo)   3.10.0-1160.el7.x86_64   docker://25.0.5</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä¸æ­£å¸¸çš„ï¼Œä¸‹é¢æ˜¯æ­£å¸¸ç¯å¢ƒçš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get node -o wide</span></span><br><span class="line">NAME           STATUS   ROLES         AGE   VERSION    INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">10.xx.x7.111   Ready    master,node   9d    v1.27.12   10.xx.x7.111   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   docker://25.0.5</span><br></pre></td></tr></table></figure><p>ä¸¤å¥—ç¯å¢ƒä¸Šçš„ docker k8s ä»¥åŠ cni-plugins ç‰ˆæœ¬å’Œ md5sum çœ‹äº†ä¸‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘åœ¨å¤–éƒ¨ <code>10.2xx.xx.30</code> ä¸Š curl ä¸¤ä¸ªç¯å¢ƒ <code>ip:80</code>ï¼Œä¿©æœºå™¨ä¸Šç”¨ conntrack æŸ¥çœ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">conntrack -L |&amp; grep 10.2xx.xx.30</span></span><br><span class="line">tcp      6 9 CLOSE src=10.2xx.xx.30 dst=10.xx.x6.112 sport=41388 dport=80 src=10.18x.2.38 dst=10.18x.2.1 sport=80 dport=55471 [ASSURED] mark=0 use=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">conntrack -L |&amp; grep 10.2xx.xx.30</span></span><br><span class="line">tcp      6 8 CLOSE src=10.2xx.xx.30 dst=10.xx.x7.111 sport=55658 dport=80 src=10.18x.0.36 dst=10.2xx.xx.30 sport=80 dport=55658 [ASSURED] mark=0 use=1</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå³ä¾§çš„ dst IP æ˜¯é”™è¯¯çš„ï¼Œç½‘å…³å±‚é¢æ‰“å°æ—¥å¿— tcp source addr å’Œè¿™ä¸ª IP æ˜¯ä¸€è‡´çš„ã€‚æ¶‰åŠåˆ°åœ°å€è½¬æ¢è‡ªç„¶æ˜¯æŸ¥çœ‹ nat è¡¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t nat -S | grep -Ev <span class="string">&#x27;KUBE-(SVC|SEP)&#x27;</span> | grep MASQ</span></span><br><span class="line">-N CNI-HOSTPORT-MASQ</span><br><span class="line">-N KUBE-MARK-MASQ</span><br><span class="line">-A POSTROUTING -m comment --comment &quot;CNI portfwd requiring masquerade&quot; -j CNI-HOSTPORT-MASQ</span><br><span class="line">-A POSTROUTING -s 10.185.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE</span><br><span class="line">-A FLANNEL-POSTRTG -s 10.18x.0.0/16 ! -d 224.0.0.0/4 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">-A FLANNEL-POSTRTG ! -s 10.18x.0.0/16 -d 10.18x.0.0/16 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">-A FLANNEL-POSTRTG -s 10.18x.0.0/16 ! -d 224.0.0.0/4 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">-A FLANNEL-POSTRTG ! -s 10.18x.0.0/16 -d 10.18x.0.0/16 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -j MASQUERADE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">iptables -t nat -S | grep -Ev <span class="string">&#x27;KUBE-(SVC|SEP|EXT)&#x27;</span> | grep MASQ</span></span><br><span class="line">-N CNI-HOSTPORT-MASQ</span><br><span class="line">-N KUBE-MARK-MASQ</span><br><span class="line">-A POSTROUTING -s 10.185.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A POSTROUTING -m comment --comment &quot;CNI portfwd requiring masquerade&quot; -j CNI-HOSTPORT-MASQ</span><br><span class="line">-A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE</span><br><span class="line">-A FLANNEL-POSTRTG -s 10.18x.0.0/16 ! -d 224.0.0.0/4 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">-A FLANNEL-POSTRTG ! -s 10.18x.0.0/16 -d 10.18x.0.0/16 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -j MASQUERADE</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”å‘ç°æ•…éšœç¯å¢ƒçš„ <code>FLANNEL-POSTRTG</code> é‡å¤æ·»åŠ äº†ï¼ŒæŸ¥çœ‹ä¸‹ flanneld ä¿©æœºå™¨ docker é•œåƒä½¿ç”¨æ˜¯ä¸€æ ·çš„ï¼ŒæŸ¥çœ‹è¯¥æ•…éšœæœºå™¨çš„ flanneld æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker logs 3743</span></span><br><span class="line">I0605 10:08:06.702126       1 main.go:209] CLI flags config: &#123;etcdEndpoints:http://127.0.0.1:4001,http://127.0.0.1:2379 etcdPrefix:/coreos.com/network etcdKeyfile: etcdCertfile: etcdCAFile: etcdUsername: etcdPassword: version:false kubeSubnetMgr:true kubeApiUrl: kubeAnnotationPrefix:flannel.alpha.coreos.com kubeConfigFile: iface:[] ifaceRegex:[] ipMasq:true ifaceCanReach: subnetFile:/run/flannel/subnet.env publicIP: publicIPv6: subnetLeaseRenewMargin:60 healthzIP:0.0.0.0 healthzPort:0 iptablesResyncSeconds:5 iptablesForwardRules:true netConfPath:/etc/kube-flannel/net-conf.json setNodeNetworkUnavailable:true&#125;</span><br><span class="line">W0605 10:08:06.702229       1 client_config.go:618] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.</span><br><span class="line">I0605 10:08:06.898029       1 kube.go:139] Waiting 10m0s for node controller to sync</span><br><span class="line">I0605 10:08:06.898109       1 kube.go:461] Starting kube subnet manager</span><br><span class="line">I0605 10:08:06.905502       1 kube.go:482] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.18x.0.0/24]</span><br><span class="line">I0605 10:08:06.905578       1 kube.go:482] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.18x.1.0/24]</span><br><span class="line">I0605 10:08:06.905587       1 kube.go:482] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.18x.2.0/24]</span><br><span class="line">I0605 10:08:07.898972       1 kube.go:146] Node controller sync successful</span><br><span class="line">I0605 10:08:07.899005       1 main.go:229] Created subnet manager: Kubernetes Subnet Manager - 10.xx.x6.112</span><br><span class="line">I0605 10:08:07.899011       1 main.go:232] Installing signal handlers</span><br><span class="line">I0605 10:08:07.899099       1 main.go:452] Found network config - Backend type: vxlan</span><br><span class="line">I0605 10:08:07.899119       1 match.go:210] Determining IP address of default interface</span><br><span class="line">I0605 10:08:07.899406       1 match.go:263] Using interface with name ens192 and address 10.xx.x6.112</span><br><span class="line">I0605 10:08:07.899429       1 match.go:285] Defaulting external address to interface address (10.xx.x6.112)</span><br><span class="line">I0605 10:08:07.899499       1 vxlan.go:141] VXLAN config: VNI=1 Port=8475 GBP=false Learning=false DirectRouting=false</span><br><span class="line">I0605 10:08:07.951679       1 kube.go:627] List of node(10.xx.x6.112) annotations: map[string]string&#123;&quot;flannel.alpha.coreos.com/backend-data&quot;:&quot;&#123;\&quot;VNI\&quot;:1,\&quot;VtepMAC\&quot;:\&quot;b2:be:c3:c7:1b:c0\&quot;&#125;&quot;, &quot;flannel.alpha.coreos.com/backend-type&quot;:&quot;vxlan&quot;, &quot;flannel.alpha.coreos.com/kube-subnet-manager&quot;:&quot;true&quot;, &quot;flannel.alpha.coreos.com/public-ip&quot;:&quot;10.xx.x6.112&quot;, &quot;node.alpha.kubernetes.io/ttl&quot;:&quot;0&quot;, &quot;volumes.kubernetes.io/controller-managed-attach-detach&quot;:&quot;true&quot;&#125;</span><br><span class="line">I0605 10:08:07.951761       1 vxlan.go:155] Setup flannel.1 mac address to b2:be:c3:c7:1b:c0 when flannel restarts</span><br><span class="line">W0605 10:08:08.358170       1 main.go:505] no subnet found for key: FLANNEL_SUBNET in file: /run/flannel/subnet.env</span><br><span class="line">W0605 10:08:08.358192       1 main.go:540] no subnet found for key: FLANNEL_IPV6_SUBNET in file: /run/flannel/subnet.env</span><br><span class="line">I0605 10:08:08.358208       1 iptables.go:65] Current network or subnet (10.18x.0.0/16, 10.18x.2.0/24) is not equal to previous one (0.0.0.0/0, 0.0.0.0/0), trying to recycle old iptables rules</span><br><span class="line">I0605 10:08:09.407576       1 iptables.go:75] Setting up masking rules</span><br><span class="line">I0605 10:08:09.496912       1 iptables.go:214] Changing default FORWARD chain policy to ACCEPT</span><br><span class="line">I0605 10:08:09.497996       1 iptables.go:373] generated 7 rules</span><br><span class="line">I0605 10:08:09.498948       1 iptables.go:373] generated 3 rules</span><br><span class="line">I0605 10:08:09.498957       1 main.go:396] Wrote subnet file to /run/flannel/subnet.env</span><br><span class="line">I0605 10:08:09.499017       1 main.go:400] Running backend.</span><br><span class="line">I0605 10:08:09.499138       1 vxlan_network.go:65] watching for new subnet leases</span><br><span class="line">I0605 10:08:09.499200       1 subnet.go:160] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xabb0000, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xa0d0431, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;vxlan&quot;, BackendData:json.RawMessage&#123;0x7b, 0x22, 0x56, 0x4e, 0x49, 0x22, 0x3a, 0x31, 0x2c, 0x22, 0x56, 0x74, 0x65, 0x70, 0x4d, 0x41, 0x43, 0x22, 0x3a, 0x22, 0x64, 0x36, 0x3a, 0x36, 0x63, 0x3a, 0x33, 0x34, 0x3a, 0x33, 0x34, 0x3a, 0x33, 0x31, 0x3a, 0x36, 0x30, 0x22, 0x7d&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0605 10:08:09.499324       1 subnet.go:160] Batch elem [0] is &#123; lease.Event&#123;Type:0, Lease:lease.Lease&#123;EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net&#123;IP:0xabb0100, PrefixLen:0x18&#125;, IPv6Subnet:ip.IP6Net&#123;IP:(*ip.IP6)(nil), PrefixLen:0x0&#125;, Attrs:lease.LeaseAttrs&#123;PublicIP:0xa0d0434, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;vxlan&quot;, BackendData:json.RawMessage&#123;0x7b, 0x22, 0x56, 0x4e, 0x49, 0x22, 0x3a, 0x31, 0x2c, 0x22, 0x56, 0x74, 0x65, 0x70, 0x4d, 0x41, 0x43, 0x22, 0x3a, 0x22, 0x34, 0x65, 0x3a, 0x36, 0x65, 0x3a, 0x32, 0x33, 0x3a, 0x32, 0x36, 0x3a, 0x64, 0x31, 0x3a, 0x33, 0x36, 0x22, 0x7d&#125;, BackendV6Data:json.RawMessage(nil)&#125;, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0&#125;&#125; &#125;</span><br><span class="line">I0605 10:08:09.695633       1 main.go:421] Waiting for all goroutines to exit</span><br><span class="line">I0605 10:08:09.700710       1 iptables.go:366] bootstrap done</span><br><span class="line">I0605 10:08:09.898448       1 iptables.go:366] bootstrap done</span><br><span class="line">I0611 17:53:28.697794       1 iptables.go:504] Some iptables rules are missing; deleting and recreating rules</span><br><span class="line">I0611 17:53:29.496576       1 iptables.go:366] bootstrap done</span><br><span class="line">E0611 18:40:00.096822       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 18:40:00.981247       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:06.900507       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:07.696829       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:11.904013       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:12.699112       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:16.906109       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:17.700350       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:21.907087       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 19:10:22.701113       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0611 23:26:26.010120       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 01:54:09.295176       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 01:55:10.203362       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:04:14.795485       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:05:44.800163       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:14:16.207339       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:14:16.312867       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:16:04.703252       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:05.999282       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:34.006303       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:39.009225       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:41.396200       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:44.011983       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:46.397122       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:49.014794       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:51.398528       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:54.016252       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:56.400014       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:18:59.019059       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:19:01.401163       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:19:04.021511       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:19:20.302554       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:19:59.906583       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:21:29.195932       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br><span class="line">E0612 02:22:49.310222       1 iptables.go:403] Failed to ensure iptables rules: error checking rule existence: failed to check rule existence: fork/exec /sbin/iptables: cannot allocate memory</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ iptables æ— æ³•åˆ†é…å†…å­˜ï¼Œé‡å¯ä¸‹ flannelï¼Œç„¶å curl åçœ‹ conntrack æ¡ç›®æ­£å¸¸äº†ï¼Œæ·»åŠ ä¸‹é‡å¤è§„åˆ™æµ‹è¯•ä¹Ÿæ­£å¸¸ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -w -t nat -A FLANNEL-POSTRTG -s 10.18x.0.0/16 ! -d 224.0.0.0/4 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br><span class="line">iptables -w -t nat -A FLANNEL-POSTRTG ! -s 10.18x.0.0/16 -d 10.18x.0.0/16 -m comment --comment &quot;flanneld masq&quot; -j MASQUERADE</span><br></pre></td></tr></table></figure><p>åé¦ˆç»™ç½‘å…³åŒäº‹è¯´å¥½äº†ï¼Œä»–è¯´è¿˜æ˜¯æœ‰é—®é¢˜çš„ IPï¼Œç­‰ conntrack è€åŒ–åå°±æ­£å¸¸äº†ã€‚æˆ‘å»çœ‹äº†ä¸‹ä¸»æœºç›‘æ§ï¼Œ<code>E0611 18:40:00.096822</code> å†…å­˜å’Œè´Ÿè½½ä»¥åŠæµé‡éƒ½æ­£å¸¸ï¼Œä»æŠ¥é”™æ¥è®²çœ‹ç€åƒæ˜¯ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯å…¶ä»–æœåŠ¡æ²¡æŠ¥é”™çœ‹ç€åƒæ˜¯ kernel memoryï¼Œä½†æ˜¯ç³»ç»Ÿæ—¥å¿—é‡Œä¹Ÿæ²¡æ‰¾åˆ°å¼‚å¸¸ï¼Œä¹Ÿå¯èƒ½æ˜¯ iptables bugã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;hostPort è®¿é—®è¿›æ¥çš„æº IP æ˜¯ cni0 åœ°å€çš„é—®é¢˜æ’æŸ¥&lt;/p&gt;</summary>
    
    
    
    
    <category term="hostPort" scheme="http://zhangguanzhang.github.io/tags/hostPort/"/>
    
  </entry>
  
  <entry>
    <title>arm64 redis COW æ£€æµ‹</title>
    <link href="http://zhangguanzhang.github.io/2024/05/22/redis-arm64-cow/"/>
    <id>http://zhangguanzhang.github.io/2024/05/22/redis-arm64-cow/</id>
    <published>2024-05-22T17:10:30.000Z</published>
    <updated>2024-05-22T17:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>å…³äº redis arm64 COW æ£€æµ‹</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>redis 5.0.14 å¼€å§‹ï¼Œä¼šå¸¦æœ‰ arm64 ä¸Šçš„ MADV_FREE&#x2F;fork çš„ kernal bug checkï¼Œå‚ç…§ä»¥ä¸‹ issue å’Œ pr</p><ul><li><a href="https://github.com/redis/redis/issues/8124">https://github.com/redis/redis/issues/8124</a></li><li><a href="https://github.com/redis/redis/pull/8224">https://github.com/redis/redis/pull/8224</a></li></ul><h2 id="å½±å“"><a href="#å½±å“" class="headerlink" title="å½±å“"></a>å½±å“</h2><p>æ ¹æ®ä»£ç é€»è¾‘ï¼Œredis arm64 ä¸Šå¯åŠ¨çš„æ—¶å€™ä¼šæ£€æµ‹ï¼Œå¦‚æœå­˜åœ¨ bugï¼Œåˆ™ä¸ä¼šå¯åŠ¨ï¼Œç±»ä¼¼ä¸‹é¢çš„æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># WARNING Your kernel has a bug that could lead to data corruption during background save. Please upgrade to the latest stable kernel.</span><br><span class="line"># Redis will now exit to prevent data corruption. Note that it is possible to suppress this warning by setting the following config: ignore-warnings ARM64-COW-BUG</span><br><span class="line">WARN exited: redis (exit status 1; not expected)</span><br></pre></td></tr></table></figure><p>éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œæ·»åŠ  <code>ignore-warnings ARM64-COW-BUG</code> æ‰è¡Œï¼Œå›½äº§çš„éº’éºŸå’Œä¸€äº›å…¶ä»–ç³»ç»Ÿçš„å†…æ ¸éƒ½æ˜¯ backpart å±…å¤šï¼ŒåŒäº‹è¯´éƒ¨åˆ†ç³»ç»Ÿä¸Š redis é…ç½®é‡ŒåŠ ä¸Šé…ç½®åä¼šæ— æ³•å¯åŠ¨ï¼Œä¸åŠ æ˜¯èƒ½å¯åŠ¨çš„ï¼Œä½†æ˜¯æˆ‘çœ‹ä»£ç æ˜¯å…ˆæ£€æŸ¥ COW å†çœ‹æ²¡é…ç½®é€‰é¡¹æ‰é€€å‡ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="keyword">if</span> ((ret = checkLinuxMadvFreeForkBug(&amp;err_msg)) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">&quot;WARNING %s&quot;</span>, err_msg);</span><br><span class="line">        sdsfree(err_msg);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        serverLog(LL_WARNING, <span class="string">&quot;Failed to test the kernel for a bug that could lead to data corruption during background save. &quot;</span></span><br><span class="line">                              <span class="string">&quot;Your system could be affected, please report this error.&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!checkIgnoreWarning(<span class="string">&quot;ARM64-COW-BUG&quot;</span>)) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Redis will now exit to prevent data corruption. &quot;</span></span><br><span class="line">                             <span class="string">&quot;Note that it is possible to suppress this warning by setting the following config: ignore-warnings ARM64-COW-BUG&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä»–è¯´çš„ç°è±¡æˆ‘æ˜¯å­˜ç–‘çš„ã€‚</p><h2 id="æ‰£æ£€æµ‹ä»£ç "><a href="#æ‰£æ£€æµ‹ä»£ç " class="headerlink" title="æ‰£æ£€æµ‹ä»£ç "></a>æ‰£æ£€æµ‹ä»£ç </h2><p>å‘ç° golang çš„ arm64 æ²¡æœ‰ <code>undefined: syscall.SYS_FORK</code>ï¼Œè¿˜æ˜¯ç›´æ¥æ‰£ä¸‹æ£€æµ‹ c å‡½æ•°ï¼Œç¼–è¯‘æˆäºŒè¿›åˆ¶ï¼Œç„¶ååŠ åˆ° redis docker-entrypoint.sh é‡Œåšé€»è¾‘è¿½åŠ é…ç½®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/redis/redis/blob/e92363e248019b8bf3fc7dd8ce84f648b6b13473/src/syscheck.c#L174-L299</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MADV_FREE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MADV_FREE 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">anetPipe</span><span class="params">(<span class="type">int</span> *fds, <span class="type">int</span> read_flags, <span class="type">int</span> write_flags)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pipe(fds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get size in kilobytes of the Shared_Dirty pages of the calling process for the</span></span><br><span class="line"><span class="comment"> * memory map corresponding to the provided address, or -1 on error. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">smapsGetSharedDirty</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret, in_mapping = <span class="number">0</span>, val = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> from, to;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    FILE *f;</span><br><span class="line"></span><br><span class="line">    f = fopen(<span class="string">&quot;/proc/self/smaps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!f) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!fgets(buf, <span class="keyword">sizeof</span>(buf), f))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        ret = <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx-%lx&quot;</span>, &amp;from, &amp;to);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">2</span>)</span><br><span class="line">            in_mapping = from &lt;= addr &amp;&amp; addr &lt; to;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_mapping &amp;&amp; !<span class="built_in">memcmp</span>(buf, <span class="string">&quot;Shared_Dirty:&quot;</span>, <span class="number">13</span>)) &#123;</span><br><span class="line">            <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%*s %d&quot;</span>, &amp;val);</span><br><span class="line">            <span class="comment">/* If parsing fails, we remain with val == -1 */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(f);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Older arm64 Linux kernels have a bug that could lead to data corruption</span></span><br><span class="line"><span class="comment"> * during background save in certain scenarios. This function checks if the</span></span><br><span class="line"><span class="comment"> * kernel is affected.</span></span><br><span class="line"><span class="comment"> * The bug was fixed in commit ff1712f953e27f0b0718762ec17d0adb15c9fd0b</span></span><br><span class="line"><span class="comment"> * titled: &quot;arm64: pgtable: Ensure dirty bit is preserved across pte_wrprotect()&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">checkLinuxMadvFreeForkBug</span><span class="params">(<span class="type">char</span> **error_msg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret, pipefd[<span class="number">2</span>] = &#123; <span class="number">-1</span>, <span class="number">-1</span> &#125;;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">char</span> *p = <span class="literal">NULL</span>, *q;</span><br><span class="line">    <span class="type">int</span> res = <span class="number">1</span>;</span><br><span class="line">    <span class="type">long</span> page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    <span class="type">long</span> map_size = <span class="number">3</span> * page_size;</span><br><span class="line"></span><br><span class="line">    p = mmap(<span class="literal">NULL</span>, map_size, PROT_READ, MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == MAP_FAILED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    q = p + page_size;</span><br><span class="line"></span><br><span class="line">    ret = mprotect(q, page_size, PROT_READ | PROT_WRITE);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">volatile</span> <span class="type">char</span>*)q = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ret = madvise(q, page_size, MADV_FREE);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINVAL) <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">volatile</span> <span class="type">char</span>*)q = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ret = anetPipe(pipefd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">        ret = smapsGetSharedDirty((<span class="type">unsigned</span> <span class="type">long</span>) q);</span><br><span class="line">        <span class="keyword">if</span> (!ret)</span><br><span class="line">            res = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">            res = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ret = write(pipefd[<span class="number">1</span>], &amp;res, <span class="keyword">sizeof</span>(res));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = read(pipefd[<span class="number">0</span>], &amp;res, <span class="keyword">sizeof</span>(res));</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            res = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        waitpid(pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    <span class="keyword">if</span> (pipefd[<span class="number">0</span>] != <span class="number">-1</span>) close(pipefd[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (pipefd[<span class="number">1</span>] != <span class="number">-1</span>) close(pipefd[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">NULL</span>) munmap(p, map_size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span> &amp;&amp; error_msg) &#123;</span><br><span class="line">        *error_msg = strdup(<span class="string">&quot;Your kernel has a bug that could lead to data corruption during background save. Please upgrade to the latest stable kernel.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> *error_msg = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> result = checkLinuxMadvFreeForkBug(&amp;error_msg);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Kernel bug detected: %s\n&quot;</span>, error_msg);</span><br><span class="line">        <span class="built_in">free</span>(error_msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;No kernel bug detected.\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error checking for kernel bug.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>arm64 ä¸Šç¼–è¯‘æˆé™æ€æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o check_bug -static check_bug.c</span><br></pre></td></tr></table></figure><p>ç„¶åæ„å»º docker é•œåƒï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">arch ?= <span class="variable">$(<span class="built_in">shell</span> uname -m)</span></span><br><span class="line"></span><br><span class="line"><span class="section">build:</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(arch)</span>, aarch64)</span><br><span class="line">gcc -o check_bug.sh -static check_bug.c</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="section">image: build</span></span><br><span class="line">docker build -t xxx .</span><br></pre></td></tr></table></figure><p><code>.gitignore</code> å¿½ç•¥äºŒè¿›åˆ¶æäº¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">check_bug.sh</span><br></pre></td></tr></table></figure><p>dockerfile é‡Œ <code>COPY *.sh</code></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…³äº redis arm64 COW æ£€æµ‹&lt;/p&gt;</summary>
    
    
    
    
    <category term="redis" scheme="http://zhangguanzhang.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>k8s node çƒ­æ‰©å®¹å†…å­˜å¯¼è‡´çš„ä¸€æ¬¡ä¸šåŠ¡æ•…éšœ</title>
    <link href="http://zhangguanzhang.github.io/2024/05/01/kubernetes-hotplug-resource/"/>
    <id>http://zhangguanzhang.github.io/2024/05/01/kubernetes-hotplug-resource/</id>
    <published>2024-05-01T15:10:30.000Z</published>
    <updated>2024-05-01T15:10:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>k8s node çƒ­æ‰©å®¹å†…å­˜å¯¼è‡´çš„ä¸€æ¬¡ä¸šåŠ¡æ•…éšœ</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>2024&#x2F;04 æœˆåº•å‘ç”Ÿçš„ï¼Œk8s node çƒ­æ‰©å®¹å†…å­˜å¯¼è‡´çš„ä¸€æ¬¡ä¸šåŠ¡æ•…éšœï¼Œæ­¤æ¬¡ä¸æ˜¯æ’æŸ¥ï¼Œè€Œæ˜¯è¿‡ç¨‹æ¢³ç†ã€‚k8s ç‰ˆæœ¬æ˜¯ 1.27.4ã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p>æˆ‘ä»¬æœ‰äº›ä¸šåŠ¡çš„ cpu å’Œå†…å­˜æ˜¯æ ¹æ®ä½¿ç”¨äººæ•°ä¸Šæ¶¨çš„ï¼Œå¤šå‰¯æœ¬èµ„æºå ç”¨ &gt; å•ä¸ªé«˜é…å‰¯æœ¬ï¼Œä¾‹å¦‚ 1000 ä¸ªäººä½¿ç”¨æŸä¸ªåŠŸèƒ½ï¼Œå¤šå‰¯æœ¬å¯èƒ½éœ€è¦ 6ä¸ª 4c4Gï¼Œä½†æ˜¯å•ä¸ªå‰¯æœ¬ 18c16G å°±å¯ä»¥ã€‚æ‰€ä»¥æˆ‘ä»¬çš„æ ¸å¿ƒä¸šåŠ¡æœåŠ¡éƒ½æ˜¯ä¸åŠ  limit çš„ã€‚è¯¥æœåŠ¡ä¹Ÿæœ‰è‡ªæˆ‘é™åˆ¶ï¼Œä¾‹å¦‚å®ƒæœ€å¤šä½¿ç”¨æœºå™¨çš„ 85% å†…å­˜åï¼Œåç»­è¯·æ±‚å°±ä¸å¤„ç†ã€‚</p><p>å®¢æˆ·ä½¿ç”¨äººæ•°ä¸Šå‡ï¼Œå‘Šè­¦åç°åœºäººå‘˜è®©å®¢æˆ·ç»™æœºå™¨åŠ äº†å†…å­˜ï¼ˆhotplugï¼‰ ç”± 64g -&gt; 128g ï¼Œç„¶åè¿‡äº†ä¸€å¤©åæœºå™¨é¢‘ç¹é©±é€å¯¼è‡´ cpu é«˜ã€‚çœ‹ kubelet æ—¥å¿—æŠ¥é”™å†…å­˜å‹åŠ›è§¦å‘é©±é€ï¼Œä½†æ˜¯çœ‹ç›‘æ§ä½¿ç”¨è¿˜å¥½ï¼ˆnode_exporterè·å–æ˜¯å®æ—¶çš„ï¼‰å†…å­˜æ²¡åˆ° 75% ä»¥ä¸Šæ‰ 65%ï¼Œæ ¸å¿ƒæœåŠ¡æ—¥å¿—é‡Œä¹Ÿæ²¡åˆ°ç™¾åˆ†æ¯”ä¸Šçº¿å†…å­˜ï¼Œåé¢å‘ç°æ˜¯ kubelet çš„å†…å­˜ä¿¡æ¯è¿˜æ˜¯è€çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Capacity:</span><br><span class="line">  cpu:                16</span><br><span class="line">  ...</span><br><span class="line">  memory:             65789716Ki</span><br><span class="line">  pods:               253</span><br><span class="line">Allocatable:</span><br><span class="line">  cpu:                15400m</span><br><span class="line">  ...</span><br><span class="line">  memory:             63225620Ki</span><br><span class="line">  pods:               253</span><br></pre></td></tr></table></figure><p>é‡å¯ kubelet åï¼Œå†…å­˜ä¿¡æ¯å°±æ­£å¸¸äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Capacity:</span><br><span class="line">  cpu:                16</span><br><span class="line">  ...</span><br><span class="line">  memory:             103538444Ki</span><br><span class="line">  pods:               253</span><br><span class="line">Allocatable:</span><br><span class="line">  cpu:                15400m</span><br><span class="line">  ...</span><br><span class="line">  memory:             100974348Ki</span><br><span class="line">  pods:               253</span><br></pre></td></tr></table></figure><h2 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h2><p>åœ¨ <code>func NewMainKubelet(</code> é‡Œï¼Œåªè·å–ä¸€æ¬¡</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/kubernetes/kubernetes/blob/7b359a2f9e1ff5cdc49cfcc4e350e9d796f502c0/pkg/kubelet/kubelet.go#L607-L614</span></span><br><span class="line"></span><br><span class="line">machineInfo, err := klet.cadvisor.MachineInfo()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Avoid collector collects it as a timestamped metric</span></span><br><span class="line"><span class="comment">// See PR #95210 and #97006 for more details.</span></span><br><span class="line">machineInfo.Timestamp = time.Time&#123;&#125;</span><br><span class="line">klet.setCachedMachineInfo(machineInfo)</span><br></pre></td></tr></table></figure><p>å…¨å±€æœ <code>setCachedMachineInfo(</code> æ‰¾åˆ°äº† <code>kubernetes/pkg/kubelet/kubelet_getters.go</code> ä¸‹çš„:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetCachedMachineInfo assumes that the machine info can&#x27;t change without a reboot</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> GetCachedMachineInfo() (*cadvisorapiv1.MachineInfo, <span class="type">error</span>) &#123;</span><br><span class="line">kl.machineInfoLock.RLock()</span><br><span class="line"><span class="keyword">defer</span> kl.machineInfoLock.RUnlock()</span><br><span class="line"><span class="keyword">return</span> kl.machineInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> setCachedMachineInfo(info *cadvisorapiv1.MachineInfo) &#123;</span><br><span class="line">kl.machineInfoLock.Lock()</span><br><span class="line"><span class="keyword">defer</span> kl.machineInfoLock.Unlock()</span><br><span class="line">kl.machineInfo = info</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ <code>GetCachedMachineInfo</code> æ‰¾åˆ° <code>kubernetes/pkg/kubelet/kubelet_node_status.go</code> ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/kubernetes/kubernetes/blob/d1c7f7a0e9d59aa88aa5b4d07db7e14772b3e386/pkg/kubelet/kubelet_node_status.go#L733</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(kl *Kubelet)</span></span> defaultNodeStatusFuncs()</span><br><span class="line">....</span><br><span class="line">setters = <span class="built_in">append</span>(setters,</span><br><span class="line">...</span><br><span class="line">nodestatus.MachineInfo(.... kl.GetCachedMachineInfo, ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶å <code>kubernetes/pkg/kubelet/nodestatus/setters.go</code> é‡Œçš„ <code>func MachineInfo(</code></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/nodestatus/setters.go#L283</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MachineInfo</span><span class="params">(nodeName <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">...</span></span></span><br><span class="line"><span class="params"><span class="function">machineInfoFunc <span class="keyword">func</span>()</span></span> (*cadvisorapiv1.MachineInfo, <span class="type">error</span>),</span><br><span class="line">    ...</span><br><span class="line">    info, err := machineInfoFunc()</span><br></pre></td></tr></table></figure><p><code>defaultNodeStatusFuncs</code> æ˜¯ node kubelet æ¯ <code>nodeStatusUpdateFrequency</code> æ—¶å€™æŸ¥çœ‹ä¸€äº›ä¿¡æ¯å˜åŒ–å¦ï¼Œå˜äº†åé¢ä¼šä¸ŠæŠ¥æ›´æ–°ï¼Œä»ä¸Šé¢æ•´ä¸ªä»£ç æµç¨‹çœ‹æ˜¯åªè·å–äº†ä¸€æ¬¡ï¼Œå¼€äº†ä¸ªè™šæ‹Ÿæœºæ­å»ºä¿®æ”¹ä»£ç  <code>GetCachedMachineInfo()</code> å†…å°¾éƒ¨è¿½åŠ ï¼Œç¼–è¯‘æ›¿æ¢åè¿è¡Œï¼Œæ‰©å®¹æµ‹è¯•äº†ä¸‹å¯ä»¥ä¸é‡å¯åŠ¨æ€æ›´æ–°ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Â  Â  <span class="comment">// Avoid collector collects it as a timestamped metric</span></span><br><span class="line">Â  Â  <span class="comment">// See PR #95210 and #97006 for more details.</span></span><br><span class="line">Â  Â  <span class="comment">// cannot use kl.machineInfo.Timestamp</span></span><br><span class="line">Â  Â  <span class="keyword">if</span> kl.lastStatusReportTime.Before(time.Now().Add(<span class="number">-50</span> * time.Second)) &#123;</span><br><span class="line">Â  Â  Â  Â  currentMachineInfo, err := kl.cadvisor.MachineInfo()</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line"></span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> currentMachineInfo.NumCores &gt; kl.machineInfo.NumCores &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  kl.machineInfo.NumCores = currentMachineInfo.NumCores</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  Â  Â  <span class="keyword">if</span> currentMachineInfo.MemoryCapacity &gt; kl.machineInfo.MemoryCapacity &#123;</span><br><span class="line">Â  Â  Â  Â  Â  Â  kl.machineInfo.MemoryCapacity = currentMachineInfo.MemoryCapacity</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  Â  &#125;</span><br></pre></td></tr></table></figure><p>åé¢å»æäº† kep <a href="https://github.com/kubernetes/enhancements/issues/4609">Hot increase cpu&#x2F;memory&#x2F;storage without restarting kubelet</a> ä½†æ˜¯å‘ç°ä¹‹å‰å°±æœ‰äº†ï¼Œåªä¸è¿‡ä¾æ—§æ²¡ç¬¦åˆè¦æ±‚å’Œåˆå…¥ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;k8s node çƒ­æ‰©å®¹å†…å­˜å¯¼è‡´çš„ä¸€æ¬¡ä¸šåŠ¡æ•…éšœ&lt;/p&gt;</summary>
    
    
    
    
    <category term="kubernetes" scheme="http://zhangguanzhang.github.io/tags/kubernetes/"/>
    
    <category term="hotplug" scheme="http://zhangguanzhang.github.io/tags/hotplug/"/>
    
  </entry>
  
  <entry>
    <title>å¼€æºå®¹å™¨é•œåƒæ‰«æ trivy æ‡’äººé‡ç‚¹æŒ‡å—</title>
    <link href="http://zhangguanzhang.github.io/2024/04/22/trivy/"/>
    <id>http://zhangguanzhang.github.io/2024/04/22/trivy/</id>
    <published>2024-04-22T18:35:30.000Z</published>
    <updated>2024-04-22T18:35:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>å†™ç»™é‚£äº›ä¸çˆ±çœ‹æ–‡æ¡£å’Œè‡ªå·±ä½¿ç”¨ä¸­åº”è¯¥æ³¨æ„çš„ä¸€äº›æŠ€å·§</p><span id="more"></span><h2 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº"></a>å…³äº</h2><p>ä»‹ç»ä¸‹ trivy çš„ä½¿ç”¨å’Œä¸€äº›æ³¨æ„çš„ç‚¹</p><h2 id="ä»‹ç»å’Œå®‰è£…"><a href="#ä»‹ç»å’Œå®‰è£…" class="headerlink" title="ä»‹ç»å’Œå®‰è£…"></a>ä»‹ç»å’Œå®‰è£…</h2><p><a href="https://github.com/aquasecurity/trivy">trivy</a> æ˜¯ä¸€ä¸ªæ¼æ´å®‰å…¨æ‰«æï¼Œå¯ä»¥æ‰«æ</p><ul><li>Container Image</li><li>Filesystem</li><li>Git Repository (remote)</li><li>Virtual Machine Image</li><li>Kubernetes</li><li>AWS</li></ul><p>å› ä¸ºæ˜¯ golang å¼€å‘çš„ï¼Œå®‰è£…éå¸¸ç®€å• <a href="https://github.com/aquasecurity/trivy/releases">release</a> é¡µé¢æ‰¾åˆ°æœ€æ–°çš„ releaseï¼Œç‚¹å‡» <code>Show all xx aseets</code> åä¸‹è½½ <code>trivy_x.xx.x_Linux-64bit.tar.gz</code> ä¸‹æ¥è§£å‹å³å¯ã€‚</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>trivy çš„ cmd å’Œ option æ˜¯ä½¿ç”¨ cobra æ¡†æ¶å†™çš„ï¼Œæ”¯æŒå­å‘½ä»¤å’Œå…¨å±€é€‰é¡¹ï¼Œå¯ä»¥<code>trivy -h</code>ã€ <code>trivy image -h</code> ä¾æ¬¡æŸ¥çœ‹å¯¹åº”çš„å‘½ä»¤å¸®åŠ©ã€‚</p><p>æ‰«æç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ trivy image debian:12</span><br><span class="line">$ trivy image --input debian-12.tar.gz</span><br><span class="line">$ trivy repo https://github.com/knqyf263/trivy-ci-test</span><br><span class="line">$ trivy k8s --report summary cluster</span><br></pre></td></tr></table></figure><p>å¯ä»¥è‡ªè¡Œç ”ç©¶ä¸‹å‘½ä»¤å‚æ•°å’Œçœ‹<a href="https://aquasecurity.github.io/trivy/latest/">å®˜æ–¹æ–‡æ¡£</a>ï¼Œè¿™é‡Œä¸å†™è¯¦ç»†çš„ï¼Œå¾ˆå¤šè¿˜æ˜¯è¦çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p><p>trivy åœ¨æ‰§è¡Œæ‰«æçš„æ—¶å€™ï¼Œä¼šä¸‹è½½ä¸¤ä¸ª dbæ–‡ä»¶ï¼š</p><ul><li><code>ghcr.io/aquasecurity/trivy-db</code></li><li><code>ghcr.io/aquasecurity/trivy-java-db</code></li></ul><p>è¯¥æ–‡ä»¶æ˜¯ ociï¼ˆ<code>application/vnd.oci.image.manifest.v1</code>ï¼‰ é•œåƒæ ¼å¼çš„ï¼ŒåŒæ—¶æ˜¯å­˜å‚¨åœ¨ ghcr çš„ github é•œåƒä»“åº“ä¸Šçš„ï¼Œå›½å†…å¯èƒ½èƒ½æ‹‰å–åˆ°ï¼Œæ›´å¤§å¯èƒ½æ˜¯æ‹‰å–ä¸åˆ°ã€‚å¯ä»¥ä½¿ç”¨å›½å†…çš„åŒæ­¥æºï¼š</p><ul><li><code>m.daocloud.io/ghcr.io/aquasecurity/trivy-db</code></li><li><code>m.daocloud.io/ghcr.io/aquasecurity/trivy-java-db</code></li></ul><p>å‘½ä»¤è¡Œå‚æ•°ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trivy image --db-repository m.daocloud.io/ghcr.io/aquasecurity/trivy-db \</span><br><span class="line">  --java-db-repository m.daocloud.io/ghcr.io/aquasecurity/trivy-java-db  \</span><br><span class="line">  debian:12</span><br></pre></td></tr></table></figure><h2 id="cve-å‡†ç¡®æ€§"><a href="#cve-å‡†ç¡®æ€§" class="headerlink" title="cve å‡†ç¡®æ€§"></a>cve å‡†ç¡®æ€§</h2><p>æˆ‘ä»¬å†…éƒ¨ä½¿ç”¨æ‰«æåï¼Œå®¢æˆ·ç°åœºæ‰«æçš„æŠ¥å‘Šï¼ŒæŸ¥çœ‹äº†ç»“æœä¸¤è€…ä¸æ˜¯ä¸€æ ·çš„ï¼Œå±äºä¸¤è€…ç»“æœæœ‰éƒ¨åˆ†äº¤é›†çš„ç»“æœã€‚æŸ¥çœ‹<a href="https://aquasecurity.github.io/trivy/latest/docs/scanner/vulnerability/">å®˜æ–¹æ–‡æ¡£ vulnerability</a> ç« èŠ‚è¯´æ˜äº†å‰é¢ä¿© db çš„æ•°æ®æ¥æºï¼Œå¹¶ä¸æ˜¯æ¯”è¾ƒå…¨çš„ cve åˆ—è¡¨ï¼ŒåŒæ—¶ <a href="https://github.com/aquasecurity/trivy-db">trivy-db</a> æ˜¯æ¯éš” 6 ä¸ªå°æ—¶æ„å»ºæ›´æ–°çš„</p><h2 id="å†…éƒ¨-ci-ä¸Šä½¿ç”¨"><a href="#å†…éƒ¨-ci-ä¸Šä½¿ç”¨" class="headerlink" title="å†…éƒ¨ ci ä¸Šä½¿ç”¨"></a>å†…éƒ¨ ci ä¸Šä½¿ç”¨</h2><p>å…ˆå¾—è§£å†³æœºå™¨æ— æ³•æ‹‰å– github é•œåƒä»“åº“ï¼Œéœ€è¦é…åŒæ­¥åˆ°å†…ç½‘é•œåƒä»“åº“ä¸Šæ¯”è¾ƒå¥½ï¼Œå¦å¤– oci æ ¼å¼æ˜¯ä¸æ”¯æŒ docker pull çš„ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://github.com/containers/skopeo">skopeo</a> çš„ sync å‘½ä»¤æ¯å¤©å®šæ—¶é—´éš”åŒæ­¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">declare -a list=(</span><br><span class="line">    &quot;trivy-db:2&quot;</span><br><span class="line">    &quot;trivy-db:1&quot;</span><br><span class="line">    trivy-db</span><br><span class="line">    &quot;trivy-java-db:1&quot;</span><br><span class="line">)</span><br><span class="line">    for image in $&#123;list[@]&#125;;do</span><br><span class="line">        skopeo --insecure-policy copy docker://m.daocloud.io/ghcr.io/aquasecurity/$&#123;image&#125; docker://xxx.com/ci-run/$&#123;image&#125;</span><br><span class="line"></span><br><span class="line">    done</span><br></pre></td></tr></table></figure><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://aquasecurity.github.io/trivy/latest/docs/references/configuration/cli/trivy_server/">trivy_server</a> æ”¯æŒ client&#x2F;server æ¨¡å¼çš„ï¼Œserver æ˜¯ä¸€ç›´è¿è¡Œçš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">trivy server</span><br><span class="line">trivy image --server http://localhost/remote:4954 alpine</span><br></pre></td></tr></table></figure><p>å¯¹äºæˆ‘ä»¬å¥½å¤šèŠ‚ç‚¹è¿˜æœ‰åœ°åŸŸæ€§è´¨çš„ jenkins æ„å»ºåœºæ™¯ä¸é€‚åˆï¼ŒåŒæ—¶æ¯ä¸ªå•ç‹¬è¿è¡Œçš„è¯ï¼Œç”±äº db é»˜è®¤æ˜¯ä¸‹è½½åè§£å‹åˆ° <code>~/.cache/trivy</code> ä¸‹çš„æ–‡ä»¶ï¼Œé»˜è®¤çš„ <code>--cache-backend</code> æ˜¯ fsï¼Œå¤š jenkins æ„å»ºæœºå™¨çš„è¯ï¼Œä¼šæ¯æ¬¡è¿è¡Œéƒ½ä¸‹è½½å¾ˆæµªè´¹å®¹é‡ã€‚</p><p>æŸ¥çœ‹äº†å®˜æ–¹æ–‡æ¡£ <a href="https://aquasecurity.github.io/trivy/latest/docs/configuration/cache/">cache</a> æ”¯æŒ redis ä½œä¸ºç¼“å­˜çš„ï¼Œä½†æ˜¯ä» -h é€‰é¡¹å’Œæ–‡æ¡£é‡Œç¤ºä¾‹çš„éƒ½æ˜¯ tls çš„ redis é“¾æ¥æ–¹å¼ï¼Œå¯¹äºå¯†ç æ–¹å¼å°±ä¸æ”¯æŒï¼Œç„¶åæŸ¥çœ‹æºç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/aquasecurity/trivy/blob/63c9469bdd91ee71ee643862329a3948b42c561d/pkg/commands/operation/operation.go#L43-L69</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCache</span><span class="params">(c flag.CacheOptions)</span></span> (Cache, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> strings.HasPrefix(c.CacheBackend, <span class="string">&quot;redis://&quot;</span>) &#123;</span><br><span class="line">log.Info(<span class="string">&quot;Redis cache&quot;</span>, log.String(<span class="string">&quot;url&quot;</span>, c.CacheBackendMasked()))</span><br><span class="line">options, err := redis.ParseURL(c.CacheBackend)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Cache&#123;&#125;, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !lo.IsEmpty(c.RedisOptions) &#123;</span><br><span class="line">caCert, cert, err := GetTLSConfig(c.RedisCACert, c.RedisCert, c.RedisKey)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Cache&#123;&#125;, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">options.TLSConfig = &amp;tls.Config&#123;</span><br><span class="line">RootCAs:      caCert,</span><br><span class="line">Certificates: []tls.Certificate&#123;cert&#125;,</span><br><span class="line">MinVersion:   tls.VersionTLS12,</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> c.RedisTLS &#123;</span><br><span class="line">options.TLSConfig = &amp;tls.Config&#123;</span><br><span class="line">MinVersion: tls.VersionTLS12,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">redisCache := cache.NewRedisCache(options, c.CacheTTL)</span><br><span class="line"><span class="keyword">return</span> Cache&#123;Cache: redisCache&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç° redis çš„ client åº“æ˜¯ä½¿ç”¨çš„ <a href="https://github.com/go-redis/redis/v8">go-redis</a>ï¼ŒæŸ¥çœ‹å®ƒçš„å®˜æ–¹æ–‡æ¡£ï¼Œå‘ç°å¯ä»¥ DSN å½¢å¼ä¼ å…¥å¯†ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt, err := redis.ParseURL(<span class="string">&quot;redis://&lt;user&gt;:&lt;pass&gt;@localhost:6379/&lt;db&gt;&quot;</span>)</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œä¸æ¨èå‘½ä»¤è¡Œå¸¦å‚æ•°ï¼Œä¸ç„¶ä¼šæ³„éœ²å¯†ç ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://aquasecurity.github.io/trivy/latest/docs/references/configuration/config-file/">config-file</a> ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">m.daocloud.io/ghcr.io/aquasecurity/trivy-db</span></span><br><span class="line">  <span class="attr">java-repository:</span> <span class="string">m.daocloud.io/ghcr.io/aquasecurity/trivy-java-db</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">backend:</span> <span class="string">&quot;redis://:xxx@redis-server:6379&quot;</span></span><br></pre></td></tr></table></figure><p>ä¸€å¼€å§‹æŠ¥é”™ noauthï¼Œåé¢å‘ç°å¿…é¡»åŠ å†’å·ï¼Œæ²¡æœ‰ç”¨æˆ·åå°±æ˜¯ä¸Šé¢è¿™æ ·çš„æ ¼å¼ï¼ŒåŒæ—¶å®˜æ–¹æ–‡æ¡£ <a href="https://aquasecurity.github.io/trivy/latest/docs/configuration/">configuration</a> è¯´æ˜äº†ï¼Œå¯¹äºæ¯ä¸€ä¸ªé•¿é€‰é¡¹ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡ä»£æ›¿ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">trivy --config xxx.yml xxx</span><br><span class="line">TRIVY_CONFIG=xxx.yml trivy xxx</span><br></pre></td></tr></table></figure><p>è¿™æ · ci é‡Œè¿è¡Œä¹Ÿä¸ç”¨å¸¦ cmdline æ³„éœ²é…ç½®æ–‡ä»¶è·¯å¾„ã€‚å½“ç„¶è¿˜æ”¯æŒæ¨¡æ¿å’Œ output format ä»¥åŠè®¾ç½® <code>--exit-code </code> ä¼šåœ¨ ci é‡Œå¾ˆå®ç”¨ã€‚é¿å…æ‰«æçš„æ—¶å€™ä¸‹è½½ç¼“å­˜å¤±è´¥å¯¼è‡´æ‰«æç»“æœæ²¡å‡ºæ¥ï¼Œå¯ä»¥æ‰«æä¹‹å‰ï¼Œæ‰§è¡Œä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">until trivy image --download-db-only; do</span><br><span class="line">echo &quot;Command failed. Retrying...&quot;</span><br><span class="line">sleep 1</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">until trivy image --download-java-db-only; do</span><br><span class="line">echo &quot;Command failed. Retrying...&quot;</span><br><span class="line">sleep 1</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>jenkins é‡Œï¼Œæ‰«æå¯ä»¥ä½¿ç”¨å®˜æ–¹çš„ html.tpl æ¨¡æ¿ï¼Œæœ€åç”¨ <a href="https://www.jenkins.io/doc/pipeline/steps/htmlpublisher/">publishHTML</a> å±•ç¤ºã€‚ç”±äº trivy ä¸æ”¯æŒä¸€æ¬¡æ‰«æå¤šä¸ªé•œåƒï¼Œå¯ä»¥æŠŠå®˜æ–¹çš„æ¨¡æ¿æ–‡ä»¶ä¸‹è½½ååˆ†å‰²æˆä¸‰éƒ¨åˆ†æ‹¼æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cp &quot;$&#123;tpl_dir&#125;/trivy-html-head.tpl&quot; report.html</span><br><span class="line">while read -r line; do</span><br><span class="line">    if [ -f &quot;$line&quot; ];then</span><br><span class="line">        trivy image --format template --template &quot;@$&#123;tpl_dir&#125;/trivy-html-body.tpl&quot; -o report.tmp --input $line</span><br><span class="line">        cat report.tmp &gt;&gt; report.html</span><br><span class="line">        # break</span><br><span class="line">    fi</span><br><span class="line">done &lt; &quot;/dev/stdin&quot;</span><br><span class="line">rm -f report.tmp</span><br><span class="line">cat &quot;$&#123;tpl_dir&#125;/trivy-html-end.tpl&quot; &gt;&gt; report.html</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>å¯¹äº trivy-db æ–‡ä»¶æ›´è¯¦ç»†çš„åˆ†æå’Œä»‹ç»æ–‡ç«  <a href="https://zhuanlan.zhihu.com/p/608116087">é•œåƒå®‰å…¨æ‰«æå·¥å…·Trivyæ·±å…¥å®è·µ</a></li><li><a href="https://www.rectcircle.cn/posts/oci-image-spec/">OCI æ ¼å¼ç ”ç©¶</a></li><li><a href="https://github.com/aquasecurity/trivy/discussions/3688">https://github.com/aquasecurity/trivy/discussions/3688</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å†™ç»™é‚£äº›ä¸çˆ±çœ‹æ–‡æ¡£å’Œè‡ªå·±ä½¿ç”¨ä¸­åº”è¯¥æ³¨æ„çš„ä¸€äº›æŠ€å·§&lt;/p&gt;</summary>
    
    
    
    
    <category term="trivy" scheme="http://zhangguanzhang.github.io/tags/trivy/"/>
    
  </entry>
  
  <entry>
    <title>golang pprof è½¬ svg çš„æœ€å°äºŒè¿›åˆ¶ä¾èµ–å°è¯•</title>
    <link href="http://zhangguanzhang.github.io/2024/04/16/pprof-small/"/>
    <id>http://zhangguanzhang.github.io/2024/04/16/pprof-small/</id>
    <published>2024-04-16T19:05:30.000Z</published>
    <updated>2024-04-16T19:05:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ä¾èµ– go ï¼Œæœ€å°äºŒè¿›åˆ¶æŠŠ pprof è½¬ svg çš„æ¢ç´¢</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>å†…éƒ¨åŒäº‹åšäº†ä¸ªé‡‡é›†ä¸šåŠ¡ pprof çš„åŠŸèƒ½ï¼Œå‘ç°å·¥å…·é•œåƒéå¸¸è‡ƒè‚¿ï¼Œå¸¦äº†ä¸ª golang å‡ºå»ã€‚ç”¨çš„æ˜¯ <a href="https://github.com/uber-archive/go-torch">go-torch</a> æŠŠ <code>curl -o /debug/pprof/profile</code> é‡‡é›†çš„æ–‡ä»¶è½¬æˆ svg ï¼Œè½¬æ¢çš„æ—¥å¿—é‡Œå‘ç°å®ƒå‘½ä»¤è¡Œè°ƒç”¨äº† <code>go tool pprof</code>ï¼Œè€Œä¸” <code>go-torch</code> æˆ‘çœ‹ä»“åº“å·²ç»ä¸ç»´æŠ¤äº†ã€‚</p><h2 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h2><p>ä¸€ä¸ªæ˜¯æ¶‰åŠåˆ°è¿­ä»£è§£å†³å®‰å…¨ï¼Œå¦ä¸€ä¸ª golang å·²ç» go è‡ªä¸¾äº†ï¼ŒæŠŠ <code>go tool pprof</code> çš„ <code>pprof</code> å‘½ä»¤æŠ å‡ºæ¥ç›´æ¥ç”¨å°±è¡Œäº†ï¼Œç”šè‡³éƒ½ä¸éœ€è¦ golang ç¯å¢ƒäº†ï¼Œæœäº†ä¸‹å‘ç°å®é™… <code>go tool pprof</code> å°±æ˜¯ä»“åº“ <a href="https://github.com/google/pprof">google&#x2F;pprof</a>ã€‚</p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p><code>go-torch</code> è½¬æ¢çš„å‘½ä»¤å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go-torch xxx-profile-20240416110934.pg.gz -f 1.svg</span></span><br><span class="line">INFO[03:12:29] Run pprof command: go tool pprof -raw -seconds 30 xxx-profile-20240416110934.pg.gz</span><br><span class="line">INFO[03:12:29] Writing svg to 1.svg</span><br></pre></td></tr></table></figure><p>æµ…æ˜¾çš„çœ‹äº†ä¸‹å®ƒçš„æºç ï¼Œå‘ç°å®ƒæ˜¯æŠŠ pprof çš„ raw æ ¼å¼è¾“å‡ºï¼ŒæŒ‰ç…§ pprof çš„å­—èŠ‚æµæ ¼å¼è§£æçš„ï¼Œå°±æ˜¯ <code>state funcnames samplenames records</code> é‚£äº›ï¼Œç„¶åè°ƒç”¨ <code>flamegraph</code> perl è„šæœ¬è½¬ svg çš„ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/uber-archive/go-torch/blob/master/renderer/flamegraph.go#L37</span></span><br><span class="line">flameGraphScripts    = []<span class="type">string</span>&#123;<span class="string">&quot;flamegraph&quot;</span>, <span class="string">&quot;flamegraph.pl&quot;</span>, <span class="string">&quot;./flamegraph.pl&quot;</span>, <span class="string">&quot;./FlameGraph/flamegraph.pl&quot;</span>, <span class="string">&quot;flame-graph-gen&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå•çº¯è½¬ svgï¼Œpprof å·¥å…·å°±å¯ä»¥ï¼Œå®ƒè½¬ svg ä¼šå…ˆè½¬ dot æ ¼å¼ï¼Œç„¶å exec è°ƒç”¨ <code>graphviz</code> åŒ…ä¸‹çš„ dot å‘½ä»¤ã€‚</p><p>dot å‘½ä»¤è¦åŒ…ç®¡ç†å®‰è£…ï¼Œå¹¶ä¸”å¾ˆå¤šä¾èµ–ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ golang çš„å®ç°ã€‚è°·æ­Œæœç´¢ <code>golang dot to svg</code> çœ‹åˆ°äº†ç¬¬ä¸€ä¸ªä»“åº“ <a href="https://github.com/goccy/go-graphviz">goccy&#x2F;go-graphviz</a>ï¼Œå¤§è‡´çœ‹äº†ä¸‹ readme.md ï¼Œå‘ç°å®ƒä¸ä¾èµ– <code>graphviz</code> å¹¶ä¸”æä¾›äº†ä¸€ä¸ª dot çš„å‘½ä»¤å®ç°ã€‚æµ‹è¯•ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/google/pprof@latest</span><br><span class="line">go install github.com/goccy/go-graphviz/cmd/dot@latest</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è½¬ svgï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pprof -svg -seconds 30 http://xx.xxx.0.84:xxxx/debug/pprof/profile &gt; test.svg</span></span><br><span class="line">Fetching profile over HTTP from http://xx.xxx.0.84:xxxx/debug/pprof/profile?seconds=30</span><br><span class="line">Please wait... (30s)</span><br><span class="line">Saved profile in /root/pprof/pprof.xxxx.samples.cpu.001.pb.gz</span><br><span class="line">the required flag `-o&#x27; was not specified</span><br></pre></td></tr></table></figure><p>å‘ç°æŠ¥é”™ï¼ŒæŸ¥çœ‹äº†ä¸‹ pprof çš„æºç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/google/pprof/blob/26353dc0451f29f7b9cdade98377a016779b8527/internal/driver/commands.go#L385-L408</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">invokeDot</span><span class="params">(format <span class="type">string</span>)</span></span> PostProcessor &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(input io.Reader, output io.Writer, ui plugin.UI)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">cmd := exec.Command(<span class="string">&quot;dot&quot;</span>, <span class="string">&quot;-T&quot;</span>+format)</span><br><span class="line">cmd.Stdin, cmd.Stdout, cmd.Stderr = input, output, os.Stderr</span><br><span class="line"><span class="keyword">if</span> err := cmd.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to execute dot. Is Graphviz installed? Error: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// massageDotSVG invokes the dot tool to generate an SVG image and alters</span></span><br><span class="line"><span class="comment">// the image to have panning capabilities when viewed in a browser.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">massageDotSVG</span><span class="params">()</span></span> PostProcessor &#123;</span><br><span class="line">generateSVG := invokeDot(<span class="string">&quot;svg&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(input io.Reader, output io.Writer, ui plugin.UI)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">baseSVG := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line"><span class="keyword">if</span> err := generateSVG(input, baseSVG, ui); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">_, err := output.Write([]<span class="type">byte</span>(massageSVG(baseSVG.String())))</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯æŠŠ dot æ ¼å¼çš„å­—èŠ‚æµç»™ <code>dot -Tsvg</code> çš„ stdin ï¼Œdot å‘½ä»¤ä¼šè‡ªåŠ¨æŠŠæµè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œç„¶å pprof ä¼šæŠŠ dot è¾“å‡ºçš„å­—èŠ‚æµæ•è·ï¼Œä¸Šé¢çš„æŠ¥é”™å°±æ˜¯ golang çš„ dot æœ‰é—®é¢˜ã€‚çœ‹äº†ä¸‹ dot çš„æºç ï¼Œå‘ç° -o é€‰é¡¹æ˜¯å¿…é¡»çš„ï¼Œä¸‹é¢æ˜¯æ”¹è¿‡çš„ diffï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">18c18</span><br><span class="line">&lt; OutputFile string          `description:&quot;specify output file name&quot; short:&quot;o&quot; required:&quot;true&quot;`</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt; OutputFile string          `description:&quot;specify output file name&quot; short:&quot;o&quot;`</span><br><span class="line">51a52,54</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; if !terminal.IsTerminal(0) &#123;</span><br><span class="line">&gt; opt.OutputFile = &quot;/dev/stdout&quot;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘åæ›¿æ¢äº†ï¼Œå‘ç°å¯ä»¥è½¬æ¢æˆ svg äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œä¼šè¾“å‡º <code>Saved profile in /root/pprof/pprof.main.samples.cpu.001.pb.gz</code> å‘ç°ä¼šæŠŠ tmp æ–‡ä»¶å­˜åœ¨è¿™é‡Œï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å˜é‡ <code>PPROF_TMPDIR</code> æŒ‡å®š tmp æ–‡ä»¶è·¯å¾„ï¼Œä½†æ˜¯ pprof æ²¡æœ‰ä»»ä½•é€‰é¡¹å‚æ•°åˆ é™¤è¿™ä¸ª tmp æ–‡ä»¶ï¼Œæäº† issue ç›´æ¥ç»™æˆ‘å…³äº†ã€‚</p><p>å…¶å®ä¹Ÿå¯ä»¥æ‰£ pprof æºç æ‹¼ <code>go-graphviz</code> åº“æºç ï¼Œè¿™æ ·ä¸€é”®æˆ–è€… golang å‡½æ•°å†…é‡‡é›†æŒ‡å®šå‚æ•°è½¬ svg ï¼Œä½†æ˜¯è¿™å—åŠŸèƒ½ç›®å‰è¿˜æ²¡é•¿æœŸå®šå‹ä¸‹æ¥ï¼Œæš‚æ—¶è¿˜æ˜¯æœ€å°çš„ <code>pprof + dot</code></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸ä¾èµ– go ï¼Œæœ€å°äºŒè¿›åˆ¶æŠŠ pprof è½¬ svg çš„æ¢ç´¢&lt;/p&gt;</summary>
    
    
    
    
    <category term="golang" scheme="http://zhangguanzhang.github.io/tags/golang/"/>
    
    <category term="pprof" scheme="http://zhangguanzhang.github.io/tags/pprof/"/>
    
  </entry>
  
  <entry>
    <title>cri-dockerd æ— æ³•æ‹‰å–éœ€è®¤è¯ä»“åº“ä¸Šçš„ pause é•œåƒè§£å†³</title>
    <link href="http://zhangguanzhang.github.io/2024/04/11/cri-docker-sandbox-image/"/>
    <id>http://zhangguanzhang.github.io/2024/04/11/cri-docker-sandbox-image/</id>
    <published>2024-04-11T16:05:30.000Z</published>
    <updated>2024-04-11T16:05:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç§æœ‰åŒ–ä¸‹ï¼Œcri-dockerd Pulling the image without credentials. Image: reg.xxx.lan:5000&#x2F;xxx&#x2F;pause:3.9</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ç§æœ‰åŒ–ä¸‹ï¼Œç¯å¢ƒéƒ½ä¼šéƒ¨ç½²ä¸€ä¸ªå†…ç½‘ä»“åº“é•œåƒï¼Œç„¶åå‘ç°æŸå¤©å®¢æˆ·ç¯å¢ƒçš„ pod æ— æ³•æ‹‰èµ·æ¥ï¼Œå‘ç°æ˜¯é•œåƒ gc åï¼Œcri-dockerd çš„ pause é•œåƒæ— æ³•æ‹‰å–äº†ï¼Œæ‰‹åŠ¨æ‹‰å–æ²¡é—®é¢˜çš„ã€‚</p><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><p>ä¹‹å‰é‡åˆ°è¿‡ï¼Œä½†æ˜¯å½“æ—¶æ¯”è¾ƒå¿™ï¼Œä»Šå¤©æœ‰ç©ºçœ‹ä¸‹ã€‚</p><h3 id="ä¿¡æ¯"><a href="#ä¿¡æ¯" class="headerlink" title="ä¿¡æ¯"></a>ä¿¡æ¯</h3><p>cri-dockerd ç‰ˆæœ¬æ— å…³ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ä½¿ç”¨ systemd éƒ¨ç½²ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl <span class="built_in">cat</span> --no-pager cri-dockerd</span></span><br><span class="line">...</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/data/kube/bin/cri-dockerd \</span><br><span class="line">    --container-runtime-endpoint unix:///var/run/cri-dockerd.sock \</span><br><span class="line">    --network-plugin=cni \</span><br><span class="line">    --streaming-bind-addr=127.0.0.1 \</span><br><span class="line">    --cni-bin-dir=/data/kube/bin/ \</span><br><span class="line">    --pod-infra-container-image=reg.xxx.lan:5000/xxx/pause:3.9</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ä¿¡æ¯ä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xe -u cri-dockerd</span></span><br><span class="line">Apr 11 15:11:48 xxx cri-dockerd[5894]: level=info msg=&quot;Pulling the image without credentials. Image: reg.xxx.lan:5000/xxx/pause:3.9&quot;</span><br><span class="line">Apr 11 15:12:14 xxx cri-dockerd[5894]: level=info msg=&quot;Pulling the image without credentials. Image: reg.xxx.lan:5000/xxx/pause:3.9&quot;</span><br><span class="line">Apr 11 15:13:11 xxx cri-dockerd[5894]: level=info msg=&quot;Pulling the image without credentials. Image: reg.xxx.lan:5000/xxx/pause:3.9&quot;</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹æºç é€»è¾‘"><a href="#æŸ¥çœ‹æºç é€»è¾‘" class="headerlink" title="æŸ¥çœ‹æºç é€»è¾‘"></a>æŸ¥çœ‹æºç é€»è¾‘</h3><p>æ ¹æ®æ—¥å¿—å…³é”®å­—ï¼Œæ‰¾åˆ°æ˜¯å¦‚ä¸‹å‡½æ•°</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/Mirantis/cri-dockerd/blob/b138f5226ae901b99ea34d40ab1eaed1c26445a4/core/sandbox_helpers.go#L408-L448</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ensureSandboxImageExists</span><span class="params">(client libdocker.DockerClientInterface, image <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">_, err := client.InspectImageByRef(image)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !libdocker.IsImageNotFoundError(err) &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to inspect sandbox image %q: %v&quot;</span>, image, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repoToPull, _, _, err := utils.ParseImageName(image)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">keyring := credentialprovider.NewDockerKeyring()</span><br><span class="line">creds, withCredentials := keyring.Lookup(repoToPull)</span><br><span class="line"><span class="keyword">if</span> !withCredentials &#123;</span><br><span class="line">logrus.Infof(<span class="string">&quot;Pulling the image without credentials. Image: %v&quot;</span>, image)</span><br><span class="line"></span><br><span class="line">err := client.PullImage(image, dockerregistry.AuthConfig&#123;&#125;, dockertypes.ImagePullOptions&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed pulling image %q: %v&quot;</span>, image, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pullErrs []<span class="type">error</span></span><br><span class="line"><span class="keyword">for</span> _, currentCreds := <span class="keyword">range</span> creds &#123;</span><br><span class="line">authConfig := dockerregistry.AuthConfig(currentCreds)</span><br><span class="line">err := client.PullImage(image, authConfig, dockertypes.ImagePullOptions&#123;&#125;)</span><br><span class="line"><span class="comment">// If there was no error, return success</span></span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pullErrs = <span class="built_in">append</span>(pullErrs, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> errors.NewAggregate(pullErrs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ <code>credentialprovider.NewDockerKeyring()</code> å¾€ä¸‹æ‰¾ï¼Œå‘ç°æœ€ç»ˆæ˜¯åœ¨ <code>./vendor/k8s.io/kubernetes/pkg/credentialprovider/</code> ä¸‹çš„é€»è¾‘ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/Mirantis/cri-dockerd/blob/b138f5226ae901b99ea34d40ab1eaed1c26445a4/vendor/k8s.io/kubernetes/pkg/credentialprovider/provider.go#L46-L 52</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">RegisterCredentialProvider(<span class="string">&quot;.dockercfg&quot;</span>,</span><br><span class="line">&amp;CachingDockerConfigProvider&#123;</span><br><span class="line">Provider: &amp;defaultDockerConfigProvider&#123;&#125;,</span><br><span class="line">Lifetime: <span class="number">5</span> * time.Minute,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ <code>CachingDockerConfigProvider</code> æ˜¯å®šä¹‰ä¸€ä¸ªé—´éš”æ—¶é—´è¯»å–æ–‡ä»¶çš„ providerï¼Œè¯»å–æ–‡ä»¶çš„é€»è¾‘åœ¨ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/Mirantis/cri-dockerd/blob/b138f5226ae901b99ea34d40ab1eaed1c26445a4/vendor/k8s.io/kubernetes/pkg/credentialprovider/provider.go#L77C1-L85C2</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *defaultDockerConfigProvider)</span></span> Provide(image <span class="type">string</span>) DockerConfig &#123;</span><br><span class="line"><span class="comment">// Read the standard Docker credentials from .dockercfg</span></span><br><span class="line"><span class="keyword">if</span> cfg, err := ReadDockerConfigFile(); err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> cfg</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> !os.IsNotExist(err) &#123;</span><br><span class="line">klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;Docker config file not found: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> DockerConfig&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€è·¯è·³è½¬ï¼Œåˆ°æ–‡ä»¶ <code>./vendor/k8s.io/kubernetes/pkg/credentialprovider/config.go</code> é‡Œçš„ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">preferredPathLock sync.Mutex</span><br><span class="line">preferredPath     = <span class="string">&quot;&quot;</span></span><br><span class="line">workingDirPath    = <span class="string">&quot;&quot;</span></span><br><span class="line">homeDirPath, _    = os.UserHomeDir()</span><br><span class="line">rootDirPath       = <span class="string">&quot;/&quot;</span></span><br><span class="line">homeJSONDirPath   = filepath.Join(homeDirPath, <span class="string">&quot;.docker&quot;</span>)</span><br><span class="line">rootJSONDirPath   = filepath.Join(rootDirPath, <span class="string">&quot;.docker&quot;</span>)</span><br><span class="line"></span><br><span class="line">configFileName     = <span class="string">&quot;.dockercfg&quot;</span></span><br><span class="line">configJSONFileName = <span class="string">&quot;config.json&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DefaultDockercfgPaths</span><span class="params">()</span></span> []<span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">string</span>&#123;GetPreferredDockercfgPath(), workingDirPath, homeDirPath, rootDirPath&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadDockercfgFile</span><span class="params">(searchPaths []<span class="type">string</span>)</span></span> (cfg DockerConfig, err <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(searchPaths) == <span class="number">0</span> &#123;</span><br><span class="line">searchPaths = DefaultDockercfgPaths()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, configPath := <span class="keyword">range</span> searchPaths &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾ç›®å½•é€»è¾‘ä¹Ÿæ²¡é—®é¢˜ï¼Œcri-dockerd æ˜¯ root è¿è¡Œçš„ï¼Œ<code>/root/.docker/config.json</code> é‡Œæœ‰çš„ï¼Œä¹Ÿæ²¡å…¶ä»–ç‰¹æ®Šæƒé™å•¥çš„ã€‚</p><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>æ‰‹åŠ¨æ‹‰å–æ²¡é—®é¢˜çš„ï¼Œæ‰€ä»¥ä¸»è¦é€»è¾‘æ˜¯ä¸ºå•¥è¿›ç¨‹æ²¡è¯»å–åˆ° <code>/root/.docker/config.json</code>ï¼Œç„¶åä¸‹è½½æºç å dlv è°ƒè¯•ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl stop cri-docker kubelet</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker rmi -f reg.xxx.lan:5000/xxx/pause:3.9</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">reboot</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¢å¤æ²¡æœ‰æ‹‰å–çš„ç¯å¢ƒæƒ…å†µå† debug</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dlv <span class="built_in">exec</span> main.go -- --container-runtime-endpoint unix:///var/run/cri-dockerd.sock \</span></span><br><span class="line"><span class="language-bash">    --network-plugin=cni \</span></span><br><span class="line"><span class="language-bash">    --streaming-bind-addr=127.0.0.1 \</span></span><br><span class="line"><span class="language-bash">    --cni-bin-dir=/data/kube/bin/ \</span></span><br><span class="line"><span class="language-bash">    --pod-infra-container-image=reg.xxx.lan:5000/xxx/pause:3.9</span></span><br></pre></td></tr></table></figure><p>æœ€åå‘ç°ä»£ç é€»è¾‘æ²¡èµ°åˆ° <code>if !withCredentials &#123;</code> ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œç„¶åè‡ªå·±ç¼–è¯‘ä¸€ä¸ªæ›¿æ¢å¯åŠ¨åå‘ç°ä¹Ÿèƒ½å¤ç°ï¼Œå°±æ‰“ç®— dlv attach çœ‹ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go build  -gcflags=<span class="string">&quot;all=-N -l&quot;</span>  -o cri-dockerd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl stop cri-dockerd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">\<span class="built_in">cp</span> cri-dockerd /data/kube/bin/cri-dockerd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl start cri-dockerd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dlv attach $(pgrep cri-dockerd)</span></span><br></pre></td></tr></table></figure><p>æ‰“äº†ä¸‰ä¸ªæ–­ç‚¹å continue ï¼Œå‘ç° <code>DefaultDockercfgPaths()</code> è¿”å›çš„å››ä¸ªæŸ¥æ‰¾è·¯å¾„å€¼ä¸å¯¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(dlv) c</span><br><span class="line">&gt; k8s.io/kubernetes/pkg/credentialprovider.ReadDockerConfigJSONFile() ./vendor/k8s.io/kubernetes/pkg/credentialprovider/config.go:138 (hits goroutine(677):1 total:1) (PC: 0x2285942)</span><br><span class="line">   133:// if searchPaths is empty, the default paths are used.</span><br><span class="line">   134:func ReadDockerConfigJSONFile(searchPaths []string) (cfg DockerConfig, err error) &#123;</span><br><span class="line">   135:if len(searchPaths) == 0 &#123;</span><br><span class="line">   136:searchPaths = DefaultDockerConfigJSONPaths()</span><br><span class="line">   137:&#125;</span><br><span class="line">=&gt; 138:for _, configPath := range searchPaths &#123;</span><br><span class="line">   139:absDockerConfigFileLocation, err := filepath.Abs(filepath.Join(configPath, configJSONFileName))</span><br><span class="line">   140:if err != nil &#123;</span><br><span class="line">   141:klog.Errorf(&quot;while trying to canonicalize %s: %v&quot;, configPath, err)</span><br><span class="line">   142:continue</span><br><span class="line">   143:&#125;</span><br><span class="line">(dlv) p searchPaths</span><br><span class="line">[]string len: 4, cap: 4, [</span><br><span class="line">&quot;&quot;,</span><br><span class="line">&quot;&quot;,</span><br><span class="line">&quot;.docker&quot;,</span><br><span class="line">&quot;/.docker&quot;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹ <code>homeJSONDirPath</code> å‘ç°ä¹Ÿä¸å¯¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(dlv) p homeJSONDirPath</span><br><span class="line">&quot;.docker&quot;</span><br></pre></td></tr></table></figure><p>ä»£ç é‡Œå®ƒçš„å€¼æ¥æºæ˜¯ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">homeDirPath, _    = os.UserHomeDir()</span><br><span class="line"> ...</span><br><span class="line">homeJSONDirPath   = filepath.Join(homeDirPath, <span class="string">&quot;.docker&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è°ƒç”¨ä¸‹ <code>os.UserHomeDir()</code> çœ‹çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(dlv) call os.UserHomeDir()</span><br><span class="line">&gt; k8s.io/kubernetes/pkg/credentialprovider.ReadDockerConfigJSONFile() ./vendor/k8s.io/kubernetes/pkg/credentialprovider/config.go:138 (PC: 0x2285942)</span><br><span class="line">Values returned:</span><br><span class="line">~r0: &quot;&quot;</span><br><span class="line">~r1: error(*errors.errorString) *&#123;</span><br><span class="line">s: &quot;$HOME is not defined&quot;,&#125;</span><br></pre></td></tr></table></figure><p>å±…ç„¶æ²¡æœ‰ <code>HOME</code> å˜é‡ï¼Œä» procfs çœ‹çœ‹å¯åŠ¨æ—¶å€™çš„ envï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">xargs -0 -n1 &lt; /proc/$(pgrep cri-dockerd)/environ</span></span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br><span class="line">NOTIFY_SOCKET=/run/systemd/notify</span><br><span class="line">LISTEN_PID=5894</span><br><span class="line">LISTEN_FDS=1</span><br></pre></td></tr></table></figure><p>çœ‹æ¥ systemd æ²¡æœ‰ç»™é…ç½® <code>$HOME</code> å˜é‡ï¼Œç„¶åå‘ç°è®¾ç½®äº† <code>User</code> æ‰æœ‰ <code>HOME=/root</code> ç¯å¢ƒå˜é‡ï¼Œè¿™ä¹Ÿè¯´æ˜ä¹‹å‰ <code>dlv exec</code> æ­£å¸¸çš„åŸå› ã€‚</p><h2 id="è§£å†³-1"><a href="#è§£å†³-1" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><p>å‡ ç§è§£å†³æ–¹æ³•ï¼š</p><ul><li>systemd æ–‡ä»¶é‡Œè®¾ç½® <code>WorkingDirectory</code> ä¸‹:<ul><li>ç›´æ¥è®¾ç½®ä¸º <code>/root</code></li><li>æ‹·è´ä¸€ä¸ª docker login çš„ config.json æ–‡ä»¶åˆ°è¿›ç¨‹ <code>WorkingDirectory</code> ä¸‹: <code>config.json</code> æˆ–è€… <code>.dockercfg</code></li></ul></li><li>è®¾ç½® <code>User=root</code></li></ul><p>å·²æäº¤ pr ä¿®å¤ <a href="https://github.com/Mirantis/cri-dockerd/pull/349">Mirantis&#x2F;cri-dockerd&#x2F;pull&#x2F;349</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç§æœ‰åŒ–ä¸‹ï¼Œcri-dockerd Pulling the image without credentials. Image: reg.xxx.lan:5000&amp;#x2F;xxx&amp;#x2F;pause:3.9&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="cri-dockerd" scheme="http://zhangguanzhang.github.io/tags/cri-dockerd/"/>
    
  </entry>
  
  <entry>
    <title>docker å’Œ k8s ä½¿ç”¨ gpu ç¬”è®°</title>
    <link href="http://zhangguanzhang.github.io/2024/04/08/nvidia-container-toolkit/"/>
    <id>http://zhangguanzhang.github.io/2024/04/08/nvidia-container-toolkit/</id>
    <published>2024-04-08T15:05:30.000Z</published>
    <updated>2024-04-08T15:05:30.000Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸‹ docker k8s ä½¿ç”¨ gpu çš„ç¬”è®°</p><span id="more"></span><h2 id="ç”±æ¥"><a href="#ç”±æ¥" class="headerlink" title="ç”±æ¥"></a>ç”±æ¥</h2><p>ç½‘ä¸Š nvidia-container-toolkit ä¸€äº›æ–‡æ¡£çš„æ—¶æ•ˆæ€§ï¼Œè€Œä¸”ä¸»è¦æ˜¯ç§æœ‰åŒ–ã€ç¦»çº¿å’Œå°ç™½è§’åº¦ä¸‹çš„ç¬”è®°</p><h2 id="å®‰è£…-nvidia-GPU-é©±åŠ¨"><a href="#å®‰è£…-nvidia-GPU-é©±åŠ¨" class="headerlink" title="å®‰è£… nvidia GPU é©±åŠ¨"></a>å®‰è£… nvidia GPU é©±åŠ¨</h2><p>è¿™ä¸ªæ–‡ç«  <a href="https://developer.nvidia.com/zh-cn/blog/nvidia-gpu-operator-simplifying-gpu-management-in-kubernetes/">nvidia-gpu-operator-simplifying-gpu-management-in-kubernetes</a> æœ‰è¯´ä½¿ç”¨ nvidia gpu operator æ¥éƒ¨ç½²ï¼Œä¸éœ€è¦åœ¨å®¿ä¸»æœºä¸Šå®‰è£…é©±åŠ¨ï¼Œä½†æ˜¯çœ‹æ–‡æ¡£ <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/platform-support.html#supported-nvidia-data-center-gpus-and-systems">supported-nvidia-data-center-gpus-and-systems</a> æ²¡æœ‰ RTX 4090 æ”¯æŒã€‚æ‰€ä»¥å¤§å®¶å¸¸è§„éƒ½æ˜¯ä½¿ç”¨ nvidia-container-toolkit æ–¹æ¡ˆçš„ <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html">å®˜æ–¹æ–‡æ¡£</a> çš„ç»“æ„ï¼š</p><p><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html"><img src="https://cloud.githubusercontent.com/assets/3028125/12213714/5b208976-b632-11e5-8406-38d379ec46aa.png" alt="nvidia-container-toolkit"></a></p><p>å¯¹äº NVIDIA GPU Operator æ„Ÿå…´è¶£ç›´æ¥çœ‹ <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/index.html">NVIDIA GPU Operator å®˜æ–¹æ–‡æ¡£</a></p><h3 id="ç³»ç»Ÿå‰ç½®é…ç½®"><a href="#ç³»ç»Ÿå‰ç½®é…ç½®" class="headerlink" title="ç³»ç»Ÿå‰ç½®é…ç½®"></a>ç³»ç»Ÿå‰ç½®é…ç½®</h3><p>æ¨è ubuntu 22.04 éƒ¨ç½²ï¼Œå…·ä½“æ”¯æŒçš„ç³»ç»Ÿçœ‹ <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/1.14.5/supported-platforms.html">å®˜æ–¹æ–‡æ¡£ supported-platforms</a>  å…ˆç¡®è®¤ç³»ç»Ÿå±‚é¢è¯†åˆ«åˆ°æ˜¾å¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ lspci | grep -i nvidia</span><br><span class="line">1b:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">1b:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br><span class="line">1e:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">1e:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br><span class="line">22:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">22:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br><span class="line">23:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">23:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br><span class="line">4f:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">4f:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br><span class="line">52:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">52:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br><span class="line">56:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">56:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br><span class="line">57:00.0 VGA compatible controller: NVIDIA Corporation Device 2684 (rev a1)</span><br><span class="line">57:00.1 Audio device: NVIDIA Corporation Device 22ba (rev a1)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ 2684 å¯ä»¥è¿›å…¥ <a href="https://admin.pci-ids.ucw.cz/mods/PC/10de?action=help?help=pci">PCI Devices</a> ä¸‹é¢è¾“å…¥ 2684 ç‚¹å‡» jump ä¼šæ˜¾ç¤ºå¯¹åº”çš„å¡åã€‚æˆ–è€…è®© lspci çš„ä¿¡æ¯æ›´æ–°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ update-pciids</span><br><span class="line">$ lspci | grep -i nvidia</span><br><span class="line">1b:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">1b:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br><span class="line">1e:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">1e:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br><span class="line">22:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">22:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br><span class="line">23:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">23:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br><span class="line">4f:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">4f:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br><span class="line">52:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">52:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br><span class="line">56:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">56:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br><span class="line">57:00.0 VGA compatible controller: NVIDIA Corporation AD102 [GeForce RTX 4090] (rev a1)</span><br><span class="line">57:00.1 Audio device: NVIDIA Corporation AD102 High Definition Audio Controller (rev a1)</span><br></pre></td></tr></table></figure><p>ç¦ç”¨ nouveau ï¼Œå®ƒæ˜¯ç¬¬ä¸‰æ–¹ä¸º NVIDIA æ˜¾å¡å¼€å‘çš„é©±åŠ¨ï¼Œæ²¡å¾—åˆ°å®˜æ–¹çš„è®¤å¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/modprobe.d/blacklist-nouveau.conf &lt;&lt; EOF</span><br><span class="line">blacklist nouveau</span><br><span class="line">options nouveau modeset=0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>å…³é—­åŒ…æ›´æ–°ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å’Œæˆ‘åŒäº‹ä¸€æ ·ï¼Œå®‰è£…å¥½é©±åŠ¨åï¼Œè¢«è‡ªåŠ¨æ›´æ–°äº†ä¸€äº›åŒ…ï¼Œå¯¼è‡´ cuda toolkit æ— æ³•ä½¿ç”¨çš„æƒ…å†µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;/Update-Package-Lists/s#1#0#&#x27; /etc/apt/apt.conf.d/10periodic</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶ <code>/etc/apt/apt.conf.d/50unattended-upgrades</code> é‡Œæ˜¯åœ¨ç³»ç»Ÿè‡ªåŠ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œä¸æ›´æ–°çš„åˆ—è¡¨ï¼Œä¾‹å¦‚æœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Unattended-Upgrade::Package-Blacklist &#123;</span><br><span class="line">    // The following matches all packages starting with linux-</span><br><span class="line">//  &quot;linux-&quot;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æŠŠ <code>linux-</code> å‰é¢çš„ <code>//</code> å–æ¶ˆäº†ï¼Œå› ä¸ºé—­æºæ˜¾å¡é©±åŠ¨å’Œå†…æ ¸ç‰ˆæœ¬æŒ‚é’©çš„ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å‡çº§ <code>linux-image-*</code> å’Œ <code>linux-headers-*</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;\@^//\s+&quot;linux-&quot;@s#^//##&#x27; /etc/apt/apt.conf.d/50unattended-upgrades</span><br></pre></td></tr></table></figure><p>æ›´æ–° initramfs å¹¶é‡å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># apt ç³»åˆ—ç³»ç»Ÿ</span><br><span class="line">update-initramfs -u</span><br><span class="line"># centos ç³»ç»Ÿ</span><br><span class="line">mv /boot/initramfs-$(uname -r).img&#123;,.bak&#125;</span><br><span class="line">dracut /boot/initramfs-$(uname -r).img $(uname -r)</span><br><span class="line"></span><br><span class="line">é‡å¯</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"># è®°å¾—éªŒè¯ä¸åŒ…å« nouveau</span><br><span class="line">lsmod | grep nouveau</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…é©±åŠ¨"><a href="#å®‰è£…é©±åŠ¨" class="headerlink" title="å®‰è£…é©±åŠ¨"></a>å®‰è£…é©±åŠ¨</h3><h4 id="ä¸ä½¿ç”¨-apt-å®‰è£…"><a href="#ä¸ä½¿ç”¨-apt-å®‰è£…" class="headerlink" title="ä¸ä½¿ç”¨ apt å®‰è£…"></a>ä¸ä½¿ç”¨ apt å®‰è£…</h4><ul><li><a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/platform-support.html#gpu-operator-component-matrix">gpu operator æ–‡æ¡£</a></li><li><a href="https://docs.nvidia.com/datacenter/tesla/drivers/index.html#cuda-drivers">cuda-drivers å’Œ cuda workdlow</a></li></ul><p>ä»ä¸Šé¢é¢ä¿©æ–‡æ¡£ï¼ˆä¸»è¦æ˜¯ç¬¬äºŒä¸ªæ–‡æ¡£ï¼‰çš„è¡¨æ ¼å¾—åˆ°ä¿¡æ¯ï¼š</p><table><thead><tr><th></th><th>R470</th><th>R535</th><th>R550</th></tr></thead><tbody><tr><td>Branch Designation</td><td>Long Term Support Branch</td><td>Long Term Support Branch</td><td>Production Branch</td></tr><tr><td>EOL æ—¶é—´</td><td>July 2024</td><td>June 2026</td><td>February 2025</td></tr><tr><td>æœ€å° CUDA ç‰ˆæœ¬æ”¯æŒ</td><td>CUDA 11.0+</td><td>CUDA 12.0+</td><td>CUDA 12.0+</td></tr></tbody></table><p>æ‰€ä»¥é©±åŠ¨é¦–é€‰ 535 ï¼Œ <a href="https://www.nvidia.com/Download/Find.aspx">å®˜ç½‘é©±åŠ¨æœç´¢é¡µé¢</a> ï¼Œæˆ‘è¿™é‡Œé€‰çš„éç¬”è®°æœ¬ 4090 ç‚¹å‡» search é€‰æ‹©åé€‰æ‹© 535 ä¸‹è½½ï¼Œå…¶ä»–å¡æ ¹æ®é€‰é¡¹é€‰æ‹©ï¼Œä¾‹å¦‚ä¸‹é¢ï¼š</p><ul><li>GeForce RTX 4090: <code>Type=GeForce</code> <code>Series=GeForce RTX 40 Series</code> <code>NVIDIA GeForce RTX 4090</code></li><li>A10: <code>Type=Data Center / Tesla</code>  <code>Series=A-Series</code> <code>NVIDIA A10</code></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget https://us.download.nvidia.com/tesla/535.161.08/NVIDIA-Linux-x86_64-535.161.08.run</span><br><span class="line">chmod a+x NVIDIA-Linux-x86_64-535.161.08.run</span><br><span class="line"></span><br><span class="line"># ç¡®ä¿æœ‰ gcc å’Œ linux-kernel-headers å’Œä¸€äº›ä¾èµ– </span><br><span class="line">apt install -y \</span><br><span class="line">  gcc linux-kernel-headers \</span><br><span class="line">  pkg-config libvulkan1</span><br><span class="line"></span><br><span class="line">./NVIDIA-Linux-x86_64-535.161.08.run</span><br><span class="line"># å®‰è£…æ—¥å¿—åœ¨ /var/log/nvidia-installer.log</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h4 id="apt-å®‰è£…æ–¹å¼"><a href="#apt-å®‰è£…æ–¹å¼" class="headerlink" title="apt å®‰è£…æ–¹å¼"></a>apt å®‰è£…æ–¹å¼</h4><p>å‚è€ƒ ubuntu å®˜æ–¹æ–‡æ¡£ <a href="https://ubuntu.com/server/docs/nvidia-drivers-installation">nvidia-drivers-installation</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install -y ubuntu-drivers-common</span><br></pre></td></tr></table></figure><p>ç„¶åæŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ¥ï¼Œè€Œä¸”ä¼šæ·»åŠ ä¸€ä¸ª <code>nvidia-detector</code> å‘½ä»¤ï¼Œæ‰§è¡Œä¼šæ¨èä½ å®‰è£…çš„ç‰ˆæœ¬ã€‚</p><h4 id="æŸ¥çœ‹æ˜¾å¡é©±åŠ¨ä¿¡æ¯"><a href="#æŸ¥çœ‹æ˜¾å¡é©±åŠ¨ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹æ˜¾å¡é©±åŠ¨ä¿¡æ¯"></a>æŸ¥çœ‹æ˜¾å¡é©±åŠ¨ä¿¡æ¯</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ nvidia-smi</span><br><span class="line">Mon Apr  8 18:48:39 2024       </span><br><span class="line">+---------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 535.113.01             Driver Version: 535.113.01   CUDA Version: 12.2     |</span><br><span class="line">|-----------------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                      |               MIG M. |</span><br><span class="line">|=========================================+======================+======================|</span><br><span class="line">|   0  NVIDIA GeForce RTX 4090        Off | 00000000:1B:00.0 Off |                  Off |</span><br><span class="line">| 31%   25C    P8              12W / 450W |   6112MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line">|   1  NVIDIA GeForce RTX 4090        Off | 00000000:1E:00.0 Off |                  Off |</span><br><span class="line">| 31%   26C    P8               6W / 450W |  17876MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line">|   2  NVIDIA GeForce RTX 4090        Off | 00000000:22:00.0 Off |                  Off |</span><br><span class="line">| 30%   28C    P8              15W / 450W |   4248MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line">|   3  NVIDIA GeForce RTX 4090        Off | 00000000:23:00.0 Off |                  Off |</span><br><span class="line">| 31%   28C    P8               5W / 450W |   4246MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line">|   4  NVIDIA GeForce RTX 4090        Off | 00000000:4F:00.0 Off |                  Off |</span><br><span class="line">| 31%   25C    P8              16W / 450W |   4246MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line">|   5  NVIDIA GeForce RTX 4090        Off | 00000000:52:00.0 Off |                  Off |</span><br><span class="line">| 30%   26C    P8              12W / 450W |   4246MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line">|   6  NVIDIA GeForce RTX 4090        Off | 00000000:56:00.0 Off |                  Off |</span><br><span class="line">| 30%   27C    P8               5W / 450W |  21974MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line">|   7  NVIDIA GeForce RTX 4090        Off | 00000000:57:00.0 Off |                  Off |</span><br><span class="line">| 31%   28C    P8              12W / 450W |  16220MiB / 24564MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line"># è¿™ä¸ªè·¯å¾„ä¹Ÿå¯ä»¥æŸ¥çœ‹é©±åŠ¨ï¼Œå¯ä»¥åšä¸€äº›è„šæœ¬åˆ¤æ–­é€»è¾‘</span><br><span class="line">$ cat /proc/driver/nvidia/version</span><br><span class="line">NVRM version: NVIDIA UNIX x86_64 Kernel Module  535.113.01  Tue Sep 12 19:41:24 UTC 2023</span><br><span class="line">GCC version:  gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)</span><br></pre></td></tr></table></figure><p>å³ä¸Šè§’çš„ cuda version æ˜¯ cuda user-mode driverçš„ç‰ˆæœ¬ï¼Œå®ƒæ˜¯è·Ÿéš driver å®‰è£…çš„ï¼Œå’Œ cuda toolkit æ²¡å¼ºå…³è”ï¼Œè€Œåç»­å¼€å‘ä½¿ç”¨åˆ°çš„ cuda toolkit ç‰ˆæœ¬å¯ä»¥è‡ªå·±æŸ¥çœ‹ <code>nvcc -V</code></p><h2 id="cuda-toolkit"><a href="#cuda-toolkit" class="headerlink" title="cuda toolkit"></a>cuda toolkit</h2><p>å®¿ä¸»æœºä¸Šæœ‰éœ€æ±‚å¯ä»¥è‡ªè¡Œå®‰è£…ä¸‹ï¼Œå¯èƒ½æœªæ¥è¿™å—ä¼šæ›´æ–°åŠ ä¸Šå®‰è£…æ­¥éª¤</p><h2 id="nvidia-container-toolkit"><a href="#nvidia-container-toolkit" class="headerlink" title="nvidia-container-toolkit"></a>nvidia-container-toolkit</h2><h3 id="å®‰è£…-ctk"><a href="#å®‰è£…-ctk" class="headerlink" title="å®‰è£… ctk"></a>å®‰è£… ctk</h3><p>æˆªè‡³ 2024&#x2F;04&#x2F;08 ï¼Œnvidia-container-runtime å·²ç»åºŸå¼ƒäº†ï¼Œç°åœ¨å« nvidia-container-toolkit å¹¶ä¸”å®˜æ–¹æ–‡æ¡£åˆ‡åˆ°ä¸‹é¢ï¼š</p><ul><li><a href="https://docs.nvidia.com/datacenter/cloud-native/#overview">https://docs.nvidia.com/datacenter/cloud-native/#overview</a></li><li><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html</a></li></ul><p><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html">å®˜æ–¹å®‰è£…æ–‡æ¡£</a></p><p>æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ·»åŠ æºåå®‰è£… <code>nvidia-container-toolkit</code>ï¼Œä¼šé™„å¸¦å®‰è£…äº†ä¸‰ä¸ªåŒ…ï¼Œå››ä¸ªåŒ…çš„ä¿¡æ¯ä¸ºï¼š</p><table><thead><tr><th></th><th>æ–‡ä»¶åˆ—è¡¨</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>libnvidia-container1</code></td><td>so åŠ¨æ€é“¾æ¥åº“ï¼Œc å’Œ go çš„ so æ–‡ä»¶</td><td>ä¾‹å¦‚ç»™ä¸‹é¢çš„äºŒè¿›åˆ¶ä½¿ç”¨ï¼Œä¸‹é¢ä¾èµ–å®ƒï¼Œæ›´æ–°å®ƒå¯ä»¥å‘å‰å…¼å®¹</td></tr><tr><td><code>libnvidia-container-tools</code></td><td><code>/usr/bin/nvidia-container-cli</code></td><td></td></tr><tr><td><code>nvidia-container-toolkit-base</code></td><td><li><code>nvidia-container-runtime</code> ä¹‹å‰åŒ…å runtime äºŒè¿›åˆ¶å’Œå®ƒçš„é…ç½®æ–‡ä»¶ <li><code>nvidia-ctk</code> NVIDIA Container Toolkit å·¥å…·ï¼Œå®ƒçš„ runtime å¯ä»¥å­å‘½ä»¤å¯ä»¥ä»£æ›¿äººä¸ºç¼–è¾‘ container runtime çš„é…ç½®æ–‡ä»¶</td><td></td></tr><tr><td><code>nvidia-container-toolkit</code></td><td><li><code>nvidia-container-runtime-hook</code> äºŒè¿›åˆ¶</td><td></td></tr></tbody></table><p>ä¾èµ–å…³ç³»å¦‚ä¸‹ï¼Œversion æ˜¯æŒ‡ NVIDIA Container Toolkit ç‰ˆæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€ nvidia-container-toolkit (version)</span><br><span class="line">â”‚    â”œâ”€ libnvidia-container-tools (&gt;= version)</span><br><span class="line">â”‚    â””â”€ nvidia-container-toolkit-base (version)</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€ libnvidia-container-tools (version)</span><br><span class="line">â”‚    â””â”€ libnvidia-container1 (&gt;= version)</span><br><span class="line">â””â”€ libnvidia-container1 (version)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£çš„å›¾ï¼Œå®ƒæ˜¯å¦‚ä½•å’Œ docker å·¥ä½œçš„ï¼Œç‚¹å‡»å›¾ç‰‡ä¹Ÿå¯ä»¥è·³è½¬ä¸Šé¢åŒ…ä»‹ç»ä¿¡æ¯ï¼š</p><p><a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/arch-overview.html"><img src="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/_images/runtime-architecture.png" alt="runtime-architecture"></a></p><details><summary>ç‚¹å‡»å±•å¼€ ubuntu22.04 ä¸Š deb åŒ…å†…æ–‡ä»¶å†…å®¹</summary><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg -L libnvidia-container1</span><br><span class="line">/.</span><br><span class="line">/usr</span><br><span class="line">/usr/lib</span><br><span class="line">/usr/lib/x86_64-linux-gnu</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libnvidia-container-go.so.1.13.5</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libnvidia-container.so.1.13.5</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/libnvidia-container1</span><br><span class="line">/usr/share/doc/libnvidia-container1/changelog.Debian.gz</span><br><span class="line">/usr/share/doc/libnvidia-container1/copyright</span><br><span class="line">/usr/share/lintian</span><br><span class="line">/usr/share/lintian/overrides</span><br><span class="line">/usr/share/lintian/overrides/libnvidia-container1</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libnvidia-container-go.so.1</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libnvidia-container.so.1</span><br><span class="line">$ dpkg -L libnvidia-container-tools</span><br><span class="line">/.</span><br><span class="line">/usr</span><br><span class="line">/usr/bin</span><br><span class="line">/usr/bin/nvidia-container-cli</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/libnvidia-container-tools</span><br><span class="line">/usr/share/doc/libnvidia-container-tools/changelog.Debian.gz</span><br><span class="line">/usr/share/doc/libnvidia-container-tools/copyright</span><br><span class="line">/usr/share/lintian</span><br><span class="line">/usr/share/lintian/overrides</span><br><span class="line">/usr/share/lintian/overrides/libnvidia-container-tools</span><br><span class="line"></span><br><span class="line">$ dpkg -L nvidia-container-toolkit-base</span><br><span class="line">/.</span><br><span class="line">/etc</span><br><span class="line">/etc/nvidia-container-runtime</span><br><span class="line">/etc/nvidia-container-runtime/config.toml</span><br><span class="line">/usr</span><br><span class="line">/usr/bin</span><br><span class="line">/usr/bin/nvidia-container-runtime</span><br><span class="line">/usr/bin/nvidia-ctk</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/nvidia-container-toolkit-base</span><br><span class="line">/usr/share/doc/nvidia-container-toolkit-base/changelog.Debian.gz</span><br><span class="line">/usr/share/doc/nvidia-container-toolkit-base/copyright</span><br><span class="line"></span><br><span class="line">$ dpkg -L nvidia-container-toolkit</span><br><span class="line">/.</span><br><span class="line">/usr</span><br><span class="line">/usr/bin</span><br><span class="line">/usr/bin/nvidia-container-runtime-hook</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/nvidia-container-toolkit</span><br><span class="line">/usr/share/doc/nvidia-container-toolkit/changelog.Debian.gz</span><br><span class="line">/usr/share/doc/nvidia-container-toolkit/copyright</span><br><span class="line">/usr/share/lintian</span><br><span class="line">/usr/share/lintian/overrides</span><br><span class="line">/usr/share/lintian/overrides/nvidia-container-toolkit</span><br></pre></td></tr></table></figure></details><details><summary>ç‚¹å‡»å±•å¼€ centos 7.9 ä¸Š rpm åŒ…å†…æ–‡ä»¶å†…å®¹</summary><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -ql libnvidia-container1</span><br><span class="line">/usr/lib64/libnvidia-container-go.so.1</span><br><span class="line">/usr/lib64/libnvidia-container-go.so.1.15.0</span><br><span class="line">/usr/lib64/libnvidia-container.so.1</span><br><span class="line">/usr/lib64/libnvidia-container.so.1.15.0</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/COPYING</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/COPYING.LESSER</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/LICENSE</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/NOTICE</span><br><span class="line">$ rpm -ql libnvidia-container-tools</span><br><span class="line">/usr/bin/nvidia-container-cli</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/COPYING</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/COPYING.LESSER</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/LICENSE</span><br><span class="line">/usr/share/licenses/libnvidia-container-1.15.0/NOTICE</span><br><span class="line">$ rpm -ql nvidia-container-toolkit-base</span><br><span class="line">/usr/bin/nvidia-container-runtime</span><br><span class="line">/usr/bin/nvidia-ctk</span><br><span class="line">/usr/share/licenses/nvidia-container-toolkit-base-1.15.0~rc.4</span><br><span class="line">/usr/share/licenses/nvidia-container-toolkit-base-1.15.0~rc.4/LICENSE</span><br><span class="line">$ rpm -ql nvidia-container-toolkit</span><br><span class="line">/usr/bin/nvidia-container-runtime-hook</span><br><span class="line">/usr/share/licenses/nvidia-container-toolkit-1.15.0~rc.4</span><br><span class="line">/usr/share/licenses/nvidia-container-toolkit-1.15.0~rc.4/LICENSE</span><br></pre></td></tr></table></figure></details><p>ç¦»çº¿çš„æºå’Œ deb åŒ…ä¸‹è½½éƒ½åœ¨ä¸‹é¢é“¾æ¥ä¸Š<br><a href="https://github.com/NVIDIA/libnvidia-container/tree/gh-pages">https://github.com/NVIDIA/libnvidia-container/tree/gh-pages</a></p><h3 id="é…ç½®-runtime"><a href="#é…ç½®-runtime" class="headerlink" title="é…ç½® runtime"></a>é…ç½® runtime</h3><p>å¢åŠ  runtime å¹¶è®¾ç½®ä¸ºé»˜è®¤çš„ runtime</p><h4 id="ä½¿ç”¨-nvidia-ctk-é…ç½®"><a href="#ä½¿ç”¨-nvidia-ctk-é…ç½®" class="headerlink" title="ä½¿ç”¨ nvidia-ctk é…ç½®"></a>ä½¿ç”¨ nvidia-ctk é…ç½®</h4><p>å®˜æ–¹æ¨èå‘½ä»¤é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker</span></span><br><span class="line">nvidia-ctk runtime configure --runtime=docker --config=/etc/docker/daemon.json</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">containerd</span></span><br><span class="line">nvidia-ctk runtime configure --runtime=containerd</span><br></pre></td></tr></table></figure><h4 id="æ‰‹åŠ¨é…ç½®"><a href="#æ‰‹åŠ¨é…ç½®" class="headerlink" title="æ‰‹åŠ¨é…ç½®"></a>æ‰‹åŠ¨é…ç½®</h4><p>ä¸»è¦æ˜¯è¿½åŠ  runtime å’Œé…ç½®æˆé»˜è®¤çš„ runtime</p><p>docker <code>vi /etc/docker/daemon.json</code> æ–‡ä»¶è¿½åŠ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;default-runtime&quot;: &quot;nvidia&quot;,</span><br><span class="line">&quot;runtimes&quot;: &#123;</span><br><span class="line">  &quot;nvidia&quot;: &#123;</span><br><span class="line">    &quot;path&quot;: &quot;/usr/bin/nvidia-container-runtime&quot;,</span><br><span class="line">    &quot;runtimeArgs&quot;: []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>containerd <code>vim /etc/containerd/config.toml</code> åœ¨ä¸ <code>plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes</code> ä¸­æ·»åŠ ï¼š:</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.nvidia]</span></span><br><span class="line">  <span class="attr">privileged_without_host_devices</span> = <span class="literal">false</span></span><br><span class="line">  <span class="attr">runtime_engine</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">runtime_root</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">runtime_type</span> = <span class="string">&quot;io.containerd.runc.v2&quot;</span></span><br><span class="line">  <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.nvidia.options]</span></span><br><span class="line">    <span class="attr">BinaryName</span> = <span class="string">&quot;/usr/bin/nvidia-container-runtime&quot;</span></span><br><span class="line">    <span class="attr">CriuImagePath</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">CriuPath</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">CriuWorkPath</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">IoGid</span> = <span class="number">0</span></span><br><span class="line">    <span class="attr">IoUid</span> = <span class="number">0</span></span><br><span class="line">    <span class="attr">NoNewKeyring</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">NoPivotRoot</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">Root</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">ShimCgroup</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">SystemdCgroup</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å°†é»˜è®¤çš„ runtime è®¾ç½®ä¸º nvidia</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span></span><br><span class="line">  <span class="attr">default_runtime_name</span> = <span class="string">&quot;nvidia&quot;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦é‡å¯ docker æˆ–è€… containerd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --gpus all nvidia/cuda:12.4.0-base-ubuntu22.04 nvidia-smi</span><br><span class="line">nerdctl run --rm --gpus all nvidia/cuda:12.4.0-base-ubuntu22.04 nvidia-smi</span><br></pre></td></tr></table></figure><p>é•œåƒ tag ä¿¡æ¯æ ¼å¼ä¸º <code>cuda ç‰ˆæœ¬-base/runtime/devel-os</code>ï¼Œcuda é©±åŠ¨ç‰ˆæœ¬å¯ä»¥ <code>nvidia-smi</code> æŸ¥çœ‹å³ä¸Šè§’</p><ul><li>base: åŒ…å« CUDA runtime (cudart)</li><li>runtime: FROM base æ·»åŠ  <a href="https://developer.nvidia.com/gpu-accelerated-libraries">CUDA math libraries</a> ã€ <a href="https://developer.nvidia.com/nccl">NCC</a> å’Œ <a href="https://developer.nvidia.com/cudnn">cuDNN</a></li><li>devel: FROM runtime æ·»åŠ  headers development tools</li></ul><p>é•œåƒæ›´å¤šä¿¡æ¯éƒ½æŸ¥çœ‹ <a href="https://hub.docker.com/r/nvidia/cuda">nvidia&#x2F;cuda</a></p><p>ä¸€äº›ä¿¡æ¯ï¼Œå½“ runtime ä¸º nvidia æ—¶å€™ï¼Œæœ‰å˜é‡å’Œæ²¡å˜é‡ï¼Œåœ¨ glibc çš„å®¹å™¨å†…ï¼Œä¼šæ–°å¢ä¸‹é¢å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm ubuntu sh -c &#x27;ls -l /usr/bin/nvidia*&#x27;</span><br><span class="line">ls: cannot access &#x27;/usr/bin/nvidia*&#x27;: No such file or directory</span><br><span class="line">$ docker run --runtime=nvidia -e NVIDIA_VISIBLE_DEVICES=all --rm ubuntu sh -c &#x27;ls -l /usr/bin/nvidia*&#x27;</span><br><span class="line">-rwxr-xr-x 1 root root  54208 Sep 29  2023 /usr/bin/nvidia-cuda-mps-control</span><br><span class="line">-rwxr-xr-x 1 root root  18664 Sep 29  2023 /usr/bin/nvidia-cuda-mps-server</span><br><span class="line">-rwxr-xr-x 1 root root 142064 Sep 29  2023 /usr/bin/nvidia-debugdump</span><br><span class="line">-rwxr-xr-x 1 root root 208352 Sep 29  2023 /usr/bin/nvidia-persistenced</span><br><span class="line">-rwxr-xr-x 1 root root 678160 Sep 29  2023 /usr/bin/nvidia-smi</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ç›¸å…³æ˜¯ä»£ç å®ç°çš„</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/NVIDIA/nvidia-container-toolkit/blob/cbc6ff73a48682604432ed04777894c4bf78005c/pkg/nvcdi/driver-nvml.go#L178</span></span><br><span class="line"><span class="comment">// NewDriverBinariesDiscoverer creates a discoverer for GSP firmware associated with the GPU driver.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDriverBinariesDiscoverer</span><span class="params">(logger logger.Interface, driverRoot <span class="type">string</span>)</span></span> discover.Discover &#123;</span><br><span class="line"><span class="keyword">return</span> discover.NewMounts(</span><br><span class="line">logger,</span><br><span class="line">lookup.NewExecutableLocator(logger, driverRoot),</span><br><span class="line">driverRoot,</span><br><span class="line">[]<span class="type">string</span>&#123;</span><br><span class="line"><span class="string">&quot;nvidia-smi&quot;</span>,              <span class="comment">/* System management interface */</span></span><br><span class="line"><span class="string">&quot;nvidia-debugdump&quot;</span>,        <span class="comment">/* GPU coredump utility */</span></span><br><span class="line"><span class="string">&quot;nvidia-persistenced&quot;</span>,     <span class="comment">/* Persistence mode utility */</span></span><br><span class="line"><span class="string">&quot;nvidia-cuda-mps-control&quot;</span>, <span class="comment">/* Multi process service CLI */</span></span><br><span class="line"><span class="string">&quot;nvidia-cuda-mps-server&quot;</span>,  <span class="comment">/* Multi process service server */</span></span><br><span class="line">&#125;,</span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="docker-ç‰¹æ®Š"><a href="#docker-ç‰¹æ®Š" class="headerlink" title="docker ç‰¹æ®Š"></a>docker ç‰¹æ®Š</h2><p>docker ä½¿ç”¨æ˜¾å¡ï¼Œå¿…é¡»æŸ¥çœ‹æ–‡æ¡£ <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/docker-specialized.html">docker-specialized</a></p><h2 id="k8s-ä¸Šä½¿ç”¨"><a href="#k8s-ä¸Šä½¿ç”¨" class="headerlink" title="k8s ä¸Šä½¿ç”¨"></a>k8s ä¸Šä½¿ç”¨</h2><p>k8s éœ€è¦éƒ¨ç½² <a href="https://github.com/NVIDIA/k8s-device-plugin">NVIDIA çš„ device plugin</a> ï¼Œä¼š daemonset èµ·ä¸€ä¸ªæœåŠ¡æŒ‚è½½å®¿ä¸»æœº <code>/var/lib/kubelet/device-plugins/</code> ç›®å½•ï¼Œç„¶ååœ¨ç›®å½•ä¸‹ç”Ÿæˆ socket æ–‡ä»¶ï¼Œkubelet å’Œè¿™ä¸ª socket æ–‡ä»¶æŒ‰ç…§ device plugin è¦æ±‚ grpc è°ƒç”¨ï¼Œéƒ¨ç½²å»çœ‹å®˜æ–¹çš„ github éƒ¨ç½²ã€‚</p><ul><li><a href="https://github.com/NVIDIA/k8s-device-plugin/blob/main/nvidia-device-plugin.yml">nvidia-device-plugin.yml</a></li><li><a href="https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/">k8s device pluginæ–‡æ¡£</a></li></ul><p>éƒ¨ç½²åï¼Œå¯ä»¥ describe node æŸ¥çœ‹åˆ°ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Capacity:</span><br><span class="line">  ...</span><br><span class="line">  nvidia.com/gpu:     8</span><br><span class="line">  ...</span><br><span class="line">Allocatable:</span><br><span class="line">  ...</span><br><span class="line">  nvidia.com/gpu:     8</span><br><span class="line">  ...</span><br><span class="line">...</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  Resource           Requests    Limits</span><br><span class="line">  --------           --------    ------</span><br><span class="line">  nvidia.com/gpu     0           0</span><br></pre></td></tr></table></figure><p>å¯ä»¥ <code>kubectl describe node xxx -v=8</code> æŸ¥çœ‹è¯·æ±‚çš„å•¥æ¥å£ï¼Œç„¶åç”¨ go-client è·å–èŠ‚ç‚¹çš„ cpu åˆ†é…æƒ…å†µï¼Œå¦‚æœä¸æ˜¯ k8s ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/NVIDIA/k8s-device-plugin/blob/main/go.mod">NVIDIA&#x2F;k8s-device-plugin</a> é‡Œæ‰¾ä¸‹ go çš„åº“æ¥çœ‹èŠ‚ç‚¹ gpu åˆ†é…æƒ…å†µã€‚<br>å‚ç…§ <a href="https://catalog.ngc.nvidia.com/orgs/nvidia/teams/k8s/containers/cuda-sample">cuda-sample</a> éƒ¨ç½²æµ‹è¯•ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-demo-vectoradd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vectoradd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bash</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        /tmp/vectorAdd</span></span><br><span class="line"><span class="string">        nvidia-smi -L</span></span><br><span class="line"><span class="string"></span>    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -o wide | grep gpu</span><br><span class="line">gpu-demo-vectoradd                                                0/1     Completed   0              117s    1xx.xx.1.192   xx.7.xx.201   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">$ kubectl logs gpu-demo-vectoradd </span><br><span class="line">[Vector addition of 50000 elements]</span><br><span class="line">Copy input data from the host memory to the CUDA device</span><br><span class="line">CUDA kernel launch with 196 blocks of 256 threads</span><br><span class="line">Copy output data from the CUDA device to the host memory</span><br><span class="line">Test PASSED</span><br><span class="line">Done</span><br><span class="line">GPU 0: NVIDIA GeForce RTX 4090 (UUID: GPU-xxx-e0bf-xxx-60d4-xxxxxxx)</span><br></pre></td></tr></table></figure><h2 id="docker-å’Œ-cri-dockerd-çš„ä¸€äº›é—®é¢˜"><a href="#docker-å’Œ-cri-dockerd-çš„ä¸€äº›é—®é¢˜" class="headerlink" title="docker å’Œ cri-dockerd çš„ä¸€äº›é—®é¢˜"></a>docker å’Œ cri-dockerd çš„ä¸€äº›é—®é¢˜</h2><p>æŸ¥çœ‹æ–‡æ¡£ <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/docker-specialized.html">docker-specialized</a> å®éªŒå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œä¸å¸¦ <code>--gpus all</code> æˆ–è€… <code>-e NVIDIA_VISIBLE_DEVICES=all</code> é»˜è®¤å°±èƒ½çœ‹åˆ°æ‰€æœ‰å¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm --gpus all nvidia/cuda:12.4.0-base-ubuntu22.04 nvidia-smi -L</span><br><span class="line">$ docker run --rm nvidia/cuda:12.4.0-base-ubuntu22.04 nvidia-smi -L</span><br><span class="line">$ docker run --rm --runtime=nvidia -e NVIDIA_VISIBLE_DEVICES=all nvidia/cuda:12.4.0-base-ubuntu22.04 nvidia-smi -L</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º nvidia æˆä¸ºé»˜è®¤çš„ runtime äº†ï¼Œç„¶å cuda docker é•œåƒéƒ½å¸¦äº† <code>ENV NVIDIA_VISIBLE_DEVICES=all</code> çš„ç¯å¢ƒå˜é‡ï¼Œå°±æ˜¯è¯´ä¸Šé¢ä¸‰ä¸ªæ˜¯ä¸€æ ·çš„ã€‚<br>å¦‚æœç¡®å®šä½ ä»¬ k8s é›†ç¾¤ä¸ä¼šå­˜åœ¨ docker run çš„å®¹å™¨ä½¿ç”¨æ˜¾å¡ï¼Œé‚£å°±ä¸ç”¨ç®¡ï¼Œä½†æ˜¯æˆ‘ä»¬å­˜åœ¨é k8s é›†ç¾¤çº¯ docker çš„ç¯å¢ƒï¼Œç›®å‰å¥½åƒæ²¡æ‰¾åˆ°å¥½çš„è§£å†³åŠæ³•ï¼Œåªèƒ½ä¸é…ç½® <code>&quot;default-runtime&quot;: &quot;nvidia&quot;,</code> å¿…é¡»æ˜¾å¼è°ƒç”¨ï¼Œå°±åƒä¸‹é¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --rm --runtime nvidia --gpus all nvidia/cuda:12.4.0-base-ubuntu22.04 nvidia-smi</span><br></pre></td></tr></table></figure><p>docker-compose v2 golangç‰ˆæœ¬çš„è¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  app:</span><br><span class="line">    image: xxx</span><br><span class="line">    runtime: nvidia</span><br></pre></td></tr></table></figure><p>k8s æŒ‡å®š runtime å¿…é¡»å…ˆåˆ›å»ºä¸€ä¸ª <code>RuntimeClass</code> å¯¹è±¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: node.k8s.io/v1</span><br><span class="line">kind: RuntimeClass</span><br><span class="line">metadata:</span><br><span class="line">  name: nvidia</span><br><span class="line">handler: nvidia</span><br></pre></td></tr></table></figure><p>ç„¶å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | kubectl create -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: gpu-demo-vectoradd</span><br><span class="line">spec:</span><br><span class="line">  restartPolicy: Never</span><br><span class="line">  runtimeClassName: nvidia # &lt;- è¿™é‡Œ</span><br><span class="line">  containers:</span><br><span class="line">  - name: vectoradd</span><br><span class="line">    image: nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2</span><br><span class="line">    command:</span><br><span class="line">    - bash</span><br><span class="line">    - -c</span><br><span class="line">    args:</span><br><span class="line">    - |</span><br><span class="line">        /tmp/vectorAdd</span><br><span class="line">        nvidia-smi -L</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        nvidia.com/gpu: 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>ç†æƒ³æ˜¯ç¾å¥½çš„ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªå¹²å‡€ç¯å¢ƒä¸ŠæŒ‰ç…§æ­¥éª¤å®é™…å‘ç°ï¼Œ<code>RuntimeClass.handler=nvidia</code> åœ¨ cri-dockerd ç¯å¢ƒä¸‹ pod æ— æ³•åˆ›å»º sandboxï¼Œå‘ç°å®ƒæ”¹ä¸º <code>docker</code> æ‰è¡Œï¼Œä½†æ˜¯è¿™æ ·ä¸‹ nvidia-device-plugin æŒ‡ä¸æŒ‡å®š <code>runtimeClassName</code> éƒ½æ‰¾ä¸åˆ°å¡ï¼Œæ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">I0412 10:31:24.585290       1 main.go:256] Retreiving plugins.</span><br><span class="line">W0412 10:31:24.585562       1 factory.go:31] No valid resources detected, creating a null CDI handler</span><br><span class="line">I0412 10:31:24.585597       1 factory.go:107] Detected non-NVML platform: could not load NVML library: libnvidia-ml.so.1: cannot open shared object file: No such file or directory</span><br><span class="line">I0412 10:31:24.585622       1 factory.go:107] Detected non-Tegra platform: /sys/devices/soc0/family file not found</span><br><span class="line">E0412 10:31:24.585629       1 factory.go:115] Incompatible platform detected</span><br><span class="line">E0412 10:31:24.585631       1 factory.go:116] If this is a GPU node, did you configure the NVIDIA Container Toolkit?</span><br><span class="line">E0412 10:31:24.585634       1 factory.go:117] You can check the prerequisites at: https://github.com/NVIDIA/k8s-device-plugin#prerequisites</span><br><span class="line">E0412 10:31:24.585637       1 factory.go:118] You can learn how to set the runtime at: https://github.com/NVIDIA/k8s-device-plugin#quick-start</span><br><span class="line">E0412 10:31:24.585640       1 factory.go:119] If this is not a GPU node, you should set up a toleration or nodeSelector to only deploy this plugin on GPU nodes</span><br><span class="line">I0412 10:31:24.585644       1 main.go:287] No devices found. Waiting indefinitely.</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æ—¥å¿—æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">I0408 10:40:23.126999       1 main.go:256] Retreiving plugins.</span><br><span class="line">I0408 10:40:23.128195       1 factory.go:107] Detected NVML platform: found NVML library</span><br><span class="line">I0408 10:40:23.128311       1 factory.go:107] Detected non-Tegra platform: /sys/devices/soc0/family file not found</span><br><span class="line">I0408 10:40:23.197946       1 server.go:165] Starting GRPC server for &#x27;nvidia.com/gpu&#x27;</span><br><span class="line">I0408 10:40:23.199739       1 server.go:117] Starting to serve &#x27;nvidia.com/gpu&#x27; on /var/lib/kubelet/device-plugins/nvidia-gpu.sock</span><br><span class="line">I0408 10:40:23.212600       1 server.go:125] Registered device plugin for &#x27;nvidia.com/gpu&#x27; with Kubelet</span><br></pre></td></tr></table></figure><p>æœ€åæ’æŸ¥å‡ºå‘ç°å®¹å™¨çš„ Runtime ä¸å¯¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect be4d | grep -i runtime</span><br><span class="line">            &quot;Runtime&quot;: &quot;runc&quot;,</span><br></pre></td></tr></table></figure><p>è¯•äº†ä¸‹ <code>docker run --runtime nvidia</code> æ˜¯èƒ½å·¥ä½œçš„ï¼Œ kubelet è‚¯å®šä¼šæŠŠ handler ä¼ é€’åˆ° CRI runtime çš„ï¼Œä¹Ÿå°±æ˜¯ cri-dockerd ä¸Šï¼Œå”¯ä¸€å¯èƒ½æ€§æ˜¯ cri-dockerd æ²¡é…ç½® Runtime ä¼ é€’åˆ° docker çš„ create é˜¶æ®µï¼Œæœ€åè°ƒè¯•äº†ä¸‹å‘ç°æœç„¶æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&gt; github.com/Mirantis/cri-dockerd/core.(*dockerService).CreateContainer() ./core/container_create.go:137 (hits goroutine(36839):1 total:1) (PC: 0x229e164)</span><br><span class="line">   132:         cleanupInfo, err := ds.applyPlatformSpecificDockerConfig(r, &amp;createConfig)</span><br><span class="line">   133:         if err != nil &#123;</span><br><span class="line">   134:                 return nil, err</span><br><span class="line">   135:         &#125;</span><br><span class="line">   136:</span><br><span class="line">=&gt; 137:         createResp, createErr := ds.client.CreateContainer(createConfig)</span><br><span class="line">   138:         if createErr != nil &#123;</span><br><span class="line">   139:                 createResp, createErr = recoverFromCreationConflictIfNeeded(</span><br><span class="line">   140:                         ds.client,</span><br><span class="line">   141:                         createConfig,</span><br><span class="line">   142:                         createErr,</span><br><span class="line">(dlv) p createConfig</span><br><span class="line">github.com/docker/docker/api/types.ContainerCreateConfig &#123;</span><br><span class="line">        Name: &quot;k8s_nvidia-device-plugin-ctr_nvidia-device-plugin-daemonset-5tm6...+52 more&quot;,</span><br><span class="line">        Config: *github.com/docker/docker/api/types/container.Config &#123;</span><br><span class="line">                ...</span><br><span class="line">        HostConfig: *github.com/docker/docker/api/types/container.HostConfig &#123;</span><br><span class="line">                Binds: []string len: 4, cap: 4, [</span><br><span class="line">                        &quot;/var/lib/kubelet/device-plugins:/var/lib/kubelet/device-plugins&quot;,</span><br><span class="line">                        &quot;/data/kube/kubelet/pods/59f9fe0c-4397-4a83-a149-97ed696d4551/vol...+99 more&quot;,</span><br><span class="line">                        &quot;/data/kube/kubelet/pods/59f9fe0c-4397-4a83-a149-97ed696d4551/etc...+17 more&quot;,</span><br><span class="line">                        &quot;/data/kube/kubelet/pods/59f9fe0c-4397-4a83-a149-97ed696d4551/con...+62 more&quot;,</span><br><span class="line">                ],</span><br><span class="line">                ContainerIDFile: &quot;&quot;,</span><br><span class="line">                LogConfig: (*&quot;github.com/docker/docker/api/types/container.LogConfig&quot;)(0xc001505228),</span><br><span class="line">                NetworkMode: &quot;container:8d3c044a8c0339faed520efebe9dc199937de3515eb9a3baf723ed...+10 more&quot;,</span><br><span class="line">                PortBindings: github.com/docker/go-connections/nat.PortMap nil,</span><br><span class="line">                RestartPolicy: (*&quot;github.com/docker/docker/api/types/container.RestartPolicy&quot;)(0xc001505258),</span><br><span class="line">                AutoRemove: false,</span><br><span class="line">                VolumeDriver: &quot;&quot;,</span><br><span class="line">                VolumesFrom: []string len: 0, cap: 0, nil,</span><br><span class="line">                ConsoleSize: [2]uint [0,0],</span><br><span class="line">                Annotations: map[string]string nil,</span><br><span class="line">                CapAdd: github.com/docker/docker/api/types/strslice.StrSlice len: 0, cap: 0, nil,</span><br><span class="line">                CapDrop: github.com/docker/docker/api/types/strslice.StrSlice len: 1, cap: 1, [&quot;ALL&quot;],</span><br><span class="line">                CgroupnsMode: &quot;&quot;,</span><br><span class="line">                DNS: []string len: 0, cap: 0, nil,</span><br><span class="line">                DNSOptions: []string len: 0, cap: 0, nil,</span><br><span class="line">                DNSSearch: []string len: 0, cap: 0, nil,</span><br><span class="line">                ExtraHosts: []string len: 0, cap: 0, nil,</span><br><span class="line">                GroupAdd: []string len: 0, cap: 0, nil,</span><br><span class="line">                IpcMode: &quot;container:8d3c044a8c0339faed520efebe9dc199937de3515eb9a3baf723ed...+10 more&quot;,</span><br><span class="line">                Cgroup: &quot;&quot;,</span><br><span class="line">                Links: []string len: 0, cap: 0, nil,</span><br><span class="line">                OomScoreAdj: -997,</span><br><span class="line">                PidMode: &quot;&quot;,</span><br><span class="line">                Privileged: false,</span><br><span class="line">                PublishAllPorts: false,</span><br><span class="line">                ReadonlyRootfs: false,</span><br><span class="line">                SecurityOpt: []string len: 2, cap: 2, [</span><br><span class="line">                        &quot;no-new-privileges&quot;,</span><br><span class="line">                        &quot;seccomp=unconfined&quot;,</span><br><span class="line">                ],</span><br><span class="line">                StorageOpt: map[string]string nil,</span><br><span class="line">                Tmpfs: map[string]string nil,</span><br><span class="line">                UTSMode: &quot;&quot;,</span><br><span class="line">                UsernsMode: &quot;&quot;,</span><br><span class="line">                ShmSize: 0,</span><br><span class="line">                Sysctls: map[string]string nil,</span><br><span class="line">                Runtime: &quot;&quot;,</span><br><span class="line">                Isolation: &quot;&quot;,</span><br><span class="line">                Resources: (*&quot;github.com/docker/docker/api/types/container.Resources&quot;)(0xc001505440),</span><br><span class="line">                Mounts: []github.com/docker/docker/api/types/mount.Mount len: 0, cap: 0, nil,</span><br><span class="line">                MaskedPaths: []string len: 10, cap: 16, [</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢ <code>Runtime</code> æ˜¯ç©ºçš„ï¼Œä¸Šå±‚çš„è°ƒç”¨é“¾é‡Œï¼Œåªå…è®¸ <code>RuntimeHandler</code>ä¸ä¸ºç©ºæƒ…å†µä¸‹è®¾ç½®ä¸º dockerï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/Mirantis/cri-dockerd/blob/v0.3.12/core/sandbox_run.go#L54-L56</span></span><br><span class="line"><span class="keyword">if</span> r.GetRuntimeHandler() != <span class="string">&quot;&quot;</span> &amp;&amp; r.GetRuntimeHandler() != runtimeName &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;RuntimeHandler %q not supported&quot;</span>, r.GetRuntimeHandler())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åé¢çš„è°ƒç”¨é“¾é‡Œä¹Ÿæ²¡å»ä½¿ç”¨ <code>r.GetRuntimeHandler()</code> æˆ–è€…è®¾ç½® <code>x.HostConfig.Runtime</code> ï¼Œæ„å‘³ç€ä¸é…ç½® <code>RuntimeClass.handler</code> æˆ–è€…è®¾ç½®ä¸º <code>docker</code> éƒ½æ˜¯ä½¿ç”¨ docker é»˜è®¤çš„ runtimeã€‚</p><p>ç„¶åæˆ‘ä¿®æ”¹ä»£ç ç¼–è¯‘åæ‰å‘ç°å¯ä»¥ä½¿ç”¨ <code>RuntimeClass.handler=nvidia</code> äº†ï¼Œå¹¶ä¸” pod çš„å®¹å™¨çš„ runtime ä¹Ÿæ­£å¸¸äº†ï¼Œå‘ cri-dockerd æäº† pr <a href="https://github.com/Mirantis/cri-dockerd/pull/350">support RuntimeClass.handler</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/Project-HAMi/HAMi/blob/master/README_cn.md">https://github.com/Project-HAMi/HAMi/blob/master/README_cn.md</a></li><li><a href="https://tianzhipeng-git.github.io/2023/11/21/cuda-version.html">https://tianzhipeng-git.github.io/2023/11/21/cuda-version.html</a></li><li><a href="https://juejin.cn/post/7202877900240339000">https://juejin.cn/post/7202877900240339000</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•ä¸‹ docker k8s ä½¿ç”¨ gpu çš„ç¬”è®°&lt;/p&gt;</summary>
    
    
    
    
    <category term="docker" scheme="http://zhangguanzhang.github.io/tags/docker/"/>
    
    <category term="gpu" scheme="http://zhangguanzhang.github.io/tags/gpu/"/>
    
    <category term="nvidia" scheme="http://zhangguanzhang.github.io/tags/nvidia/"/>
    
  </entry>
  
</feed>
